(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports);
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports);
    global.textUtils = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.isUnicodeCJK = isUnicodeCJK;
  _exports.isUnicodeSpace = isUnicodeSpace;
  _exports.safeMeasureText = safeMeasureText;
  _exports.fragmentText = fragmentText;
  _exports.BASELINE_RATIO = void 0;

  /*
   Copyright (c) 2013-2016 Chukong Technologies Inc.
   Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.
  
   http://www.cocos.com
  
   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated engine source code (the "Software"), a limited,
   worldwide, royalty-free, non-assignable, revocable and non-exclusive license
   to use Cocos Creator solely to develop games on your target platforms. You shall
   not use Cocos Creator software for developing other software or tools that's
   used for developing games. You are not granted to publish, distribute,
   sublicense, and/or sell copies of Cocos Creator.
  
   The software or tools in this License Agreement are licensed, not sold.
   Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.
  
   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
   THE SOFTWARE.
  */

  /**
   * @hide
   */
  var BASELINE_RATIO = 0.26;
  _exports.BASELINE_RATIO = BASELINE_RATIO;
  var WORD_REG = /([a-zA-Z0-9Ã„Ã–ÃœÃ¤Ã¶Ã¼ÃŸÃ©Ã¨Ã§Ã Ã¹ÃªÃ¢Ã®Ã´Ã»Ð°-ÑÐ-Ð¯ÐÑ‘]+|\S)/;
  var SYMBOL_REG = /^[!,.:;'}\]%\?>ã€â€˜â€œã€‹ï¼Ÿã€‚ï¼Œï¼]/;
  var LAST_WORD_REG = /([a-zA-Z0-9Ã„Ã–ÃœÃ¤Ã¶Ã¼ÃŸÃ©Ã¨Ã§Ã Ã¹ÃªÃ¢Ã®Ã´Ã»Ð°Ã­Ã¬ÃÃŒÃ¯ÃÃ€Ã¡Ã Ã‰ÃˆÃ’Ã“Ã²Ã³ÅÅ‘Ã™ÃšÅ°ÃºÅ±Ã±Ã‘Ã¦Ã†Å“Å’ÃƒÃ‚Ã£Ã”ÃµÄ›Å¡ÄÅ™Å¾Ã½Ã¡Ã­Ã©Ã³ÃºÅ¯Å¥ÄÅˆÄšÅ ÄŒÅ˜Å½ÃÃÃ‰Ã“ÃšÅ¤Å¼ÅºÅ›Ã³Å„Å‚Ä™Ä‡Ä…Å»Å¹ÅšÃ“ÅƒÅÄ˜Ä†Ä„-ÑÐ-Ð¯ÐÑ‘]+|\S)$/;
  var LAST_ENGLISH_REG = /[a-zA-Z0-9Ã„Ã–ÃœÃ¤Ã¶Ã¼ÃŸÃ©Ã¨Ã§Ã Ã¹ÃªÃ¢Ã®Ã´Ã»Ð°Ã­Ã¬ÃÃŒÃ¯ÃÃ€Ã¡Ã Ã‰ÃˆÃ’Ã“Ã²Ã³ÅÅ‘Ã™ÃšÅ°ÃºÅ±Ã±Ã‘Ã¦Ã†Å“Å’ÃƒÃ‚Ã£Ã”ÃµÄ›Å¡ÄÅ™Å¾Ã½Ã¡Ã­Ã©Ã³ÃºÅ¯Å¥ÄÅˆÄšÅ ÄŒÅ˜Å½ÃÃÃ‰Ã“ÃšÅ¤Å¼ÅºÅ›Ã³Å„Å‚Ä™Ä‡Ä…Å»Å¹ÅšÃ“ÅƒÅÄ˜Ä†Ä„-ÑÐ-Ð¯ÐÑ‘]+$/;
  var FIRST_ENGLISH_REG = /^[a-zA-Z0-9Ã„Ã–ÃœÃ¤Ã¶Ã¼ÃŸÃ©Ã¨Ã§Ã Ã¹ÃªÃ¢Ã®Ã´Ã»Ð°Ã­Ã¬ÃÃŒÃ¯ÃÃ€Ã¡Ã Ã‰ÃˆÃ’Ã“Ã²Ã³ÅÅ‘Ã™ÃšÅ°ÃºÅ±Ã±Ã‘Ã¦Ã†Å“Å’ÃƒÃ‚Ã£Ã”ÃµÄ›Å¡ÄÅ™Å¾Ã½Ã¡Ã­Ã©Ã³ÃºÅ¯Å¥ÄÅˆÄšÅ ÄŒÅ˜Å½ÃÃÃ‰Ã“ÃšÅ¤Å¼ÅºÅ›Ã³Å„Å‚Ä™Ä‡Ä…Å»Å¹ÅšÃ“ÅƒÅÄ˜Ä†Ä„-ÑÐ-Ð¯ÐÑ‘]/;
  var WRAP_INSPECTION = true; // The unicode standard will never assign a character from code point 0xD800 to 0xDFFF
  // high surrogate (0xD800-0xDBFF) and low surrogate(0xDC00-0xDFFF) combines to a character on the Supplementary Multilingual Plane
  // reference: https://en.wikipedia.org/wiki/UTF-16

  var highSurrogateRex = /[\uD800-\uDBFF]/;
  var lowSurrogateRex = /[\uDC00-\uDFFF]/;

  function isUnicodeCJK(ch) {
    var __CHINESE_REG = /^[\u4E00-\u9FFF\u3400-\u4DFF]+$/;
    var __JAPANESE_REG = /[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g;
    var __KOREAN_REG = /^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/;
    return __CHINESE_REG.test(ch) || __JAPANESE_REG.test(ch) || __KOREAN_REG.test(ch);
  } // Checking whether the character is a whitespace


  function isUnicodeSpace(ch) {
    var chCode = ch.charCodeAt(0);
    return chCode >= 9 && chCode <= 13 || chCode === 32 || chCode === 133 || chCode === 160 || chCode === 5760 || chCode >= 8192 && chCode <= 8202 || chCode === 8232 || chCode === 8233 || chCode === 8239 || chCode === 8287 || chCode === 12288;
  }

  function safeMeasureText(ctx, string) {
    var metric = ctx.measureText(string);
    return metric && metric.width || 0;
  } // in case truncate a character on the Supplementary Multilingual Plane
  // test case: a = 'ðŸ˜‰ðŸš—'
  // _safeSubstring(a, 1) === 'ðŸ˜‰ðŸš—'
  // _safeSubstring(a, 0, 1) === 'ðŸ˜‰'
  // _safeSubstring(a, 0, 2) === 'ðŸ˜‰'
  // _safeSubstring(a, 0, 3) === 'ðŸ˜‰'
  // _safeSubstring(a, 0, 4) === 'ðŸ˜‰ðŸš—'
  // _safeSubstring(a, 1, 2) === _safeSubstring(a, 1, 3) === 'ðŸ˜‰'
  // _safeSubstring(a, 2, 3) === _safeSubstring(a, 2, 4) === 'ðŸš—'


  function _safeSubstring(targetString, startIndex, endIndex) {
    var newStartIndex = startIndex;
    var newEndIndex = endIndex;
    var startChar = targetString[startIndex]; // lowSurrogateRex

    if (startChar >= "\uDC00" && startChar <= "\uDFFF") {
      newStartIndex--;
    }

    if (endIndex !== undefined) {
      if (endIndex - 1 !== startIndex) {
        var endChar = targetString[endIndex - 1]; // highSurrogateRex

        if (endChar >= "\uD800" && endChar <= "\uDBFF") {
          newEndIndex--;
        }
      } // highSurrogateRex
      else if (startChar >= "\uD800" && startChar <= "\uDBFF") {
          newEndIndex++;
        }
    }

    return targetString.substring(newStartIndex, newEndIndex);
  }

  function fragmentText(stringToken, allWidth, maxWidth, measureText) {
    // check the first character
    var wrappedWords = []; // fast return if strArr is empty

    if (stringToken.length === 0 || maxWidth < 0) {
      wrappedWords.push('');
      return wrappedWords;
    }

    var text = stringToken;

    while (allWidth > maxWidth && text.length > 1) {
      var fuzzyLen = text.length * (maxWidth / allWidth) | 0;

      var tmpText = _safeSubstring(text, fuzzyLen);

      var width = allWidth - measureText(tmpText);
      var sLine = tmpText;
      var pushNum = 0;
      var checkWhile = 0;
      var checkCount = 10; // Exceeded the size

      while (width > maxWidth && checkWhile++ < checkCount) {
        fuzzyLen *= maxWidth / width;
        fuzzyLen = fuzzyLen | 0;
        tmpText = _safeSubstring(text, fuzzyLen);
        width = allWidth - measureText(tmpText);
      }

      checkWhile = 0; // Find the truncation point

      while (width <= maxWidth && checkWhile++ < checkCount) {
        if (tmpText) {
          var exec = WORD_REG.exec(tmpText);
          pushNum = exec ? exec[0].length : 1;
          sLine = tmpText;
        }

        fuzzyLen = fuzzyLen + pushNum;
        tmpText = _safeSubstring(text, fuzzyLen);
        width = allWidth - measureText(tmpText);
      }

      fuzzyLen -= pushNum; // in case maxWidth cannot contain any characters, need at least one character per line

      if (fuzzyLen === 0) {
        fuzzyLen = 1;
        sLine = _safeSubstring(text, 1);
      } // highSurrogateRex
      else if (fuzzyLen === 1 && text[0] >= "\uD800" && text[0] <= "\uDBFF") {
          fuzzyLen = 2;
          sLine = _safeSubstring(text, 2);
        }

      var sText = _safeSubstring(text, 0, fuzzyLen);

      var result = void 0; // symbol in the first

      if (WRAP_INSPECTION) {
        if (SYMBOL_REG.test(sLine || tmpText)) {
          result = LAST_WORD_REG.exec(sText);
          fuzzyLen -= result ? result[0].length : 0;

          if (fuzzyLen === 0) {
            fuzzyLen = 1;
          }

          sLine = _safeSubstring(text, fuzzyLen);
          sText = _safeSubstring(text, 0, fuzzyLen);
        }
      } // To judge whether a English words are truncated


      if (FIRST_ENGLISH_REG.test(sLine)) {
        result = LAST_ENGLISH_REG.exec(sText);

        if (result && sText !== result[0]) {
          fuzzyLen -= result[0].length;
          sLine = _safeSubstring(text, fuzzyLen);
          sText = _safeSubstring(text, 0, fuzzyLen);
        }
      } // The first line And do not wrap should not remove the space


      if (wrappedWords.length === 0) {
        wrappedWords.push(sText);
      } else {
        sText = sText.trim();

        if (sText.length > 0) {
          wrappedWords.push(sText);
        }
      }

      text = sLine || tmpText;
      allWidth = measureText(text);
    }

    if (wrappedWords.length === 0) {
      wrappedWords.push(text);
    } else {
      text = text.trim();

      if (text.length > 0) {
        wrappedWords.push(text);
      }
    }

    return wrappedWords;
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImU6L2QwMDQ1MjUyMC9HaXRodWIvZW5naW5lL2NvY29zL2NvcmUvdXRpbHMvdGV4dC11dGlscy50cyJdLCJuYW1lcyI6WyJCQVNFTElORV9SQVRJTyIsIldPUkRfUkVHIiwiU1lNQk9MX1JFRyIsIkxBU1RfV09SRF9SRUciLCJMQVNUX0VOR0xJU0hfUkVHIiwiRklSU1RfRU5HTElTSF9SRUciLCJXUkFQX0lOU1BFQ1RJT04iLCJoaWdoU3Vycm9nYXRlUmV4IiwibG93U3Vycm9nYXRlUmV4IiwiaXNVbmljb2RlQ0pLIiwiY2giLCJfX0NISU5FU0VfUkVHIiwiX19KQVBBTkVTRV9SRUciLCJfX0tPUkVBTl9SRUciLCJ0ZXN0IiwiaXNVbmljb2RlU3BhY2UiLCJjaENvZGUiLCJjaGFyQ29kZUF0Iiwic2FmZU1lYXN1cmVUZXh0IiwiY3R4Iiwic3RyaW5nIiwibWV0cmljIiwibWVhc3VyZVRleHQiLCJ3aWR0aCIsIl9zYWZlU3Vic3RyaW5nIiwidGFyZ2V0U3RyaW5nIiwic3RhcnRJbmRleCIsImVuZEluZGV4IiwibmV3U3RhcnRJbmRleCIsIm5ld0VuZEluZGV4Iiwic3RhcnRDaGFyIiwidW5kZWZpbmVkIiwiZW5kQ2hhciIsInN1YnN0cmluZyIsImZyYWdtZW50VGV4dCIsInN0cmluZ1Rva2VuIiwiYWxsV2lkdGgiLCJtYXhXaWR0aCIsIndyYXBwZWRXb3JkcyIsImxlbmd0aCIsInB1c2giLCJ0ZXh0IiwiZnV6enlMZW4iLCJ0bXBUZXh0Iiwic0xpbmUiLCJwdXNoTnVtIiwiY2hlY2tXaGlsZSIsImNoZWNrQ291bnQiLCJleGVjIiwic1RleHQiLCJyZXN1bHQiLCJ0cmltIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUEwQkE7OztBQUlPLE1BQU1BLGNBQWMsR0FBRyxJQUF2Qjs7QUFFUCxNQUFNQyxRQUFRLEdBQUcsNENBQWpCO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLDBCQUFuQjtB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LENBQUNFLElBQU4sRUFBUjs7QUFDQSxZQUFJRixLQUFLLENBQUNWLE1BQU4sR0FBZSxDQUFuQixFQUFzQjtBQUNsQkQsVUFBQUEsWUFBWSxDQUFDRSxJQUFiLENBQWtCUyxLQUFsQjtBQUNIO0FBQ0o7O0FBQ0RSLE1BQUFBLElBQUksR0FBR0csS0FBSyxJQUFJRCxPQUFoQjtBQUNBUCxNQUFBQSxRQUFRLEdBQUdkLFdBQVcsQ0FBQ21CLElBQUQsQ0FBdEI7QUFDSDs7QUFFRCxRQUFJSCxZQUFZLENBQUNDLE1BQWIsS0FBd0IsQ0FBNUIsRUFBK0I7QUFDM0JELE1BQUFBLFlBQVksQ0FBQ0UsSUFBYixDQUFrQkMsSUFBbEI7QUFDSCxLQUZELE1BR0s7QUFDREEsTUFBQUEsSUFBSSxHQUFHQSxJQUFJLENBQUNVLElBQUwsRUFBUDs7QUFDQSxVQUFJVixJQUFJLENBQUNGLE1BQUwsR0FBYyxDQUFsQixFQUFxQjtBQUNqQkQsUUFBQUEsWUFBWSxDQUFDRSxJQUFiLENBQWtCQyxJQUFsQjtBQUNIO0FBQ0o7O0FBQ0QsV0FBT0gsWUFBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuIENvcHlyaWdodCAoYykgMjAxMy0yMDE2IENodWtvbmcgVGVjaG5vbG9naWVzIEluYy5cclxuIENvcHlyaWdodCAoYykgMjAxNy0yMDE4IFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLlxyXG5cclxuIGh0dHA6Ly93d3cuY29jb3MuY29tXHJcblxyXG4gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxyXG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXHJcbiB3b3JsZHdpZGUsIHJveWFsdHktZnJlZSwgbm9uLWFzc2lnbmFibGUsIHJldm9jYWJsZSBhbmQgbm9uLWV4Y2x1c2l2ZSBsaWNlbnNlXHJcbiB0byB1c2UgQ29jb3MgQ3JlYXRvciBzb2xlbHkgdG8gZGV2ZWxvcCBnYW1lcyBvbiB5b3VyIHRhcmdldCBwbGF0Zm9ybXMuIFlvdSBzaGFsbFxyXG4gbm90IHVzZSBDb2NvcyBDcmVhdG9yIHNvZnR3YXJlIGZvciBkZXZlbG9waW5nIG90aGVyIHNvZnR3YXJlIG9yIHRvb2xzIHRoYXQnc1xyXG4gdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxyXG4gc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzIG9mIENvY29zIENyZWF0b3IuXHJcblxyXG4gVGhlIHNvZnR3YXJlIG9yIHRvb2xzIGluIHRoaXMgTGljZW5zZSBBZ3JlZW1lbnQgYXJlIGxpY2Vuc2VkLCBub3Qgc29sZC5cclxuIFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLiByZXNlcnZlcyBhbGwgcmlnaHRzIG5vdCBleHByZXNzbHkgZ3JhbnRlZCB0byB5b3UuXHJcblxyXG4gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxyXG4gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXHJcbiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcclxuIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcclxuIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXHJcbiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXHJcbiBUSEUgU09GVFdBUkUuXHJcbiovXHJcblxyXG4vKipcclxuICogQGhpZGVcclxuICovXHJcblxyXG5leHBvcnQgY29uc3QgQkFTRUxJTkVfUkFUSU8gPSAwLjI2O1xyXG5cclxuY29uc3QgV09SRF9SRUcgPSAvKFthLXpBLVowLTnDhMOWw5zDpMO2w7zDn8Opw6jDp8Ogw7nDqsOiw67DtMO70LAt0Y/QkC3Qr9CB0ZFdK3xcXFMpLztcclxuY29uc3QgU1lNQk9MX1JFRyA9IC9eWyEsLjo7J31cXF0lXFw/PuOAgeKAmOKAnOOAi++8n+OAgu+8jO+8gV0vO1xyXG5jb25zdCBMQVNUX1dPUkRfUkVHID0gLyhbYS16QS1aMC05w4TDlsOcw6TDtsO8w5/DqcOow6fDoMO5w6rDosOuw7TDu9Cww63DrMONw4zDr8OBw4DDocOgw4nDiMOSw5PDssOzxZDFkcOZw5rFsMO6xbHDscORw6bDhsWTxZLDg8OCw6PDlMO1xJvFocSNxZnFvsO9w6HDrcOpw7PDusWvxaXEj8WIxJrFoMSMxZjFvcOBw43DicOTw5rFpMW8xbrFm8OzxYTFgsSZxIfEhcW7xbnFmsOTxYPFgcSYxIbEhC3Rj9CQLdCv0IHRkV0rfFxcUykkLztcclxuY29uc3QgTEFTVF9FTkdMSVNIX1JFRyA9IC9bYS16QS1aMC05w4TDlsOcw6TDtsO8w5/DqcOow6fDoMO5w6rDosOuw7TDu9Cww63DrMONw4zDr8OBw4DDocOgw4nDiMOSw5PDssOzxZDFkcOZw5rFsMO6xbHDscORw6bDhsWTxZLDg8OCw6PDlMO1xJvFocSNxZnFvsO9w6HDrcOpw7PDusWvxaXEj8WIxJrFoMSMxZjFvcOBw43DicOTw5rFpMW8xbrFm8OzxYTFgsSZxIfEhcW7xbnFmsOTxYPFgcSYxIbEhC3Rj9CQLdCv0IHRkV0rJC87XHJcbmNvbnN0IEZJUlNUX0VOR0xJU0hfUkVHID0gL15bYS16QS1aMC05w4TDlsOcw6TDtsO8w5/DqcOow6fDoMO5w6rDosOuw7TDu9Cww63DrMONw4zDr8OBw4DDocOgw4nDiMOSw5PDssOzxZDFkcOZw5rFsMO6xbHDscORw6bDhsWTxZLDg8OCw6PDlMO1xJvFocSNxZnFvsO9w6HDrcOpw7PDusWvxaXEj8WIxJrFoMSMxZjFvcOBw43DicOTw5rFpMW8xbrFm8OzxYTFgsSZxIfEhcW7xbnFmsOTxYPFgcSYxIbEhC3Rj9CQLdCv0IHRkV0vO1xyXG5jb25zdCBXUkFQX0lOU1BFQ1RJT04gPSB0cnVlO1xyXG4vLyBUaGUgdW5pY29kZSBzdGFuZGFyZCB3aWxsIG5ldmVyIGFzc2lnbiBhIGNoYXJhY3RlciBmcm9tIGNvZGUgcG9pbnQgMHhEODAwIHRvIDB4REZGRlxyXG4vLyBoaWdoIHN1cnJvZ2F0ZSAoMHhEODAwLTB4REJGRikgYW5kIGxvdyBzdXJyb2dhdGUoMHhEQzAwLTB4REZGRikgY29tYmluZXMgdG8gYSBjaGFyYWN0ZXIgb24gdGhlIFN1cHBsZW1lbnRhcnkgTXVsdGlsaW5ndWFsIFBsYW5lXHJcbi8vIHJlZmVyZW5jZTogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvVVRGLTE2XHJcbmNvbnN0IGhpZ2hTdXJyb2dhdGVSZXggPSAvW1xcdUQ4MDAtXFx1REJGRl0vO1xyXG5jb25zdCBsb3dTdXJyb2dhdGVSZXggPSAvW1xcdURDMDAtXFx1REZGRl0vO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzVW5pY29kZUNKSyAoY2g6IHN0cmluZykge1xyXG4gICAgY29uc3QgX19DSElORVNFX1JFRyA9IC9eW1xcdTRFMDAtXFx1OUZGRlxcdTM0MDAtXFx1NERGRl0rJC87XHJcbiAgICBjb25zdCBfX0pBUEFORVNFX1JFRyA9IC9bXFx1MzAwMC1cXHUzMDNGXXxbXFx1MzA0MC1cXHUzMDlGXXxbXFx1MzBBMC1cXHUzMEZGXXxbXFx1RkYwMC1cXHVGRkVGXXxbXFx1NEUwMC1cXHU5RkFGXXxbXFx1MjYwNS1cXHUyNjA2XXxbXFx1MjE5MC1cXHUyMTk1XXxcXHUyMDNCL2c7XHJcbiAgICBjb25zdCBfX0tPUkVBTl9SRUcgPSAvXltcXHUxMTAwLVxcdTExRkZdfFtcXHUzMTMwLVxcdTMxOEZdfFtcXHVBOTYwLVxcdUE5N0ZdfFtcXHVBQzAwLVxcdUQ3QUZdfFtcXHVEN0IwLVxcdUQ3RkZdKyQvO1xyXG4gICAgcmV0dXJuIF9fQ0hJTkVTRV9SRUcudGVzdChjaCkgfHwgX19KQVBBTkVTRV9SRUcudGVzdChjaCkgfHwgX19LT1JFQU5fUkVHLnRlc3QoY2gpO1xyXG59XHJcblxyXG4vLyBDaGVja2luZyB3aGV0aGVyIHRoZSBjaGFyYWN0ZXIgaXMgYSB3aGl0ZXNwYWNlXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1VuaWNvZGVTcGFjZSAoY2g6IHN0cmluZykge1xyXG4gICAgY29uc3QgY2hDb2RlID0gY2guY2hhckNvZGVBdCgwKTtcclxuICAgIHJldHVybiAoKGNoQ29kZSA+PSA5ICYmIGNoQ29kZSA8PSAxMykgfHxcclxuICAgIGNoQ29kZSA9PT0gMzIgfHxcclxuICAgIGNoQ29kZSA9PT0gMTMzIHx8XHJcbiAgICBjaENvZGUgPT09IDE2MCB8fFxyXG4gICAgY2hDb2RlID09PSA1NzYwIHx8XHJcbiAgICAoY2hDb2RlID49IDgxOTIgJiYgY2hDb2RlIDw9IDgyMDIpIHx8XHJcbiAgICBjaENvZGUgPT09IDgyMzIgfHxcclxuICAgIGNoQ29kZSA9PT0gODIzMyB8fFxyXG4gICAgY2hDb2RlID09PSA4MjM5IHx8XHJcbiAgICBjaENvZGUgPT09IDgyODcgfHxcclxuICAgIGNoQ29kZSA9PT0gMTIyODgpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc2FmZU1lYXN1cmVUZXh0IChjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgc3RyaW5nOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IG1ldHJpYyA9IGN0eC5tZWFzdXJlVGV4dChzdHJpbmcpO1xyXG4gICAgcmV0dXJuIG1ldHJpYyAmJiBtZXRyaWMud2lkdGggfHwgMDtcclxufVxyXG5cclxuLy8gaW4gY2FzZSB0cnVuY2F0ZSBhIGNoYXJhY3RlciBvbiB0aGUgU3VwcGxlbWVudGFyeSBNdWx0aWxpbmd1YWwgUGxhbmVcclxuLy8gdGVzdCBjYXNlOiBhID0gJ/CfmInwn5qXJ1xyXG4vLyBfc2FmZVN1YnN0cmluZyhhLCAxKSA9PT0gJ/CfmInwn5qXJ1xyXG4vLyBfc2FmZVN1YnN0cmluZyhhLCAwLCAxKSA9PT0gJ/CfmIknXHJcbi8vIF9zYWZlU3Vic3RyaW5nKGEsIDAsIDIpID09PSAn8J+YiSdcclxuLy8gX3NhZmVTdWJzdHJpbmcoYSwgMCwgMykgPT09ICfwn5iJJ1xyXG4vLyBfc2FmZVN1YnN0cmluZyhhLCAwLCA0KSA9PT0gJ/CfmInwn5qXJ1xyXG4vLyBfc2FmZVN1YnN0cmluZyhhLCAxLCAyKSA9PT0gX3NhZmVTdWJzdHJpbmcoYSwgMSwgMykgPT09ICfwn5iJJ1xyXG4vLyBfc2FmZVN1YnN0cmluZyhhLCAyLCAzKSA9PT0gX3NhZmVTdWJzdHJpbmcoYSwgMiwgNCkgPT09ICfwn5qXJ1xyXG5mdW5jdGlvbiBfc2FmZVN1YnN0cmluZyAodGFyZ2V0U3RyaW5nLCBzdGFydEluZGV4LCBlbmRJbmRleD8pIHtcclxuICAgIGxldCBuZXdTdGFydEluZGV4ID0gc3RhcnRJbmRleDtcclxuICAgIGxldCBuZXdFbmRJbmRleCA9IGVuZEluZGV4O1xyXG4gICAgY29uc3Qgc3RhcnRDaGFyID0gdGFyZ2V0U3RyaW5nW3N0YXJ0SW5kZXhdO1xyXG4gICAgLy8gbG93U3Vycm9nYXRlUmV4XHJcbiAgICBpZiAoc3RhcnRDaGFyID49ICdcXHVEQzAwJyAmJiBzdGFydENoYXIgPD0gJ1xcdURGRkYnKSB7XHJcbiAgICAgICAgbmV3U3RhcnRJbmRleC0tO1xyXG4gICAgfVxyXG4gICAgaWYgKGVuZEluZGV4ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBpZiAoZW5kSW5kZXggLSAxICE9PSBzdGFydEluZGV4KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGVuZENoYXIgPSB0YXJnZXRTdHJpbmdbZW5kSW5kZXggLSAxXTtcclxuICAgICAgICAgICAgLy8gaGlnaFN1cnJvZ2F0ZVJleFxyXG4gICAgICAgICAgICBpZiAoZW5kQ2hhciA+PSAnXFx1RDgwMCcgJiYgZW5kQ2hhciA8PSAnXFx1REJGRicpIHtcclxuICAgICAgICAgICAgICAgIG5ld0VuZEluZGV4LS07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gaGlnaFN1cnJvZ2F0ZVJleFxyXG4gICAgICAgIGVsc2UgaWYgKHN0YXJ0Q2hhciA+PSAnXFx1RDgwMCcgJiYgc3RhcnRDaGFyIDw9ICdcXHVEQkZGJykge1xyXG4gICAgICAgICAgICBuZXdFbmRJbmRleCsrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB0YXJnZXRTdHJpbmcuc3Vic3RyaW5nKG5ld1N0YXJ0SW5kZXgsIG5ld0VuZEluZGV4KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZyYWdtZW50VGV4dCAoc3RyaW5nVG9rZW46IHN0cmluZywgYWxsV2lkdGg6IG51bWJlciwgbWF4V2lkdGg6IG51bWJlciwgbWVhc3VyZVRleHQ6IChzdHJpbmc6IHN0cmluZykgPT4gbnVtYmVyKSB7XHJcbiAgICAvLyBjaGVjayB0aGUgZmlyc3QgY2hhcmFjdGVyXHJcbiAgICBjb25zdCB3cmFwcGVkV29yZHM6IHN0cmluZ1tdID0gW107XHJcbiAgICAvLyBmYXN0IHJldHVybiBpZiBzdHJBcnIgaXMgZW1wdHlcclxuICAgIGlmIChzdHJpbmdUb2tlbi5sZW5ndGggPT09IDAgfHwgbWF4V2lkdGggPCAwKSB7XHJcbiAgICAgICAgd3JhcHBlZFdvcmRzLnB1c2goJycpO1xyXG4gICAgICAgIHJldHVybiB3cmFwcGVkV29yZHM7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHRleHQgPSBzdHJpbmdUb2tlbjtcclxuICAgIHdoaWxlIChhbGxXaWR0aCA+IG1heFdpZHRoICYmIHRleHQubGVuZ3RoID4gMSkge1xyXG5cclxuICAgICAgICBsZXQgZnV6enlMZW4gPSB0ZXh0Lmxlbmd0aCAqICggbWF4V2lkdGggLyBhbGxXaWR0aCApIHwgMDtcclxuICAgICAgICBsZXQgdG1wVGV4dCA9IF9zYWZlU3Vic3RyaW5nKHRleHQsIGZ1enp5TGVuKTtcclxuICAgICAgICBsZXQgd2lkdGggPSBhbGxXaWR0aCAtIG1lYXN1cmVUZXh0KHRtcFRleHQpO1xyXG4gICAgICAgIGxldCBzTGluZSA9IHRtcFRleHQ7XHJcbiAgICAgICAgbGV0IHB1c2hOdW0gPSAwO1xyXG5cclxuICAgICAgICBsZXQgY2hlY2tXaGlsZSA9IDA7XHJcbiAgICAgICAgY29uc3QgY2hlY2tDb3VudCA9IDEwO1xyXG5cclxuICAgICAgICAvLyBFeGNlZWRlZCB0aGUgc2l6ZVxyXG4gICAgICAgIHdoaWxlICh3aWR0aCA+IG1heFdpZHRoICYmIGNoZWNrV2hpbGUrKyA8IGNoZWNrQ291bnQpIHtcclxuICAgICAgICAgICAgZnV6enlMZW4gKj0gbWF4V2lkdGggLyB3aWR0aDtcclxuICAgICAgICAgICAgZnV6enlMZW4gPSBmdXp6eUxlbiB8IDA7XHJcbiAgICAgICAgICAgIHRtcFRleHQgPSBfc2FmZVN1YnN0cmluZyh0ZXh0LCBmdXp6eUxlbik7XHJcbiAgICAgICAgICAgIHdpZHRoID0gYWxsV2lkdGggLSBtZWFzdXJlVGV4dCh0bXBUZXh0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNoZWNrV2hpbGUgPSAwO1xyXG5cclxuICAgICAgICAvLyBGaW5kIHRoZSB0cnVuY2F0aW9uIHBvaW50XHJcbiAgICAgICAgd2hpbGUgKHdpZHRoIDw9IG1heFdpZHRoICYmIGNoZWNrV2hpbGUrKyA8IGNoZWNrQ291bnQpIHtcclxuICAgICAgICAgICAgaWYgKHRtcFRleHQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4ZWMgPSBXT1JEX1JFRy5leGVjKHRtcFRleHQpO1xyXG4gICAgICAgICAgICAgICAgcHVzaE51bSA9IGV4ZWMgPyBleGVjWzBdLmxlbmd0aCA6IDE7XHJcbiAgICAgICAgICAgICAgICBzTGluZSA9IHRtcFRleHQ7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGZ1enp5TGVuID0gZnV6enlMZW4gKyBwdXNoTnVtO1xyXG4gICAgICAgICAgICB0bXBUZXh0ID0gX3NhZmVTdWJzdHJpbmcodGV4dCwgZnV6enlMZW4pO1xyXG4gICAgICAgICAgICB3aWR0aCA9IGFsbFdpZHRoIC0gbWVhc3VyZVRleHQodG1wVGV4dCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmdXp6eUxlbiAtPSBwdXNoTnVtO1xyXG4gICAgICAgIC8vIGluIGNhc2UgbWF4V2lkdGggY2Fubm90IGNvbnRhaW4gYW55IGNoYXJhY3RlcnMsIG5lZWQgYXQgbGVhc3Qgb25lIGNoYXJhY3RlciBwZXIgbGluZVxyXG4gICAgICAgIGlmIChmdXp6eUxlbiA9PT0gMCkge1xyXG4gICAgICAgICAgICBmdXp6eUxlbiA9IDE7XHJcbiAgICAgICAgICAgIHNMaW5lID0gX3NhZmVTdWJzdHJpbmcodGV4dCwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGhpZ2hTdXJyb2dhdGVSZXhcclxuICAgICAgICBlbHNlIGlmIChmdXp6eUxlbiA9PT0gMSAmJiB0ZXh0WzBdID49ICdcXHVEODAwJyAmJiB0ZXh0WzBdIDw9ICdcXHVEQkZGJykge1xyXG4gICAgICAgICAgICBmdXp6eUxlbiA9IDI7XHJcbiAgICAgICAgICAgIHNMaW5lID0gX3NhZmVTdWJzdHJpbmcodGV4dCwgMik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgc1RleHQgPSBfc2FmZVN1YnN0cmluZyh0ZXh0LCAwLCBmdXp6eUxlbik7XHJcbiAgICAgICAgbGV0IHJlc3VsdDtcclxuXHJcbiAgICAgICAgLy8gc3ltYm9sIGluIHRoZSBmaXJzdFxyXG4gICAgICAgIGlmIChXUkFQX0lOU1BFQ1RJT04pIHtcclxuICAgICAgICAgICAgaWYgKFNZTUJPTF9SRUcudGVzdChzTGluZSB8fCB0bXBUZXh0KSkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gTEFTVF9XT1JEX1JFRy5leGVjKHNUZXh0KTtcclxuICAgICAgICAgICAgICAgIGZ1enp5TGVuIC09IHJlc3VsdCA/IHJlc3VsdFswXS5sZW5ndGggOiAwO1xyXG4gICAgICAgICAgICAgICAgaWYgKGZ1enp5TGVuID09PSAwKSB7IGZ1enp5TGVuID0gMTsgfVxyXG5cclxuICAgICAgICAgICAgICAgIHNMaW5lID0gX3NhZmVTdWJzdHJpbmcodGV4dCwgZnV6enlMZW4pO1xyXG4gICAgICAgICAgICAgICAgc1RleHQgPSBfc2FmZVN1YnN0cmluZyh0ZXh0LCAwLCBmdXp6eUxlbik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIFRvIGp1ZGdlIHdoZXRoZXIgYSBFbmdsaXNoIHdvcmRzIGFyZSB0cnVuY2F0ZWRcclxuICAgICAgICBpZiAoRklSU1RfRU5HTElTSF9SRUcudGVzdChzTGluZSkpIHtcclxuICAgICAgICAgICAgcmVzdWx0ID0gTEFTVF9FTkdMSVNIX1JFRy5leGVjKHNUZXh0KTtcclxuICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiBzVGV4dCAhPT0gcmVzdWx0WzBdKSB7XHJcbiAgICAgICAgICAgICAgICBmdXp6eUxlbiAtPSByZXN1bHRbMF0ubGVuZ3RoO1xyXG4gICAgICAgICAgICAgICAgc0xpbmUgPSBfc2FmZVN1YnN0cmluZyh0ZXh0LCBmdXp6eUxlbik7XHJcbiAgICAgICAgICAgICAgICBzVGV4dCA9IF9zYWZlU3Vic3RyaW5nKHRleHQsIDAsIGZ1enp5TGVuKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVGhlIGZpcnN0IGxpbmUgQW5kIGRvIG5vdCB3cmFwIHNob3VsZCBub3QgcmVtb3ZlIHRoZSBzcGFjZVxyXG4gICAgICAgIGlmICh3cmFwcGVkV29yZHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHdyYXBwZWRXb3Jkcy5wdXNoKHNUZXh0KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHNUZXh0ID0gc1RleHQudHJpbSgpO1xyXG4gICAgICAgICAgICBpZiAoc1RleHQubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgd3JhcHBlZFdvcmRzLnB1c2goc1RleHQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRleHQgPSBzTGluZSB8fCB0bXBUZXh0O1xyXG4gICAgICAgIGFsbFdpZHRoID0gbWVhc3VyZVRleHQodGV4dCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHdyYXBwZWRXb3Jkcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICB3cmFwcGVkV29yZHMucHVzaCh0ZXh0KTtcclxuICAgIH1cclxuICAgIGVsc2Uge1xyXG4gICAgICAgIHRleHQgPSB0ZXh0LnRyaW0oKTtcclxuICAgICAgICBpZiAodGV4dC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHdyYXBwZWRXb3Jkcy5wdXNoKHRleHQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB3cmFwcGVkV29yZHM7XHJcbn1cclxuIl19