System.register([],(function(e){"use strict";return{execute:function(){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?c(e):t}function h(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=s(e)););return e}function _(e,t,i){return(_="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var n=h(e,t);if(n){var r=Object.getOwnPropertyDescriptor(n,t);return r.get?r.get.call(i):r.value}})(e,t,i||e)}function d(e,t,i,n){return(d="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,i,n){var r,o=h(e,t);if(o){if((r=Object.getOwnPropertyDescriptor(o,t)).set)return r.set.call(n,i),!0;if(!r.writable)return!1}if(r=Object.getOwnPropertyDescriptor(n,t)){if(!r.writable)return!1;r.value=i,Object.defineProperty(n,t,r)}else a(n,t,i);return!0})(e,t,i,n)}function f(e,t,i,n,r){if(!d(e,t,i,n||e)&&r)throw new Error("failed to set property");return i}function p(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var i=[],n=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(i.push(o.value),!t||i.length!==t);n=!0);}catch(e){r=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(r)throw a}}return i}(e,t)||v(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(e){return function(e){if(Array.isArray(e))return g(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||v(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(e,t){if(e){if("string"==typeof e)return g(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(i):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?g(e,t):void 0}}function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function y(e){var t=0;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(e=v(e)))return function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(t=e[Symbol.iterator]()).next.bind(t)}function x(e,t,i,n){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function S(e,t,i,n,r){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}e({BitMask:$e,CCClass:Ht,CacheMode:void 0,EAxisDirection:void 0,ERigidBodyType:void 0,Enum:et,Eventify:$i,GFXAPI:void 0,GFXAddress:void 0,GFXAttributeName:void 0,GFXBlendFactor:void 0,GFXBlendOp:void 0,GFXBufferAccessBit:void 0,GFXBufferFlagBit:void 0,GFXBufferUsageBit:void 0,GFXClearFlag:void 0,GFXColorMask:void 0,GFXCommandBufferType:void 0,GFXComparisonFunc:void 0,GFXCullMode:void 0,GFXDescriptorType:void 0,GFXDynamicStateFlagBit:void 0,GFXFeature:void 0,GFXFilter:void 0,GFXFormat:void 0,GFXFormatSize:Bs,GFXFormatSurfaceSize:Ls,GFXFormatType:void 0,GFXGetTypeSize:Fs,GFXLoadOp:void 0,GFXMemoryUsageBit:void 0,GFXObjectType:void 0,GFXPipelineBindPoint:void 0,GFXPolygonMode:void 0,GFXPrimitiveMode:void 0,GFXQueueType:void 0,GFXSampleCount:void 0,GFXShadeModel:void 0,GFXShaderStageFlagBit:void 0,GFXStencilFace:void 0,GFXStencilOp:void 0,GFXStoreOp:void 0,GFXTextureFlagBit:void 0,GFXTextureLayout:void 0,GFXTextureType:void 0,GFXTextureUsageBit:void 0,GFXType:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,IsPowerOf2:Ol,Overflow:void 0,SystemEventType:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:PC,WorldNode3DToWorldNodeUI:kC,absMax:kn,absMaxComponent:Pn,approx:mn,assert:D,assertID:q,bezier:Kz,bezierByTime:iU,ccenum:nt,clamp:vn,clamp01:gn,color:Pa,computeRatioByType:oU,deserialize:KC,equals:pn,error:k,errorID:V,find:sT,fragmentText:Au,getPathFromRoot:function(e,t){var i=e,n="";for(;null!==i&&i!==t;)n="".concat(i.name,"/").concat(n),i=i.parent;return n.slice(0,-1)},getTypedArrayConstructor:zs,getWorldTransformUntilRoot:hg,instantiate:uw,inverseLerp:Mn,isCustomTargetModifier:XG,isDisplayStats:Y,isElementModifier:qG,isPropertyModifier:jG,isUnicodeCJK:Su,isUnicodeSpace:Tu,isValid:ji,lerp:yn,log:M,logID:z,markAsWarning:void 0,mat4:Aa,murmurhash2_32_gc:rl,nextPow2:Rn,pingPong:On,pseudoRandom:An,pseudoRandomRange:Cn,pseudoRandomRangeInt:wn,quat:Sa,randomRange:En,randomRangeInt:bn,rect:Oa,removeProperty:void 0,repeat:In,replaceProperty:void 0,safeMeasureText:Eu,sampleAnimationCurve:aU,setDefaultLogTimes:function(e){e>0&&(za=e)},setDisplayStats:K,size:Ra,toDegree:Sn,toRadian:xn,tween:zee,tweenUtil:Uee,v2:aa,v3:ca,v4:ha,warn:P,warnID:G});var T="undefined"==typeof window?global:window,E=e("cclegacy",{_global:T});E.internal={};T.CocosEngine=E.ENGINE_VERSION="1.2.0",T.cc=E;var b="https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md",A=null,C=console.log,w=console.log,R=console.log,I=function(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+O.apply(void 0,[t].concat(n)))}};function O(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return E.js.formatStr.apply(null,[e].concat(i))}function M(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return C.apply(void 0,[e].concat(i))}function P(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return w.apply(void 0,[e].concat(i))}function k(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return R.apply(void 0,[e].concat(i))}function D(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return I.apply(void 0,[e,t].concat(n))}function B(e){if(C=w=R=I=function(){},e!==W.NONE){if(e>W.ERROR){var t=function(e){if(E.game.canvas){if(!A){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",E.game.canvas.height);var i=t.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(A=document.createElement("textarea")).setAttribute("rows","20"),A.setAttribute("cols","30"),A.setAttribute("disabled","true");var n=A.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(A),E.game.canvas.parentNode.appendChild(t)}A.value=A.value+e+"\r\n",A.scrollTop=A.scrollHeight}};R=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t("ERROR :  "+O.apply(void 0,[e].concat(n)))},I=function(e,i){if(!e){for(var n=arguments.length,r=new Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];t("ASSERT: "+O.apply(void 0,[i].concat(r)))}},e!==W.ERROR_FOR_WEB_PAGE&&(w=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t("WARN :  "+O.apply(void 0,[e].concat(n)))}),e===W.INFO_FOR_WEB_PAGE&&(C=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t(O.apply(void 0,[e].concat(n)))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),R=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.error.apply(console,[e].concat(i))},I=function(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var a=O.apply(void 0,[t].concat(n));throw new Error(a)}});e!==W.ERROR&&(w=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.warn.apply(console,[e].concat(i))}),e===W.INFO&&(C=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return console.log.apply(console,[e].concat(i))})}}function L(e){var t=e.stack;k(t||e)}function N(e){return function(t){for(var i="".concat(e," ").concat(t,", please go to ").concat(b,"#").concat(t," to see details."),n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];return 0===r.length?i:i+" Arguments: "+r.join(", ")}}var F=N("Log");function z(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];M(F.apply(void 0,[e].concat(i)))}var U=N("Warning");function G(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];P(U.apply(void 0,[e].concat(i)))}var H=N("Error");function V(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];k(H.apply(void 0,[e].concat(i)))}var W,j=N("Assert");function q(e,t){if(!e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];D(!1,j.apply(void 0,[t].concat(n)))}}function X(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];return H.apply(void 0,[e].concat(i))}function Y(){return!!E.profiler&&E.profiler.isShowingStats()}function K(e){E.profiler&&(e?E.profiler.showStats():E.profiler.hideStats(),E.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE"}(W||(W={}));var Z=Object.freeze({__proto__:null,log:M,warn:P,error:k,assert:D,_resetDebugSetting:B,_throw:L,logID:z,warnID:G,errorID:V,assertID:q,get DebugMode(){return W},getError:X,isDisplayStats:Y,setDisplayStats:K}),Q=function(){function e(t){i(this,e),this.i=0,this.array=t}return r(e,[{key:"remove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)}},{key:"removeAt",value:function(e){this.array.splice(e,1),e<=this.i&&--this.i}},{key:"fastRemove",value:function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)}},{key:"fastRemoveAt",value:function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i}},{key:"push",value:function(e){this.array.push(e)}},{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function J(e,t){e.splice(t,1)}function $(e,t){var i=e.indexOf(t);return i>=0&&(J(e,i),!0)}function ee(e,t){return e.indexOf(t)>=0}var te=Object.freeze({__proto__:null,removeAt:J,fastRemoveAt:function(e,t){var i=e.length;t<0||t>=i||(e[t]=e[i-1],e.length=i-1)},remove:$,fastRemove:function(e,t){var i=e.indexOf(t);i>=0&&(e[i]=e[e.length-1],--e.length)},removeIf:function(e,t){var i=e.findIndex(t);if(i>=0){var n=e[i];return J(e,i),n}},verifyType:function(e,t){if(e&&e.length>0)for(var i,n=y(e);!(i=n()).done;){if(!(i.value instanceof t))return z(1300),!1}return!0},removeArray:function(e,t){for(var i=0,n=t.length;i<n;i++)$(e,t[i])},appendObjectsAt:function(e,t,i){return e.splice.apply(e,[i,0].concat(m(t))),e},contains:ee,copy:function(e){for(var t=e.length,i=new Array(t),n=0;n<t;n+=1)i[n]=e[n];return i},MutableForwardIterator:Q}),ie=function(){function e(t){i(this,e),this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return r(e,[{key:"getNewId",value:function(){return this.prefix+ ++this.id}}]),e}();ie.global=new ie("global");var ne=new ie("TmpCId."),re="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]");function ae(e){return"number"==typeof e||e instanceof Number}function oe(e){return"string"==typeof e||e instanceof String}var se,le=(se={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,i,n,r){se.value=i,se.writable=n,se.enumerable=r,Object.defineProperty(e,t,se),se.value=void 0}),ce=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,i,n,r){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];"boolean"==typeof r&&(a=r,r=void 0),e.get=n,e.set=r,e.enumerable=a,e.configurable=o,Object.defineProperty(t,i,e),e.get=void 0,e.set=void 0}}(),ue=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,i,n,r,a){e.get=n,e.enumerable=r,e.configurable=a,Object.defineProperty(t,i,e),e.get=void 0}}(),he=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,i,n,r,a){e.set=n,e.enumerable=r,e.configurable=a,Object.defineProperty(t,i,e),e.set=void 0}}();function _e(e){var t=Object.create(null);if(e){t["."]=!0,t["/"]=!0,delete t["."],delete t["/"]}return t}function de(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var i="";if(e.name&&(i=e.name),e.toString){var n,r=e.toString();(n="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}return e&&e.constructor?de(e.constructor):""}function fe(e,t,i,n){var r=/([^.]+)$/,a=r.exec(t)[0],o=r.exec(i)[0];function s(){return this[o]}n?ce(e,a,s,(function(e){this[o]=e})):ue(e,a,s)}function pe(e,t,i,n){for(var r in i){fe(e,t+"."+r,i[r],n)}}var me=/(%d)|(%s)/,ve=/%s/;function ge(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+e;var r="string"==typeof e&&me.test(e);if(r)for(var a,o=y(i);!(a=o()).done;){var s=a.value,l="number"==typeof s?me:ve;l.test(e)?e=e.replace(l,s):e+=" "+s}else for(var c,u=y(i);!(c=u()).done;){var h=c.value;e+=" "+h}return e}function ye(){for(var e=arguments.length-1,t=new Array(e),i=0;i<e;++i)t[i]=arguments[i+1];return t}function xe(e,t){for(;e;){var i=Object.getOwnPropertyDescriptor(e,t);if(i)return i;e=Object.getPrototypeOf(e)}return null}function Se(e,t,i){var n=xe(t,e);n&&Object.defineProperty(i,e,n)}function Te(e){e=e||{};for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var a=0,o=n;a<o.length;a++){var s=o[a];if(s){if("object"!==t(s)){V(5402,s);continue}for(var l in s)l in e||Se(l,s,e)}}return e}function Ee(e){e=e||{};for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var a=0,o=n;a<o.length;a++){var s=o[a];if(s){if("object"!==t(s)){V(5403,s);continue}for(var l in s)Se(l,s,e)}}return e}function be(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ae(e){var t=e.prototype,i=t&&Object.getPrototypeOf(t);return i&&i.constructor}function Ce(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ae(e)))return!1;if(e===t)return!0}}return!1}function we(e){for(var t=0,i=Object.keys(e);t<i.length;t++){delete e[i[t]]}}var Re={},Ie={};function Oe(e,t){var i=Re;if(t.prototype.hasOwnProperty("__cid__")&&delete i[t.prototype.__cid__],le(t.prototype,"__cid__",e),e){var n=i[e];if(n&&n!==t)k('A Class already exists with the same __cid__ : "'+e+'".');else i[e]=t}}function Me(e,t){if(function(e,t){var i=Ie;if(t.prototype.hasOwnProperty("__classname__")&&delete i[t.prototype.__classname__],le(t.prototype,"__classname__",e),e){var n=i[e];if(n&&n!==t)k('A Class already exists with the same __classname__ : "'+e+'".');else i[e]=t}}(e,t),!t.prototype.hasOwnProperty("__cid__")){var i=e||ne.getNewId();i&&Oe(i,t)}}function Pe(e,t){var i=Ie[t],n=Re[t],r=!0;if(i&&i!==e&&(k('"'.concat(t,'" has already been set as name or alias of another class.')),r=!1),n&&n!==e&&(k('"'.concat(t,'" has already been set as id or alias of another class.')),r=!1),r){var a=e[re];a||(a=[],e[re]=a),a.push(t),Ie[t]=e,Re[t]=e}}function ke(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];for(var n=0,r=t;n<r.length;n++){var a=r[n],o=a.prototype,s=o.__cid__;s&&delete Re[s];var l=o.__classname__;l&&delete Ie[l];var c=o[re];if(c)for(var u=0;u<c.length;++u){var h=c[u];delete Ie[h],delete Re[h]}}}function De(e){return Re[e]}function Be(e){return Ie[e]}function Le(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty("__cid__"))return e.prototype.__cid__;if(e&&e.constructor){var i=e.constructor.prototype;if(i&&i.hasOwnProperty("__cid__"))return e.__cid__}return""}var Ne=function(){function e(t,n){i(this,e),this.count=void 0,this._pool=void 0,this._cleanup=void 0;var r=void 0===n?t:n,a=void 0===n?null:t;this.count=0,this._pool=new Array(r),this._cleanup=a}return r(e,[{key:"get",value:function(){return this._get()}}]),r(e,[{key:"_get",value:function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null}},{key:"put",value:function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}}},{key:"resize",value:function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))}}]),e}(),Fe=te,ze={IDGenerator:ie,Pool:Ne,array:te,isNumber:ae,isString:oe,getPropertyDescriptor:xe,addon:Te,mixin:Ee,extend:be,getSuper:Ae,isChildClassOf:Ce,clear:we,value:le,getset:ce,get:ue,set:he,unregisterClass:ke,getClassName:de,setClassName:Me,setClassAlias:Pe,getClassByName:Be,_getClassId:Le,_setClassId:Oe,_getClassById:De,obsolete:fe,obsoletes:pe,formatStr:ge,shiftArguments:ye,createMap:_e};E.js=ze,e("js",Object.freeze({__proto__:null,array:Fe,js:ze,IDGenerator:ie,Pool:Ne,isNumber:ae,isString:oe,value:le,getset:ce,get:ue,set:he,createMap:_e,getClassName:de,obsolete:fe,obsoletes:pe,formatStr:ge,shiftArguments:ye,getPropertyDescriptor:xe,addon:Te,mixin:Ee,extend:be,getSuper:Ae,isChildClassOf:Ce,clear:we,_idToClass:Re,_nameToClass:Ie,_setClassId:Oe,setClassName:Me,setClassAlias:Pe,unregisterClass:ke,_getClassById:De,getClassByName:Be,_getClassId:Le}));for(var Ue=/^(?:cc|dragonBones|sp|ccsg)\..+/,Ge=new Array(123),He=0;He<123;++He)Ge[He]=64;for(var Ve=0;Ve<64;++Ve)Ge["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(Ve)]=Ve;var We=Ge;function je(e,t,i){function n(e,t,i,n){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[i]=r.get),r.set&&n&&(e[n]=r.set);else{var a=e[i];ce(e,t,a,e[n])}}for(var r,a=e.prototype,o=0;o<t.length;o++){var s=(r=t[o])[0].toUpperCase()+r.slice(1);n(a,r,"get"+s,"set"+s)}for(r in i){var l=i[r];n(a,r,l[0],l[1])}}function qe(e,t,i,n){var r=e[t];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):e[t]=n?[i,r]:[r,i]:e[t]=i}function Xe(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var i=t.parentNode;if(i)do{if(i===e)return!0;i=i.parentNode}while(null!==i);return!1}function Ye(e){return"object"===("undefined"==typeof window?"undefined":t(window))&&"function"==typeof Node?e instanceof Node:e&&"object"===t(e)&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function Ke(e,t,i){e&&setTimeout((function(){e(t,i)}),0)}function Ze(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")}function Qe(e){if(!e||e.constructor!==Object)return!1;for(var t in e)return!1;return!0}function Je(e){return e&&"function"==typeof e.clone&&(e.constructor&&e.constructor.prototype.hasOwnProperty("clone")||e.hasOwnProperty("clone"))}function $e(e){if("__bitmask__"in e)return e;le(e,"__bitmask__",null,!0);for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o=""+a;r!==o&&le(e,o,r)}return e}function et(e){return"__enums__"in e?e:(le(e,"__enums__",null,!0),et.update(e))}function tt(e){e.hasOwnProperty("__enums__")}function it(e){tt(e);var t=e.__enums__||[];for(var i in t.length=0,e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function nt(e){"__enums__"in e||le(e,"__enums__",null,!0)}E.misc={BUILTIN_CLASSID_RE:Ue,BASE64_VALUES:We,propertyDefine:je,pushToMap:qe,contains:Xe,isDomNode:Ye,callInNextTick:Ke,tryCatchFunctor_EDITOR:Ze,isPlainEmptyObj_DEV:Qe,cloneable_DEV:Je},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:Ue,BASE64_VALUES:We,propertyDefine:je,pushToMap:qe,contains:Xe,isDomNode:Ye,callInNextTick:Ke,tryCatchFunctor_EDITOR:Ze,isPlainEmptyObj_DEV:Qe,cloneable_DEV:Je})),$e.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},$e.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var i in e){var n=e[i];Number.isInteger(n)&&t.push({name:i,value:n})}return t.sort((function(e,t){return e.value-t.value})),t},E.BitMask=$e,et.update=function(e){for(var t=-1,i=Object.keys(e),n=0;n<i.length;n++){var r=i[n],a=e[r];if(-1===a)a=++t,e[r]=a;else if("number"==typeof a)t=a;else if("string"==typeof a&&Number.isInteger(parseFloat(r)))continue;var o=""+a;r!==o&&le(e,o,r)}return Array.isArray(e.__enums__)&&it(e),e},et||(et=e("Enum",{})),et.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},et.getList=function(e){return tt(e),e.__enums__?e.__enums__:it(e)},E.Enum=et;var rt=e("ValueType",function(){function e(){i(this,e)}return r(e,[{key:"clone",value:function(){return V(100,de(this)+".clone"),this}},{key:"equals",value:function(e){return!1}},{key:"set",value:function(e){V(100,de(this)+".set")}},{key:"toString",value:function(){return""+{}}}]),e}());Me("cc.ValueType",rt),E.ValueType=rt;function at(e,t,i){var n;n=function(){},i&&be(n,i.constructor);var r=new n;return le(e,"__attrs__",r),r}function ot(e){for(var t,i=E.Class.getInheritanceChain(e),n=i.length-1;n>=0;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||at(r,0,(t=i[n+1])&&t.__attrs__)}return at(e,0,(t=i[0])&&t.__attrs__),e.__attrs__}function st(e,i,n){var r,a;if("function"==typeof e)a=(r=lt(e)).constructor.prototype;else{var o=e;if(!(r=o.__attrs__))r=at(o,0,lt(e=o.constructor));a=r}if(void 0===n){var s=i+"$_$",l={};for(var c in r)c.startsWith(s)&&(l[c.slice(s.length)]=r[c]);return l}if("object"===t(n))for(var u in n)95!==u.charCodeAt(0)&&(a[i+"$_$"+u]=n[u])}function lt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||ot(e)}function ct(e){return lt(e).constructor.prototype}function ut(e,t,i,n){ct(e)[t+"$_$"+i]=n}var ht=function(){function e(t,n){i(this,e),this.name=void 0,this.default=void 0,this.name=t,this.default=n}return r(e,[{key:"toString",value:function(){return this.name}}]),e}(),_t=e("CCInteger",new ht("Integer",0));E.Integer=_t,E.CCInteger=_t;var dt=e("CCFloat",new ht("Float",0));E.Float=dt,E.CCFloat=dt;var ft=e("CCBoolean",new ht("Boolean",!1));E.Boolean=ft,E.CCBoolean=ft;var pt=e("CCString",new ht("String",""));function mt(e,i){return function(n,r){var a='"'+de(n)+"."+r+'"',o=st(n,r);if(!o.saveUrlAsAsset){var s=o.type;if(s===_t||s===dt?s="Number":s!==pt&&s!==ft||(s=s.toString()),s!==e)return void G(3604,a)}if(o.hasOwnProperty("default")){var l=o.default;if(void 0!==l)if(!(Array.isArray(l)||Qe(l))){var c=t(l),u=e.toLowerCase();if(c===u){if(!o.saveUrlAsAsset)if("object"===u){if(!l||l instanceof o.ctor)return;G(3605,a,de(o.ctor))}else"Number"!==e&&G(3606,i,a,e)}else{if("function"===c)return;e===pt.default&&null==l?Ce(o.ctor,E.RawAsset)||G(3607,a):G(3611,i,a,c)}delete o.type}}}}E.String=pt,E.CCString=pt;var vt=Object.freeze({__proto__:null,DELIMETER:"$_$",createAttrsSingle:at,createAttrs:ot,attr:st,getClassAttrs:lt,getClassAttrsProto:ct,setClassAttr:ut,PrimitiveType:ht,CCInteger:_t,CCFloat:dt,CCBoolean:ft,CCString:pt,getTypeChecker:mt,getObjTypeChecker:function(e){return function(t,i){mt("Object","type")(t,i);var n=lt(t)[i+"$_$default"],r=E.Class.getDefault(n);if(!Array.isArray(r)&&Ce(e,E.ValueType)){var a=de(e),o=ge('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',de(t),i,a);n?M(o):G(3612,o,a,de(t),i,a)}}}}),gt={url:{canUsedInGet:!0},default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function yt(e,t,i,n){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,i.call(this,t)};var a={};for(var o in n[r]=a,gt){var s=gt[o];e.hasOwnProperty(o)&&(a[o]=e[o],s.canUsedInGet||delete e[o])}}}function xt(e,t,i,n){Array.isArray(n)&&n.length>0&&(n=n[0]),e.type=n}function St(e,t,i,n){if(Array.isArray(t)){if(!(t.length>0))return V(5508,i,n);if(E.RawAsset.isRawAssetType(t[0]))return e.url=t[0],void delete e.type;e.type=t=t[0]}}function Tt(e,t,i){if(!(e&&e.constructor===Object)){if(Array.isArray(e)&&e.length>0){e[0];return{default:[],type:e,_short:!0}}if("function"==typeof e){var n=e;return E.RawAsset.isRawAssetType(n)?{default:"",url:n,_short:!0}:{default:Ce(n,E.ValueType)?new n:null,type:n,_short:!0}}return e instanceof ht?{default:e.default,_short:!0}:{default:e,_short:!0}}return null}function Et(e,t,i,n,r){return"function"==typeof e||null===e}var bt=[];function At(){return bt[bt.length-1]}E._RF={push:function(e,t,i,n){void 0===i&&(i=t,t=""),bt.push({uuid:t,script:i,module:e,exports:e.exports,beh:null,importMeta:n})},pop:function(){var e=bt.pop(),t=e.module,i=t.exports;if(i===e.exports){for(var n in i)return;t.exports=i=e.cls}},peek:At};var Ct=["name","extends","mixins","ctor","__ctor__","properties","statics","editor","__ES6__"];function wt(e,t){e.indexOf(t)<0&&e.push(t)}var Rt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var i=e[t],n=i.cls,r=i.props;"function"==typeof r&&(r=r());var a=de(n);r?Gt(n,a,r,n.$super,i.mixins):V(3633,a)}this.datas=null}}};var It=[];function Ot(e,t,i,n,r){ut(e,i,"default",n.default),function(e,t){wt(e.__props__,t)}(e,i);var a=jt(e,n,t,i);if(a){for(var o=It,s=0;s<a.length;s++){var l=a[s];st(e,i,l),!1===l.serializable&&wt(e.__values__,i),l._onAfterProp&&o.push(l._onAfterProp)}for(var c=0;c<o.length;c++)o[c](e,i);It.length=0,a.length=0}}function Mt(e,t,i,n,r){var a=n.get,o=n.set,s=e.prototype,l=!Object.getOwnPropertyDescriptor(s,i);if(a){for(var c=jt(e,n,t,i),u=0;u<c.length;u++)st(e,i,c[u]);c.length=0,ut(e,i,"serializable",!1),r||ue(s,i,a,l,l)}o&&(r||he(s,i,o,l,l))}function Pt(e){return"function"==typeof e?e():e}function kt(e,t,i){for(var n in t)e.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(e,n,xe(t,n))}function Dt(e,t,i,n){var r,a,o=n.__ctor__,s=n.ctor,l=n.__ES6__;l?(r=[s],a=s):(r=o?[o]:function(e,t,i){for(var n=[],r=[e].concat(t),a=0;a<r.length;a++){var o=r[a];if(o)for(var s=(c=o,Ht._isCCClass(c)?c.__ctors__||[]:[c]),l=0;l<s.length;l++)wt(n,s[l])}var c;var u=i.ctor;u&&n.push(u);return n}(t,i,n),a=zt(r,t,e,n),le(a,"extend",(function(e){return e.extends=this,Ht(e)}),!0)),le(a,"__ctors__",r.length>0?r:null,!0);var c=a.prototype;if(t&&(l||(be(a,t),c=a.prototype),a.$super=t),i){for(var u=function(e){var t=i[e];kt(c,t.prototype),kt(a,t,(function(e){return t.hasOwnProperty(e)&&!0})),Ht._isCCClass(t)&&kt(lt(a).constructor.prototype,lt(t).constructor.prototype)},h=i.length-1;h>=0;h--)u(h);c.constructor=a}return l||(c.__initProps__=Ft),Me(e,a),a}function Bt(e){for(var t=de(e),i=e.constructor,n="new "+t+"(",r=0;r<i.__props__.length;r++){n+=e[i.__props__[r]],r<i.__props__.length-1&&(n+=",")}return n+")"}function Lt(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}var Nt=/^[A-Za-z_$][0-9A-Za-z_$]*$/;function Ft(e){var i=lt(e),n=e.__props__;null===n&&(Rt.init(),n=e.__props__);var r=function(e,i){for(var n=[],r="",a=0;a<i.length;a++){var o=i[a],s=o+"$_$default";if(s in e){var l=void 0;l=Nt.test(o)?"this."+o+"=":"this["+Lt(o)+"]=";var c=void 0,u=e[s];if("object"===t(u)&&u)c=u instanceof E.ValueType?Bt(u):Array.isArray(u)?"[]":"{}";else if("function"==typeof u){var h=n.length;n.push(u),c="F["+h+"]()"}else c="string"==typeof u?Lt(u):u;r+=l=l+c+";\n"}}return 0===n.length?Function(r):Function("F","return (function(){\n"+r+"})")(n)}(i,n);e.prototype.__initProps__=r,r.call(this)}var zt=function(e,t,i,n){var r="return function CCClass(){\n";t&&function(e,t,i){var n=!1;for(var r in t)if(!(Ct.indexOf(r)>=0)){var a=t[r];if("function"==typeof a){var o=xe(e.prototype,r);if(o){var s=o.value;if("function"==typeof s){Ut.test(a)&&(n=!0,t[r]=function(e,t){return function(){var i=this._super;this._super=e;var n=t.apply(this,arguments);return this._super=i,n}}(s,a));continue}}}}return n}(t,n)&&(r+="this._super=null;\n"),r+="this.__initProps__(CCClass);\n";var a=e.length;if(a>0){0;var o="].apply(this,arguments);\n";if(1===a)r+="CCClass.__ctors__[0"+o;else{r+="var cs=CCClass.__ctors__;\n";for(var s=0;s<a;s++)r+="cs["+s+o}0}return r+="}",Function(r)()};var Ut=/xyz/.test(function(){}.toString())?/\b\._super\b/:/.*/;function Gt(e,t,i,n,r,a){if(e.__props__=[],n&&n.__props__&&(e.__props__=n.__props__.slice()),r)for(var o=0;o<r.length;++o){var s=r[o];s.__props__&&(e.__props__=e.__props__.concat(s.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(i)for(var l in function(e,t,i,n){for(var r in e){var a=e[r],o=Tt(a);if(o&&(a=e[r]=o),a){var s=a.notify;s&&yt(a,r,s,e),"type"in a&&St(a,a.type,t,r),"url"in a&&xt(a,0,0,a.url),"type"in a&&a.type}}}(i,t),i){var c=i[l];"default"in c?Ot(e,t,l,c):Mt(e,t,l,c,a)}var u=lt(e);e.__values__=e.__props__.filter((function(e){return!1!==u[e+"$_$serializable"]}))}function Ht(e){var t=(e=e||{}).name,i=e.extends,n=e.mixins,r=function(e,t,i,n){var r=E.Component,a=At();if(a&&Ce(t,r)){if(Ce(a.cls,r))return V(3615),null;e=e||a.script}var o=Dt(e,t,i,n),s=Ce(t,E.RenderPipeline),l=Ce(t,E.RenderFlow),c=Ce(t,E.RenderStage);if(s||l||c||!1){var u="";s?u="render_pipeline":l?u="render_flow":c&&(u="render_stage"),u&&Oe(e,o)}if(a)if(Ce(t,r)){var h=a.uuid;h&&Oe(h,o),a.cls=o}else Ce(a.cls,r)||(a.cls=o);return o}(t,i,n,e);t||(t=E.js.getClassName(r)),r._sealed=!0,i&&(i._sealed=!1);var a=e.properties;"function"==typeof a||i&&null===i.__props__||n&&n.some((function(e){return null===e.__props__}))?(Rt.push({cls:r,props:a,mixins:n}),r.__props__=r.__values__=null):Gt(r,t,a,i,e.mixins,e.__ES6__);var o,s=e.statics;if(s)for(o in s)r[o]=s[o];for(var l in e)if(!(Ct.indexOf(l)>=0)){var c=e[l];Et(c)&&le(r.prototype,l,c,!0,!0)}var u=e.editor;return u&&Ce(i,E.Component)&&E.Component._registerEditorProps(r,u),r}Ht._isCCClass=function(e){return e&&e.hasOwnProperty&&e.hasOwnProperty("__ctors__")},Ht.fastDefine=function(e,t,i){Me(e,t);for(var n=t.__props__=t.__values__=Object.keys(i),r=ct(t),a=0;a<n.length;a++){var o=n[a];r[o+"$_$visible"]=!1,r[o+"$_$default"]=i[o]}},Ht.Attr=vt,Ht.attr=st,Ht.getInheritanceChain=function(e){for(var t=[];e=Ae(e);)e!==Object&&t.push(e);return t};var Vt={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"},Wt=[];function jt(e,i,n,r,a){var o=null,s="";function l(){return s=r+"$_$",o=ct(e)}Wt.length=0;var c=Wt;"type"in i&&void 0===i.type&&G(3660,r,n);var u=i.type;if(u)if(Vt[u])c.push({type:u,_onAfterProp:void 0});else if("Object"===u);else if("object"===t(u))et.isEnum(u)?c.push({type:"Enum",enumList:et.getList(u)}):$e.isBitMask(u)&&c.push({type:"BitMask",bitmaskList:$e.getList(u)});else if("function"==typeof u){c.push({type:"Object",ctor:u,_onAfterProp:void 0})}var h,_=function(e,n){if(e in i){var r=i[e];t(r)===n&&((o||l())[s+e]=r)}};(i.editorOnly&&((o||l())[s+"editorOnly"]=!0),i.url&&((o||l())[s+"saveUrlAsAsset"]=!0),i.__noImplicit)?(o||l())[s+"serializable"]=null!==(h=i.serializable)&&void 0!==h&&h:!1===i.serializable&&((o||l())[s+"serializable"]=!1);_("formerlySerializedAs","string");var d=i.range;return d&&Array.isArray(d)&&d.length>=2&&((o||l())[s+"min"]=d[0],(o||l())[s+"max"]=d[1],d.length>2&&((o||l())[s+"step"]=d[2])),_("min","number"),_("max","number"),_("step","number"),c}Ht.isArray=function(e){return e=Pt(e),Array.isArray(e)},Ht.getDefault=Pt,Ht.escapeForJS=Lt,Ht.IDENTIFIER_RE=Nt,Ht.getNewValueTypeCode=Bt,E.Class=Ht;var qt=function(){},Xt=function(){return qt},Yt=Kt((function(){}));function Kt(e){return function(t){return"function"==typeof t?e(t):function(i){return e(i,t)}}}function Zt(e,t,i){var n=Jt(e);if(n){var r=$t(n,"proto");$t(r,"editor")[t]=i}}function Qt(e){return function(t){return function(i){Zt(i,e,t)}}}function Jt(e,t){return $t(e,"__ccclassCache__")}function $t(e,t){return e[t]||(e[t]={})}var ei,ti,ii=Kt((function(e,t){var i=ze.getSuper(e);i===Object&&(i=null);var n={name:t,extends:i,ctor:e,__ES6__:!0},r=e.__ccclassCache__;if(r){var a=r.proto;a&&ze.mixin(n,a),e.__ccclassCache__=void 0}return Ht(n)})),ni=Qt("requireComponent"),ri=Qt("executionOrder"),ai=(ei="disallowMultiple",Kt((function(e,t){Zt(e,ei,void 0!==ti?ti:t)})));function oi(e,i,n){var r=null;function a(e,i,n){var a=Jt(e.constructor);if(a){var o=$t(a,"proto"),s=$t(o,"properties");!function(e,i,n,r,a,o){var s;r&&(s=(s=Tt(r))||r);var l=i[n],c=ze.mixin(l||{},s||{});if(a&&(a.get||a.set))a.get&&(c.get=a.get),a.set&&(c.set=a.set);else{var u;if(a)a.initializer&&(u=function(e){var i;try{i=e()}catch(t){return e}return"object"!==t(i)||null===i?i:e}(a.initializer));else{var h=o.default||(o.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));h.hasOwnProperty(n)&&(u=h[n])}c.default=u}i[n]=c}(e.constructor,s,i,r,n,a)}}return void 0===e?oi({type:void 0}):void 0===i?(r=e,a):void a(e,i,n)}var si=function(e,t,i){return oi(ui({}))(e,t,i)};function li(e){return oi(ui({formerlySerializedAs:e}))}var ci=function(e,t,i){return oi({editorOnly:!0})(e,t,i)};function ui(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var hi=Yt,_i=Xt,di=Yt,fi=Xt,pi=Xt,mi=Xt,vi=qt,gi=Xt,yi=qt,xi=Xt,Si=Xt,Ti=Xt,Ei=Xt,bi=Xt,Ai=Xt,Ci=qt,wi=Xt,Ri=Xt,Ii=qt,Oi=qt,Mi=qt,Pi=Li(_t),ki=Li(dt),Di=Li(ft),Bi=Li(pt);function Li(e){return oi({type:e})}var Ni=function(e,t,i){return oi({__noImplicit:!0,override:!0})(e,t,i)},Fi=e("Event",function(){function e(t,n){i(this,e),this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!n}return r(e,[{key:"unuse",value:function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}},{key:"reuse",value:function(e,t){this.type=e,this.bubbles=t||!1}},{key:"isStopped",value:function(){return this.propagationStopped||this.propagationImmediateStopped}},{key:"getCurrentTarget",value:function(){return this.currentTarget}},{key:"getType",value:function(){return this.type}}]),e}());Fi.NO_TYPE="no_type",Fi.TOUCH="touch",Fi.MOUSE="mouse",Fi.KEYBOARD="keyboard",Fi.ACCELERATION="acceleration",Fi.NONE=0,Fi.CAPTURING_PHASE=1,Fi.AT_TARGET=2,Fi.BUBBLING_PHASE=3,E.Event=Fi;var zi=e("Pool",function(){function e(t,n){i(this,e),this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._ctor=t,this._elementsPerBatch=Math.max(n,1),this._nextAvail=this._elementsPerBatch-1;for(var r=0;r<this._elementsPerBatch;++r)this._freepool.push(t())}return r(e,[{key:"alloc",value:function(){if(this._nextAvail<0){for(var e=this._elementsPerBatch,t=0;t<e;t++)this._freepool.push(this._ctor());this._nextAvail=e-1}var i=this._freepool[this._nextAvail--];return this._freepool.length--,i}},{key:"free",value:function(e){this._freepool.push(e),this._nextAvail++}},{key:"freeArray",value:function(e){Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length}},{key:"destroy",value:function(e){if(e)for(var t=0;t<=this._nextAvail;t++)e(this._freepool[t]);this._freepool.length=0,this._nextAvail=-1}}]),e}()),Ui=e("RecyclePool",function(){function e(t,n){i(this,e),this._fn=void 0,this._count=0,this._data=void 0,this._fn=t,this._data=new Array(n);for(var r=0;r<n;++r)this._data[r]=t()}return r(e,[{key:"reset",value:function(){this._count=0}},{key:"resize",value:function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()}},{key:"add",value:function(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}},{key:"removeAt",value:function(e){if(!(e>=this._count)){var t=this._count-1,i=this._data[e];this._data[e]=this._data[t],this._data[t]=i,this._count-=1}}},{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}()),Gi=e("CachedArray",function(){function e(t,n){i(this,e),this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(t),this.length=0,this._compareFn=void 0!==n?n:function(e,t){return e-t}}return r(e,[{key:"push",value:function(e){this.array[this.length++]=e}},{key:"pop",value:function(){return this.array[--this.length]}},{key:"get",value:function(e){return this.array[e]}},{key:"clear",value:function(){this.length=0}},{key:"sort",value:function(){this.array.length=this.length,this.array.sort(this._compareFn)}},{key:"concat",value:function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]}},{key:"fastRemove",value:function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}}},{key:"indexOf",value:function(e){return this.array.indexOf(e)}}]),e}());e("memop",Object.freeze({__proto__:null,Pool:zi,RecyclePool:Ui,CachedArray:Gi}));var Hi=[];var Vi=e("CCObject",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";i(this,e),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}return r(e,null,[{key:"_deferredDestroy",value:function(){for(var e=Hi.length,t=0;t<e;++t){var i=Hi[t];1&i._objFlags||i._destroyImmediate()}e===Hi.length?Hi.length=0:Hi.splice(0,e)}}]),r(e,[{key:"destroy",value:function(){return 1&this._objFlags?(G(5e3),!1):!(4&this._objFlags)&&(this._objFlags|=4,Hi.push(this),!0)}},{key:"_destruct",value:function(){var e=this.constructor,i=e.__destruct__;i||(i=function(e,i){var n,r=e instanceof E._BaseNode||e instanceof E.Component,a=r?"_id":null,o={};for(n in e)if(e.hasOwnProperty(n)){if(n===a)continue;switch(t(e[n])){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(Ht._isCCClass(i))for(var s=E.Class.Attr.getClassAttrs(i),l=i.__props__,c=0;c<l.length;c++){var u=(n=l[c])+E.Class.Attr.DELIMETER+"default";if(u in s){if(r&&"_id"===n)continue;switch(t(s[u])){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var h="";for(n in o){var _=void 0;_=Ht.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Ht.escapeForJS(n)+"]=";var d=o[n];""===d&&(d='""'),h+=_+d+";\n"}return Function("o",h)}(this,e),le(e,"__destruct__",i,!0)),i(this)}},{key:"_destroyImmediate",value:function(){1&this._objFlags?V(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),Wi=Vi.prototype;function ji(e,i){return"object"===t(e)?!(!e||e._objFlags&(i?5:1)):void 0!==e}Wi._deserialize=null,Wi._onPreDestroy=null,Ht.fastDefine("cc.Object",Vi,{_name:"",_objFlags:0}),le(Vi,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),E.isValid=ji,E.Object=Vi;var qi=Fe.fastRemoveAt;function Xi(){}var Yi=function(){function e(){i(this,e),this.callback=Xi,this.target=void 0,this.once=!1}return r(e,[{key:"set",value:function(e,t,i){this.callback=e||Xi,this.target=t,this.once=!!i}},{key:"reset",value:function(){this.target=void 0,this.callback=Xi,this.once=!1}},{key:"check",value:function(){return!(this.target instanceof Vi&&!ji(this.target,!0))}}]),e}(),Ki=new zi((function(){return new Yi}),32),Zi=function(){function e(){i(this,e),this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}return r(e,[{key:"removeByCallback",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.callback===e&&(i.reset(),Ki.free(i),qi(this.callbackInfos,t),--t)}}},{key:"removeByTarget",value:function(e){for(var t=0;t<this.callbackInfos.length;++t){var i=this.callbackInfos[t];i&&i.target===e&&(i.reset(),Ki.free(i),qi(this.callbackInfos,t),--t)}}},{key:"cancel",value:function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:qi(this.callbackInfos,e),Ki.free(t)),this.containCanceled=!0}},{key:"cancelAll",value:function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),Ki.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0}},{key:"purgeCanceled",value:function(){for(var e=this.callbackInfos.length-1;e>=0;--e){this.callbackInfos[e]||qi(this.callbackInfos,e)}this.containCanceled=!1}},{key:"clear",value:function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}]),e}(),Qi=new zi((function(){return new Zi}),16),Ji=function(){function e(){i(this,e),this._callbackTable=_e(!0)}return r(e,[{key:"on",value:function(e,t,i,n){if(!this.hasEventListener(e,t,i)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=Qi.alloc());var a=Ki.alloc();a.set(t,i,n),r.callbackInfos.push(a)}return t}},{key:"hasEventListener",value:function(e,t,i){var n=this._callbackTable[e];if(!n)return!1;var r=n.callbackInfos;if(!t){if(n.isInvoking){for(var a=0;a<r.length;++a)if(r[a])return!0;return!1}return r.length>0}for(var o=0;o<r.length;++o){var s=r[o];if(s&&s.check()&&s.callback===t&&s.target===i)return!0}return!1}},{key:"removeAll",value:function(e){if("string"==typeof e){var t=this._callbackTable[e];t&&(t.isInvoking?t.cancelAll():(t.clear(),Qi.free(t),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var n=this._callbackTable[i];if(n.isInvoking)for(var r=n.callbackInfos,a=0;a<r.length;++a){var o=r[a];o&&o.target===e&&n.cancel(a)}else n.removeByTarget(e)}}},{key:"off",value:function(e,t,i){var n=this._callbackTable[e];if(n){var r=n.callbackInfos;if(t)for(var a=0;a<r.length;++a){var o=r[a];if(o&&o.callback===t&&o.target===i){n.cancel(a);break}}else this.removeAll(e)}}},{key:"emit",value:function(e,t,i,n,r,a){var o=this._callbackTable[e];if(o){var s=!o.isInvoking;o.isInvoking=!0;for(var l=o.callbackInfos,c=0,u=l.length;c<u;++c){var h=l[c];if(h){var _=h.callback,d=h.target;h.once&&this.off(e,_,d),h.check()?d?_.call(d,t,i,n,r,a):_(t,i,n,r,a):this.off(e,_,d)}}s&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}}},{key:"clear",value:function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),Qi.free(t),delete this._callbackTable[e])}}}]),e}();function $i(e){for(var t=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._callbackTable=_e(!0),n}return o(t,e),r(t,[{key:"once",value:function(e,t,i){return this.on(e,t,i,!0)}},{key:"targetOff",value:function(e){this.removeAll(e)}}]),t}(e),n=Ji.prototype,a=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),l=0;l<a.length;++l){var c=a[l];if(!(c in t.prototype)){var h=Object.getOwnPropertyDescriptor(n,c);h&&Object.defineProperty(t.prototype,c,h)}}return t}var en,tn=e("EventTarget",$i((function e(){i(this,e)})));E.EventTarget=tn;var nn,rn,an,on,sn,ln=e("RawAsset",ii("cc.RawAsset")(en=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._uuid=void 0,Object.defineProperty(c(n),"_uuid",{value:"",writable:!0}),n}return o(t,e),r(t,null,[{key:"isRawAssetType",value:function(e){return Ce(e,E.RawAsset)&&!Ce(e,E.Asset)}}]),t}(Vi))||en);E.RawAsset=ln;var cn=e("Asset",ii("cc.Asset")((sn=on=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).loaded=!0,x(n,"_native",an,c(n)),n._file=null,n}return o(t,e),r(t,[{key:"toString",value:function(){return this.nativeUrl}},{key:"serialize",value:function(){}},{key:"_setRawAsset",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._native=!1!==t?e||"":"/"+e}},{key:"nativeUrl",get:function(){if(this._native){var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);if(E.AssetLibrary){var t=E.AssetLibrary.getLibUrlNoExt(this._uuid,!0);return 46===e.charCodeAt(0)?t+e:t+"/"+e}V(6400)}return""}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}}],[{key:"deserialize",value:function(e){return E.deserialize(e)}}]),t}($i(ln)),on.preventDeferredLoadDependents=!1,on.preventPreloadNativeObject=!1,an=S((rn=sn).prototype,"_native",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),S(rn.prototype,"_nativeAsset",[oi],Object.getOwnPropertyDescriptor(rn.prototype,"_nativeAsset"),rn.prototype),nn=rn))||nn);cn.prototype.createNode=null,E.Asset=cn;var un={INITIALIZING:0,PLAYING:1,STOPPED:2},hn=function(){function e(t){var n=this;i(this,e),this._state=un.STOPPED,this._duration=0,this._eventTarget=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._blocking=!1,this._duration=t.duration,this._eventTarget=t.eventTarget,this._onHide=function(){n._blocking=!0,n._state===un.PLAYING&&(n.pause(),n._interrupted=!0)},this._onShow=function(){n._blocking=!1,n._interrupted&&(n.play(),n._interrupted=!1)},E.game.on(E.Game.EVENT_HIDE,this._onHide),E.game.on(E.Game.EVENT_SHOW,this._onShow)}return r(e,[{key:"getState",value:function(){return this._state}},{key:"getDuration",value:function(){return this._duration}},{key:"destroy",value:function(){E.game.off(E.Game.EVENT_HIDE,this._onHide),E.game.off(E.Game.EVENT_SHOW,this._onShow)}}]),e}();E.internal.AudioPlayer=hn;var _n=Math.PI/180,dn=180/Math.PI,fn=e("EPSILON",1e-6);function pn(e,t){return Math.abs(e-t)<=fn*Math.max(1,Math.abs(e),Math.abs(t))}function mn(e,t,i){return i=i||fn,Math.abs(e-t)<=i}function vn(e,t,i){if(t>i){var n=t;t=i,i=n}return e<t?t:e>i?i:e}function gn(e){return e<0?0:e>1?1:e}function yn(e,t,i){return e+(t-e)*i}function xn(e){return e*_n}function Sn(e){return e*dn}var Tn=e("random",Math.random);function En(e,t){return Math.random()*(t-e)+e}function bn(e,t){return Math.floor(En(e,t))}function An(e){return(e=(9301*e+49297)%233280)/233280}function Cn(e,t,i){return An(e)*(i-t)+t}function wn(e,t,i){return Math.floor(Cn(e,t,i))}function Rn(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function In(e,t){return e-Math.floor(e/t)*t}function On(e,t){return e=In(e,2*t),e=t-Math.abs(e-t)}function Mn(e,t,i){return(i-e)/(t-e)}function Pn(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function kn(e,t){return Math.abs(e)>Math.abs(t)?e:t}var Dn,Bn=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,e)))._volume=1,n._loop=!1,n._oneShotOngoing=!1,n._audio=void 0,n._cbRegistered=!1,n._remove_cb=void 0,n._post_play=void 0,n._on_gesture=void 0,n._post_gesture=void 0,n._audio=e.clip,n._remove_cb=function(){n._cbRegistered&&(E.game.canvas.removeEventListener("touchend",n._on_gesture),E.game.canvas.removeEventListener("mouseup",n._on_gesture),n._cbRegistered=!1)},n._post_play=function(){n._state=un.PLAYING,n._eventTarget.emit("started"),n._remove_cb()},n._post_gesture=function(){n._interrupted?(n._post_play(),n._interrupted=!1):(n._audio.pause(),n._audio.currentTime=0)},n._on_gesture=function(){if(n._audio){var e=n._audio.play();if(!e)return n._state=un.PLAYING,void E.director.once(E.Director.EVENT_AFTER_UPDATE,n._post_gesture);e.then(n._post_gesture),n._remove_cb()}},n._audio.volume=n._volume,n._audio.loop=n._loop,n._audio.addEventListener("ended",(function(){n._oneShotOngoing||(n._state=un.STOPPED,n._audio.currentTime=0,n._eventTarget.emit("ended"))})),E.game.canvas.addEventListener("touchend",n._on_gesture),E.game.canvas.addEventListener("mouseup",n._on_gesture),n._cbRegistered=!0,n}return o(t,e),r(t,[{key:"play",value:function(){var e=this;if(this._audio&&this._state!==un.PLAYING)if(this._blocking)this._interrupted=!0;else{var t=this._audio.play();if(!t)return this._state=un.PLAYING,void E.director.once(E.Director.EVENT_AFTER_UPDATE,this._post_play);t.then(this._post_play).catch((function(){e._interrupted=!0}))}}},{key:"pause",value:function(){this._audio&&(this._interrupted=!1,this._state===un.PLAYING&&(this._audio.pause(),this._state=un.STOPPED,this._oneShotOngoing=!1))}},{key:"stop",value:function(){this._audio&&(this._audio.currentTime=0,this._interrupted=!1,this._state===un.PLAYING&&(this._audio.pause(),this._state=un.STOPPED,this._oneShotOngoing=!1))}},{key:"playOneShot",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=this._audio;i&&(i.currentTime=0,i.volume=t,this._oneShotOngoing||(i.loop=!1,this._oneShotOngoing=!0,i.play().then((function(){i.addEventListener("ended",(function(){i.currentTime=0,i.volume=e._volume,i.loop=e._loop,e._oneShotOngoing=!1}),{once:!0})})).catch((function(){e._oneShotOngoing=!1}))))}},{key:"setCurrentTime",value:function(e){this._audio&&(this._audio.currentTime=vn(e,0,this._duration))}},{key:"getCurrentTime",value:function(){return this._audio?this._audio.currentTime:0}},{key:"setVolume",value:function(e,t){this._volume=e,this._audio&&(this._audio.volume=e)}},{key:"getVolume",value:function(){return this._audio?this._audio.volume:this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._audio&&(this._audio.loop=e)}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){this._audio&&(this._audio.src=""),_(s(t.prototype),"destroy",this).call(this)}}]),t}(hn),Ln="undefined"==typeof window?global:window;!function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(Dn||(Dn={}));var Nn,Fn,zn,Un,Gn=e("sys",{NetworkType:Dn,LANGUAGE_ENGLISH:"en",LANGUAGE_CHINESE:"zh",LANGUAGE_FRENCH:"fr",LANGUAGE_ITALIAN:"it",LANGUAGE_GERMAN:"de",LANGUAGE_SPANISH:"es",LANGUAGE_DUTCH:"du",LANGUAGE_RUSSIAN:"ru",LANGUAGE_KOREAN:"ko",LANGUAGE_JAPANESE:"ja",LANGUAGE_HUNGARIAN:"hu",LANGUAGE_PORTUGUESE:"pt",LANGUAGE_ARABIC:"ar",LANGUAGE_NORWEGIAN:"no",LANGUAGE_POLISH:"pl",LANGUAGE_TURKISH:"tr",LANGUAGE_UKRAINIAN:"uk",LANGUAGE_ROMANIAN:"ro",LANGUAGE_BULGARIAN:"bg",LANGUAGE_UNKNOWN:"unknown",OS_IOS:"iOS",OS_ANDROID:"Android",OS_WINDOWS:"Windows",OS_LINUX:"Linux",OS_OSX:"OS X",OS_UNKNOWN:"Unknown",UNKNOWN:-1,WIN32:0,LINUX:1,MACOS:2,ANDROID:3,IPHONE:4,IPAD:5,BLACKBERRY:6,NACL:7,EMSCRIPTEN:8,TIZEN:9,WINRT:10,WP8:11,MOBILE_BROWSER:100,DESKTOP_BROWSER:101,EDITOR_PAGE:102,EDITOR_CORE:103,WECHAT_GAME:104,QQ_PLAY:105,BROWSER_TYPE_WECHAT:"wechat",BROWSER_TYPE_COCOSPLAY:"cocosplay",BROWSER_TYPE_HUAWEI_GAME:"huaweiquickgame",BROWSER_TYPE_OPPO_GAME:"oppogame",BROWSER_TYPE_VIVO_GAME:"vivogame",BROWSER_TYPE_ANDROID:"androidbrowser",BROWSER_TYPE_IE:"ie",BROWSER_TYPE_EDGE:"edge",BROWSER_TYPE_QQ:"qqbrowser",BROWSER_TYPE_MOBILE_QQ:"mqqbrowser",BROWSER_TYPE_UC:"ucbrowser",BROWSER_TYPE_UCBS:"ucbs",BROWSER_TYPE_360:"360browser",BROWSER_TYPE_BAIDU_APP:"baiduboxapp",BROWSER_TYPE_BAIDU:"baidubrowser",BROWSER_TYPE_MAXTHON:"maxthon",BROWSER_TYPE_OPERA:"opera",BROWSER_TYPE_OUPENG:"oupeng",BROWSER_TYPE_MIUI:"miuibrowser",BROWSER_TYPE_FIREFOX:"firefox",BROWSER_TYPE_SAFARI:"safari",BROWSER_TYPE_CHROME:"chrome",BROWSER_TYPE_LIEBAO:"liebao",BROWSER_TYPE_QZONE:"qzone",BROWSER_TYPE_SOUGOU:"sogou",BROWSER_TYPE_UNKNOWN:"unknown",isNative:!1,isBrowser:"object"===("undefined"==typeof window?"undefined":t(window))&&"object"===("undefined"==typeof document?"undefined":t(document))&&!0,isMobile:!1,isLittleEndian:(Nn=new ArrayBuffer(2),new DataView(Nn).setInt16(0,256,!0),256===new Int16Array(Nn)[0]),platform:-1,language:"unknown",os:"Unknown",osVersion:"",osMainVersion:0,browserType:"unknown",browserVersion:"",windowPixelResolution:null,capabilities:null,localStorage:null,__audioSupport:null,__videoSupport:null,getNetworkType:function(){return Dn.LAN},getBatteryLevel:function(){return 1},garbageCollect:function(){},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",M(e+="Using "+(E.game.renderType===E.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){window.open(e)},now:function(){return Date.now?Date.now():+new Date},dumpRoot:function(){},restartVM:function(){},cleanScript:function(e){},getSafeAreaRect:function(){var e=E.view.getVisibleSize();return E.rect(0,0,e.width,e.height)}});if(Ln.__globalAdapter&&Ln.__globalAdapter.adaptSys)Ln.__globalAdapter.adaptSys(Gn);else{var Hn=window,Vn=Hn.navigator,Wn=document,jn=Wn.documentElement,qn=Vn.userAgent.toLowerCase();Gn.isMobile=/mobile|android|iphone|ipad/.test(qn),Gn.platform=Gn.isMobile?Gn.MOBILE_BROWSER:Gn.DESKTOP_BROWSER;var Xn=Vn.language;Xn=(Xn=Xn||Vn.browserLanguage)?Xn.split("-")[0]:Gn.LANGUAGE_ENGLISH,Gn.language=Xn;var Yn=!1,Kn=!1,Zn="",Qn=0,Jn=/android\s*(\d+(?:\.\d+)*)/i.exec(qn)||/android\s*(\d+(?:\.\d+)*)/i.exec(Vn.platform);Jn&&(Yn=!0,Zn=Jn[1]||"",Qn=parseInt(Zn)||0),(Jn=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(qn))?(Kn=!0,Zn=Jn[2]||"",Qn=parseInt(Zn)||0):(/(iPhone|iPad|iPod)/.exec(Vn.platform)||"MacIntel"===Vn.platform&&Vn.maxTouchPoints&&Vn.maxTouchPoints>1)&&(Kn=!0,Zn="",Qn=0);var $n=Gn.OS_UNKNOWN;-1!==Vn.appVersion.indexOf("Win")?$n=Gn.OS_WINDOWS:Kn?$n=Gn.OS_IOS:-1!==Vn.appVersion.indexOf("Mac")?$n=Gn.OS_OSX:-1!==Vn.appVersion.indexOf("X11")&&-1===Vn.appVersion.indexOf("Linux")?$n=Gn.OS_UNIX:Yn?$n=Gn.OS_ANDROID:-1===Vn.appVersion.indexOf("Linux")&&-1===qn.indexOf("ubuntu")||($n=Gn.OS_LINUX),Gn.os=$n,Gn.osVersion=Zn,Gn.osMainVersion=Qn,Gn.browserType=Gn.BROWSER_TYPE_UNKNOWN,function(){var e=/mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(qn);e||(e=/qqbrowser|ucbrowser|edge/i.exec(qn)),e||(e=/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(qn));var t=e?e[0].toLowerCase():Gn.BROWSER_TYPE_UNKNOWN;"micromessenger"===t?t=Gn.BROWSER_TYPE_WECHAT:"safari"===t&&Yn||"qq"===t&&qn.match(/android.*applewebkit/i)?t=Gn.BROWSER_TYPE_ANDROID:"trident"===t?t=Gn.BROWSER_TYPE_IE:"edge"===t||("360 aphone"===t?t=Gn.BROWSER_TYPE_360:"mxbrowser"===t?t=Gn.BROWSER_TYPE_MAXTHON:"opr/"===t&&(t=Gn.BROWSER_TYPE_OPERA)),Gn.browserType=t}(),Gn.browserVersion="",(Un=qn.match(/(mqqbrowser|micromessenger|qq|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui)(mobile)?(browser)?\/?([\d.]+)/i))||(Un=qn.match(/(qqbrowser|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i)),Gn.browserVersion=Un?Un[4]:"";var er=window.innerWidth||document.documentElement.clientWidth,tr=window.innerHeight||document.documentElement.clientHeight,ir=window.devicePixelRatio||1;Gn.windowPixelResolution={width:ir*er,height:ir*tr};var nr=document.createElement("canvas");try{var rr=Gn.localStorage=Hn.localStorage;rr.setItem("storage",""),rr.removeItem("storage"),rr=null}catch(Ro){var ar=function(){G(5200)};Gn.localStorage={getItem:ar,setItem:ar,removeItem:ar,clear:ar}}var or=nr.toDataURL("image/webp").startsWith("data:image/webp"),sr=!!nr.getContext("2d"),lr=!1;if(Hn.WebGLRenderingContext&&(function e(t,i,n){if(!n)return e(t,i,"webgl")||e(t,i,"experimental-webgl")||e(t,i,"webkit-3d")||e(t,i,"moz-webgl")||null;try{return t.getContext(n,i)}catch(e){return null}}(document.createElement("CANVAS"))&&(lr=!0),lr&&Gn.os===Gn.OS_ANDROID)){var cr=parseFloat(Gn.browserVersion);switch(Gn.browserType){case Gn.BROWSER_TYPE_MOBILE_QQ:case Gn.BROWSER_TYPE_BAIDU:case Gn.BROWSER_TYPE_BAIDU_APP:lr=cr>=6.2;break;case Gn.BROWSER_TYPE_ANDROID:Gn.osMainVersion&&Gn.osMainVersion>=5&&(lr=!0);break;case Gn.BROWSER_TYPE_CHROME:lr=cr>=30;break;case Gn.BROWSER_TYPE_UC:lr=cr>11;break;case Gn.BROWSER_TYPE_360:lr=!1}}var ur,hr=Gn.capabilities={canvas:sr,opengl:lr,webp:or};(void 0!==jn.ontouchstart||void 0!==Wn.ontouchstart||Vn.msPointerEnabled)&&(hr.touches=!0),void 0!==jn.onmouseup&&(hr.mouse=!0),void 0!==jn.onkeyup&&(hr.keyboard=!0),(Hn.DeviceMotionEvent||Hn.DeviceOrientationEvent)&&(hr.accelerometer=!0),zn=!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),ur={ONLY_ONE:!1,WEB_AUDIO:zn,DELAY_CREATE_CTX:!1},Gn.os===Gn.OS_IOS&&(ur.USE_LOADER_EVENT="loadedmetadata"),Gn.browserType===Gn.BROWSER_TYPE_FIREFOX&&(ur.DELAY_CREATE_CTX=!0,ur.USE_LOADER_EVENT="canplay"),Gn.os===Gn.OS_ANDROID&&Gn.browserType===Gn.BROWSER_TYPE_UC&&(ur.ONE_SOURCE=!0);try{ur.WEB_AUDIO&&(ur._context=null,Object.defineProperty(ur,"context",{get:function(){return this._context?this._context:this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}}))}catch(k){ur.WEB_AUDIO=!1,z(5201)}var _r=[];(Fn=document.createElement("audio")).canPlayType&&(Fn.canPlayType('audio/ogg; codecs="vorbis"')&&_r.push(".ogg"),Fn.canPlayType("audio/mpeg")&&_r.push(".mp3"),Fn.canPlayType('audio/wav; codecs="1"')&&_r.push(".wav"),Fn.canPlayType("audio/mp4")&&_r.push(".mp4"),Fn.canPlayType("audio/x-m4a")&&_r.push(".m4a")),ur.format=_r,Gn.__audioSupport=ur,Gn.__videoSupport={format:[]},function(){var e=document.createElement("video");if(e.canPlayType){var t=Gn.__videoSupport.format;["mp4","webm"].forEach((function(i){e.canPlayType("video/".concat(i))&&t.push(".".concat(i))})),Gn.__videoSupport.format=t}}()}E.sys=Gn;var dr,fr,pr,mr,vr,gr,yr,xr,Sr=Gn.__audioSupport,Tr=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,e)))._startTime=0,n._offset=0,n._volume=1,n._loop=!1,n._currentTimer=0,n._audio=void 0,n._context=void 0,n._sourceNode=void 0,n._gainNode=void 0,n._startInvoked=!1,n._onEndedCB=void 0,n._onGestureCB=void 0,n._onGestureProceedCB=void 0,n._audio=e.clip,n._context=Sr.context,n._sourceNode=n._context.createBufferSource(),n._gainNode=n._context.createGain(),n._gainNode.connect(n._context.destination),n._onEndedCB=n._onEnded.bind(c(n)),n._onGestureCB=n._onGesture.bind(c(n)),n._onGestureProceedCB=n._onGestureProceed.bind(c(n)),"running"!==n._context.state&&n._context.resume&&(E.game.canvas.addEventListener("touchend",n._onGestureCB),E.game.canvas.addEventListener("mouseup",n._onGestureCB)),n}return o(t,e),r(t,[{key:"play",value:function(){if(this._audio&&this._state!==un.PLAYING)return this._blocking||"running"!==this._context.state?(this._interrupted=!0,void("interrupted"===this._context.state&&this._context.resume&&this._onGesture())):void this._doPlay()}},{key:"pause",value:function(){this._interrupted=!1,this._state===un.PLAYING&&(this._doStop(),this._offset+=this._context.currentTime-this._startTime,this._state=un.STOPPED,clearInterval(this._currentTimer))}},{key:"stop",value:function(){this._offset=0,this._interrupted=!1,this._state===un.PLAYING&&(this._doStop(),this._state=un.STOPPED,clearInterval(this._currentTimer))}},{key:"playOneShot",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;if(this._audio){var t=this._context.createGain();t.connect(this._context.destination),t.gain.value=e;var i=this._context.createBufferSource();i.buffer=this._audio,i.loop=!1,i.connect(t),i.start()}}},{key:"setCurrentTime",value:function(e){this._offset=vn(e,0,this._audio&&this._audio.duration||this._duration),this._state===un.PLAYING&&(this._doStop(),this._doPlay())}},{key:"getCurrentTime",value:function(){return this._state!==un.PLAYING?this._offset:this._context.currentTime-this._startTime+this._offset}},{key:"setVolume",value:function(e,t){this._volume=e,!t&&this._gainNode.gain.setTargetAtTime?this._gainNode.gain.setTargetAtTime(e,this._context.currentTime,.01):this._gainNode.gain.value=e}},{key:"getVolume",value:function(){return this._volume}},{key:"setLoop",value:function(e){this._loop=e,this._sourceNode.loop=e}},{key:"getLoop",value:function(){return this._loop}},{key:"destroy",value:function(){_(s(t.prototype),"destroy",this).call(this)}},{key:"_doPlay",value:function(){var e=this;this._state=un.PLAYING,this._sourceNode=this._context.createBufferSource(),this._sourceNode.buffer=this._audio,this._sourceNode.loop=this._loop,this._sourceNode.connect(this._gainNode),this._startTime=this._context.currentTime,this._startInvoked=!1,E.director.once(E.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this),clearInterval(this._currentTimer),this._currentTimer=window.setInterval((function(){e._onEnded(),clearInterval(e._currentTimer),e._sourceNode.loop&&(e._currentTimer=window.setInterval(e._onEndedCB,1e3*e._audio.duration))}),1e3*(this._audio.duration-this._offset))}},{key:"_doStop",value:function(){this._startInvoked?this._sourceNode.stop():E.director.off(E.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this)}},{key:"_playAndEmit",value:function(){this._sourceNode.start(0,this._offset),this._eventTarget.emit("started"),this._startInvoked=!0}},{key:"_onEnded",value:function(){this._offset=0,this._startTime=this._context.currentTime,this._sourceNode.loop||(this._eventTarget.emit("ended"),this._state=un.STOPPED)}},{key:"_onGestureProceed",value:function(){this._interrupted&&(this._doPlay(),this._interrupted=!1),E.game.canvas.removeEventListener("touchend",this._onGestureCB),E.game.canvas.removeEventListener("mouseup",this._onGestureCB)}},{key:"_onGesture",value:function(){"running"!==this._context.state?this._context.resume().then(this._onGestureProceedCB):this._onGestureProceed()}}]),t}(hn),Er=et({WEB_AUDIO:0,DOM_AUDIO:1,JSB_AUDIO:2,UNKNOWN_AUDIO:3}),br=e("AudioClip",(dr=ii("cc.AudioClip"),fr=Li(Er),dr((xr=yr=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_duration",vr,c(e)),x(e,"_loadMode",gr,c(e)),e._audio=null,e._player=null,e.loaded=!1,e}return o(t,e),r(t,[{key:"destroy",value:function(){return this._player&&this._player.destroy(),_(s(t.prototype),"destroy",this).call(this)}},{key:"play",value:function(){this._player&&this._player.play()}},{key:"pause",value:function(){this._player&&this._player.pause()}},{key:"stop",value:function(){this._player&&this._player.stop()}},{key:"playOneShot",value:function(e){this._player&&this._player.playOneShot(e)}},{key:"setCurrentTime",value:function(e){this._player&&this._player.setCurrentTime(e)}},{key:"getCurrentTime",value:function(){return this._player?this._player.getCurrentTime():0}},{key:"getDuration",value:function(){return this._player?this._player.getDuration():this._duration}},{key:"setVolume",value:function(e,t){this._player&&this._player.setVolume(e,t||!1)}},{key:"getVolume",value:function(){return this._player?this._player.getVolume():1}},{key:"setLoop",value:function(e){this._player&&this._player.setLoop(e)}},{key:"getLoop",value:function(){return!!this._player&&this._player.getLoop()}},{key:"_getPlayer",value:function(e){var t;return"undefined"!=typeof AudioBuffer&&e instanceof AudioBuffer?(t=Tr,this._loadMode=Er.WEB_AUDIO):(t=Bn,this._loadMode=Er.DOM_AUDIO),t}},{key:"_nativeAsset",set:function(e){if(this._audio=e,e){var t=this._getPlayer(e);this._player=new t({clip:e,duration:this._duration,eventTarget:this}),this.loaded=!0,this.emit("load")}else this._player=null,this._loadMode=Er.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1},get:function(){return this._audio}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():un.INITIALIZING}}]),t}(cn),yr.PlayingState=un,yr.AudioType=Er,yr.preventDeferredLoadDependents=!0,vr=S((mr=xr).prototype,"_duration",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gr=S(mr.prototype,"_loadMode",[fr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Er.UNKNOWN_AUDIO}}),pr=mr))||pr));E.AudioClip=br;var Ar,Cr,wr,Rr=Gn.__audioSupport,Ir=Rr.format;function Or(e,t){var i=document.createElement("audio");i.src=e.url;var n=function(){clearTimeout(r),i.removeEventListener("canplaythrough",a,!1),i.removeEventListener("error",o,!1),Rr.USE_LOADER_EVENT&&i.removeEventListener(Rr.USE_LOADER_EVENT,a,!1)},r=setTimeout((function(){0===i.readyState?o():a()}),8e3),a=function(){n(),t(null,i)},o=function(){n();var i="load audio failure - "+e.url;M(i),t(i)};i.addEventListener("canplaythrough",a,!1),i.addEventListener("error",o,!1),Rr.USE_LOADER_EVENT&&i.addEventListener(Rr.USE_LOADER_EVENT,a,!1)}function Mr(e,t){var i=Rr.context;i||t(new Error(X(4926)));var n=E.loader.getXMLHttpRequest();n.open("GET",e.url,!0),n.responseType="arraybuffer",n.onload=function(){i.decodeAudioData(n.response,(function(e){t(null,e)}),(function(){t("decode error - "+e.id,null)}))},n.onerror=function(){t("request error - "+e.id,null)},n.send()}function Pr(e,t){if(0===Ir.length)return new Error(X(4927));var i;Rr.WEB_AUDIO?i=e._owner instanceof br?e._owner.loadMode===Er.WEB_AUDIO?Mr:Or:e.urlParam&&e.urlParam.useDom?Or:Mr:i=Or;i(e,t)}var kr=e("Script",ii("cc.Script")(Ar=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),t}(cn))||Ar);E._Script=kr;var Dr=e("JavaScript",ii("cc.JavaScript")(Cr=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),t}(kr))||Cr);E._JavaScript=Dr;var Br,Lr,Nr,Fr,zr,Ur,Gr,Hr,Vr,Wr,jr=e("TypeScript",ii("cc.TypeScript")(wr=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),t}(kr))||wr);E._TypeScript=jr;var qr=new ie("Comp"),Xr=(Vi.Flags.IsOnEnableCalled,Vi.Flags.IsOnLoadCalled),Yr=e("Component",(Br=ii("cc.Component"),Lr=xi("Script"),Nr=Li(kr),Fr=Si("i18n:INSPECTOR.component.script"),Br((Wr=Vr=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"node",Gr,c(n)),x(n,"_enabled",Hr,c(n)),n._sceneGetter=null,n._id=qr.getNewId(),n}return o(t,e),r(t,[{key:"_getRenderScene",value:function(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}},{key:"addComponent",value:function(e){return this.node.addComponent(e)}},{key:"getComponent",value:function(e){return this.node.getComponent(e)}},{key:"getComponents",value:function(e){return this.node.getComponents(e)}},{key:"getComponentInChildren",value:function(e){return this.node.getComponentInChildren(e)}},{key:"getComponentsInChildren",value:function(e){return this.node.getComponentsInChildren(e)}},{key:"destroy",value:function(){return!!_(s(t.prototype),"destroy",this).call(this)&&(this._enabled&&this.node.activeInHierarchy&&E.director._compScheduler.disableComp(this),!0)}},{key:"_onPreDestroy",value:function(){this.unscheduleAllCallbacks(),E.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}},{key:"_instantiate",value:function(e){return e||(e=E.instantiate._clone(this,this)),e.node=null,e}},{key:"schedule",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:E.macro.REPEAT_FOREVER,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;q(e,1619),q((t=t||0)>=0,1620),i=isNaN(i)?E.macro.REPEAT_FOREVER:i,n=n||0;var r=E.director.getScheduler(),a=r.isTargetPaused(this);r.schedule(e,this,t,i,n,a)}},{key:"scheduleOnce",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.schedule(e,0,0,t)}},{key:"unschedule",value:function(e){e&&E.director.getScheduler().unschedule(e,this)}},{key:"unscheduleAllCallbacks",value:function(){E.director.getScheduler().unscheduleAllForTarget(this)}},{key:"name",get:function(){if(this._name)return this._name;var e=de(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node.name+"<"+e+">"},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=E.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Xr}}]),t}(Vi),Vr.system=null,S((Ur=Wr).prototype,"__scriptAsset",[Lr,Nr,Fr],Object.getOwnPropertyDescriptor(Ur.prototype,"__scriptAsset"),Ur.prototype),Gr=S(Ur.prototype,"node",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hr=S(Ur.prototype,"_enabled",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zr=Ur))||zr)),Kr=Yr.prototype;Kr.update=null,Kr.lateUpdate=null,Kr.__preload=null,Kr.onLoad=null,Kr.start=null,Kr.onEnable=null,Kr.onDisable=null,Kr.onDestroy=null,Kr.onFocusInEditor=null,Kr.onLostFocusInEditor=null,Kr.resetInEditor=null,Kr._getLocalBounds=null,Kr.onRestore=null,Yr._requireComponent=null,Yr._executionOrder=0,le(Yr,"_registerEditorProps",(function(e,t){var i=t.requireComponent;i&&(e._requireComponent=i);var n=t.executionOrder;n&&"number"==typeof n&&(e._executionOrder=n)})),E.Component=Yr;function Zr(e){return(e>0)-(e<0)}function Qr(e){var t,i;return t=(e>65535)<<4,t|=i=((e>>>=t)>255)<<3,t|=i=((e>>>=i)>15)<<2,(t|=i=((e>>>=i)>3)<<1)|(e>>>=i)>>1}function Jr(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function $r(e){return e+=0===e,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)+1}var ea=new Array(256);!function(e){for(var t=0;t<256;++t){var i=t,n=t,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;e[t]=n<<r&255}}(ea);var ta=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-1<<31,sign:Zr,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:Qr,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:Jr,nextPow2:$r,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return ea[255&e]<<24|ea[e>>>8&255]<<16|ea[e>>>16&255]<<8|ea[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,i){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>Jr(e)+1}});e("bits",ta);var ia=e("Vec2",function(e){function n(e,r){var a;return i(this,n),a=u(this,s(n).call(this)),e&&"object"===t(e)?(a.x=e.x,a.y=e.y):(a.x=e||0,a.y=r||0),a}return o(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e}},{key:"set",value:function(e,t,i){return e.x=t,e.y=i,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n}},{key:"len",value:function(e){var t=e.x,i=e.y;return Math.sqrt(t*t+i*i)}},{key:"lengthSqr",value:function(e){var t=e.x,i=e.y;return t*t+i*i}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e}},{key:"inverseSafe",value:function(e,t){var i=t.x,n=t.y;return Math.abs(i)<fn?e.x=0:e.x=1/i,Math.abs(n)<fn?e.y=0:e.y=1/n,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=i*i+n*n;return r>0&&(r=1/Math.sqrt(r),e.x=i*r,e.y=n*r),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y}},{key:"cross",value:function(e,t,i){return e.x=e.y=0,e.z=t.x*i.y-t.y*i.x,e}},{key:"lerp",value:function(e,t,i,n){var r=t.x,a=t.y;return e.x=r+n*(i.x-r),e.y=a+n*(i.y-a),e}},{key:"random",value:function(e,t){t=t||1;var i=2*Tn()*Math.PI;return e.x=Math.cos(i)*t,e.y=Math.sin(i)*t,e}},{key:"transformMat3",value:function(e,t,i){var n=t.x,r=t.y;return e.x=i.m00*n+i.m03*r+i.m06,e.y=i.m01*n+i.m04*r+i.m07,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y;return e.x=i.m00*n+i.m04*r+i.m12,e.y=i.m01*n+i.m05*r+i.m13,e}},{key:"str",value:function(e){return"Vec2(".concat(e.x,", ").concat(e.y,")")}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))}},{key:"angle",value:function(e,t){n.normalize(na,e),n.normalize(ra,t);var i=n.dot(na,ra);return i>1?0:i<-1?Math.PI:Math.acos(i)}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y)}},{key:"set",value:function(e,i){return e&&"object"===t(e)?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=i||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fn;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))}},{key:"equals2f",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn;return Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y}},{key:"strictEquals2f",value:function(e,t){return this.x===e&&this.y===t}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),")")}},{key:"lerp",value:function(e,t){var i=this.x,n=this.y;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this}},{key:"clampf",value:function(e,t){return this.x=vn(this.x,e.x,t.x),this.y=vn(this.y,e.y,t.y),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this}},{key:"add2f",value:function(e,t){return this.x=this.x+e,this.y=this.y+t,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this}},{key:"subtract2f",value:function(e,t){return this.x=this.x-e,this.y=this.y-t,this}},{key:"multiplyScalar",value:function(e){return"object"===t(e)&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this}},{key:"multiply",value:function(e){return"object"!==t(e)&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this}},{key:"multiply2f",value:function(e,t){return this.x=this.x*e,this.y=this.y*t,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}},{key:"divide2f",value:function(e,t){return this.x=this.x/e,this.y=this.y/t,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"cross",value:function(e){return this.x*e.y-this.y*e.x}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=e*e+t*t;return i>0&&(i=1/Math.sqrt(i),this.x=this.x*i,this.y=this.y*i),this}},{key:"angle",value:function(e){var t=this.lengthSqr(),i=e.lengthSqr();if(0===t||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(e)/Math.sqrt(t*i);return n=vn(n,-1,1),Math.acos(n)}},{key:"signAngle",value:function(e){var t=this.angle(e);return this.cross(e)<0?-t:t}},{key:"rotate",value:function(e){var t=this.x,i=this.y,n=Math.sin(e),r=Math.cos(e);return this.x=r*t-n*i,this.y=n*t+r*i,this}},{key:"project",value:function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y;return this.x=e.m00*t+e.m04*i+e.m12,this.y=e.m01*t+e.m05*i+e.m13,this}}]),n}(rt));ia.ZERO=Object.freeze(new ia(0,0)),ia.ONE=Object.freeze(new ia(1,1)),ia.NEG_ONE=Object.freeze(new ia(-1,-1)),ia.UNIT_X=Object.freeze(new ia(1,0)),ia.UNIT_Y=Object.freeze(new ia(0,1));var na=new ia,ra=new ia;function aa(e,t){return new ia(e,t)}Ht.fastDefine("cc.Vec2",ia,{x:0,y:0}),E.Vec2=ia,E.v2=aa;var oa=e("Vec3",function(e){function n(e,r,a){var o;return i(this,n),o=u(this,s(n).call(this)),e&&"object"===t(e)?(o.x=e.x,o.y=e.y,o.z=e.z):(o.x=e||0,o.y=r||0,o.z=a||0),o}return o(n,e),r(n,null,[{key:"zero",value:function(e){return e.x=0,e.y=0,e.z=0,e}},{key:"clone",value:function(e){return new n(e.x,e.y,e.z)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e}},{key:"set",value:function(e,t,i,n){return e.x=t,e.y=i,e.z=n,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+n*n+r*r)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z;return i*i+n*n+r*r}},{key:"len",value:function(e){var t=e.x,i=e.y,n=e.z;return Math.sqrt(t*t+i*i+n*n)}},{key:"lengthSqr",value:function(e){var t=e.x,i=e.y,n=e.z;return t*t+i*i+n*n}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e}},{key:"invert",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e}},{key:"invertSafe",value:function(e,t){var i=t.x,n=t.y,r=t.z;return Math.abs(i)<fn?e.x=0:e.x=1/i,Math.abs(n)<fn?e.y=0:e.y=1/n,Math.abs(r)<fn?e.z=0:e.z=1/r,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=i*i+n*n+r*r;return a>0&&(a=1/Math.sqrt(a),e.x=i*a,e.y=n*a,e.z=r*a),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}},{key:"cross",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=i.x,s=i.y,l=i.z;return e.x=r*l-a*s,e.y=a*o-n*l,e.z=n*s-r*o,e}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e}},{key:"random",value:function(e,t){t=t||1;var i=2*Tn()*Math.PI,n=2*Tn()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=i.m03*n+i.m07*r+i.m11*a+i.m15;return o=o?Math.abs(1/o):1,e.x=(i.m00*n+i.m04*r+i.m08*a+i.m12)*o,e.y=(i.m01*n+i.m05*r+i.m09*a+i.m13)*o,e.z=(i.m02*n+i.m06*r+i.m10*a+i.m14)*o,e}},{key:"transformMat4Normal",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=i.m03*n+i.m07*r+i.m11*a;return o=o?Math.abs(1/o):1,e.x=(i.m00*n+i.m04*r+i.m08*a)*o,e.y=(i.m01*n+i.m05*r+i.m09*a)*o,e.z=(i.m02*n+i.m06*r+i.m10*a)*o,e}},{key:"transformMat3",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;return e.x=n*i.m00+r*i.m03+a*i.m06,e.y=n*i.m01+r*i.m04+a*i.m07,e.z=n*i.m02+r*i.m05+a*i.m08,e}},{key:"transformAffine",value:function(e,t,i){var n=t.x,r=t.y,a=t.z;return e.x=i.m00*n+i.m04*r+i.m08*a+i.m12,e.y=i.m01*n+i.m05*r+i.m09*a+i.m13,e.x=i.m02*n+i.m06*r+i.m10*a+i.m14,e}},{key:"transformQuat",value:function(e,t,i){var n=i.w*t.x+i.y*t.z-i.z*t.y,r=i.w*t.y+i.z*t.x-i.x*t.z,a=i.w*t.z+i.x*t.y-i.y*t.x,o=-i.x*t.x-i.y*t.y-i.z*t.z;return e.x=n*i.w+o*-i.x+r*-i.z-a*-i.y,e.y=r*i.w+o*-i.y+a*-i.x-n*-i.z,e.z=a*i.w+o*-i.z+n*-i.y-r*-i.x,e}},{key:"transformRTS",value:function(e,t,i,n,r){var a=t.x*r.x,o=t.y*r.y,s=t.z*r.z,l=i.w*a+i.y*s-i.z*o,c=i.w*o+i.z*a-i.x*s,u=i.w*s+i.x*o-i.y*a,h=-i.x*a-i.y*o-i.z*s;return e.x=l*i.w+h*-i.x+c*-i.z-u*-i.y+n.x,e.y=c*i.w+h*-i.y+u*-i.x-l*-i.z+n.y,e.z=u*i.w+h*-i.z+l*-i.y-c*-i.x+n.z,e}},{key:"transformInverseRTS",value:function(e,t,i,n,r){var a=t.x-n.x,o=t.y-n.y,s=t.z-n.z,l=i.w*a-i.y*s+i.z*o,c=i.w*o-i.z*a+i.x*s,u=i.w*s-i.x*o+i.y*a,h=i.x*a+i.y*o+i.z*s;return e.x=(l*i.w+h*i.x+c*i.z-u*i.y)/r.x,e.y=(c*i.w+h*i.y+u*i.x-l*i.z)/r.y,e.z=(u*i.w+h*i.z+l*i.y-c*i.x)/r.z,e}},{key:"rotateX",value:function(e,t,i,n){var r=t.x-i.x,a=t.y-i.y,o=t.z-i.z,s=Math.cos(n),l=Math.sin(n),c=r,u=a*s-o*l,h=a*l+o*s;return e.x=c+i.x,e.y=u+i.y,e.z=h+i.z,e}},{key:"rotateY",value:function(e,t,i,n){var r=t.x-i.x,a=t.y-i.y,o=t.z-i.z,s=Math.cos(n),l=Math.sin(n),c=o*l+r*s,u=a,h=o*s-r*l;return e.x=c+i.x,e.y=u+i.y,e.z=h+i.z,e}},{key:"rotateZ",value:function(e,t,i,n){var r=t.x-i.x,a=t.y-i.y,o=t.z-i.z,s=Math.cos(n),l=Math.sin(n),c=r*s-a*l,u=r*l+a*s,h=o;return e.x=c+i.x,e.y=u+i.y,e.z=h+i.z,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn,n=e.x,r=e.y,a=e.z,o=t.x,s=t.y,l=t.z;return Math.abs(n-o)<=i*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-s)<=i*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(a-l)<=i*Math.max(1,Math.abs(a),Math.abs(l))}},{key:"angle",value:function(e,t){n.normalize(sa,e),n.normalize(la,t);var i=n.dot(sa,la);return i>1?0:i<-1?Math.PI:Math.acos(i)}},{key:"projectOnPlane",value:function(e,t,i){return n.subtract(e,t,n.project(e,t,i))}},{key:"project",value:function(e,t,i){var r=n.lengthSqr(i);return r<1e-6?n.set(e,0,0,0):n.multiplyScalar(e,i,n.dot(t,i)/r)}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z)}},{key:"set",value:function(e,i,n){return e&&"object"===t(e)?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=i||0,this.z=n||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fn;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))}},{key:"equals3f",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:fn;return Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z}},{key:"strictEquals3f",value:function(e,t,i){return this.x===e&&this.y===t&&this.z===i}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),")")}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this}},{key:"add3f",value:function(e,t,i){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this}},{key:"subtract3f",value:function(e,t,i){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this}},{key:"multiplyScalar",value:function(e){return"object"===t(e)&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this}},{key:"multiply",value:function(e){return"object"!==t(e)&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this}},{key:"multiply3f",value:function(e,t,i){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this}},{key:"divide3f",value:function(e,t,i){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"clampf",value:function(e,t){return this.x=vn(this.x,e.x,t.x),this.y=vn(this.y,e.y,t.y),this.z=vn(this.z,e.z,t.z),this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,o=e.z;return this.x=i*o-n*a,this.y=n*r-t*o,this.z=t*a-i*r,this}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=this.z,n=e*e+t*t+i*i;return n>0&&(n=1/Math.sqrt(n),this.x=e*n,this.y=t*n,this.z=i*n),this}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.m03*t+e.m07*i+e.m11*n+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*i+e.m08*n+e.m12)*r,this.y=(e.m01*t+e.m05*i+e.m09*n+e.m13)*r,this.z=(e.m02*t+e.m06*i+e.m10*n+e.m14)*r,this}}]),n}(rt));oa.UNIT_X=Object.freeze(new oa(1,0,0)),oa.UNIT_Y=Object.freeze(new oa(0,1,0)),oa.UNIT_Z=Object.freeze(new oa(0,0,1)),oa.RIGHT=Object.freeze(new oa(1,0,0)),oa.UP=Object.freeze(new oa(0,1,0)),oa.FORWARD=Object.freeze(new oa(0,0,-1)),oa.ZERO=Object.freeze(new oa(0,0,0)),oa.ONE=Object.freeze(new oa(1,1,1)),oa.NEG_ONE=Object.freeze(new oa(-1,-1,-1));var sa=new oa,la=new oa;function ca(e,t,i){return new oa(e,t,i)}Ht.fastDefine("cc.Vec3",oa,{x:0,y:0,z:0}),E.Vec3=oa,E.v3=ca;var ua=e("Vec4",function(e){function n(e,r,a,o){var l;return i(this,n),l=u(this,s(n).call(this)),e&&"object"===t(e)?(l.x=e.x,l.y=e.y,l.z=e.z,l.w=e.w):(l.x=e||0,l.y=r||0,l.z=a||0,l.w=o||0),l}return o(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"add",value:function(e,t,i){return e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z,e.w=t.w+i.w,e}},{key:"subtract",value:function(e,t,i){return e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z,e.w=t.w-i.w,e}},{key:"multiply",value:function(e,t,i){return e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z,e.w=t.w*i.w,e}},{key:"divide",value:function(e,t,i){return e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z,e.w=t.w/i.w,e}},{key:"ceil",value:function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e}},{key:"floor",value:function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e}},{key:"min",value:function(e,t,i){return e.x=Math.min(t.x,i.x),e.y=Math.min(t.y,i.y),e.z=Math.min(t.z,i.z),e.w=Math.min(t.w,i.w),e}},{key:"max",value:function(e,t,i){return e.x=Math.max(t.x,i.x),e.y=Math.max(t.y,i.y),e.z=Math.max(t.z,i.z),e.w=Math.max(t.w,i.w),e}},{key:"round",value:function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"distance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+n*n+r*r+a*a)}},{key:"squaredDistance",value:function(e,t){var i=t.x-e.x,n=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+n*n+r*r+a*a}},{key:"len",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return Math.sqrt(t*t+i*i+n*n+r*r)}},{key:"lengthSqr",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w;return t*t+i*i+n*n+r*r}},{key:"negate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e}},{key:"inverse",value:function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e}},{key:"inverseSafe",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w;return Math.abs(i)<fn?e.x=0:e.x=1/i,Math.abs(n)<fn?e.y=0:e.y=1/n,Math.abs(r)<fn?e.z=0:e.z=1/r,Math.abs(a)<fn?e.w=0:e.w=1/a,e}},{key:"normalize",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,o=i*i+n*n+r*r+a*a;return o>0&&(o=1/Math.sqrt(o),e.x=i*o,e.y=n*o,e.z=r*o,e.w=a*o),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"random",value:function(e,t){t=t||1;var i=2*Tn()*Math.PI,n=2*Tn()-1,r=Math.sqrt(1-n*n);return e.x=r*Math.cos(i)*t,e.y=r*Math.sin(i)*t,e.z=n*t,e.w=0,e}},{key:"transformMat4",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=t.w;return e.x=i.m00*n+i.m04*r+i.m08*a+i.m12*o,e.y=i.m01*n+i.m05*r+i.m09*a+i.m13*o,e.z=i.m02*n+i.m06*r+i.m10*a+i.m14*o,e.w=i.m03*n+i.m07*r+i.m11*a+i.m15*o,e}},{key:"transformAffine",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=t.w;return e.x=i.m00*n+i.m01*r+i.m02*a+i.m03*o,e.y=i.m04*n+i.m05*r+i.m06*a+i.m07*o,e.x=i.m08*n+i.m09*r+i.m10*a+i.m11*o,e.w=t.w,e}},{key:"transformQuat",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=i.x,s=i.y,l=i.z,c=i.w,u=c*n+s*a-l*r,h=c*r+l*n-o*a,_=c*a+o*r-s*n,d=-o*n-s*r-l*a;return e.x=u*c+d*-o+h*-l-_*-s,e.y=h*c+d*-s+_*-o-u*-l,e.z=_*c+d*-l+u*-s-h*-o,e.w=t.w,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,i,n,r){return e&&"object"===t(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=i||0,this.z=n||0,this.w=r||0),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fn;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"equals4f",value:function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:fn;return Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=r*Math.max(1,Math.abs(this.w),Math.abs(n))}},{key:"strictEquals",value:function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"strictEquals4f",value:function(e,t,i,n){return this.x===e&&this.y===t&&this.z===i&&this.w===n}},{key:"lerp",value:function(e,t){var i=this.x,n=this.y,r=this.z,a=this.w;return this.x=i+t*(e.x-i),this.y=n+t*(e.y-n),this.z=r+t*(e.z-r),this.w=a+t*(e.w-a),this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.z.toFixed(2),", ").concat(this.w.toFixed(2),")")}},{key:"clampf",value:function(e,t){return this.x=vn(this.x,e.x,t.x),this.y=vn(this.y,e.y,t.y),this.z=vn(this.z,e.z,t.z),this.w=vn(this.w,e.w,t.w),this}},{key:"add",value:function(e){return this.x=this.x+e.x,this.y=this.y+e.y,this.z=this.z+e.z,this.w=this.w+e.w,this}},{key:"add4f",value:function(e,t,i,n){return this.x=this.x+e,this.y=this.y+t,this.z=this.z+i,this.w=this.w+n,this}},{key:"subtract",value:function(e){return this.x=this.x-e.x,this.y=this.y-e.y,this.z=this.z-e.z,this.w=this.w-e.w,this}},{key:"subtract4f",value:function(e,t,i,n){return this.x=this.x-e,this.y=this.y-t,this.z=this.z-i,this.w=this.w-n,this}},{key:"multiplyScalar",value:function(e){return"object"===t(e)&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e,this}},{key:"multiply",value:function(e){return"object"!==t(e)&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x=this.x*e.x,this.y=this.y*e.y,this.z=this.z*e.z,this.w=this.w*e.w,this}},{key:"multiply4f",value:function(e,t,i,n){return this.x=this.x*e,this.y=this.y*t,this.z=this.z*i,this.w=this.w*n,this}},{key:"divide",value:function(e){return this.x=this.x/e.x,this.y=this.y/e.y,this.z=this.z/e.z,this.w=this.w/e.w,this}},{key:"divide4f",value:function(e,t,i,n){return this.x=this.x/e,this.y=this.y/t,this.z=this.z/i,this.w=this.w/n,this}},{key:"negative",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}},{key:"cross",value:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,o=e.z;return this.x=i*o-n*a,this.y=n*r-t*o,this.z=t*a-i*r,this}},{key:"length",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w;return Math.sqrt(e*e+t*t+i*i+n*n)}},{key:"lengthSqr",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w;return e*e+t*t+i*i+n*n}},{key:"normalize",value:function(){var e=this.x,t=this.y,i=this.z,n=this.w,r=e*e+t*t+i*i+n*n;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=i*r,this.w=n*r),this}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=this.z,r=this.w;return this.x=e.m00*t+e.m04*i+e.m08*n+e.m12*r,this.y=e.m01*t+e.m05*i+e.m09*n+e.m13*r,this.z=e.m02*t+e.m06*i+e.m10*n+e.m14*r,this.w=e.m03*t+e.m07*i+e.m11*n+e.m15*r,this}}]),n}(rt));function ha(e,t,i,n){return new ua(e,t,i,n)}ua.ZERO=Object.freeze(new ua(0,0,0,0)),ua.ONE=Object.freeze(new ua(1,1,1,1)),ua.NEG_ONE=Object.freeze(new ua(-1,-1,-1,-1)),Ht.fastDefine("cc.Vec4",ua,{x:0,y:0,z:0,w:0}),E.Vec4=ua,E.v4=ha;var _a=e("Mat3",function(e){function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,_=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,f=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return i(this,n),e=u(this,s(n).call(this)),"object"===t(r)?(e.m00=r.m00,e.m01=r.m01,e.m02=r.m02,e.m03=r.m03,e.m04=r.m04,e.m05=r.m05,e.m06=r.m06,e.m07=r.m07,e.m08=r.m08):(e.m00=r,e.m01=a,e.m02=o,e.m03=l,e.m04=c,e.m05=h,e.m06=_,e.m07=d,e.m08=f),e}return o(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"set",value:function(e,t,i,n,r,a,o,s,l,c){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=l,e.m08=c,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=i,e.m05=t.m07,e.m06=n,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e}},{key:"invert",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,c=t.m07,u=t.m08,h=u*o-s*c,_=-u*a+s*l,d=c*a-o*l,f=i*h+n*_+r*d;return 0===f?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(f=1/f,e.m00=h*f,e.m01=(-u*n+r*c)*f,e.m02=(s*n-r*o)*f,e.m03=_*f,e.m04=(u*i-r*l)*f,e.m05=(-s*i+r*a)*f,e.m06=d*f,e.m07=(-c*i+n*l)*f,e.m08=(o*i-n*a)*f,e)}},{key:"determinant",value:function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,l=e.m07,c=e.m08;return t*(c*a-o*l)+i*(-c*r+o*s)+n*(l*r-a*s)}},{key:"multiply",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,c=t.m06,u=t.m07,h=t.m08,_=i.m00,d=i.m01,f=i.m02,p=i.m03,m=i.m04,v=i.m05,g=i.m06,y=i.m07,x=i.m08;return e.m00=_*n+d*o+f*c,e.m01=_*r+d*s+f*u,e.m02=_*a+d*l+f*h,e.m03=p*n+m*o+v*c,e.m04=p*r+m*s+v*u,e.m05=p*a+m*l+v*h,e.m06=g*n+y*o+x*c,e.m07=g*r+y*s+x*u,e.m08=g*a+y*l+x*h,e}},{key:"multiplyMat4",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,c=t.m06,u=t.m07,h=t.m08,_=i.m00,d=i.m01,f=i.m02,p=i.m04,m=i.m05,v=i.m06,g=i.m08,y=i.m09,x=i.m10;return e.m00=_*n+d*o+f*c,e.m01=_*r+d*s+f*u,e.m02=_*a+d*l+f*h,e.m03=p*n+m*o+v*c,e.m04=p*r+m*s+v*u,e.m05=p*a+m*l+v*h,e.m06=g*n+y*o+x*c,e.m07=g*r+y*s+x*u,e.m08=g*a+y*l+x*h,e}},{key:"transfrom",value:function(e,t,i){n.transform(e,t,i)}},{key:"transform",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,c=t.m06,u=t.m07,h=t.m08,_=i.x,d=i.y;return e.m00=n,e.m01=r,e.m02=a,e.m03=o,e.m04=s,e.m05=l,e.m06=_*n+d*o+c,e.m07=_*r+d*s+u,e.m08=_*a+d*l+h,e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y;return e.m00=n*t.m00,e.m01=n*t.m01,e.m02=n*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e}},{key:"rotate",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,c=t.m06,u=t.m07,h=t.m08,_=Math.sin(i),d=Math.cos(i);return e.m00=d*n+_*o,e.m01=d*r+_*s,e.m02=d*a+_*l,e.m03=d*o-_*n,e.m04=d*s-_*r,e.m05=d*l-_*a,e.m06=c,e.m07=u,e.m08=h,e}},{key:"fromMat4",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e}},{key:"fromViewUp",value:function(e,t,i){return oa.lengthSqr(t)<fn*fn?(n.identity(e),e):(i=i||oa.UNIT_Y,oa.normalize(da,oa.cross(da,i,t)),oa.lengthSqr(da)<fn*fn?(n.identity(e),e):(oa.cross(fa,t,da),n.set(e,da.x,da.y,da.z,fa.x,fa.y,fa.z,t.x,t.y,t.z),e))}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=-i,e.m04=n,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,o=i+i,s=n+n,l=r+r,c=i*o,u=n*o,h=n*s,_=r*o,d=r*s,f=r*l,p=a*o,m=a*s,v=a*l;return e.m00=1-h-f,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-c-f,e.m07=d-p,e.m02=_-m,e.m05=d+p,e.m08=1-c-h,e}},{key:"inverseTransposeMat4",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,c=t.m07,u=t.m08,h=t.m09,_=t.m10,d=t.m11,f=t.m12,p=t.m13,m=t.m14,v=t.m15,g=i*s-n*o,y=i*l-r*o,x=i*c-a*o,S=n*l-r*s,T=n*c-a*s,E=r*c-a*l,b=u*p-h*f,A=u*m-_*f,C=u*v-d*f,w=h*m-_*p,R=h*v-d*p,I=_*v-d*m,O=g*I-y*R+x*w+S*C-T*A+E*b;return O?(O=1/O,e.m00=(s*I-l*R+c*w)*O,e.m01=(l*C-o*I-c*A)*O,e.m02=(o*R-s*C+c*b)*O,e.m03=(r*R-n*I-a*w)*O,e.m04=(i*I-r*C+a*A)*O,e.m05=(n*C-i*R-a*b)*O,e.m06=(p*E-m*T+v*S)*O,e.m07=(m*x-f*E-v*y)*O,e.m08=(f*T-p*x+v*g)*O,e):null}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=i.m00*n+t.m00,e.m01=i.m01*n+t.m01,e.m02=i.m02*n+t.m02,e.m03=i.m03*n+t.m03,e.m04=i.m04*n+t.m04,e.m05=i.m05*n+t.m05,e.m06=i.m06*n+t.m06,e.m07=i.m07*n+t.m07,e.m08=i.m08*n+t.m08,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))}}]),r(n,[{key:"clone",value:function(){var e=this;return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return"object"===t(e)?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=i,this.m02=n,this.m03=r,this.m04=a,this.m05=o,this.m06=s,this.m07=l,this.m08=c),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fn;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08}},{key:"toString",value:function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=i,this}},{key:"invert",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,l=this.m08,c=l*r-a*s,u=-l*n+a*o,h=s*n-r*o,_=e*c+t*u+i*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=c*_,this.m01=(-l*t+i*s)*_,this.m02=(a*t-i*r)*_,this.m03=u*_,this.m04=(l*e-i*o)*_,this.m05=(-a*e+i*n)*_,this.m06=h*_,this.m07=(-s*e+t*o)*_,this.m08=(r*e-t*n)*_,this)}},{key:"determinant",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,l=this.m08;return e*(l*r-a*s)+t*(-l*n+a*o)+i*(s*n-r*o)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,l=this.m07,c=this.m08,u=e.m00,h=e.m01,_=e.m02,d=e.m03,f=e.m04,p=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+_*s,this.m01=u*i+h*a+_*l,this.m02=u*n+h*o+_*c,this.m03=d*t+f*r+p*s,this.m04=d*i+f*a+p*l,this.m05=d*n+f*o+p*c,this.m06=m*t+v*r+g*s,this.m07=m*i+v*a+g*l,this.m08=m*n+v*o+g*c,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this}},{key:"scale",value:function(e){var t=e.x,i=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}},{key:"rotate",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,l=this.m07,c=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*i+u*a,this.m02=h*n+u*o,this.m03=h*r-u*t,this.m04=h*a-u*i,this.m05=h*o-u*n,this.m06=s,this.m07=l,this.m08=c,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,o=i+i,s=n+n,l=t*a,c=i*a,u=i*o,h=n*a,_=n*o,d=n*s,f=r*a,p=r*o,m=r*s;return this.m00=1-u-d,this.m03=c-m,this.m06=h+p,this.m01=c+m,this.m04=1-l-d,this.m07=_-f,this.m02=h-p,this.m05=_+f,this.m08=1-l-u,this}}]),n}(rt));_a.IDENTITY=Object.freeze(new _a);var da=new oa,fa=new oa;Ht.fastDefine("cc.Mat3",_a,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),E.Mat3=_a;var pa=e("Quat",function(e){function n(e,r,a,o){var l;return i(this,n),l=u(this,s(n).call(this)),e&&"object"===t(e)?(l.x=e.x,l.y=e.y,l.z=e.z,l.w=e.w):(l.x=e||0,l.y=r||0,l.z=a||0,l.w=null!=o?o:1),l}return o(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.x,e.y,e.z,e.w)}},{key:"copy",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e}},{key:"set",value:function(e,t,i,n,r){return e.x=t,e.y=i,e.z=n,e.w=r,e}},{key:"identity",value:function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e}},{key:"rotationTo",value:function(e,t,i){var r=oa.dot(t,i);return r<-.999999?(oa.cross(ga,oa.UNIT_X,t),ga.length()<1e-6&&oa.cross(ga,oa.UNIT_Y,t),oa.normalize(ga,ga),n.fromAxisAngle(e,ga,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(oa.cross(ga,t,i),e.x=ga.x,e.y=ga.y,e.z=ga.z,e.w=1+r,n.normalize(e,e))}},{key:"getAxisAngle",value:function(e,t){var i=2*Math.acos(t.w),n=Math.sin(i/2);return 0!==n?(e.x=t.x/n,e.y=t.y/n,e.z=t.z/n):(e.x=1,e.y=0,e.z=0),i}},{key:"multiply",value:function(e,t,i){var n=t.x*i.w+t.w*i.x+t.y*i.z-t.z*i.y,r=t.y*i.w+t.w*i.y+t.z*i.x-t.x*i.z,a=t.z*i.w+t.w*i.z+t.x*i.y-t.y*i.x,o=t.w*i.w-t.x*i.x-t.y*i.y-t.z*i.z;return e.x=n,e.y=r,e.z=a,e.w=o,e}},{key:"multiplyScalar",value:function(e,t,i){return e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i,e}},{key:"scaleAndAdd",value:function(e,t,i,n){return e.x=t.x+i.x*n,e.y=t.y+i.y*n,e.z=t.z+i.z*n,e.w=t.w+i.w*n,e}},{key:"rotateX",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),a=t.x,o=t.y,s=t.z,l=t.w;return e.x=a*r+l*n,e.y=o*r+s*n,e.z=s*r-o*n,e.w=l*r-a*n,e}},{key:"rotateY",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),a=t.x,o=t.y,s=t.z,l=t.w;return e.x=a*r-s*n,e.y=o*r+l*n,e.z=s*r+a*n,e.w=l*r-o*n,e}},{key:"rotateZ",value:function(e,t,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),a=t.x,o=t.y,s=t.z,l=t.w;return e.x=a*r+o*n,e.y=o*r-a*n,e.z=s*r+l*n,e.w=l*r-s*n,e}},{key:"rotateAround",value:function(e,t,i,r){return n.invert(ma,t),oa.transformQuat(ga,i,ma),n.fromAxisAngle(ma,ga,r),n.multiply(e,t,ma),e}},{key:"rotateAroundLocal",value:function(e,t,i,r){return n.fromAxisAngle(ma,i,r),n.multiply(e,t,ma),e}},{key:"calculateW",value:function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e}},{key:"dot",value:function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}},{key:"lerp",value:function(e,t,i,n){return e.x=t.x+n*(i.x-t.x),e.y=t.y+n*(i.y-t.y),e.z=t.z+n*(i.z-t.z),e.w=t.w+n*(i.w-t.w),e}},{key:"slerp",value:function(e,t,i,n){var r=0,a=0,o=i.x,s=i.y,l=i.z,c=i.w,u=t.x*i.x+t.y*i.y+t.z*i.z+t.w*i.w;if(u<0&&(u=-u,o=-o,s=-s,l=-l,c=-c),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-n)*h)/_,a=Math.sin(n*h)/_}else r=1-n,a=n;return e.x=r*t.x+a*o,e.y=r*t.y+a*s,e.z=r*t.z+a*l,e.w=r*t.w+a*c,e}},{key:"sqlerp",value:function(e,t,i,r,a,o){return n.slerp(ma,t,a,o),n.slerp(va,i,r,o),n.slerp(e,ma,va,2*o*(1-o)),e}},{key:"invert",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,n=i?1/i:0;return e.x=-t.x*n,e.y=-t.y*n,e.z=-t.z*n,e.w=t.w*n,e}},{key:"conjugate",value:function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e}},{key:"len",value:function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)}},{key:"lengthSqr",value:function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w}},{key:"normalize",value:function(e,t){var i=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return i>0&&(i=1/Math.sqrt(i),e.x=t.x*i,e.y=t.y*i,e.z=t.z*i,e.w=t.w*i),e}},{key:"fromAxes",value:function(e,t,i,r){return _a.set(ya,t.x,t.y,t.z,i.x,i.y,i.z,r.x,r.y,r.z),n.normalize(e,n.fromMat3(e,ya))}},{key:"fromViewUp",value:function(e,t,i){return _a.fromViewUp(ya,t,i),n.normalize(e,n.fromMat3(e,ya))}},{key:"fromAxisAngle",value:function(e,t,i){i*=.5;var n=Math.sin(i);return e.x=n*t.x,e.y=n*t.y,e.z=n*t.z,e.w=Math.cos(i),e}},{key:"fromMat3",value:function(e,t){var i=t.m00,n=t.m03,r=t.m06,a=t.m01,o=t.m04,s=t.m07,l=t.m02,c=t.m05,u=t.m08,h=i+o+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(c-s)*_,e.y=(r-l)*_,e.z=(a-n)*_}else if(i>o&&i>u){var d=2*Math.sqrt(1+i-o-u);e.w=(c-s)/d,e.x=.25*d,e.y=(n+a)/d,e.z=(r+l)/d}else if(o>u){var f=2*Math.sqrt(1+o-i-u);e.w=(r-l)/f,e.x=(n+a)/f,e.y=.25*f,e.z=(s+c)/f}else{var p=2*Math.sqrt(1+u-i-o);e.w=(a-n)/p,e.x=(r+l)/p,e.y=(s+c)/p,e.z=.25*p}return e}},{key:"fromEuler",value:function(e,t,i,n){t*=xa,i*=xa,n*=xa;var r=Math.sin(t),a=Math.cos(t),o=Math.sin(i),s=Math.cos(i),l=Math.sin(n),c=Math.cos(n);return e.x=r*s*c+a*o*l,e.y=a*o*c+r*s*l,e.z=a*s*l-r*o*c,e.w=a*s*c-r*o*l,e}},{key:"toAxisX",value:function(e,t){var i=2*t.y,n=2*t.z;return e.x=1-i*t.y-n*t.z,e.y=i*t.x+n*t.w,e.z=n*t.x+i*t.w,e}},{key:"toAxisY",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=n*t.x-r*t.w,e.y=1-i*t.x-r*t.z,e.z=r*t.y+i*t.w,e}},{key:"toAxisZ",value:function(e,t){var i=2*t.x,n=2*t.y,r=2*t.z;return e.x=r*t.x-n*t.w,e.y=r*t.y-i*t.w,e.z=1-i*t.x-n*t.y,e}},{key:"toEuler",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=t.w,s=0,l=0,c=0,u=n*r+a*o;if(u>.499999)s=0,l=Sn(2*Math.atan2(n,o)),c=90;else if(u<-.499999)s=0,l=-Sn(2*Math.atan2(n,o)),c=-90;else{var h=n*n,_=r*r,d=a*a;s=Sn(Math.atan2(2*n*o-2*r*a,1-2*h-2*d)),l=Sn(Math.atan2(2*r*o-2*n*a,1-2*_-2*d)),c=Sn(Math.asin(2*u)),i&&(s=-180*Math.sign(s+1e-6)+s,l=-180*Math.sign(l+1e-6)+l,c=180*Math.sign(c+1e-6)-c)}return e.x=s,e.y=l,e.z=c,e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.x,e[i+1]=t.y,e[i+2]=t.z,e[i+3]=t.w,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.x=t[i+0],e.y=t[i+1],e.z=t[i+2],e.w=t[i+3],e}},{key:"strictEquals",value:function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn;return Math.abs(e.x-t.x)<=i*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=i*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=i*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=i*Math.max(1,Math.abs(e.w),Math.abs(t.w))}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.z,this.w)}},{key:"set",value:function(e,i,n,r){return e&&"object"===t(e)?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=i||0,this.z=n||0,this.w=null!=r?r:1),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fn;return Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))}},{key:"strictEquals",value:function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{key:"getEulerAngles",value:function(e){return n.toEuler(e,this)}},{key:"lerp",value:function(e,t){return this.x=this.x+t*(e.x-this.x),this.y=this.y+t*(e.y-this.y),this.z=this.z+t*(e.z-this.z),this.w=this.w+t*(e.w-this.w),this}},{key:"slerp",value:function(e,t){return n.slerp(this,this,e,t)}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}},{key:"lengthSqr",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}]),n}(rt));pa.IDENTITY=Object.freeze(new pa);var ma=new pa,va=new pa,ga=new oa,ya=new _a,xa=.5*Math.PI/180;function Sa(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new pa(e,t,i,n)}Ht.fastDefine("cc.Quat",pa,{x:0,y:0,z:0,w:1}),E.Quat=pa,E.quat=Sa;var Ta=e("Mat4",function(e){function n(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,_=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,d=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,f=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,p=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,m=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,v=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,g=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,y=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,x=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,S=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return i(this,n),(e=u(this,s(n).call(this))).m00=void 0,e.m01=void 0,e.m02=void 0,e.m03=void 0,e.m04=void 0,e.m05=void 0,e.m06=void 0,e.m07=void 0,e.m08=void 0,e.m09=void 0,e.m10=void 0,e.m11=void 0,e.m12=void 0,e.m13=void 0,e.m14=void 0,e.m15=void 0,"object"===t(r)?(e.m00=r.m00,e.m01=r.m01,e.m02=r.m02,e.m03=r.m03,e.m04=r.m04,e.m05=r.m05,e.m06=r.m06,e.m07=r.m07,e.m08=r.m08,e.m09=r.m09,e.m10=r.m10,e.m11=r.m11,e.m12=r.m12,e.m13=r.m13,e.m14=r.m14,e.m15=r.m15):(e.m00=r,e.m01=a,e.m02=o,e.m03=l,e.m04=c,e.m05=h,e.m06=_,e.m07=d,e.m08=f,e.m09=p,e.m10=m,e.m11=v,e.m12=g,e.m13=y,e.m14=x,e.m15=S),e}return o(n,e),r(n,null,[{key:"clone",value:function(e){return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"copy",value:function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"set",value:function(e,t,i,n,r,a,o,s,l,c,u,h,_,d,f,p,m){return e.m00=t,e.m01=i,e.m02=n,e.m03=r,e.m04=a,e.m05=o,e.m06=s,e.m07=l,e.m08=c,e.m09=u,e.m10=h,e.m11=_,e.m12=d,e.m13=f,e.m14=p,e.m15=m,e}},{key:"identity",value:function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"transpose",value:function(e,t){if(e===t){var i=t.m01,n=t.m02,r=t.m03,a=t.m06,o=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=i,e.m06=t.m09,e.m07=t.m13,e.m08=n,e.m09=a,e.m11=t.m14,e.m12=r,e.m13=o,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e}},{key:"invert",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,c=t.m07,u=t.m08,h=t.m09,_=t.m10,d=t.m11,f=t.m12,p=t.m13,m=t.m14,v=t.m15,g=i*s-n*o,y=i*l-r*o,x=i*c-a*o,S=n*l-r*s,T=n*c-a*s,E=r*c-a*l,b=u*p-h*f,A=u*m-_*f,C=u*v-d*f,w=h*m-_*p,R=h*v-d*p,I=_*v-d*m,O=g*I-y*R+x*w+S*C-T*A+E*b;return 0===O?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(O=1/O,e.m00=(s*I-l*R+c*w)*O,e.m01=(r*R-n*I-a*w)*O,e.m02=(p*E-m*T+v*S)*O,e.m03=(_*T-h*E-d*S)*O,e.m04=(l*C-o*I-c*A)*O,e.m05=(i*I-r*C+a*A)*O,e.m06=(m*x-f*E-v*y)*O,e.m07=(u*E-_*x+d*y)*O,e.m08=(o*R-s*C+c*b)*O,e.m09=(n*C-i*R-a*b)*O,e.m10=(f*T-p*x+v*g)*O,e.m11=(h*x-u*T-d*g)*O,e.m12=(s*A-o*w-l*b)*O,e.m13=(i*w-n*A+r*b)*O,e.m14=(p*y-f*S-m*g)*O,e.m15=(u*S-h*y+_*g)*O,e)}},{key:"determinant",value:function(e){var t=e.m00,i=e.m01,n=e.m02,r=e.m03,a=e.m04,o=e.m05,s=e.m06,l=e.m07,c=e.m08,u=e.m09,h=e.m10,_=e.m11,d=e.m12,f=e.m13,p=e.m14,m=e.m15;return(t*o-i*a)*(h*m-_*p)-(t*s-n*a)*(u*m-_*f)+(t*l-r*a)*(u*p-h*f)+(i*s-n*o)*(c*m-_*d)-(i*l-r*o)*(c*p-h*d)+(n*l-r*s)*(c*f-u*d)}},{key:"multiply",value:function(e,t,i){var n=t.m00,r=t.m01,a=t.m02,o=t.m03,s=t.m04,l=t.m05,c=t.m06,u=t.m07,h=t.m08,_=t.m09,d=t.m10,f=t.m11,p=t.m12,m=t.m13,v=t.m14,g=t.m15,y=i.m00,x=i.m01,S=i.m02,T=i.m03;return e.m00=y*n+x*s+S*h+T*p,e.m01=y*r+x*l+S*_+T*m,e.m02=y*a+x*c+S*d+T*v,e.m03=y*o+x*u+S*f+T*g,y=i.m04,x=i.m05,S=i.m06,T=i.m07,e.m04=y*n+x*s+S*h+T*p,e.m05=y*r+x*l+S*_+T*m,e.m06=y*a+x*c+S*d+T*v,e.m07=y*o+x*u+S*f+T*g,y=i.m08,x=i.m09,S=i.m10,T=i.m11,e.m08=y*n+x*s+S*h+T*p,e.m09=y*r+x*l+S*_+T*m,e.m10=y*a+x*c+S*d+T*v,e.m11=y*o+x*u+S*f+T*g,y=i.m12,x=i.m13,S=i.m14,T=i.m15,e.m12=y*n+x*s+S*h+T*p,e.m13=y*r+x*l+S*_+T*m,e.m14=y*a+x*c+S*d+T*v,e.m15=y*o+x*u+S*f+T*g,e}},{key:"transform",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;if(t===e)e.m12=t.m00*n+t.m04*r+t.m08*a+t.m12,e.m13=t.m01*n+t.m05*r+t.m09*a+t.m13,e.m14=t.m02*n+t.m06*r+t.m10*a+t.m14,e.m15=t.m03*n+t.m07*r+t.m11*a+t.m15;else{var o=t.m00,s=t.m01,l=t.m02,c=t.m03,u=t.m04,h=t.m05,_=t.m06,d=t.m07,f=t.m08,p=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15;e.m00=o,e.m01=s,e.m02=l,e.m03=c,e.m04=u,e.m05=h,e.m06=_,e.m07=d,e.m08=f,e.m09=p,e.m10=m,e.m11=v,e.m12=o*n+u*r+f*a+t.m12,e.m13=s*n+h*r+p*a+t.m13,e.m14=l*n+_*r+m*a+t.m14,e.m15=c*n+d*r+v*a+t.m15}return e}},{key:"translate",value:function(e,t,i){return console.warn("function changed"),t===e?(e.m12+=i.x,e.m13+=i.y,e.m14+=i.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=i.x,e.m13+=i.y,e.m14+=i.z,e.m15=t.m15),e}},{key:"scale",value:function(e,t,i){var n=i.x,r=i.y,a=i.z;return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*a,e.m09=t.m09*a,e.m10=t.m10*a,e.m11=t.m11*a,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e}},{key:"rotate",value:function(e,t,i,n){var r=n.x,a=n.y,o=n.z,s=Math.sqrt(r*r+a*a+o*o);if(Math.abs(s)<fn)return null;r*=s=1/s,a*=s,o*=s;var l=Math.sin(i),c=Math.cos(i),u=1-c,h=t.m00,_=t.m01,d=t.m02,f=t.m03,p=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,x=t.m09,S=t.m10,T=t.m11,E=r*r*u+c,b=a*r*u+o*l,A=o*r*u-a*l,C=r*a*u-o*l,w=a*a*u+c,R=o*a*u+r*l,I=r*o*u+a*l,O=a*o*u-r*l,M=o*o*u+c;return e.m00=h*E+p*b+y*A,e.m01=_*E+m*b+x*A,e.m02=d*E+v*b+S*A,e.m03=f*E+g*b+T*A,e.m04=h*C+p*w+y*R,e.m05=_*C+m*w+x*R,e.m06=d*C+v*w+S*R,e.m07=f*C+g*w+T*R,e.m08=h*I+p*O+y*M,e.m09=_*I+m*O+x*M,e.m10=d*I+v*O+S*M,e.m11=f*I+g*O+T*M,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e}},{key:"rotateX",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m04,o=t.m05,s=t.m06,l=t.m07,c=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=a*r+c*n,e.m05=o*r+u*n,e.m06=s*r+h*n,e.m07=l*r+_*n,e.m08=c*r-a*n,e.m09=u*r-o*n,e.m10=h*r-s*n,e.m11=_*r-l*n,e}},{key:"rotateY",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,o=t.m01,s=t.m02,l=t.m03,c=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r-c*n,e.m01=o*r-u*n,e.m02=s*r-h*n,e.m03=l*r-_*n,e.m08=a*n+c*r,e.m09=o*n+u*r,e.m10=s*n+h*r,e.m11=l*n+_*r,e}},{key:"rotateZ",value:function(e,t,i){var n=Math.sin(i),r=Math.cos(i),a=t.m00,o=t.m01,s=t.m02,l=t.m03,c=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=a*r+c*n,e.m01=o*r+u*n,e.m02=s*r+h*n,e.m03=l*r+_*n,e.m04=c*r-a*n,e.m05=u*r-o*n,e.m06=h*r-s*n,e.m07=_*r-l*n,e}},{key:"fromTranslation",value:function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e}},{key:"fromScaling",value:function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRotation",value:function(e,t,i){var n=i.x,r=i.y,a=i.z,o=Math.sqrt(n*n+r*r+a*a);if(Math.abs(o)<fn)return null;n*=o=1/o,r*=o,a*=o;var s=Math.sin(t),l=Math.cos(t),c=1-l;return e.m00=n*n*c+l,e.m01=r*n*c+a*s,e.m02=a*n*c-r*s,e.m03=0,e.m04=n*r*c-a*s,e.m05=r*r*c+l,e.m06=a*r*c+n*s,e.m07=0,e.m08=n*a*c+r*s,e.m09=r*a*c-n*s,e.m10=a*a*c+l,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromXRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=n,e.m06=i,e.m07=0,e.m08=0,e.m09=-i,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromYRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=0,e.m02=-i,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=i,e.m09=0,e.m10=n,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromZRotation",value:function(e,t){var i=Math.sin(t),n=Math.cos(t);return e.m00=n,e.m01=i,e.m02=0,e.m03=0,e.m04=-i,e.m05=n,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"fromRT",value:function(e,t,i){var n=t.x,r=t.y,a=t.z,o=t.w,s=n+n,l=r+r,c=a+a,u=n*s,h=n*l,_=n*c,d=r*l,f=r*c,p=a*c,m=o*s,v=o*l,g=o*c;return e.m00=1-(d+p),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+p),e.m06=f+m,e.m07=0,e.m08=_+v,e.m09=f-m,e.m10=1-(u+d),e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"getTranslation",value:function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e}},{key:"getScaling",value:function(e,t){var i=ba.m00=t.m00,n=ba.m01=t.m01,r=ba.m02=t.m02,a=ba.m03=t.m04,o=ba.m04=t.m05,s=ba.m05=t.m06,l=ba.m06=t.m08,c=ba.m07=t.m09,u=ba.m08=t.m10;return e.x=Math.sqrt(i*i+n*n+r*r),e.y=Math.sqrt(a*a+o*o+s*s),e.z=Math.sqrt(l*l+c*c+u*u),_a.determinant(ba)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e,t){var i=t.m00+t.m05+t.m10,n=0;return i>0?(n=2*Math.sqrt(i+1),e.w=.25*n,e.x=(t.m06-t.m09)/n,e.y=(t.m08-t.m02)/n,e.z=(t.m01-t.m04)/n):t.m00>t.m05&&t.m00>t.m10?(n=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/n,e.x=.25*n,e.y=(t.m01+t.m04)/n,e.z=(t.m08+t.m02)/n):t.m05>t.m10?(n=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/n,e.x=(t.m01+t.m04)/n,e.y=.25*n,e.z=(t.m06+t.m09)/n):(n=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/n,e.x=(t.m08+t.m02)/n,e.y=(t.m06+t.m09)/n,e.z=.25*n),e}},{key:"toRTS",value:function(e,t,i,n){n.x=oa.set(Ea,e.m00,e.m01,e.m02).length(),ba.m00=e.m00/n.x,ba.m01=e.m01/n.x,ba.m02=e.m02/n.x,n.y=oa.set(Ea,e.m04,e.m05,e.m06).length(),ba.m03=e.m04/n.y,ba.m04=e.m05/n.y,ba.m05=e.m06/n.y,n.z=oa.set(Ea,e.m08,e.m09,e.m10).length(),ba.m06=e.m08/n.z,ba.m07=e.m09/n.z,ba.m08=e.m10/n.z,_a.determinant(ba)<0&&(n.x*=-1,ba.m00*=-1,ba.m01*=-1,ba.m02*=-1),pa.fromMat3(t,ba),oa.set(i,e.m12,e.m13,e.m14)}},{key:"fromRTS",value:function(e,t,i,n){var r=t.x,a=t.y,o=t.z,s=t.w,l=r+r,c=a+a,u=o+o,h=r*l,_=r*c,d=r*u,f=a*c,p=a*u,m=o*u,v=s*l,g=s*c,y=s*u,x=n.x,S=n.y,T=n.z;return e.m00=(1-(f+m))*x,e.m01=(_+y)*x,e.m02=(d-g)*x,e.m03=0,e.m04=(_-y)*S,e.m05=(1-(h+m))*S,e.m06=(p+v)*S,e.m07=0,e.m08=(d+g)*T,e.m09=(p-v)*T,e.m10=(1-(h+f))*T,e.m11=0,e.m12=i.x,e.m13=i.y,e.m14=i.z,e.m15=1,e}},{key:"fromRTSOrigin",value:function(e,t,i,n,r){var a=t.x,o=t.y,s=t.z,l=t.w,c=a+a,u=o+o,h=s+s,_=a*c,d=a*u,f=a*h,p=o*u,m=o*h,v=s*h,g=l*c,y=l*u,x=l*h,S=n.x,T=n.y,E=n.z,b=r.x,A=r.y,C=r.z;return e.m00=(1-(p+v))*S,e.m01=(d+x)*S,e.m02=(f-y)*S,e.m03=0,e.m04=(d-x)*T,e.m05=(1-(_+v))*T,e.m06=(m+g)*T,e.m07=0,e.m08=(f+y)*E,e.m09=(m-g)*E,e.m10=(1-(_+p))*E,e.m11=0,e.m12=i.x+b-(e.m00*b+e.m04*A+e.m08*C),e.m13=i.y+A-(e.m01*b+e.m05*A+e.m09*C),e.m14=i.z+C-(e.m02*b+e.m06*A+e.m10*C),e.m15=1,e}},{key:"fromQuat",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=t.w,o=i+i,s=n+n,l=r+r,c=i*o,u=n*o,h=n*s,_=r*o,d=r*s,f=r*l,p=a*o,m=a*s,v=a*l;return e.m00=1-h-f,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-c-f,e.m06=d+p,e.m07=0,e.m08=_+m,e.m09=d-p,e.m10=1-c-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e}},{key:"frustum",value:function(e,t,i,n,r,a,o){var s=1/(i-t),l=1/(r-n),c=1/(a-o);return e.m00=2*a*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*a*l,e.m06=0,e.m07=0,e.m08=(i+t)*s,e.m09=(r+n)*l,e.m10=(o+a)*c,e.m11=-1,e.m12=0,e.m13=0,e.m14=o*a*2*c,e.m15=0,e}},{key:"perspective",value:function(e,t,i,n,r){var a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:-1,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,l=1/Math.tan(t/2),c=1/(n-r);return e.m00=a?l/i:l,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=(a?l:l*i)*s,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-o*n)*c,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*n*c*(1-o),e.m15=0,e}},{key:"ortho",value:function(e,t,i,n,r,a,o){var s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:-1,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1,c=1/(t-i),u=1/(n-r),h=1/(a-o);return e.m00=-2*c,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=-2*u*l,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=h*(1-s),e.m11=0,e.m12=(t+i)*c,e.m13=(r+n)*u,e.m14=(a-s*o)*h,e.m15=1,e}},{key:"lookAt",value:function(e,t,i,n){var r=t.x,a=t.y,o=t.z,s=n.x,l=n.y,c=n.z,u=r-i.x,h=a-i.y,_=o-i.z,d=1/Math.sqrt(u*u+h*h+_*_),f=l*(_*=d)-c*(h*=d),p=c*(u*=d)-s*_,m=s*h-l*u,v=h*(m*=d=1/Math.sqrt(f*f+p*p+m*m))-_*(p*=d),g=_*(f*=d)-u*m,y=u*p-h*f;return e.m00=f,e.m01=v,e.m02=u,e.m03=0,e.m04=p,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(f*r+p*a+m*o),e.m13=-(v*r+g*a+y*o),e.m14=-(u*r+h*a+_*o),e.m15=1,e}},{key:"inverseTranspose",value:function(e,t){var i=t.m00,n=t.m01,r=t.m02,a=t.m03,o=t.m04,s=t.m05,l=t.m06,c=t.m07,u=t.m08,h=t.m09,_=t.m10,d=t.m11,f=t.m12,p=t.m13,m=t.m14,v=t.m15,g=i*s-n*o,y=i*l-r*o,x=i*c-a*o,S=n*l-r*s,T=n*c-a*s,E=r*c-a*l,b=u*p-h*f,A=u*m-_*f,C=u*v-d*f,w=h*m-_*p,R=h*v-d*p,I=_*v-d*m,O=g*I-y*R+x*w+S*C-T*A+E*b;return O?(O=1/O,e.m00=(s*I-l*R+c*w)*O,e.m01=(l*C-o*I-c*A)*O,e.m02=(o*R-s*C+c*b)*O,e.m03=0,e.m04=(r*R-n*I-a*w)*O,e.m05=(i*I-r*C+a*A)*O,e.m06=(n*C-i*R-a*b)*O,e.m07=0,e.m08=(p*E-m*T+v*S)*O,e.m09=(m*x-f*E-v*y)*O,e.m10=(f*T-p*x+v*g)*O,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i+0]=t.m00,e[i+1]=t.m01,e[i+2]=t.m02,e[i+3]=t.m03,e[i+4]=t.m04,e[i+5]=t.m05,e[i+6]=t.m06,e[i+7]=t.m07,e[i+8]=t.m08,e[i+9]=t.m09,e[i+10]=t.m10,e[i+11]=t.m11,e[i+12]=t.m12,e[i+13]=t.m13,e[i+14]=t.m14,e[i+15]=t.m15,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e.m00=t[i+0],e.m01=t[i+1],e.m02=t[i+2],e.m03=t[i+3],e.m04=t[i+4],e.m05=t[i+5],e.m06=t[i+6],e.m07=t[i+7],e.m08=t[i+8],e.m09=t[i+9],e.m10=t[i+10],e.m11=t[i+11],e.m12=t[i+12],e.m13=t[i+13],e.m14=t[i+14],e.m15=t[i+15],e}},{key:"add",value:function(e,t,i){return e.m00=t.m00+i.m00,e.m01=t.m01+i.m01,e.m02=t.m02+i.m02,e.m03=t.m03+i.m03,e.m04=t.m04+i.m04,e.m05=t.m05+i.m05,e.m06=t.m06+i.m06,e.m07=t.m07+i.m07,e.m08=t.m08+i.m08,e.m09=t.m09+i.m09,e.m10=t.m10+i.m10,e.m11=t.m11+i.m11,e.m12=t.m12+i.m12,e.m13=t.m13+i.m13,e.m14=t.m14+i.m14,e.m15=t.m15+i.m15,e}},{key:"subtract",value:function(e,t,i){return e.m00=t.m00-i.m00,e.m01=t.m01-i.m01,e.m02=t.m02-i.m02,e.m03=t.m03-i.m03,e.m04=t.m04-i.m04,e.m05=t.m05-i.m05,e.m06=t.m06-i.m06,e.m07=t.m07-i.m07,e.m08=t.m08-i.m08,e.m09=t.m09-i.m09,e.m10=t.m10-i.m10,e.m11=t.m11-i.m11,e.m12=t.m12-i.m12,e.m13=t.m13-i.m13,e.m14=t.m14-i.m14,e.m15=t.m15-i.m15,e}},{key:"multiplyScalar",value:function(e,t,i){return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*i,e.m05=t.m05*i,e.m06=t.m06*i,e.m07=t.m07*i,e.m08=t.m08*i,e.m09=t.m09*i,e.m10=t.m10*i,e.m11=t.m11*i,e.m12=t.m12*i,e.m13=t.m13*i,e.m14=t.m14*i,e.m15=t.m15*i,e}},{key:"multiplyScalarAndAdd",value:function(e,t,i,n){return e.m00=t.m00+i.m00*n,e.m01=t.m01+i.m01*n,e.m02=t.m02+i.m02*n,e.m03=t.m03+i.m03*n,e.m04=t.m04+i.m04*n,e.m05=t.m05+i.m05*n,e.m06=t.m06+i.m06*n,e.m07=t.m07+i.m07*n,e.m08=t.m08+i.m08*n,e.m09=t.m09+i.m09*n,e.m10=t.m10+i.m10*n,e.m11=t.m11+i.m11*n,e.m12=t.m12+i.m12*n,e.m13=t.m13+i.m13*n,e.m14=t.m14+i.m14*n,e.m15=t.m15+i.m15*n,e}},{key:"strictEquals",value:function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn;return Math.abs(e.m00-t.m00)<=i*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=i*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=i*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=i*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=i*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=i*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=i*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=i*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=i*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=i*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=i*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=i*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=i*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=i*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=i*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=i*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))}}]),r(n,[{key:"clone",value:function(){var e=this;return new n(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)}},{key:"set",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,_=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,d=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,f=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,p=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,m=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return"object"===t(e)?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=i,this.m02=n,this.m03=r,this.m04=a,this.m05=o,this.m06=s,this.m07=l,this.m08=c,this.m09=u,this.m10=h,this.m11=_,this.m12=d,this.m13=f,this.m14=p,this.m15=m,this.m00=e),this}},{key:"equals",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fn;return Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))}},{key:"strictEquals",value:function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15}},{key:"toString",value:function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"}},{key:"identity",value:function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}},{key:"transpose",value:function(){var e=this.m01,t=this.m02,i=this.m03,n=this.m06,r=this.m07,a=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=a,this}},{key:"invert",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,l=this.m08,c=this.m09,u=this.m10,h=this.m11,_=this.m12,d=this.m13,f=this.m14,p=this.m15,m=e*a-t*r,v=e*o-i*r,g=e*s-n*r,y=t*o-i*a,x=t*s-n*a,S=i*s-n*o,T=l*d-c*_,E=l*f-u*_,b=l*p-h*_,A=c*f-u*d,C=c*p-h*d,w=u*p-h*f,R=m*w-v*C+g*A+y*b-x*E+S*T;return 0===R?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(R=1/R,this.m00=(a*w-o*C+s*A)*R,this.m01=(i*C-t*w-n*A)*R,this.m02=(d*S-f*x+p*y)*R,this.m03=(u*x-c*S-h*y)*R,this.m04=(o*b-r*w-s*E)*R,this.m05=(e*w-i*b+n*E)*R,this.m06=(f*g-_*S-p*v)*R,this.m07=(l*S-u*g+h*v)*R,this.m08=(r*C-a*b+s*T)*R,this.m09=(t*b-e*C-n*T)*R,this.m10=(_*x-d*g+p*m)*R,this.m11=(c*g-l*x-h*m)*R,this.m12=(a*E-r*A-o*T)*R,this.m13=(e*A-t*E+i*T)*R,this.m14=(d*v-_*y-f*m)*R,this.m15=(l*y-c*v+u*m)*R,this)}},{key:"determinant",value:function(){var e=this.m00,t=this.m01,i=this.m02,n=this.m03,r=this.m04,a=this.m05,o=this.m06,s=this.m07,l=this.m08,c=this.m09,u=this.m10,h=this.m11,_=this.m12,d=this.m13,f=this.m14,p=this.m15;return(e*a-t*r)*(u*p-h*f)-(e*o-i*r)*(c*p-h*d)+(e*s-n*r)*(c*f-u*d)+(t*o-i*a)*(l*p-h*_)-(t*s-n*a)*(l*f-u*_)+(i*s-n*o)*(l*d-c*_)}},{key:"add",value:function(e){return this.m00=this.m00+e.m00,this.m01=this.m01+e.m01,this.m02=this.m02+e.m02,this.m03=this.m03+e.m03,this.m04=this.m04+e.m04,this.m05=this.m05+e.m05,this.m06=this.m06+e.m06,this.m07=this.m07+e.m07,this.m08=this.m08+e.m08,this.m09=this.m09+e.m09,this.m10=this.m10+e.m10,this.m11=this.m11+e.m11,this.m12=this.m12+e.m12,this.m13=this.m13+e.m13,this.m14=this.m14+e.m14,this.m15=this.m15+e.m15,this}},{key:"subtract",value:function(e){return this.m00=this.m00-e.m00,this.m01=this.m01-e.m01,this.m02=this.m02-e.m02,this.m03=this.m03-e.m03,this.m04=this.m04-e.m04,this.m05=this.m05-e.m05,this.m06=this.m06-e.m06,this.m07=this.m07-e.m07,this.m08=this.m08-e.m08,this.m09=this.m09-e.m09,this.m10=this.m10-e.m10,this.m11=this.m11-e.m11,this.m12=this.m12-e.m12,this.m13=this.m13-e.m13,this.m14=this.m14-e.m14,this.m15=this.m15-e.m15,this}},{key:"multiply",value:function(e){var t=this.m00,i=this.m01,n=this.m02,r=this.m03,a=this.m04,o=this.m05,s=this.m06,l=this.m07,c=this.m08,u=this.m09,h=this.m10,_=this.m11,d=this.m12,f=this.m13,p=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,x=e.m03;return this.m00=v*t+g*a+y*c+x*d,this.m01=v*i+g*o+y*u+x*f,this.m02=v*n+g*s+y*h+x*p,this.m03=v*r+g*l+y*_+x*m,v=e.m04,g=e.m05,y=e.m06,x=e.m07,this.m04=v*t+g*a+y*c+x*d,this.m05=v*i+g*o+y*u+x*f,this.m06=v*n+g*s+y*h+x*p,this.m07=v*r+g*l+y*_+x*m,v=e.m08,g=e.m09,y=e.m10,x=e.m11,this.m08=v*t+g*a+y*c+x*d,this.m09=v*i+g*o+y*u+x*f,this.m10=v*n+g*s+y*h+x*p,this.m11=v*r+g*l+y*_+x*m,v=e.m12,g=e.m13,y=e.m14,x=e.m15,this.m12=v*t+g*a+y*c+x*d,this.m13=v*i+g*o+y*u+x*f,this.m14=v*n+g*s+y*h+x*p,this.m15=v*r+g*l+y*_+x*m,this}},{key:"multiplyScalar",value:function(e){return this.m00=this.m00*e,this.m01=this.m01*e,this.m02=this.m02*e,this.m03=this.m03*e,this.m04=this.m04*e,this.m05=this.m05*e,this.m06=this.m06*e,this.m07=this.m07*e,this.m08=this.m08*e,this.m09=this.m09*e,this.m10=this.m10*e,this.m11=this.m11*e,this.m12=this.m12*e,this.m13=this.m13*e,this.m14=this.m14*e,this.m15=this.m15*e,this}},{key:"translate",value:function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this}},{key:"scale",value:function(e){var t=e.x,i=e.y,n=e.z;return this.m00=this.m00*t,this.m01=this.m01*t,this.m02=this.m02*t,this.m03=this.m03*t,this.m04=this.m04*i,this.m05=this.m05*i,this.m06=this.m06*i,this.m07=this.m07*i,this.m08=this.m08*n,this.m09=this.m09*n,this.m10=this.m10*n,this.m11=this.m11*n,this.m12=this.m12,this.m13=this.m13,this.m14=this.m14,this.m15=this.m15,this}},{key:"rotate",value:function(e,t){var i=t.x,n=t.y,r=t.z,a=Math.sqrt(i*i+n*n+r*r);if(Math.abs(a)<fn)return null;i*=a=1/a,n*=a,r*=a;var o=Math.sin(e),s=Math.cos(e),l=1-s,c=this.m00,u=this.m01,h=this.m02,_=this.m03,d=this.m04,f=this.m05,p=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=i*i*l+s,T=n*i*l+r*o,E=r*i*l-n*o,b=i*n*l-r*o,A=n*n*l+s,C=r*n*l+i*o,w=i*r*l+n*o,R=n*r*l-i*o,I=r*r*l+s;return this.m00=c*S+d*T+v*E,this.m01=u*S+f*T+g*E,this.m02=h*S+p*T+y*E,this.m03=_*S+m*T+x*E,this.m04=c*b+d*A+v*C,this.m05=u*b+f*A+g*C,this.m06=h*b+p*A+y*C,this.m07=_*b+m*A+x*C,this.m08=c*w+d*R+v*I,this.m09=u*w+f*R+g*I,this.m10=h*w+p*R+y*I,this.m11=_*w+m*R+x*I,this}},{key:"getTranslation",value:function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e}},{key:"getScale",value:function(e){var t=ba.m00=this.m00,i=ba.m01=this.m01,n=ba.m02=this.m02,r=ba.m03=this.m04,a=ba.m04=this.m05,o=ba.m05=this.m06,s=ba.m06=this.m08,l=ba.m07=this.m09,c=ba.m08=this.m10;return e.x=Math.sqrt(t*t+i*i+n*n),e.y=Math.sqrt(r*r+a*a+o*o),e.z=Math.sqrt(s*s+l*l+c*c),_a.determinant(ba)<0&&(e.x*=-1),e}},{key:"getRotation",value:function(e){var t=this.m00+this.m05+this.m10,i=0;return t>0?(i=2*Math.sqrt(t+1),e.w=.25*i,e.x=(this.m06-this.m09)/i,e.y=(this.m08-this.m02)/i,e.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/i,e.x=.25*i,e.y=(this.m01+this.m04)/i,e.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/i,e.x=(this.m01+this.m04)/i,e.y=.25*i,e.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/i,e.x=(this.m08+this.m02)/i,e.y=(this.m06+this.m09)/i,e.z=.25*i),e}},{key:"fromRTS",value:function(e,t,i){var n=e.x,r=e.y,a=e.z,o=e.w,s=n+n,l=r+r,c=a+a,u=n*s,h=n*l,_=n*c,d=r*l,f=r*c,p=a*c,m=o*s,v=o*l,g=o*c,y=i.x,x=i.y,S=i.z;return this.m00=(1-(d+p))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+p))*x,this.m06=(f+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(f-m)*S,this.m10=(1-(u+d))*S,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this}},{key:"fromQuat",value:function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,o=i+i,s=n+n,l=t*a,c=i*a,u=i*o,h=n*a,_=n*o,d=n*s,f=r*a,p=r*o,m=r*s;return this.m00=1-u-d,this.m01=c+m,this.m02=h-p,this.m03=0,this.m04=c-m,this.m05=1-l-d,this.m06=_+f,this.m07=0,this.m08=h+p,this.m09=_-f,this.m10=1-l-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}]),n}(rt));Ta.IDENTITY=Object.freeze(new Ta);var Ea=new oa,ba=new _a;function Aa(e,t,i,n,r,a,o,s,l,c,u,h,_,d,f,p){return new Ta(e,t,i,n,r,a,o,s,l,c,u,h,_,d,f,p)}Ht.fastDefine("cc.Mat4",Ta,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),E.Mat4=Ta,E.mat4=Aa;var Ca=e("AffineTransform",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;i(this,e),this.a=t,this.b=n,this.c=r,this.d=a,this.tx=o,this.ty=s}return r(e,null,[{key:"identity",value:function(){return new e}},{key:"clone",value:function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)}},{key:"concat",value:function(e,t,i){var n=t.a,r=t.b,a=t.c,o=t.d,s=t.tx,l=t.ty;e.a=n*i.a+r*i.c,e.b=n*i.b+r*i.d,e.c=a*i.a+o*i.c,e.d=a*i.b+o*i.d,e.tx=s*i.a+l*i.c+i.tx,e.ty=s*i.b+l*i.d+i.ty}},{key:"invert",value:function(e,t){var i=1/(t.a*t.d-t.b*t.c);e.a=i*t.d,e.b=-i*t.b,e.c=-i*t.c,e.d=i*t.a,e.tx=i*(t.c*t.ty-t.d*t.tx),e.ty=i*(t.b*t.tx-t.a*t.ty)}},{key:"fromMat4",value:function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13}},{key:"transformVec2",value:function(e,t,i,n){var r,a;void 0===n?(n=i,r=t.x,a=t.y):(r=t,a=i),e.x=n.a*r+n.c*a+n.tx,e.y=n.b*r+n.d*a+n.ty}},{key:"transformSize",value:function(e,t,i){e.width=i.a*t.width+i.c*t.height,e.height=i.b*t.width+i.d*t.height}},{key:"transformRect",value:function(e,t,i){var n=t.x+t.width,r=t.y+t.height,a=i.a*t.x+i.c*t.y+i.tx,o=i.b*t.x+i.d*t.y+i.ty,s=i.a*n+i.c*t.y+i.tx,l=i.b*n+i.d*t.y+i.ty,c=i.a*t.x+i.c*r+i.tx,u=i.b*t.x+i.d*r+i.ty,h=i.a*n+i.c*r+i.tx,_=i.b*n+i.d*r+i.ty,d=Math.min(a,s,c,h),f=Math.max(a,s,c,h),p=Math.min(o,l,u,_),m=Math.max(o,l,u,_);e.x=d,e.y=p,e.width=f-d,e.height=m-p}},{key:"transformObb",value:function(e,t,i,n,r,a){var o=a.a*r.x+a.c*r.y+a.tx,s=a.b*r.x+a.d*r.y+a.ty,l=a.a*r.width,c=a.b*r.width,u=a.c*r.height,h=a.d*r.height;t.x=o,t.y=s,i.x=l+o,i.y=c+s,e.x=u+o,e.y=h+s,n.x=l+u+o,n.y=c+h+s}}]),e}());E.AffineTransform=Ca;var wa=e("Size",function(e){function n(e,r){var a;return i(this,n),a=u(this,s(n).call(this)),e&&"object"===t(e)?(a.height=e.height,a.width=e.width):(a.width=e||0,a.height=r||0),a}return o(n,e),r(n,[{key:"x",set:function(e){this.width=e},get:function(){return this.width}},{key:"y",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"lerp",value:function(e,t,i,n){return e.width=t.width+(i.width-t.width)*n,e.height=t.height+(i.height-t.height)*n,e}}]),r(n,[{key:"clone",value:function(){return new n(this.width,this.height)}},{key:"set",value:function(e,i){return e&&"object"===t(e)?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=i||0),this}},{key:"equals",value:function(e){return this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){return this.width=this.width+(e.width-this.width)*t,this.height=this.height+(e.height-this.height)*t,this}},{key:"toString",value:function(){return"(".concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}}]),n}(rt));function Ra(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new wa(e,t)}wa.ZERO=Object.freeze(new wa(0,0)),wa.ONE=Object.freeze(new wa(1,1)),Ht.fastDefine("cc.Size",wa,{width:0,height:0}),E.size=Ra,E.Size=wa;var Ia=e("Rect",function(e){function n(e,r,a,o){var l;return i(this,n),l=u(this,s(n).call(this)),e&&"object"===t(e)?(l.y=e.y,l.width=e.width,l.height=e.height,l.x=e.x):(l.x=e||0,l.y=r||0,l.width=a||0,l.height=o||0),l}return o(n,e),r(n,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new ia(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new E.Vec2(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new wa(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",set:function(e){this.width=e},get:function(){return this.width}},{key:"w",set:function(e){this.height=e},get:function(){return this.height}}],[{key:"fromMinMax",value:function(e,t,i){var n=Math.min(t.x,i.x),r=Math.min(t.y,i.y),a=Math.max(t.x,i.x),o=Math.max(t.y,i.y);return e.x=n,e.y=r,e.width=a-n,e.height=o-r,e}},{key:"lerp",value:function(e,t,i,n){var r=t.x,a=t.y,o=t.width,s=t.height;return e.x=r+(i.x-r)*n,e.y=a+(i.y-a)*n,e.width=o+(i.width-o)*n,e.height=s+(i.height-s)*n,e}},{key:"intersection",value:function(e,t,i){var n=t.x,r=t.y,a=t.x+t.width,o=t.y+t.height,s=i.x,l=i.y,c=i.x+i.width,u=i.y+i.height;return e.x=Math.max(n,s),e.y=Math.max(r,l),e.width=Math.min(a,c)-e.x,e.height=Math.min(o,u)-e.y,e}},{key:"union",value:function(e,t,i){var n=t.x,r=t.y,a=t.width,o=t.height,s=i.x,l=i.y,c=i.width,u=i.height;return e.x=Math.min(n,s),e.y=Math.min(r,l),e.width=Math.max(n+a,s+c)-e.x,e.height=Math.max(r+o,l+u)-e.y,e}}]),r(n,[{key:"clone",value:function(){return new n(this.x,this.y,this.width,this.height)}},{key:"set",value:function(e,i,n,r){return e&&"object"===t(e)?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=i||0,this.width=n||0,this.height=r||0),this}},{key:"equals",value:function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}},{key:"lerp",value:function(e,t){var i=this.x,n=this.y,r=this.width,a=this.height;return this.x=i+(e.x-i)*t,this.y=n+(e.y-n)*t,this.width=r+(e.width-r)*t,this.height=a+(e.height-a)*t,this}},{key:"toString",value:function(){return"(".concat(this.x.toFixed(2),", ").concat(this.y.toFixed(2),", ").concat(this.width.toFixed(2),", ").concat(this.height.toFixed(2),")")}},{key:"intersects",value:function(e){var t=this.x+this.width,i=this.y+this.height,n=e.x+e.width,r=e.y+e.height;return!(t<e.x||n<this.x||i<e.y||r<this.y)}},{key:"contains",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y}},{key:"containsRect",value:function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height}},{key:"transformMat4",value:function(e){var t=this.x,i=this.y,n=t+this.width,r=i+this.height,a=e.m00*t+e.m04*i+e.m12,o=e.m01*t+e.m05*i+e.m13,s=e.m00*n+e.m04*i+e.m12,l=e.m01*n+e.m05*i+e.m13,c=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*n+e.m04*r+e.m12,_=e.m01*n+e.m05*r+e.m13,d=Math.min(a,s,c,h),f=Math.max(a,s,c,h),p=Math.min(o,l,u,_),m=Math.max(o,l,u,_);return this.x=d,this.y=p,this.width=f-d,this.height=m-p,this}}]),n}(rt));function Oa(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return new Ia(e,t,i,n)}Ht.fastDefine("cc.Rect",Ia,{x:0,y:0,width:0,height:0}),E.Rect=Ia,E.rect=Oa;var Ma=e("Color",function(e){function n(e,t,r,a){var o;return i(this,n),(o=u(this,s(n).call(this)))._val=0,"string"==typeof e?o.fromHEX(e):void 0!==t?o.set(e,t,r,a):o.set(e),o}return o(n,e),r(n,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~vn(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~vn(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~vn(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~vn(e,0,255),this._val=(16777215&this._val|e<<24>>>0)>>>0}},{key:"x",get:function(){return this.r*(1/255)},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*(1/255)},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*(1/255)},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*(1/255)},set:function(e){this.a=255*e}}],[{key:"clone",value:function(e){var t=new n;return e._val?t._val=e._val:t._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,t}},{key:"copy",value:function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e}},{key:"set",value:function(e,t,i,n,r){return e.r=t,e.g=i,e.b=n,e.a=r,e}},{key:"fromHEX",value:function(e,t){return t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0,e.a=parseInt(t.substr(6,2),16)||255,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e}},{key:"add",value:function(e,t,i){return e.r=t.r+i.r,e.g=t.g+i.g,e.b=t.b+i.b,e.a=t.a+i.a,e}},{key:"subtract",value:function(e,t,i){return e.r=t.r-i.r,e.g=t.g-i.g,e.b=t.b-i.b,e.a=t.a-i.a,e}},{key:"multiply",value:function(e,t,i){return e.r=t.r*i.r,e.g=t.g*i.g,e.b=t.b*i.b,e.a=t.a*i.a,e}},{key:"divide",value:function(e,t,i){return e.r=t.r/i.r,e.g=t.g/i.g,e.b=t.b/i.b,e.a=t.a/i.a,e}},{key:"scale",value:function(e,t,i){return e.r=t.r*i,e.g=t.g*i,e.b=t.b*i,e.a=t.a*i,e}},{key:"lerp",value:function(e,t,i,n){var r=t.r,a=t.g,o=t.b,s=t.a;return r+=(i.r-r)*n,a+=(i.g-a)*n,o+=(i.b-o)*n,s+=(i.a-s)*n,e._val=Math.floor((s<<24>>>0)+(o<<16)+(a<<8)+r),e}},{key:"toArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=t instanceof n||t.a>1?1/255:1;return e[i+0]=t.r*r,e[i+1]=t.g*r,e[i+2]=t.b*r,e[i+3]=t.a*r,e}},{key:"fromArray",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return t.r=255*e[i+0],t.g=255*e[i+1],t.b=255*e[i+2],t.a=255*e[i+3],t}},{key:"strictEquals",value:function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}},{key:"equals",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fn;return Math.abs(e.r-t.r)<=i*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=i*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=i*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=i*Math.max(1,Math.abs(e.a),Math.abs(t.a))}},{key:"hex",value:function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0}}]),r(n,[{key:"clone",value:function(){var e=new n;return e._val=this._val,e}},{key:"equals",value:function(e){return e&&this._val===e._val}},{key:"lerp",value:function(e,t){var i=this.r,n=this.g,r=this.b,a=this.a;return i+=(e.r-i)*t,n+=(e.g-n)*t,r+=(e.b-r)*t,a+=(e.a-a)*t,this._val=Math.floor((a<<24>>>0)+(r<<16)+(n<<8)+i),this}},{key:"toString",value:function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"}},{key:"toCSS",value:function(e){return"rgba"===e?"rgba("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+","+(this.a*(1/255)).toFixed(2)+")":"rgb"===e?"rgb("+(0|this.r)+","+(0|this.g)+","+(0|this.b)+")":"#"+this.toHEX(e)}},{key:"fromHEX",value:function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,i=parseInt(e.substr(2,2),16)||0,n=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16)||255;return this._val=(r<<24>>>0)+(n<<16)+(i<<8)+t,this}},{key:"toHEX",value:function(e){var t=[(this.r<16?"0":"")+(0|this.r).toString(16),(this.g<16?"0":"")+(0|this.g).toString(16),(this.b<16?"0":"")+(0|this.b).toString(16)],i=-1;if("#rgb"===e)for(i=0;i<t.length;++i)t[i].length>1&&(t[i]=t[i][0]);else if("#rrggbb"===e)for(i=0;i<t.length;++i)1===t[i].length&&(t[i]="0"+t[i]);else"#rrggbbaa"===e&&t.push((this.a<16?"0":"")+(0|this.a).toString(16));return t.join("")}},{key:"toRGBValue",value:function(){return 16777215&this._val}},{key:"fromHSV",value:function(e,t,i){var n=0,r=0,a=0;if(0===t)n=r=a=i;else if(0===i)n=r=a=0;else{1===e&&(e=0),e*=6,t=t,i=i;var o=Math.floor(e),s=e-o,l=i*(1-t),c=i*(1-t*s),u=i*(1-t*(1-s));switch(o){case 0:n=i,r=u,a=l;break;case 1:n=c,r=i,a=l;break;case 2:n=l,r=i,a=u;break;case 3:n=l,r=c,a=i;break;case 4:n=u,r=l,a=i;break;case 5:n=i,r=l,a=c}}return n*=255,r*=255,a*=255,this._val=(this.a<<24>>>0)+(a<<16)+(r<<8)+n,this}},{key:"toHSV",value:function(){var e=this.r*(1/255),t=this.g*(1/255),i=this.b*(1/255),n={h:0,s:0,v:0},r=Math.max(e,t,i),a=Math.min(e,t,i),o=0;return n.v=r,n.s=r?(r-a)/r:0,n.s?(o=r-a,n.h=e===r?(t-i)/o:t===r?2+(i-e)/o:4+(e-t)/o,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n}},{key:"set",value:function(e,i,n,r){return"object"===t(e)?null!=e._val?this._val=e._val:(i=e.g||0,n=e.b||0,r="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(r<<24>>>0)+(n<<16)+(i<<8)+e):(e=e||0,i=i||0,n=n||0,r="number"==typeof r?r:255,this._val=(r<<24>>>0)+(n<<16)+(i<<8)+e),this}},{key:"multiply",value:function(e){var t=(255&this._val)*e.r>>8,i=(65280&this._val)*e.g>>8,n=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&n|65280&i|255&t,this}},{key:"_set_r_unsafe",value:function(e){return this._val=(4294967040&this._val|e)>>>0,this}},{key:"_set_g_unsafe",value:function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this}},{key:"_set_b_unsafe",value:function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this}},{key:"_set_a_unsafe",value:function(e){return this._val=(16777215&this._val|e<<24>>>0)>>>0,this}}]),n}(rt));function Pa(e,t,i,n){return new Ma(e,t,i,n)}Ma.WHITE=Object.freeze(new Ma(255,255,255,255)),Ma.GRAY=Object.freeze(new Ma(127,127,127,255)),Ma.BLACK=Object.freeze(new Ma(0,0,0,255)),Ma.TRANSPARENT=Object.freeze(new Ma(0,0,0,0)),Ma.RED=Object.freeze(new Ma(255,0,0,255)),Ma.GREEN=Object.freeze(new Ma(0,255,0,255)),Ma.BLUE=Object.freeze(new Ma(0,0,255,255)),Ma.CYAN=Object.freeze(new Ma(0,255,255,255)),Ma.MAGENTA=Object.freeze(new Ma(255,0,255,255)),Ma.YELLOW=Object.freeze(new Ma(255,255,0,255)),Ht.fastDefine("cc.Color",Ma,{r:0,g:0,b:0,a:255}),E.Color=Ma,E.color=Pa;var ka,Da,Ba,La,Na,Fa,za=10;var Ua=0,Ga=new Map;La=function(e,t,i,n,r,a){var o=Ga.get(a);o&&o.logTimes>o.count&&(r("'%s' is deprecated, please use '%s' instead.","".concat(e,".").concat(t),"".concat(i,".").concat(n)),o.count++)},ka=e("replaceProperty",(function(e,t,i){null!=e&&i.forEach((function(i){var n=Ua++;Ga.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:za});var r=null!=i.target?i.target:e,a=null!=i.newName?i.newName:i.name,o=null!=i.targetName?i.targetName:t,s=r==e;if(null!=i.customFunction)e[i.name]=function(){var e;return La(t,i.name,o,a,P,n),(e=i.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=i.customSetter||null!=i.customGetter){var l=null!=i.customSetter,c=null!=i.customGetter;l&&c?Object.defineProperty(e,i.name,{get:function(){return La(t,i.name,o,a,P,n),i.customGetter.call(this)},set:function(e){La(t,i.name,o,a,P,n),i.customSetter.call(this,e)}}):l?Object.defineProperty(e,i.name,{set:function(e){La(t,i.name,o,a,P,n),i.customSetter.call(this,e)}}):c&&Object.defineProperty(e,i.name,{get:function(){return La(t,i.name,o,a,P,n),i.customGetter.call(this)}})}else Object.defineProperty(e,i.name,{get:function(){return La(t,i.name,o,a,P,n),s?this[a]:r[a]},set:function(e){La(t,i.name,o,a,P,n),s?this[a]=e:r[a]=e}})}))})),Fa=function(e,t,i,n,r){var a=Ga.get(n),o=void 0===r?"":"("+r+")";a&&a.logTimes>a.count&&(i("'%s' has been removed. "+o,"".concat(e,".").concat(t)),a.count++)},Da=e("removeProperty",(function(e,t,i){null!=e&&i.forEach((function(i){var n=Ua++;Ga.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:za}),Object.defineProperty(e,i.name,{get:function(){return Fa(t,i.name,k,n,i.suggest)},set:function(){Fa(t,i.name,k,n,i.suggest)}})}))})),Na=function(e,t,i,n,r){var a=Ga.get(n),o=void 0===r?"":"("+r+")";a&&a.logTimes>a.count&&(i("'%s' is deprecated. "+o,"".concat(e,".").concat(t)),a.count++)},Ba=e("markAsWarning",(function(e,t,i){if(null!=e){var n=function(e,t,i,n,r,a){if(e.get){var o=e.get();e.get=function(){return Na(t,i,n,r,a),o.call(this)}}if(e.set){var s=Object.create(e.set);e.set=function(e){Na(t,i,n,r,a),s.call(this,e)}}};i.forEach((function(i){var r=i.name,a=Object.getOwnPropertyDescriptor(e,r);if(a){var o=Ua++;if(Ga.set(o,{id:o,count:0,logTimes:void 0!==i.logTimes?i.logTimes:za}),null!=a.value)if("function"==typeof a.value){var s=a.value;e[r]=function(){return Na(t,r,P,o,i.suggest),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else n(a,t,r,P,o,i.suggest);else n(a,t,r,P,o,i.suggest)}}))}})),ka(ia,"Vec2",[{name:"sub",newName:"subtract",target:ia,targetName:"Vec2"},{name:"mul",newName:"multiply",target:ia,targetName:"Vec2"},{name:"div",newName:"divide",target:ia,targetName:"Vec2"},{name:"dist",newName:"distance",target:ia,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:ia,targetName:"Vec2"},{name:"mag",newName:"len",target:ia,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:ia,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:ia,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:ia,targetName:"Vec2"}]),ka(ia.prototype,"Vec2",[{name:"mag",newName:"length",target:ia.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:ia.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:ia.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:ia.prototype,targetName:"Vec2"}]),Da(ia.prototype,"vmath",[{name:"divide"}]),ka(oa,"Vec3",[{name:"sub",newName:"subtract",target:oa,targetName:"Vec3"},{name:"mul",newName:"multiply",target:oa,targetName:"Vec3"},{name:"div",newName:"divide",target:oa,targetName:"Vec3"},{name:"dist",newName:"distance",target:oa,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:oa,targetName:"Vec3"},{name:"mag",newName:"len",target:oa,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:oa,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:oa,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:oa,targetName:"Vec3"}]),ka(oa.prototype,"Vec3",[{name:"mag",newName:"length",target:oa.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:oa.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:oa.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:oa.prototype,targetName:"Vec3"}]),Da(oa.prototype,"vmath",[{name:"divide"}]),ka(ua,"Vec4",[{name:"sub",newName:"subtract",target:ua,targetName:"Vec4"},{name:"mul",newName:"multiply",target:ua,targetName:"Vec4"},{name:"div",newName:"divide",target:ua,targetName:"Vec4"},{name:"dist",newName:"distance",target:ua,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:ua,targetName:"Vec4"},{name:"mag",newName:"len",target:ua,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:ua,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ua,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ua,targetName:"Vec4"}]),ka(ua.prototype,"Vec4",[{name:"mag",newName:"length",target:ua.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:ua.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:ua.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:ua.prototype,targetName:"Vec4"}]),Da(ua.prototype,"vmath",[{name:"divide"}]),ka(pa,"Quat",[{name:"mag",newName:"len",target:pa,targetName:"Quat"},{name:"mul",newName:"multiply",target:pa,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:pa,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:pa,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:pa,targetName:"Quat"}]),ka(pa.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:pa.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:pa.prototype,targetName:"Quat"}]),ka(Ma,"Color",[{name:"sub",newName:"subtract",target:Ma,targetName:"Color"},{name:"mul",newName:"multiply",target:Ma,targetName:"Color"},{name:"div",newName:"divide",target:Ma,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Ma,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[1].toString(16);return E.Color.fromHEX(t[0],n)}}]),ka(_a,"Mat3",[{name:"sub",newName:"subtract",target:_a,targetName:"Mat3"},{name:"mul",newName:"multiply",target:_a,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:_a,targetName:"Mat3"}]),ka(_a.prototype,"Mat3",[{name:"sub",newName:"subtract",target:_a.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:_a.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:_a.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:_a.prototype,targetName:"Mat3"}]),ka(Ta,"Mat4",[{name:"sub",newName:"subtract",target:Ta,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Ta,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Ta,targetName:"Mat4"}]),ka(Ta.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Ta.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Ta.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Ta.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Ta.prototype,targetName:"Mat4"}]);var Ha,Va,Wa,ja,qa,Xa,Ya,Ka,Za,Qa,Ja,$a,eo,to,io,no,ro=Object.freeze({__proto__:null,bits:ta,Vec2:ia,v2:aa,Vec3:oa,v3:ca,Vec4:ua,v4:ha,Quat:pa,quat:Sa,Mat3:_a,Mat4:Ta,mat4:Aa,AffineTransform:Ca,Size:wa,size:Ra,Rect:Ia,rect:Oa,Color:Ma,color:Pa,EPSILON:fn,equals:pn,approx:mn,clamp:vn,clamp01:gn,lerp:yn,toRadian:xn,toDegree:Sn,random:Tn,randomRange:En,randomRangeInt:bn,pseudoRandom:An,pseudoRandomRange:Cn,pseudoRandomRangeInt:wn,nextPow2:Rn,repeat:In,pingPong:On,inverseLerp:Mn,absMaxComponent:Pn,absMax:kn});e("math",ro);var ao=e("AudioSourceComponent",(Ha=ii("cc.AudioSource"),Va=mi("i18n:cc.AudioSource"),Wa=_i("Components/AudioSource"),ja=Li(br),qa=Li(br),Xa=Si("i18n:audio.clip"),Ya=Si("i18n:audio.loop"),Ka=Si("i18n:audio.playOnAwake"),Za=Ti([0,1]),Qa=Si("i18n:audio.volume"),Ha(Ja=Va(Ja=Wa((eo=S(($a=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_clip",eo,c(n)),x(n,"_loop",to,c(n)),x(n,"_playOnAwake",io,c(n)),x(n,"_volume",no,c(n)),n._cachedCurrentTime=0,n}return o(t,e),r(t,[{key:"onLoad",value:function(){this._syncStates(),this._playOnAwake&&this.play()}},{key:"onDisable",value:function(){this.pause()}},{key:"onDestroy",value:function(){this.stop()}},{key:"play",value:function(){this._clip&&(this.playing?this.currentTime=0:this._clip.play())}},{key:"pause",value:function(){this._clip&&this._clip.pause()}},{key:"stop",value:function(){this._clip&&this._clip.stop()}},{key:"playOneShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;e.playOneShot(this._volume*t)}},{key:"_syncStates",value:function(){this._clip&&(this._clip.setCurrentTime(this._cachedCurrentTime),this._clip.setLoop(this._loop),this._clip.setVolume(this._volume,!0),this._volume=this._clip.getVolume())}},{key:"clip",set:function(e){this._clip=e,this._syncStates()},get:function(){return this._clip}},{key:"loop",set:function(e){this._loop=e,this._clip&&this._clip.setLoop(e)},get:function(){return this._loop}},{key:"playOnAwake",set:function(e){this._playOnAwake=e},get:function(){return this._playOnAwake}},{key:"volume",set:function(e){isNaN(e)?console.warn("illegal audio volume!"):(e=vn(e,0,1),this._clip?(this._clip.setVolume(e),this._volume=this._clip.getVolume()):this._volume=e)},get:function(){return this._volume}},{key:"currentTime",set:function(e){isNaN(e)?console.warn("illegal audio time!"):(e=vn(e,0,this.duration),this._cachedCurrentTime=e,this._clip&&this._clip.setCurrentTime(this._cachedCurrentTime))},get:function(){return this._clip?this._clip.getCurrentTime():this._cachedCurrentTime}},{key:"duration",get:function(){return this._clip?this._clip.getDuration():0}},{key:"state",get:function(){return this._clip?this._clip.state:br.PlayingState.INITIALIZING}},{key:"playing",get:function(){return this.state===br.PlayingState.PLAYING}}]),t}(Yr)).prototype,"_clip",[ja],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),to=S($a.prototype,"_loop",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),io=S($a.prototype,"_playOnAwake",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),no=S($a.prototype,"_volume",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),S($a.prototype,"clip",[qa,Xa],Object.getOwnPropertyDescriptor($a.prototype,"clip"),$a.prototype),S($a.prototype,"loop",[Ya],Object.getOwnPropertyDescriptor($a.prototype,"loop"),$a.prototype),S($a.prototype,"playOnAwake",[Ka],Object.getOwnPropertyDescriptor($a.prototype,"playOnAwake"),$a.prototype),S($a.prototype,"volume",[Za,Qa],Object.getOwnPropertyDescriptor($a.prototype,"volume"),$a.prototype),Ja=$a))||Ja)||Ja)||Ja));E.AudioSourceComponent=ao,ze.setClassAlias(ao,"cc.AudioSourceComponent");var oo=/(\.[^\.\/\?\\]*)(\?.*)?$/,so=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,lo=/[^\.\/]+\/\.\.\//;function co(){for(var e="",t=arguments.length,i=new Array(t),n=0;n<t;n++)i[n]=arguments[n];for(var r=0,a=i;r<a.length;r++){var o=a[r];e=(e+(""===e?"":"/")+o).replace(/(\/|\\\\)$/,"")}return e}function uo(e){var t=oo.exec(e);return t?t[1]:""}function ho(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function _o(e,t){var i=e.indexOf("?");i>0&&(e=e.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!n)return"";var r=n[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function fo(e){var t=so.exec(e);return t?t[2]:""}function po(e,t){t=t||"";var i=e.indexOf("?"),n="";return i>0&&(n=e.substring(i),e=e.substring(0,i)),(i=e.lastIndexOf("."))<0?e+t+n:e.substring(0,i)+t+n}function mo(e,t,i){if(0===t.indexOf("."))return po(e,t);var n=e.indexOf("?"),r="",a=i?uo(e):"";return n>0&&(r=e.substring(n),e=e.substring(0,n)),n=(n=e.lastIndexOf("/"))<=0?0:n+1,e.substring(0,n)+t+a+r}function vo(e){var t=e=String(e);do{t=e,e=e.replace(lo,"")}while(t.length!==e.length);return e}function go(e){return e.replace(/[\/\\]$/,"")}function yo(){return E.sys.os===E.sys.OS_WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:co,extname:uo,mainFileName:ho,basename:_o,dirname:fo,changeExtname:po,changeBasename:mo,_normalize:vo,stripSep:go,getSeperator:yo})),E.log=M,E.warn=P,E.error=k,E.assert=D,E._throw=L,E.logID=z,E.warnID=G,E.errorID=V,E.assertID=q,E.debug=Z,E.path={join:co,extname:uo,mainFileName:ho,basename:_o,dirname:fo,changeExtname:po,changeBasename:mo,_normalize:vo,stripSep:go,get sep(){return yo()}};var xo={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},So=new oa,To=new oa,Eo=new oa,bo=new oa,Ao=new oa,Co=new oa,wo=new Array(3),Ro=new Array(3);function Io(e,t){return oa.dot(t.n,e)-t.d}function Oo(e,t,i){return oa.copy(e,t),oa.subtract(Ao,i.center,i.halfExtents),oa.add(Co,i.center,i.halfExtents),e.x=e.x<Ao.x?Ao.x:e.x,e.y=e.y<Ao.x?Ao.y:e.y,e.z=e.z<Ao.x?Ao.z:e.z,e.x=e.x>Co.x?Co.x:e.x,e.y=e.y>Co.x?Co.y:e.y,e.z=e.z>Co.x?Co.z:e.z,e}function Mo(e,t,i){oa.set(So,i.orientation.m00,i.orientation.m01,i.orientation.m02),oa.set(To,i.orientation.m03,i.orientation.m04,i.orientation.m05),oa.set(Eo,i.orientation.m06,i.orientation.m07,i.orientation.m08),wo[0]=So,wo[1]=To,wo[2]=Eo,Ro[0]=i.halfExtents.x,Ro[1]=i.halfExtents.y,Ro[2]=i.halfExtents.z,oa.subtract(bo,t,i.center),oa.set(e,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=oa.dot(bo,wo[n]);r>Ro[n]&&(r=Ro[n]),r<-Ro[n]&&(r=-Ro[n]),e.x+=r*wo[n].x,e.y+=r*wo[n].y,e.z+=r*wo[n].z}return e}var Po=Object.freeze({__proto__:null,point_plane:Io,pt_point_plane:function(e,t,i){var n=Io(t,i);return oa.subtract(e,t,oa.multiplyScalar(e,i.n,n))},pt_point_aabb:Oo,pt_point_obb:Mo,pt_point_line:function(e,t,i,n){oa.subtract(So,i,n);var r=So,a=oa.lengthSqr(r);if(0==a)oa.copy(e,i);else{oa.subtract(So,t,i);var o=oa.dot(So,r)/a;o<0?oa.copy(e,i):o>1?oa.copy(e,n):oa.scaleAndAdd(e,i,r,o)}}}),ko=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;i(this,e),this.o=void 0,this.d=void 0,this._type=void 0,this._type=xo.SHAPE_RAY,this.o=new oa(t,n,r),this.d=new oa(a,o,s)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;return new e(t,i,n,r,a,o)}},{key:"clone",value:function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}},{key:"copy",value:function(e,t){return oa.copy(e.o,t.o),oa.copy(e.d,t.d),e}},{key:"fromPoints",value:function(e,t,i){return oa.copy(e.o,t),oa.normalize(e.d,oa.subtract(e.d,i,t)),e}},{key:"set",value:function(e,t,i,n,r,a,o){return e.o.x=t,e.o.y=i,e.o.z=n,e.d.x=r,e.d.y=a,e.d.z=o,e}}]),r(e,[{key:"computeHit",value:function(e,t){oa.normalize(e,this.d),oa.scaleAndAdd(e,this.o,e,t)}}]),e}(),Do=new oa,Bo=new oa,Lo=new oa,No=new oa;function Fo(e){return Math.max(Math.max(e.x,e.y),e.z)}var zo,Uo=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;i(this,e),this.center=void 0,this.radius=void 0,this._type=void 0,this._type=xo.SHAPE_SPHERE,this.center=new oa(t,n,r),this.radius=a}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r){return new e(t,i,n,r)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)}},{key:"copy",value:function(e,t){return oa.copy(e.center,t.center),e.radius=t.radius,e}},{key:"fromPoints",value:function(e,t,i){return oa.multiplyScalar(e.center,oa.add(Do,t,i),.5),e.radius=.5*oa.subtract(Do,i,t).length(),e}},{key:"set",value:function(e,t,i,n,r){return e.center.x=t,e.center.y=i,e.center.z=n,e.radius=r,e}},{key:"mergePoint",value:function(e,t,i){if(t.radius<0)return e.center=i,e.radius=0,e;oa.subtract(Bo,i,t.center);var n=Bo.length();if(n>t.radius){var r=.5*(n-t.radius);e.radius+=r,oa.multiplyScalar(Bo,Bo,r/n),oa.add(e.center,e.center,Bo)}return e}},{key:"mergeAABB",value:function(t,i,n){return n.getBoundary(Lo,No),e.mergePoint(t,i,Lo),e.mergePoint(t,i,No),t}}]),r(e,[{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}},{key:"getBoundary",value:function(e,t){oa.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),oa.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}},{key:"transform",value:function(e,t,i,n,r){oa.transformMat4(r.center,this.center,e),r.radius=this.radius*Fo(n)}},{key:"translateAndRotate",value:function(e,t,i){oa.transformMat4(i.center,this.center,e)}},{key:"setScale",value:function(e,t){t.radius=this.radius*Fo(e)}}]),e}(),Go=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0;i(this,e),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=xo.SHAPE_TRIANGLE,this.a=new oa(t,n,r),this.b=new oa(a,o,s),this.c=new oa(l,c,u)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:1;return new e(t,i,n,r,a,o,s,l,c)}},{key:"clone",value:function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}},{key:"copy",value:function(e,t){return oa.copy(e.a,t.a),oa.copy(e.b,t.b),oa.copy(e.c,t.c),e}},{key:"fromPoints",value:function(e,t,i,n){return oa.copy(e.a,t),oa.copy(e.b,i),oa.copy(e.c,n),e}},{key:"set",value:function(e,t,i,n,r,a,o,s,l,c){return e.a.x=t,e.a.y=i,e.a.z=n,e.b.x=r,e.b.y=a,e.b.z=o,e.c.x=s,e.c.y=l,e.c.z=c,e}}]),e}(),Ho=e("GFX_MAX_ATTACHMENTS",4);!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BUFFER=1]="BUFFER",e[e.TEXTURE=2]="TEXTURE",e[e.RENDER_PASS=3]="RENDER_PASS",e[e.FRAMEBUFFER=4]="FRAMEBUFFER",e[e.SAMPLER=5]="SAMPLER",e[e.SHADER=6]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=9]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=12]="COMMAND_BUFFER",e[e.FENCE=13]="FENCE",e[e.QUEUE=14]="QUEUE",e[e.WINDOW=15]="WINDOW"}(zo||(zo=e("GFXObjectType",{})));var Vo,Wo,jo,qo,Xo,Yo,Ko,Zo,Qo,Jo,$o,es,ts,is,ns,rs,as,os,ss,ls,cs,us,hs,_s,ds,fs,ps,ms,vs,gs,ys,xs,Ss=e("GFXObject",function(){function e(t){i(this,e),this._gfxType=zo.UNKNOWN,this._gfxType=t}return r(e,[{key:"gfxType",get:function(){return this._gfxType}}]),e}());!function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(Vo||(Vo=e("GFXAttributeName",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.COUNT=32]="COUNT"}(Wo||(Wo=e("GFXType",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.D16=54]="D16",e[e.D16S8=55]="D16S8",e[e.D24=56]="D24",e[e.D24S8=57]="D24S8",e[e.D32F=58]="D32F",e[e.D32F_S8=59]="D32F_S8",e[e.BC1=60]="BC1",e[e.BC1_ALPHA=61]="BC1_ALPHA",e[e.BC1_SRGB=62]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",e[e.BC2=64]="BC2",e[e.BC2_SRGB=65]="BC2_SRGB",e[e.BC3=66]="BC3",e[e.BC3_SRGB=67]="BC3_SRGB",e[e.BC4=68]="BC4",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5=70]="BC5",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.BC6H_UF16=72]="BC6H_UF16",e[e.BC6H_SF16=73]="BC6H_SF16",e[e.BC7=74]="BC7",e[e.BC7_SRGB=75]="BC7_SRGB",e[e.ETC_RGB8=76]="ETC_RGB8",e[e.ETC2_RGB8=77]="ETC2_RGB8",e[e.ETC2_SRGB8=78]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=81]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",e[e.EAC_R11=83]="EAC_R11",e[e.EAC_R11SN=84]="EAC_R11SN",e[e.EAC_RG11=85]="EAC_RG11",e[e.EAC_RG11SN=86]="EAC_RG11SN",e[e.PVRTC_RGB2=87]="PVRTC_RGB2",e[e.PVRTC_RGBA2=88]="PVRTC_RGBA2",e[e.PVRTC_RGB4=89]="PVRTC_RGB4",e[e.PVRTC_RGBA4=90]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=91]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=92]="PVRTC2_4BPP",e[e.ASTC_RGBA_4x4=93]="ASTC_RGBA_4x4",e[e.ASTC_RGBA_5x4=94]="ASTC_RGBA_5x4",e[e.ASTC_RGBA_5x5=95]="ASTC_RGBA_5x5",e[e.ASTC_RGBA_6x5=96]="ASTC_RGBA_6x5",e[e.ASTC_RGBA_6x6=97]="ASTC_RGBA_6x6",e[e.ASTC_RGBA_8x5=98]="ASTC_RGBA_8x5",e[e.ASTC_RGBA_8x6=99]="ASTC_RGBA_8x6",e[e.ASTC_RGBA_8x8=100]="ASTC_RGBA_8x8",e[e.ASTC_RGBA_10x5=101]="ASTC_RGBA_10x5",e[e.ASTC_RGBA_10x6=102]="ASTC_RGBA_10x6",e[e.ASTC_RGBA_10x8=103]="ASTC_RGBA_10x8",e[e.ASTC_RGBA_10x10=104]="ASTC_RGBA_10x10",e[e.ASTC_RGBA_12x10=105]="ASTC_RGBA_12x10",e[e.ASTC_RGBA_12x12=106]="ASTC_RGBA_12x12",e[e.ASTC_SRGBA_4x4=107]="ASTC_SRGBA_4x4",e[e.ASTC_SRGBA_5x4=108]="ASTC_SRGBA_5x4",e[e.ASTC_SRGBA_5x5=109]="ASTC_SRGBA_5x5",e[e.ASTC_SRGBA_6x5=110]="ASTC_SRGBA_6x5",e[e.ASTC_SRGBA_6x6=111]="ASTC_SRGBA_6x6",e[e.ASTC_SRGBA_8x5=112]="ASTC_SRGBA_8x5",e[e.ASTC_SRGBA_8x6=113]="ASTC_SRGBA_8x6",e[e.ASTC_SRGBA_8x8=114]="ASTC_SRGBA_8x8",e[e.ASTC_SRGBA_10x5=115]="ASTC_SRGBA_10x5",e[e.ASTC_SRGBA_10x6=116]="ASTC_SRGBA_10x6",e[e.ASTC_SRGBA_10x8=117]="ASTC_SRGBA_10x8",e[e.ASTC_SRGBA_10x10=118]="ASTC_SRGBA_10x10",e[e.ASTC_SRGBA_12x10=119]="ASTC_SRGBA_12x10",e[e.ASTC_SRGBA_12x12=120]="ASTC_SRGBA_12x12"}(jo||(jo=e("GFXFormat",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(qo||(qo=e("GFXBufferUsageBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(Xo||(Xo=e("GFXMemoryUsageBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(Yo||(Yo=e("GFXBufferFlagBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.READ=1]="READ",e[e.WRITE=2]="WRITE"}(Ko||(Ko=e("GFXBufferAccessBit",{}))),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Zo||(Zo=e("GFXPrimitiveMode",{}))),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Qo||(Qo=e("GFXPolygonMode",{}))),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Jo||(Jo=e("GFXShadeModel",{}))),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}($o||($o=e("GFXCullMode",{}))),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(es||(es=e("GFXComparisonFunc",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(ts||(ts=e("GFXStencilOp",{}))),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(is||(is=e("GFXBlendOp",{}))),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(ns||(ns=e("GFXBlendFactor",{}))),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(rs||(rs=e("GFXColorMask",{}))),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(as||(as=e("GFXFilter",{}))),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(os||(os=e("GFXAddress",{}))),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(ss||(ss=e("GFXTextureType",{}))),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",e[e.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(ls||(ls=e("GFXTextureUsageBit",{}))),function(e){e[e.X1=0]="X1",e[e.X2=1]="X2",e[e.X4=2]="X4",e[e.X8=3]="X8",e[e.X16=4]="X16",e[e.X32=5]="X32",e[e.X64=6]="X64"}(cs||(cs=e("GFXSampleCount",{}))),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.CUBEMAP=2]="CUBEMAP",e[e.BAKUP_BUFFER=4]="BAKUP_BUFFER"}(us||(us=e("GFXTextureFlagBit",{}))),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(hs||(hs=e("GFXShaderStageFlagBit",{}))),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER=16]="SAMPLER"}(_s||(_s=e("GFXDescriptorType",{}))),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(ds||(ds=e("GFXCommandBufferType",{}))),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(fs||(fs=e("GFXLoadOp",{}))),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(ps||(ps=e("GFXStoreOp",{}))),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.GENERAL=1]="GENERAL",e[e.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",e[e.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",e[e.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",e[e.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",e[e.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",e[e.PREINITIALIZED=8]="PREINITIALIZED",e[e.PRESENT_SRC=9]="PRESENT_SRC"}(ms||(ms=e("GFXTextureLayout",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(vs||(vs=e("GFXPipelineBindPoint",{}))),function(e){e[e.NONE=0]="NONE",e[e.VIEWPORT=1]="VIEWPORT",e[e.SCISSOR=2]="SCISSOR",e[e.LINE_WIDTH=4]="LINE_WIDTH",e[e.DEPTH_BIAS=8]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(gs||(gs=e("GFXDynamicStateFlagBit",{}))),function(e){e[e.FRONT=0]="FRONT",e[e.BACK=1]="BACK",e[e.ALL=2]="ALL"}(ys||(ys=e("GFXStencilFace",{}))),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(xs||(xs=e("GFXQueueType",{})));var Ts,Es=e("GFXRect",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;i(this,e),this.x=t,this.y=n,this.width=r,this.height=a})),bs=e("GFXViewport",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;i(this,e),this.left=t,this.top=n,this.width=r,this.height=a,this.minDepth=o,this.maxDepth=s})),As=e("GFXColor",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(this,e),this.x=t,this.y=n,this.z=r,this.w=a}));!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Ts||(Ts=e("GFXClearFlag",{})));var Cs,ws=e("GFXOffset",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;i(this,e),this.x=t,this.y=n,this.z=r})),Rs=e("GFXExtent",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;i(this,e),this.width=t,this.height=n,this.depth=r})),Is=e("GFXTextureSubres",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;i(this,e),this.mipLevel=t,this.baseArrayLayer=n,this.layerCount=r})),Os=e("GFXTextureCopy",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Is,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new ws,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Is,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new ws,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Rs;i(this,e),this.srcSubres=t,this.srcOffset=n,this.dstSubres=r,this.dstOffset=a,this.extent=o})),Ms=e("GFXBufferTextureCopy",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new ws,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new Rs,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Is;i(this,e),this.buffStride=t,this.buffTexHeight=n,this.texOffset=r,this.texExtent=a,this.texSubres=o}));!function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(Cs||(Cs=e("GFXFormatType",{})));var Ps=e("GFXFormatInfo",(function e(t,n,r,a,o,s,l,c){i(this,e),this.name=t,this.size=n,this.count=r,this.type=a,this.hasAlpha=o,this.hasDepth=s,this.hasStencil=l,this.isCompressed=c})),ks=e("GFXMemoryStatus",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,e),this.bufferSize=t,this.textureSize=n})),Ds=e("GFXFormatInfos",Object.freeze([new Ps("UNKNOWN",0,0,Cs.NONE,!1,!1,!1,!1),new Ps("A8",1,1,Cs.UNORM,!0,!1,!1,!1),new Ps("L8",1,1,Cs.UNORM,!1,!1,!1,!1),new Ps("LA8",1,2,Cs.UNORM,!0,!1,!1,!1),new Ps("R8",1,1,Cs.UNORM,!1,!1,!1,!1),new Ps("R8SN",1,1,Cs.SNORM,!1,!1,!1,!1),new Ps("R8UI",1,1,Cs.UINT,!1,!1,!1,!1),new Ps("R8I",1,1,Cs.INT,!1,!1,!1,!1),new Ps("R16F",2,1,Cs.FLOAT,!1,!1,!1,!1),new Ps("R16UI",2,1,Cs.UINT,!1,!1,!1,!1),new Ps("R16I",2,1,Cs.INT,!1,!1,!1,!1),new Ps("R32F",4,1,Cs.FLOAT,!1,!1,!1,!1),new Ps("R32UI",4,1,Cs.UINT,!1,!1,!1,!1),new Ps("R32I",4,1,Cs.INT,!1,!1,!1,!1),new Ps("RG8",2,2,Cs.UNORM,!1,!1,!1,!1),new Ps("RG8SN",2,2,Cs.SNORM,!1,!1,!1,!1),new Ps("RG8UI",2,2,Cs.UINT,!1,!1,!1,!1),new Ps("RG8I",2,2,Cs.INT,!1,!1,!1,!1),new Ps("RG16F",4,2,Cs.FLOAT,!1,!1,!1,!1),new Ps("RG16UI",4,2,Cs.UINT,!1,!1,!1,!1),new Ps("RG16I",4,2,Cs.INT,!1,!1,!1,!1),new Ps("RG32F",8,2,Cs.FLOAT,!1,!1,!1,!1),new Ps("RG32UI",8,2,Cs.UINT,!1,!1,!1,!1),new Ps("RG32I",8,2,Cs.INT,!1,!1,!1,!1),new Ps("RGB8",3,3,Cs.UNORM,!1,!1,!1,!1),new Ps("SRGB8",3,3,Cs.UNORM,!1,!1,!1,!1),new Ps("RGB8SN",3,3,Cs.SNORM,!1,!1,!1,!1),new Ps("RGB8UI",3,3,Cs.UINT,!1,!1,!1,!1),new Ps("RGB8I",3,3,Cs.INT,!1,!1,!1,!1),new Ps("RGB16F",6,3,Cs.FLOAT,!1,!1,!1,!1),new Ps("RGB16UI",6,3,Cs.UINT,!1,!1,!1,!1),new Ps("RGB16I",6,3,Cs.INT,!1,!1,!1,!1),new Ps("RGB32F",12,3,Cs.FLOAT,!1,!1,!1,!1),new Ps("RGB32UI",12,3,Cs.UINT,!1,!1,!1,!1),new Ps("RGB32I",12,3,Cs.INT,!1,!1,!1,!1),new Ps("RGBA8",4,4,Cs.UNORM,!0,!1,!1,!1),new Ps("BGRA8",4,4,Cs.UNORM,!0,!1,!1,!1),new Ps("SRGB8_A8",4,4,Cs.UNORM,!0,!1,!1,!1),new Ps("RGBA8SN",4,4,Cs.SNORM,!0,!1,!1,!1),new Ps("RGBA8UI",4,4,Cs.UINT,!0,!1,!1,!1),new Ps("RGBA8I",4,4,Cs.INT,!0,!1,!1,!1),new Ps("RGBA16F",8,4,Cs.FLOAT,!0,!1,!1,!1),new Ps("RGBA16UI",8,4,Cs.UINT,!0,!1,!1,!1),new Ps("RGBA16I",8,4,Cs.INT,!0,!1,!1,!1),new Ps("RGBA32F",16,4,Cs.FLOAT,!0,!1,!1,!1),new Ps("RGBA32UI",16,4,Cs.UINT,!0,!1,!1,!1),new Ps("RGBA32I",16,4,Cs.INT,!0,!1,!1,!1),new Ps("R5G6B5",2,3,Cs.UNORM,!1,!1,!1,!1),new Ps("R11G11B10F",4,3,Cs.FLOAT,!1,!1,!1,!1),new Ps("RGB5A1",2,4,Cs.UNORM,!0,!1,!1,!1),new Ps("RGBA4",2,4,Cs.UNORM,!0,!1,!1,!1),new Ps("RGB10A2",2,4,Cs.UNORM,!0,!1,!1,!1),new Ps("RGB10A2UI",2,4,Cs.UINT,!0,!1,!1,!1),new Ps("RGB9E5",2,4,Cs.FLOAT,!0,!1,!1,!1),new Ps("D16",2,1,Cs.UINT,!1,!0,!1,!1),new Ps("D16S8",3,2,Cs.UINT,!1,!0,!0,!1),new Ps("D24",3,1,Cs.UINT,!1,!0,!1,!1),new Ps("D24S8",4,2,Cs.UINT,!1,!0,!0,!1),new Ps("D32F",4,1,Cs.FLOAT,!1,!0,!1,!1),new Ps("D32FS8",5,2,Cs.FLOAT,!1,!0,!0,!1),new Ps("BC1",1,3,Cs.UNORM,!1,!1,!1,!0),new Ps("BC1_ALPHA",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("BC1_SRGB",1,3,Cs.UNORM,!1,!1,!1,!0),new Ps("BC1_SRGB_ALPHA",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("BC2",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("BC2_SRGB",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("BC3",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("BC3_SRGB",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("BC4",1,1,Cs.UNORM,!1,!1,!1,!0),new Ps("BC4_SNORM",1,1,Cs.SNORM,!1,!1,!1,!0),new Ps("BC5",1,2,Cs.UNORM,!1,!1,!1,!0),new Ps("BC5_SNORM",1,2,Cs.SNORM,!1,!1,!1,!0),new Ps("BC6H_UF16",1,3,Cs.UFLOAT,!1,!1,!1,!0),new Ps("BC6H_SF16",1,3,Cs.FLOAT,!1,!1,!1,!0),new Ps("BC7",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("BC7_SRGB",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ETC_RGB8",1,3,Cs.UNORM,!1,!1,!1,!0),new Ps("ETC2_RGB8",1,3,Cs.UNORM,!1,!1,!1,!0),new Ps("ETC2_SRGB8",1,3,Cs.UNORM,!1,!1,!1,!0),new Ps("ETC2_RGB8_A1",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ETC2_SRGB8_A1",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ETC2_RGBA8",2,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ETC2_SRGB8_A8",2,4,Cs.UNORM,!0,!1,!1,!0),new Ps("EAC_R11",1,1,Cs.UNORM,!1,!1,!1,!0),new Ps("EAC_R11SN",1,1,Cs.SNORM,!1,!1,!1,!0),new Ps("EAC_RG11",2,2,Cs.UNORM,!1,!1,!1,!0),new Ps("EAC_RG11SN",2,2,Cs.SNORM,!1,!1,!1,!0),new Ps("PVRTC_RGB2",2,3,Cs.UNORM,!1,!1,!1,!0),new Ps("PVRTC_RGBA2",2,4,Cs.UNORM,!0,!1,!1,!0),new Ps("PVRTC_RGB4",2,3,Cs.UNORM,!1,!1,!1,!0),new Ps("PVRTC_RGBA4",2,4,Cs.UNORM,!0,!1,!1,!0),new Ps("PVRTC2_2BPP",2,4,Cs.UNORM,!0,!1,!1,!0),new Ps("PVRTC2_4BPP",2,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_4x4",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_5x4",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_5x5",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_6x5",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_6x6",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_8x5",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_8x6",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_8x8",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_10x5",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_10x6",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_10x8",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_10x10",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_12x10",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_RGBA_12x12",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_4x4",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_5x4",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_5x5",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_6x5",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_6x6",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_8x5",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_8x6",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_8x8",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_10x5",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_10x6",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_10x8",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_10x10",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_12x10",1,4,Cs.UNORM,!0,!1,!1,!0),new Ps("ASTC_SRGBA_12x12",1,4,Cs.UNORM,!0,!1,!1,!0)]));function Bs(e,t,i,n){if(!Ds[e].isCompressed)return t*i*n*Ds[e].size;switch(e){case jo.BC1:case jo.BC1_ALPHA:case jo.BC1_SRGB:case jo.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case jo.BC2:case jo.BC2_SRGB:case jo.BC3:case jo.BC3_SRGB:case jo.BC4:case jo.BC4_SNORM:case jo.BC6H_SF16:case jo.BC6H_UF16:case jo.BC7:case jo.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case jo.BC5:case jo.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(i/4)*32*n;case jo.ETC_RGB8:case jo.ETC2_RGB8:case jo.ETC2_SRGB8:case jo.ETC2_RGB8_A1:case jo.EAC_R11:case jo.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(i/4)*8*n;case jo.ETC2_RGBA8:case jo.ETC2_SRGB8_A1:case jo.EAC_RG11:case jo.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case jo.PVRTC_RGB2:case jo.PVRTC_RGBA2:case jo.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(i,8)/4)*n;case jo.PVRTC_RGB4:case jo.PVRTC_RGBA4:case jo.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(i,8)/2)*n;case jo.ASTC_RGBA_4x4:case jo.ASTC_SRGBA_4x4:return Math.ceil(t/4)*Math.ceil(i/4)*16*n;case jo.ASTC_RGBA_5x4:case jo.ASTC_SRGBA_5x4:return Math.ceil(t/5)*Math.ceil(i/4)*16*n;case jo.ASTC_RGBA_5x5:case jo.ASTC_SRGBA_5x5:return Math.ceil(t/5)*Math.ceil(i/5)*16*n;case jo.ASTC_RGBA_6x5:case jo.ASTC_SRGBA_6x5:return Math.ceil(t/6)*Math.ceil(i/5)*16*n;case jo.ASTC_RGBA_6x6:case jo.ASTC_SRGBA_6x6:return Math.ceil(t/6)*Math.ceil(i/6)*16*n;case jo.ASTC_RGBA_8x5:case jo.ASTC_SRGBA_8x5:return Math.ceil(t/8)*Math.ceil(i/5)*16*n;case jo.ASTC_RGBA_8x6:case jo.ASTC_SRGBA_8x6:return Math.ceil(t/8)*Math.ceil(i/6)*16*n;case jo.ASTC_RGBA_8x8:case jo.ASTC_SRGBA_8x8:return Math.ceil(t/8)*Math.ceil(i/8)*16*n;case jo.ASTC_RGBA_10x5:case jo.ASTC_SRGBA_10x5:return Math.ceil(t/10)*Math.ceil(i/5)*16*n;case jo.ASTC_RGBA_10x6:case jo.ASTC_SRGBA_10x6:return Math.ceil(t/10)*Math.ceil(i/6)*16*n;case jo.ASTC_RGBA_10x8:case jo.ASTC_SRGBA_10x8:return Math.ceil(t/10)*Math.ceil(i/8)*16*n;case jo.ASTC_RGBA_10x10:case jo.ASTC_SRGBA_10x10:return Math.ceil(t/10)*Math.ceil(i/10)*16*n;case jo.ASTC_RGBA_12x10:case jo.ASTC_SRGBA_12x10:return Math.ceil(t/12)*Math.ceil(i/10)*16*n;case jo.ASTC_RGBA_12x12:case jo.ASTC_SRGBA_12x12:return Math.ceil(t/12)*Math.ceil(i/12)*16*n;default:return 0}}function Ls(e,t,i,n,r){for(var a=0,o=0;o<r;++o)a+=Bs(e,t,i,n),t=Math.max(t>>1,1),i=Math.max(i>>1,1);return a}var Ns=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Fs(e){return Ns[e]||0}function zs(e){var t=e.size/e.count;switch(e.type){case Cs.UNORM:case Cs.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Cs.SNORM:case Cs.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Cs.FLOAT:return Float32Array}return Float32Array}var Us,Gs,Hs=Object.freeze({__proto__:null,GFX_MAX_ATTACHMENTS:Ho,get GFXObjectType(){return zo},GFXObject:Ss,get GFXAttributeName(){return Vo},get GFXType(){return Wo},get GFXFormat(){return jo},get GFXBufferUsageBit(){return qo},get GFXMemoryUsageBit(){return Xo},get GFXBufferFlagBit(){return Yo},get GFXBufferAccessBit(){return Ko},get GFXPrimitiveMode(){return Zo},get GFXPolygonMode(){return Qo},get GFXShadeModel(){return Jo},get GFXCullMode(){return $o},get GFXComparisonFunc(){return es},get GFXStencilOp(){return ts},get GFXBlendOp(){return is},get GFXBlendFactor(){return ns},get GFXColorMask(){return rs},get GFXFilter(){return as},get GFXAddress(){return os},get GFXTextureType(){return ss},get GFXTextureUsageBit(){return ls},get GFXSampleCount(){return cs},get GFXTextureFlagBit(){return us},get GFXShaderStageFlagBit(){return hs},get GFXDescriptorType(){return _s},get GFXCommandBufferType(){return ds},get GFXLoadOp(){return fs},get GFXStoreOp(){return ps},get GFXTextureLayout(){return ms},get GFXPipelineBindPoint(){return vs},get GFXDynamicStateFlagBit(){return gs},get GFXStencilFace(){return ys},get GFXQueueType(){return xs},GFXRect:Es,GFXViewport:bs,GFXColor:As,get GFXClearFlag(){return Ts},GFXOffset:ws,GFXExtent:Rs,GFXTextureSubres:Is,GFXTextureCopy:Os,GFXBufferTextureCopy:Ms,get GFXFormatType(){return Cs},GFXFormatInfo:Ps,GFXMemoryStatus:ks,GFXFormatInfos:Ds,GFXFormatSize:Bs,GFXFormatSurfaceSize:Ls,GFXGetTypeSize:Fs,getTypedArrayConstructor:zs}),Vs=e("GFXDrawInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;i(this,e),this.vertexCount=t,this.firstVertex=n,this.indexCount=r,this.firstIndex=a,this.vertexOffset=o,this.instanceCount=s,this.firstInstance=l})),Ws=e("GFX_DRAW_INFO_SIZE",28),js=e("GFXIndirectBuffer",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];i(this,e),this.drawInfos=t})),qs=e("GFXBufferInfo",(function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Yo.NONE;i(this,e),this.usage=t,this.memUsage=n,this.size=r,this.stride=a,this.flags=o})),Xs=e("GFXBufferViewInfo",(function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;i(this,e),this.buffer=t,this.offset=n,this.range=r})),Ys=e("GFXBuffer",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.BUFFER)))._device=void 0,n._usage=qo.NONE,n._memUsage=Xo.NONE,n._size=0,n._stride=1,n._count=0,n._flags=Yo.NONE,n._bakcupBuffer=null,n._indirectBuffer=null,n._isBufferView=!1,n._device=e,n}return o(t,e),r(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}},{key:"backupBuffer",get:function(){return this._bakcupBuffer}}]),t}(Ss)),Ks=e("GFXCommandBufferInfo",(function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ds.PRIMARY;i(this,e),this.queue=t,this.type=n})),Zs=e("GFXCommandBuffer",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.COMMAND_BUFFER)))._device=void 0,n._queue=null,n._type=ds.PRIMARY,n._numDrawCalls=0,n._numInstances=0,n._numTris=0,n._device=e,n}return o(t,e),r(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(Ss));nt(jo),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GL=1]="GL",e[e.GLES2=2]="GLES2",e[e.GLES3=3]="GLES3",e[e.METAL=4]="METAL",e[e.VULKAN=5]="VULKAN",e[e.DX12=6]="DX12",e[e.WEBGL=7]="WEBGL",e[e.WEBGL2=8]="WEBGL2"}(Us||(Us=e("GFXAPI",{}))),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_D16=7]="FORMAT_D16",e[e.FORMAT_D16S8=8]="FORMAT_D16S8",e[e.FORMAT_D24=9]="FORMAT_D24",e[e.FORMAT_D24S8=10]="FORMAT_D24S8",e[e.FORMAT_D32F=11]="FORMAT_D32F",e[e.FORMAT_D32FS8=12]="FORMAT_D32FS8",e[e.FORMAT_ETC1=13]="FORMAT_ETC1",e[e.FORMAT_ETC2=14]="FORMAT_ETC2",e[e.FORMAT_DXT=15]="FORMAT_DXT",e[e.FORMAT_PVRTC=16]="FORMAT_PVRTC",e[e.FORMAT_ASTC=17]="FORMAT_ASTC",e[e.FORMAT_RGB8=18]="FORMAT_RGB8",e[e.MSAA=19]="MSAA",e[e.ELEMENT_INDEX_UINT=20]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=21]="INSTANCED_ARRAYS",e[e.COUNT=22]="COUNT"}(Gs||(Gs=e("GFXFeature",{})));var Qs=e("GFXBindingMappingInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;i(this,e),this.bufferOffsets=t,this.samplerOffsets=n,this.flexibleSet=r})),Js=e("GFXDeviceInfo",(function e(t){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:new Qs;i(this,e),this.canvasElm=t,this.isAntialias=n,this.isPremultipliedAlpha=r,this.devicePixelRatio=a,this.nativeWidth=o,this.nativeHeight=s,this.bindingMappingInfo=l})),$s=e("GFXDevice",function(){function e(){i(this,e),this._canvas=null,this._canvas2D=null,this._gfxAPI=Us.UNKNOWN,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(Gs.COUNT),this._queue=null,this._cmdBuff=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=0,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._uboOffsetAlignment=1,this._depthBits=0,this._stencilBits=0,this._colorFmt=jo.UNKNOWN,this._depthStencilFmt=jo.UNKNOWN,this._macros=new Map,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new ks,this._clipSpaceMinZ=-1,this._screenSpaceSignY=1,this._UVSpaceSignY=-1}return r(e,[{key:"hasFeature",value:function(e){return this._features[e]}},{key:"canvas",get:function(){return this._canvas}},{key:"canvas2D",get:function(){return this._canvas2D}},{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"devicePixelRatio",get:function(){return this._devicePixelRatio}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"nativeWidth",get:function(){return this._nativeWidth}},{key:"nativeHeight",get:function(){return this._nativeHeight}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"maxVertexAttributes",get:function(){return this._maxVertexAttributes}},{key:"maxVertexUniformVectors",get:function(){return this._maxVertexUniformVectors}},{key:"maxFragmentUniformVectors",get:function(){return this._maxFragmentUniformVectors}},{key:"maxTextureUnits",get:function(){return this._maxTextureUnits}},{key:"maxVertexTextureUnits",get:function(){return this._maxVertexTextureUnits}},{key:"maxUniformBufferBindings",get:function(){return this._maxUniformBufferBindings}},{key:"maxUniformBlockSize",get:function(){return this._maxUniformBlockSize}},{key:"maxTextureSize",get:function(){return this._maxTextureSize}},{key:"maxCubeMapTextureSize",get:function(){return this._maxCubeMapTextureSize}},{key:"uboOffsetAlignment",get:function(){return this._uboOffsetAlignment}},{key:"depthBits",get:function(){return this._depthBits}},{key:"stencilBits",get:function(){return this._stencilBits}},{key:"colorFormat",get:function(){return this._colorFmt}},{key:"depthStencilFormat",get:function(){return this._depthStencilFmt}},{key:"macros",get:function(){return this._macros}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"clipSpaceMinZ",get:function(){return this._clipSpaceMinZ}},{key:"screenSpaceSignY",get:function(){return this._screenSpaceSignY}},{key:"UVSpaceSignY",get:function(){return this._UVSpaceSignY}}]),e}()),el=e("GFXFramebufferInfo",(function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;i(this,e),this.renderPass=t,this.colorTextures=n,this.depthStencilTexture=r,this.colorMipmapLevels=a,this.depStencilMipmapLevel=o})),tl=e("GFXFramebuffer",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.FRAMEBUFFER)))._device=void 0,n._renderPass=null,n._colorTextures=[],n._depthStencilTexture=null,n._device=e,n}return o(t,e),r(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(Ss)),il=String.prototype.charCodeAt;function nl(e){return this[e]}function rl(e,t){for(var i=e.length,n=t^i,r=0,a="string"==typeof e?il:nl;i>=4;){var o=255&a.call(e,r)|(255&a.call(e,++r))<<8|(255&a.call(e,++r))<<16|(255&a.call(e,++r))<<24;o=1540483477*(65535&o)+((1540483477*(o>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(o=1540483477*(65535&(o^=o>>>24))+((1540483477*(o>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&a.call(e,r+2))<<16;case 2:n^=(255&a.call(e,r+1))<<8;case 1:n=1540483477*(65535&(n^=255&a.call(e,r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}var al=e("GFXAttribute",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:jo.UNKNOWN,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;i(this,e),this.name=t,this.format=n,this.isNormalized=r,this.stream=a,this.isInstanced=o,this.location=s})),ol=e("GFXInputAssemblerInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;i(this,e),this.attributes=t,this.vertexBuffers=n,this.indexBuffer=r,this.indirectBuffer=a})),sl=e("GFXInputAssembler",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.INPUT_ASSEMBLER)))._device=void 0,n._attributes=[],n._vertexBuffers=[],n._indexBuffer=null,n._vertexCount=0,n._firstVertex=0,n._indexCount=0,n._firstIndex=0,n._vertexOffset=0,n._instanceCount=0,n._firstInstance=0,n._attributesHash=0,n._indirectBuffer=null,n._device=e,n}return o(t,e),r(t,[{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"attributes",get:function(){return this._attributes}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._vertexCount},set:function(e){this._vertexCount=e}},{key:"firstVertex",get:function(){return this._firstVertex},set:function(e){this._firstVertex=e}},{key:"indexCount",get:function(){return this._indexCount},set:function(e){this._indexCount=e}},{key:"firstIndex",get:function(){return this._firstIndex},set:function(e){this._firstIndex=e}},{key:"vertexOffset",get:function(){return this._vertexOffset},set:function(e){this._vertexOffset=e}},{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"firstInstance",get:function(){return this._firstInstance},set:function(e){this._firstInstance=e}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}}]),r(t,[{key:"getVertexBuffer",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return e<this._vertexBuffers.length?this._vertexBuffers[e]:null}},{key:"computeAttributesHash",value:function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var i=this.attributes[t];e+=",".concat(i.name,",").concat(i.format,",").concat(i.isNormalized,",").concat(i.stream,",").concat(i.isInstanced)}return rl(e,666)}}]),t}(Ss)),ll=e("GFXRasterizerState",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Qo.FILL,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Jo.GOURAND,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:$o.BACK,o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=!(arguments.length>8&&void 0!==arguments[8])||arguments[8],h=arguments.length>9&&void 0!==arguments[9]&&arguments[9],_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1;i(this,e),this.isDiscard=t,this.polygonMode=n,this.shadeModel=r,this.cullMode=a,this.isFrontFaceCCW=o,this.depthBias=s,this.depthBiasClamp=l,this.depthBiasSlop=c,this.isDepthClip=u,this.isMultisample=h,this.lineWidth=_}return r(e,[{key:"compare",value:function(e){return this.isDiscard===e.isDiscard&&this.polygonMode===e.polygonMode&&this.shadeModel===e.shadeModel&&this.cullMode===e.cullMode&&this.isFrontFaceCCW===e.isFrontFaceCCW&&this.depthBias===e.depthBias&&this.depthBiasClamp===e.depthBiasClamp&&this.depthBiasSlop===e.depthBiasSlop&&this.isDepthClip===e.isDepthClip&&this.lineWidth===e.lineWidth&&this.isMultisample===e.isMultisample}}]),e}()),cl=e("GFXDepthStencilState",function(){function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:es.LESS,a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:es.ALWAYS,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:65535,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:65535,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:ts.KEEP,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:ts.KEEP,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:ts.KEEP,_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,d=arguments.length>11&&void 0!==arguments[11]&&arguments[11],f=arguments.length>12&&void 0!==arguments[12]?arguments[12]:es.ALWAYS,p=arguments.length>13&&void 0!==arguments[13]?arguments[13]:65535,m=arguments.length>14&&void 0!==arguments[14]?arguments[14]:65535,v=arguments.length>15&&void 0!==arguments[15]?arguments[15]:ts.KEEP,g=arguments.length>16&&void 0!==arguments[16]?arguments[16]:ts.KEEP,y=arguments.length>17&&void 0!==arguments[17]?arguments[17]:ts.KEEP,x=arguments.length>18&&void 0!==arguments[18]?arguments[18]:1;i(this,e),this.depthTest=t,this.depthWrite=n,this.depthFunc=r,this.stencilTestFront=a,this.stencilFuncFront=o,this.stencilReadMaskFront=s,this.stencilWriteMaskFront=l,this.stencilFailOpFront=c,this.stencilZFailOpFront=u,this.stencilPassOpFront=h,this.stencilRefFront=_,this.stencilTestBack=d,this.stencilFuncBack=f,this.stencilReadMaskBack=p,this.stencilWriteMaskBack=m,this.stencilFailOpBack=v,this.stencilZFailOpBack=g,this.stencilPassOpBack=y,this.stencilRefBack=x}return r(e,[{key:"compare",value:function(e){return this.depthTest===e.depthTest&&this.depthWrite===e.depthWrite&&this.depthFunc===e.depthFunc&&this.stencilTestFront===e.stencilTestFront&&this.stencilFuncFront===e.stencilFuncFront&&this.stencilReadMaskFront===e.stencilReadMaskFront&&this.stencilWriteMaskFront===e.stencilWriteMaskFront&&this.stencilFailOpFront===e.stencilFailOpFront&&this.stencilZFailOpFront===e.stencilZFailOpFront&&this.stencilPassOpFront===e.stencilPassOpFront&&this.stencilRefFront===e.stencilRefFront&&this.stencilTestBack===e.stencilTestBack&&this.stencilFuncBack===e.stencilFuncBack&&this.stencilReadMaskBack===e.stencilReadMaskBack&&this.stencilWriteMaskBack===e.stencilWriteMaskBack&&this.stencilFailOpBack===e.stencilFailOpBack&&this.stencilZFailOpBack===e.stencilZFailOpBack&&this.stencilPassOpBack===e.stencilPassOpBack&&this.stencilRefBack===e.stencilRefBack}}]),e}()),ul=e("GFXBlendTarget",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ns.ONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ns.ZERO,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:is.ADD,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ns.ONE,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:ns.ZERO,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:is.ADD,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:rs.ALL;i(this,e),this.blend=t,this.blendSrc=n,this.blendDst=r,this.blendEq=a,this.blendSrcAlpha=o,this.blendDstAlpha=s,this.blendAlphaEq=l,this.blendColorMask=c}return r(e,[{key:"compare",value:function(e){return this.blend===e.blend&&this.blendSrc===e.blendSrc&&this.blendDst===e.blendDst&&this.blendEq===e.blendEq&&this.blendSrcAlpha===e.blendSrcAlpha&&this.blendDstAlpha===e.blendDstAlpha&&this.blendAlphaEq===e.blendAlphaEq&&this.blendColorMask===e.blendColorMask}}]),e}()),hl=e("GFXBlendState",function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new As,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[new ul];i(this,e),this.isA2C=t,this.isIndepend=n,this.blendColor=r,this.targets=a}return r(e,[{key:"setTarget",value:function(e,t){this.targets[e]=t}}]),e}()),_l=e("GFXInputState",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];i(this,e),this.attributes=t})),dl=e("GFXPipelineStateInfo",(function e(t,n,r,a,o,s,l){var c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:Zo.TRIANGLE_LIST,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:gs.NONE;i(this,e),this.shader=t,this.pipelineLayout=n,this.renderPass=r,this.inputState=a,this.rasterizerState=o,this.depthStencilState=s,this.blendState=l,this.primitive=c,this.dynamicStates=u})),fl=e("GFXPipelineState",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.PIPELINE_STATE)))._device=void 0,n._shader=null,n._pipelineLayout=null,n._primitive=Zo.TRIANGLE_LIST,n._is=null,n._rs=null,n._dss=null,n._bs=null,n._dynamicStates=gs.NONE,n._renderPass=null,n._device=e,n}return o(t,e),r(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(Ss)),pl=e("GFXQueueInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:xs.GRAPHICS;i(this,e),this.type=t})),ml=e("GFXQueue",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.QUEUE)))._device=void 0,n._type=xs.GRAPHICS,n._isAsync=!1,n._device=e,n}return o(t,e),r(t,[{key:"type",get:function(){return this._type}}]),r(t,[{key:"isAsync",value:function(){return this._isAsync}}]),t}(Ss)),vl=e("GFXColorAttachment",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:jo.UNKNOWN,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fs.CLEAR,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ps.STORE,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ms.UNDEFINED,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:ms.PRESENT_SRC;i(this,e),this.format=t,this.sampleCount=n,this.loadOp=r,this.storeOp=a,this.beginLayout=o,this.endLayout=s})),gl=e("GFXDepthStencilAttachment",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:jo.UNKNOWN,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fs.CLEAR,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ps.STORE,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:fs.CLEAR,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:ps.STORE,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:ms.UNDEFINED,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:ms.DEPTH_STENCIL_ATTACHMENT_OPTIMAL;i(this,e),this.format=t,this.sampleCount=n,this.depthLoadOp=r,this.depthStoreOp=a,this.stencilLoadOp=o,this.stencilStoreOp=s,this.beginLayout=l,this.endLayout=c})),yl=(e("GFXSubPassInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:vs.GRAPHICS,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:-1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[];i(this,e),this.bindPoint=t,this.inputs=n,this.colors=r,this.resolves=a,this.depthStencil=o,this.preserves=s})),e("GFXRenderPassInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];i(this,e),this.colorAttachments=t,this.depthStencilAttachment=n,this.subPasses=r}))),xl=e("GFXRenderPass",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.RENDER_PASS)))._device=void 0,n._colorInfos=[],n._depthStencilInfo=null,n._subPasses=[],n._hash=0,n._device=e,n}return o(t,e),r(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subPasses}},{key:"hash",get:function(){return this._hash}}]),r(t,[{key:"computeHash",value:function(){var e="";if(this._subPasses.length)for(var t=0;t<this._subPasses.length;++t){var i=this._subPasses[t];if(i.inputs.length){e+="ia";for(var n=0;n<i.inputs.length;++n){var r=this._colorInfos[i.inputs[n]];e+=",".concat(r.format,",").concat(r.sampleCount)}}if(i.colors.length){e+="ca";for(var a=0;a<i.inputs.length;++a){var o=this._colorInfos[i.inputs[a]];e+=",".concat(o.format,",").concat(o.sampleCount)}}if(i.depthStencil>=0){var s=this._colorInfos[i.depthStencil];e+="ds,".concat(s.format,",").concat(s.sampleCount)}}else{e+="ca";for(var l=0;l<this._colorInfos.length;++l){var c=this._colorInfos[l];e+=",".concat(c.format,",").concat(c.sampleCount)}var u=this._depthStencilInfo;u&&(e+="ds,".concat(u.format,",").concat(u.sampleCount))}return rl(e,666)}}]),t}(Ss)),Sl=e("GFXSamplerInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:as.LINEAR,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:as.LINEAR,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:as.NONE,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:os.WRAP,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:os.WRAP,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:os.WRAP,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:16,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:es.NEVER,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:new As,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,d=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0;i(this,e),this.minFilter=t,this.magFilter=n,this.mipFilter=r,this.addressU=a,this.addressV=o,this.addressW=s,this.maxAnisotropy=l,this.cmpFunc=c,this.borderColor=u,this.minLOD=h,this.maxLOD=_,this.mipLODBias=d})),Tl=e("GFXSampler",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.SAMPLER)))._device=void 0,n._minFilter=as.LINEAR,n._magFilter=as.LINEAR,n._mipFilter=as.NONE,n._addressU=os.WRAP,n._addressV=os.WRAP,n._addressW=os.WRAP,n._maxAnisotropy=16,n._cmpFunc=es.NEVER,n._borderColor=new As,n._minLOD=0,n._maxLOD=0,n._mipLODBias=0,n._device=e,n}return o(t,e),r(t,[{key:"minFilter",get:function(){return this._minFilter}},{key:"magFilter",get:function(){return this._magFilter}},{key:"mipFilter",get:function(){return this._mipFilter}},{key:"addressU",get:function(){return this._addressU}},{key:"addressV",get:function(){return this._addressV}},{key:"addressW",get:function(){return this._addressW}},{key:"maxAnisotropy",get:function(){return this._maxAnisotropy}},{key:"cmpFunc",get:function(){return this._cmpFunc}},{key:"borderColor",get:function(){return this._borderColor}},{key:"minLOD",get:function(){return this._minLOD}},{key:"maxLOD",get:function(){return this._maxLOD}},{key:"mipLODBias",get:function(){return this._mipLODBias}}]),t}(Ss)),El=e("GFXShaderStage",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:hs.NONE,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";i(this,e),this.stage=t,this.source=n})),bl=e("GFXUniform",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Wo.UNKNOWN,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;i(this,e),this.name=t,this.type=n,this.count=r})),Al=e("GFXUniformBlock",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;i(this,e),this.set=t,this.binding=n,this.name=r,this.members=a,this.count=o})),Cl=e("GFXUniformSampler",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Wo.UNKNOWN,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;i(this,e),this.set=t,this.binding=n,this.name=r,this.type=a,this.count=o})),wl=e("GFXShaderInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];i(this,e),this.name=t,this.stages=n,this.attributes=r,this.blocks=a,this.samplers=o})),Rl=e("GFXShader",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.SHADER)))._device=void 0,n._id=void 0,n._name="",n._stages=[],n._attributes=[],n._blocks=[],n._samplers=[],n._device=e,n._id=t._shaderIdGen++,n}return o(t,e),r(t,[{key:"id",get:function(){return this._id}},{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(Ss));Rl._shaderIdGen=0;var Il=e("GFXTextureInfo",(function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ls.NONE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:jo.UNKNOWN,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:us.NONE,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:1,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:cs.X1,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:1;i(this,e),this.type=t,this.usage=n,this.format=r,this.width=a,this.height=o,this.flags=s,this.layerCount=l,this.levelCount=c,this.samples=u,this.depth=h}));e("GFXTextureViewInfo",(function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ss.TEX2D,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:jo.UNKNOWN,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;i(this,e),this.texture=t,this.type=n,this.format=r,this.baseLevel=a,this.levelCount=o,this.baseLayer=s,this.layerCount=l}));function Ol(e){return e>0&&0==(e&e-1)}var Ml,Pl=e("GFXTexture",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.TEXTURE)))._device=void 0,n._type=ss.TEX2D,n._usage=ls.NONE,n._format=jo.UNKNOWN,n._width=0,n._height=0,n._depth=1,n._layerCount=1,n._levelCount=1,n._samples=cs.X1,n._flags=us.NONE,n._isPowerOf2=!1,n._size=0,n._buffer=null,n._device=e,n}return o(t,e),r(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}},{key:"buffer",get:function(){return this._buffer}}]),t}(Ss)),kl=e("DESCRIPTOR_BUFFER_TYPE",_s.UNIFORM_BUFFER|_s.DYNAMIC_UNIFORM_BUFFER|_s.STORAGE_BUFFER|_s.DYNAMIC_STORAGE_BUFFER),Dl=e("DESCRIPTOR_SAMPLER_TYPE",_s.SAMPLER),Bl=e("GFXDescriptorSetInfo",(function e(t){i(this,e),this.layout=t})),Ll=e("GFXDescriptorSet",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.DESCRIPTOR_SET)))._device=void 0,n._layout=null,n._buffers=[],n._textures=[],n._samplers=[],n._isDirty=!1,n._device=e,n}return o(t,e),r(t,[{key:"layout",get:function(){return this._layout}}]),r(t,[{key:"bindBuffer",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this._layout.bindings[e],r=this._layout.descriptorIndices[e];n&&n.descriptorType&kl?this._buffers[r+i]!==t&&(this._buffers[r+i]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.UNIFORM_BUFFER.")}},{key:"bindSampler",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this._layout.bindings[e],r=this._layout.descriptorIndices[e];n&&n.descriptorType&Dl?this._samplers[r+i]!==t&&(this._samplers[r+i]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.SAMPLER.")}},{key:"bindTexture",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=this._layout.bindings[e],r=this._layout.descriptorIndices[e];n&&n.descriptorType&Dl?this._textures[r+i]!==t&&(this._textures[r+i]=t,this._isDirty=!0):console.error("Setting binding is not GFXDescriptorType.SAMPLER.")}},{key:"getBuffer",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this._layout.descriptorIndices[e];return this._buffers[i+t]}},{key:"getSampler",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this._layout.descriptorIndices[e];return this._samplers[i+t]}},{key:"getTexture",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this._layout.descriptorIndices[e];return this._textures[i+t]}}]),t}(Ss)),Nl=e("GFXDescriptorSetLayoutBinding",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_s.UNKNOWN,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:hs.NONE,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];i(this,e),this.descriptorType=t,this.count=n,this.stageFlags=r,this.immutableSamplers=a})),Fl=e("GFXDescriptorSetLayoutInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];i(this,e),this.bindings=t})),zl=e("DESCRIPTOR_DYNAMIC_TYPE",_s.DYNAMIC_STORAGE_BUFFER|_s.DYNAMIC_UNIFORM_BUFFER),Ul=e("GFXDescriptorSetLayout",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.DESCRIPTOR_SET_LAYOUT)))._device=void 0,n._bindings=[],n._descriptorIndices=[],n._device=e,n}return o(t,e),r(t,[{key:"bindings",get:function(){return this._bindings}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(Ss)),Gl=e("GFXPipelineLayoutInfo",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];i(this,e),this.setLayouts=t})),Hl=e("GFXPipelineLayout",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.PIPELINE_LAYOUT)))._device=void 0,n._setLayouts=[],n._device=e,n}return o(t,e),r(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(Ss)),Vl=(e("GFXFenceInfo",(function e(){i(this,e)})),e("GFXFence",function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,zo.FENCE)))._device=void 0,n._device=e,n}return o(t,e),t}(Ss)));E.GFXDevice=$s,E.GFXBuffer=Ys,E.GFXTexture=Pl,E.GFXSampler=Tl,E.GFXShader=Rl,E.GFXInputAssembler=sl,E.GFXRenderPass=xl,E.GFXFramebuffer=tl,E.GFXPipelineState=fl,E.GFXCommandBuffer=Zs,E.GFXQueue=ml,Object.assign(E,Hs),function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(Ml||(Ml={}));var Wl,jl,ql,Xl,Yl,Kl,Zl=(Wl=new oa(0,0,0),function(e,t){var i=oa.dot(e.d,t.n);if(Math.abs(i)<Number.EPSILON)return 0;oa.multiplyScalar(Wl,t.n,t.d);var n=oa.dot(oa.subtract(Wl,Wl,e.o),t.n)/i;return n<0?0:n}),Ql=(jl=new oa(0,0,0),ql=new oa(0,0,0),Xl=new oa(0,0,0),Yl=new oa(0,0,0),Kl=new oa(0,0,0),function(e,t,i){oa.subtract(jl,t.b,t.a),oa.subtract(ql,t.c,t.a),oa.cross(Xl,e.d,ql);var n=oa.dot(jl,Xl);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;oa.subtract(Yl,e.o,t.a);var a=oa.dot(Yl,Xl)*r;if(a<0||a>1)return 0;oa.cross(Kl,Yl,jl);var o=oa.dot(e.d,Kl)*r;if(o<0||a+o>1)return 0;var s=oa.dot(ql,Kl)*r;return s<0?0:s}),Jl=function(){var e=new oa(0,0,0);return function(t,i){var n=i.radius,r=i.center,a=t.o,o=t.d,s=n*n;oa.subtract(e,r,a);var l=e.lengthSqr(),c=oa.dot(e,o),u=s-(l-c*c);if(u<0)return 0;var h=Math.sqrt(u),_=l<s?c+h:c-h;return _<0?0:_}}(),$l=function(){var e=new oa,t=new oa;return function(i,n){return oa.subtract(e,n.center,n.halfExtents),oa.add(t,n.center,n.halfExtents),ec(i,e,t)}}();function ec(e,t,i){var n=e.o,r=e.d,a=1/r.x,o=1/r.y,s=1/r.z,l=(t.x-n.x)*a,c=(i.x-n.x)*a,u=(t.y-n.y)*o,h=(i.y-n.y)*o,_=(t.z-n.z)*s,d=(i.z-n.z)*s,f=Math.max(Math.max(Math.min(l,c),Math.min(u,h)),Math.min(_,d)),p=Math.min(Math.min(Math.max(l,c),Math.max(u,h)),Math.max(_,d));return p<0||f>p?0:f>0?f:p}var tc,ic,nc=function(){var e=new oa,t=new oa,i=new oa,n=new oa,r=new oa,a=new oa,o=new oa,s=new Array(3),l=new Array(3),c=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,i=h.d,oa.set(n,_.orientation.m00,_.orientation.m01,_.orientation.m02),oa.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),oa.set(a,_.orientation.m06,_.orientation.m07,_.orientation.m08),oa.subtract(o,e,t),l[0]=oa.dot(n,i),l[1]=oa.dot(r,i),l[2]=oa.dot(a,i),c[0]=oa.dot(n,o),c[1]=oa.dot(r,o),c[2]=oa.dot(a,o);for(var d=0;d<3;++d){if(0===l[d]){if(-c[d]-s[d]>0||-c[d]+s[d]<0)return 0;l[d]=1e-7}u[2*d+0]=(c[d]+s[d])/l[d],u[2*d+1]=(c[d]-s[d])/l[d]}var f=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),p=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return p<0||f>p?0:f>0?f:p}}(),rc=function(){var e=new oa,t=new oa,i=new oa,n=new oa,r=new oa,a=new oa,o=new oa,s=new Uo;return function(l,c){var u=c.radius*c.radius,h=oa.normalize(e,l.d),_=c.ellipseCenter0,d=c.ellipseCenter1,f=oa.subtract(t,d,_);if(f.equals(oa.ZERO))return s.radius=c.radius,s.center.set(c.ellipseCenter0),Uc.ray_sphere(l,s);var p=l.o,m=oa.subtract(i,p,_),v=oa.cross(n,h,f),g=v.lengthSqr();if(0===g){s.radius=c.radius;var y=oa.subtract(r,d,p);return m.lengthSqr()<y.lengthSqr()?s.center.set(c.ellipseCenter0):s.center.set(c.ellipseCenter1),Uc.ray_sphere(l,s)}var x=oa.cross(r,m,f),S=f.lengthSqr(),T=2*oa.dot(v,x),E=T*T-4*g*(x.lengthSqr()-u*S);if(E<0)return 0;var b=(-T-Math.sqrt(E))/(2*g);if(b<0){s.radius=c.radius;var A=oa.subtract(a,d,p);return m.lengthSqr()<A.lengthSqr()?s.center.set(c.ellipseCenter0):s.center.set(c.ellipseCenter1),Uc.ray_sphere(l,s)}var C=oa.scaleAndAdd(a,l.o,h,b),w=oa.subtract(o,C,_),R=oa.dot(w,f)/S;return R>=0&&R<=1?b:R<0?(s.radius=c.radius,s.center.set(c.ellipseCenter0),Uc.ray_sphere(l,s)):R>1?(s.radius=c.radius,s.center.set(c.ellipseCenter1),Uc.ray_sphere(l,s)):0}}(),ac=function(){var e=Go.create(),t={distance:1/0,doubleSided:!1,mode:Ml.ANY},i=0,n=function(e,t,n,r,a,o){e===Ml.CLOSEST?(i>t||0===i)&&(i=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:r/3,vertexIndex2:a/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=r/3,o[0].vertexIndex2=a/3))):(i=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:r/3,vertexIndex2:a/3}))};return function(r,a,o){if(i=0,0===a.geometricInfo.positions.length)return i;var s=void 0===o?t:o;if(ec(r,a.geometricInfo.boundingBox.min,a.geometricInfo.boundingBox.max)){var l=a.primitiveMode,c=a.geometricInfo;!function(t,i,r,a,o){if(r===Zo.TRIANGLE_LIST)for(var s=i.length,l=0;l<s;l+=3){var c=3*i[l],u=3*i[l+1],h=3*i[l+2];oa.set(e.a,t[c],t[c+1],t[c+2]),oa.set(e.b,t[u],t[u+1],t[u+2]),oa.set(e.c,t[h],t[h+1],t[h+2]);var _=Uc.ray_triangle(a,e,o.doubleSided);if(!(0===_||_>o.distance)&&(n(o.mode,_,c,u,h,o.result),o.mode===Ml.ANY))return _}else if(r===Zo.TRIANGLE_STRIP)for(var d=i.length-2,f=0,p=0;p<d;p+=1){var m=3*i[p-f],v=3*i[p+f+1],g=3*i[p+2];oa.set(e.a,t[m],t[m+1],t[m+2]),oa.set(e.b,t[v],t[v+1],t[v+2]),oa.set(e.c,t[g],t[g+1],t[g+2]),f=~f;var y=Uc.ray_triangle(a,e,o.doubleSided);if(!(0===y||y>o.distance)&&(n(o.mode,y,m,v,g,o.result),o.mode===Ml.ANY))return y}else if(r===Zo.TRIANGLE_FAN){var x=i.length-1,S=3*i[0];oa.set(e.a,t[S],t[S+1],t[S+2]);for(var T=1;T<x;T+=1){var E=3*i[T],b=3*i[T+1];oa.set(e.b,t[E],t[E+1],t[E+2]),oa.set(e.c,t[b],t[b+1],t[b+2]);var A=Uc.ray_triangle(a,e,o.doubleSided);if(!(0===A||A>o.distance)&&(n(o.mode,A,S,E,b,o.result),o.mode===Ml.ANY))return A}}}(c.positions,c.indices,l,r,s)}return i}}(),oc=(tc=0,ic={distance:1/0,doubleSided:!1,mode:Ml.ANY},function(e,t,i){tc=0;var n=void 0===i?ic:i,r=t.renderingSubMeshes.length,a=t.struct.minPosition,o=t.struct.maxPosition;if(a&&o&&!ec(e,a,o))return tc;for(var s=0;s<r;s++){var l=t.renderingSubMeshes[s],c=ac(e,l,n);if(c)if(n.mode===Ml.CLOSEST)(0===tc||tc>c)&&(tc=c,n.subIndices&&(n.subIndices[0]=s));else if(tc=c,n.subIndices&&n.subIndices.push(s),n.mode===Ml.ANY)return c}return tc&&n.mode===Ml.CLOSEST&&(n.result&&(n.result[0].distance=tc,n.result.length=1),n.subIndices&&(n.subIndices.length=1)),tc}),sc=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:Ml.ANY},i=new ko,n=new Ta;return function(r,a,o){e=0;var s=void 0===o?t:o,l=a.worldBounds;if(l&&!$l(r,l))return e;ko.copy(i,r),a.node&&(Ta.invert(n,a.node.getWorldMatrix(n)),oa.transformMat4(i.o,r.o,n),oa.transformMat4Normal(i.d,r.d,n));for(var c=a.subModels,u=0;u<c.length;u++){var h=c[u].subMesh,_=ac(i,h,s);if(_)if(s.mode===Ml.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===Ml.ANY)return _}return e&&s.mode===Ml.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),lc=function(){var e=new oa(0,0,0);return function(t,i){oa.subtract(e,t.e,t.s);var n=(i.d-oa.dot(t.s,i.n))/oa.dot(e,i.n);return n<0||n>1?0:n}}(),cc=function(){var e=new oa(0,0,0),t=new oa(0,0,0),i=new oa(0,0,0),n=new oa(0,0,0),r=new oa(0,0,0),a=new oa(0,0,0);return function(o,s,l){oa.subtract(e,s.b,s.a),oa.subtract(t,s.c,s.a),oa.subtract(i,o.s,o.e),oa.cross(r,e,t);var c=oa.dot(i,r);if(c<=0)return 0;oa.subtract(n,o.s,s.a);var u=oa.dot(n,r);if(u<0||u>c)return 0;oa.cross(a,i,n);var h=oa.dot(t,a);if(h<0||h>c)return 0;var _=-oa.dot(e,a);if(_<0||h+_>c)return 0;if(l){var d=1/c,f=1-(h*=d)-(_*=d);oa.set(l,s.a.x*f+s.b.x*h+s.c.x*_,s.a.y*f+s.b.y*h+s.c.y*_,s.a.z*f+s.b.z*h+s.c.z*_)}return 1}}(),uc=new ko;function hc(e,t){uc.o.set(e.s),oa.subtract(uc.d,e.e,e.s),uc.d.normalize();var i=$l(uc,t);return i<=e.length()?i:0}function _c(e,t){uc.o.set(e.s),oa.subtract(uc.d,e.e,e.s),uc.d.normalize();var i=nc(uc,t);return i<=e.length()?i:0}function dc(e,t){uc.o.set(e.s),oa.subtract(uc.d,e.e,e.s),uc.d.normalize();var i=Jl(uc,t);return i<=e.length()?i:0}var fc,pc,mc,vc,gc=(fc=new oa,pc=new oa,mc=new oa,vc=new oa,function(e,t){return oa.subtract(fc,e.center,e.halfExtents),oa.add(pc,e.center,e.halfExtents),oa.subtract(mc,t.center,t.halfExtents),oa.add(vc,t.center,t.halfExtents),fc.x<=vc.x&&pc.x>=mc.x&&fc.y<=vc.y&&pc.y>=mc.y&&fc.z<=vc.z&&pc.z>=mc.z});function yc(e,t,i,n,r,a){oa.set(a[0],e.x+i.x*t.x+n.x*t.y+r.x*t.z,e.y+i.y*t.x+n.y*t.y+r.y*t.z,e.z+i.z*t.x+n.z*t.y+r.z*t.z),oa.set(a[1],e.x-i.x*t.x+n.x*t.y+r.x*t.z,e.y-i.y*t.x+n.y*t.y+r.y*t.z,e.z-i.z*t.x+n.z*t.y+r.z*t.z),oa.set(a[2],e.x+i.x*t.x-n.x*t.y+r.x*t.z,e.y+i.y*t.x-n.y*t.y+r.y*t.z,e.z+i.z*t.x-n.z*t.y+r.z*t.z),oa.set(a[3],e.x+i.x*t.x+n.x*t.y-r.x*t.z,e.y+i.y*t.x+n.y*t.y-r.y*t.z,e.z+i.z*t.x+n.z*t.y-r.z*t.z),oa.set(a[4],e.x-i.x*t.x-n.x*t.y-r.x*t.z,e.y-i.y*t.x-n.y*t.y-r.y*t.z,e.z-i.z*t.x-n.z*t.y-r.z*t.z),oa.set(a[5],e.x+i.x*t.x-n.x*t.y-r.x*t.z,e.y+i.y*t.x-n.y*t.y-r.y*t.z,e.z+i.z*t.x-n.z*t.y-r.z*t.z),oa.set(a[6],e.x-i.x*t.x+n.x*t.y-r.x*t.z,e.y-i.y*t.x+n.y*t.y-r.y*t.z,e.z-i.z*t.x+n.z*t.y-r.z*t.z),oa.set(a[7],e.x-i.x*t.x-n.x*t.y+r.x*t.z,e.y-i.y*t.x-n.y*t.y+r.y*t.z,e.z-i.z*t.x-n.z*t.y+r.z*t.z)}function xc(e,t){for(var i=oa.dot(t,e[0]),n=i,r=1;r<8;++r){var a=oa.dot(t,e[r]);i=a<i?a:i,n=a>n?a:n}return[i,n]}var Sc,Tc=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new oa(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new oa(0,0,0),n[r]=new oa(0,0,0);var a=new oa,o=new oa;return function(t,r){oa.set(e[0],1,0,0),oa.set(e[1],0,1,0),oa.set(e[2],0,0,1),oa.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),oa.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),oa.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)oa.cross(e[6+3*s+0],e[s],e[0]),oa.cross(e[6+3*s+1],e[s],e[1]),oa.cross(e[6+3*s+1],e[s],e[2]);oa.subtract(a,t.center,t.halfExtents),oa.add(o,t.center,t.halfExtents),function(e,t,i){oa.set(i[0],e.x,t.y,t.z),oa.set(i[1],e.x,t.y,e.z),oa.set(i[2],e.x,e.y,t.z),oa.set(i[3],e.x,e.y,e.z),oa.set(i[4],t.x,t.y,t.z),oa.set(i[5],t.x,t.y,e.z),oa.set(i[6],t.x,e.y,t.z),oa.set(i[7],t.x,e.y,e.z)}(a,o,i),yc(r.center,r.halfExtents,e[3],e[4],e[5],n);for(var l=0;l<15;++l){var c=xc(i,e[l]),u=xc(n,e[l]);if(u[0]>c[1]||c[0]>u[1])return 0}return 1}}(),Ec=function(e,t){var i=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),n=oa.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1},bc=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Ec(e,t.planes[i]))return 0;return 1},Ac=function(){for(var e=new Array(8),t=0,i=0,n=0;n<e.length;n++)e[n]=new oa(0,0,0);return function(n,r){for(var a=0,o=!1,s=0;s<r.planes.length;s++){if(-1===(a=Ec(n,r.planes[s])))return 0;1===a&&(o=!0)}if(!o)return 1;for(var l=0;l<r.vertices.length;l++)oa.subtract(e[l],r.vertices[l],n.center);t=0,i=0;for(var c=0;c<r.vertices.length;c++)e[c].x>n.halfExtents.x?t++:e[c].x<-n.halfExtents.x&&i++;if(t===r.vertices.length||i===r.vertices.length)return 0;t=0,i=0;for(var u=0;u<r.vertices.length;u++)e[u].y>n.halfExtents.y?t++:e[u].y<-n.halfExtents.y&&i++;if(t===r.vertices.length||i===r.vertices.length)return 0;t=0,i=0;for(var h=0;h<r.vertices.length;h++)e[h].z>n.halfExtents.z?t++:e[h].z<-n.halfExtents.z&&i++;return t===r.vertices.length||i===r.vertices.length?0:1}}(),Cc=function(){var e=new oa(0,0,0),t=new _a;return function(i,n){return oa.subtract(e,n,i.center),oa.transformMat3(e,e,_a.transpose(t,i.orientation)),r=e,a=i.halfExtents,Math.abs(r.x)<a.x&&Math.abs(r.y)<a.y&&Math.abs(r.z)<a.z;var r,a}}(),wc=(Sc=function(e,t,i,n){return Math.abs(e.x*t+e.y*i+e.z*n)},function(e,t){var i=e.halfExtents.x*Sc(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Sc(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Sc(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),n=oa.dot(t.n,e.center);return n+i<t.d?-1:n-i>t.d?0:1}),Rc=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===wc(e,t.planes[i]))return 0;return 1},Ic=function(){for(var e=new Array(8),t=0,i=0,n=0,r=0;r<e.length;r++)e[r]=new oa(0,0,0);var a=function(e,t,i,n){return e.x*t+e.y*i+e.z*n};return function(r,o){for(var s=0,l=!1,c=0;c<o.planes.length;c++){if(-1===(s=wc(r,o.planes[c])))return 0;1===s&&(l=!0)}if(!l)return 1;for(var u=0;u<o.vertices.length;u++)oa.subtract(e[u],o.vertices[u],r.center);i=0,n=0;for(var h=0;h<o.vertices.length;h++)(t=a(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?i++:t<-r.halfExtents.x&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(var _=0;_<o.vertices.length;_++)(t=a(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?i++:t<-r.halfExtents.y&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(var d=0;d<o.vertices.length;d++)(t=a(e[d],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?i++:t<-r.halfExtents.z&&n++;return i===o.vertices.length||n===o.vertices.length?0:1}}(),Oc=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new oa(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new oa(0,0,0),n[r]=new oa(0,0,0);return function(t,r){oa.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),oa.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),oa.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),oa.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),oa.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),oa.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var a=0;a<3;++a)oa.cross(e[6+3*a+0],e[a],e[0]),oa.cross(e[6+3*a+1],e[a],e[1]),oa.cross(e[6+3*a+1],e[a],e[2]);yc(t.center,t.halfExtents,e[0],e[1],e[2],i),yc(r.center,r.halfExtents,e[3],e[4],e[5],n);for(var o=0;o<15;++o){var s=xc(i,e[o]),l=xc(n,e[o]);if(l[0]>s[1]||s[0]>l[1])return 0}return 1}}(),Mc=function(){for(var e=new Uo,t=new oa,i=new oa,n=new oa,r=new Array(8),a=0;a<8;a++)r[a]=new oa;for(var o=new Array(8),s=0;s<8;s++)o[s]=new oa;return function(a,s){if(0===oa.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),Uc.sphere_obb(e,a);t.x=a.orientation.m00,t.y=a.orientation.m01,t.z=a.orientation.m02,i.x=a.orientation.m03,i.y=a.orientation.m04,i.z=a.orientation.m05,n.x=a.orientation.m06,n.y=a.orientation.m07,n.z=a.orientation.m08,yc(a.center,a.halfExtents,t,i,n,r);var l=o,c=oa.copy(l[0],t),u=oa.copy(l[1],i),h=oa.copy(l[2],n);oa.subtract(l[3],s.center,a.center).normalize();var _=oa.subtract(l[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),oa.cross(l[5],c,_),oa.cross(l[6],u,_),oa.cross(l[7],h,_);for(var d=0;d<8;++d){var f=xc(r,l[d]),p=oa.dot(l[d],s.ellipseCenter0),m=oa.dot(l[d],s.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-s.radius,y=v+s.radius;if(g>f[1]||f[0]>y)return 0}return 1}}(),Pc=function(e,t){var i=oa.dot(t.n,e.center),n=e.radius*t.n.length();return i+n<t.d?-1:i-n>t.d?0:1},kc=function(e,t){for(var i=0;i<t.planes.length;i++)if(-1===Pc(e,t.planes[i]))return 0;return 1},Dc=function(){var e=new oa(0,0,0),t=[1,-1,1,-1,1,-1];return function(i,n){for(var r=0;r<6;r++){var a=n.planes[r],o=i.radius,s=i.center,l=a.n,c=a.d,u=oa.dot(l,s);if(u+o<c)return 0;if(!(u-o>c)){oa.add(e,s,oa.multiplyScalar(e,l,o));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var _=n.planes[h];if(oa.dot(_.n,e)<_.d)return 0}}}return 1}}(),Bc=function(e,t){var i=e.radius+t.radius;return oa.squaredDistance(e.center,t.center)<i*i},Lc=function(){var e=new oa;return function(t,i){return Oo(e,t.center,i),oa.squaredDistance(t.center,e)<t.radius*t.radius}}(),Nc=function(){var e=new oa;return function(t,i){return Mo(e,t.center,i),oa.squaredDistance(t.center,e)<t.radius*t.radius}}(),Fc=function(){var e=new oa,t=new oa;return function(i,n){var r=i.radius+n.radius,a=r*r,o=oa.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===o)return oa.squaredDistance(i.center,n.center)<a;oa.subtract(e,i.center,n.ellipseCenter0),oa.subtract(t,n.ellipseCenter1,n.ellipseCenter0);var s=oa.dot(e,t)/o;return s<0?oa.squaredDistance(i.center,n.ellipseCenter0)<a:s>1?oa.squaredDistance(i.center,n.ellipseCenter1)<a:(oa.scaleAndAdd(e,n.ellipseCenter0,t,s),oa.squaredDistance(i.center,e)<a)}}(),zc=function(){var e=new oa,t=new oa,i=new oa,n=new oa,r=new oa,a=new oa;return function(o,s){var l,c,u,h,_=oa.subtract(e,o.ellipseCenter1,o.ellipseCenter0),d=oa.subtract(t,s.ellipseCenter1,s.ellipseCenter0),f=oa.subtract(i,o.ellipseCenter0,s.ellipseCenter0),p=oa.dot(_,_),m=oa.dot(_,d),v=oa.dot(d,d),g=oa.dot(_,f),y=oa.dot(d,f),x=p*v-m*m,S=x,T=x;x<fn?(c=0,S=1,h=y,T=v):(h=p*y-m*g,(c=m*y-v*g)<0?(c=0,h=y,T=v):c>S&&(c=S,h=y+m,T=v)),h<0?(h=0,-g<0?c=0:-g>p?c=S:(c=-g,S=p)):h>T&&(h=T,-g+m<0?c=0:-g+m>p?c=S:(c=-g+m,S=p)),l=Math.abs(c)<fn?0:c/S,u=Math.abs(h)<fn?0:h/T;var E=n;E.set(f),E.add(oa.multiplyScalar(r,_,l)),E.subtract(oa.multiplyScalar(a,d,u));var b=o.radius+s.radius;return E.lengthSqr()<b*b}}(),Uc={ray_sphere:Jl,ray_aabb:$l,ray_obb:nc,ray_plane:Zl,ray_triangle:Ql,ray_capsule:rc,ray_subMesh:ac,ray_mesh:oc,ray_model:sc,line_sphere:dc,line_aabb:hc,line_obb:_c,line_plane:lc,line_triangle:cc,sphere_sphere:Bc,sphere_aabb:Lc,sphere_obb:Nc,sphere_plane:Pc,sphere_frustum:kc,sphere_frustum_accurate:Dc,sphere_capsule:Fc,aabb_aabb:gc,aabb_obb:Tc,aabb_plane:Ec,aabb_frustum:bc,aabb_frustum_accurate:Ac,obb_obb:Oc,obb_plane:wc,obb_frustum:Rc,obb_frustum_accurate:Ic,obb_point:Cc,obb_capsule:Mc,capsule_capsule:zc,resolve:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=e._type,r=t._type,a=this[n|r];return n<r?a(e,t,i):a(t,e,i)}};Uc[xo.SHAPE_RAY|xo.SHAPE_SPHERE]=Jl,Uc[xo.SHAPE_RAY|xo.SHAPE_AABB]=$l,Uc[xo.SHAPE_RAY|xo.SHAPE_OBB]=nc,Uc[xo.SHAPE_RAY|xo.SHAPE_PLANE]=Zl,Uc[xo.SHAPE_RAY|xo.SHAPE_TRIANGLE]=Ql,Uc[xo.SHAPE_RAY|xo.SHAPE_CAPSULE]=rc,Uc[xo.SHAPE_LINE|xo.SHAPE_SPHERE]=dc,Uc[xo.SHAPE_LINE|xo.SHAPE_AABB]=hc,Uc[xo.SHAPE_LINE|xo.SHAPE_OBB]=_c,Uc[xo.SHAPE_LINE|xo.SHAPE_PLANE]=lc,Uc[xo.SHAPE_LINE|xo.SHAPE_TRIANGLE]=cc,Uc[xo.SHAPE_SPHERE]=Bc,Uc[xo.SHAPE_SPHERE|xo.SHAPE_AABB]=Lc,Uc[xo.SHAPE_SPHERE|xo.SHAPE_OBB]=Nc,Uc[xo.SHAPE_SPHERE|xo.SHAPE_PLANE]=Pc,Uc[xo.SHAPE_SPHERE|xo.SHAPE_FRUSTUM]=kc,Uc[xo.SHAPE_SPHERE|xo.SHAPE_FRUSTUM_ACCURATE]=Dc,Uc[xo.SHAPE_SPHERE|xo.SHAPE_CAPSULE]=Fc,Uc[xo.SHAPE_AABB]=gc,Uc[xo.SHAPE_AABB|xo.SHAPE_OBB]=Tc,Uc[xo.SHAPE_AABB|xo.SHAPE_PLANE]=Ec,Uc[xo.SHAPE_AABB|xo.SHAPE_FRUSTUM]=bc,Uc[xo.SHAPE_AABB|xo.SHAPE_FRUSTUM_ACCURATE]=Ac,Uc[xo.SHAPE_OBB]=Oc,Uc[xo.SHAPE_OBB|xo.SHAPE_PLANE]=wc,Uc[xo.SHAPE_OBB|xo.SHAPE_FRUSTUM]=Rc,Uc[xo.SHAPE_OBB|xo.SHAPE_FRUSTUM_ACCURATE]=Ic,Uc[xo.SHAPE_OBB|xo.SHAPE_CAPSULE]=Mc,Uc[xo.SHAPE_CAPSULE]=zc;var Gc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:-1;i(this,e),this.s=void 0,this.e=void 0,this._type=void 0,this._type=xo.SHAPE_LINE,this.s=new oa(t,n,r),this.e=new oa(a,o,s)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r,a,o){return new e(t,i,n,r,a,o)}},{key:"clone",value:function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}},{key:"copy",value:function(e,t){return oa.copy(e.s,t.s),oa.copy(e.e,t.e),e}},{key:"fromPoints",value:function(e,t,i){return oa.copy(e.s,t),oa.copy(e.e,i),e}},{key:"set",value:function(e,t,i,n,r,a,o){return e.s.x=t,e.s.y=i,e.s.z=n,e.e.x=r,e.e.y=a,e.e.z=o,e}},{key:"len",value:function(e){return oa.distance(e.s,e.e)}}]),r(e,[{key:"length",value:function(){return oa.distance(this.s,this.e)}}]),e}(),Hc=new oa(0,0,0),Vc=new oa(0,0,0),Wc=E.mat4(),jc=E.v4(),qc=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(this,e),this.n=void 0,this.d=void 0,this._type=void 0,this._type=xo.SHAPE_PLANE,this.n=new oa(t,n,r),this.d=a}return r(e,[{key:"type",get:function(){return this._type}},{key:"x",set:function(e){this.n.x=e},get:function(){return this.n.x}},{key:"y",set:function(e){this.n.y=e},get:function(){return this.n.y}},{key:"z",set:function(e){this.n.z=e},get:function(){return this.n.z}},{key:"w",set:function(e){this.d=e},get:function(){return this.d}}],[{key:"create",value:function(t,i,n,r){return new e(t,i,n,r)}},{key:"clone",value:function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)}},{key:"copy",value:function(e,t){return oa.copy(e.n,t.n),e.d=t.d,e}},{key:"fromPoints",value:function(e,t,i,n){return oa.subtract(Hc,i,t),oa.subtract(Vc,n,t),oa.normalize(e.n,oa.cross(e.n,Hc,Vc)),e.d=oa.dot(e.n,t),e}},{key:"set",value:function(e,t,i,n,r){return e.n.x=t,e.n.y=i,e.n.z=n,e.d=r,e}},{key:"fromNormalAndPoint",value:function(e,t,i){return oa.copy(e.n,t),e.d=oa.dot(t,i),e}},{key:"normalize",value:function(e,t){var i=t.n.length();return oa.normalize(e.n,t.n),i>0&&(e.d=t.d/i),e}}]),r(e,[{key:"transform",value:function(e){Ta.invert(Wc,e),Ta.transpose(Wc,Wc),ua.set(jc,this.n.x,this.n.y,this.n.z,this.d),ua.transformMat4(jc,jc,Wc),oa.set(this.n,jc.x,jc.y,jc.z),this.d=jc.w}}]),e}(),Xc=new oa,Yc=new oa,Kc=new oa,Zc=new oa,Qc=new _a,Jc=function(e,t,i){Qc.m00=Math.abs(i.m00),Qc.m01=Math.abs(i.m01),Qc.m02=Math.abs(i.m02),Qc.m03=Math.abs(i.m04),Qc.m04=Math.abs(i.m05),Qc.m05=Math.abs(i.m06),Qc.m06=Math.abs(i.m08),Qc.m07=Math.abs(i.m09),Qc.m08=Math.abs(i.m10),oa.transformMat3(e,t,Qc)},$c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;i(this,e),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=xo.SHAPE_AABB,this.center=new oa(t,n,r),this.halfExtents=new oa(a,o,s)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r,a,o){return new e(t,i,n,r,a,o)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}},{key:"copy",value:function(e,t){return oa.copy(e.center,t.center),oa.copy(e.halfExtents,t.halfExtents),e}},{key:"fromPoints",value:function(e,t,i){return oa.add(Xc,i,t),oa.subtract(Yc,i,t),oa.multiplyScalar(e.center,Xc,.5),oa.multiplyScalar(e.halfExtents,Yc,.5),e}},{key:"set",value:function(e,t,i,n,r,a,o){return oa.set(e.center,t,i,n),oa.set(e.halfExtents,r,a,o),e}},{key:"merge",value:function(t,i,n){return oa.subtract(Xc,i.center,i.halfExtents),oa.subtract(Yc,n.center,n.halfExtents),oa.add(Kc,i.center,i.halfExtents),oa.add(Zc,n.center,n.halfExtents),oa.max(Zc,Kc,Zc),oa.min(Kc,Xc,Yc),e.fromPoints(t,Kc,Zc)}},{key:"transform",value:function(e,t,i){return oa.transformMat4(e.center,t.center,i),Jc(e.halfExtents,t.halfExtents,i),e}}]),r(e,[{key:"getBoundary",value:function(e,t){oa.subtract(e,this.center,this.halfExtents),oa.add(t,this.center,this.halfExtents)}},{key:"transform",value:function(e,t,i,n,r){oa.transformMat4(r.center,this.center,e),Jc(r.halfExtents,this.halfExtents,e)}},{key:"clone",value:function(){return e.clone(this)}},{key:"copy",value:function(t){return e.copy(this,t)}}]),e}(),eu=new oa,tu=new oa,iu=new _a,nu=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,h=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,_=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,d=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,f=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,p=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,m=arguments.length>14&&void 0!==arguments[14]?arguments[14]:1;i(this,e),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=xo.SHAPE_OBB,this.center=new oa(t,n,r),this.halfExtents=new oa(a,o,s),this.orientation=new _a(l,c,u,h,_,d,f,p,m)}return r(e,[{key:"type",get:function(){return this._type}}],[{key:"create",value:function(t,i,n,r,a,o,s,l,c,u,h,_,d,f,p){return new e(t,i,n,r,a,o,s,l,c,u,h,_,d,f,p)}},{key:"clone",value:function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}},{key:"copy",value:function(e,t){return oa.copy(e.center,t.center),oa.copy(e.halfExtents,t.halfExtents),_a.copy(e.orientation,t.orientation),e}},{key:"fromPoints",value:function(e,t,i){return oa.multiplyScalar(e.center,oa.add(eu,t,i),.5),oa.multiplyScalar(e.halfExtents,oa.subtract(tu,i,t),.5),_a.identity(e.orientation),e}},{key:"set",value:function(e,t,i,n,r,a,o,s,l,c,u,h,_,d,f,p){return oa.set(e.center,t,i,n),oa.set(e.halfExtents,r,a,o),_a.set(e.orientation,s,l,c,u,h,_,d,f,p),e}}]),r(e,[{key:"getBoundary",value:function(e,t){var i,n,r;i=eu,n=this.halfExtents,r=this.orientation,iu.m00=Math.abs(r.m00),iu.m01=Math.abs(r.m01),iu.m02=Math.abs(r.m02),iu.m03=Math.abs(r.m03),iu.m04=Math.abs(r.m04),iu.m05=Math.abs(r.m05),iu.m06=Math.abs(r.m06),iu.m07=Math.abs(r.m07),iu.m08=Math.abs(r.m08),oa.transformMat3(i,n,iu),oa.subtract(e,this.center,eu),oa.add(t,this.center,eu)}},{key:"transform",value:function(e,t,i,n,r){oa.transformMat4(r.center,this.center,e),_a.fromQuat(r.orientation,i),oa.multiply(r.halfExtents,this.halfExtents,n)}},{key:"translateAndRotate",value:function(e,t,i){oa.transformMat4(i.center,this.center,e),_a.fromQuat(i.orientation,t)}},{key:"setScale",value:function(e,t){oa.multiply(t.halfExtents,this.halfExtents,e)}}]),e}(),ru=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;i(this,e),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=xo.SHAPE_CAPSULE,this.radius=t,this.halfHeight=n,this.axis=r,this.center=new oa,this.rotation=new pa,this.ellipseCenter0=new oa(0,n,0),this.ellipseCenter1=new oa(0,-n,0),this.updateCache()}return r(e,[{key:"type",get:function(){return this._type}}]),r(e,[{key:"transform",value:function(e,t,i,n,r){var a=n,o=Pn(a);r.radius=this.radius*Math.abs(o);var s=(this.halfHeight+this.radius)*Math.abs(a.y)-r.radius;s<0&&(s=0),r.halfHeight=s,oa.transformMat4(r.center,this.center,e),pa.multiply(r.rotation,this.rotation,i),r.updateCache()}},{key:"updateCache",value:function(){this.updateLocalCenter(),oa.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),oa.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}},{key:"updateLocalCenter",value:function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}}}]),e}(),au=new Array(8);au[0]=new oa(1,1,1),au[1]=new oa(-1,1,1),au[2]=new oa(-1,-1,1),au[3]=new oa(1,-1,1),au[4]=new oa(1,1,-1),au[5]=new oa(-1,1,-1),au[6]=new oa(-1,-1,-1),au[7]=new oa(1,-1,-1);var ou,su,lu=function(){function e(){i(this,e),this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=xo.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=qc.create(0,0,0,0);this.vertices=new Array(8);for(var n=0;n<8;++n)this.vertices[n]=new oa}return r(e,[{key:"accurate",set:function(e){this._type=e?xo.SHAPE_FRUSTUM_ACCURATE:xo.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}],[{key:"create",value:function(){return new e}},{key:"clone",value:function(t){return e.copy(new e,t)}},{key:"copy",value:function(e,t){e._type=t._type;for(var i=0;i<6;++i)qc.copy(e.planes[i],t.planes[i]);for(var n=0;n<8;++n)oa.copy(e.vertices[n],t.vertices[n]);return e}}]),r(e,[{key:"update",value:function(e,t){if(oa.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),oa.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),oa.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),oa.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),oa.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),oa.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===xo.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();oa.multiplyScalar(n.n,n.n,r),n.d*=r}for(var a=0;a<8;a++)oa.transformMat4(this.vertices[a],au[a],t)}}},{key:"transform",value:function(e){if(this._type===xo.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)oa.transformMat4(this.vertices[t],this.vertices[t],e);qc.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),qc.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),qc.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),qc.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),qc.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),qc.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}]),e}();lu.createOrtho=function(){var e=new oa;return function(t,i,n,r,a,o){var s=i/2,l=n/2;oa.set(e,s,l,r),oa.transformMat4(t.vertices[0],e,o),oa.set(e,-s,l,r),oa.transformMat4(t.vertices[1],e,o),oa.set(e,-s,-l,r),oa.transformMat4(t.vertices[2],e,o),oa.set(e,s,-l,r),oa.transformMat4(t.vertices[3],e,o),oa.set(e,s,l,a),oa.transformMat4(t.vertices[4],e,o),oa.set(e,-s,l,a),oa.transformMat4(t.vertices[5],e,o),oa.set(e,-s,-l,a),oa.transformMat4(t.vertices[6],e,o),oa.set(e,s,-l,a),oa.transformMat4(t.vertices[7],e,o),qc.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),qc.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),qc.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),qc.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),qc.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),qc.fromPoints(t.planes[0],t.vertices[7],t.vertices[5],t.vertices[6])}}(),function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(ou||(ou={})),function(e){e[e.Default=ou.Default]="Default",e[e.Normal=ou.Normal]="Normal",e[e.Reverse=ou.Reverse]="Reverse",e[e.Loop=ou.Loop]="Loop",e[e.LoopReverse=ou.Loop|ou.Reverse]="LoopReverse",e[e.PingPong=ou.PingPong]="PingPong",e[e.PingPongReverse=ou.PingPong|ou.Reverse]="PingPongReverse"}(su||(su={})),nt(su);var cu=function(){function e(t){i(this,e),this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return r(e,[{key:"set",value:function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex}}]),e}();var uu=et({Default:ou.Default,Normal:ou.Normal,Clamp:ou.Clamp,Loop:ou.Loop,PingPong:ou.PingPong}),hu=function e(){i(this,e),this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Ht.fastDefine("cc.Keyframe",hu,{time:0,value:0,inTangent:0,outTangent:0});var _u=function(){function e(){i(this,e),this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return r(e,[{key:"evaluate",value:function(e){return function(e,t){return e*(e*(e*t[0]+t[1])+t[2])+t[3]}(e-this.time,this.coefficient)}}]),e}();var du=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;i(this,e),this.keyFrames=void 0,this.preWrapMode=uu.Loop,this.postWrapMode=uu.Clamp,this.cachedKey=void 0,this.keyFrames=t||[].concat(e.defaultKF),this.cachedKey=new _u}return r(e,[{key:"addKey",value:function(e){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(e)}},{key:"evaluate_slow",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case uu.Loop:t=In(e-n,r-n)+n;break;case uu.PingPong:t=On(e-n,r-n)+n;break;case uu.Clamp:t=vn(e,n,r)}var a=0;if(t>this.keyFrames[0].time)if(t>=this.keyFrames[this.keyFrames.length-1].time)a=this.keyFrames.length-2;else for(var o=0;o<this.keyFrames.length-1;o++)if(t>=this.keyFrames[0].time&&t<=this.keyFrames[o+1].time){a=o;break}var s=this.keyFrames[a],l=this.keyFrames[a+1],c=Mn(s.time,l.time,t),u=l.time-s.time,h=s.outTangent*u,_=l.inTangent*u,d=c*c,f=d*c,p=f-2*d+c,m=f-d,v=-2*f+3*d;return(2*f-3*d+1)*s.value+p*h+m*_+v*l.value}},{key:"evaluate",value:function(e){var t=e,i=e<0?this.preWrapMode:this.postWrapMode,n=this.keyFrames[0].time,r=this.keyFrames[this.keyFrames.length-1].time;switch(i){case uu.Loop:t=In(e-n,r-n)+n;break;case uu.PingPong:t=On(e-n,r-n)+n;break;case uu.Clamp:t=vn(e,n,r)}if(t>=this.cachedKey.time&&t<this.cachedKey.endTime)return this.cachedKey.evaluate(t);var a=this.findIndex(this.cachedKey,t),o=a+1;return o===this.keyFrames.length&&(o-=1),this.calcOptimizedKey(this.cachedKey,a,o),this.cachedKey.evaluate(t)}},{key:"calcOptimizedKey",value:function(e,t,i){var n=this.keyFrames[t],r=this.keyFrames[i];e.index=t,e.time=n.time,e.endTime=r.time;var a=r.time-n.time,o=r.value-n.value,s=1/(a*a),l=n.outTangent*a,c=r.inTangent*a;e.coefficient[0]=(l+c-o-o)*s/a,e.coefficient[1]=(o+o+o-l-l-c)*s,e.coefficient[2]=n.outTangent,e.coefficient[3]=n.value}},{key:"findIndex",value:function(e,t){var i=e.index;if(-1!==i)if(t>this.keyFrames[i].time)for(var n=0;n<3;n++){var r=i+n;if(r+1<this.keyFrames.length&&this.keyFrames[r+1].time>t)return r}else for(var a=0;a<3;a++){var o=i-a;if(o>=0&&this.keyFrames[o-1].time<=t)return o-1}for(var s=0,l=this.keyFrames.length,c=Math.floor((s+l)/2);l-s>1;)this.keyFrames[c].time>=t?l=c:s=c+1,c=Math.floor((s+l)/2);return s}}]),e}();du.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Ht.fastDefine("cc.AnimationCurve",du,{preWrapMode:uu.Default,postWrapMode:uu.Default,keyFrames:[]}),ka(Gc.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),Da(Uc,"intersect",[{name:"line_quad"}]);var fu=Object.freeze({__proto__:null,distance:Po,enums:xo,intersect:Uc,line:Gc,plane:qc,ray:ko,triangle:Go,sphere:Uo,aabb:$c,obb:nu,capsule:ru,frustum:lu,Keyframe:hu,AnimationCurve:du,get ERaycastMode(){return Ml}});e("geometry",fu);var pu=e("BASELINE_RATIO",.26),mu=/([a-zA-Z0-9--]+|\S)/,vu=/^[!,.:;'}\]%\?>]/,gu=/([a-zA-Z0-9--]+|\S)$/,yu=/[a-zA-Z0-9--]+$/,xu=/^[a-zA-Z0-9--]/;function Su(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function Tu(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function Eu(e,t){var i=e.measureText(t);return i&&i.width||0}function bu(e,t,i){var n=t,r=i,a=e[t];if(a>="\udc00"&&a<="\udfff"&&n--,void 0!==i)if(i-1!==t){var o=e[i-1];o>="\ud800"&&o<="\udbff"&&r--}else a>="\ud800"&&a<="\udbff"&&r++;return e.substring(n,r)}function Au(e,t,i,n){var r=[];if(0===e.length||i<0)return r.push(""),r;for(var a=e;t>i&&a.length>1;){for(var o=a.length*(i/t)|0,s=bu(a,o),l=t-n(s),c=s,u=0,h=0;l>i&&h++<10;)o*=i/l,l=t-n(s=bu(a,o|=0));for(h=0;l<=i&&h++<10;){if(s){var _=mu.exec(s);u=_?_[0].length:1,c=s}l=t-n(s=bu(a,o+=u))}0===(o-=u)?(o=1,c=bu(a,1)):1===o&&a[0]>="\ud800"&&a[0]<="\udbff"&&(o=2,c=bu(a,2));var d=bu(a,0,o),f=void 0;vu.test(c||s)&&(0===(o-=(f=gu.exec(d))?f[0].length:0)&&(o=1),c=bu(a,o),d=bu(a,0,o)),xu.test(c)&&(f=yu.exec(d))&&d!==f[0]&&(c=bu(a,o-=f[0].length),d=bu(a,0,o)),(0===r.length||(d=d.trim()).length>0)&&r.push(d),t=n(a=c||s)}return(0===r.length||(a=a.trim()).length>0)&&r.push(a),r}var Cu,wu,Ru,Iu,Ou,Mu,Pu,ku,Du=/^(click)(\s)*=|(param)(\s)*=/,Bu=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,Lu=e("HtmlTextParser",function(){function e(){i(this,e),this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}return r(e,[{key:"parse",value:function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,i=e.length;t<i;){var n=e.indexOf(">",t),r=-1;if(n>=0)(r=e.lastIndexOf("<",n))<t-1&&(r=e.indexOf("<",n+1),n=e.indexOf(">",r+1));if(r<0)this._stack.pop(),this._processResult(e.substring(t)),t=i;else{var a=e.substring(t,r),o=e.substring(r+1,n);""===o&&(a=e.substring(t,n+1)),this._processResult(a),-1===n?n=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(o),t=n+1}}return this._resultObjectArray}},{key:"_attributeToObject",value:function(e){var t={},i=(e=e.trim()).match(/^(color|size)(\s)*=/),n="",r=0,a="";if(i){if(n=i[0],""===(e=e.substring(n.length).trim()))return t;switch(r=e.indexOf(" "),n[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(a=e.substring(r+1).trim(),t.event=this._processEventHandler(a)),t}if((i=e.match(/^(br(\s)*\/)/))&&i[0].length>0&&(n=i[0].trim()).startsWith("br")&&"/"===n[n.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var o="";if((i=e.match(/^(img(\s)*src(\s)*=[^>]+\/)/))&&i[0].length>0&&(n=i[0].trim()).startsWith("img")&&"/"===n[n.length-1]){var s;i=e.match(Bu);for(var l=!1;i;){if(n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),s=(r=(o=e.substring(n.length).trim()).indexOf(" "))>-1?o.substr(0,r):o,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=o.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===n){switch(s.charCodeAt(0)){case 34:case 39:l=!0,s=s.slice(1,-1)}t.isImage=!0,t.src=s}else if("height"===n)t.imageHeight=parseInt(s);else if("width"===n)t.imageWidth=parseInt(s);else if("align"===n){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}t.imageAlign=s.toLocaleLowerCase()}else"offset"===n?t.imageOffset=s:"click"===n&&(t.event=this._processEventHandler(n+"="+s));t.event&&"param"===n&&(t.event[n]=s.replace(/^\"|\"$/g,"")),i=e.match(Bu)}return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(i=e.match(/^(outline(\s)*[^>]*)/)){var c={color:"#ffffff",width:1};if(e=i[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(i=e.match(h);i;)n=(e=e.substring(e.indexOf(i[0]))).substr(0,i[0].length),u=(r=(o=e.substring(n.length).trim()).indexOf(" "))>-1?o.substr(0,r):o,n=(n=n.replace(/[^a-zA-Z]/g,"").trim()).toLocaleLowerCase(),e=o.substring(r).trim(),"click"===n?t.event=this._processEventHandler(n+"="+u):"color"===n?c.color=u:"width"===n&&(c.width=parseInt(u)),t.event&&"param"===n&&(t.event[n]=u.replace(/^\"|\"$/g,"")),i=e.match(h)}t.outline=c}if((i=e.match(/^(on|u|b|i)(\s)*/))&&i[0].length>0){switch(n=i[0],e=e.substring(n.length).trim(),n[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t}},{key:"_processEventHandler",value:function(e){for(var t=new Map,i=0,n=!1,r=e.match(Du);r;){var a=r[0],o="";if(n=!1,'"'===(e=e.substring(a.length).trim()).charAt(0))(i=e.indexOf('"',1))>-1&&(o=e.substring(1,i).trim(),n=!0),i++;else if("'"===e.charAt(0))(i=e.indexOf("'",1))>-1&&(o=e.substring(1,i).trim(),n=!0),i++;else{var s=e.match(/(\S)+/);i=(o=s?s[0]:"").length}n&&(t[a=a.substring(0,a.length-1).trim()]=o),r=(e=e.substring(i).trim()).match(Du)}return t}},{key:"_addToStack",value:function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var i=this._stack[this._stack.length-1];for(var n in i)t[n]||(t[n]=i[n]);this._stack.push(t)}}},{key:"_processResult",value:function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))}},{key:"_escapeSpecialSymbol",value:function(e){for(var t,i=y(this._specialSymbolArray);!(t=i()).done;){var n=t.value,r=n[0],a=n[1];e=e.replace(r,a)}return e}}]),e}()),Nu=e("PrefabInfo",ii("cc.PrefabInfo")((Ru=S((wu=function e(){i(this,e),x(this,"root",Ru,this),x(this,"asset",Iu,this),x(this,"fileId",Ou,this),x(this,"sync",Mu,this),x(this,"_synced",Pu,this)}).prototype,"root",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Iu=S(wu.prototype,"asset",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ou=S(wu.prototype,"fileId",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Mu=S(wu.prototype,"sync",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pu=S(wu.prototype,"_synced",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{default:!1,serializable:!1}}}),Cu=wu))||Cu);E._PrefabInfo=Nu;var Fu=(a(ku={},Cs.UNORM,"Uint"),a(ku,Cs.SNORM,"Int"),a(ku,Cs.UINT,"Uint"),a(ku,Cs.INT,"Int"),a(ku,Cs.UFLOAT,"Float"),a(ku,Cs.FLOAT,"Float"),a(ku,"default","Uint"),ku);function zu(e){return(Fu[e.type]||Fu.default)+e.size/e.count*8}function Uu(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:jo.R32F,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=Ds[i];r||(r=a.size);for(var o="set"+zu(a),s=a.size/a.count,l=Math.floor(t.length/a.count),c=Gn.isLittleEndian,u=0;u<l;++u)for(var h=n+r*u,_=0;_<a.count;++_){var d=h+s*_;e[o](d,t[a.count*u+_],c)}}function Gu(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:jo.R32F,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.byteLength-i,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[],o=Ds[t];r||(r=o.size);for(var s="get"+zu(o),l=o.size/o.count,c=Math.floor(n/r),u=Gn.isLittleEndian,h=0;h<c;++h)for(var _=i+r*h,d=0;d<o.count;++d){var f=_+l*d;a[o.count*h+d]=e[s](f,u)}return a}function Hu(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:jo.R32F,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:e.byteLength-n,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=arguments.length>6?arguments[6]:void 0;o||(o=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=Ds[i];a||(a=s.size);for(var l="set"+zu(s),c="get"+zu(s),u=s.size/s.count,h=Math.floor(r/a),_=Gn.isLittleEndian,d=0;d<h;++d)for(var f=n+a*d,p=0;p<s.count;++p){var m=f+u*p,v=e[c](m,_);o[l](m,t(v,p,e),_)}return o}var Vu=function(){function e(){i(this,e),this._arrayBufferOrPaddings=[],this._length=0}return r(e,[{key:"setNextAlignment",value:function(e){if(0!==e){var t=this._length%e;if(0!==t){var i=e-t;this._arrayBufferOrPaddings.push(i),this._length+=i}}}},{key:"addBuffer",value:function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t}},{key:"getLength",value:function(){return this._length}},{key:"getCombined",value:function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(i){"number"==typeof i?t+=i:(e.set(new Uint8Array(i),t),t+=i.byteLength)})),e.buffer}}]),e}();var Wu,ju,qu,Xu,Yu,Ku,Zu,Qu=1024;!function(e){e[e.RGB565=jo.R5G6B5]="RGB565",e[e.RGB5A1=jo.RGB5A1]="RGB5A1",e[e.RGBA4444=jo.RGBA4]="RGBA4444",e[e.RGB888=jo.RGB8]="RGB888",e[e.RGB32F=jo.RGB32F]="RGB32F",e[e.RGBA8888=jo.RGBA8]="RGBA8888",e[e.RGBA32F=jo.RGBA32F]="RGBA32F",e[e.A8=jo.A8]="A8",e[e.I8=jo.L8]="I8",e[e.AI8=jo.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=jo.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=jo.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Qu++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=jo.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=jo.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Qu++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=jo.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Qu++]="RGBA_ETC1",e[e.RGB_ETC2=jo.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=jo.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=jo.ASTC_RGBA_4x4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=jo.ASTC_RGBA_5x4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=jo.ASTC_RGBA_5x5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=jo.ASTC_RGBA_6x5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=jo.ASTC_RGBA_6x6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=jo.ASTC_RGBA_8x5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=jo.ASTC_RGBA_8x6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=jo.ASTC_RGBA_8x8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=jo.ASTC_RGBA_10x5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=jo.ASTC_RGBA_10x6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=jo.ASTC_RGBA_10x8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=jo.ASTC_RGBA_10x10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=jo.ASTC_RGBA_12x10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=jo.ASTC_RGBA_12x12]="RGBA_ASTC_12x12"}(Wu||(Wu={})),function(e){e[e.REPEAT=os.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=os.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=os.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=os.BORDER]="CLAMP_TO_BORDER"}(ju||(ju={})),function(e){e[e.NONE=as.NONE]="NONE",e[e.LINEAR=as.LINEAR]="LINEAR",e[e.NEAREST=as.POINT]="NEAREST"}(qu||(qu={}));var Ju,$u=e("ImageAsset",ii("cc.ImageAsset")((Zu=Ku=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this)))._nativeData=void 0,n._tex=void 0,n._url=void 0,n._exportedExts=void 0,n._format=Wu.RGBA8888,n._width=0,n._height=0,n._url="",n.loaded=!1,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&n.reset(e),n}return o(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData instanceof HTMLImageElement||this._nativeData instanceof HTMLCanvasElement?this._nativeData:this._nativeData._data}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Wu.RGB_ETC1&&this._format<=Wu.RGBA_ASTC_12x12||this._format>=Wu.RGB_A_PVRTC_2BPPV1&&this._format<=Wu.RGBA_ETC1}},{key:"url",get:function(){return this._url}},{key:"_texture",set:function(e){this._tex=e},get:function(){if(!this._tex){var e=new E.Texture2D;e.name=this._url,e.image=this,this._tex=e}return this._tex}}]),r(t,[{key:"reset",value:function(e){var t=this;e instanceof HTMLElement?(this._nativeData=e,e.complete||e instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,e.addEventListener("load",(function(){t._onDataComplete()})),e.addEventListener("error",(function(e){G(3119,e.message)})))):(this._nativeData=e,this._format=e.format,this._onDataComplete())}},{key:"destroy",value:function(){return this.data&&this.data instanceof HTMLImageElement&&(this.data.src="",this._setRawAsset(""),E.loader.removeItem(this.data.id)),_(s(t.prototype),"destroy",this).call(this)}},{key:"_serialize",value:function(){var e=this._exportedExts;if(!e&&this._native&&(e=[this._native]),!e)return"";for(var i,n=[],r=y(e);!(i=r()).done;){var a=i.value,o=a.split("@"),s=t.extnames.indexOf(o[0]),l=s<0?a:"".concat(s);o[1]&&(l+="@"+o[1]),n.push(l)}return{fmt:n.join("_"),w:this.width,h:this.height}}},{key:"_deserialize",value:function(e,i){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var r,a=E.director.root?E.director.root.device:null,o=n.split("_"),s=Number.MAX_VALUE,l=this._format,c="",u=E.macro.SUPPORT_TEXTURE_FORMATS,h=y(o);!(r=h()).done;){var _=r.value.split("@"),d=parseInt(_[0],void 0),f=t.extnames[d]||_.join(),p=u.indexOf(f);if(-1!==p&&p<s){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==f||a&&a.hasFeature(Gs.FORMAT_ASTC)))continue;if(!(".pvr"!==f||a&&a.hasFeature(Gs.FORMAT_PVRTC)))continue;if(!(m!==Wu.RGB_ETC1&&m!==Wu.RGBA_ETC1||a&&a.hasFeature(Gs.FORMAT_ETC1)))continue;if(!(m!==Wu.RGB_ETC2&&m!==Wu.RGBA_ETC2||a&&a.hasFeature(Gs.FORMAT_ETC2)))continue;if(".webp"===f&&!E.sys.capabilities.webp)continue;s=p,c=f,l=m}}c&&(this._setRawAsset(c),this._format=l);var v=i.customEnv,g=v&&v.uuid;g&&(this._uuid=g,this._url=this.nativeUrl)}},{key:"_onDataComplete",value:function(){this.loaded=!0,this.emit("load")}}]),t}(cn),Ku.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],S((Yu=Zu).prototype,"_nativeAsset",[Ni],Object.getOwnPropertyDescriptor(Yu.prototype,"_nativeAsset"),Yu.prototype),Xu=Yu))||Xu);E.ImageAsset=$u,function(e){e[e.minFilter=0]="minFilter",e[e.magFilter=1]="magFilter",e[e.mipFilter=2]="mipFilter",e[e.addressU=3]="addressU",e[e.addressV=4]="addressV",e[e.addressW=5]="addressW",e[e.maxAnisotropy=6]="maxAnisotropy",e[e.cmpFunc=7]="cmpFunc",e[e.minLOD=8]="minLOD",e[e.maxLOD=9]="maxLOD",e[e.mipLODBias=10]="mipLODBias",e[e.total=11]="total"}(Ju||(Ju={}));var eh=[as.LINEAR,as.LINEAR,as.NONE,os.WRAP,os.WRAP,os.WRAP,8,es.NEVER,0,0,0],th=rh(eh),ih=new As,nh=new Sl;function rh(e){for(var t=0,i=0,n=0;n<eh.length;n++)switch(t=e[n]||eh[n],n){case Ju.minFilter:i|=t;break;case Ju.magFilter:i|=t<<2;break;case Ju.mipFilter:i|=t<<4;break;case Ju.addressU:i|=t<<6;break;case Ju.addressV:i|=t<<8;break;case Ju.addressW:i|=t<<10;break;case Ju.maxAnisotropy:i|=t<<12;break;case Ju.cmpFunc:i|=t<<16;break;case Ju.minLOD:i|=t<<20;break;case Ju.maxLOD:i|=t<<24;break;case Ju.mipLODBias:i|=t<<28}return i}var ah,oh,sh,lh,ch,uh,hh,_h,dh,fh,ph,mh,vh=new(function(){function e(){i(this,e),this._cache={}}return r(e,[{key:"getSampler",value:function(e,t){0===t&&(t=th);var i=this._cache[t];return i||(nh.minFilter=3&t,nh.magFilter=t>>2&3,nh.mipFilter=t>>4&3,nh.addressU=t>>6&3,nh.addressV=t>>8&3,nh.addressW=t>>10&3,nh.maxAnisotropy=t>>12&15,nh.cmpFunc=t>>16&15,nh.minLOD=t>>20&15,nh.maxLOD=t>>24&15,nh.mipLODBias=t>>28&15,nh.borderColor=ih,this._cache[t]=e.createSampler(nh))}}]),e}());E.samplerLib=vh;var gh=new ie("Tex"),yh=ii("cc.TextureBase")((mh=ph=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_format",sh,c(e)),x(e,"_minFilter",lh,c(e)),x(e,"_magFilter",ch,c(e)),x(e,"_mipFilter",uh,c(e)),x(e,"_wrapS",hh,c(e)),x(e,"_wrapT",_h,c(e)),x(e,"_wrapR",dh,c(e)),x(e,"_anisotropy",fh,c(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=[],e._samplerHash=0,e._gfxSampler=null,e._gfxDevice=null,e._id=gh.getNewId(),e.loaded=!1,e._gfxDevice=e._getGFXDevice(),e}return o(t,e),r(t,[{key:"isCompressed",get:function(){return this._format>=Wu.RGB_ETC1&&this._format<=Wu.RGBA_PVRTC_4BPPV1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),r(t,[{key:"getId",value:function(){return this._id}},{key:"getPixelFormat",value:function(){return this._format}},{key:"getAnisotropy",value:function(){return this._anisotropy}},{key:"setWrapMode",value:function(e,t,i){this._wrapS=e,this._samplerInfo[Ju.addressU]=e,this._wrapT=t,this._samplerInfo[Ju.addressV]=t,void 0!==i&&(this._wrapR=i,this._samplerInfo[Ju.addressW]=i),this._samplerHash=rh(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=vh.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setFilters",value:function(e,t){this._minFilter=e,this._samplerInfo[Ju.minFilter]=e,this._magFilter=t,this._samplerInfo[Ju.magFilter]=t,this._samplerHash=rh(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=vh.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setMipFilter",value:function(e){this._mipFilter=e,this._samplerInfo[Ju.mipFilter]=e,this._samplerInfo[Ju.maxLOD]=e===qu.NONE?0:15,this._samplerHash=rh(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=vh.getSampler(this._gfxDevice,this._samplerHash))}},{key:"setAnisotropy",value:function(e){this._anisotropy=e,this._samplerInfo[Ju.maxAnisotropy]=e,this._samplerHash=rh(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=vh.getSampler(this._gfxDevice,this._samplerHash))}},{key:"destroy",value:function(){return _(s(t.prototype),"destroy",this).call(this)}},{key:"getGFXTexture",value:function(){return null}},{key:"getSamplerHash",value:function(){return this._samplerHash}},{key:"getGFXSampler",value:function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=vh.getSampler(this._gfxDevice,this._samplerHash):V(9302)),this._gfxSampler}},{key:"_serialize",value:function(e){return this._minFilter+","+this._magFilter+","+this._wrapS+","+this._wrapT+","+this._mipFilter+","+this._anisotropy}},{key:"_deserialize",value:function(e,t){var i=e.split(",");i.unshift(""),i.length>=5&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4]))),i.length>=7&&(this.setMipFilter(parseInt(i[5])),this.setAnisotropy(parseInt(i[6])))}},{key:"_getGFXDevice",value:function(){return E.director.root&&E.director.root.device}},{key:"_getGFXFormat",value:function(){return this._getGFXPixelFormat(this._format)}},{key:"_setGFXFormat",value:function(e){this._format=void 0===e?Wu.RGBA8888:e}},{key:"_getGFXPixelFormat",value:function(e){return e===Wu.RGBA_ETC1?e=Wu.RGB_ETC1:e===Wu.RGB_A_PVRTC_4BPPV1?e=Wu.RGB_PVRTC_4BPPV1:e===Wu.RGB_A_PVRTC_2BPPV1&&(e=Wu.RGB_PVRTC_2BPPV1),e}}]),t}(cn),ph.PixelFormat=Wu,ph.WrapMode=ju,ph.Filter=qu,sh=S((oh=mh).prototype,"_format",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wu.RGBA8888}}),lh=S(oh.prototype,"_minFilter",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qu.LINEAR}}),ch=S(oh.prototype,"_magFilter",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qu.LINEAR}}),uh=S(oh.prototype,"_mipFilter",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qu.NONE}}),hh=S(oh.prototype,"_wrapS",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ju.REPEAT}}),_h=S(oh.prototype,"_wrapT",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ju.REPEAT}}),dh=S(oh.prototype,"_wrapR",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ju.REPEAT}}),fh=S(oh.prototype,"_anisotropy",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),ah=oh))||ah;E.TextureBase=yh;var xh,Sh=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,DOWNLOAD_MAX_CONCURRENT:64,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0});E.macro=Sh;var Th=[new Ms];function Eh(e){return e&&0==(e&e-1)}var bh,Ah,Ch,wh,Rh,Ih=ii("cc.SimpleTexture")(xh=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gfxTexture=null,n._mipmapLevel=1,n}return o(t,e),r(t,[{key:"getGFXTexture",value:function(){return this._gfxTexture}},{key:"destroy",value:function(){return this._tryDestroyTexture(),_(s(t.prototype),"destroy",this).call(this)}},{key:"updateImage",value:function(){this.updateMipmaps(0)}},{key:"updateMipmaps",value:function(){}},{key:"uploadData",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this._gfxTexture&&!(this._gfxTexture.levelCount<=t)){var n=this._getGFXDevice();if(n){var r=Th[0];r.texExtent.width=this._gfxTexture.width>>t,r.texExtent.height=this._gfxTexture.height>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=i,ArrayBuffer.isView(e)?n.copyBuffersToTexture([e],this._gfxTexture,Th):n.copyTexImagesToTexture([e],this._gfxTexture,Th)}}}},{key:"_assignImage",value:function(e,t,i){var n=this,r=function(){var r=e.data;r&&(n.uploadData(r,t,i),n._checkTextureLoaded(),Sh.CLEANUP_IMAGE_CACHE&&E.loader.release(e))};if(e.loaded)r();else{if(e.once("load",(function(){r()})),!this.isCompressed){var a=E.builtinResMgr.get("black-texture").image;this.uploadData(a.data,t,i)}E.textureUtil.postLoadImage(e)}}},{key:"_checkTextureLoaded",value:function(){this._textureReady()}},{key:"_textureReady",value:function(){this.loaded=!0,this.emit("load")}},{key:"_setMipmapLevel",value:function(e){this._mipmapLevel=e<1?1:e}},{key:"_getGfxTextureCreateInfo",value:function(e){return null}},{key:"_tryReset",value:function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}}},{key:"_createTexture",value:function(e){var t=us.NONE;this._mipFilter!==qu.NONE&&function(e,t,i){return!(e.gfxAPI===Us.WEBGL)||Eh(t)&&Eh(i)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var i=Math.max(e,t),n=0;i;)i>>=1,n++;return n}(this._width,this._height),t=us.GEN_MIPMAP);var i=this._getGfxTextureCreateInfo({usage:ls.SAMPLED|ls.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(i){var n=e.createTexture(i);this._gfxTexture=n}}},{key:"_tryDestroyTexture",value:function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}},{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(yh))||xh;E.SimpleTexture=Ih;var Oh=e("Texture2D",(bh=ii("cc.Texture2D"),Ah=Li([$u]),bh((Rh=S((wh=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_mipmaps",Rh,c(n)),n}return o(t,e),r(t,[{key:"initialize",value:function(){this.mipmaps=this._mipmaps}},{key:"onLoaded",value:function(){this.initialize()}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"create",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Wu.RGBA8888,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.reset({width:e,height:t,format:i,mipmapLevel:n})}},{key:"toString",value:function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}},{key:"updateMipmaps",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0;if(!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),n=0;n<i;++n){var r=e+n;this._assignImage(this._mipmaps[r],r)}}},{key:"getHtmlElementObj",value:function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}},{key:"destroy",value:function(){return this._mipmaps=[],_(s(t.prototype),"destroy",this).call(this)}},{key:"description",value:function(){var e=this._mipmaps[0]?this._mipmaps[0].url:"";return"<cc.Texture2D | Name = ".concat(e," | Dimension = ").concat(this.width," x ").concat(this.height,">")}},{key:"releaseTexture",value:function(){this.destroy()}},{key:"_serialize",value:function(e){return{base:_(s(t.prototype),"_serialize",this).call(this,e),mipmaps:this._mipmaps.map((function(t){return t&&t._uuid?e?EditorExtends.UuidUtils.compressUuid(t._uuid,!0):t._uuid:null}))}}},{key:"_deserialize",value:function(e,i){var n=e;_(s(t.prototype),"_deserialize",this).call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r)if(this._mipmaps[r]=new $u,n.mipmaps[r]){var a=n.mipmaps[r];i.result.push(this._mipmaps,"".concat(r),a),this._mipmaps[r]._texture=this}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=new Il(ss.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)}},{key:"_checkTextureLoaded",value:function(){for(var e=!0,i=0;i<this._mipmaps.length;++i){if(!this._mipmaps[i].loaded){e=!1;break}}e&&_(s(t.prototype),"_textureReady",this).call(this)}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0];this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,i){t._assignImage(e,i)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(Ih)).prototype,"_mipmaps",[Ah],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ch=wh))||Ch));E.Texture2D=Oh;var Mh={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Ph=e("Layers",function(){function e(){i(this,e)}return r(e,null,[{key:"makeMaskInclude",value:function(e){for(var t,i=0,n=y(e);!(t=n()).done;){i|=t.value}return i}},{key:"makeMaskExclude",value:function(t){return~e.makeMaskInclude(t)}},{key:"addLayer",value:function(t,i){void 0!==i?i>19||i<0?console.warn("maximum layers reached."):(e.Enum[t]=1<<i,e.Enum[i]=t,e.BitMask[t]=1<<i,e.BitMask[i]=t):console.warn("bitNum can't be undefined")}},{key:"deleteLayer",value:function(t){t>19||t<0?console.warn("do not change buildin layers."):(delete e.Enum[e.Enum[t]],delete e.Enum[t],delete e.BitMask[e.BitMask[t]],delete e.BitMask[t])}}]),e}());Ph.Enum=et(Mh),Ph.BitMask=$e(Object.assign({},Mh)),E.Layers=Ph;var kh,Dh;!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(kh||(kh={})),E.RenderPassStage=kh,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Dh||(Dh={}));var Bh,Lh={bindings:[],layouts:{}},Nh={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_SHADOW=1]="UBO_SHADOW",e[e.SAMPLER_ENVIRONMENT=2]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_GBUFFER_ALBEDOMAP=4]="SAMPLER_GBUFFER_ALBEDOMAP",e[e.SAMPLER_GBUFFER_POSITIONMAP=5]="SAMPLER_GBUFFER_POSITIONMAP",e[e.SAMPLER_GBUFFER_NORMALMAP=6]="SAMPLER_GBUFFER_NORMALMAP",e[e.SAMPLER_GBUFFER_EMISSIVEMAP=7]="SAMPLER_GBUFFER_EMISSIVEMAP",e[e.COUNT=8]="COUNT"}(Bh||(Bh={}));var Fh,zh=Bh.SAMPLER_ENVIRONMENT,Uh=Bh.COUNT-zh;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=9]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",e[e.COUNT=11]="COUNT"}(Fh||(Fh={}));var Gh,Hh=Fh.SAMPLER_JOINTS,Vh=Fh.COUNT-Hh;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(Gh||(Gh={}));var Wh=new Qs;Wh.bufferOffsets=[0,zh+Hh,zh],Wh.samplerOffsets=[-zh,Uh+Vh,Uh-Hh],Wh.flexibleSet=1;var jh=function e(){i(this,e)};jh.SIZE=4*(jh.COUNT=(jh.GLOBAL_FOG_ADD_OFFSET=(jh.GLOBAL_FOG_BASE_OFFSET=(jh.GLOBAL_FOG_COLOR_OFFSET=(jh.AMBIENT_GROUND_OFFSET=(jh.AMBIENT_SKY_OFFSET=(jh.MAIN_LIT_COLOR_OFFSET=(jh.MAIN_LIT_DIR_OFFSET=(jh.EXPOSURE_OFFSET=(jh.CAMERA_POS_OFFSET=(jh.MAT_VIEW_PROJ_INV_OFFSET=(jh.MAT_VIEW_PROJ_OFFSET=(jh.MAT_PROJ_INV_OFFSET=(jh.MAT_PROJ_OFFSET=(jh.MAT_VIEW_INV_OFFSET=(jh.MAT_VIEW_OFFSET=(jh.NATIVE_SIZE_OFFSET=(jh.SCREEN_SCALE_OFFSET=(jh.SCREEN_SIZE_OFFSET=(jh.TIME_OFFSET=0)+4)+4)+4)+4)+16)+16)+16)+16)+16)+16)+4)+4)+4)+4)+4)+4)+4)+4)+4),jh.NAME="CCGlobal",jh.BINDING=Bh.UBO_GLOBAL,jh.DESCRIPTOR=new Nl(_s.UNIFORM_BUFFER,1,hs.ALL),jh.LAYOUT=new Al(Gh.GLOBAL,jh.BINDING,jh.NAME,[new bl("cc_time",Wo.FLOAT4,1),new bl("cc_screenSize",Wo.FLOAT4,1),new bl("cc_screenScale",Wo.FLOAT4,1),new bl("cc_nativeSize",Wo.FLOAT4,1),new bl("cc_matView",Wo.MAT4,1),new bl("cc_matViewInv",Wo.MAT4,1),new bl("cc_matProj",Wo.MAT4,1),new bl("cc_matProjInv",Wo.MAT4,1),new bl("cc_matViewProj",Wo.MAT4,1),new bl("cc_matViewProjInv",Wo.MAT4,1),new bl("cc_cameraPos",Wo.FLOAT4,1),new bl("cc_exposure",Wo.FLOAT4,1),new bl("cc_mainLitDir",Wo.FLOAT4,1),new bl("cc_mainLitColor",Wo.FLOAT4,1),new bl("cc_ambientSky",Wo.FLOAT4,1),new bl("cc_ambientGround",Wo.FLOAT4,1),new bl("cc_fogColor",Wo.FLOAT4,1),new bl("cc_fogBase",Wo.FLOAT4,1),new bl("cc_fogAdd",Wo.FLOAT4,1)],1),Lh.layouts[jh.NAME]=jh.LAYOUT,Lh.bindings[jh.BINDING]=jh.DESCRIPTOR;var qh=function e(){i(this,e)};qh.SIZE=4*(qh.COUNT=(qh.SHADOW_SIZE_OFFSET=(qh.SHADOW_PCF_OFFSET=(qh.SHADOW_COLOR_OFFSET=(qh.MAT_LIGHT_VIEW_PROJ_OFFSET=(qh.MAT_LIGHT_PLANE_PROJ_OFFSET=0)+16)+16)+4)+4)+4),qh.NAME="CCShadow",qh.BINDING=Bh.UBO_SHADOW,qh.DESCRIPTOR=new Nl(_s.UNIFORM_BUFFER,1,hs.ALL),qh.LAYOUT=new Al(Gh.GLOBAL,qh.BINDING,qh.NAME,[new bl("cc_matLightPlaneProj",Wo.MAT4,1),new bl("cc_matLightViewProj",Wo.MAT4,1),new bl("cc_shadowColor",Wo.FLOAT4,1),new bl("cc_shadowPCF",Wo.FLOAT4,1),new bl("cc_shadowSize",Wo.FLOAT4,1)],1),Lh.layouts[qh.NAME]=qh.LAYOUT,Lh.bindings[qh.BINDING]=qh.DESCRIPTOR;var Xh=Bh.SAMPLER_SHADOWMAP,Yh=new Nl(_s.SAMPLER,1,hs.FRAGMENT),Kh=new Cl(Gh.GLOBAL,Xh,"cc_shadowMap",Wo.SAMPLER2D,1);Lh.layouts.cc_shadowMap=Kh,Lh.bindings[Xh]=Yh;var Zh=Bh.SAMPLER_GBUFFER_ALBEDOMAP,Qh=new Nl(_s.SAMPLER,1,hs.FRAGMENT),Jh=new Cl(Gh.GLOBAL,Zh,"cc_gbuffer_albedoMap",Wo.SAMPLER2D,1);Lh.layouts.cc_gbuffer_albedoMap=Jh,Lh.bindings[Zh]=Qh;var $h=Bh.SAMPLER_GBUFFER_POSITIONMAP,e_=new Nl(_s.SAMPLER,1,hs.FRAGMENT),t_=new Cl(Gh.GLOBAL,$h,"cc_gbuffer_positionMap",Wo.SAMPLER2D,1);Lh.layouts.cc_gbuffer_positionMap=t_,Lh.bindings[$h]=e_;var i_=Bh.SAMPLER_GBUFFER_NORMALMAP,n_=new Nl(_s.SAMPLER,1,hs.FRAGMENT),r_=new Cl(Gh.GLOBAL,i_,"cc_gbuffer_normalMap",Wo.SAMPLER2D,1);Lh.layouts.cc_gbuffer_normalMap=r_,Lh.bindings[i_]=n_;var a_=Bh.SAMPLER_GBUFFER_EMISSIVEMAP,o_=new Nl(_s.SAMPLER,1,hs.FRAGMENT),s_=new Cl(Gh.GLOBAL,a_,"cc_gbuffer_emissiveMap",Wo.SAMPLER2D,1);Lh.layouts.cc_gbuffer_emissiveMap=s_,Lh.bindings[a_]=o_;var l_=Bh.SAMPLER_ENVIRONMENT,c_=new Cl(Gh.GLOBAL,l_,"cc_environment",Wo.SAMPLER_CUBE,1),u_=new Nl(_s.SAMPLER,1,hs.FRAGMENT);Lh.layouts.cc_environment=c_,Lh.bindings[l_]=u_;var h_=function e(){i(this,e)};h_.SIZE=4*(h_.COUNT=(h_.LIGHTINGMAP_UVPARAM=(h_.MAT_WORLD_IT_OFFSET=(h_.MAT_WORLD_OFFSET=0)+16)+16)+4),h_.NAME="CCLocal",h_.BINDING=Fh.UBO_LOCAL,h_.DESCRIPTOR=new Nl(_s.UNIFORM_BUFFER,1,hs.VERTEX),h_.LAYOUT=new Al(Gh.LOCAL,h_.BINDING,h_.NAME,[new bl("cc_matWorld",Wo.MAT4,1),new bl("cc_matWorldIT",Wo.MAT4,1),new bl("cc_lightingMapUVParam",Wo.FLOAT4,1)],1),Nh.layouts[h_.NAME]=h_.LAYOUT,Nh.bindings[h_.BINDING]=h_.DESCRIPTOR;var __=function e(){i(this,e)};__.BATCHING_COUNT=10,__.MAT_WORLDS_OFFSET=0,__.SIZE=4*(__.COUNT=16*__.BATCHING_COUNT),__.NAME="CCLocalBatched",__.BINDING=Fh.UBO_LOCAL,__.DESCRIPTOR=new Nl(_s.UNIFORM_BUFFER,1,hs.VERTEX),__.LAYOUT=new Al(Gh.LOCAL,__.BINDING,__.NAME,[new bl("cc_matWorlds",Wo.MAT4,__.BATCHING_COUNT)],1),Nh.layouts[__.NAME]=__.LAYOUT,Nh.bindings[__.BINDING]=__.DESCRIPTOR;var d_=function e(){i(this,e)};d_.LIGHTS_PER_PASS=1,d_.SIZE=4*(d_.COUNT=(d_.LIGHT_DIR_OFFSET=(d_.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(d_.LIGHT_COLOR_OFFSET=(d_.LIGHT_POS_OFFSET=0)+4*d_.LIGHTS_PER_PASS)+4*d_.LIGHTS_PER_PASS)+4*d_.LIGHTS_PER_PASS)+4*d_.LIGHTS_PER_PASS),d_.NAME="CCForwardLight",d_.BINDING=Fh.UBO_FORWARD_LIGHTS,d_.DESCRIPTOR=new Nl(_s.DYNAMIC_UNIFORM_BUFFER,1,hs.FRAGMENT),d_.LAYOUT=new Al(Gh.LOCAL,d_.BINDING,d_.NAME,[new bl("cc_lightPos",Wo.FLOAT4,d_.LIGHTS_PER_PASS),new bl("cc_lightColor",Wo.FLOAT4,d_.LIGHTS_PER_PASS),new bl("cc_lightSizeRangeAngle",Wo.FLOAT4,d_.LIGHTS_PER_PASS),new bl("cc_lightDir",Wo.FLOAT4,d_.LIGHTS_PER_PASS)],1),Nh.layouts[d_.NAME]=d_.LAYOUT,Nh.bindings[d_.BINDING]=d_.DESCRIPTOR;var f_=function e(){i(this,e)};f_.SIZE=4*(f_.COUNT=(f_.JOINTS_TEXTURE_INFO_OFFSET=0)+4),f_.NAME="CCSkinningTexture",f_.BINDING=Fh.UBO_SKINNING_TEXTURE,f_.DESCRIPTOR=new Nl(_s.UNIFORM_BUFFER,1,hs.VERTEX),f_.LAYOUT=new Al(Gh.LOCAL,f_.BINDING,f_.NAME,[new bl("cc_jointTextureInfo",Wo.FLOAT4,1)],1),Nh.layouts[f_.NAME]=f_.LAYOUT,Nh.bindings[f_.BINDING]=f_.DESCRIPTOR;var p_=function e(){i(this,e)};p_.SIZE=4*(p_.COUNT=(p_.JOINTS_ANIM_INFO_OFFSET=0)+4),p_.NAME="CCSkinningAnimation",p_.BINDING=Fh.UBO_SKINNING_ANIMATION,p_.DESCRIPTOR=new Nl(_s.UNIFORM_BUFFER,1,hs.VERTEX),p_.LAYOUT=new Al(Gh.LOCAL,p_.BINDING,p_.NAME,[new bl("cc_jointAnimInfo",Wo.FLOAT4,1)],1),Nh.layouts[p_.NAME]=p_.LAYOUT,Nh.bindings[p_.BINDING]=p_.DESCRIPTOR;var m_=function e(){i(this,e)};m_.SIZE=4*(m_.COUNT=(m_.JOINTS_OFFSET=0)+360),m_.NAME="CCSkinning",m_.BINDING=Fh.UBO_SKINNING_TEXTURE,m_.DESCRIPTOR=new Nl(_s.UNIFORM_BUFFER,1,hs.VERTEX),m_.LAYOUT=new Al(Gh.LOCAL,m_.BINDING,m_.NAME,[new bl("cc_joints",Wo.FLOAT4,90)],1),Nh.layouts[m_.NAME]=m_.LAYOUT,Nh.bindings[m_.BINDING]=m_.DESCRIPTOR;var v_=function e(){i(this,e)};v_.MAX_MORPH_TARGET_COUNT=60,v_.OFFSET_OF_WEIGHTS=0,v_.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=(v_.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*v_.MAX_MORPH_TARGET_COUNT)+4,v_.COUNT_BASE_4_BYTES=4*Math.ceil(v_.MAX_MORPH_TARGET_COUNT/4)+4,v_.SIZE=4*v_.COUNT_BASE_4_BYTES,v_.NAME="CCMorph",v_.BINDING=Fh.UBO_MORPH,v_.DESCRIPTOR=new Nl(_s.UNIFORM_BUFFER,1,hs.VERTEX),v_.LAYOUT=new Al(Gh.LOCAL,v_.BINDING,v_.NAME,[new bl("cc_displacementWeights",Wo.FLOAT4,v_.MAX_MORPH_TARGET_COUNT/4),new bl("cc_displacementTextureInfo",Wo.FLOAT4,1)],1),Nh.layouts[v_.NAME]=v_.LAYOUT,Nh.bindings[v_.BINDING]=v_.DESCRIPTOR;var g_=Fh.SAMPLER_JOINTS,y_=new Nl(_s.SAMPLER,1,hs.VERTEX),x_=new Cl(Gh.LOCAL,g_,"cc_jointTexture",Wo.SAMPLER2D,1);Nh.layouts.cc_jointTexture=x_,Nh.bindings[g_]=y_;var S_=Fh.SAMPLER_MORPH_POSITION,T_=new Nl(_s.SAMPLER,1,hs.VERTEX),E_=new Cl(Gh.LOCAL,S_,"cc_PositionDisplacements",Wo.SAMPLER2D,1);Nh.layouts.cc_PositionDisplacements=E_,Nh.bindings[S_]=T_;var b_=Fh.SAMPLER_MORPH_NORMAL,A_=new Nl(_s.SAMPLER,1,hs.VERTEX),C_=new Cl(Gh.LOCAL,b_,"cc_NormalDisplacements",Wo.SAMPLER2D,1);Nh.layouts.cc_NormalDisplacements=C_,Nh.bindings[b_]=A_;var w_=Fh.SAMPLER_MORPH_TANGENT,R_=new Nl(_s.SAMPLER,1,hs.VERTEX),I_=new Cl(Gh.LOCAL,w_,"cc_TangentDisplacements",Wo.SAMPLER2D,1);Nh.layouts.cc_TangentDisplacements=I_,Nh.bindings[w_]=R_;var O_=Fh.SAMPLER_LIGHTMAP,M_=new Nl(_s.SAMPLER,1,hs.FRAGMENT),P_=new Cl(Gh.LOCAL,O_,"cc_lightingMap",Wo.SAMPLER2D,1);Nh.layouts.cc_lightingMap=P_,Nh.bindings[O_]=M_;var k_=Fh.SAMPLER_SPRITE,D_=new Nl(_s.SAMPLER,1,hs.FRAGMENT),B_=new Cl(Gh.LOCAL,k_,"cc_spriteTexture",Wo.SAMPLER2D,1);Nh.layouts.cc_spriteTexture=B_,Nh.bindings[k_]=D_;var L_,N_,F_,z_,U_,G_=Ph.makeMaskExclude([Ph.BitMask.UI_2D,Ph.BitMask.GIZMOS,Ph.BitMask.EDITOR,Ph.BitMask.SCENE_GIZMO,Ph.BitMask.PROFILER]),H_=Ph.makeMaskExclude([Ph.BitMask.UI_2D,Ph.BitMask.PROFILER]),V_=Ph.Enum.ALL,W_=Object.freeze({__proto__:null,PIPELINE_FLOW_FORWARD:"ForwardFlow",PIPELINE_FLOW_GBUFFER:"GbufferFlow",PIPELINE_FLOW_LIGHTING:"LightingFlow",PIPELINE_FLOW_SHADOW:"ShadowFlow",PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return kh},get RenderPriority(){return Dh},globalDescriptorSetLayout:Lh,localDescriptorSetLayout:Nh,get PipelineGlobalBindings(){return Bh},get ModelLocalBindings(){return Fh},get SetIndex(){return Gh},bindingMappingInfo:Wh,UBOGlobal:jh,UBOShadow:qh,UNIFORM_SHADOWMAP_BINDING:Xh,UNIFORM_GBUFFER_ALBEDOMAP_BINDING:Zh,UNIFORM_GBUFFER_POSITIONMAP_BINDING:$h,UNIFORM_GBUFFER_NORMALMAP_BINDING:i_,UNIFORM_GBUFFER_EMISSIVEMAP_BINDING:a_,UNIFORM_ENVIRONMENT_BINDING:l_,UBOLocal:h_,INST_MAT_WORLD:"a_matWorld0",UBOLocalBatched:__,UBOForwardLight:d_,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:f_,UBOSkinningAnimation:p_,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:m_,UBOMorph:v_,UNIFORM_JOINT_TEXTURE_BINDING:g_,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:S_,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:b_,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:w_,UNIFORM_LIGHTMAP_TEXTURE_BINDING:O_,UNIFORM_SPRITE_TEXTURE_BINDING:k_,CAMERA_DEFAULT_MASK:G_,CAMERA_EDITOR_MASK:H_,MODEL_ALWAYS_MASK:V_}),j_=function(){function e(t,n){if(i(this,e),this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var r=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(r).fill(null);for(var a=0;a<r;++a){var o=this._mesh.struct.morph.subMeshMorphs[a];o&&(o.targets.length>v_.MAX_MORPH_TARGET_COUNT?G(10002,v_.MAX_MORPH_TARGET_COUNT,o.targets.length):this._subMeshRenderings[a]=new q_(this._mesh,a,this._mesh.struct.morph,n))}}}return r(e,[{key:"createInstance",value:function(){for(var e=this,t=this._mesh.struct.primitives.length,i=new Array(t),n=0;n<t;++n){var r,a;i[n]=null!==(r=null===(a=this._subMeshRenderings[n])||void 0===a?void 0:a.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var n;null===(n=i[e])||void 0===n||n.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var n=e._mesh.struct.morph.subMeshMorphs[t],r=i[t];if(null!==r){var a=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:n.targets.length}];return n.attributes.includes(Vo.ATTR_POSITION)&&a.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),n.attributes.includes(Vo.ATTR_NORMAL)&&a.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),n.attributes.includes(Vo.ATTR_TANGENT)&&a.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),a.push.apply(a,m(r.requiredPatches())),a}},adaptPipelineState:function(e,t){var n;null===(n=i[e])||void 0===n||n.adaptPipelineState(t)},destroy:function(){for(var e,t=y(i);!(e=t()).done;){var n=e.value;null==n||n.destroy()}}}}}]),e}(),q_=function(){function e(t,n,r,a){i(this,e),this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._gfxDevice=a;var o=r.subMeshMorphs[n];this._subMeshMorph=o,function(e,t,i){e.renderingSubMeshes[t].enableVertexIdChannel(i)}(t,n,a);var s=t.struct.vertexBundles[t.struct.primitives[n].vertexBundelIndices[0]].view.count,l=o.targets.length,c=function(e,t){var i,n,r,a;e.hasFeature(Gs.TEXTURE_FLOAT)?(i=t,r=16,n=Oh.PixelFormat.RGBA32F,a=Float32Array):(i=4*t,r=4,n=Oh.PixelFormat.RGBA8888,a=Uint8Array);var o=function(e){e<5&&(e=5);var t=Qr($r(e)),i=t>>1;return{width:1<<(1&t?i+1:i),height:1<<i}}(i),s=o.width,l=o.height;return{width:s,height:l,create:function(){var t=new ArrayBuffer(s*l*r),i=new Float32Array(t),o=a===Float32Array?i:new a(t),c=new $u({width:s,height:l,_data:o,_compressed:!1,format:n}),u=new Oh;u.setFilters(Oh.Filter.NEAREST,Oh.Filter.NEAREST),u.setMipFilter(Oh.Filter.NONE),u.setWrapMode(Oh.WrapMode.CLAMP_TO_EDGE,Oh.WrapMode.CLAMP_TO_EDGE,Oh.WrapMode.CLAMP_TO_EDGE),u.image=c,u.getGFXTexture()||P("Unexpected: failed to create morph texture?");var h=vh.getSampler(e,u.getSamplerHash());return{get texture(){return u.getGFXTexture()},get sampler(){return h},get valueView(){return i},destroy:function(){u.destroy()},updatePixels:function(){u.uploadData(o)}}}}}(a,l+s*l);this._textureInfo={width:c.width,height:c.height},this._attributes=o.attributes.map((function(e,i){var n=c.create(),r=n.valueView,a=0,s=o.targets.length;return o.targets.forEach((function(e){var n=e.displacements[i],o=new Float32Array(t.data.buffer,t.data.byteOffset+n.offset,n.count),l=o.length/3;r[a]=s+.5;for(var c=4*s,u=0;u<l;++u)r[c+4*u+0]=o[3*u+0],r[c+4*u+1]=o[3*u+1],r[c+4*u+2]=o[3*u+2];a+=4,s+=l})),n.updatePixels(),{name:e,morphTexture:n}}))}return r(e,[{key:"destroy",value:function(){for(var e,t=y(this._attributes);!(e=t()).done;){e.value.morphTexture.destroy()}}},{key:"createInstance",value:function(){var e=this,t=new X_(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(i){for(var n,r=y(e._attributes);!(n=r()).done;){var a=n.value,o=void 0;switch(a.name){case Vo.ATTR_POSITION:o=S_;break;case Vo.ATTR_NORMAL:o=b_;break;case Vo.ATTR_TANGENT:o=w_;break;default:P("Unexpected attribute!")}void 0!==o&&(i.bindSampler(o,a.morphTexture.sampler),i.bindTexture(o,a.morphTexture.texture))}i.bindBuffer(v_.BINDING,t.buffer),i.update()},destroy:function(){}}}}]),e}(),X_=function(){function e(t,n){i(this,e),this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=n,this._localBuffer=new DataView(new ArrayBuffer(v_.SIZE)),this._remoteBuffer=t.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,v_.SIZE,v_.SIZE))}return r(e,[{key:"destroy",value:function(){this._remoteBuffer.destroy()}},{key:"setWeights",value:function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(v_.OFFSET_OF_WEIGHTS+4*t,e[t],E.sys.isLittleEndian)}},{key:"setMorphTextureInfo",value:function(e,t){this._localBuffer.setFloat32(v_.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,E.sys.isLittleEndian),this._localBuffer.setFloat32(v_.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,E.sys.isLittleEndian)}},{key:"commit",value:function(){this._remoteBuffer.update(this._localBuffer.buffer,this._localBuffer.byteOffset,this._localBuffer.byteLength)}},{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function Y_(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}return Uint8Array}var K_=e("RenderingSubMesh",function(){function e(t,n,r){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;i(this,e),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=void 0,this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=n,this._vertexBuffers=t,this._indexBuffer=a,this._indirectBuffer=o,this._primitiveMode=r,this._iaInfo=new ol(n,t,a,o)}return r(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:oa.ZERO,max:oa.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:oa.ZERO,max:oa.ZERO}};var e=this.mesh,t=this.subMeshIdx,i=e.readAttribute(t,Vo.ATTR_POSITION),n=e.readIndices(t),r=new oa,a=new oa,o=this.attributes.find((function(e){return e.name===E.GFXAttributeName.ATTR_POSITION}));if(o){var s=Ds[o.format].count;2===s?(r.set(i[0],i[1],0),a.set(i[0],i[1],0)):(r.set(i[0],i[1],i[2]),a.set(i[0],i[1],i[2]));for(var l=0;l<i.length;l+=s)2===s?(r.x=i[l]>r.x?i[l]:r.x,r.y=i[l+1]>r.y?i[l+1]:r.y,a.x=i[l]<a.x?i[l]:a.x,a.y=i[l+1]<a.y?i[l+1]:a.y):(r.x=i[l]>r.x?i[l]:r.x,r.y=i[l+1]>r.y?i[l+1]:r.y,r.z=i[l+2]>r.z?i[l+2]:r.z,a.x=i[l]<a.x?i[l]:a.x,a.y=i[l+1]<a.y?i[l+1]:a.y,a.z=i[l+2]<a.z?i[l+2]:a.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:r,min:a}},this._geometricInfo}},{key:"flatBuffers",get:function(){if(this._flatBuffers)return this._flatBuffers;var e=this._flatBuffers=[];if(!this.mesh||void 0===this.subMeshIdx)return e;var t=this.mesh,i=0,n=t.struct.primitives[this.subMeshIdx];n.indexView&&(i=n.indexView.count);for(var r,a=y(n.vertexBundelIndices);!(r=a()).done;){var o=r.value,s=t.struct.vertexBundles[o],l=n.indexView?n.indexView.count:s.view.count,c=s.view.stride,u=c*l,h=new Uint8Array(t.data.buffer,s.view.offset,s.view.length);if(n.indexView){for(var _=new Uint8Array(u),d=t.readIndices(this.subMeshIdx),f=0;f<i;++f)for(var p=f*c,m=d[f]*c,v=0;v<c;++v)_[p+v]=h[m+v];this._flatBuffers.push({stride:c,count:l,buffer:_})}else this._flatBuffers.push({stride:c,count:l,buffer:h})}return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],i=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var n,r,a=this.mesh.struct,o=a.primitives[this.subMeshIdx];if(!a.jointMaps||void 0===o.jointMapIndex||!a.jointMaps[o.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=E.director.root.device,l=0;l<o.vertexBundelIndices.length;l++){var c=a.vertexBundles[o.vertexBundelIndices[l]];r=0,n=jo.UNKNOWN;for(var u=0;u<c.attributes.length;u++){var h=c.attributes[u];if(h.name===Vo.ATTR_JOINTS){n=h.format;break}r+=Ds[h.format].size}n?function(){var u=new Uint8Array(e.mesh.data.buffer,c.view.offset,c.view.length),h=new DataView(u.slice().buffer),_=a.jointMaps[o.jointMapIndex];Hu(h,(function(e){return _.indexOf(e)}),n,r,c.view.length,c.view.stride,h);var d=s.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.DEVICE,c.view.length,c.view.stride));d.update(h.buffer),t.push(d),i.push(l)}():t.push(this.vertexBuffers[o.vertexBundelIndices[l]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(s)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),r(e,[{key:"destroy",value:function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)}},{key:"enableVertexIdChannel",value:function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(e);this.vertexBuffers.push(n),this.attributes.push(new al("a_vertexId",jo.R32F,!1,t)),this._vertexIdChannel={stream:t,index:i}}}},{key:"_allocVertexIdBuffer",value:function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(t),n=0;n<t;++n)i[n]=n+.5;var r=e.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return r.update(i),r}}]),e}()),Z_=new oa,Q_=new oa,J_=new Uint8Array,$_=e("Mesh",ii("cc.Mesh")((F_=S((N_=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_struct",F_,c(e)),x(e,"_dataLength",z_,c(e)),x(e,"_hash",U_,c(e)),e._data=J_,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e.morphRendering=null,e.loaded=!1,e}return o(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),E.loader._cache[this.nativeUrl]&&(E.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this.loaded=!0,this.emit("load")}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=rl(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}}]),r(t,[{key:"initialize",value:function(){var e=this;if(!this._initialized){var t,i;this._initialized=!0,this._data.byteLength!==this._dataLength&&(this._data=new Uint8Array(this._dataLength),(t=this).loaded?i&&i():t.nativeUrl?E.loader.load({url:t.nativeUrl},(function(e,n){n&&(t.loaded||(t._nativeAsset=n)),i&&i(e)})):i&&i());for(var n=this._data.buffer,r=E.director.root.device,a=this._createVertexBuffers(r,n),o=[],s=function(t){var i=e._struct.primitives[t];if(0===i.vertexBundelIndices.length)return"continue";var s=null,l=null;if(i.indexView){var c=i.indexView,u=c.stride,h=c.length;if(4===u&&!r.hasFeature(Gs.ELEMENT_INDEX_UINT)){var _=e._struct.vertexBundles[i.vertexBundelIndices[0]].view.count;if(_>=65536)return G(10001,_,65536),"continue";u>>=1,h>>=1}s=r.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.DEVICE,h,u)),l=new(Y_(c.stride))(n,c.offset,c.count),c.stride!==u&&(l=Y_(u).from(l)),e.loaded?s.update(l):e.once("load",(function(){s.update(l)}))}var d=i.vertexBundelIndices.map((function(e){return a[e]})),f=[];if(i.vertexBundelIndices.length>0){var p=i.vertexBundelIndices[0];f=e._struct.vertexBundles[p].attributes}var m=new K_(d,f,i.primitiveMode,s);m.mesh=e,m.subMeshIdx=t,o.push(m)},l=0;l<this._struct.primitives.length;l++)s(l);this._renderingSubMeshes=o,this._struct.morph&&(this.morphRendering=function(e,t){return new j_(e,t)}(this,r))}}},{key:"destroy",value:function(){return this.destroyRenderingMesh(),_(s(t.prototype),"destroy",this).call(this)}},{key:"destroyRenderingMesh",value:function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}}},{key:"assign",value:function(e,t){this.reset({struct:e,data:t})}},{key:"reset",value:function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._dataLength=this.data.byteLength,this._hash=0,this.loaded=!0,this.emit("load")}},{key:"getBoneSpaceBounds",value:function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var i=[],n=e.bindposes,r=0;r<n.length;r++)t.push(new $c(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);for(var a=this._struct.primitives,o=0;o<a.length;o++){var s=this.readAttribute(o,Vo.ATTR_JOINTS),l=this.readAttribute(o,Vo.ATTR_WEIGHTS),c=this.readAttribute(o,Vo.ATTR_POSITION);if(s&&l&&c)for(var u=Math.min(s.length/4,l.length/4,c.length/3),h=0;h<u;h++){oa.set(Z_,c[3*h+0],c[3*h+1],c[3*h+2]);for(var _=0;_<4;++_){var d=4*h+_,f=s[d];if(!(0===l[d]||f>=n.length)){oa.transformMat4(Q_,Z_,n[f]),i[f]=!0;var p=t[f];oa.min(p.center,p.center,Q_),oa.max(p.halfExtents,p.halfExtents,Q_)}}}}for(var m=0;m<n.length;m++){var v=t[m];i[m]?$c.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t}},{key:"merge",value:function(e,t,i){if(i&&(!this.loaded||!e.loaded||!this.validateMergingMesh(e)))return!1;var n=new oa,r=t&&new pa,a=t&&new $c;if(r&&t.getRotation(r),!this._initialized){var o=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){o.maxPosition&&o.minPosition&&(oa.add(a.center,o.maxPosition,o.minPosition),oa.multiplyScalar(a.center,a.center,.5),oa.subtract(a.halfExtents,o.maxPosition,o.minPosition),oa.multiplyScalar(a.halfExtents,a.halfExtents,.5),$c.transform(a,a,t),oa.add(o.maxPosition,a.center,a.halfExtents),oa.subtract(o.minPosition,a.center,a.halfExtents));for(var l=0;l<o.vertexBundles.length;l++)for(var c=o.vertexBundles[l],u=0;u<c.attributes.length;u++)if(c.attributes[u].name===Vo.ATTR_POSITION||c.attributes[u].name===Vo.ATTR_NORMAL){var h=c.attributes[u].format,_=new DataView(s.buffer,c.view.offset+ed(c.attributes,u)),d=nd(_,h),f=rd(_,h);if(!d||!f)continue;for(var p=c.view.count,m=c.view.stride,v=id(h),g=0;g<p;g++){var x=g*m,S=x+v,T=S+v;switch(n.set(d(x),d(S),d(T)),c.attributes[u].name){case Vo.ATTR_POSITION:n.transformMat4(t);break;case Vo.ATTR_NORMAL:oa.transformQuat(n,n,r)}f(x,n.x),f(S,n.y),f(T,n.z)}}}return this.reset({struct:o,data:s}),this.initialize(),!0}for(var E,b,A,C,w,R=new Vu,I=0,O=0,M=0,P=0,k=0,D=0,B=0,L=0,N=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var U=this._struct.vertexBundles[z],G=e._struct.vertexBundles[z];M=U.view.offset,P=G.view.offset,O=U.view.stride,I=U.view.count+G.view.count,E=new ArrayBuffer(I*O),b=new Uint8Array(E),M+=(A=this._data.subarray(M,M+U.view.length)).length,P+=(C=e._data.subarray(P,P+G.view.length)).length,b.set(A),k=0;for(var H,V=y(U.attributes);!(H=V()).done;){var W=H.value;B=0,N=!1;for(var j,q=y(G.attributes);!(j=q()).done;){var X=j.value;if(W.name===X.name&&W.format===X.format){N=!0;break}B+=Ds[X.format].size}if(N){L=Ds[W.format].size,D=U.view.length+k;for(var Y=0;Y<G.view.count;++Y){if(w=C.subarray(B,B+L),b.set(w,D),(W.name===Vo.ATTR_POSITION||W.name===Vo.ATTR_NORMAL)&&t){var K=new Float32Array(b.buffer,D,3);switch(n.set(K[0],K[1],K[2]),W.name){case Vo.ATTR_POSITION:n.transformMat4(t);break;case Vo.ATTR_NORMAL:oa.transformQuat(n,n,r)}K[0]=n.x,K[1]=n.y,K[2]=n.z}D+=U.view.stride,B+=G.view.stride}}k+=Ds[W.format].size}F[z]={attributes:U.attributes,view:{offset:R.getLength(),length:E.byteLength,count:I,stride:O}},R.addBuffer(E)}for(var Z,Q,J,$=0,ee=2,te=0,ie=new Array(this._struct.primitives.length),ne=0;ne<this._struct.primitives.length;++ne){var re=this._struct.primitives[ne],ae=e._struct.primitives[ne];ie[ne]={primitiveMode:re.primitiveMode,vertexBundelIndices:re.vertexBundelIndices};for(var oe,se=y(re.vertexBundelIndices);!(oe=se()).done;){var le=oe.value;te=Math.max(te,this._struct.vertexBundles[le].view.count)}if(re.indexView&&ae.indexView){$=re.indexView.count,$+=ae.indexView.count,M=re.indexView.offset,P=ae.indexView.offset,ee=$<256?1:$<65536?2:4;var ce=new ArrayBuffer($*ee);if(Z=2===ee?new Uint16Array(ce):1===ee?new Uint8Array(ce):new Uint32Array(ce),Q=2===re.indexView.stride?new Uint16Array(this._data.buffer,M,re.indexView.count):1===re.indexView.stride?new Uint8Array(this._data.buffer,M,re.indexView.count):new Uint32Array(this._data.buffer,M,re.indexView.count),ee===re.indexView.stride)Z.set(Q);else for(var ue=0;ue<re.indexView.count;++ue)Z[ue]=Q[ue];M+=re.indexView.length,J=2===ae.indexView.stride?new Uint16Array(e._data.buffer,P,ae.indexView.count):1===ae.indexView.stride?new Uint8Array(e._data.buffer,P,ae.indexView.count):new Uint32Array(e._data.buffer,P,ae.indexView.count);for(var he=0;he<ae.indexView.count;++he)Z[re.indexView.count+he]=te+J[he];P+=ae.indexView.length,ie[ne].indexView={offset:R.getLength(),length:ce.byteLength,count:$,stride:ee},R.setNextAlignment(ee),R.addBuffer(ce)}}var _e={vertexBundles:F,primitives:ie,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _e.minPosition&&e._struct.minPosition&&_e.maxPosition&&e._struct.maxPosition&&(t?(oa.add(a.center,e._struct.maxPosition,e._struct.minPosition),oa.multiplyScalar(a.center,a.center,.5),oa.subtract(a.halfExtents,e._struct.maxPosition,e._struct.minPosition),oa.multiplyScalar(a.halfExtents,a.halfExtents,.5),$c.transform(a,a,t),oa.add(n,a.center,a.halfExtents),oa.max(_e.maxPosition,_e.maxPosition,n),oa.subtract(n,a.center,a.halfExtents),oa.min(_e.minPosition,_e.minPosition,n)):(oa.min(_e.minPosition,_e.minPosition,e._struct.minPosition),oa.max(_e.maxPosition,_e.maxPosition,e._struct.maxPosition))),this.reset({struct:_e,data:new Uint8Array(R.getCombined())}),this.initialize(),!0}},{key:"validateMergingMesh",value:function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var i=this._struct.vertexBundles[t],n=e._struct.vertexBundles[t];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var a=0;a<this._struct.primitives.length;++a){var o=this._struct.primitives[a],s=e._struct.primitives[a];if(o.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var l=0;l<o.vertexBundelIndices.length;++l)if(o.vertexBundelIndices[l]!==s.vertexBundelIndices[l])return!1;if(o.primitiveMode!==s.primitiveMode)return!1;if(o.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0}},{key:"readAttribute",value:function(e,t){var i=this,n=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,a=e.attributes[t].format,o=zs(Ds[a]);if(0===r)return new o;var s=new DataView(i._data.buffer,e.view.offset+ed(e.attributes,t)),l=Ds[a],c=nd(s,a);if(o&&c){for(var u=l.count,h=new o(r*u),_=e.view.stride,d=0;d<r;++d)for(var f=0;f<u;++f)h[u*d+f]=c(_*d+h.BYTES_PER_ELEMENT*f);n=h}})),n}},{key:"copyAttribute",value:function(e,t,i,n,r){var a=this,o=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var l=e.attributes[t].format,c=new DataView(a._data.buffer,e.view.offset+ed(e.attributes,t)),u=new DataView(i,r),h=Ds[l],_=nd(c,l),d=rd(u,l);if(_&&d){for(var f=h.count,p=e.view.stride,m=id(l),v=n,g=m,y=0;y<s;++y)for(var x=0;x<f;++x){d(v*y+g*x,_(p*y+m*x))}o=!0}}else o=!0})),o}},{key:"readIndices",value:function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var i=t.indexView.stride;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)}},{key:"copyIndices",value:function(e,t){if(e>=this._struct.primitives.length)return!1;var i=this._struct.primitives[e];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?jo.R8UI:2===i.indexView.stride?jo.R16UI:jo.R32UI,a=nd(new DataView(this._data.buffer),r),o=0;o<n;++o)t[o]=a(i.indexView.offset+Ds[r].size*o);return!0}},{key:"_accessAttribute",value:function(e,t,i){if(!(e>=this._struct.primitives.length))for(var n,r=y(this._struct.primitives[e].vertexBundelIndices);!(n=r()).done;){var a=n.value,o=this._struct.vertexBundles[a],s=o.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){i(o,s);break}}}},{key:"_createVertexBuffers",value:function(e,t){var i=this;return this._struct.vertexBundles.map((function(n){var r=e.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.DEVICE,n.view.length,n.view.stride)),a=new Uint8Array(t,n.view.offset,n.view.length);return i.loaded?r.update(a):i.once("load",(function(){r.update(a)})),r}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}(cn)).prototype,"_struct",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),z_=S(N_.prototype,"_dataLength",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),U_=S(N_.prototype,"_hash",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),L_=N_))||L_);function ed(e,t){for(var i=0,n=0;n<t;++n){var r=e[n];i+=Ds[r.format].size}return i}E.Mesh=$_;var td=Gn.isLittleEndian;function id(e){var t=Ds[e];return t.size/t.count}function nd(e,t){var i=Ds[t],n=i.size/i.count;switch(i.type){case Cs.UNORM:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,td)};case 4:return function(t){return e.getUint32(t,td)}}break;case Cs.SNORM:case Cs.INT:switch(n){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,td)};case 4:return function(t){return e.getInt32(t,td)}}break;case Cs.UINT:switch(n){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,td)};case 4:return function(t){return e.getUint32(t,td)}}break;case Cs.FLOAT:return function(t){return e.getFloat32(t,td)}}return null}function rd(e,t){var i=Ds[t],n=i.size/i.count;switch(i.type){case Cs.UNORM:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,td)};case 4:return function(t,i){return e.setUint32(t,i,td)}}break;case Cs.SNORM:case Cs.INT:switch(n){case 1:return function(t,i){return e.setInt8(t,i)};case 2:return function(t,i){return e.setInt16(t,i,td)};case 4:return function(t,i){return e.setInt32(t,i,td)}}break;case Cs.UINT:switch(n){case 1:return function(t,i){return e.setUint8(t,i)};case 2:return function(t,i){return e.setUint16(t,i,td)};case 4:return function(t,i){return e.setUint32(t,i,td)}}break;case Cs.FLOAT:return function(t,i){return e.setFloat32(t,i,td)}}return null}var ad,od,sd,ld,cd=0,ud={},hd=function(e){if(void 0===ud[e]){var t=1<<cd;ud[e]=t,cd+=1}};!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(ad||(ad={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(od||(od={}));var _d;!function(e){e[e.UBO=0]="UBO",e[e.SAMPLER=1]="SAMPLER"}(_d||(_d={}));var dd,fd=function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;return e<<28&4026531840|n<<22&264241152|t<<20&3145728|i<<14&1032192|16383&r},pd=function(e){return(4026531840&e)>>>28},md=function(e){return(264241152&e)>>>22},vd=function(e){return(1032192&e)>>>14},gd=function(e){return 16383&e},yd=function(e,t){return-264241153&e|t<<22&264241152},xd=(a(sd={},Wo.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),a(sd,Wo.INT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]})),a(sd,Wo.INT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ia.fromArray(t,e,i)})),a(sd,Wo.INT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return oa.fromArray(t,e,i)})),a(sd,Wo.INT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ua.fromArray(t,e,i)})),a(sd,Wo.FLOAT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]})),a(sd,Wo.FLOAT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ia.fromArray(t,e,i)})),a(sd,Wo.FLOAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return oa.fromArray(t,e,i)})),a(sd,Wo.FLOAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ua.fromArray(t,e,i)})),a(sd,Wo.MAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return _a.fromArray(t,e,i)})),a(sd,Wo.MAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ta.fromArray(t,e,i)})),sd),Sd=(a(ld={},Wo.UNKNOWN,(function(e,t){return console.warn("illegal uniform handle")})),a(ld,Wo.INT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]=t})),a(ld,Wo.INT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ia.toArray(e,t,i)})),a(ld,Wo.INT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return oa.toArray(e,t,i)})),a(ld,Wo.INT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ua.toArray(e,t,i)})),a(ld,Wo.FLOAT,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return e[i]=t})),a(ld,Wo.FLOAT2,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ia.toArray(e,t,i)})),a(ld,Wo.FLOAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return oa.toArray(e,t,i)})),a(ld,Wo.FLOAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return ua.toArray(e,t,i)})),a(ld,Wo.MAT3,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return _a.toArray(e,t,i)})),a(ld,Wo.MAT4,(function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Ta.toArray(e,t,i)})),ld),Td=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Ed(e){switch(e){case Wo.BOOL:case Wo.INT:case Wo.UINT:case Wo.FLOAT:return Td[0];case Wo.BOOL2:case Wo.INT2:case Wo.UINT2:case Wo.FLOAT2:return Td[1];case Wo.BOOL4:case Wo.INT4:case Wo.UINT4:case Wo.FLOAT4:return Td[2];case Wo.MAT4:return Td[3];case Wo.SAMPLER2D:return"default-texture";case Wo.SAMPLER_CUBE:return"default-cube-texture"}return Td[0]}function bd(e,t){for(var i=Object.entries(t),n=!1,r=0;r<i.length;r++)e[i[r][0]]!==i[r][1]&&(e[i[r][0]]=i[r][1],n=!0);return n}var Ad,Cd,wd,Rd,Id,Od,Md=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],Pd=e("SpriteFrame",ii("cc.SpriteFrame")(dd=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this))).vertices=null,e.uv=[],e.uvHash=0,e.uvSliced=[],e._rect=new Ia,e._offset=new ia,e._originalSize=new wa,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._flipUv=!1,e}return o(t,e),r(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in ".concat(this.name))}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){e&&(this._refreshTexture(e),this._calculateUV())}}],[{key:"createWithImage",value:function(e){var i=e instanceof $u?e:new $u(e),n=new Oh;n.image=i;var r=new t;return r.texture=n,r}}]),r(t,[{key:"textureLoaded",value:function(){return this.texture&&this.texture.loaded}},{key:"isRotated",value:function(){return this._rotated}},{key:"setRotated",value:function(e){this.rotated=e}},{key:"getRect",value:function(e){return e?(e.set(this._rect),e):this._rect.clone()}},{key:"setRect",value:function(e){this.rect=e}},{key:"getOriginalSize",value:function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()}},{key:"setOriginalSize",value:function(e){this.originalSize=e}},{key:"getOffset",value:function(e){return e?(e.set(this._offset),e):this._offset.clone()}},{key:"setOffset",value:function(e){this.offset=e}},{key:"getGFXTexture",value:function(){return this._texture.getGFXTexture()}},{key:"getGFXSampler",value:function(){return this._texture.getGFXSampler()}},{key:"reset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),e&&(e.texture&&(this.loaded=!1,this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._flipUv=!!e.isFlipUv),i=!0),i&&this.texture&&this._calculateUV()}},{key:"checkRect",value:function(e){var t=this._rect,i=t.x,n=t.y;return this._rotated?(i+=t.height,n+=t.width):(i+=t.width,n+=t.height),i>e.width?(V(3300,this.name+"/"+e.name,i,e.width),!1):!(n>e.height)||(V(3301,this.name+"/"+e.name,n,e.height),!1)}},{key:"onLoaded",value:function(){this.loaded=!0,this.emit("load")}},{key:"destroy",value:function(){return _(s(t.prototype),"destroy",this).call(this)}},{key:"_calculateSlicedUV",value:function(){var e=this._rect,t=this.texture,i=t.width,n=t.height,r=this._capInsets[0],a=this._capInsets[2],o=e.width-r-a,s=this._capInsets[1],l=this._capInsets[3],c=e.height-s-l,u=this.uvSliced;if(u.length=0,this._rotated){Md[0].u=(e.x+.5)/i,Md[1].u=(e.x+l)/i,Md[2].u=(e.x+l+c)/i,Md[3].u=(e.x+e.height-.5)/i,Md[3].v=(e.y+.5)/n,Md[2].v=(e.y+r)/n,Md[1].v=(e.y+r+o)/n,Md[0].v=(e.y+e.width-.5)/n;for(var h=0;h<4;++h)for(var _=Md[h],d=0;d<4;++d){var f=Md[3-d];u.push({u:_.u,v:f.v})}}else{Md[0].u=(e.x+.5)/i,Md[1].u=(e.x+r)/i,Md[2].u=(e.x+r+o)/i,Md[3].u=(e.x+e.width-.5)/i,Md[3].v=(e.y+.5)/n,Md[2].v=(e.y+s)/n,Md[1].v=(e.y+s+c)/n,Md[0].v=(e.y+e.height-.5)/n;for(var p=0;p<4;++p)for(var m=Md[p],v=0;v<4;++v){var g=Md[v];u.push({u:g.u,v:m.v})}}}},{key:"_calculateUV",value:function(){var e=this._rect,t=this.uv,i=this.texture,n=i.width,r=i.height;if(this._rotated){var a=0===n?0:(e.x+.5)/n,o=0===n?0:(e.x+e.height-.5)/n,s=0===r?0:(e.y+.5)/r,l=0===r?0:(e.y+e.width-.5)/r;this._flipUv,t[0]=a,t[1]=s,t[2]=a,t[3]=l,t[4]=o,t[5]=s,t[6]=o,t[7]=l}else{var c=0===n?0:(e.x+.5)/n,u=0===n?0:(e.x+e.width-.5)/n,h=0===r?0:(e.y+e.height-.5)/r,_=0===r?0:(e.y+.5)/r;this._flipUv?(t[0]=c,t[1]=_,t[2]=u,t[3]=_,t[4]=c,t[5]=h,t[6]=u,t[7]=h):(t[0]=c,t[1]=h,t[2]=u,t[3]=h,t[4]=c,t[5]=_,t[6]=u,t[7]=_)}for(var d="",f=0;f<t.length;f++)d+=t[f];this.uvHash=rl(d,666);var p=this.vertices;if(p){p.nu.length=0,p.nv.length=0;for(var m=0;m<p.u.length;m++)p.nu[m]=p.u[m]/n,p.nv[m]=p.v[m]/r}this._calculateSlicedUV()}},{key:"_serialize",value:function(e){var t,i,n=this._rect,r=this._offset,a=this._originalSize,o=this._uuid;return this._texture&&(t=this._texture._uuid),o&&e&&(o=EditorExtends.UuidUtils.compressUuid(o,!0)),t&&e&&(t=EditorExtends.UuidUtils.compressUuid(t,!0)),this.vertices&&(i={triangles:this.vertices.triangles,x:this.vertices.x,y:this.vertices.y,u:this.vertices.u,v:this.vertices.v}),{name:this._name,atlas:e?void 0:this._atlasUuid,rect:n,offset:r,originalSize:a,rotated:this._rotated,capInsets:this._capInsets,vertices:i,texture:t}}},{key:"_deserialize",value:function(e,t){var i=e,n=i.rect;n&&(this._rect=new Ia(n.x,n.y,n.width,n.height));var r=i.offset;i.offset&&(this._offset=new ia(r.x,r.y));var a=i.originalSize;i.originalSize&&(this._originalSize=new wa(a.width,a.height)),this._rotated=!!i.rotated,this._name=i.name;var o=i.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),i.texture&&t.result.push(this,"_textureSource",i.texture),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}},{key:"_textureLoaded",value:function(){var e=this._texture,t={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(t.rect=new Ia(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(t.originalSize=new wa(e.width,e.height),i=!0),i&&(this.reset(t),this.onLoaded())}},{key:"_refreshTexture",value:function(e){this._texture=e,e.loaded?this._textureLoaded():e.once("load",this._textureLoaded,this)}}]),t}(cn))||dd);E.SpriteFrame=Pd,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(Od||(Od={}));var kd=e("TextureCube",ii("cc.TextureCube")((Id=Rd=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_mipmaps",wd,c(n)),n}return o(t,e),r(t,[{key:"onLoaded",value:function(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}},{key:"reset",value:function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()}},{key:"updateMipmaps",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1?arguments[1]:void 0;if(!(t>=this._mipmaps.length))for(var n=Math.min(void 0===i?this._mipmaps.length:i,this._mipmaps.length-t),r=function(i){var n=t+i;Dd(e._mipmaps[n],(function(t,i){e._assignImage(t,n,i)}))},a=0;a<n;++a)r(a)}},{key:"destroy",value:function(){return this._mipmaps=[],_(s(t.prototype),"destroy",this).call(this)}},{key:"releaseTexture",value:function(){this.mipmaps=[]}},{key:"_serialize",value:function(e){return{base:_(s(t.prototype),"_serialize",this).call(this),mipmaps:this._mipmaps.map((function(t){return e?{front:EditorExtends.UuidUtils.compressUuid(t.front._uuid,!0),back:EditorExtends.UuidUtils.compressUuid(t.back._uuid,!0),left:EditorExtends.UuidUtils.compressUuid(t.left._uuid,!0),right:EditorExtends.UuidUtils.compressUuid(t.right._uuid,!0),top:EditorExtends.UuidUtils.compressUuid(t.top._uuid,!0),bottom:EditorExtends.UuidUtils.compressUuid(t.bottom._uuid,!0)}:{front:t.front._uuid,back:t.back._uuid,left:t.left._uuid,right:t.right._uuid,top:t.top._uuid,bottom:t.bottom._uuid}}))}}},{key:"_deserialize",value:function(e,i){var n=e;_(s(t.prototype),"_deserialize",this).call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r){this._mipmaps[r]={front:new $u,back:new $u,left:new $u,right:new $u,top:new $u,bottom:new $u};var a=n.mipmaps[r];i.result.push(this._mipmaps[r],"front",a.front),i.result.push(this._mipmaps[r],"back",a.back),i.result.push(this._mipmaps[r],"left",a.left),i.result.push(this._mipmaps[r],"right",a.right),i.result.push(this._mipmaps[r],"top",a.top),i.result.push(this._mipmaps[r],"bottom",a.bottom)}}},{key:"_getGfxTextureCreateInfo",value:function(e){var t=new Il(ss.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t.flags=t.flags|us.CUBEMAP,t}},{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0].front;this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,i){Dd(e,(function(e,n){t._assignImage(e,i,n)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}],[{key:"fromTexture2DArray",value:function(e,i){for(var n=[],r=e.length/6,a=0;a<r;a++){var o=6*a;n.push({front:e[o+Od.front].image,back:e[o+Od.back].image,left:e[o+Od.left].image,right:e[o+Od.right].image,top:e[o+Od.top].image,bottom:e[o+Od.bottom].image})}return(i=i||new t).mipmaps=n,i}}]),t}(Ih),Rd.FaceIndex=Od,wd=S((Cd=Id).prototype,"_mipmaps",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ad=Cd))||Ad);function Dd(e,t){t(e.front,Od.front),t(e.back,Od.back),t(e.left,Od.left),t(e.right,Od.right),t(e.top,Od.top),t(e.bottom,Od.bottom)}E.TextureCube=kd;var Bd,Ld,Nd,Fd,zd,Ud,Gd,Hd,Vd,Wd,jd,qd,Xd,Yd,Kd,Zd,Qd,Jd,$d=e("effects",[{name:"builtin-billboard",_uuid:"711ebe11-f673-4cd9-9a83-63c60ba54c5b",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-billboard|vert:vs_main|tinted-fs:add",hash:2143664850,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"builtin-graphics",_uuid:"1c02ae6f-4492-4915-b8f8-7492a3b1e4cd",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"builtin-graphics|vs:vert|fs:frag",hash:3946667351,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    #ifdef GL_OES_standard_derivatives\n      float aa = fwidth(v_dist);\n    #else\n      float aa = 0.05;\n    #endif\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"builtin-particle-gpu",_uuid:"971bdb23-3ff6-43eb-b422-1c30165a3663",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:3696836305,glsl3:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord;\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  layout(std140) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  layout(std140) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  layout(std140) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  layout(std140) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  layout(std140) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  layout(std140) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord;\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  uniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  uniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  uniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  uniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  uniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  uniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture2D(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord;\n  layout(location = 7) in vec3 a_texCoord3;\n  layout(location = 8) in vec3 a_normal;\n  layout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\n  layout(set = 1, binding = 3) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\n  layout(set = 1, binding = 4) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\n  layout(set = 1, binding = 5) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\n  layout(set = 1, binding = 6) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\n  layout(set = 1, binding = 7) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  layout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\n  layout(set = 1, binding = 8) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"builtin-particle-trail",_uuid:"17debcc3-0a6b-4b8a-b00b-dc58b885581e",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle-trail|particle-trail:vs_main|tinted-fs:add",hash:4115155772,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  layout(std140) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  layout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  layout(location = 0) in vec2 uv;\n  layout(location = 1) in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    layout(location = 2) in vec3 vBarycentric;\n  #endif\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n  layout(set = 1, binding = 1) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"builtin-particle",_uuid:"d1346436-ac96-4271-b863-1f4fdead95b0",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"builtin-particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:66662317,glsl3:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\n  in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},glsl1:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\n  attribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"},glsl4:{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\n  layout(location = 5) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord3;\n  layout(location = 7) in vec3 a_normal;\n  layout(location = 5) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:5},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"builtin-sprite",_uuid:"60f7195c-ec2a-45eb-ba94-8955f60e81d0",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"builtin-sprite|sprite-vs:vert|sprite-fs:frag",hash:2679078392,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture2D(tex, uv);\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleTexture(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\n  layout(location = 1) in vec2 uv0;\n  layout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleTexture(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"builtin-standard",_uuid:"1baf0fc9-befa-459c-8bdd-af1a450a0319",techniques:[{name:"opaque",passes:[{program:"builtin-standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"builtin-standard|standard-vs:vert|standard-fs:frag",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:1},program:"builtin-standard|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"builtin-standard|standard-vs:vert|standard-fs:frag",hash:967558702,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexID;\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nout vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if USE_VERTEX_COLOR\n  in vec3 a_color;\n  out vec3 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\nout float v_fog_factor;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  in vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(std140) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nin vec4 v_shadowPos;\nuniform sampler2D cc_shadowMap;\nvec4 CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float depth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\nvec4 CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float depth = 0.0;\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth /= 5.0;\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\nvec4 CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float depth = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      depth += dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    }\n  }\n  depth /= 9.0;\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\nvec4 CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float depth = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      depth += dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    }\n  }\n  depth /= 25.0;\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      vec4 shadow = vec4(1.0);\n      float pcf = cc_shadowPCF.x + 0.001;\n      if (pcf > 3.0) {shadow = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadow = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadow = CCGetShadowFactorX5();}\n      else {shadow = CCGetShadowFactorX1();}\n      finalColor = shadow.rgb * shadow.a + finalColor * (1.0 - shadow.a);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\nin float v_fog_factor;\n#if USE_VERTEX_COLOR\n  in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nvarying vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if USE_VERTEX_COLOR\n  attribute vec3 a_color;\n  varying vec3 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying float v_fog_factor;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform lowp vec4 cc_shadowColor;\nuniform lowp vec4 cc_shadowPCF;\nuniform lowp vec4 cc_shadowSize;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return texture2DLodEXT(tex, coord, lod);\n    #else\n      return texture2D(tex, coord, lod);\n    #endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return textureCubeLodEXT(tex, coord, lod);\n    #else\n      return textureCube(tex, coord, lod);\n    #endif\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nuniform highp vec4 cc_lightPos[1];\nuniform vec4 cc_lightColor[1];\nuniform vec4 cc_lightSizeRangeAngle[1];\nuniform vec4 cc_lightDir[1];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nvarying vec4 v_shadowPos;\nuniform sampler2D cc_shadowMap;\nvec4 CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float depth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\nvec4 CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float depth = 0.0;\n  depth += dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth /= 5.0;\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\nvec4 CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float depth = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      depth += dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    }\n  }\n  depth /= 9.0;\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\nvec4 CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float depth = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      depth += dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    }\n  }\n  depth /= 25.0;\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture2D(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      vec4 shadow = vec4(1.0);\n      float pcf = cc_shadowPCF.x + 0.001;\n      if (pcf > 3.0) {shadow = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadow = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadow = CCGetShadowFactorX5();}\n      else {shadow = CCGetShadowFactorX1();}\n      finalColor = shadow.rgb * shadow.a + finalColor * (1.0 - shadow.a);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\n  varying vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture2D(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture2D(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nlayout(location = 0) out vec4 v_shadowPos;\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 13) in vec3 a_color;\n  layout(location = 1) out vec3 v_color;\n#endif\nlayout(location = 2) out vec3 v_position;\nlayout(location = 3) out vec3 v_normal;\nlayout(location = 4) out vec2 v_uv;\nlayout(location = 5) out vec2 v_uv1;\nlayout(location = 6) out float v_fog_factor;\n#if USE_NORMAL_MAP\n  layout(location = 7) out vec3 v_tangent;\n  layout(location = 8) out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 14) in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(matWorld * In.position);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if CC_USE_IBL\nlayout(set = 0, binding = 3) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) in vec2 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(set = 2, binding = 1) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      finalColor += SNL * cc_lightColor[i].rgb * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  #if CC_RECEIVE_SHADOW\nlayout(location = 0) in vec4 v_shadowPos;\nlayout(set = 0, binding = 4) uniform sampler2D cc_shadowMap;\nvec4 CCGetShadowFactorX1 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float depth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\nvec4 CCGetShadowFactorX5 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float depth = 0.0;\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth += dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n  depth /= 5.0;\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\nvec4 CCGetShadowFactorX9 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float depth = 0.0;\n  for (int i = -1; i <= 1; i++) {\n    for (int j = -1; j <= 1; j++) {\n      depth += dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    }\n  }\n  depth /= 9.0;\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\nvec4 CCGetShadowFactorX25 () {\n  vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n  float offsetx = 1.0 / cc_shadowSize.x;\n  float offsety = 1.0 / cc_shadowSize.y;\n  float depth = 0.0;\n  for (int i = -2; i <= 2; i++) {\n    for (int j = -2; j <= 2; j++) {\n      depth += dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    }\n  }\n  depth /= 25.0;\n  if (depth < (clipPos.z - 0.001)) return cc_shadowColor;\n  else return vec4(0);\n}\n  #endif\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      vec4 lightmap = texture(cc_lightingMap, v_luv);\n      finalColor = lightmap.a * lightmap.rgb + (1.0 - lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n      vec4 shadow = vec4(1.0);\n      float pcf = cc_shadowPCF.x + 0.001;\n      if (pcf > 3.0) {shadow = CCGetShadowFactorX25();}\n      else if (3.0 > pcf && pcf > 2.0) {shadow = CCGetShadowFactorX9();}\n      else if (2.0 > pcf && pcf > 1.0) {shadow = CCGetShadowFactorX5();}\n      else {shadow = CCGetShadowFactorX1();}\n      finalColor = shadow.rgb * shadow.a + finalColor * (1.0 - shadow.a);\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(location = 2) in vec3 v_position;\nlayout(location = 4) in vec2 v_uv;\nlayout(location = 5) in vec2 v_uv1;\nlayout(location = 3) in vec3 v_normal;\nlayout(location = 6) in float v_fog_factor;\n#if USE_VERTEX_COLOR\n  layout(location = 1) in vec3 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  layout(location = 7) in vec3 v_tangent;\n  layout(location = 8) in vec3 v_bitangent;\n  layout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  layout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  layout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  layout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  layout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor.rgb *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_shadowMap",defines:["!CC_FORWARD_ADD","CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:15,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:32,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"builtin-standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:1431638625,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexID;\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture2D(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 13) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out vec2 v_uv1;\nlayout(location = 2) out vec2 v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in vec2 v_uv1;\nlayout(location = 2) in vec2 v_clip_depth;\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"builtin-terrain",_uuid:"1d08ef62-a503-4ce2-8b9a-46c90873f7d3",techniques:[{name:"opaque",passes:[{program:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},lightMap:{value:"grey",type:28}}}]}],shaders:[{name:"builtin-terrain|terrain-vs:vert|terrain-fs:frag",hash:298856331,glsl3:{vert:"\n  precision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  in vec3 a_position;\n  in vec3 a_normal;\n  in vec2 a_texCoord;\n  out vec2 uvw;\n  out vec2 uv0;\n  out vec2 uv1;\n  out vec2 uv2;\n  out vec2 uv3;\n  out vec2 luv;\n  out vec3 diffuse;\n  out float factor_fog;\n  layout(std140) uniform TexCoords {\n    vec4 UVScale;\n    vec4 lightMapUVParam;\n  };\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uvw;\n  in vec2 uv0;\n  in vec2 uv1;\n  in vec2 uv2;\n  in vec2 uv3;\n  in vec3 diffuse;\n  in vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\n  in float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\n  precision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  attribute vec3 a_position;\n  attribute vec3 a_normal;\n  attribute vec2 a_texCoord;\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec2 luv;\n  varying vec3 diffuse;\n  varying float factor_fog;\n  uniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uvw;\n  varying vec2 uv0;\n  varying vec2 uv1;\n  varying vec2 uv2;\n  varying vec2 uv3;\n  varying vec3 diffuse;\n  varying vec2 luv;\n  uniform sampler2D weightMap;\n  uniform sampler2D detailMap0;\n  uniform sampler2D detailMap1;\n  uniform sampler2D detailMap2;\n  uniform sampler2D detailMap3;\n  uniform sampler2D lightMap;\n  varying float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture2D(weightMap, uvw);\n    color += texture2D(detailMap0, uv0) * w.r;\n    color += texture2D(detailMap1, uv1) * w.g;\n    color += texture2D(detailMap2, uv2) * w.b;\n    color += texture2D(detailMap3, uv3) * w.a;\n  #else\n    color = texture2D(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture2D(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n  precision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n  layout(location = 0) in vec3 a_position;\n  layout(location = 1) in vec3 a_normal;\n  layout(location = 2) in vec2 a_texCoord;\n  layout(location = 0) out vec2 uvw;\n  layout(location = 1) out vec2 uv0;\n  layout(location = 2) out vec2 uv1;\n  layout(location = 3) out vec2 uv2;\n  layout(location = 4) out vec2 uv3;\n  layout(location = 5) out vec2 luv;\n  layout(location = 6) out vec3 diffuse;\n  layout(location = 7) out float factor_fog;\n  layout(set = 1, binding = 0) uniform TexCoords {\n    vec4 UVScale;\n    vec4 lightMapUVParam;\n  };\n  vec4 vert () {\n    vec3 worldPos;\n    worldPos.x = cc_matWorld[3][0] + a_position.x;\n    worldPos.y = cc_matWorld[3][1] + a_position.y;\n    worldPos.z = cc_matWorld[3][2] + a_position.z;\n    vec4 pos = vec4(worldPos, 1);\n    pos = cc_matViewProj * pos;\n    uvw = a_texCoord;\n    uv0 = a_position.xz * UVScale.x;\n    uv1 = a_position.xz * UVScale.y;\n    uv2 = a_position.xz * UVScale.z;\n    uv3 = a_position.xz * UVScale.w;\n    float fAmb = dot(a_normal, vec3(0.0, -1.0, 0.0)) * 0.5 + 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n#if LIGHT_MAP == 0\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 N = a_normal;\n    diffuse = ambDiff + vec3(dot(N, L)) * cc_mainLitColor.rgb;\n#else\n    diffuse = ambDiff;\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n#endif\n    factor_fog = CC_TRANSFER_FOG(vec4(worldPos, 1));\n    return pos;\n  }\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  layout(location = 0) in vec2 uvw;\n  layout(location = 1) in vec2 uv0;\n  layout(location = 2) in vec2 uv1;\n  layout(location = 3) in vec2 uv2;\n  layout(location = 4) in vec2 uv3;\n  layout(location = 6) in vec3 diffuse;\n  layout(location = 5) in vec2 luv;\n  layout(set = 1, binding = 1) uniform sampler2D weightMap;\n  layout(set = 1, binding = 2) uniform sampler2D detailMap0;\n  layout(set = 1, binding = 3) uniform sampler2D detailMap1;\n  layout(set = 1, binding = 4) uniform sampler2D detailMap2;\n  layout(set = 1, binding = 5) uniform sampler2D detailMap3;\n  layout(set = 1, binding = 6) uniform sampler2D lightMap;\n  layout(location = 7) in float factor_fog;\nvec4 frag () {\n  vec4 color = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    color = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    vec4 w = texture(weightMap, uvw);\n    color += texture(detailMap0, uv0) * w.r;\n    color += texture(detailMap1, uv1) * w.g;\n    color += texture(detailMap2, uv2) * w.b;\n    color += texture(detailMap3, uv3) * w.a;\n  #else\n    color = texture(detailMap0, uv0);\n  #endif\n  vec3 lighting = diffuse;\n  #if LIGHT_MAP == 1\n    lighting += texture(lightMap, luv).rgb;\n  #endif\n  color.rgb *= lighting;\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, factor_fog), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"LIGHT_MAP",type:"number",range:[0,3]},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"builtin-unlit",_uuid:"a3cd009f-0ab0-420d-9278-b9fdab939bbc",techniques:[{name:"opaque",passes:[{program:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"builtin-unlit|unlit-vs:vert|unlit-fs:frag",hash:2713860986,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexID;\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  in lowp vec4 a_color;\n  out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  out vec2 v_uv;\n  layout(std140) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nout float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  in lowp vec4 v_color;\n#endif\nin float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  attribute lowp vec4 a_color;\n  varying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nvarying float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\n  varying lowp vec4 v_color;\n#endif\nvarying float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 1\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 2\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 3\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 4\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  layout(location = 13) in lowp vec4 a_color;\n  layout(location = 0) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  layout(location = 1) out vec2 v_uv;\n  layout(set = 1, binding = 0) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nlayout(location = 2) out float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  layout(location = 1) in vec2 v_uv;\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 0) in lowp vec4 v_color;\n#endif\nlayout(location = 2) in float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"pipeline/planar-shadow",_uuid:"9361fd90-ba52-4f84-aa93-6e878fd576ca",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"pipeline/planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:870436315,glsl3:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexID;\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\n#ifdef GL_EXT_shader_explicit_arithmetic_types_int16\n#extension GL_EXT_shader_explicit_arithmetic_types_int16: enable\n#endif\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - step(127.99, rgba[3]) * 2.0;\n  highp float Exponent = 2.0 * mod(rgba[3], 127.99) + step(128.0, rgba[2]) - 127.0;\n  highp float Mantissa = mod(rgba[2], 128.0) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    float m = mod(float(index), 4.0);\n    if (m < 1.0) {\n        return cc_displacementWeights[index / 4].x;\n    } else if (m < 2.0) {\n        return cc_displacementWeights[index / 4].y;\n    } else if (m < 3.0) {\n        return cc_displacementWeights[index / 4].z;\n    } else {\n        return cc_displacementWeights[index / 4].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        int dataPixelStart = int(fetchVec3ArrayFromTexture(tex, iTarget).r);\n        result += (fetchVec3ArrayFromTexture(tex, dataPixelStart + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  return getJointMatrix(a_joints.x) * a_weights.x\n       + getJointMatrix(a_joints.y) * a_weights.y\n       + getJointMatrix(a_joints.z) * a_weights.z\n       + getJointMatrix(a_joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 1) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp vec4 cc_shadowColor;\n  lowp vec4 cc_shadowPCF;\n  lowp vec4 cc_shadowSize;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"pipeline/skybox",_uuid:"511d2633-09a7-4bdd-ac42-f778032124b3",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"pipeline/skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"pipeline/skybox|sky-vs:vert|sky-fs:frag",hash:629379420,glsl3:{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  vec4 pos = matViewRotOnly * viewDir;\n  vec2 f = cc_matProj[3][3] > 0.0 ? vec2(4.8, 2.4) : vec2(cc_matProj[1][1]);\n  pos.xy *= vec2(cc_matProj[0][0] / cc_matProj[1][1] * cc_cameraPos.w, 1.0) * f;\n  pos.zw = vec2(-0.99999 * pos.z, -pos.z);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 3) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"util/profiler",_uuid:"871c3b6c-7379-419d-bda3-794b239ab90d",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/profiler|profiler-vs:vert|profiler-fs:frag",hash:4021376818,glsl3:{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\n  vec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nuniform mediump vec4 cc_screenSize;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = vec4(a_position, 1.0);\n  position.x *= cc_screenSize.y * cc_screenSize.z;\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_nativeSize;\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"util/splash-screen",_uuid:"970b0598-bcb0-4714-91fb-2e81440dccd8",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"util/splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"util/splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:2106901053,glsl3:{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nlayout(std140) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nout vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},glsl1:{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform float u_precent;\nvec4 frag () {\n  vec4 color = texture2D(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nvoid main() { gl_FragColor = frag(); }"},glsl4:{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 1) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 0) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,stageFlags:16,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),ef=function(){function e(){i(this,e),this._device=null,this._resources={}}return r(e,[{key:"initBuiltinRes",value:function(e){this._device=e;var t=this._resources,i=document.createElement("canvas"),n=i.getContext("2d"),r=new $u(i),a=i.width=i.height=2;n.fillStyle="#000",n.fillRect(0,0,a,a);var o=new Oh;o._uuid="black-texture",o.image=r,t[o._uuid]=o,n.fillStyle="rgba(0,0,0,0)",n.fillRect(0,0,a,a);for(var s=new Uint8Array(16),l=0;l<s.length;++l)s[l]=0;var c=new Oh;c._uuid="empty-texture",c.image=r,c.uploadData(s),t[c._uuid]=c;var u=new kd;u._uuid="black-cube-texture",u.setMipFilter(kd.Filter.LINEAR),u.image={front:new $u(i),back:new $u(i),left:new $u(i),right:new $u(i),top:new $u(i),bottom:new $u(i)},t[u._uuid]=u,n.fillStyle="#777",n.fillRect(0,0,a,a);var h=new Oh;h._uuid="grey-texture",h.image=r,t[h._uuid]=h,n.fillStyle="#fff",n.fillRect(0,0,a,a);var _=new Oh;_._uuid="white-texture",_.image=r,t[_._uuid]=_;var d=new kd;d._uuid="white-cube-texture",d.setMipFilter(kd.Filter.LINEAR),d.image={front:new $u(i),back:new $u(i),left:new $u(i),right:new $u(i),top:new $u(i),bottom:new $u(i)},t[d._uuid]=d,n.fillStyle="#7f7fff",n.fillRect(0,0,a,a);var f=new Oh;f._uuid="normal-texture",f.image=r,t[f._uuid]=f,i.width=i.height=16,n.fillStyle="#ddd",n.fillRect(0,0,16,16),n.fillStyle="#555",n.fillRect(0,0,8,8),n.fillStyle="#555",n.fillRect(8,8,8,8);var p=new Oh;p._uuid="default-texture",p.image=r,t[p._uuid]=p;var m=new kd;m.setMipFilter(kd.Filter.LINEAR),m._uuid="default-cube-texture",m.image={front:new $u(i),back:new $u(i),left:new $u(i),right:new $u(i),top:new $u(i),bottom:new $u(i)},t[m._uuid]=m;var v=new Pd,g=r._texture;v.texture=g,v._uuid="default-spriteframe",t[v._uuid]=v,$d.forEach((function(e){Object.assign(new E.EffectAsset,e).onLoaded()}));var y=new E.Material;y._uuid="standard-material",y.initialize({effectName:"builtin-standard"}),t[y._uuid]=y;var x=new E.Material;x._uuid="missing-effect-material",x.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),x.setProperty("mainColor",E.color("#ffff00")),t[x._uuid]=x;var S=new E.Material;S._uuid="missing-material",S.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0}}),S.setProperty("mainColor",E.color("#ff00ff")),t[S._uuid]=S;var T=new E.Material;T._uuid="ui-base-material",T.initialize({defines:{USE_TEXTURE:!1},effectName:"builtin-sprite"}),t[T._uuid]=T;var b=new E.Material;b._uuid="ui-sprite-material",b.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"builtin-sprite"}),t[b._uuid]=b;var A=new E.Material;A._uuid="ui-sprite-gray-material",A.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"builtin-sprite"}),t[A._uuid]=A;var C=new E.Material;C._uuid="ui-sprite-alpha-sep-material",C.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"builtin-sprite"}),t[C._uuid]=C;var w=new E.Material;w._uuid="ui-sprite-gray-alpha-sep-material",w.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"builtin-sprite"}),t[w._uuid]=w;var R=new E.Material;R._uuid="ui-graphics-material",R.initialize({effectName:"builtin-graphics"}),t[R._uuid]=R;var I=new E.Material;I._uuid="default-particle-material",I.initialize({effectName:"builtin-particle"}),t[I._uuid]=I;var O=new E.Material;O._uuid="default-particle-gpu-material",O.initialize({effectName:"builtin-particle-gpu"}),t[O._uuid]=O;var M=new E.Material;M._uuid="default-trail-material",M.initialize({effectName:"builtin-particle-trail"}),t[M._uuid]=M;var P=new E.Material;P._uuid="default-billboard-material",P.initialize({effectName:"builtin-billboard"}),t[P._uuid]=P}},{key:"get",value:function(e){return this._resources[e]}}]),e}(),tf=e("builtinResMgr",E.builtinResMgr=new ef),nf=(Bd=new Map,Ld=0,function(e){return"number"==typeof e?e:(Bd.has(e)||(Bd.set(e,1<<Ld),Ld++),Bd.get(e))}),rf=function(){function e(t,n,r){i(this,e),this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=r*(1<<n)}return r(e,[{key:"allocateNewChunk",value:function(){return new ArrayBuffer(this._chunkSize)}}]),e}(),af=function e(t,n){i(this,e)},of=function(){function e(t,n){i(this,e),this._size=void 0,this._size=n}return r(e,[{key:"alloc",value:function(e){return new Uint32Array(this._size)}},{key:"resize",value:function(e,t,i){var n=new Uint32Array(t);return n.set(e),n}}]),e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(Jd||(Jd={}));var sf,lf=function(){function e(t,n,r){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8;i(this,e),this._dataType=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freelists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=r.COUNT,this._entryBits=a,this._dataType=n;var o=4;this._stride=o*this._elementCount,this._entriesPerChunk=1<<a,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new rf(t,a,this._stride);var s=Jd.NEVER,l=!1,c=!1;for(var u in n){if(l=this._hasFloat32,(c=this._hasUint32)&&l)break;s=n[u],l||s!==Jd.FLOAT32?c||s!==Jd.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}return r(e,[{key:"alloc",value:function(){for(var e=0;e<this._freelists.length;e++){var t=this._freelists[e];if(t.length){var i=t[t.length-1];return t.length--,(e<<this._entryBits)+i+this._poolFlag}}for(var n=this._nativePool.allocateNewChunk(),r=[],a=[],o=[],s=this._hasFloat32,l=this._hasUint32,c=0;c<this._entriesPerChunk;c++)s&&r.push(new Float32Array(n,this._stride*c,this._elementCount)),l&&a.push(new Uint32Array(n,this._stride*c,this._elementCount)),c&&o.push(c);return this._arrayBuffers.push(n),l&&this._uint32BufferViews.push(a),s&&this._float32BufferViews.push(r),this._freelists.push(o),(e<<this._entryBits)+this._poolFlag}},{key:"get",value:function(e,t){var i=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._dataType[t]===Jd.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][n][t]}},{key:"set",value:function(e,t,i){var n=(this._chunkMask&e)>>this._entryBits,r=this._entryMask&e;(this._dataType[t]===Jd.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][r][t]=i}},{key:"setVec2",value:function(e,t,i){}},{key:"setVec3",value:function(e,t,i){}},{key:"setVec4",value:function(e,t,i){}},{key:"setMat4",value:function(e,t,i){}},{key:"free",value:function(e){var t=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][i].fill(0),this._freelists[t].push(i)}}]),e}(),cf=function(){function e(t,n,r){i(this,e),this._ctor=void 0,this._dtor=void 0,this._indexMask=void 0,this._poolFlag=void 0,this._array=[],this._freelist=[],this._nativePool=void 0,this._ctor=n,r&&(this._dtor=r),this._poolFlag=1<<29,this._indexMask=~this._poolFlag,this._nativePool=new af(t,this._array)}return r(e,[{key:"alloc",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=this._freelist,r=-1;if(n.length&&(r=n[n.length-1],n.length--,this._array[r]=this._ctor(arguments,this._array[r])),r<0){r=this._array.length;var a=this._ctor(arguments);if(!a)return 0;this._array.push(a)}return r+this._poolFlag}},{key:"get",value:function(e){var t=this._indexMask&e;return this._array[t]}},{key:"free",value:function(e){var t=this._indexMask&e;this._dtor&&this._dtor(this._array[t]),this._freelist.push(t)}}]),e}(),uf=function(){function e(t,n,r){i(this,e),this._nativeArrayPool=void 0,this._arrayMap=new Map,this._curArrayHandle=0,this._arrayHandleFlag=void 0,this._arrayHandleMask=void 0,this._size=0,this._step=0,this._arrayHandleFlag=1<<30,this._arrayHandleMask=~this._arrayHandleFlag,this._size=n+1,this._step=r||n,this._nativeArrayPool=new of(t,this._size)}return r(e,[{key:"alloc",value:function(){var e=this._curArrayHandle++,t=this._nativeArrayPool.alloc(e);return this._arrayMap.set(e,t),e|this._arrayHandleFlag}},{key:"free",value:function(e){var t=this._arrayHandleMask&e;void 0!==this._arrayMap.get(t)&&this._arrayMap.delete(t)}},{key:"assign",value:function(e,t,i){var n=this._arrayHandleMask&e,r=this._arrayMap.get(n);if(void 0!==r){if((t+=1)>=r.length){for(var a=r.length;t>=a;)a+=this._step;r=this._nativeArrayPool.resize(r,a,n),this._arrayMap.set(n,r)}r[t]=i;var o=r[0];r[0]=t>o?t:o}}},{key:"erase",value:function(e,t){var i=this._arrayMap.get(this._arrayHandleMask&e);if(!(void 0===i||t>i[0])){for(var n=t+1;n<i[0];++n)i[n]=i[n+1];--i[0]}}},{key:"push",value:function(e,t){var i=this._arrayMap.get(this._arrayHandleMask&e);void 0!==i&&this.assign(e,i[0],t)}},{key:"pop",value:function(e){var t=this._arrayMap.get(this._arrayHandleMask&e);void 0!==t&&0!==t[0]&&--t[0]}},{key:"clear",value:function(e){var t=this._arrayMap.get(this._arrayHandleMask&e);void 0!==t&&(t[0]=0)}}]),e}();!function(e){e[e.RASTERIZER_STATE=0]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=1]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=2]="BLEND_STATE",e[e.DESCRIPTOR_SETS=3]="DESCRIPTOR_SETS",e[e.SHADER=4]="SHADER",e[e.INPUT_ASSEMBLER=5]="INPUT_ASSEMBLER",e[e.PIPELINE_LAYOUT=6]="PIPELINE_LAYOUT",e[e.FRAMEBUFFER=7]="FRAMEBUFFER",e[e.PASS=100]="PASS",e[e.SUB_MODEL=101]="SUB_MODEL",e[e.MODEL=102]="MODEL",e[e.SCENE=103]="SCENE",e[e.CAMERA=104]="CAMERA",e[e.NODE=105]="NODE",e[e.ROOT=106]="ROOT",e[e.AABB=107]="AABB",e[e.RENDER_WINDOW=108]="RENDER_WINDOW",e[e.FRUSTUM=109]="FRUSTUM",e[e.AMBIENT=110]="AMBIENT",e[e.FOG=111]="FOG",e[e.SKYBOX=112]="SKYBOX",e[e.SHADOW=113]="SHADOW",e[e.LIGHT=114]="LIGHT",e[e.SUB_MODEL_ARRAY=200]="SUB_MODEL_ARRAY",e[e.MODEL_ARRAY=201]="MODEL_ARRAY"}(sf||(sf={}));var hf,_f=new cf(sf.RASTERIZER_STATE,(function(){return new ll})),df=new cf(sf.DEPTH_STENCIL_STATE,(function(){return new cl})),ff=new cf(sf.BLEND_STATE,(function(){return new hl})),pf=new cf(sf.SHADER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createShader(e[1])}),(function(e){return e&&e.destroy()})),mf=new cf(sf.DESCRIPTOR_SETS,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createDescriptorSet(e[1])}),(function(e){return e&&e.destroy()})),vf=new cf(sf.INPUT_ASSEMBLER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createInputAssembler(e[1])}),(function(e){return e&&e.destroy()})),gf=new cf(sf.PIPELINE_LAYOUT,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createPipelineLayout(e[1])}),(function(e){return e&&e.destroy()})),yf=new cf(sf.FRAMEBUFFER,(function(e,t){return t?(t.initialize(e[1]),t):e[0].createFramebuffer(e[1])}),(function(e){return e&&e.destroy()})),xf=new uf(sf.SUB_MODEL_ARRAY,10),Sf=new uf(sf.MODEL_ARRAY,50,10);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.BATCHING_SCHEME=3]="BATCHING_SCHEME",e[e.PRIMITIVE=4]="PRIMITIVE",e[e.DYNAMIC_STATES=5]="DYNAMIC_STATES",e[e.HASH=6]="HASH",e[e.RASTERIZER_STATE=7]="RASTERIZER_STATE",e[e.DEPTH_STENCIL_STATE=8]="DEPTH_STENCIL_STATE",e[e.BLEND_STATE=9]="BLEND_STATE",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.PIPELINE_LAYOUT=11]="PIPELINE_LAYOUT",e[e.COUNT=12]="COUNT"}(hf||(hf={}));var Tf,Ef=(a(Nd={},hf.PRIORITY,Jd.UINT32),a(Nd,hf.STAGE,Jd.UINT32),a(Nd,hf.PHASE,Jd.UINT32),a(Nd,hf.BATCHING_SCHEME,Jd.UINT32),a(Nd,hf.PRIMITIVE,Jd.UINT32),a(Nd,hf.DYNAMIC_STATES,Jd.UINT32),a(Nd,hf.HASH,Jd.UINT32),a(Nd,hf.RASTERIZER_STATE,Jd.UINT32),a(Nd,hf.DEPTH_STENCIL_STATE,Jd.UINT32),a(Nd,hf.BLEND_STATE,Jd.UINT32),a(Nd,hf.DESCRIPTOR_SET,Jd.UINT32),a(Nd,hf.PIPELINE_LAYOUT,Jd.UINT32),a(Nd,hf.COUNT,Jd.NEVER),Nd),bf=new lf(sf.PASS,Ef,hf);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.PASS_COUNT=1]="PASS_COUNT",e[e.PASS_0=2]="PASS_0",e[e.PASS_1=3]="PASS_1",e[e.PASS_2=4]="PASS_2",e[e.PASS_3=5]="PASS_3",e[e.SHADER_0=6]="SHADER_0",e[e.SHADER_1=7]="SHADER_1",e[e.SHADER_2=8]="SHADER_2",e[e.SHADER_3=9]="SHADER_3",e[e.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",e[e.COUNT=12]="COUNT"}(Tf||(Tf={}));var Af,Cf=(a(Fd={},Tf.PRIORITY,Jd.UINT32),a(Fd,Tf.PASS_COUNT,Jd.UINT32),a(Fd,Tf.PASS_0,Jd.UINT32),a(Fd,Tf.PASS_1,Jd.UINT32),a(Fd,Tf.PASS_2,Jd.UINT32),a(Fd,Tf.PASS_3,Jd.UINT32),a(Fd,Tf.SHADER_0,Jd.UINT32),a(Fd,Tf.SHADER_1,Jd.UINT32),a(Fd,Tf.SHADER_2,Jd.UINT32),a(Fd,Tf.SHADER_3,Jd.UINT32),a(Fd,Tf.DESCRIPTOR_SET,Jd.UINT32),a(Fd,Tf.INPUT_ASSEMBLER,Jd.UINT32),a(Fd,Tf.COUNT,Jd.NEVER),Fd),wf=new lf(sf.SUB_MODEL,Cf,Tf);!function(e){e[e.ENABLED=0]="ENABLED",e[e.VIS_FLAGS=1]="VIS_FLAGS",e[e.CAST_SHADOW=2]="CAST_SHADOW",e[e.WORLD_BOUNDS=3]="WORLD_BOUNDS",e[e.NODE=4]="NODE",e[e.TRANSFORM=5]="TRANSFORM",e[e.SUB_MODEL_ARRAY=6]="SUB_MODEL_ARRAY",e[e.COUNT=7]="COUNT"}(Af||(Af={}));var Rf,If=(a(zd={},Af.ENABLED,Jd.UINT32),a(zd,Af.VIS_FLAGS,Jd.UINT32),a(zd,Af.CAST_SHADOW,Jd.UINT32),a(zd,Af.WORLD_BOUNDS,Jd.UINT32),a(zd,Af.NODE,Jd.UINT32),a(zd,Af.TRANSFORM,Jd.UINT32),a(zd,Af.SUB_MODEL_ARRAY,Jd.UINT32),a(zd,Af.COUNT,Jd.NEVER),zd),Of=new lf(sf.MODEL,If,Af);!function(e){e[e.CENTER=0]="CENTER",e[e.HALF_EXTENSION=3]="HALF_EXTENSION",e[e.COUNT=6]="COUNT"}(Rf||(Rf={}));var Mf,Pf=(a(Ud={},Rf.CENTER,Jd.FLOAT32),a(Ud,Rf.HALF_EXTENSION,Jd.FLOAT32),a(Ud,Rf.COUNT,Jd.NEVER),Ud),kf=new lf(sf.AABB,Pf,Rf);!function(e){e[e.MAIN_LIGHT=0]="MAIN_LIGHT",e[e.MODEL_ARRAY=1]="MODEL_ARRAY",e[e.COUNT=2]="COUNT"}(Mf||(Mf={}));var Df,Bf=(a(Gd={},Mf.MAIN_LIGHT,Jd.UINT32),a(Gd,Mf.MODEL_ARRAY,Jd.UINT32),a(Gd,Mf.COUNT,Jd.NEVER),Gd),Lf=new lf(sf.SCENE,Bf,Mf);!function(e){e[e.WIDTH=0]="WIDTH",e[e.HEIGHT=1]="HEIGHT",e[e.EXPOSURE=2]="EXPOSURE",e[e.CLEAR_FLAG=3]="CLEAR_FLAG",e[e.CLEAR_DEPTH=4]="CLEAR_DEPTH",e[e.CLEAR_STENCIL=5]="CLEAR_STENCIL",e[e.NODE=6]="NODE",e[e.SCENE=7]="SCENE",e[e.FRUSTUM=8]="FRUSTUM",e[e.FORWARD=9]="FORWARD",e[e.POSITION=12]="POSITION",e[e.VIEW_PORT=15]="VIEW_PORT",e[e.CLEAR_COLOR=19]="CLEAR_COLOR",e[e.MAT_VIEW=23]="MAT_VIEW",e[e.MAT_VIEW_PROJ=39]="MAT_VIEW_PROJ",e[e.MAT_VIEW_PROJ_INV=55]="MAT_VIEW_PROJ_INV",e[e.MAT_PROJ=71]="MAT_PROJ",e[e.MAT_PROJ_INV=87]="MAT_PROJ_INV",e[e.COUNT=103]="COUNT"}(Df||(Df={}));var Nf,Ff=(a(Hd={},Df.WIDTH,Jd.UINT32),a(Hd,Df.HEIGHT,Jd.UINT32),a(Hd,Df.EXPOSURE,Jd.FLOAT32),a(Hd,Df.CLEAR_FLAG,Jd.UINT32),a(Hd,Df.CLEAR_DEPTH,Jd.FLOAT32),a(Hd,Df.CLEAR_STENCIL,Jd.UINT32),a(Hd,Df.NODE,Jd.UINT32),a(Hd,Df.SCENE,Jd.UINT32),a(Hd,Df.FRUSTUM,Jd.UINT32),a(Hd,Df.FORWARD,Jd.FLOAT32),a(Hd,Df.POSITION,Jd.FLOAT32),a(Hd,Df.VIEW_PORT,Jd.UINT32),a(Hd,Df.CLEAR_COLOR,Jd.FLOAT32),a(Hd,Df.MAT_VIEW,Jd.FLOAT32),a(Hd,Df.MAT_VIEW_PROJ,Jd.FLOAT32),a(Hd,Df.MAT_VIEW_PROJ_INV,Jd.FLOAT32),a(Hd,Df.MAT_PROJ,Jd.FLOAT32),a(Hd,Df.MAT_PROJ_INV,Jd.FLOAT32),a(Hd,Df.COUNT,Jd.NEVER),Hd),zf=new lf(sf.CAMERA,Ff,Df);!function(e){e[e.LAYER=0]="LAYER",e[e.WORLD_SCALE=1]="WORLD_SCALE",e[e.WORLD_POSITION=4]="WORLD_POSITION",e[e.WORLD_ROTATION=7]="WORLD_ROTATION",e[e.WORLD_MATRIX=11]="WORLD_MATRIX",e[e.COUNT=27]="COUNT"}(Nf||(Nf={}));var Uf=(a(Vd={},Nf.LAYER,Jd.UINT32),a(Vd,Nf.WORLD_SCALE,Jd.FLOAT32),a(Vd,Nf.WORLD_POSITION,Jd.FLOAT32),a(Vd,Nf.WORLD_ROTATION,Jd.FLOAT32),a(Vd,Nf.WORLD_MATRIX,Jd.FLOAT32),a(Vd,Nf.COUNT,Jd.NEVER),Vd);delete Nf[Nf.COUNT],Nf[Nf.COUNT=Nf.LAYER+1]="COUNT";var Gf,Hf=new lf(sf.NODE,Uf,Nf);!function(e){e[e.CUMULATIVE_TIME=0]="CUMULATIVE_TIME",e[e.FRAME_TIME=1]="FRAME_TIME",e[e.COUNT=2]="COUNT"}(Gf||(Gf={}));var Vf,Wf=(a(Wd={},Gf.CUMULATIVE_TIME,Jd.FLOAT32),a(Wd,Gf.FRAME_TIME,Jd.FLOAT32),a(Wd,Gf.COUNT,Jd.NEVER),Wd),jf=new lf(sf.ROOT,Wf,Gf,1);!function(e){e[e.HAS_ON_SCREEN_ATTACHMENTS=0]="HAS_ON_SCREEN_ATTACHMENTS",e[e.HAS_OFF_SCREEN_ATTACHMENTS=1]="HAS_OFF_SCREEN_ATTACHMENTS",e[e.FRAMEBUFFER=2]="FRAMEBUFFER",e[e.COUNT=3]="COUNT"}(Vf||(Vf={}));var qf,Xf=(a(jd={},Vf.HAS_ON_SCREEN_ATTACHMENTS,Jd.UINT32),a(jd,Vf.HAS_OFF_SCREEN_ATTACHMENTS,Jd.UINT32),a(jd,Vf.FRAMEBUFFER,Jd.UINT32),a(jd,Vf.COUNT,Jd.NEVER),jd),Yf=new lf(sf.RENDER_WINDOW,Xf,Vf,2);!function(e){e[e.VERTICES=0]="VERTICES",e[e.PLANES=24]="PLANES",e[e.COUNT=48]="COUNT"}(qf||(qf={}));var Kf,Zf=(a(qd={},qf.VERTICES,Jd.FLOAT32),a(qd,qf.PLANES,Jd.FLOAT32),a(qd,qf.COUNT,Jd.NEVER),qd),Qf=new lf(sf.FRUSTUM,Zf,qf);!function(e){e[e.ENABLE=0]="ENABLE",e[e.ILLUM=1]="ILLUM",e[e.SKY_COLOR=2]="SKY_COLOR",e[e.GROUND_ALBEDO=6]="GROUND_ALBEDO",e[e.COUNT=10]="COUNT"}(Kf||(Kf={}));var Jf=(a(Xd={},Kf.ENABLE,Jd.UINT32),a(Xd,Kf.ILLUM,Jd.FLOAT32),a(Xd,Kf.SKY_COLOR,Jd.FLOAT32),a(Xd,Kf.GROUND_ALBEDO,Jd.FLOAT32),a(Xd,Kf.COUNT,Jd.NEVER),Xd);delete Kf[Kf.COUNT],Kf[Kf.COUNT=Kf.ILLUM+1]="COUNT";var $f,ep=new lf(sf.AMBIENT,Jf,Kf,1);!function(e){e[e.ENABLE=0]="ENABLE",e[e.IS_RGBE=1]="IS_RGBE",e[e.USE_IBL=2]="USE_IBL",e[e.MODEL=3]="MODEL",e[e.COUNT=4]="COUNT"}($f||($f={}));var tp,ip=(a(Yd={},$f.ENABLE,Jd.UINT32),a(Yd,$f.IS_RGBE,Jd.UINT32),a(Yd,$f.USE_IBL,Jd.UINT32),a(Yd,$f.MODEL,Jd.UINT32),a(Yd,$f.COUNT,Jd.NEVER),Yd),np=new lf(sf.SKYBOX,ip,$f,1);!function(e){e[e.ENABLE=0]="ENABLE",e[e.TYPE=1]="TYPE",e[e.DENSITY=2]="DENSITY",e[e.START=3]="START",e[e.END=4]="END",e[e.ATTEN=5]="ATTEN",e[e.TOP=6]="TOP",e[e.RANGE=7]="RANGE",e[e.COLOR=8]="COLOR",e[e.COUNT=12]="COUNT"}(tp||(tp={}));var rp=(a(Kd={},tp.ENABLE,Jd.UINT32),a(Kd,tp.TYPE,Jd.UINT32),a(Kd,tp.DENSITY,Jd.FLOAT32),a(Kd,tp.START,Jd.FLOAT32),a(Kd,tp.END,Jd.FLOAT32),a(Kd,tp.ATTEN,Jd.FLOAT32),a(Kd,tp.TOP,Jd.FLOAT32),a(Kd,tp.RANGE,Jd.FLOAT32),a(Kd,tp.COLOR,Jd.FLOAT32),a(Kd,tp.COUNT,Jd.NEVER),Kd);delete tp[tp.COUNT],tp[tp.COUNT=tp.RANGE+1]="COUNT";var ap,op=new lf(sf.FOG,rp,tp);!function(e){e[e.ENABLE=0]="ENABLE",e[e.DIRTY=1]="DIRTY",e[e.TYPE=2]="TYPE",e[e.DISTANCE=3]="DISTANCE",e[e.INSTANCE_PASS=4]="INSTANCE_PASS",e[e.PLANAR_PASS=5]="PLANAR_PASS",e[e.NEAR=6]="NEAR",e[e.FAR=7]="FAR",e[e.ASPECT=8]="ASPECT",e[e.PCF_TYPE=9]="PCF_TYPE",e[e.ORTHO_SIZE=10]="ORTHO_SIZE",e[e.SIZE=11]="SIZE",e[e.NORMAL=13]="NORMAL",e[e.COLOR=16]="COLOR",e[e.SPHERE=20]="SPHERE",e[e.COUNT=24]="COUNT"}(ap||(ap={}));var sp=(a(Zd={},ap.ENABLE,Jd.UINT32),a(Zd,ap.TYPE,Jd.UINT32),a(Zd,ap.DISTANCE,Jd.FLOAT32),a(Zd,ap.INSTANCE_PASS,Jd.UINT32),a(Zd,ap.PLANAR_PASS,Jd.UINT32),a(Zd,ap.NEAR,Jd.FLOAT32),a(Zd,ap.FAR,Jd.FLOAT32),a(Zd,ap.ASPECT,Jd.FLOAT32),a(Zd,ap.PCF_TYPE,Jd.UINT32),a(Zd,ap.DIRTY,Jd.UINT32),a(Zd,ap.ORTHO_SIZE,Jd.UINT32),a(Zd,ap.SIZE,Jd.FLOAT32),a(Zd,ap.NORMAL,Jd.FLOAT32),a(Zd,ap.COLOR,Jd.FLOAT32),a(Zd,ap.SPHERE,Jd.FLOAT32),a(Zd,ap.COUNT,Jd.NEVER),Zd);delete ap[tp.COUNT],ap[ap.COUNT=ap.ORTHO_SIZE+1]="COUNT";var lp,cp=new lf(sf.SHADOW,sp,ap,1);!function(e){e[e.USE_COLOR_TEMPERATURE=0]="USE_COLOR_TEMPERATURE",e[e.ILLUMINANCE=1]="ILLUMINANCE",e[e.NODE=2]="NODE",e[e.DIRECTION=3]="DIRECTION",e[e.COLOR=6]="COLOR",e[e.COLOR_TEMPERATURE_RGB=9]="COLOR_TEMPERATURE_RGB",e[e.COUNT=12]="COUNT"}(lp||(lp={}));var up=(a(Qd={},lp.USE_COLOR_TEMPERATURE,Jd.UINT32),a(Qd,lp.ILLUMINANCE,Jd.FLOAT32),a(Qd,lp.NODE,Jd.UINT32),a(Qd,lp.DIRECTION,Jd.FLOAT32),a(Qd,lp.COLOR,Jd.FLOAT32),a(Qd,lp.COLOR_TEMPERATURE_RGB,Jd.FLOAT32),a(Qd,lp.COUNT,Jd.NEVER),Qd),hp=new lf(sf.LIGHT,up,lp,3),_p=new Fl;function dp(e){return Math.ceil(Math.log2(Math.max(e,2)))}function fp(e,t){switch(e.type){case"boolean":return("number"==typeof t?t:t?1:0)+"";case"string":return void 0!==t?t:e.options[0];case"number":return(void 0!==t?t:e.range[0])+""}return console.warn("unknown define type '".concat(e.type,"'")),"-1"}function pp(e,t,i){for(var n=e.builtins[i],r=[],a=0;a<n.blocks.length;a++){var o=n.blocks[a],s=t.layouts[o.name];s&&t.bindings[s.binding].descriptorType&kl?r.push(s):console.warn("builtin UBO '".concat(o.name,"' not available!"))}Array.prototype.unshift.apply(e.gfxBlocks,r);for(var l=[],c=0;c<n.samplers.length;c++){var u=n.samplers[c],h=t.layouts[u.name];h&&t.bindings[h.binding].descriptorType&Dl?l.push(h):console.warn("builtin sampler '".concat(u.name,"' not available!"))}Array.prototype.unshift.apply(e.gfxSamplers,l)}function mp(e){return e.members.reduce((function(e,t){return e+Fs(t.type)*t.count}),0)}function vp(e,t){for(var i=0;i<e.length;i++){var n=e[i];if("!"===n[0]){if(t[n.slice(1)])return!1}else if(!t[n])return!1}return!0}var gp=null,yp=new(function(){function e(){i(this,e),this._templates={},this._pipelineLayouts={},this._cache={}}return r(e,[{key:"define",value:function(e){var t=this._templates[e.name];if(!t||t.hash!==e.hash){for(var i=Object.assign({},e),n=0,r=function(e){var t=i.defines[e],r=1;if("number"===t.type){var a=t.range;r=dp(a[1]-a[0]+1),t._map=function(e){return e-a[0]}}else"string"===t.type?(r=dp(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=n,n+=r},a=0;a<i.defines.length;a++)r(a);n>31&&(i.uber=!0),i.samplerStartBinding=i.blocks.length,i.gfxBlocks=[],i.gfxSamplers=[],i.bindings=[],i.blockSizes=[];for(var o=0;o<i.blocks.length;o++){var s=i.blocks[o];i.blockSizes.push(mp(s)),i.bindings.push(new Nl(s.descriptorType||_s.UNIFORM_BUFFER,1,s.stageFlags)),i.gfxBlocks.push(new Al(Gh.MATERIAL,s.binding,s.name,s.members.map((function(e){return new bl(e.name,e.type,e.count)})),1))}for(var l=0;l<i.samplers.length;l++){var c=i.samplers[l];i.bindings.push(new Nl(c.descriptorType||_s.SAMPLER,c.count,c.stageFlags)),i.gfxSamplers.push(new Cl(Gh.MATERIAL,c.binding,c.name,c.type,c.count))}i.gfxAttributes=[];for(var u=0;u<i.attributes.length;u++){var h=i.attributes[u];i.gfxAttributes.push(new al(h.name,h.format,h.isNormalized,0,h.isInstanced,h.location))}i.gfxStages=[],i.gfxStages.push(new El(hs.VERTEX,"")),i.gfxStages.push(new El(hs.FRAGMENT,"")),i.handleMap=function(e){for(var t={},i=0;i<e.blocks.length;i++)for(var n=e.blocks[i],r=n.members,a=0,o=0;o<r.length;o++){var s=r[o];t[s.name]=fd(_d.UBO,Gh.MATERIAL,n.binding,s.type,a),a+=(Fs(s.type)>>2)*s.count}for(var l=0;l<e.samplers.length;l++){var c=e.samplers[l];t[c.name]=fd(_d.SAMPLER,Gh.MATERIAL,c.binding,c.type)}return t}(i),this._templates[e.name]=i,this._pipelineLayouts[e.name]={hPipelineLayout:0,setLayouts:[]}}}},{key:"getTemplate",value:function(e){return this._templates[e]}},{key:"getPipelineLayout",value:function(e){return this._pipelineLayouts[e]}},{key:"hasProgram",value:function(e){return void 0!==this._templates[e]}},{key:"getKey",value:function(e,t){var i=this._templates[e],n=i.defines;if(i.uber){for(var r="",a=0;a<n.length;a++){var o=n[a],s=t[o.name];if(s&&o._map){var l=o._map(s);r+=o._offset+(l+"|")}}return r+i.hash}for(var c=0,u=0;u<n.length;u++){var h=n[u],_=t[h.name];if(_&&h._map)c|=h._map(_)<<h._offset}return"".concat(c.toString(16),"|").concat(i.hash)}},{key:"destroyShaderByDefines",value:function(e){var t=this,i=Object.keys(e);if(i.length)for(var n=i.map((function(t){var i=e[t];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(t+i)})),r=Object.keys(this._cache).filter((function(e){return n.every((function(i){return i.test(pf.get(t._cache[e]).name)}))})),a=0;a<r.length;a++){var o=r[a],s=pf.get(this._cache[o]);console.log("destroyed shader ".concat(s.name)),s.destroy(),delete this._cache[o]}}},{key:"getGFXShader",value:function(e,t,i,n,r){Object.assign(i,n.macros),r||(r=this.getKey(t,i));var a=this._cache[r];if(a)return a;var o=this._templates[t],s=this._pipelineLayouts[t];s.hPipelineLayout||(pp(o,Nh,"locals"),pp(o,Lh,"globals"),s.setLayouts[Gh.GLOBAL]=n.descriptorSetLayout,s.setLayouts[Gh.MATERIAL]||(_p.bindings=o.bindings,s.setLayouts[Gh.MATERIAL]=e.createDescriptorSetLayout(_p)),_p.bindings=Nh.bindings,s.setLayouts[Gh.LOCAL]=gp=gp||e.createDescriptorSetLayout(_p),s.hPipelineLayout=gf.alloc(e,new Gl(s.setLayouts)));var l=function(e,t){for(var i=[],n=0;n<t.length;n++){var r=t[n],a=r.name,o=e[a],s=fp(r,o),l=!o||"0"===o;i.push({name:a,value:s,isDefault:l})}return i}(i,o.defines),c=l.reduce((function(e,t){return"".concat(e,"#define ").concat(t.name," ").concat(t.value,"\n")}),"")+"\n",u=o.glsl3;switch(e.gfxAPI){case Us.GLES2:case Us.WEBGL:u=o.glsl1;break;case Us.GLES3:case Us.WEBGL2:u=o.glsl3;break;case Us.VULKAN:case Us.METAL:u=o.glsl4;break;default:console.error("Invalid GFX API!")}o.gfxStages[0].source=c+u.vert,o.gfxStages[1].source=c+u.frag;var h=function(e,t){for(var i=[],n=e.attributes,r=e.gfxAttributes,a=0;a<n.length;a++)vp(n[a].defines,t)&&i.push(r[a]);return i}(o,i),_=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:"".concat(e,"|").concat(t.name).concat(t.value)}),"")}(t,l),d=new wl(_,o.gfxStages,h,o.gfxBlocks,o.gfxSamplers);return this._cache[r]=pf.alloc(e,d)}}]),e}());E.programLib=yp;var xp,Sp=new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE),Tp=new Xs(null),Ep=new Fl,bp=new Bl(null);!function(e){e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(xp||(xp={}));var Ap=function(){function e(t){i(this,e),this._rootBuffer=null,this._rootBufferDirty=!1,this._buffers=[],this._descriptorSet=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._root=void 0,this._device=void 0,this._hShaderDefault=0,this._handle=0,this._root=t,this._device=t.device}return r(e,null,[{key:"fillPipelineInfo",value:function(e,t){void 0!==t.priority&&bf.set(e,hf.PRIORITY,t.priority),void 0!==t.primitive&&bf.set(e,hf.PRIMITIVE,t.primitive),void 0!==t.stage&&bf.set(e,hf.STAGE,t.stage),void 0!==t.dynamicStates&&bf.set(e,hf.DYNAMIC_STATES,t.dynamicStates),void 0!==t.phase&&bf.set(e,hf.PHASE,nf(t.phase));var i=ff.get(bf.get(e,hf.BLEND_STATE));if(t.blendState){var n=t.blendState;n.targets&&n.targets.forEach((function(e,t){i.targets[t]||i.setTarget(t,new ul),Object.assign(i.targets[t],e)})),void 0!==n.isA2C&&(i.isA2C=n.isA2C),void 0!==n.isIndepend&&(i.isIndepend=n.isIndepend),void 0!==n.blendColor&&Object.assign(i.blendColor,n.blendColor)}Object.assign(_f.get(bf.get(e,hf.RASTERIZER_STATE)),t.rasterizerState),Object.assign(df.get(bf.get(e,hf.DEPTH_STENCIL_STATE)),t.depthStencilState)}},{key:"getPassHash",value:function(e,t){var i,n=t+","+bf.get(e,hf.PRIMITIVE)+","+bf.get(e,hf.DYNAMIC_STATES);return n+=function(e){for(var t,i=",bs,".concat(e.isA2C,",").concat(e.blendColor),n=y(e.targets);!(t=n()).done;){var r=t.value;i+=",bt,".concat(r.blend,",").concat(r.blendEq,",").concat(r.blendAlphaEq,",").concat(r.blendColorMask),i+=",".concat(r.blendSrc,",").concat(r.blendDst,",").concat(r.blendSrcAlpha,",").concat(r.blendDstAlpha)}return i}(ff.get(bf.get(e,hf.BLEND_STATE))),n+=function(e){var t=",dss,".concat(e.depthTest,",").concat(e.depthWrite,",").concat(e.depthFunc);return t+=",".concat(e.stencilTestFront,",").concat(e.stencilFuncFront,",").concat(e.stencilRefFront,",").concat(e.stencilReadMaskFront),t+=",".concat(e.stencilFailOpFront,",").concat(e.stencilZFailOpFront,",").concat(e.stencilPassOpFront,",").concat(e.stencilWriteMaskFront),t+=",".concat(e.stencilTestBack,",").concat(e.stencilFuncBack,",").concat(e.stencilRefBack,",").concat(e.stencilReadMaskBack),t+=",".concat(e.stencilFailOpBack,",").concat(e.stencilZFailOpBack,",").concat(e.stencilPassOpBack,",").concat(e.stencilWriteMaskBack)}(df.get(bf.get(e,hf.DEPTH_STENCIL_STATE))),rl(n+=",rs,"+(i=_f.get(bf.get(e,hf.RASTERIZER_STATE))).cullMode+","+i.depthBias+","+i.isFrontFaceCCW,666)}}]),r(e,[{key:"initialize",value:function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()}},{key:"getHandle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Wo.UNKNOWN,n=this._propertyHandleMap[e];return n?(i?n=yd(n,i):t&&(n=yd(n,md(n)-t)),n+t):0}},{key:"getBinding",value:function(t){var i=this.getHandle(t);return i?e.getBindingFromHandle(i):-1}},{key:"setUniform",value:function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._blocks[n];Sd[r](o,i,a),this._rootBufferDirty=!0}},{key:"getUniform",value:function(t,i){var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=e.getOffsetFromHandle(t),o=this._blocks[n];return xd[r](o,i,a)}},{key:"setUniformArray",value:function(t,i){for(var n=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),a=Fs(r)>>2,o=this._blocks[n],s=e.getOffsetFromHandle(t),l=0;l<i.length;l++,s+=a)null!==i[l]&&Sd[r](o,i[l],s);this._rootBufferDirty=!0}},{key:"bindTexture",value:function(e,t,i){this._descriptorSet.bindTexture(e,t,i||0)}},{key:"bindSampler",value:function(e,t,i){this._descriptorSet.bindSampler(e,t,i||0)}},{key:"setDynamicState",value:function(e,t){var i=this._dynamics[e];i&&i.value===t||(i.value=t,i.dirty=!0)}},{key:"overridePipelineStates",value:function(e,t){console.warn("base pass cannot override states, please use pass instance instead.")}},{key:"update",value:function(){this._rootBufferDirty&&this._rootBuffer&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()}},{key:"destroy",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBlock=null),this._descriptorSet=null,this._handle&&(_f.free(bf.get(this._handle,hf.RASTERIZER_STATE)),df.free(bf.get(this._handle,hf.DEPTH_STENCIL_STATE)),ff.free(bf.get(this._handle,hf.BLEND_STATE)),mf.free(bf.get(this._handle,hf.DESCRIPTOR_SET)),bf.free(this._handle),this._handle=0)}},{key:"resetUniform",value:function(t){var i=this.getHandle(t);if(i){var n=e.getTypeFromHandle(i),r=e.getBindingFromHandle(i),a=e.getOffsetFromHandle(i),o=this._blocks[r],s=this._properties[t],l=s&&s.value||Ed(n);Sd[n](o,l,a),this._rootBufferDirty=!0}}},{key:"resetTexture",value:function(t,i){var n=this.getHandle(t);if(n){var r=e.getTypeFromHandle(n),a=e.getBindingFromHandle(n),o=this._properties[t],s=o&&o.value,l=s?s+"-texture":Ed(r),c=tf.get(l),u=c&&c.getGFXTexture(),h=o&&void 0!==o.samplerHash?o.samplerHash:c.getSamplerHash(),_=vh.getSampler(this._device,h);this._descriptorSet.bindSampler(a,_,i),this._descriptorSet.bindTexture(a,u,i)}}},{key:"resetUBOs",value:function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],i=this._blocks[t.binding],n=0,r=0;r<t.members.length;r++){for(var a=t.members[r],o=this._properties[a.name],s=o&&o.value,l=s||Ed(a.type),c=(Fs(a.type)>>2)*a.count,u=0;u+l.length<=c;u+=l.length)i.set(l,n+u);n+=c}this._rootBufferDirty=!0}},{key:"resetTextures",value:function(){for(var e=0;e<this._shaderInfo.samplers.length;e++)for(var t=this._shaderInfo.samplers[e],i=0;i<t.count;i++)this.resetTexture(t.name,i)}},{key:"tryCompile",value:function(){var t=this._root.pipeline;return t?(this._syncBatchingScheme(),this._hShaderDefault=yp.getGFXShader(this._device,this._programName,this._defines,t),this._hShaderDefault?(bf.set(this._handle,hf.PIPELINE_LAYOUT,yp.getPipelineLayout(this._programName).hPipelineLayout),bf.set(this._handle,hf.HASH,e.getPassHash(this._handle,this._hShaderDefault)),!0):(console.warn("create shader ".concat(this._programName," failed")),!1)):null}},{key:"getShaderVariant",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this._hShaderDefault&&!this.tryCompile())return console.warn("pass resources incomplete"),0;if(!e)return this._hShaderDefault;for(var t=this._root.pipeline,i=0;i<e.length;i++){var n=e[i];this._defines[n.name]=n.value}for(var r=yp.getGFXShader(this._device,this._programName,this._defines,t),a=0;a<e.length;a++){var o=e[a];delete this._defines[o.name]}return r}},{key:"beginChangeStatesSilently",value:function(){}},{key:"endChangeStatesSilently",value:function(){}},{key:"_doInit",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this._handle=bf.alloc();bf.set(n,hf.PRIORITY,Dh.DEFAULT),bf.set(n,hf.STAGE,kh.DEFAULT),bf.set(n,hf.PHASE,nf("default")),bf.set(n,hf.PRIMITIVE,Zo.TRIANGLE_LIST),bf.set(n,hf.RASTERIZER_STATE,_f.alloc()),bf.set(n,hf.DEPTH_STENCIL_STATE,df.alloc()),bf.set(n,hf.BLEND_STATE,ff.alloc()),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=i?Object.assign({},t.defines):t.defines,this._shaderInfo=yp.getTemplate(t.program),this._properties=t.properties||this._properties;var r=this._device;e.fillPipelineInfo(n,t),t.stateOverrides&&e.fillPipelineInfo(n,t.stateOverrides);var a=yp.getPipelineLayout(t.program).setLayouts;a[Gh.MATERIAL]||(Ep.bindings=this._shaderInfo.bindings,a[Gh.MATERIAL]=r.createDescriptorSetLayout(Ep)),bp.layout=a[Gh.MATERIAL];var o=mf.alloc(this._device,bp);bf.set(this._handle,hf.DESCRIPTOR_SET,o),this._descriptorSet=mf.get(o);for(var s=this._shaderInfo,l=s.blocks,c=s.blockSizes,u=r.uboOffsetAlignment,h=[],_=0,d=0,f=0;f<l.length;f++){var p=c[f];h.push(d),d+=Math.ceil(p/u)*u,_=p}var m=h[h.length-1]+_;m&&(Sp.size=16*Math.ceil(m/16),this._rootBuffer=r.createBuffer(Sp),this._rootBlock=new ArrayBuffer(m));for(var v=0,g=0;v<l.length;v++){var y=l[v].binding,x=c[v];Tp.buffer=this._rootBuffer,Tp.offset=h[g++],Tp.range=x;var S=this._buffers[y]=r.createBuffer(Tp);this._blocks[y]=new Float32Array(this._rootBlock,Tp.offset,x/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(y,S)}var T=this._propertyHandleMap=this._shaderInfo.handleMap,E={};for(var b in this._properties){var A=this._properties[b];A.handleInfo&&(E[b]=this.getHandle.apply(this,A.handleInfo))}Object.assign(T,E)}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_INSTANCING?this._device.hasFeature(Gs.INSTANCED_ARRAYS)?bf.set(this._handle,hf.BATCHING_SCHEME,xp.INSTANCING):(this._defines.USE_INSTANCING=!1,bf.set(this._handle,hf.BATCHING_SCHEME,0)):this._defines.USE_BATCHING?bf.set(this._handle,hf.BATCHING_SCHEME,xp.VB_MERGING):bf.set(this._handle,hf.BATCHING_SCHEME,0)}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"setLayouts",get:function(){return yp.getPipelineLayout(this._programName).setLayouts}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"handle",get:function(){return this._handle}},{key:"priority",get:function(){return bf.get(this._handle,hf.PRIORITY)}},{key:"primitive",get:function(){return bf.get(this._handle,hf.PRIMITIVE)}},{key:"stage",get:function(){return bf.get(this._handle,hf.STAGE)}},{key:"phase",get:function(){return bf.get(this._handle,hf.PHASE)}},{key:"rasterizerState",get:function(){return _f.get(bf.get(this._handle,hf.RASTERIZER_STATE))}},{key:"depthStencilState",get:function(){return df.get(bf.get(this._handle,hf.DEPTH_STENCIL_STATE))}},{key:"blendState",get:function(){return ff.get(bf.get(this._handle,hf.BLEND_STATE))}},{key:"dynamicStates",get:function(){return bf.get(this._handle,hf.DYNAMIC_STATES)}},{key:"batchingScheme",get:function(){return bf.get(this._handle,hf.BATCHING_SCHEME)}},{key:"hash",get:function(){return bf.get(this._handle,hf.HASH)}}]),e}();function Cp(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function wp(e,t){return Math.ceil(e/t)*t}Ap.PropertyType=_d,Ap.getPropertyTypeFromHandle=pd,Ap.getTypeFromHandle=md,Ap.getBindingFromHandle=vd,Ap.getOffsetFromHandle=gd;var Rp,Ip,Op,Mp,Pp,kp,Dp,Bp,Lp,Np,Fp,zp,Up,Gp,Hp,Vp,Wp=function(){function e(t){i(this,e),this._device=void 0,this._format=jo.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Ms,this._region1=new Ms,this._region2=new Ms,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}return r(e,[{key:"initialize",value:function(e){var t=Ds[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=zs(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)}},{key:"destroy",value:function(){for(var e=0;e<this._chunkCount;++e){this._chunks[e].texture.destroy()}this._chunks.length=0,this._handles.length=0}},{key:"alloc",value:function(e,t){e=wp(e,this._alignment);var i=-1,n=-1;if(void 0!==t&&(i=t,n=this._findAvailableSpace(e,i)),n<0)for(var r=0;r<this._chunkCount&&(i=r,!((n=this._findAvailableSpace(e,i))>=0));++r);if(n>=0){var a=this._chunks[i];a.start+=e;var o={chunkIdx:i,start:n,end:n+e,texture:a.texture};return this._handles.push(o),o}var s=Math.sqrt(e/this._formatSize),l=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,Cp(s)),c=this._chunks[this.createChunk(l)];c.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:c.texture};return this._handles.push(u),u}},{key:"free",value:function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)}},{key:"createChunk",value:function(e){var t=e*e*this._formatSize;console.info("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var i={texture:this._device.createTexture(new Il(ss.TEX2D,ls.SAMPLED|ls.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=i,this._chunkCount++}},{key:"update",value:function(e,t){var i=[],n=[],r=e.start/this._formatSize,a=t.byteLength/this._formatSize,o=r%e.texture.width,s=Math.floor(r/e.texture.width),l=Math.min(e.texture.width-o,a),c=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=s,this._region0.texExtent.width=l,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(t,c*this._formatSize,l*this._channels)),n.push(this._region0),o=0,s+=1,a-=l,c+=l),a>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=s,a>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(a/e.texture.width),l=this._region1.texExtent.width*this._region1.texExtent.height):(l=a,this._region1.texExtent.width=l,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(t,c*this._formatSize,l*this._channels)),n.push(this._region1),o=0,s+=this._region1.texExtent.height,a-=l,c+=l),a>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=s,this._region2.texExtent.width=a,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(t,c*this._formatSize,a*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,e.texture,n)}},{key:"_findAvailableSpace",value:function(e,t){var i=this._chunks[t],n=!1,r=i.start;if(r+e<=i.size)n=!0;else{r=0;for(var a=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),o=0;o<a.length;o++){var s=a[o];if(r+e<=s.start){n=!0;break}r=s.end}!n&&r+e<=i.size&&(n=!0)}return n?r:-1}},{key:"_McDonaldAlloc",value:function(e){e=wp(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var i=this._chunks[t],n=!1,r=i.start;if(r+e<=i.end?n=!0:r>i.end?r+e<=i.size?n=!0:e<=i.end&&(i.start=r=0,n=!0):r===i.end&&(i.start=r=0,i.end=i.size,e<=i.end&&(n=!0)),n){i.start+=e;var a={chunkIdx:t,start:r,end:r+e,texture:i.texture};return this._handles.push(a),a}}var o=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(o,this._formatSize)||Math.max(1024,Cp(o)),l=this._chunks[this.createChunk(s)];l.start+=e;var c={chunkIdx:this._chunkCount,start:0,end:e,texture:l.texture};return this._handles.push(c),c}}]),e}(),jp={},qp=e("EffectAsset",ii("cc.EffectAsset")((Dp=kp=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"techniques",Op,c(n)),x(n,"shaders",Mp,c(n)),x(n,"combinations",Pp,c(n)),n}return o(t,e),r(t,[{key:"onLoaded",value:function(){this.shaders.forEach((function(e){return yp.define(e)})),E.game.once(E.Game.EVENT_ENGINE_INITED,this._precompile,this),t.register(this)}},{key:"_precompile",value:function(){for(var e=this,t=E.director.root,i=function(i){var n=e.shaders[i],r=e.combinations[i];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,i){var n=r[t],a=[i].concat(m(Array(n.length-1)).map((function(){return Object.assign({},i)})));return a.forEach((function(e,i){return e[t]=n[i]})),e.concat(a)}),[])}),[{}]).forEach((function(e){return yp.getGFXShader(t.device,n.name,e,t.pipeline)}))},n=0;n<this.shaders.length;n++)i(n)}}],[{key:"register",value:function(e){jp[e.name]=e}},{key:"remove",value:function(e){if(jp[e])delete jp[e];else for(var t in jp)if(jp[t]._uuid===e)return void delete jp[t]}},{key:"get",value:function(e){if(jp[e])return jp[e];for(var t in jp)if(jp[t]._uuid===e)return jp[t];return null}},{key:"getAll",value:function(){return jp}}]),t}(cn),kp._effects={},Op=S((Ip=Dp).prototype,"techniques",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Mp=S(Ip.prototype,"shaders",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pp=S(Ip.prototype,"combinations",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rp=Ip))||Rp);E.EffectAsset=qp;var Xp=new vl;Xp.endLayout=ms.SHADER_READONLY_OPTIMAL;var Yp,Kp,Zp,Qp,Jp,$p,em,tm,im,nm=new gl,rm=new yl([Xp],nm),am={width:1,height:1,renderPassInfo:rm},om=e("RenderTexture",(Bp=ii("cc.RenderTexture"),Lp=Ei(1),Np=bi(2048),Fp=Ei(1),zp=bi(2048),Bp((Hp=S((Gp=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_width",Hp,c(n)),x(n,"_height",Vp,c(n)),n._window=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){this._window&&(E.director.root.destroyWindow(this._window),this._window=null);return _(s(t.prototype),"destroy",this).call(this)}},{key:"resize",value:function(e,t){this._width=e,this._height=t,this._window&&this._window.resize(e,t),this.emit("resize",this._window)}},{key:"getGFXTexture",value:function(){return this._window&&this._window.framebuffer.colorTextures[0]}},{key:"getGFXSampler",value:function(){var e=E.director.root;return vh.getSampler(e.device,th)}},{key:"onLoaded",value:function(){this._initWindow(),this.loaded=!0,this.emit("load")}},{key:"_initWindow",value:function(e){var t=E.director.root;am.title=this._name,am.width=this._width,am.height=this._height,am.renderPassInfo=e&&e.passInfo?e.passInfo:rm,this._window?(this._window.destroy(),this._window.initialize(t.device,am)):this._window=t.createWindow(am)}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"window",get:function(){return this._window}}]),t}(cn)).prototype,"_width",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Vp=S(Gp.prototype,"_height",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),S(Gp.prototype,"width",[Lp,Np],Object.getOwnPropertyDescriptor(Gp.prototype,"width"),Gp.prototype),S(Gp.prototype,"height",[Fp,zp],Object.getOwnPropertyDescriptor(Gp.prototype,"height"),Gp.prototype),Up=Gp))||Up));E.RenderTexture=om;var sm=e("Material",(Yp=ii("cc.Material"),Kp=Li(qp),Yp((Jp=S((Qp=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_effectAsset",Jp,c(e)),x(e,"_techIdx",$p,c(e)),x(e,"_defines",em,c(e)),x(e,"_states",tm,c(e)),x(e,"_props",im,c(e)),e._passes=[],e._hash=0,e.loaded=!1,e}return o(t,e),r(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}],[{key:"getHash",value:function(e){for(var t,i=0,n=y(e.passes);!(t=n()).done;){i^=t.value.hash}return i}}]),r(t,[{key:"initialize",value:function(e){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=qp.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states),this._update()}},{key:"reset",value:function(e){this.initialize(e)}},{key:"destroy",value:function(){return this._doDestroy(),_(s(t.prototype),"destroy",this).call(this)}},{key:"recompileShaders",value:function(e,t){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"overridePipelineStates",value:function(e,t){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")}},{key:"onLoaded",value:function(){this._update(),this.loaded=!0,this.emit("load")}},{key:"resetUniforms",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var i,n=y(this._passes);!(i=n()).done;){var r=i.value;r.resetUBOs(),r.resetTextures()}}},{key:"setProperty",value:function(e,t,i){var n=!1;if(void 0===i)for(var r=this._passes,a=r.length,o=0;o<a;o++){var s=r[o];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: ".concat(i,"."));var l=this._passes[i];this._uploadProperty(l,e,t)&&(this._props[l.propertyIndex][e]=t,n=!0)}n||console.warn("illegal property name: ".concat(e,"."))}},{key:"getProperty",value:function(e,t){if(void 0===t)for(var i=this._props,n=i.length,r=0;r<n;r++){var a=i[r];for(var o in a)if(o===e)return a[o]}else{if(t>=this._props.length)return console.warn("illegal pass index: ".concat(t,".")),null;var s=this._props[this._passes[t].propertyIndex];for(var l in s)if(l===e)return s[l]}return null}},{key:"copy",value:function(e){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var t=0;t<e._props.length;t++)this._props[t]=Object.assign({},e._props[t]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=Object.assign({},e._defines[i]);this._states.length=e._states.length;for(var n=0;n<e._states.length;n++)this._states[n]=Object.assign({},e._states[n]);this._effectAsset=e._effectAsset,this._update()}},{key:"_prepareInfo",value:function(e,t){if(!Array.isArray(e)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;e=Array(i).fill(e)}for(var n=0;n<e.length;++n)Object.assign(t[n]||(t[n]={}),e[n])}},{key:"_createPasses",value:function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,i=[],n=0;n<t;++n){var r=e.passes[n],a=r.passIndex=n,o=r.defines=this._defines[a]||(this._defines[a]={}),s=r.stateOverrides=this._states[a]||(this._states[a]={});if(void 0!==r.propertyIndex&&(Object.assign(o,this._defines[r.propertyIndex]),Object.assign(s,this._states[r.propertyIndex])),void 0!==r.embeddedMacros&&Object.assign(o,r.embeddedMacros),!r.switch||o[r.switch]){var l=new Ap(E.director.root);l.initialize(r),i.push(l)}}return i}},{key:"_update",value:function(){var e=this,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._effectAsset){if(this._passes&&this._passes.length)for(var n,r=y(this._passes);!(n=r()).done;){var a=n.value;a.destroy()}this._passes=this._createPasses();var o=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=o,i)this._passes.forEach((function(t,i){var n=e._props[i];for(var r in n||(n=e._props[i]={}),n=e._props[t.propertyIndex])e._uploadProperty(t,r,n[r])}));else for(var s=0;s<this._props.length;s++)this._props[s]={}}else{var l=tf.get("missing-effect-material");l&&(this._passes=l._passes.slice())}this._hash=t.getHash(this)}},{key:"_uploadProperty",value:function(e,t,i){var n=e.getHandle(t);if(!n)return!1;var r=Ap.getPropertyTypeFromHandle(n);if(r===_d.UBO)Array.isArray(i)?e.setUniformArray(n,i):null!==i?e.setUniform(n,i):e.resetUniform(t);else if(r===_d.SAMPLER){var a=Ap.getBindingFromHandle(n);if(Array.isArray(i))for(var o=0;o<i.length;o++)this._bindTexture(e,a,i[o],o);else i?this._bindTexture(e,a,i):e.resetTexture(t)}return!0}},{key:"_bindTexture",value:function(e,t,i,n){if(i instanceof Pl)e.bindTexture(t,i,n);else if(i instanceof yh||i instanceof Pd||i instanceof om){var r=i.getGFXTexture();if(!r||!r.width||!r.height)return!1;e.bindTexture(t,r,n),e.bindSampler(t,i.getGFXSampler(),n)}}},{key:"_doDestroy",value:function(){if(this._passes&&this._passes.length)for(var e,t=y(this._passes);!(e=t()).done;){e.value.destroy()}this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0}}]),t}(cn)).prototype,"_effectAsset",[Kp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$p=S(Qp.prototype,"_techIdx",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),em=S(Qp.prototype,"_defines",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tm=S(Qp.prototype,"_states",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),im=S(Qp.prototype,"_props",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zp=Qp))||Zp));E.Material=sm;var lm,cm=function(e){function t(e,n){var r;i(this,t),(r=u(this,s(t).call(this,e.root)))._parent=void 0,r._owner=void 0,r._dontNotify=!1,r._parent=e,r._owner=n,r._doInit(r._parent,!0);for(var a=0;a<r._shaderInfo.blocks.length;a++){var o=r._shaderInfo.blocks[a],l=r._blocks[o.binding],h=r._parent.blocks[o.binding];l.set(h)}r._rootBufferDirty=!0;for(var d=r._parent,f=0;f<r._shaderInfo.samplers.length;f++)for(var p=r._shaderInfo.samplers[f],m=0;m<p.count;m++){var v=d._descriptorSet.getSampler(p.binding,m),g=d._descriptorSet.getTexture(p.binding,m);r._descriptorSet.bindSampler(p.binding,v,m),r._descriptorSet.bindTexture(p.binding,g,m)}return _(s(t.prototype),"tryCompile",c(r)).call(c(r)),r}return o(t,e),r(t,[{key:"parent",get:function(){return this._parent}}]),r(t,[{key:"overridePipelineStates",value:function(e,t){ff.free(bf.get(this._handle,hf.BLEND_STATE)),_f.free(bf.get(this._handle,hf.RASTERIZER_STATE)),df.free(bf.get(this._handle,hf.DEPTH_STENCIL_STATE)),bf.set(this._handle,hf.BLEND_STATE,ff.alloc()),bf.set(this._handle,hf.RASTERIZER_STATE,_f.alloc()),bf.set(this._handle,hf.DEPTH_STENCIL_STATE,df.alloc()),Ap.fillPipelineInfo(this._handle,e),Ap.fillPipelineInfo(this._handle,t),this._onStateChange()}},{key:"tryCompile",value:function(e){if(e&&!bd(this._defines,e))return!1;var i=_(s(t.prototype),"tryCompile",this).call(this);return this._onStateChange(),i}},{key:"beginChangeStatesSilently",value:function(){this._dontNotify=!0}},{key:"endChangeStatesSilently",value:function(){this._dontNotify=!1}},{key:"_syncBatchingScheme",value:function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,bf.set(this._handle,hf.BATCHING_SCHEME,0)}},{key:"_onStateChange",value:function(){bf.set(this._handle,hf.HASH,Ap.getPassHash(this._handle,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)}}]),t}(Ap),um=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this)))._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=e.parent,n._owner=e.owner||null,n._subModelIdx=e.subModelIdx||0,n.copy(n._parent),n}return o(t,e),r(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),r(t,[{key:"recompileShaders",value:function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var i,n=y(this._passes);!(i=n()).done;){i.value.tryCompile(e)}else this._passes[t].tryCompile(e)}},{key:"overridePipelineStates",value:function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var r=this._passes[n],a=this._states[n]||(this._states[n]={});for(var o in e)a[o]=e[o];r.overridePipelineStates(i[r.passIndex],a)}else{var s=this._states[t]||(this._states[t]={});for(var l in e)s[l]=e[l];this._passes[t].overridePipelineStates(i[t],s)}}}},{key:"destroy",value:function(){return this._doDestroy(),!0}},{key:"onPassStateChange",value:function(e){this._hash=sm.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}},{key:"_createPasses",value:function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new cm(t[i],this));return e}}]),t}(sm);!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed"}(lm||(lm=e("SystemEventType",{}))),nt(lm),E.SystemEventType=lm;var hm=new ia,_m=e("EventMouse",function(e){function t(e,n,r){var a;return i(this,t),(a=u(this,s(t).call(this,Fi.MOUSE,n))).movementX=0,a.movementY=0,a.eventType=void 0,a._button=t.BUTTON_MISSING,a._x=0,a._y=0,a._prevX=0,a._prevY=0,a._scrollX=0,a._scrollY=0,a.eventType=e,r&&(a._prevX=r.x,a._prevY=r.y),a}return o(t,e),r(t,[{key:"setScrollData",value:function(e,t){this._scrollX=e,this._scrollY=t}},{key:"getScrollX",value:function(){return this._scrollX}},{key:"getScrollY",value:function(){return this._scrollY}},{key:"setLocation",value:function(e,t){this._x=e,this._y=t}},{key:"getLocation",value:function(e){return e||(e=new ia),ia.set(e,this._x,this._y),e}},{key:"getLocationInView",value:function(e){return e||(e=new ia),ia.set(e,this._x,E.view._designResolutionSize.height-this._y),e}},{key:"getUILocation",value:function(e){return e||(e=new ia),ia.set(e,this._x,this._y),E.view._convertPointWithScale(e),e}},{key:"getPreviousLocation",value:function(e){return e||(e=new ia),ia.set(e,this._prevX,this._prevY),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new ia),ia.set(e,this._prevX,this._prevY),E.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new ia),ia.set(e,this._x-this._prevX,this._y-this._prevY),e}},{key:"getDeltaX",value:function(){return this._x-this._prevX}},{key:"getDeltaY",value:function(){return this._y-this._prevY}},{key:"getUIDelta",value:function(e){return e||(e=new ia),ia.set(e,(this._x-this._prevX)/E.view.getScaleX(),(this._y-this._prevY)/E.view.getScaleY()),e}},{key:"getUIDeltaX",value:function(){return(this._x-this._prevX)/E.view.getScaleX()}},{key:"getUIDeltaY",value:function(){return(this._y-this._prevY)/E.view.getScaleY()}},{key:"setButton",value:function(e){this._button=e}},{key:"getButton",value:function(){return this._button}},{key:"getLocationX",value:function(){return this._x}},{key:"getLocationY",value:function(){return this._y}},{key:"getUILocationX",value:function(){var e=E.view.getViewportRect();return(this._x-e.x)/E.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=E.view.getViewportRect();return(this._y-e.y)/E.view.getScaleY()}}]),t}(Fi));_m.NONE=0,_m.DOWN=1,_m.UP=2,_m.MOVE=3,_m.SCROLL=4,_m.BUTTON_MISSING=-1,_m.BUTTON_LEFT=0,_m.BUTTON_RIGHT=2,_m.BUTTON_MIDDLE=1,_m.BUTTON_4=3,_m.BUTTON_5=4,_m.BUTTON_6=5,_m.BUTTON_7=6,_m.BUTTON_8=7;var dm=e("EventTouch",function(e){function t(e,n,r,a){var o;return i(this,t),(o=u(this,s(t).call(this,Fi.TOUCH,n))).touch=null,o.simulate=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=r||0,o._touches=e||[],o._allTouches=a||[],o}return o(t,e),r(t,[{key:"getEventCode",value:function(){return this._eventCode}},{key:"getTouches",value:function(){return this._touches}},{key:"getAllTouches",value:function(){return this._allTouches}},{key:"setLocation",value:function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)}},{key:"getLocation",value:function(e){return this.touch?this.touch.getLocation(e):new ia}},{key:"getUILocation",value:function(e){return this.touch?this.touch.getUILocation(e):new ia}},{key:"getLocationInView",value:function(e){return this.touch?this.touch.getLocationInView(e):new ia}},{key:"getPreviousLocation",value:function(e){return this.touch?this.touch.getPreviousLocation(e):new ia}},{key:"getStartLocation",value:function(e){return this.touch?this.touch.getStartLocation(e):new ia}},{key:"getUIStartLocation",value:function(e){return this.touch?this.touch.getUIStartLocation(e):new ia}},{key:"getID",value:function(){return this.touch?this.touch.getID():null}},{key:"getDelta",value:function(e){return this.touch?this.touch.getDelta(e):new ia}},{key:"getUIDelta",value:function(e){return this.touch?this.touch.getUIDelta(e):new ia}},{key:"getDeltaX",value:function(){return this.touch?this.touch.getDelta(hm).x:0}},{key:"getDeltaY",value:function(){return this.touch?this.touch.getDelta(hm).y:0}},{key:"getLocationX",value:function(){return this.touch?this.touch.getLocationX():0}},{key:"getLocationY",value:function(){return this.touch?this.touch.getLocationY():0}}]),t}(Fi));dm.MAX_TOUCHES=5,dm.BEGAN=0,dm.MOVED=1,dm.ENDED=2,dm.CANCELLED=3;var fm=e("EventAcceleration",function(e){function t(e,n){var r;return i(this,t),(r=u(this,s(t).call(this,Fi.ACCELERATION,n))).acc=void 0,r.acc=e,r}return o(t,e),t}(Fi)),pm=e("EventKeyboard",function(e){function t(e,n,r){var a;return i(this,t),(a=u(this,s(t).call(this,Fi.KEYBOARD,r))).keyCode=void 0,a.rawEvent=void 0,a.isPressed=void 0,"number"==typeof e?a.keyCode=e:(a.keyCode=e.keyCode,a.rawEvent=e),a.isPressed=n,a}return o(t,e),t}(Fi));Fi.EventMouse=_m,Fi.EventTouch=dm,Fi.EventAcceleration=fm,Fi.EventKeyboard=pm;var mm=function(){function e(t,n,r){i(this,e),this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=r,this._type=t||0,this._listenerID=n||""}return r(e,[{key:"onEvent",get:function(){return this._onEvent}}],[{key:"create",value:function(e){q(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===E.EventListener.TOUCH_ONE_BY_ONE?i=new ym:t===E.EventListener.TOUCH_ALL_AT_ONCE?i=new xm:t===E.EventListener.MOUSE?i=new gm:t===E.EventListener.KEYBOARD?i=new Tm:t===E.EventListener.ACCELERATION&&(i=new Sm(e.callback),delete e.callback),i)for(var n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];i[a]=e[a]}return i}}]),r(e,[{key:"_setPaused",value:function(e){this._paused=e}},{key:"_isPaused",value:function(){return this._paused}},{key:"_setRegistered",value:function(e){this._registered=e}},{key:"_isRegistered",value:function(){return this._registered}},{key:"_getType",value:function(){return this._type}},{key:"_getListenerID",value:function(){return this._listenerID}},{key:"_setFixedPriority",value:function(e){this._fixedPriority=e}},{key:"_getFixedPriority",value:function(){return this._fixedPriority}},{key:"_setSceneGraphPriority",value:function(e){this._target=e,this._node=e}},{key:"_getSceneGraphPriority",value:function(){return this._node}},{key:"checkAvailable",value:function(){return null!==this._onEvent}},{key:"clone",value:function(){return null}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}}]),e}();mm.UNKNOWN=0,mm.TOUCH_ONE_BY_ONE=1,mm.TOUCH_ALL_AT_ONCE=2,mm.KEYBOARD=3,mm.MOUSE=4,mm.ACCELERATION=6,mm.CUSTOM=8,mm.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var vm=mm.ListenerID,gm=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,mm.MOUSE,vm.MOUSE,null))).onMouseDown=null,e.onMouseUp=null,e.onMouseMove=null,e.onMouseScroll=null,e._onEvent=function(t){return e._callback(t)},e}return o(t,e),r(t,[{key:"_callback",value:function(e){var t=E.Event.EventMouse;switch(e.eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}}},{key:"clone",value:function(){var e=new t;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e}},{key:"checkAvailable",value:function(){return!0}}]),t}(mm),ym=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,mm.TOUCH_ONE_BY_ONE,vm.TOUCH_ONE_BY_ONE,null))).swallowTouches=!1,e.onTouchBegan=null,e.onTouchMoved=null,e.onTouchEnded=null,e.onTouchCancelled=null,e._claimedTouches=[],e}return o(t,e),r(t,[{key:"setSwallowTouches",value:function(e){this.swallowTouches=e}},{key:"isSwallowTouches",value:function(){return this.swallowTouches}},{key:"clone",value:function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e}},{key:"checkAvailable",value:function(){return!!this.onTouchBegan||(z(1801),!1)}}]),t}(mm),xm=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,mm.TOUCH_ALL_AT_ONCE,vm.TOUCH_ALL_AT_ONCE,null))).onTouchesBegan=null,e.onTouchesMoved=null,e.onTouchesEnded=null,e.onTouchesCancelled=null,e}return o(t,e),r(t,[{key:"clone",value:function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e}},{key:"checkAvailable",value:function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(z(1802),!1)}}]),t}(mm),Sm=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,mm.ACCELERATION,vm.ACCELERATION,null)))._onAccelerationEvent=null,n._onEvent=function(e){return n._callback(e)},n._onAccelerationEvent=e,n}return o(t,e),r(t,[{key:"_callback",value:function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)}},{key:"checkAvailable",value:function(){return q(this._onAccelerationEvent,1803),!0}},{key:"clone",value:function(){return new t(this._onAccelerationEvent)}}]),t}(mm),Tm=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,mm.KEYBOARD,vm.KEYBOARD,null))).onKeyPressed=null,e.onKeyReleased=null,e._onEvent=function(t){return e._callback(t)},e}return o(t,e),r(t,[{key:"_callback",value:function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)}},{key:"clone",value:function(){var e=new t;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e}},{key:"checkAvailable",value:function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(z(1800),!1)}}]),t}(mm);E.EventListener=mm;var Em=mm.ListenerID;var bm=function(){function e(){i(this,e),this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}return r(e,[{key:"size",value:function(){return this._fixedListeners.length+this._sceneGraphListeners.length}},{key:"empty",value:function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}},{key:"push",value:function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)}},{key:"clearSceneGraphListeners",value:function(){this._sceneGraphListeners.length=0}},{key:"clearFixedListeners",value:function(){this._fixedListeners.length=0}},{key:"clear",value:function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}},{key:"getFixedPriorityListeners",value:function(){return this._fixedListeners}},{key:"getSceneGraphPriorityListeners",value:function(){return this._sceneGraphListeners}}]),e}();var Am=e("eventManager",new(function(){function e(){i(this,e),this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners=[],this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}return r(e,[{key:"pauseTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof E._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n){var r=i[n];r._setPaused(!0)}if(!0===t){var a=e.children;if(a)for(var o=0;o<a.length;++o){var s=a[o];this.pauseTarget(s,!0)}}}else G(3506)}},{key:"resumeTarget",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e instanceof E._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n){var r=i[n];r._setPaused(!1)}if(this._setDirtyForNode(e),!0===t&&e.children.length>0){var a=e.children;if(a)for(var o=0;o<a.length;++o){var s=a[o];this.resumeTarget(s,!0)}}}else G(3506)}},{key:"frameUpdateListeners",value:function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},{key:"hasEventListener",value:function(e){return!!this._getListeners(e)}},{key:"addListener",value:function(e,t){if(q(e&&t,3503),E.js.isNumber(t)||t instanceof E._BaseNode){if(e instanceof E.EventListener){if(e._isRegistered())return void z(3505)}else q(!E.js.isNumber(t),3504),e=E.EventListener.create(e);if(e.checkAvailable()){if(E.js.isNumber(t)){if(0===t)return void z(3500);e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(i=t)||!i.getComponent("cc.UITransform"))return void z(3512);e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var i;return e}}else G(3506)}},{key:"addCustomListener",value:function(e,t){var i=mm.create({event:E.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i}},{key:"removeListener",value:function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var n in i){var r=i[n],a=r.getFixedPriorityListeners(),o=r.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(o,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(a,e))&&this._setDirty(e._getListenerID(),1),r.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t)for(var s=this._toAddedListeners,l=s.length-1;l>=0;l--){var c=s[l];if(c===e){E.js.array.removeAt(s,l),c._setRegistered(!1);break}}}}},{key:"removeListeners",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(E.js.isNumber(e)||e instanceof E._BaseNode)if(void 0!==e._id){var i=this._nodeListenersMap[e._id];if(i){for(var n=E.js.array.copy(i),r=0;r<n.length;++r){var a=n[r];this.removeListener(a)}delete this._nodeListenersMap[e._id]}for(var o=this._toAddedListeners,s=0;s<o.length;){var l=o[s];l._getSceneGraphPriority()===e?(l._setSceneGraphPriority(null),l._setRegistered(!1),o.splice(s,1)):++s}if(!0===t)for(var c=e.getChildren(),u=0;u<c.length;++u){var h=c[u];this.removeListeners(h,!0)}}else e===E.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Em.TOUCH_ONE_BY_ONE):e===E.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Em.TOUCH_ALL_AT_ONCE):e===E.EventListener.MOUSE?this._removeListenersForListenerID(Em.MOUSE):e===E.EventListener.ACCELERATION?this._removeListenersForListenerID(Em.ACCELERATION):e===E.EventListener.KEYBOARD?this._removeListenersForListenerID(Em.KEYBOARD):z(3501);else G(3506)}},{key:"removeCustomListeners",value:function(e){this._removeListenersForListenerID(e)}},{key:"removeAllListeners",value:function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)}},{key:"setPriority",value:function(e,t){if(null!=e){var i=this._listenersMap;for(var n in i){var r=i[n].getFixedPriorityListeners();if(r)if(-1!==r.indexOf(e))return null!=e._getSceneGraphPriority()&&z(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}}},{key:"setEnabled",value:function(e){this._isEnabled=e}},{key:"isEnabled",value:function(){return this._isEnabled}},{key:"dispatchEvent",value:function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(E.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=Fi,i=e.type;return i===t.ACCELERATION?Em.ACCELERATION:i===t.KEYBOARD?Em.KEYBOARD:i.startsWith(t.MOUSE)?Em.MOUSE:(i.startsWith(t.TOUCH)&&z(2e3),"")}(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else V(3511)}},{key:"_onListenerCallback",value:function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()}},{key:"dispatchCustomEvent",value:function(e,t){var i=new E.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)}},{key:"_setDirtyForNode",value:function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var r=t[i]._getListenerID();null==this._dirtyListeners[r]&&(this._dirtyListeners[r]=!0)}if(e.children.length>0)for(var a=e.children,o=0,s=a?a.length:0;o<s;o++)this._setDirtyForNode(a[o])}},{key:"_addListener",value:function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)}},{key:"_forceAddEventListener",value:function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new bm,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&z(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)}},{key:"_getListeners",value:function(e){return this._listenersMap[e]}},{key:"_updateDirtyFlagForSceneGraph",value:function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2);this._dirtyListeners.length=0}},{key:"_removeAllListenersInVector",value:function(e){if(e)for(var t,i=e.length-1;i>=0;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&E.js.array.removeAt(e,i)}},{key:"_removeListenersForListenerID",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var r=this._toAddedListeners,a=r.length-1;a>=0;a--){var o=r[a];o&&o._getListenerID()===e&&E.js.array.removeAt(r,a)}}},{key:"_sortEventListeners",value:function(e){var t=0,i=this._priorityDirtyFlagMap;(i[e]&&(t=i[e]),0!==t)&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&E.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))}},{key:"_sortListenersOfSceneGraphPriority",value:function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();i&&0!==i.length&&t.getSceneGraphPriorityListeners().sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},{key:"_sortEventListenersOfSceneGraphPriorityDes",value:function(e,t){var i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(e&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return 1;var r=i,a=n,o=!1,s=i._uiProps.uiTransformComp,l=n._uiProps.uiTransformComp;if(s.visibility!==l.visibility)return l.visibility-s.visibility;for(;r.parent._id!==a.parent._id;)r=null===r.parent.parent?(o=!0)&&n:r.parent,a=null===a.parent.parent?(o=!0)&&i:a.parent;if(r._id===a._id){if(r._id===n._id)return-1;if(r._id===i._id)return 1}var c=r.getSiblingIndex(),u=a.getSiblingIndex();return o?c-u:u-c}},{key:"_sortListenersOfFixedPriority",value:function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,r=i.length;n<r&&!(i[n]._getFixedPriority()>=0);)++n;t.gt0Index=n}}}},{key:"_sortListenersOfFixedPriorityAsc",value:function(e,t){return e._getFixedPriority()-t._getFixedPriority()}},{key:"_onUpdateListeners",value:function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var r=i.length-1;r>=0;r--){var a=i[r];if(!a._isRegistered()){E.js.array.removeAt(i,r);var o=n.indexOf(a);-1!==o&&n.splice(o,1)}}if(t)for(var s=t.length-1;s>=0;s--){var l=t[s];if(!l._isRegistered()){E.js.array.removeAt(t,s);var c=n.indexOf(l);-1!==c&&n.splice(c,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()}},{key:"_updateTouchListeners",value:function(e){var t=this._inDispatch;if(q(t>0,3508),!(t>1)){var i;(i=this._listenersMap[Em.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(i),(i=this._listenersMap[Em.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(i),q(1===t,3509);var n=this._toAddedListeners;if(0!==n.length){for(var r=0,a=n.length;r<a;r++)this._forceAddEventListener(n[r]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}}},{key:"_cleanToRemovedListeners",value:function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],n=this._listenersMap[i._getListenerID()];if(n){var r=n.getFixedPriorityListeners(),a=n.getSceneGraphPriorityListeners();if(a){var o=a.indexOf(i);-1!==o&&a.splice(o,1)}if(r){var s=r.indexOf(i);-1!==s&&r.splice(s,1)}}}e.length=0}},{key:"_onTouchEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();var r=!1,a=-1,o=i.getEventCode();if(o===dm.BEGAN){if(!Sh.ENABLE_MULTI_TOUCH&&Am._currentTouch){var s=Am._currentTouchListener._node;if(!s||s.activeInHierarchy)return!1}e.onTouchBegan&&(r=e.onTouchBegan(n,i))&&e._isRegistered()&&(e._claimedTouches.push(n),!Sh.ENABLE_MULTI_TOUCH&&Am._currentTouch||(Am._currentTouch=n),Am._currentTouchListener=e)}else if(e._claimedTouches.length>0&&-1!==(a=e._claimedTouches.indexOf(n))){if(r=!0,!Sh.ENABLE_MULTI_TOUCH&&Am._currentTouch&&Am._currentTouch!==n)return!1;o===dm.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):o===dm.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1),(Sh.ENABLE_MULTI_TOUCH||Am._currentTouch===n)&&(Am._currentTouch=null),Am._currentTouchListener=null):o===dm.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(a,1),(Sh.ENABLE_MULTI_TOUCH||Am._currentTouch===n)&&(Am._currentTouch=null),Am._currentTouchListener=null)}return i.isStopped()?(Am._updateTouchListeners(i),!0):!!(r&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)}},{key:"_dispatchTouchEvent",value:function(e){this._sortEventListeners(Em.TOUCH_ONE_BY_ONE),this._sortEventListeners(Em.TOUCH_ALL_AT_ONCE);var t=this._getListeners(Em.TOUCH_ONE_BY_ONE),i=this._getListeners(Em.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),r=E.js.array.copy(n),a={event:e,needsMutableSet:t&&i,touches:r,selTouch:null};if(t)for(var o=0;o<n.length;++o){var s=n[o];e.touch=s,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,a)}i&&r.length>0&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:r}),e.isStopped())||this._updateTouchListeners(e)}}},{key:"_onTouchesEventCallback",value:function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,r=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),r===dm.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):r===dm.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):r===dm.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):r===dm.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(Am._updateTouchListeners(i),!0)}},{key:"_associateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)}},{key:"_dissociateNodeAndEventListener",value:function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(E.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])}},{key:"_dispatchEventToListeners",value:function(e,t,i){var n=!1,r=e.getFixedPriorityListeners(),a=e.getSceneGraphPriorityListeners(),o=0;if(r&&0!==r.length)for(;o<e.gt0Index;++o){var s=r[o];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&t(s,i)){n=!0;break}}if(a&&!n)for(var l=0;l<a.length;++l){var c=a[l];if(c.isEnabled()&&!c._isPaused()&&c._isRegistered()&&t(c,i)){n=!0;break}}if(r&&!n)for(;o<r.length;++o){var u=r[o];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){n=!0;break}}}},{key:"_setDirty",value:function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]=t|i[e]}},{key:"_sortNumberAsc",value:function(e,t){return e-t}},{key:"_removeListenerInCallback",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n._onCustomEvent===t||n.onEvent===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?E.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}},{key:"_removeListenerInVector",value:function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?E.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1}}]),e}()));E.eventManager=Am;Vi.Flags.Destroying;var Cm=new Array(16),wm=null,Rm=new ia,Im=[lm.TOUCH_START.toString(),lm.TOUCH_MOVE.toString(),lm.TOUCH_END.toString(),lm.TOUCH_CANCEL.toString()],Om=[lm.MOUSE_DOWN.toString(),lm.MOUSE_ENTER.toString(),lm.MOUSE_MOVE.toString(),lm.MOUSE_LEAVE.toString(),lm.MOUSE_UP.toString(),lm.MOUSE_WHEEL.toString()];function Mm(e,t){var i=this.owner;return!(!i||!i._uiProps.uiTransformComp)&&(e.getUILocation(Rm),!!i._uiProps.uiTransformComp.isHit(Rm,this)&&(t.type=lm.TOUCH_START.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t),!0))}function Pm(e,t){var i=this.owner;if(!i||!i._uiProps.uiTransformComp)return!1;t.type=lm.TOUCH_MOVE.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t)}function km(e,t){var i=this.owner;i&&i._uiProps.uiTransformComp&&(e.getUILocation(Rm),i._uiProps.uiTransformComp.isHit(Rm,this)?t.type=lm.TOUCH_END.toString():t.type=lm.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function Dm(e,t){var i=this.owner;i&&i._uiProps.uiTransformComp&&(t.type=lm.TOUCH_CANCEL.toString(),t.touch=e,t.bubbles=!0,i.dispatchEvent(t))}function Bm(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Rm=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Rm,this)&&(e.type=lm.MOUSE_DOWN.toString(),e.bubbles=!0,t.dispatchEvent(e)))}function Lm(e){var t=this.owner;if(t&&t._uiProps.uiTransformComp){if(Rm=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Rm,this))this._previousIn||(wm&&wm.eventProcessor.mouseListener&&(e.type=lm.MOUSE_LEAVE,wm.dispatchEvent(e),wm.eventProcessor.mouseListener&&(wm.eventProcessor.mouseListener._previousIn=!1)),wm=t,e.type=lm.MOUSE_ENTER.toString(),t.dispatchEvent(e),this._previousIn=!0),e.type=lm.MOUSE_MOVE.toString(),e.bubbles=!0,t.dispatchEvent(e);else{if(!this._previousIn)return;e.type=lm.MOUSE_LEAVE.toString(),t.dispatchEvent(e),this._previousIn=!1,wm=null}e.propagationStopped=!0}}function Nm(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Rm=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Rm,this)&&(e.type=lm.MOUSE_UP.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function Fm(e){var t=this.owner;t&&t._uiProps.uiTransformComp&&(Rm=e.getUILocation(),t._uiProps.uiTransformComp.isHit(Rm,this)&&(e.type=lm.MOUSE_WHEEL.toString(),e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0))}function zm(e){var t=E.Mask;if(t)for(var i=0,n=e;n&&E.Node.isNode(n);n=n.parent,++i)if(n.getComponent(t))return{index:i,node:n};return null}function Um(e,t){if(!e._persistNode){if(e.eventProcessor.bubblingTargets)for(var i=0;i<t.length;++i)if(e.eventProcessor.bubblingTargets.hasEventListener(t[i]))return!0;if(e.eventProcessor.capturingTargets)for(var n=0;n<t.length;++n)if(e.eventProcessor.capturingTargets.hasEventListener(t[n]))return!0;return!1}return!0}var Gm,Hm,Vm,Wm,jm,qm,Xm,Ym,Km,Zm=function(){function e(t){i(this,e),this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=t}return r(e,[{key:"node",get:function(){return this._node}}]),r(e,[{key:"reattach",value:function(){if(this.touchListener){var e=this.touchListener.mask=zm(this._node);this.mouseListener&&(this.mouseListener.mask=e)}else this.mouseListener&&(this.mouseListener.mask=zm(this._node))}},{key:"destroy",value:function(){wm===this._node&&(wm=null),(this.touchListener||this.mouseListener)&&(Am.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}},{key:"on",value:function(e,t,i,n){return this._checknSetupSysEvent(e)?this._onDispatch(e,t,i,n):(this.bubblingTargets||(this.bubblingTargets=new Ji),this.bubblingTargets.on(e,t,i))}},{key:"once",value:function(e,t,i,n){var r,a=this;(r=this._checknSetupSysEvent(e)&&n?this.capturingTargets=this.capturingTargets||new Ji:this.bubblingTargets=this.bubblingTargets||new Ji).on(e,t,i,!0),r.on(e,(function(){a.off(e,t,i)}),void 0,!0)}},{key:"off",value:function(e,t,i,n){var r=-1!==Im.indexOf(e),a=!r&&-1!==Om.indexOf(e);r||a?(this._offDispatch(e,t,i,n),r?this.touchListener&&!Um(this._node,Im)&&(Am.removeListener(this.touchListener),this.touchListener=null):a&&this.mouseListener&&!Um(this._node,Om)&&(Am.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(e,t,i)}},{key:"emit",value:function(e,t,i,n,r,a){this.bubblingTargets&&this.bubblingTargets.emit(e,t,i,n,r,a)}},{key:"dispatchEvent",value:function(e){!function(e,t){var i,n=0;for(t.target=e,Cm.length=0,e.eventProcessor.getCapturingTargets(t.type,Cm),t.eventPhase=1,n=Cm.length-1;n>=0;--n)if((i=Cm[n]).eventProcessor.capturingTargets&&(t.currentTarget=i,i.eventProcessor.capturingTargets.emit(t.type,t,Cm),t.propagationStopped))return void(Cm.length=0);if(Cm.length=0,t.eventPhase=2,t.currentTarget=e,e.eventProcessor.capturingTargets&&e.eventProcessor.capturingTargets.emit(t.type,t),!t.propagationImmediateStopped&&e.eventProcessor.bubblingTargets&&e.eventProcessor.bubblingTargets.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(e.eventProcessor.getBubblingTargets(t.type,Cm),t.eventPhase=3,n=0;n<Cm.length;++n)if((i=Cm[n]).eventProcessor.bubblingTargets&&(t.currentTarget=i,i.eventProcessor.bubblingTargets.emit(t.type,t),t.propagationStopped))return void(Cm.length=0);Cm.length=0}(this._node,e),Cm.length=0}},{key:"hasEventListener",value:function(e,t,i){var n=!1;return this.bubblingTargets&&(n=this.bubblingTargets.hasEventListener(e,t,i)),!n&&this.capturingTargets&&(n=this.capturingTargets.hasEventListener(e,t,i)),n}},{key:"targetOff",value:function(e){this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e),this.touchListener&&!Um(this.node,Im)&&(Am.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!Um(this.node,Om)&&(Am.removeListener(this.mouseListener),this.mouseListener=null)}},{key:"getCapturingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"getBubblingTargets",value:function(e,t){for(var i=this._node.parent;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(e)&&t.push(i),i=i.parent}},{key:"_checknSetupSysEvent",value:function(e){var t=this,i=!1,n=!1;return-1!==Im.indexOf(e)?(this.touchListener||(this.touchListener=E.EventListener.create({event:E.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:zm(this._node),onTouchBegan:Mm,onTouchMoved:Pm,onTouchEnded:km,onTouchCancelled:Dm}),Am.addListener(this.touchListener,this._node),i=!0),n=!0):-1!==Om.indexOf(e)&&(this.mouseListener||(this.mouseListener=E.EventListener.create({event:E.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:zm(this._node),onMouseDown:Bm,onMouseMove:Lm,onMouseUp:Nm,onMouseScroll:Fm}),Am.addListener(this.mouseListener,this._node),i=!0),n=!0),i&&!this._node.activeInHierarchy&&E.director.getScheduler().schedule((function(){t._node.activeInHierarchy||Am.pauseTarget(t._node)}),this._node,0,0,0,!1),n}},{key:"_onDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=null;return(r=n?this.capturingTargets=this.capturingTargets||new Ji:this.bubblingTargets=this.bubblingTargets||new Ji).hasEventListener(e,t,i)||r.on(e,t,i),t}V(6800)}},{key:"_offDispatch",value:function(e,t,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,t){var r=n?this.capturingTargets:this.bubblingTargets;r&&r.off(e,t,i)}else this.capturingTargets&&this.capturingTargets.removeAll(e),this.bubblingTargets&&this.bubblingTargets.removeAll(e)}}]),e}();E.NodeEventProcessor=Zm;var Qm=Vi.Flags.Destroying,Jm=Vi.Flags.DontDestroy,$m=Vi.Flags.Deactivating,ev=(Vi.Flags.Activating,new ie("Node"));function tv(e){return e?"string"==typeof e?Be(e):e:(V(3804),null)}var iv,nv,rv,av,ov,sv,lv,cv,uv,hv,_v,dv,fv,pv,mv,vv,gv,yv,xv=e("BaseNode",ii("cc.BaseNode")((Km=Ym=function(e){function n(e){var t;return i(this,n),x(t=u(this,s(n).call(this,e)),"_parent",Vm,c(t)),x(t,"_children",Wm,c(t)),x(t,"_active",jm,c(t)),x(t,"_components",qm,c(t)),x(t,"_prefab",Xm,c(t)),t._scene=null,t._activeInHierarchy=!1,t._id=ev.getNewId(),t._name=void 0,t._eventProcessor=new Zm(c(t)),t._eventMask=0,t._siblingIndex=0,t._registerIfAttached=void 0,t._name=void 0!==e?e:"New Node",t}return o(n,e),r(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&Jm)>0},set:function(e){e?this._objFlags|=Jm:this._objFlags&=~Jm}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;if(t)t._activeInHierarchy&&E.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}],[{key:"_setScene",value:function(e){e instanceof E.Scene?e._scene=e:null==e._parent?k("Node %s(%s) has not attached to a scene.",e.name,e.uuid):e._scene=e._parent._scene}},{key:"_findComponent",value:function(e,t){var i=t,n=e._components;if(i._sealed)for(var r=0;r<n.length;++r){var a=n[r];if(a.constructor===t)return a}else for(var o=0;o<n.length;++o){var s=n[o];if(s instanceof t)return s}return null}},{key:"_findComponents",value:function(e,t,i){var n=t,r=e._components;if(n._sealed)for(var a=0;a<r.length;++a){var o=r[a];o.constructor===t&&i.push(o)}else for(var s=0;s<r.length;++s){var l=r[s];l instanceof t&&i.push(l)}}},{key:"_findChildComponent",value:function(e,t){for(var i=0;i<e.length;++i){var r=e[i],a=n._findComponent(r,t);if(a)return a;if(r._children.length>0&&(a=n._findChildComponent(r._children,t)))return a}return null}},{key:"_findChildComponents",value:function(e,t,i){for(var r=0;r<e.length;++r){var a=e[r];n._findComponents(a,t,i),a._children.length>0&&n._findChildComponents(a._children,t,i)}}}]),r(n,[{key:"attr",value:function(e){Ee(this,e)}},{key:"getParent",value:function(){return this._parent}},{key:"setParent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._parent!==e){var i=this._parent,n=e;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,t),this.emit&&this.emit(lm.PARENT_CHANGED,i),i&&!(i._objFlags&Qm)){var r=i._children.indexOf(this);i._children.splice(r,1),i._updateSiblingIndex(),i.emit&&i.emit(lm.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(lm.CHILD_ADDED,this)),this._onHierarchyChanged(i)}}},{key:"getChildByUuid",value:function(e){if(!e)return M("Invalid uuid"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._id===e)return t[i];return null}},{key:"getChildByName",value:function(e){if(!e)return M("Invalid name"),null;for(var t=this._children,i=0,n=t.length;i<n;i++)if(t[i]._name===e)return t[i];return null}},{key:"getChildByPath",value:function(e){for(var i=e.split("/"),n=this,r=function(e){var t=i[e];if(0===t.length)return"continue";var r=n.children.find((function(e){return e.name===t}));if(!r)return{v:null};n=r},a=0;a<i.length;++a){var o=r(a);switch(o){case"continue":continue;default:if("object"===t(o))return o.v}}return n}},{key:"addChild",value:function(e){q(e,1606),q(null===e._parent,1605),e.setParent(this)}},{key:"insertChild",value:function(e,t){e.parent=this,e.setSiblingIndex(t)}},{key:"getSiblingIndex",value:function(){return this._siblingIndex}},{key:"setSiblingIndex",value:function(e){if(this._parent)if(this._parent._objFlags&$m)V(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var i=t.indexOf(this);e!==i&&(t.splice(i,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}}},{key:"walk",value:function(e,t){var i=1,r=null,a=null,o=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var l=null,c=!1;i;)if(a=s[--i])if(!c&&e?e(a):c&&t&&t(a),s[i]=null,c){if(l===this._parent)break;if(c=!1,r)if(r[++o])s[i]=r[o],i++;else if(l&&(s[i]=l,i++,c=!0,l._parent?(o=(r=l._parent._children).indexOf(l),l=l._parent):(l=null,r=null),o<0))break}else a._children.length>0?(l=a,r=a._children,o=0,s[i]=r[o],i++):(s[i]=a,i++,c=!0);s.length=0,n._stackId--}},{key:"removeFromParent",value:function(){this._parent&&this._parent.removeChild(this)}},{key:"removeChild",value:function(e){this._children.indexOf(e)>-1&&(e.parent=null)}},{key:"removeAllChildren",value:function(){for(var e=this._children,t=e.length-1;t>=0;t--){var i=e[t];i&&(i.parent=null)}this._children.length=0}},{key:"isChildOf",value:function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1}},{key:"getComponent",value:function(e){var t=tv(e);return t?n._findComponent(this,t):null}},{key:"getComponents",value:function(e){var t=tv(e),i=[];return t&&n._findComponents(this,t,i),i}},{key:"getComponentInChildren",value:function(e){var t=tv(e);return t?n._findChildComponent(this._children,t):null}},{key:"getComponentsInChildren",value:function(e){var t=tv(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i}},{key:"addComponent",value:function(e){var t;if("string"==typeof e){if(!(t=Be(e)))throw E._RF.peek()&&V(3808,e),TypeError(X(3807,e))}else{if(!e)throw TypeError(X(3804));t=e}if("function"!=typeof t)throw TypeError(X(3809));if(!Ce(t,E.Component))throw TypeError(X(3810));var i=t._requireComponent;i&&!this.getComponent(i)&&this.addComponent(i);var n=new t;return n.node=this,this._components.push(n),this._activeInHierarchy&&E.director._nodeActivator.activateComp(n),n}},{key:"removeComponent",value:function(e){if(e){var t=null;(t=e instanceof Yr?e:this.getComponent(e))&&t.destroy()}else V(3813)}},{key:"on",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(e){case lm.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,i,n)}},{key:"off",value:function(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this._eventProcessor.off(e,t,i,n);var r=this._eventProcessor.hasEventListener(e);if(!r)switch(e){case lm.TRANSFORM_CHANGED:this._eventMask&=-2}}},{key:"once",value:function(e,t,i,n){this._eventProcessor.once(e,t,i,n)}},{key:"emit",value:function(e,t,i,n,r,a){this._eventProcessor.emit(e,t,i,n,r,a)}},{key:"dispatchEvent",value:function(e){this._eventProcessor.dispatchEvent(e)}},{key:"hasEventListener",value:function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)}},{key:"targetOff",value:function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(lm.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}},{key:"destroy",value:function(){return!!_(s(n.prototype),"destroy",this).call(this)&&(this._activeInHierarchy&&this._disableChildComps(),!0)}},{key:"destroyAllChildren",value:function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()}},{key:"_removeComponent",value:function(e){if(e){if(!(this._objFlags&Qm)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&V(3815)}}else V(3814)}},{key:"_updateSiblingIndex",value:function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e}},{key:"_onSetParent",value:function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk((function(e){n._setScene(e)})))}},{key:"_onPostActivated",value:function(e){}},{key:"_onBatchRestored",value:function(){}},{key:"_onBatchCreated",value:function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}},{key:"_onPreDestroy",value:function(){this._onPreDestroyBase()}},{key:"_onHierarchyChanged",value:function(e){return this._onHierarchyChangedBase(e)}},{key:"_instantiate",value:function(e){e||(e=E.instantiate._clone(this,this));var t=this._prefab;t&&this===t.root&&t.sync;return e._parent=null,e._onBatchRestored(),e}},{key:"_onHierarchyChangedBase",value:function(e){var t=this._parent;!this._persistNode||t instanceof E.Scene||E.game.removePersistRootNode(this);var i=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==i&&E.director._nodeActivator.activateNode(this,i)}},{key:"_onPreDestroyBase",value:function(){this._objFlags|=Qm;var e=this._parent,t=!!e&&0!=(e._objFlags&Qm);if(this._persistNode&&E.game.removePersistRootNode(this),!t&&e){this.emit(lm.PARENT_CHANGED,this);var i=e._children.indexOf(this);e._children.splice(i,1),this._siblingIndex=0,e.emit&&e.emit(lm.CHILD_REMOVED,this)}this.emit(lm.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var n=this._children,r=0;r<n.length;++r)n[r]._destroyImmediate();for(var a=this._components,o=0;o<a.length;++o)a[o]._destroyImmediate();return t}},{key:"_disableChildComps",value:function(){for(var e=this._components,t=0;t<e.length;++t){var i=e[t];i._enabled&&E.director._compScheduler.disableComp(i)}for(var n=this._children,r=0;r<n.length;++r){var a=n[r];a._active&&a._disableChildComps()}}}]),n}(Vi),Ym.idGenerator=ev,Ym._stacks=[[]],Ym._stackId=0,S((Hm=Km).prototype,"_persistNode",[oi],Object.getOwnPropertyDescriptor(Hm.prototype,"_persistNode"),Hm.prototype),S(Hm.prototype,"name",[vi],Object.getOwnPropertyDescriptor(Hm.prototype,"name"),Hm.prototype),S(Hm.prototype,"children",[vi],Object.getOwnPropertyDescriptor(Hm.prototype,"children"),Hm.prototype),S(Hm.prototype,"active",[vi],Object.getOwnPropertyDescriptor(Hm.prototype,"active"),Hm.prototype),S(Hm.prototype,"activeInHierarchy",[vi],Object.getOwnPropertyDescriptor(Hm.prototype,"activeInHierarchy"),Hm.prototype),S(Hm.prototype,"parent",[vi],Object.getOwnPropertyDescriptor(Hm.prototype,"parent"),Hm.prototype),Vm=S(Hm.prototype,"_parent",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wm=S(Hm.prototype,"_children",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jm=S(Hm.prototype,"_active",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qm=S(Hm.prototype,"_components",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xm=S(Hm.prototype,"_prefab",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gm=Hm))||Gm);E._BaseNode=xv,function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(iv||(iv={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(nv||(nv={})),E.internal.TransformBit=nv;var Sv,Tv,Ev,bv,Av,Cv,wv,Rv,Iv,Ov,Mv,Pv,kv,Dv,Bv,Lv,Nv,Fv=new ia,zv=new ia,Uv=new Ta,Gv=new Ta,Hv=new Ta,Vv=new Ta(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),Wv=new Ia,jv=e("UITransformComponent",(rv=ii("cc.UITransform"),av=mi("i18n:cc.UITransform"),ov=ri(110),sv=_i("UI/UITransform"),lv=wi(0),cv=Si(""),uv=wi(1),hv=Si(""),_v=Si(""),rv(dv=av(dv=ov(dv=sv(dv=hi((yv=gv=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_priority",pv,c(n)),n._canvas=null,x(n,"_contentSize",mv,c(n)),x(n,"_anchorPoint",vv,c(n)),n}return o(t,e),r(t,[{key:"__preload",value:function(){this.node._uiProps.uiTransformComp=this}},{key:"onEnable",value:function(){this._updateVisibility(),this.node.on(lm.PARENT_CHANGED,this._parentChanged,this),this._sortSiblings()}},{key:"onDisable",value:function(){this.node.off(lm.PARENT_CHANGED,this._parentChanged,this),this._canvas=null}},{key:"onDestroy",value:function(){this.node._uiProps.uiTransformComp=null}},{key:"setContentSize",value:function(e,t){var i=this._contentSize;if(void 0===t){if((e=e).width===i.width&&e.height===i.height)return;i.width=e.width,i.height=e.height}else{if(e===i.width&&t===i.height)return;i.width=e,i.height=t}this.node.emit(lm.SIZE_CHANGED)}},{key:"setAnchorPoint",value:function(e,t){var i=this._anchorPoint;if(void 0===t){if((e=e).x===i.x&&e.y===i.y)return;i.x=e.x,i.y=e.y}else{if(e===i.x&&t===i.y)return;i.x=e,i.y=t}this.node.emit(lm.ANCHOR_CHANGED,this._anchorPoint)}},{key:"isHit",value:function(e,t){var i=this._contentSize.width,n=this._contentSize.height,r=Fv,a=zv,o=this._canvas;if(o){o.node.getWorldRT(Uv);var s=Uv.m12,l=Uv.m13,c=E.visibleRect.center;if(Uv.m12=c.x-(Uv.m00*s+Uv.m04*l),Uv.m13=c.y-(Uv.m01*s+Uv.m05*l),Ta.invert(Uv,Uv),ia.transformMat4(r,e,Uv),this.node.getWorldMatrix(Hv),Ta.invert(Uv,Hv),Ta.strictEquals(Uv,Vv))return!1;if(ia.transformMat4(a,r,Uv),a.x+=this._anchorPoint.x*i,a.y+=this._anchorPoint.y*n,a.x>=0&&a.y>=0&&a.x<=i&&a.y<=n){if(t&&t.mask){for(var u=t.mask,h=this.node,_=0;h&&_<u.index;++_,h=h.parent);if(h===u.node){var d=h.getComponent(E.Mask);return!d||!d.enabledInHierarchy||d.isHit(r)}return t.mask=null,!0}return!0}return!1}}},{key:"convertToNodeSpaceAR",value:function(e,t){return this.node.getWorldMatrix(Hv),Ta.invert(Uv,Hv),t||(t=new oa),oa.transformMat4(t,e,Uv)}},{key:"convertToWorldSpaceAR",value:function(e,t){return this.node.getWorldMatrix(Hv),t||(t=new oa),oa.transformMat4(t,e,Hv)}},{key:"getBoundingBox",value:function(){Ta.fromRTS(Gv,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,i=new Ia(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return i.transformMat4(Gv),i}},{key:"getBoundingBoxToWorld",value:function(){return this.node.parent?(this.node.parent.getWorldMatrix(Hv),this.getBoundingBoxTo(Hv)):this.getBoundingBox()}},{key:"getBoundingBoxTo",value:function(e){Ta.fromRTS(Gv,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var i=this._contentSize.width,n=this._contentSize.height,r=new Ia(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if(Ta.multiply(Hv,e,Gv),r.transformMat4(Hv),!this.node.children)return r;for(var a,o=y(this.node.children);!(a=o()).done;){var s=a.value;if(s&&s.active){var l=s.getComponent(t);if(l){var c=l.getBoundingBoxTo(e);c&&Ia.union(r,r,c)}}}return r}},{key:"getComputeAABB",value:function(e){var t=this._contentSize.width,i=this._contentSize.height;Wv.set(-this._anchorPoint.x*t,-this._anchorPoint.y*i,t,i),Wv.transformMat4(this.node.worldMatrix);var n=Wv.x+.5*Wv.width,r=Wv.y+.5*Wv.height,a=this.node.worldPosition.z,o=Wv.width/2,s=Wv.height/2;if(null==e)return new $c(n,r,a,o,s,.001);$c.set(e,n,r,a,o,s,.001)}},{key:"_updateVisibility",value:function(){for(var e=this.node;e;){if(e){var t=e.getComponent("cc.Canvas");if(t){this._canvas=t;break}}e=e.parent}}},{key:"_parentChanged",value:function(e){this._canvas&&this._canvas.node===this.node||this._sortSiblings()}},{key:"_sortSiblings",value:function(){var e=this.node.parent&&this.node.parent.children;e&&(e.sort((function(e,t){var i=e._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp,r=(i?i.priority:0)-(n?n.priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r})),this.node.parent._updateSiblingIndex())}},{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(lm.SIZE_CHANGED))}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(lm.SIZE_CHANGED))}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(lm.SIZE_CHANGED))}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(lm.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(lm.ANCHOR_CHANGED,this._anchorPoint))}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(lm.ANCHOR_CHANGED,this._anchorPoint))}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this._canvas&&this._canvas.node===this.node?G(9200):(this._priority=e,this._sortSiblings()))}},{key:"visibility",get:function(){return this._canvas?this._canvas.visibility:-1}}]),t}(Yr),gv.EventType=lm,S((fv=yv).prototype,"contentSize",[lv,cv],Object.getOwnPropertyDescriptor(fv.prototype,"contentSize"),fv.prototype),S(fv.prototype,"anchorPoint",[uv,hv],Object.getOwnPropertyDescriptor(fv.prototype,"anchorPoint"),fv.prototype),S(fv.prototype,"priority",[_v],Object.getOwnPropertyDescriptor(fv.prototype,"priority"),fv.prototype),pv=S(fv.prototype,"_priority",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mv=S(fv.prototype,"_contentSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wa(100,100)}}),vv=S(fv.prototype,"_anchorPoint",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ia(.5,.5)}}),dv=fv))||dv)||dv)||dv)||dv)||dv)),qv=function(){function e(t){i(this,e),this.uiComp=null,this.opacity=1,this._uiTransformComp=null,this._node=void 0,this._node=t}return r(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent(jv)),this._uiTransformComp},set:function(e){this._uiTransformComp=e}}]),e}(),Xv=new oa,Yv=new pa,Kv=new pa,Zv=new Array(10),Qv=new pa,Jv=new _a,$v=new _a,eg=new Ta,tg=new Map,ig=e("Node",(Sv=ii("cc.Node"),Tv=Li(oa),Sv((Mv=Ov=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,e)))._uiProps=new qv(c(n)),n._static=!1,n._pos=new oa,n._rot=new pa,n._scale=new oa(1,1,1),n._mat=new Ta,x(n,"_lpos",Av,c(n)),x(n,"_lrot",Cv,c(n)),x(n,"_lscale",wv,c(n)),x(n,"_layer",Rv,c(n)),x(n,"_euler",Iv,c(n)),n._dirtyFlags=nv.NONE,n._eulerDirty=!1,n._poolHandle=0,n._poolHandle=Hf.alloc(),Hf.set(n._poolHandle,Nf.LAYER,n._layer),Hf.setVec3(n._poolHandle,Nf.WORLD_SCALE,n._scale),n}return o(t,e),r(t,null,[{key:"isNode",value:function(e){return e instanceof t&&(e.constructor===t||!(e instanceof E.Scene))}}]),r(t,[{key:"destroy",value:function(){return this._poolHandle&&(Hf.free(this._poolHandle),this._poolHandle=0),_(s(t.prototype),"destroy",this).call(this)}},{key:"setParent",value:function(e){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];i&&this.updateWorldTransform(),_(s(t.prototype),"setParent",this).call(this,e,i)}},{key:"_onSetParent",value:function(e,i){if(_(s(t.prototype),"_onSetParent",this).call(this,e,i),i){var n=this._parent;n?(n.updateWorldTransform(),Ta.multiply(eg,Ta.invert(eg,n._mat),this._mat),Ta.toRTS(eg,this._lrot,this._lpos,this._lscale)):(oa.copy(this._lpos,this._pos),pa.copy(this._lrot,this._rot),oa.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(nv.TRS)}},{key:"_onBatchCreated",value:function(){_(s(t.prototype),"_onBatchCreated",this).call(this),tg.set(this._id,nv.TRS),this._dirtyFlags=nv.TRS;for(var e=this._children.length,i=0;i<e;++i)this._children[i]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"_onBeforeSerialize",value:function(){this.eulerAngles}},{key:"_onPostActivated",value:function(e){e?(Am.resumeTarget(this),this.eventProcessor.reattach(),this.invalidateChildren(nv.TRS)):Am.pauseTarget(this)}},{key:"translate",value:function(e,t){var i=t||iv.LOCAL;if(i===iv.LOCAL)oa.transformQuat(Xv,e,this._lrot),this._lpos.x+=Xv.x,this._lpos.y+=Xv.y,this._lpos.z+=Xv.z;else if(i===iv.WORLD)if(this._parent){pa.invert(Yv,this._parent.worldRotation),oa.transformQuat(Xv,e,Yv);var n=this.worldScale;this._lpos.x+=Xv.x/n.x,this._lpos.y+=Xv.y/n.y,this._lpos.z+=Xv.z/n.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(nv.POSITION),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.POSITION)}},{key:"rotate",value:function(e,t){var i=t||iv.LOCAL;if(pa.normalize(Yv,e),i===iv.LOCAL)pa.multiply(this._lrot,this._lrot,Yv);else if(i===iv.WORLD){var n=this.worldRotation;pa.multiply(Kv,Yv,n),pa.invert(Yv,n),pa.multiply(Kv,Yv,Kv),pa.multiply(this._lrot,this._lrot,Kv)}this._eulerDirty=!0,this.invalidateChildren(nv.ROTATION),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.ROTATION)}},{key:"lookAt",value:function(e,t){this.getWorldPosition(Xv),oa.subtract(Xv,Xv,e),oa.normalize(Xv,Xv),pa.fromViewUp(Yv,Xv,t),this.setWorldRotation(Yv)}},{key:"invalidateChildren",value:function(e){if((this._dirtyFlags&this.hasChangedFlags&e)!==e){this._dirtyFlags|=e,tg.set(this._id,this.hasChangedFlags|e),e|=nv.POSITION;for(var t=this._children.length,i=0;i<t;++i){var n=this._children[i];n.isValid&&n.invalidateChildren(e)}}}},{key:"updateWorldTransform",value:function(){if(this._dirtyFlags){for(var e,t=this,i=0;t&&t._dirtyFlags;)Zv[i++]=t,t=t._parent;for(var n=0;i;)n|=(e=Zv[--i])._dirtyFlags,t?(n&nv.POSITION&&(oa.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z,Hf.setVec3(e._poolHandle,Nf.WORLD_POSITION,e._pos)),n&nv.RS&&(Ta.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),Ta.multiply(e._mat,t._mat,e._mat),n&nv.ROTATION&&(pa.multiply(e._rot,t._rot,e._lrot),Hf.setVec4(e._poolHandle,Nf.WORLD_ROTATION,e._rot)),_a.fromQuat(Jv,pa.conjugate(Qv,e._rot)),_a.multiplyMat4(Jv,Jv,e._mat),e._scale.x=Jv.m00,e._scale.y=Jv.m04,e._scale.z=Jv.m08,Hf.setVec3(e._poolHandle,Nf.WORLD_SCALE,e._scale))):(n&nv.POSITION&&(oa.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z,Hf.setVec3(e._poolHandle,Nf.WORLD_POSITION,e._pos)),n&nv.RS&&(n&nv.ROTATION&&(pa.copy(e._rot,e._lrot),Hf.setVec4(e._poolHandle,Nf.WORLD_ROTATION,e._rot)),n&nv.SCALE&&(oa.copy(e._scale,e._lscale),Hf.setVec3(e._poolHandle,Nf.WORLD_SCALE,e._scale),Ta.fromRTS(e._mat,e._rot,e._pos,e._scale)))),n!==nv.NONE&&Hf.setMat4(e._poolHandle,Nf.WORLD_MATRIX,e._mat),e._dirtyFlags=nv.NONE,t=e}}},{key:"setPosition",value:function(e,t,i){void 0===t||void 0===i?oa.copy(this._lpos,e):oa.set(this._lpos,e,t,i),this.invalidateChildren(nv.POSITION),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.POSITION)}},{key:"getPosition",value:function(e){return e?oa.set(e,this._lpos.x,this._lpos.y,this._lpos.z):oa.copy(new oa,this._lpos)}},{key:"setRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?pa.copy(this._lrot,e):pa.set(this._lrot,e,t,i,n),this._eulerDirty=!0,this.invalidateChildren(nv.ROTATION),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.ROTATION)}},{key:"setRotationFromEuler",value:function(e,t,i){oa.set(this._euler,e,t,i),pa.fromEuler(this._lrot,e,t,i),this._eulerDirty=!1,this.invalidateChildren(nv.ROTATION),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.ROTATION)}},{key:"getRotation",value:function(e){return e?pa.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):pa.copy(new pa,this._lrot)}},{key:"setScale",value:function(e,t,i){void 0===t||void 0===i?oa.copy(this._lscale,e):oa.set(this._lscale,e,t,i),this.invalidateChildren(nv.SCALE),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.SCALE)}},{key:"getScale",value:function(e){return e?oa.set(e,this._lscale.x,this._lscale.y,this._lscale.z):oa.copy(new oa,this._lscale)}},{key:"inverseTransformPoint",value:function(e,t){oa.copy(e,t);for(var i=this,n=0;i._parent;)Zv[n++]=i,i=i._parent;for(;n>=0;)oa.transformInverseRTS(e,e,i._lrot,i._lpos,i._lscale),i=Zv[--n];return e}},{key:"setWorldPosition",value:function(e,t,i){void 0===t||void 0===i?oa.copy(this._pos,e):oa.set(this._pos,e,t,i),Hf.setVec3(this._poolHandle,Nf.WORLD_POSITION,this._pos);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),oa.transformMat4(r,this._pos,Ta.invert(eg,n._mat))):oa.copy(r,this._pos),this.invalidateChildren(nv.POSITION),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.POSITION)}},{key:"getWorldPosition",value:function(e){return this.updateWorldTransform(),e?oa.copy(e,this._pos):oa.copy(new oa,this._pos)}},{key:"setWorldRotation",value:function(e,t,i,n){void 0===t||void 0===i||void 0===n?pa.copy(this._rot,e):pa.set(this._rot,e,t,i,n),Hf.setVec4(this._poolHandle,Nf.WORLD_ROTATION,this._rot),this._parent?(this._parent.updateWorldTransform(),pa.multiply(this._lrot,pa.conjugate(this._lrot,this._parent._rot),this._rot)):pa.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(nv.ROTATION),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.ROTATION)}},{key:"setWorldRotationFromEuler",value:function(e,t,i){pa.fromEuler(this._rot,e,t,i),this._parent?(this._parent.updateWorldTransform(),pa.multiply(this._lrot,pa.conjugate(this._lrot,this._parent._rot),this._rot)):pa.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(nv.ROTATION),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.ROTATION)}},{key:"getWorldRotation",value:function(e){return this.updateWorldTransform(),e?pa.copy(e,this._rot):pa.copy(new pa,this._rot)}},{key:"setWorldScale",value:function(e,t,i){void 0===t||void 0===i?oa.copy(this._scale,e):oa.set(this._scale,e,t,i),Hf.setVec3(this._poolHandle,Nf.WORLD_SCALE,this._scale);var n=this._parent;n?(n.updateWorldTransform(),_a.fromQuat(Jv,pa.conjugate(Qv,n._rot)),_a.multiplyMat4(Jv,Jv,n._mat),$v.m00=this._scale.x,$v.m04=this._scale.y,$v.m08=this._scale.z,_a.multiply(Jv,$v,_a.invert(Jv,Jv)),this._lscale.x=oa.set(Xv,Jv.m00,Jv.m01,Jv.m02).length(),this._lscale.y=oa.set(Xv,Jv.m03,Jv.m04,Jv.m05).length(),this._lscale.z=oa.set(Xv,Jv.m06,Jv.m07,Jv.m08).length()):oa.copy(this._lscale,this._scale),this.invalidateChildren(nv.SCALE),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.SCALE)}},{key:"getWorldScale",value:function(e){return this.updateWorldTransform(),e?oa.copy(e,this._scale):oa.copy(new oa,this._scale)}},{key:"getWorldMatrix",value:function(e){return this.updateWorldTransform(),e||(e=new Ta),Ta.copy(e,this._mat)}},{key:"getWorldRS",value:function(e){return this.updateWorldTransform(),e||(e=new Ta),Ta.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}},{key:"getWorldRT",value:function(e){return this.updateWorldTransform(),e||(e=new Ta),Ta.fromRT(e,this._rot,this._pos)}},{key:"setRTS",value:function(e,t,i){var n=0;e&&(n|=nv.ROTATION,void 0!==e.w?(pa.copy(this._lrot,e),this._eulerDirty=!0):(oa.copy(this._euler,e),pa.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(oa.copy(this._lpos,t),n|=nv.POSITION),i&&(oa.copy(this._lscale,i),n|=nv.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,n))}},{key:"pauseSystemEvents",value:function(e){Am.pauseTarget(this,e)}},{key:"resumeSystemEvents",value:function(e){Am.resumeTarget(this,e)}},{key:"handle",get:function(){return this._poolHandle}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e),Hf.setVec3(this._poolHandle,Nf.WORLD_POSITION,e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)},get:function(){return this._eulerDirty&&(pa.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e),Hf.setVec3(this._poolHandle,Nf.WORLD_SCALE,e)}},{key:"matrix",set:function(e){Ta.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(nv.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(lm.TRANSFORM_CHANGED,nv.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return oa.transformQuat(new oa,oa.FORWARD,this.worldRotation)},set:function(e){var t=e.length();oa.multiplyScalar(Xv,e,-1/t),pa.fromViewUp(Yv,Xv),this.setWorldRotation(Yv)}},{key:"layer",set:function(e){this._layer=e,Hf.set(this._poolHandle,Nf.LAYER,this._layer)},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return tg.get(this._id)||0},set:function(e){tg.set(this._id,e)}}]),t}(xv),Ov.bookOfChange=tg,Ov.EventType=lm,Ov.NodeSpace=iv,Ov.TransformDirtyBit=nv,Ov.TransformBit=nv,Av=S((bv=Mv).prototype,"_lpos",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),Cv=S(bv.prototype,"_lrot",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new pa}}),wv=S(bv.prototype,"_lscale",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(1,1,1)}}),Rv=S(bv.prototype,"_layer",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ph.Enum.DEFAULT}}),Iv=S(bv.prototype,"_euler",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),S(bv.prototype,"eulerAngles",[Tv],Object.getOwnPropertyDescriptor(bv.prototype,"eulerAngles"),bv.prototype),S(bv.prototype,"layer",[vi],Object.getOwnPropertyDescriptor(bv.prototype,"layer"),bv.prototype),Ev=bv))||Ev));function ng(e){return"string"==typeof e||"number"==typeof e}function rg(e,t){return e instanceof t}E.Node=ig;var ag=ii("cc.animation.HierarchyPath")((Dv=S((kv=function(){function e(t){i(this,e),x(this,"path",Dv,this),this.path=t||""}return r(e,[{key:"get",value:function(e){if(!(e instanceof ig))return P("Target of hierarchy path should be of type Node."),null;var t=e.getChildByPath(this.path);return t||(P('Node "'.concat(e.name,'" has no path "').concat(this.path,'"')),null)}}]),e}()).prototype,"path",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Pv=kv))||Pv,og=ii("cc.animation.ComponentPath")((Nv=S((Lv=function(){function e(t){i(this,e),x(this,"component",Nv,this),this.component=t||""}return r(e,[{key:"get",value:function(e){if(!(e instanceof ig))return P("Target of component path should be of type Node."),null;var t=e.getComponent(this.component);return t||(P('Node "'.concat(e.name,'" has no component "').concat(this.component,'"')),null)}}]),e}()).prototype,"component",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Bv=Lv))||Bv;function sg(e){for(var t=e,i=0;i<(arguments.length<=1?0:arguments.length-1);++i){var n=i+1<1||arguments.length<=i+1?void 0:arguments[i+1];if(ng(n)){if(!(n in t))return P('Target object has no property "'.concat(n,'"')),null;t=t[n]}else t=n.get(t);if(null===t)break}return t}var lg=e("SkelAnimDataHub",function(){function e(){i(this,e)}return r(e,null,[{key:"getOrExtract",value:function(t){var i=e.pool.get(t);return i&&i.info.sample===t.sample||(i&&E.director.root.dataPoolManager.releaseAnimationClip(t),i=function(e){var t={};e.curves.forEach((function(e){if(!e.valueAdapter&&rg(e.modifiers[0],ag)&&ng(e.modifiers[1])){var i=e.modifiers[0].path,n=t[i];n||(n=t[i]={}),n[e.modifiers[1]]={values:e.data.values,keys:e.data.keys}}}));for(var i=Math.ceil(e.sample*e.duration)+1,n=function(){var n=a[r],o=t[n];if(!o)return"continue";Object.defineProperty(o,"worldMatrix",{get:function(){if(!o._worldMatrix){var r=o.position,a=o.rotation,s=o.scale;cg(e,r,i),cg(e,a,i),cg(e,s,i),function(e,t,i){var n=i.position.values,r=i.rotation.values,a=i.scale.values,o=n.map((function(){return new Ta})),s=t.lastIndexOf("/"),l=null;if(s>0){var c=t.substring(0,s),u=e[c];if(!u)return void console.warn("no data for parent bone?");l=u.worldMatrix.values}for(var h=0;h<n.length;h++){var _=n[h],d=r[h],f=a[h],p=o[h];Ta.fromRTS(p,d,_,f),l&&Ta.multiply(p,l[h],p)}Object.keys(i).forEach((function(e){return delete i[e]})),i._worldMatrix={keys:0,interpolate:!1,values:o}}(t,n,o)}return o._worldMatrix}})},r=0,a=Object.keys(t);r<a.length;r++)n();return{info:{frames:i,sample:e.sample},data:t}}(t),e.pool.set(t,i)),i}},{key:"destroy",value:function(t){e.pool.delete(t)}}]),e}());function cg(e,t,i){var n=e.keys[t.keys],r=[];if(n&&1!==n.length)for(var a=t.values[0]instanceof pa,o=0,s=0;o<i;o++){for(var l=o/e.sample;n[s]<=l;)s++;s>n.length-1?l=n[s=n.length-1]:0===s&&(s=1);var c=t.values[s-1].clone(),u=n[s]-n[s-1],h=u?gn((l-n[s-1])/u):1;a?c.slerp(t.values[s],h):c.lerp(t.values[s],h),r[o]=c}else for(var _=0;_<i;_++)r[_]=t.values[0].clone();t.values=r}lg.pool=new Map;var ug=new Ta;function hg(e,t,i){for(Ta.identity(i);e!==t;)Ta.fromRTS(ug,e.rotation,e.position,e.scale),Ta.multiply(i,ug,i),e=e.parent;return i}var _g=function(e,t,i,n){e[t+0]=i.m00,e[t+1]=i.m01,e[t+2]=i.m02,e[t+3]=i.m12,e[t+4]=i.m04,e[t+5]=i.m05,e[t+6]=i.m06,e[t+7]=i.m13,e[t+8]=i.m08,e[t+9]=i.m09,e[t+10]=i.m10,e[t+11]=i.m14};function dg(e){return e.hasFeature(Gs.TEXTURE_FLOAT)?jo.RGBA32F:jo.RGBA8}new pa,new pa,new oa,new pa,new oa;function fg(e,t){var i=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*i,e)/12)}var pg,mg,vg,gg,yg,xg,Sg,Tg,Eg,bg,Ag,Cg,wg,Rg,Ig,Og,Mg,Pg,kg,Dg,Bg,Lg=rh([as.POINT,as.POINT,as.NONE,os.CLAMP,os.CLAMP,os.CLAMP]),Ng=new oa,Fg=new oa,zg=new oa,Ug=new oa,Gg=new Ta,Hg=new Ta,Vg=new $c,Wg=Number.MAX_SAFE_INTEGER,jg=function(){function e(t){i(this,e),this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var n=dg(this._device);this._formatSize=Ds[n].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Wp(t),this._pool.initialize({format:n,roundUpFn:fg}),this._customPool=new Wp(t),this._customPool.initialize({format:n,roundUpFn:fg})}return r(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),r(e,[{key:"clear",value:function(){this._pool.destroy(),this._textureBuffers.clear()}},{key:"registerCustomTextureLayouts",value:function(e){for(var t=0;t<e.length;t++)for(var i=e[t],n=this._customPool.createChunk(i.textureLength),r=0;r<i.contents.length;r++){var a=i.contents[r],o=a.skeleton;this._chunkIdxMap.set(o,n);for(var s=0;s<a.clips.length;s++){var l=a.clips[s];this._chunkIdxMap.set(o^l,n)}}}},{key:"getDefaultPoseTexture",value:function(e,t,i){var n=0^e.hash,r=this._textureBuffers.get(n)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var a=e.joints,o=e.bindposes,s=null,l=!1,c=a.length;if(r)r.refCount++;else{var u=12*c,h=this._chunkIdxMap.get(n),_=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!_)return r;r={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:_},s=new Float32Array(u),l=!0}oa.set(zg,Wg,Wg,Wg),oa.set(Ug,-Wg,-Wg,-Wg);for(var d=t.getBoneSpaceBounds(e),f=0,p=0;f<c;f++,p+=12){var m=i.getChildByPath(a[f]),v=m?hg(m,i,Gg):e.inverseBindposes[f],g=d[f];g&&($c.transform(Vg,g,v),Vg.getBoundary(Ng,Fg),oa.min(zg,zg,Ng),oa.max(Ug,Ug,Fg)),l&&(m&&Ta.multiply(v,v,o[f]),_g(s,p,m?v:Ta.IDENTITY))}var y=[new $c];return r.bounds.set(t.hash,y),$c.fromPoints(y[0],zg,Ug),l&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(n,r)),r}},{key:"getSequencePoseTexture",value:function(e,t,i,n){var r=e.hash^t.hash,a=this._textureBuffers.get(r)||null;if(a&&a.bounds.has(i.hash))return a.refCount++,a;var o=e.joints,s=e.bindposes,l=lg.getOrExtract(t).info.frames,c=null,u=!1,h=o.length;if(a)a.refCount++;else{var _=12*h*l,d=this._chunkIdxMap.get(r),f=void 0!==d?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,d):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!f)return null;var p=this._createAnimInfos(e,t,n);a={pixelOffset:f.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:f,animInfos:p},c=new Float32Array(_),u=!0}var m=i.getBoneSpaceBounds(e),v=[];a.bounds.set(i.hash,v);for(var g=0;g<l;g++)v.push(new $c(Wg,Wg,Wg,-Wg,-Wg,-Wg));for(var y=0,x=0;y<l;y++){for(var S=v[y],T=0;T<h;T++,x+=12){var E=a.animInfos[T],b=E.curveData,A=E.downstream,C=E.bindposeIdx,w=E.bindposeCorrection,R=void 0,I=!0;b&&A?R=Ta.multiply(Gg,b[y],A):b?R=b[y]:A?R=A:(R=e.inverseBindposes[C],I=!1);var O=m[T];if(O){var M=w?Ta.multiply(Hg,R,w):R;$c.transform(Vg,O,M),Vg.getBoundary(Ng,Fg),oa.min(S.center,S.center,Ng),oa.max(S.halfExtents,S.halfExtents,Fg)}u&&(I&&Ta.multiply(Gg,R,s[C]),_g(c,x,I?Gg:Ta.IDENTITY))}$c.fromPoints(S,S.center,S.halfExtents)}return u&&(this._pool.update(a.handle,c.buffer),this._textureBuffers.set(r,a)),a}},{key:"releaseHandle",value:function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}}},{key:"releaseSkeleton",value:function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;){var n=i.value;n.skeletonHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}}},{key:"releaseAnimationClip",value:function(e){for(var t=this._textureBuffers.values(),i=t.next();!i.done;){var n=i.value;n.clipHash===e.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=t.next()}}},{key:"_createAnimInfos",value:function(e,t,i){for(var n=[],r=e.joints,a=e.bindposes,o=r.length,s=lg.getOrExtract(t),l=0;l<o;l++){for(var c=r[l],u=s.data[c],h=i.getChildByPath(c),_=void 0,d=void 0;!u;){var f=c.lastIndexOf("/");if(c=c.substring(0,f),u=s.data[c],h?(_||(_=new Ta),Ta.fromRTS(Gg,h.rotation,h.position,h.scale),Ta.multiply(_,Gg,_),h=h.parent):d=c,f<0)break}var p=l,m=void 0;if(void 0!==d&&u){p=l-1;for(var v=0;v<o;v++)if(r[v]===d){p=v,m=new Ta,Ta.multiply(m,a[v],e.inverseBindposes[l]);break}}n.push({curveData:u&&u.worldMatrix.values,downstream:_,bindposeIdx:p,bindposeCorrection:m})}return n}}]),e}(),qg=function(){function e(t){i(this,e),this._pool=new Map,this._device=void 0,this._device=t}return r(e,[{key:"getData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"-1",t=this._pool.get(e);if(t)return t;var i=this._device.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,p_.SIZE,p_.SIZE)),n=new Float32Array([0,0,0,0]);i.update(n);var r={buffer:i,data:n,dirty:!1};return this._pool.set(e,r),r}},{key:"destroy",value:function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))}},{key:"switchClip",value:function(e,t){return e.data[0]=0,e.buffer.update(e.data),e.dirty=!1,e}},{key:"clear",value:function(){for(var e,t=y(this._pool.values());!(e=t()).done;){e.value.buffer.destroy()}this._pool.clear()}}]),e}(),Xg=new Bl(null),Yg=function(){function e(){i(this,e),this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=0,this._priority=Dh.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}return r(e,[{key:"initialize",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._device=E.director.root.device,this._subMesh=e,this._patches=i,this._passes=t,this._handle=wf.alloc(),this._flushPassInfo(),Xg.layout=t[0].setLayouts[Gh.LOCAL];var n=mf.alloc(this._device,Xg),r=vf.alloc(this._device,e.iaInfo);wf.set(this._handle,Tf.PRIORITY,Dh.DEFAULT),wf.set(this._handle,Tf.INPUT_ASSEMBLER,r),wf.set(this._handle,Tf.DESCRIPTOR_SET,n),this._inputAssembler=vf.get(r),this._descriptorSet=mf.get(n)}},{key:"destroy",value:function(){mf.free(wf.get(this._handle,Tf.DESCRIPTOR_SET)),vf.free(wf.get(this._handle,Tf.INPUT_ASSEMBLER)),wf.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=Dh.DEFAULT,this._handle=0,this._patches=null,this._subMesh=null,this._passes=null}},{key:"update",value:function(){for(var e=0;e<this._passes.length;++e){this._passes[e].update()}this._descriptorSet.update()}},{key:"onPipelineStateChanged",value:function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}},{key:"_flushPassInfo",value:function(){var e=this._passes;if(e){wf.set(this._handle,Tf.PASS_COUNT,e.length);for(var t=Tf.PASS_0,i=Tf.SHADER_0,n=0;n<e.length;n++,t++,i++)wf.set(this._handle,t,e[n].handle),wf.set(this._handle,i,e[n].getShaderVariant(this._patches))}}},{key:"passes",set:function(e){this._passes=e,this._flushPassInfo()},get:function(){return this._passes}},{key:"subMesh",set:function(e){this._subMesh=e,this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo)},get:function(){return this._subMesh}},{key:"priority",set:function(e){this._priority=e,wf.set(this._handle,Tf.PRIORITY,e)},get:function(){return this._priority}},{key:"handle",get:function(){return this._handle}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),Kg=e("RenderStage",(pg=ii("RenderStage"),mg=wi(0),vg=wi(1),gg=wi(2),pg((Sg=S((xg=function(){function e(){i(this,e),x(this,"_name",Sg,this),x(this,"_priority",Tg,this),x(this,"_tag",Eg,this)}return r(e,[{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e,t){this._pipeline=e,this._flow=t}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}}]),e}()).prototype,"_name",[mg,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Tg=S(xg.prototype,"_priority",[vg,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Eg=S(xg.prototype,"_tag",[gg,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yg=xg))||yg));E.RenderStage=Kg;var Zg,Qg,Jg,$g,ey,ty,iy,ny,ry=e("RenderFlow",(bg=ii("RenderFlow"),Ag=wi(0),Cg=wi(1),wg=wi(2),Rg=wi(3),Ig=Li([Kg]),bg((Pg=S((Mg=function(){function e(){i(this,e),x(this,"_name",Pg,this),x(this,"_priority",kg,this),x(this,"_tag",Dg,this),x(this,"_stages",Bg,this)}return r(e,[{key:"initialize",value:function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)}},{key:"render",value:function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].render(e)}},{key:"destroy",value:function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0}},{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}}]),e}()).prototype,"_name",[Ag,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kg=S(Mg.prototype,"_priority",[Cg,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dg=S(Mg.prototype,"_tag",[wg,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bg=S(Mg.prototype,"_stages",[Rg,Ig,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Og=Mg))||Og));E.RenderFlow=ry;var ay,oy,sy,ly,cy,uy,hy,_y,dy,fy,py,my,vy,gy,yy,xy,Sy,Ty,Ey,by,Ay,Cy,wy,Ry,Iy,Oy,My,Py,ky,Dy,By,Ly,Ny,Fy,zy,Uy,Gy,Hy,Vy,Wy,jy,qy,Xy,Yy,Ky,Zy,Qy,Jy,$y,ex,tx,ix,nx,rx,ax,ox,sx,lx,cx,ux,hx,_x,dx,fx,px,mx,vx,gx,yx,xx,Sx,Tx,Ex,bx,Ax,Cx,wx,Rx,Ix,Ox,Mx,Px,kx,Dx=e("RenderPipeline",(Zg=ii("cc.RenderPipeline"),Qg=wi(0),Jg=wi(1),$g=Li([ry]),Zg((iy=S((ty=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_tag",iy,c(n)),x(n,"_flows",ny,c(n)),n._macros={},n._commandBuffers=[],n}return o(t,e),r(t,[{key:"initialize",value:function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0}},{key:"activate",value:function(){this._device=E.director.root.device;var e=new Fl(Lh.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._descriptorSet=this._device.createDescriptorSet(new Bl(this._descriptorSetLayout));for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0}},{key:"render",value:function(e){for(var t=0;t<e.length;t++)for(var i=e[t],n=0;n<i.flows.length;n++)i.flows[n].render(i)}},{key:"destroy",value:function(){for(var e=0;e<this._flows.length;e++)this._flows[e].destroy();this._flows.length=0,this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null);for(var i=0;i<this._commandBuffers.length;i++)this._commandBuffers[i].destroy();return this._commandBuffers.length=0,_(s(t.prototype),"destroy",this).call(this)}},{key:"macros",get:function(){return this._macros}},{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"device",get:function(){return this._device}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}}]),t}(cn)).prototype,"_tag",[Qg,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ny=S(ty.prototype,"_flows",[Jg,$g,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ey=ty))||ey));E.RenderPipeline=Dx,nt(ss),nt(ls),nt(ps),nt(fs),nt(ms),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(kx||(kx={})),nt(kx);ay=ii("RenderTextureDesc"),oy=Li(ss),sy=Li(ls),ly=Li(jo),ay((hy=S((uy=function e(){i(this,e),x(this,"name",hy,this),x(this,"type",_y,this),x(this,"usage",dy,this),x(this,"format",fy,this),x(this,"width",py,this),x(this,"height",my,this)}).prototype,"name",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_y=S(uy.prototype,"type",[oy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ss.TEX2D}}),dy=S(uy.prototype,"usage",[sy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ls.COLOR_ATTACHMENT}}),fy=S(uy.prototype,"format",[ly],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jo.UNKNOWN}}),py=S(uy.prototype,"width",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),my=S(uy.prototype,"height",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),cy=uy));var Bx,Lx=(vy=ii("RenderTextureConfig"),gy=Li(om),vy((Sy=S((xy=function e(){i(this,e),x(this,"name",Sy,this),x(this,"texture",Ty,this)}).prototype,"name",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ty=S(xy.prototype,"texture",[gy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yy=xy))||yy),Nx=(Ey=ii("MaterialConfig"),by=Li(sm),Ey((wy=S((Cy=function e(){i(this,e),x(this,"name",wy,this),x(this,"material",Ry,this)}).prototype,"name",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ry=S(Cy.prototype,"material",[by],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ay=Cy))||Ay),Fx=(Iy=ii("FrameBufferDesc"),Oy=Li([pt]),My=Li(om),Iy((Dy=S((ky=function e(){i(this,e),x(this,"name",Dy,this),x(this,"renderPass",By,this),x(this,"colorTextures",Ly,this),x(this,"depthStencilTexture",Ny,this),x(this,"texture",Fy,this)}).prototype,"name",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),By=S(ky.prototype,"renderPass",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ly=S(ky.prototype,"colorTextures",[Oy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ny=S(ky.prototype,"depthStencilTexture",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Fy=S(ky.prototype,"texture",[My],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Py=ky)),zy=ii("ColorDesc"),Uy=Li(jo),Gy=Li(fs),Hy=Li(ps),Vy=Li(ms),Wy=Li(ms),zy((Xy=S((qy=function e(){i(this,e),x(this,"format",Xy,this),x(this,"loadOp",Yy,this),x(this,"storeOp",Ky,this),x(this,"sampleCount",Zy,this),x(this,"beginLayout",Qy,this),x(this,"endLayout",Jy,this)}).prototype,"format",[Uy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jo.UNKNOWN}}),Yy=S(qy.prototype,"loadOp",[Gy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fs.CLEAR}}),Ky=S(qy.prototype,"storeOp",[Hy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ps.STORE}}),Zy=S(qy.prototype,"sampleCount",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Qy=S(qy.prototype,"beginLayout",[Vy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ms.UNDEFINED}}),Jy=S(qy.prototype,"endLayout",[Wy],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ms.PRESENT_SRC}}),jy=qy))||jy),zx=($y=ii("DepthStencilDesc"),ex=Li(jo),tx=Li(fs),ix=Li(ps),nx=Li(fs),rx=Li(ps),ax=Li(ms),ox=Li(ms),$y((cx=S((lx=function e(){i(this,e),x(this,"format",cx,this),x(this,"depthLoadOp",ux,this),x(this,"depthStoreOp",hx,this),x(this,"stencilLoadOp",_x,this),x(this,"stencilStoreOp",dx,this),x(this,"sampleCount",fx,this),x(this,"beginLayout",px,this),x(this,"endLayout",mx,this)}).prototype,"format",[ex],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jo.UNKNOWN}}),ux=S(lx.prototype,"depthLoadOp",[tx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fs.CLEAR}}),hx=S(lx.prototype,"depthStoreOp",[ix],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ps.STORE}}),_x=S(lx.prototype,"stencilLoadOp",[nx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fs.CLEAR}}),dx=S(lx.prototype,"stencilStoreOp",[rx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ps.STORE}}),fx=S(lx.prototype,"sampleCount",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),px=S(lx.prototype,"beginLayout",[ax],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ms.UNDEFINED}}),mx=S(lx.prototype,"endLayout",[ox],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ms.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),sx=lx))||sx);vx=ii("RenderPassDesc"),gx=Li([Fx]),yx=Li(zx),vx((Tx=S((Sx=function e(){i(this,e),x(this,"index",Tx,this),x(this,"colorAttachments",Ex,this),x(this,"depthStencilAttachment",bx,this)}).prototype,"index",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ex=S(Sx.prototype,"colorAttachments",[gx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bx=S(Sx.prototype,"depthStencilAttachment",[yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zx}}),xx=Sx));!function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(Bx||(Bx={})),nt(Bx);var Ux,Gx=(Ax=ii("RenderQueueDesc"),Cx=Li(Bx),wx=Li([pt]),Ax((Ox=S((Ix=function e(){i(this,e),x(this,"isTransparent",Ox,this),x(this,"sortMode",Mx,this),x(this,"stages",Px,this)}).prototype,"isTransparent",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mx=S(Ix.prototype,"sortMode",[Cx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bx.FRONT_TO_BACK}}),Px=S(Ix.prototype,"stages",[wx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rx=Ix))||Rx);!function(e){e[e.GENERAL=100]="GENERAL"}(Ux||(Ux={}));var Hx,Vx,Wx=e("RenderView",function(){function e(){i(this,e),this._name="",this._window=null,this._priority=0,this._visibility=G_,this._isEnable=!1,this._flows=[]}return r(e,[{key:"name",get:function(){return this._name}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,E.director.root&&E.director.root.sortViews()}},{key:"visibility",set:function(e){this._visibility=e},get:function(){return this._visibility}},{key:"camera",get:function(){return this._camera}},{key:"isEnable",get:function(){return this._isEnable}},{key:"flows",get:function(){return this._flows}}]),r(e,[{key:"initialize",value:function(e){return this._camera=e.camera,this._name=e.name,this.priority=e.priority,this.setExecuteFlows(e.flows),!0}},{key:"destroy",value:function(){this._window=null,this._priority=0}},{key:"enable",value:function(e){this._isEnable=e}},{key:"setExecuteFlows",value:function(e){this._flows.length=0;var t=E.director.root.pipeline.flows;if(e&&1===e.length&&"UIFlow"===e[0]){for(var i=0;i<t.length;i++)if("UIFlow"===t[i].name){this._flows.push(t[i]);break}}else for(var n=0;n<t.length;++n){var r=t[n];(r.tag===kx.SCENE||e&&-1!==e.indexOf(r.name))&&this._flows.push(r)}}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=E.director.root.pipeline.flows,t=0;t<this._flows.length;++t)for(var i=this._flows[t],n=0;n<e.length;n++)if(e[n].name===i.name){this._flows[t]=e[n];break}}}]),e}());!function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(Hx||(Hx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(Vx||(Vx={}));var jx=e("PipelineStateManager",function(){function e(){i(this,e)}return r(e,null,[{key:"getOrCreatePipelineState",value:function(e,t,i,n,r){var a=bf.get(t,hf.HASH)^n.hash^r.attributesHash^i.id,o=this._PSOHashMap.get(a);if(!o){var s=gf.get(bf.get(t,hf.PIPELINE_LAYOUT)),l=new _l;l.attributes=r.attributes;var c=new dl(i,s,n,l,_f.get(bf.get(t,hf.RASTERIZER_STATE)),df.get(bf.get(t,hf.DEPTH_STENCIL_STATE)),ff.get(bf.get(t,hf.BLEND_STATE)),bf.get(t,hf.PRIMITIVE),bf.get(t,hf.DYNAMIC_STATES));o=e.createPipelineState(c),this._PSOHashMap.set(a,o)}return o}}]),e}());function qx(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function Xx(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}jx._PSOHashMap=new Map;var Yx=function(){function e(t){i(this,e),this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new Ui((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Gi(64,this._passDesc.sortFunc)}return r(e,[{key:"clear",value:function(){this.queue.clear(),this._passPool.reset()}},{key:"insertRenderPass",value:function(e,t,i){var n=e.model.subModels[t],r=wf.get(n.handle,Tf.PASS_0+i);if(ff.get(bf.get(r,hf.BLEND_STATE)).targets[0].blend!==this._passDesc.isTransparent||!(bf.get(r,hf.PHASE)&this._passDesc.phases))return!1;var a=0|bf.get(r,hf.PRIORITY)<<16|n.priority<<8|i,o=this._passPool.add();return o.hash=a,o.depth=e.depth||0,o.shaderId=wf.get(n.handle,Tf.SHADER_0+i),o.subModel=n,o.passIdx=i,this.queue.push(o),!0}},{key:"sort",value:function(){this.queue.sort()}},{key:"recordCommandBuffer",value:function(e,t,i){for(var n=0;n<this.queue.length;++n){var r=this.queue.array[n],a=r.subModel,o=r.passIdx,s=a.inputAssembler,l=a.handle,c=wf.get(l,Tf.PASS_0+o),u=pf.get(wf.get(l,Tf.SHADER_0+o)),h=jx.getOrCreatePipelineState(e,c,u,t,s);i.bindPipelineState(h),i.bindDescriptorSet(Gh.MATERIAL,mf.get(bf.get(c,hf.DESCRIPTOR_SET))),i.bindDescriptorSet(Gh.LOCAL,mf.get(wf.get(l,Tf.DESCRIPTOR_SET))),i.bindInputAssembler(s),i.draw(s)}}}]),e}();function Kx(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var Zx,Qx=function(){function e(){i(this,e),this.queue=new Set}return r(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"recordCommandBuffer",value:function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){for(var a=0;a<r.value.batches.length;++a){var o=r.value.batches[a];if(o.mergeCount){for(var s=0;s<o.vbs.length;++s)o.vbs[s].update(o.vbDatas[s]);o.vbIdx.update(o.vbIdxData.buffer),o.ubo.update(o.uboData)}}r=n.next()}for(r=(n=this.queue.values()).next();!r.done;){for(var l=!1,c=0;c<r.value.batches.length;++c){var u=r.value.batches[c];if(u.mergeCount){if(!l){var h=pf.get(u.hShader),_=jx.getOrCreatePipelineState(e,u.hPass,h,t,u.ia);i.bindPipelineState(_),i.bindDescriptorSet(Gh.MATERIAL,mf.get(bf.get(u.hPass,hf.DESCRIPTOR_SET))),l=!0}i.bindDescriptorSet(Gh.LOCAL,u.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(u.ia),i.draw(u.ia)}}r=n.next()}}}]),e}(),Jx=function(){function e(){i(this,e),this.queue=new Set}return r(e,[{key:"clear",value:function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()}},{key:"recordCommandBuffer",value:function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;)r.value.hasPendingModels&&r.value.uploadBuffers(),r=n.next();for(r=(n=this.queue.values()).next();!r.done;){var a=r.value,o=a.instances,s=a.hPass;if(a.hasPendingModels){i.bindDescriptorSet(Gh.MATERIAL,mf.get(bf.get(s,hf.DESCRIPTOR_SET)));for(var l=null,c=0;c<o.length;++c){var u=o[c];if(u.count){var h=pf.get(u.hShader),_=jx.getOrCreatePipelineState(e,s,h,t,u.ia);l!==_&&(i.bindPipelineState(_),l=_),i.bindDescriptorSet(Gh.LOCAL,mf.get(u.hDescriptorSet),r.value.dynamicOffsets),i.bindInputAssembler(u.ia),i.draw(u.ia)}}}r=n.next()}}}]),e}();function $x(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),r=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),a=2*n-8*r+4,o=3*n/a,s=2*r/a,l=1/s*o,c=1/s*(1-o-s);e.x=3.2404542*l-1.5371385+-.4985314*c,e.y=-.969266*l+1.8760108+.041556*c,e.z=.0556434*l-.2040259+1.0572252*c}!function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(Zx||(Zx={}));var eS=function(e){return 4*Math.PI*Math.PI*e*e},tS=function(){function e(){i(this,e),this._color=new oa(1,1,1),this._colorTemp=6550,this._colorTempRGB=new oa(1,1,1),this._scene=null,this._node=null,this._type=void 0,this._name=null,this._handle=0,this._type=Zx.UNKNOWN}return r(e,[{key:"color",set:function(e){this._color.set(e),hp.setVec3(this._handle,lp.COLOR,e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){hp.set(this._handle,lp.USE_COLOR_TEMPERATURE,e?1:0)},get:function(){return 1===hp.get(this._handle,lp.USE_COLOR_TEMPERATURE)}},{key:"colorTemperature",set:function(e){this._colorTemp=e,$x(this._colorTempRGB,this._colorTemp),hp.setVec3(this._handle,lp.COLOR_TEMPERATURE_RGB,this._colorTempRGB)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=nv.ROTATION,hp.set(this._handle,lp.NODE,this._node.handle))},get:function(){return this._node}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"handle",get:function(){return this._handle}}]),r(e,[{key:"initialize",value:function(){this._handle=hp.alloc(),hp.setVec3(this._handle,lp.COLOR,this._color),hp.setVec3(this._handle,lp.COLOR_TEMPERATURE_RGB,this._colorTempRGB)}},{key:"attachToScene",value:function(e){this._scene=e}},{key:"detachFromScene",value:function(){this._scene=null}},{key:"destroy",value:function(){this._name=null,this._type=Zx.UNKNOWN,this._node=null,this._handle&&(hp.free(this._handle),this._handle=0)}},{key:"update",value:function(){}}]),e}(),iS=e("InstancedBuffer",function(){function e(t){i(this,e),this.instances=[],this.hPass=0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.hPass=t.handle}return r(e,null,[{key:"get",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=e._buffers;n.has(t)||n.set(t,{});var r=n.get(t);return r[i]||(r[i]=new e(t))}}]),r(e,[{key:"destroy",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0}},{key:"merge",value:function(e,t,i){var n=t.buffer.length;if(n){for(var r=e.inputAssembler,a=e.descriptorSet.getTexture(O_),o=wf.get(e.handle,Tf.SHADER_0+i),s=wf.get(e.handle,Tf.DESCRIPTOR_SET),l=0;l<this.instances.length;++l){var c=this.instances[l];if(!(c.ia.indexBuffer!==r.indexBuffer||c.count>=1024)&&c.lightingMap===a){if(c.stride!==n)return;if(c.count>=c.capacity){c.capacity<<=1;var u=c.stride*c.capacity,h=c.data;c.data=new Uint8Array(u),c.data.set(h),c.vb.resize(u)}return c.hShader!==o&&(c.hShader=o),c.hDescriptorSet!==s&&(c.hDescriptorSet=s),c.data.set(t.buffer,c.stride*c.count++),void(this.hasPendingModels=!0)}}for(var _=this._device.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,32*n,n)),d=new Uint8Array(32*n),f=r.vertexBuffers.slice(),p=r.attributes.slice(),m=r.indexBuffer,v=0;v<t.list.length;v++){var g=t.list[v],y=new al(g.name,g.format,g.isNormalized,f.length,!0);p.push(y)}d.set(t.buffer),f.push(_);var x=new ol(p,f,m),S=this._device.createInputAssembler(x);this.instances.push({count:1,capacity:32,vb:_,data:d,ia:S,stride:n,hShader:o,hDescriptorSet:s,lightingMap:a}),this.hasPendingModels=!0}}},{key:"uploadBuffers",value:function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.count&&(t.ia.instanceCount=t.count,t.vb.update(t.data))}}},{key:"clear",value:function(){for(var e=0;e<this.instances.length;++e){this.instances[e].count=0}this.hasPendingModels=!1}}]),e}());iS._buffers=new Map;var nS=function(){function e(t){i(this,e),this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}return r(e,null,[{key:"get",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=e._buffers;n.has(t)||n.set(t,{});var r=n.get(t);return r[i]||(r[i]=new e(t))}}]),r(e,[{key:"destroy",value:function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0}},{key:"merge",value:function(e,t,i){var n=e.subMesh.flatBuffers;if(0!==n.length){for(var r=0,a=0,o=n[0].count,s=wf.get(e.handle,Tf.PASS_0+t),l=wf.get(e.handle,Tf.SHADER_0+t),c=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===n.length&&_.mergeCount<__.BATCHING_COUNT){u=!0;for(var d=0;d<_.vbs.length;++d){if(_.vbs[d].stride!==n[d].stride){u=!1;break}}if(u){for(var f=0;f<_.vbs.length;++f){var p=n[f],m=_.vbs[f],v=_.vbDatas[f];(r=(o+_.vbCount)*p.stride)>m.size&&(m.resize(r),_.vbDatas[f]=new Uint8Array(r),_.vbDatas[f].set(v)),_.vbDatas[f].set(p.buffer,_.vbCount*p.stride)}var g=_.vbIdxData;(a=4*(o+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(a),_.vbIdxData=new Float32Array(a/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+o,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var T=y;T<x;T++)g[T]=S+.1;return Ta.toArray(_.uboData,i.model.transform.worldMatrix,__.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(c.bindBuffer(__.BINDING,_.ubo),c.update(),_.hPass=s,_.hShader=l,_.descriptorSet=c),++_.mergeCount,_.vbCount+=o,void(_.ia.vertexCount+=o)}}}for(var E=[],b=[],A=[],C=0;C<n.length;++C){var w=n[C],R=this._device.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,w.count*w.stride,w.stride));R.update(w.buffer.buffer),E.push(R),b.push(new Uint8Array(R.size)),A.push(R)}var I=this._device.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,4*o,4)),O=new Float32Array(o);O.fill(0),I.update(O),A.push(I);for(var M=e.inputAssembler.attributes,P=new Array(M.length+1),k=0;k<M.length;++k)P[k]=M[k];P[M.length]=new al("a_dyn_batch_id",jo.R32F,!1,n.length);var D=new ol(P,A),B=this._device.createInputAssembler(D),L=this._device.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,__.SIZE,__.SIZE));c.bindBuffer(__.BINDING,L),c.update();var N=new Float32Array(__.COUNT);Ta.toArray(N,i.model.transform.worldMatrix,__.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:E,vbDatas:b,vbIdx:I,vbIdxData:O,vbCount:o,ia:B,ubo:L,uboData:N,hPass:s,hShader:l,descriptorSet:c})}}},{key:"clear",value:function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}}}]),e}();nS._buffers=new Map;var rS=new zi((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[]}}),16),aS=new Float32Array(4),oS=Uo.create(0,0,0,1),sS=[],lS=[];function cS(e,t){return!(!t.worldBounds||Uc.aabb_aabb(t.worldBounds,e.aabb))}function uS(e,t){return!(!t.worldBounds||Uc.aabb_aabb(t.worldBounds,e.aabb)&&Uc.aabb_frustum(t.worldBounds,e.frustum))}var hS=nf("forward-add");function _S(e){for(var t=0;t<e.length;t++)for(var i=e[t].passes,n=0;n<i.length;n++)if(i[n].phase===hS)return n;return-1}var dS=function(){function e(t){i(this,e),this._device=void 0,this._validLights=[],this._lightPasses=[],this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstlightBufferView=void 0,this._lightBufferData=void 0,this._isHDR=void 0,this._fpScale=void 0,this._renderObjects=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._device=t.device,this._isHDR=t.isHDR,this._fpScale=t.fpScale,this._renderObjects=t.renderObjects,this._instancedQueue=new Jx,this._batchedQueue=new Qx,this._lightBufferStride=Math.ceil(d_.SIZE/this._device.uboOffsetAlignment)*this._device.uboOffsetAlignment,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstlightBufferView=this._device.createBuffer(new Xs(this._lightBuffer,0,d_.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}return r(e,[{key:"gatherLightPasses",value:function(e,t){var i=this._validLights,n=e.camera.scene.sphereLights;this._instancedQueue.clear(),this._batchedQueue.clear(),i.length=0;for(var r=0;r<this._lightPasses.length;r++){this._lightPasses[r].dynamicOffsets.length=0}rS.freeArray(this._lightPasses),this._lightPasses.length=0;for(var a=0;a<n.length;a++){var o=n[a];Uo.set(oS,o.position.x,o.position.y,o.position.z,o.range),Uc.sphere_frustum(oS,e.camera.frustum)&&i.push(o)}for(var s=e.camera.scene.spotLights,l=0;l<s.length;l++){var c=s[l];Uo.set(oS,c.position.x,c.position.y,c.position.z,c.range),Uc.sphere_frustum(oS,e.camera.frustum)&&i.push(c)}if(i.length){this._updateUBOs(e,t);for(var u=0;u<this._renderObjects.length;u++){var h=this._renderObjects[u],_=h.model,d=_.subModels,f=_S(d);if(!(f<0)){lS.length=0;for(var p=0;p<i.length;p++){var m=i[p],v=!1;switch(m.type){case Zx.SPHERE:v=cS(m,_);break;case Zx.SPOT:v=uS(m,_)}v||lS.push(p)}if(lS.length)for(var g=0;g<d.length;g++){var y=d[g],x=y.passes[f],S=x.batchingScheme;if(y.descriptorSet.bindBuffer(d_.BINDING,this._firstlightBufferView),y.descriptorSet.update(),S===xp.INSTANCING)for(var T=0;T<lS.length;T++){var E=lS[T],b=iS.get(x,E);b.merge(y,_.instancedAttributes,f),b.dynamicOffsets[0]=this._lightBufferStride*E,this._instancedQueue.queue.add(b)}else if(S===xp.VB_MERGING)for(var A=0;A<lS.length;A++){var C=lS[A],w=nS.get(x,C);w.merge(y,f,h),w.dynamicOffsets[0]=this._lightBufferStride*C,this._batchedQueue.queue.add(w)}else{var R=rS.alloc();R.subModel=y,R.passIdx=f;for(var I=0;I<lS.length;I++)R.dynamicOffsets.push(this._lightBufferStride*lS[I]);this._lightPasses.push(R)}}}}}}},{key:"recordCommandBuffer",value:function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._lightPasses.length;n++){var r=this._lightPasses[n],a=r.subModel,o=r.passIdx,s=r.dynamicOffsets,l=pf.get(wf.get(a.handle,Tf.SHADER_0+o)),c=a.passes[o],u=a.inputAssembler,h=jx.getOrCreatePipelineState(e,c.handle,l,t,u),_=mf.get(bf.get(c.handle,hf.DESCRIPTOR_SET)),d=a.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(Gh.MATERIAL,_),i.bindInputAssembler(u);for(var f=0;f<s.length;++f)sS[0]=s[f],i.bindDescriptorSet(Gh.LOCAL,d,sS),i.draw(u)}}},{key:"_updateUBOs",value:function(e,t){var i=e.camera.exposure;this._validLights.length>this._lightBufferCount&&(this._firstlightBufferView.destroy(),this._lightBufferCount=Rn(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstlightBufferView.initialize(new Xs(this._lightBuffer,0,d_.SIZE)));for(var n=0,r=0;n<this._validLights.length;n++,r+=this._lightBufferElementCount){var a=this._validLights[n];switch(a.type){case Zx.SPHERE:var o=a;if(oa.toArray(aS,o.position),aS[3]=0,this._lightBufferData.set(aS,r+d_.LIGHT_POS_OFFSET),aS[0]=o.size,aS[1]=o.range,aS[2]=0,this._lightBufferData.set(aS,r+d_.LIGHT_SIZE_RANGE_ANGLE_OFFSET),oa.toArray(aS,a.color),a.useColorTemperature){var s=a.colorTemperatureRGB;aS[0]*=s.x,aS[1]*=s.y,aS[2]*=s.z}this._isHDR?aS[3]=o.luminance*this._fpScale*this._lightMeterScale:aS[3]=o.luminance*i*this._lightMeterScale,this._lightBufferData.set(aS,r+d_.LIGHT_COLOR_OFFSET);break;case Zx.SPOT:var l=a;if(oa.toArray(aS,l.position),aS[3]=1,this._lightBufferData.set(aS,r+d_.LIGHT_POS_OFFSET),aS[0]=l.size,aS[1]=l.range,aS[2]=l.spotAngle,this._lightBufferData.set(aS,r+d_.LIGHT_SIZE_RANGE_ANGLE_OFFSET),oa.toArray(aS,l.direction),this._lightBufferData.set(aS,r+d_.LIGHT_DIR_OFFSET),oa.toArray(aS,a.color),a.useColorTemperature){var c=a.colorTemperatureRGB;aS[0]*=c.x,aS[1]*=c.y,aS[2]*=c.z}this._isHDR?aS[3]=l.luminance*this._fpScale*this._lightMeterScale:aS[3]=l.luminance*i*this._lightMeterScale,this._lightBufferData.set(aS,r+d_.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)}}]),e}(),fS=et({Planar:0,ShadowMap:1}),pS=et({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3}),mS=function(){function e(){i(this,e),this._normal=new oa(0,1,0),this._shadowColor=new Ma(0,0,0,76),this._matLight=new Ta,this._material=null,this._instancingMaterial=null,this._size=new ia(512,512),this._handle=0,this._sphere=new Uo(0,0,0,.01),this._handle=cp.alloc()}return r(e,[{key:"enabled",get:function(){return cp.get(this._handle,ap.ENABLE)},set:function(e){this.dirty=!0,cp.set(this._handle,ap.ENABLE,e?1:0),e?this.activate():this._updatePipeline()}},{key:"normal",get:function(){return this._normal},set:function(e){oa.copy(this._normal,e),this.dirty=!0,cp.setVec3(this._handle,ap.NORMAL,this._normal)}},{key:"distance",get:function(){return cp.get(this._handle,ap.DISTANCE)},set:function(e){this.dirty=!0,cp.set(this._handle,ap.DISTANCE,e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e,this.dirty=!0,cp.setVec4(this._handle,ap.COLOR,e)}},{key:"type",get:function(){return cp.get(this._handle,ap.TYPE)},set:function(e){cp.set(this._handle,ap.TYPE,this.enabled?e:-1),this._updatePipeline(),this._updatePlanarInfo()}},{key:"near",get:function(){return cp.get(this._handle,ap.NEAR)},set:function(e){cp.set(this._handle,ap.NEAR,e)}},{key:"far",get:function(){return cp.get(this._handle,ap.FAR)},set:function(e){cp.set(this._handle,ap.FAR,e)}},{key:"aspect",get:function(){return cp.get(this._handle,ap.ASPECT)},set:function(e){cp.set(this._handle,ap.ASPECT,e)}},{key:"orthoSize",get:function(){return cp.get(this._handle,ap.ORTHO_SIZE)},set:function(e){cp.set(this._handle,ap.ORTHO_SIZE,e)}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,cp.setVec2(this._handle,ap.SIZE,this._size)}},{key:"pcf",get:function(){return cp.get(this._handle,ap.PCF_TYPE)},set:function(e){cp.set(this._handle,ap.PCF_TYPE,e)}},{key:"matLight",get:function(){return this._matLight}},{key:"sphere",get:function(){return this._sphere}},{key:"dirty",get:function(){return cp.get(this._handle,ap.DIRTY)},set:function(e){cp.set(this._handle,ap.DIRTY,e?1:0)}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"handle",get:function(){return this._handle}}]),r(e,[{key:"activate",value:function(){this.dirty=!0,this.type===fS.ShadowMap?this._updatePipeline():this._updatePlanarInfo()}},{key:"_updatePlanarInfo",value:function(){this._material||(this._material=new sm,this._material.initialize({effectName:"pipeline/planar-shadow"}),cp.set(this._handle,ap.PLANAR_PASS,this._material.passes[0].handle)),this._instancingMaterial||(this._instancingMaterial=new sm,this._instancingMaterial.initialize({effectName:"pipeline/planar-shadow",defines:{USE_INSTANCING:!0}}),cp.set(this._handle,ap.INSTANCE_PASS,this._instancingMaterial.passes[0].handle))}},{key:"_updatePipeline",value:function(){var e=E.director.root,t=e.pipeline,i=this.enabled&&this.type===fS.ShadowMap;t.macros.CC_RECEIVE_SHADOW!==i&&(t.macros.CC_RECEIVE_SHADOW=i,e.onGlobalPipelineStateChanged())}},{key:"destroy",value:function(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this._handle&&(cp.free(this._handle),this._handle=0)}}]),e}();E.Shadows=mS;var vS,gS,yS,xS,SS,TS,ES,bS,AS,CS,wS,RS,IS,OS,MS,PS,kS,DS,BS,LS,NS,FS,zS=new $c,US=function(){function e(t){i(this,e),this._pendingModels=[],this._record=new Map,this._pipeline=t}return r(e,[{key:"createShadowData",value:function(e){for(var t=[],i=this._pipeline.shadows,n=e.isInstancingEnabled?i.instancingMaterial:i.material,r=e.isInstancingEnabled?iS.get(n.passes[0]):null,a=e.subModels,o=0;o<a.length;o++){var s=wf.get(a[o].handle,Tf.SHADER_0);t.push(pf.get(s))}return{model:e,shaders:t,instancedBuffer:r}}},{key:"updateShadowList",value:function(e){this._pendingModels.length=0;var t=this._pipeline.shadows;if(t.enabled&&t.type===fS.Planar){var i=e.camera,n=i.scene,r=i.frustum,a=0!=(i.visibility&Ph.BitMask.DEFAULT);if(n.mainLight&&a)for(var o=n.models,s=0;s<o.length;s++){var l=o[s];if(l.enabled&&l.node&&l.castShadow&&(!l.worldBounds||($c.transform(zS,l.worldBounds,t.matLight),Uc.aabb_frustum(zS,r)))){var c=this.createShadowData(l);this._pendingModels.push(c)}}}}},{key:"recordCommandBuffer",value:function(e,t,i){var n=this._pipeline.shadows;if(n.enabled&&n.type===fS.Planar){var r=this._pendingModels,a=r.length;if(a){var o=iS.get(n.instancingMaterial.passes[0]);o&&o.clear();var s=n.material.passes[0].handle,l=mf.get(bf.get(s,hf.DESCRIPTOR_SET));i.bindDescriptorSet(Gh.MATERIAL,l);for(var c=0;c<a;c++)for(var u=r[c],h=u.model,_=u.shaders,d=u.instancedBuffer,f=0;f<_.length;f++){var p=h.subModels[f],m=_[f];if(d)d.merge(p,h.instancedAttributes,0);else{var v=p.inputAssembler,g=jx.getOrCreatePipelineState(e,s,m,t,v);i.bindPipelineState(g),i.bindDescriptorSet(Gh.LOCAL,p.descriptorSet),i.bindInputAssembler(v),i.draw(v)}}if(o&&o.hasPendingModels){o.uploadBuffers(),l=mf.get(bf.get(o.hPass,hf.DESCRIPTOR_SET)),i.bindDescriptorSet(Gh.MATERIAL,l);for(var y=null,x=0;x<o.instances.length;++x){var S=o.instances[x];if(S.count){var T=pf.get(S.hShader),E=jx.getOrCreatePipelineState(e,o.hPass,T,t,S.ia);y!==E&&(i.bindPipelineState(E),i.bindDescriptorSet(Gh.LOCAL,mf.get(S.hDescriptorSet)),y=E),i.bindInputAssembler(S.ia),i.draw(S.ia)}}}}}}}]),e}(),GS=[new As(0,0,0,1)],HS=e("ForwardStage",(vS=ii("ForwardStage"),gS=Li([Gx]),yS=wi(2),vS((bS=ES=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"renderQueues",TS,c(e)),e._renderQueues=[],e._renderArea=new Es,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=nf("default"),e._batchedQueue=new Qx,e._instancedQueue=new Jx,e}return o(t,e),r(t,[{key:"initialize",value:function(e){return _(s(t.prototype),"initialize",this).call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e,i){_(s(t.prototype),"activate",this).call(this,e,i);for(var n=0;n<this.renderQueues.length;n++){for(var r=0,a=0;a<this.renderQueues[n].stages.length;a++)r|=nf(this.renderQueues[n].stages[a]);var o=qx;switch(this.renderQueues[n].sortMode){case Bx.BACK_TO_FRONT:o=Xx;break;case Bx.FRONT_TO_BACK:o=qx}this._renderQueues[n]=new Yx({isTransparent:this.renderQueues[n].isTransparent,phases:r,sortFunc:o})}this._additiveLightQueue=new dS(this._pipeline),this._planarQueue=new US(this._pipeline)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(this.renderQueueClearFunc);for(var n=t.renderObjects,r=0,a=0,o=0,s=0;s<n.length;++s){var l=n[s],c=l.model.subModels;for(r=0;r<c.length;++r){var u=c[r],h=u.passes;for(a=0;a<h.length;++a){var _=h[a];if(_.phase===this._phaseID){var d=_.batchingScheme;if(d===xp.INSTANCING){var f=iS.get(_);f.merge(u,l.model.instancedAttributes,a),this._instancedQueue.queue.add(f)}else if(d===xp.VB_MERGING){var p=nS.get(_);p.merge(u,a,l),this._batchedQueue.queue.add(p)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(l,r,a)}}}}var m=t.commandBuffers[0];this._renderQueues.forEach(this.renderQueueSortFunc),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.updateShadowList(e);var v=e.camera,g=v.viewport;if(this._renderArea.x=g.x*v.width,this._renderArea.y=g.y*v.height,this._renderArea.width=g.width*v.width*t.shadingScale,this._renderArea.height=g.height*v.height*t.shadingScale,v.clearFlag&Ts.COLOR)if(t.isHDR){Kx(GS[0],v.clearColor);var y=t.fpScale/v.exposure;GS[0].x*=y,GS[0].y*=y,GS[0].z*=y}else GS[0].x=v.clearColor.x,GS[0].y=v.clearColor.y,GS[0].z=v.clearColor.z;GS[0].w=v.clearColor.w;var x=e.window.framebuffer,S=x.colorTextures[0]?x.renderPass:t.getRenderPass(v.clearFlag);m.beginRenderPass(S,x,this._renderArea,GS,v.clearDepth,v.clearStencil),m.bindDescriptorSet(Gh.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,S,m),this._instancedQueue.recordCommandBuffer(i,S,m),this._batchedQueue.recordCommandBuffer(i,S,m),this._additiveLightQueue.recordCommandBuffer(i,S,m),this._planarQueue.recordCommandBuffer(i,S,m),this._renderQueues[1].recordCommandBuffer(i,S,m),m.endRenderPass()}},{key:"renderQueueClearFunc",value:function(e){e.clear()}},{key:"renderQueueSortFunc",value:function(e){e.sort()}}]),t}(Kg),ES.initInfo={name:"ForwardStage",priority:Hx.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:Bx.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Bx.BACK_TO_FRONT,stages:["default","planarShadow"]}]},TS=S((SS=bS).prototype,"renderQueues",[gS,si,yS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xS=SS))||xS)),VS=e("ForwardFlow",ii("ForwardFlow")((wS=CS=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"initialize",value:function(e){if(_(s(t.prototype),"initialize",this).call(this,e),0===this._stages.length){var i=new HS;i.initialize(HS.initInfo),this._stages.push(i)}return!0}},{key:"activate",value:function(e){_(s(t.prototype),"activate",this).call(this,e)}},{key:"render",value:function(e){this._pipeline.updateUBOs(e),_(s(t.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){_(s(t.prototype),"destroy",this).call(this)}}]),t}(ry),CS.initInfo={name:"ForwardFlow",priority:Vx.FORWARD,stages:[]},AS=wS))||AS),WS=function(){function e(){i(this,e),this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._shadowMapBuffer=null,this._phaseID=nf("shadow-add"),this._instancedQueue=new Jx,this._batchedQueue=new Qx}return r(e,[{key:"clear",value:function(e){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear(),this._shadowMapBuffer=e}},{key:"add",value:function(e,t,i){var n=e.model.subModels[t],r=n.passes[i];if(r.phase===this._phaseID)if(this._shadowMapBuffer)if(r.batchingScheme===xp.INSTANCING){var a=iS.get(r);a.merge(n,e.model.instancedAttributes,i),this._instancedQueue.queue.add(a)}else if(r.batchingScheme===xp.VB_MERGING){var o=nS.get(r);o.merge(n,i,e),this._batchedQueue.queue.add(o)}else{var s=pf.get(wf.get(n.handle,Tf.SHADER_0+i));this._subModelsArray.push(n),this._shaderArray.push(s),this._passArray.push(r.handle)}else this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()}},{key:"recordCommandBuffer",value:function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],a=this._shaderArray[n],o=this._passArray[n],s=r.inputAssembler,l=jx.getOrCreatePipelineState(e,o,a,t,s),c=mf.get(bf.get(o,hf.DESCRIPTOR_SET));i.bindPipelineState(l),i.bindDescriptorSet(Gh.MATERIAL,c),i.bindDescriptorSet(Gh.LOCAL,r.descriptorSet),i.bindInputAssembler(s),i.draw(s)}}}]),e}(),jS=[new As(1,1,1,1)],qS=e("ShadowStage",ii("ShadowStage")((OS=IS=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._additiveShadowQueue=void 0,e._shadowFrameBuffer=null,e._renderArea=new Es,e._additiveShadowQueue=new WS,e}return o(t,e),r(t,[{key:"setShadowFrameBuffer",value:function(e){this._shadowFrameBuffer=e}}]),r(t,[{key:"destroy",value:function(){}},{key:"render",value:function(e){var t=this._pipeline,i=t.shadows;this._additiveShadowQueue.clear(t.descriptorSet.getBuffer(qh.BINDING));for(var n=t.shadowObjects,r=0,a=0,o=0;o<n.length;++o){var s=n[o],l=s.model.subModels;for(r=0;r<l.length;r++){var c=l[r].passes;for(a=0;a<c.length;a++)this._additiveShadowQueue.add(s,r,a)}}var u=e.camera,h=t.commandBuffers[0],_=u.viewport,d=i.size;this._renderArea.x=_.x*d.x,this._renderArea.y=_.y*d.y,this._renderArea.width=_.width*d.x*t.shadingScale,this._renderArea.height=_.height*d.y*t.shadingScale;var f=t.device,p=this._shadowFrameBuffer.renderPass;h.beginRenderPass(p,this._shadowFrameBuffer,this._renderArea,jS,u.clearDepth,u.clearStencil),h.bindDescriptorSet(Gh.GLOBAL,t.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(f,p,h),h.endRenderPass()}}]),t}(Kg),IS.initInfo={name:"ShadowStage",priority:Hx.FORWARD,tag:0},RS=OS))||RS),XS=e("ShadowFlow",ii("ShadowFlow")((kS=PS=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._shadowRenderPass=null,n._shadowRenderTargets=[],n._shadowFrameBuffer=null,n._depth=null,n._width=0,n._height=0,n}return o(t,e),r(t,[{key:"initialize",value:function(e){if(_(s(t.prototype),"initialize",this).call(this,e),0===this._stages.length){var i=new qS;i.initialize(qS.initInfo),this._stages.push(i)}return!0}},{key:"activate",value:function(e){_(s(t.prototype),"activate",this).call(this,e);var i=e.device,n=e.shadows.size;if(this._width=n.x,this._height=n.y,!this._shadowRenderPass){var r=new vl;r.format=jo.RGBA8,r.loadOp=fs.CLEAR,r.storeOp=ps.STORE,r.sampleCount=1,r.beginLayout=ms.UNDEFINED,r.endLayout=ms.PRESENT_SRC;var a=new gl;a.format=i.depthStencilFormat,a.depthLoadOp=fs.CLEAR,a.depthStoreOp=ps.STORE,a.stencilLoadOp=fs.CLEAR,a.stencilStoreOp=ps.STORE,a.sampleCount=1,a.beginLayout=ms.UNDEFINED,a.endLayout=ms.DEPTH_STENCIL_ATTACHMENT_OPTIMAL;var o=new yl([r],a);this._shadowRenderPass=i.createRenderPass(o)}this._shadowRenderTargets.length<1&&this._shadowRenderTargets.push(i.createTexture(new Il(ss.TEX2D,ls.COLOR_ATTACHMENT|ls.SAMPLED,jo.RGBA8,this._width,this._height))),this._depth||(this._depth=i.createTexture(new Il(ss.TEX2D,ls.DEPTH_STENCIL_ATTACHMENT,i.depthStencilFormat,this._width,this._height))),this._shadowFrameBuffer||(this._shadowFrameBuffer=i.createFramebuffer(new el(this._shadowRenderPass,this._shadowRenderTargets,this._depth)));for(var l=0;l<this._stages.length;++l)this._stages[l].setShadowFrameBuffer(this._shadowFrameBuffer)}},{key:"render",value:function(e){var i=this._pipeline,n=i.shadows;if(n.type===fS.ShadowMap){var r=n.size;this._width===r.x&&this._height===r.y||(this.resizeShadowMap(r.x,r.y),this._width=r.x,this._height=r.y),i.updateUBOs(e),_(s(t.prototype),"render",this).call(this,e),i.descriptorSet.bindTexture(Xh,this._shadowFrameBuffer.colorTextures[0])}}},{key:"resizeShadowMap",value:function(e,t){if(this._depth&&this._depth.resize(e,t),this._shadowRenderTargets.length>0)for(var i=0;i<this._shadowRenderTargets.length;i++){var n=this._shadowRenderTargets[i];n&&n.resize(e,t)}this._shadowFrameBuffer&&(this._shadowFrameBuffer.destroy(),this._shadowFrameBuffer.initialize(new el(this._shadowRenderPass,this._shadowRenderTargets,this._depth)))}},{key:"shadowFrameBuffer",get:function(){return this._shadowFrameBuffer}}]),t}(ry),PS.initInfo={name:"ShadowFlow",priority:Vx.SHADOW,tag:kx.SCENE,stages:[]},MS=kS))||MS);!function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(DS||(DS={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(BS||(BS={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(LS||(LS={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(NS||(NS={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(FS||(FS={}));var YS=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],KS=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],ZS=[100,200,400,800],QS=new oa,JS=new oa,$S=new Ta,eT=new Ta,tT=Ts.STENCIL<<1,iT=function(){function e(t){i(this,e),this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=DS.VERTICAL,this._fov=xn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new As(.2,.2,.2,1),this._viewport=new Ia(0,0,1,1),this._isProjDirty=!0,this._matView=new Ta,this._matViewInv=null,this._matProj=new Ta,this._matProjInv=new Ta,this._matViewProj=new Ta,this._matViewProjInv=new Ta,this._frustum=new lu,this._forward=new oa,this._position=new oa,this._view=null,this._visibility=G_,this._priority=0,this._aperture=LS.F16_0,this._apertureValue=void 0,this._shutter=FS.D125,this._shutterValue=0,this._iso=NS.ISO100,this._isoValue=0,this._ec=0,this._poolHandle=0,this._frustumHandle=0,this._device=t,this._apertureValue=YS[this._aperture],this._shutterValue=KS[this._shutter],this._isoValue=ZS[this._iso],this._aspect=this.screenScale=1}return r(e,[{key:"initialize",value:function(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1;var t=this._poolHandle=zf.alloc();zf.set(t,Df.WIDTH,1),zf.set(t,Df.HEIGHT,1),zf.set(t,Df.CLEAR_FLAG,Ts.NONE),zf.set(t,Df.CLEAR_DEPTH,1),zf.set(t,Df.NODE,this._node.handle),this._scene&&zf.set(t,Df.SCENE,this._scene.handle),this.updateExposure(),this._view=E.director.root.createView({camera:this,name:this._name,priority:this._priority,flows:e.flows}),E.director.root.attachCamera(this),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+zf.get(t,Df.WIDTH)+"x"+zf.get(t,Df.HEIGHT))}},{key:"destroy",value:function(){E.director.root.detachCamera(this),this._view&&(this._view.destroy(),this._view=null),this._name=null,this._poolHandle&&(zf.free(this._poolHandle),this._poolHandle=0,this._frustumHandle&&(Qf.free(this._frustumHandle),this._frustumHandle=0))}},{key:"attachToScene",value:function(e){this._scene=e,zf.set(this._poolHandle,Df.SCENE,e.handle),this._view&&this._view.enable(!0)}},{key:"detachFromScene",value:function(){this._scene=null,zf.set(this._poolHandle,Df.SCENE,0),this._view&&this._view.enable(!1)}},{key:"resize",value:function(e,t){var i=this._poolHandle;zf.set(i,Df.WIDTH,e),zf.set(i,Df.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0}},{key:"setFixedSize",value:function(e,t){var i=this._poolHandle;zf.set(i,Df.WIDTH,e),zf.set(i,Df.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this.isWindowSize=!1}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this._node){if((this._node.hasChangedFlags||e)&&(Ta.invert(this._matView,this._node.worldMatrix),zf.setMat4(this._poolHandle,Df.MAT_VIEW,this._matView),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),zf.setVec3(this._poolHandle,Df.POSITION,this._position),zf.setVec3(this._poolHandle,Df.FORWARD,this._forward)),this._isProjDirty){var t=this._device.screenSpaceSignY;if(this._view&&(this._view.window.hasOffScreenAttachments||this._view.flows.some((function(e){return"GbufferFlow"===e.name})))&&(t*=this._device.UVSpaceSignY),this._proj===BS.PERSPECTIVE)Ta.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===DS.VERTICAL,this._device.clipSpaceMinZ,t);else{var i=this._orthoHeight*this._aspect,n=this._orthoHeight;Ta.ortho(this._matProj,-i,i,-n,n,this._nearClip,this._farClip,this._device.clipSpaceMinZ,t)}Ta.invert(this._matProjInv,this._matProj),zf.setMat4(this._poolHandle,Df.MAT_PROJ,this._matProj),zf.setMat4(this._poolHandle,Df.MAT_PROJ_INV,this._matProjInv)}(this._node.hasChangedFlags||this._isProjDirty||e)&&(Ta.multiply(this._matViewProj,this._matProj,this._matView),Ta.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),zf.setMat4(this._poolHandle,Df.MAT_VIEW_PROJ,this._matViewProj),zf.setMat4(this._poolHandle,Df.MAT_VIEW_PROJ_INV,this._matViewProjInv),this.recordFrustumInSharedMemory()),this._isProjDirty=!1}}},{key:"getSplitFrustum",value:function(e,t,i){if(this._node){if(t=Math.max(t,this._nearClip),i=Math.min(i,this._farClip),Ta.invert(this._matView,this._node.worldMatrix),zf.setMat4(this._poolHandle,Df.MAT_VIEW,this._matView),this._proj===BS.PERSPECTIVE)Ta.perspective($S,this._fov,this._aspect,t,i,this._fovAxis===DS.VERTICAL,this._device.clipSpaceMinZ,this._device.screenSpaceSignY);else{var n=this._orthoHeight*this._aspect,r=this._orthoHeight;Ta.ortho($S,-n,n,-r,r,t,i,this._device.clipSpaceMinZ,this._device.screenSpaceSignY)}Ta.multiply(eT,$S,this._matView),Ta.invert($S,eT),e.update(eT,$S)}}},{key:"changeTargetWindow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=e||E.director.root.mainWindow;t&&this._view&&(this._view.window=t,this.resize(t.width,t.height))}},{key:"screenPointToRay",value:function(e,t,i){var n=this._poolHandle,r=zf.get(n,Df.WIDTH),a=zf.get(n,Df.HEIGHT),o=this._viewport.x*r,s=this._viewport.y*a,l=this._viewport.width*r,c=this._viewport.height*a;return oa.set(QS,(t-o)/l*2-1,(i-s)/c*2-1,1),QS.y*=this._device.screenSpaceSignY,oa.transformMat4(QS,QS,this._matViewProjInv),this._proj===BS.PERSPECTIVE?this._node&&this._node.getWorldPosition(JS):(oa.set(JS,(t-o)/l*2-1,(i-s)/c*2-1,-1),JS.y*=this._device.screenSpaceSignY,oa.transformMat4(JS,JS,this._matViewProjInv)),ko.fromPoints(e,JS,QS)}},{key:"screenToWorld",value:function(e,t){var i=this._poolHandle,n=zf.get(i,Df.WIDTH),r=zf.get(i,Df.HEIGHT),a=this._viewport.x*n,o=this._viewport.y*r,s=this._viewport.width*n,l=this._viewport.height*r;return this._proj===BS.PERSPECTIVE?(oa.set(e,(t.x-a)/s*2-1,(t.y-o)/l*2-1,1),oa.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(QS),oa.lerp(e,QS,e,yn(this._nearClip/this._farClip,1,t.z))):(oa.set(e,(t.x-a)/s*2-1,(t.y-o)/l*2-1,2*t.z-1),oa.transformMat4(e,e,this.matViewProjInv)),e}},{key:"worldToScreen",value:function(e,t){var i=this._poolHandle,n=zf.get(i,Df.WIDTH),r=zf.get(i,Df.HEIGHT),a=this._viewport.x*n,o=this._viewport.y*r,s=this._viewport.width*n,l=this._viewport.height*r;return oa.transformMat4(e,t,this.matViewProj),e.x=a+.5*(e.x+1)*s,e.y=o+.5*(e.y+1)*l,e.z=.5*e.z+.5,e}},{key:"worldMatrixToScreen",value:function(e,t,i,n){Ta.multiply(e,this._matViewProj,t);var r=i/2,a=n/2;return Ta.identity($S),Ta.transform($S,$S,oa.set(QS,r,a,0)),Ta.scale($S,$S,oa.set(QS,r,a,1)),Ta.multiply(e,$S,e),e}},{key:"updateExposure",value:function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);zf.set(this._poolHandle,Df.EXPOSURE,.833333/Math.pow(2,e))}},{key:"recordFrustumInSharedMemory",value:function(){var e=this._frustumHandle,t=this._frustum;if(t&&0!==e){for(var i=t.vertices,n=qf.VERTICES,r=0;r<8;++r)Qf.setVec3(e,n,i[r]),n+=3;for(var a=t.planes,o=qf.PLANES,s=0;s<6;s++,o+=4)Qf.setVec4(e,o,a[s])}}},{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"enabled",set:function(e){this._enabled=e,this._view&&this._view.enable(e)},get:function(){return this._enabled}},{key:"view",get:function(){return this._view}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"fovAxis",set:function(e){this._fovAxis=e,this._isProjDirty=!0},get:function(){return this._fovAxis}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w,zf.setVec4(this._poolHandle,Df.CLEAR_COLOR,e)},get:function(){return this._clearColor}},{key:"viewport",get:function(){return this._viewport},set:function(e){var t=this._device.screenSpaceSignY;this._viewport.x=e.x,this._viewport.y=t>0?e.y:1-e.y-e.height,this._viewport.width=e.width,this._viewport.height=e.height,zf.setVec4(this._poolHandle,Df.VIEW_PORT,this._viewport),this.resize(this.width,this.height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return zf.get(this._poolHandle,Df.WIDTH)}},{key:"height",get:function(){return zf.get(this._poolHandle,Df.HEIGHT)}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",set:function(e){this._matView=e,zf.setMat4(this._poolHandle,Df.MAT_VIEW,this._matView)},get:function(){return this._matView}},{key:"matViewInv",set:function(e){this._matViewInv=e},get:function(){return this._matViewInv||this._node.worldMatrix}},{key:"matProj",set:function(e){this._matProj=e,zf.setMat4(this._poolHandle,Df.MAT_PROJ,this._matProj)},get:function(){return this._matProj}},{key:"matProjInv",set:function(e){this._matProjInv=e,zf.setMat4(this._poolHandle,Df.MAT_PROJ_INV,this._matProjInv)},get:function(){return this._matProjInv}},{key:"matViewProj",set:function(e){this._matViewProj=e,zf.setMat4(this._poolHandle,Df.MAT_VIEW_PROJ,this._matViewProj)},get:function(){return this._matViewProj}},{key:"matViewProjInv",set:function(e){this._matViewProjInv=e,zf.setMat4(this._poolHandle,Df.MAT_VIEW_PROJ_INV,this._matViewProjInv)},get:function(){return this._matViewProjInv}},{key:"frustum",set:function(e){this._frustum=e,this.recordFrustumInSharedMemory()},get:function(){return this._frustum}},{key:"forward",set:function(e){this._forward=e,zf.setVec3(this._poolHandle,Df.FORWARD,this._forward)},get:function(){return this._forward}},{key:"position",set:function(e){this._position=e,zf.setVec3(this._poolHandle,Df.POSITION,this._position)},get:function(){return this._position}},{key:"visibility",set:function(e){this._visibility=e,this._view&&(this._view.visibility=e)},get:function(){return this._visibility}},{key:"priority",get:function(){return this._view?this._view.priority:-1},set:function(e){this._priority=e,this._view&&(this._view.priority=this._priority)}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=YS[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=KS[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=ZS[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return zf.get(this._poolHandle,Df.EXPOSURE)}},{key:"flows",set:function(e){this._view&&this._view.setExecuteFlows(e)}},{key:"clearFlag",get:function(){return zf.get(this._poolHandle,Df.CLEAR_FLAG)},set:function(e){zf.set(this._poolHandle,Df.CLEAR_FLAG,e)}},{key:"clearDepth",get:function(){return zf.get(this._poolHandle,Df.CLEAR_DEPTH)},set:function(e){zf.set(this._poolHandle,Df.CLEAR_DEPTH,e)}},{key:"clearStencil",get:function(){return zf.get(this._poolHandle,Df.CLEAR_STENCIL)},set:function(e){zf.set(this._poolHandle,Df.CLEAR_STENCIL,e)}},{key:"handle",get:function(){return this._poolHandle}}]),e}(),nT=et({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),rT=function(){function e(){i(this,e),this._type=nT.LINEAR,this._fogColor=new Ma("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._handle=0,this._handle=op.alloc()}return r(e,[{key:"enabled",set:function(e){op.set(this._handle,tp.ENABLE,e?1:0),op.set(this._handle,tp.TYPE,e?this._type+1:0),e?this.activate():this._updatePipeline()},get:function(){return op.get(this._handle,tp.ENABLE)}},{key:"fogColor",set:function(e){this._fogColor.set(e),Ma.toArray(this._colorArray,this._fogColor),op.setVec4(this._handle,tp.COLOR,this._fogColor)},get:function(){return this._fogColor}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this.enabled&&this._updatePipeline(),op.set(this._handle,tp.TYPE,this.enabled?this._type+1:0)}},{key:"fogDensity",get:function(){return op.get(this._handle,tp.DENSITY)},set:function(e){op.set(this._handle,tp.DENSITY,e)}},{key:"fogStart",get:function(){return op.get(this._handle,tp.START)},set:function(e){op.set(this._handle,tp.START,e)}},{key:"fogEnd",get:function(){return op.get(this._handle,tp.END)},set:function(e){op.set(this._handle,tp.END,e)}},{key:"fogAtten",get:function(){return op.get(this._handle,tp.ATTEN)},set:function(e){op.set(this._handle,tp.ATTEN,e)}},{key:"fogTop",get:function(){return op.get(this._handle,tp.TOP)},set:function(e){op.set(this._handle,tp.TOP,e)}},{key:"fogRange",get:function(){return op.get(this._handle,tp.RANGE)},set:function(e){op.set(this._handle,tp.RANGE,e)}},{key:"currType",get:function(){return op.get(this._handle,tp.TYPE)}},{key:"colorArray",get:function(){return this._colorArray}},{key:"handle",get:function(){return this._handle}}]),r(e,[{key:"activate",value:function(){Ma.toArray(this._colorArray,this._fogColor),op.setVec4(this._handle,tp.COLOR,this._fogColor),op.set(this._handle,tp.TYPE,this.enabled?this._type+1:0),this._updatePipeline()}},{key:"_updatePipeline",value:function(){var e=E.director.root,t=this.currType,i=e.pipeline;i.macros.CC_USE_FOG!==t&&(i.macros.CC_USE_FOG=t,e.onGlobalPipelineStateChanged())}},{key:"destroy",value:function(){this._handle&&(op.free(this._handle),this._handle=0)}}]),e}();E.Fog=rT;var aT,oT=function(){function e(){i(this,e),this._skyColor=new Ma(51,128,204,1),this._groundAlbedo=new Ma(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._handle=0,this._handle=ep.alloc()}return r(e,[{key:"colorArray",get:function(){return this._colorArray}},{key:"albedoArray",get:function(){return this._albedoArray}},{key:"enabled",set:function(e){ep.set(this._handle,Kf.ENABLE,e?1:0),this.activate()},get:function(){return ep.get(this._handle,Kf.ENABLE)}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor=e,Ma.toArray(this._colorArray,this._skyColor),ep.setVec4(this._handle,Kf.SKY_COLOR,this._skyColor)}},{key:"skyIllum",get:function(){return ep.get(this._handle,Kf.ILLUM)},set:function(e){ep.set(this._handle,Kf.ILLUM,e)}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo=e,oa.toArray(this._albedoArray,this._groundAlbedo),ep.setVec4(this._handle,Kf.GROUND_ALBEDO,this._groundAlbedo)}},{key:"handle",get:function(){return this._handle}}]),r(e,[{key:"activate",value:function(){Ma.toArray(this._colorArray,this._skyColor),oa.toArray(this._albedoArray,this._groundAlbedo),ep.setVec4(this._handle,Kf.SKY_COLOR,this._skyColor),ep.setVec4(this._handle,Kf.GROUND_ALBEDO,this._groundAlbedo)}},{key:"destroy",value:function(){this._handle&&(ep.free(this._handle),this._handle=0)}}]),e}();function sT(e,t){if(!t){var i=E.director.getScene();if(!i)return null;t=i}return t.getChildByPath(e)}oT.SUN_ILLUM=65e3,oT.SKY_ILLUM=2e4,E.Ambient=oT,E.find=sT,function(e){e[e.positions=Vo.ATTR_POSITION]="positions",e[e.normals=Vo.ATTR_NORMAL]="normals",e[e.uvs=Vo.ATTR_TEX_COORD]="uvs",e[e.colors=Vo.ATTR_COLOR]="colors"}(aT||(aT={}));var lT=[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_NORMAL,jo.RGB32F),new al(Vo.ATTR_TEX_COORD,jo.RG32F),new al(Vo.ATTR_TANGENT,jo.RGBA32F),new al(Vo.ATTR_COLOR,jo.RGBA32F)],cT=new oa;function uT(e,t,i){i=i||{};var n,r=[],a=0,o=[],s=0,l=e.positions.slice();if(l.length>0){if(n=null,e.attributes)for(var c,u=y(e.attributes);!(c=u()).done;){var h=c.value;if(h.name===Vo.ATTR_POSITION){n=h;break}}n||(n=lT[0]),r.push(n);var _=Ds[n.format];s=Math.max(s,Math.floor(l.length/_.count)),o.push({offset:a,data:l,attribute:n}),a+=_.size}if(e.normals&&e.normals.length>0){if(n=null,e.attributes)for(var d,f=y(e.attributes);!(d=f()).done;){var p=d.value;if(p.name===Vo.ATTR_NORMAL){n=p;break}}n||(n=lT[1]);var m=Ds[n.format];r.push(n),s=Math.max(s,Math.floor(e.normals.length/m.count)),o.push({offset:a,data:e.normals,attribute:n}),a+=m.size}if(e.uvs&&e.uvs.length>0){if(n=null,e.attributes)for(var v,g=y(e.attributes);!(v=g()).done;){var x=v.value;if(x.name===Vo.ATTR_TEX_COORD){n=x;break}}n||(n=lT[2]);var S=Ds[n.format];r.push(n),s=Math.max(s,Math.floor(e.uvs.length/S.count)),o.push({offset:a,data:e.uvs,attribute:n}),a+=S.size}if(e.tangents&&e.tangents.length>0){if(n=null,e.attributes)for(var T,E=y(e.attributes);!(T=E()).done;){var b=T.value;if(b.name===Vo.ATTR_TANGENT){n=b;break}}n||(n=lT[3]);var A=Ds[n.format];r.push(n),s=Math.max(s,Math.floor(e.tangents.length/A.count)),o.push({offset:a,data:e.tangents,attribute:n}),a+=A.size}if(e.colors&&e.colors.length>0){if(n=null,e.attributes)for(var C,w=y(e.attributes);!(C=w()).done;){var R=C.value;if(R.name===Vo.ATTR_COLOR){n=R;break}}n||(n=lT[4]);var I=Ds[n.format];r.push(n),s=Math.max(s,Math.floor(e.colors.length/I.count)),o.push({offset:a,data:e.colors,attribute:n}),a+=I.size}if(e.customAttributes)for(var O,M=y(e.customAttributes);!(O=M()).done;){var P=O.value,k=Ds[P.attr.format];r.push(P.attr),s=Math.max(s,Math.floor(P.values.length/k.count)),o.push({offset:a,data:P.values,attribute:P.attr}),a+=k.size}for(var D=new Vu,B=new ArrayBuffer(s*a),L=new DataView(B),N=0,F=o;N<F.length;N++){var z=F[N];Uu(L,z.data,z.attribute.format,z.offset,a)}D.setNextAlignment(0);var U={attributes:r,view:{offset:D.getLength(),length:B.byteLength,count:s,stride:a}};D.addBuffer(B);var G=null,H=0;if(e.indices){var V=e.indices;H=V.length,G=new ArrayBuffer(2*H),Uu(new DataView(G),V,jo.R16UI)}var W={primitiveMode:e.primitiveMode||Zo.TRIANGLE_LIST,vertexBundelIndices:[0]};G&&(D.setNextAlignment(2),W.indexView={offset:D.getLength(),length:G.byteLength,count:H,stride:2},D.addBuffer(G));var j=e.minPos;if(!j&&i.calculateBounds){j=oa.set(new oa,1/0,1/0,1/0);for(var q=0;q<s;++q)oa.set(cT,l[3*q+0],l[3*q+1],l[3*q+2]),oa.min(j,j,cT)}var X=e.maxPos;if(!X&&i.calculateBounds){X=oa.set(new oa,-1/0,-1/0,-1/0);for(var Y=0;Y<s;++Y)oa.set(cT,l[3*Y+0],l[3*Y+1],l[3*Y+2]),oa.max(X,X,cT)}var K={vertexBundles:[U],primitives:[W]};return j&&(K.minPosition=new oa(j.x,j.y,j.z)),X&&(K.maxPosition=new oa(X.x,X.y,X.z)),t||(t=new $_),t.reset({struct:K,data:new Uint8Array(D.getCombined())}),t}var hT=Object.freeze({__proto__:null,find:sT,toPPM:function(e,t,i){return"P3 ".concat(t," ").concat(i," 255\n").concat(e.filter((function(e,t){return t%4<3})).toString(),"\n")},readMesh:function(e){for(var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),a=e.struct,o=a.primitives[i],s=y(o.vertexBundelIndices);!(t=s()).done;)for(var l,c=t.value,u=a.vertexBundles[c],h=u.view.offset,_=u.view,d=_.length,f=_.stride,p=y(u.attributes);!(l=p()).done;){var m=l.value,v=aT[m.name];v&&(n[v]=(n[v]||[]).concat(Gu(r,m.format,h,d,f))),h+=Ds[m.format].size}var g=o.indexView;return n.indices=Gu(r,jo["R".concat(8*g.stride,"UI")],g.offset,g.length),n},createMesh:uT,readBuffer:Gu,writeBuffer:Uu,mapBuffer:Hu});function _T(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}function dT(e){var t=(e=e||{}).widthSegments||1,i=e.heightSegments||1,n=e.lengthSegments||1,r=(e.width||1)/2,a=(e.height||1)/2,o=(e.length||1)/2,s=[oa.set(gT,-r,-a,o),oa.set(yT,r,-a,o),oa.set(xT,r,a,o),oa.set(ST,-r,a,o),oa.set(TT,r,-a,-o),oa.set(ET,-r,-a,-o),oa.set(bT,-r,a,-o),oa.set(AT,r,a,-o)],l=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],c=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],u=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],h=[],_=[],d=[],f=[],p=[],m=new oa(-r,-a,-o),v=new oa(r,a,o),g=Math.sqrt(r*r+a*a+o*o);function y(e,t,i){var n,r,a,o,m=h.length/3,v=l[e],g=c[e],y=u[e];for(o=0;o<=i;o++)for(a=0;a<=t;a++)if(n=a/t,r=o/i,oa.lerp(fT,s[v[0]],s[v[1]],n),oa.lerp(pT,s[v[0]],s[v[2]],r),oa.subtract(mT,pT,s[v[0]]),oa.add(vT,fT,mT),h.push(vT.x,vT.y,vT.z),_.push(g[0],g[1],g[2]),d.push(n,r),f.push(y[0],y[1],y[2],y[3]),a<t&&o<i){var x=t+1,S=a+o*x,T=a+(o+1)*x,E=a+1+(o+1)*x,b=a+1+o*x;p.push(m+S,m+b,m+T),p.push(m+T,m+b,m+E)}}return y(0,t,i),y(4,n,i),y(1,t,i),y(5,n,i),y(3,t,n),y(2,t,n),{positions:h,normals:_,uvs:d,tangents:f,indices:p,minPos:m,maxPos:v,boundingRadius:g}}e("utils",hT);var fT=new oa,pT=new oa,mT=new oa,vT=new oa,gT=new oa,yT=new oa,xT=new oa,ST=new oa,TT=new oa,ET=new oa,bT=new oa,AT=new oa,CT=new oa(0,0,0),wT=new oa(0,0,0);function RT(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=.5*i,a=n.radialSegments||32,o=n.heightSegments||1,s=void 0===n.capped||n.capped,l=n.arc||2*Math.PI,c=0;s||(e>0&&c++,t>0&&c++);var u=(a+1)*(o+1);s&&(u+=(a+1)*c+a*c);var h=a*o*2*3;s&&(h+=a*c*3);var _=new Array(h),d=new Array(3*u),f=new Array(3*u),p=new Array(2*u),m=Math.max(e,t),v=new oa(-m,-r,-m),g=new oa(m,r,m),y=Math.sqrt(m*m+r*r),x=0,S=0;return T(),s&&(t>0&&E(!1),e>0&&E(!0)),{positions:d,normals:f,uvs:p,indices:_,minPos:v,maxPos:g,boundingRadius:y};function T(){for(var n=[],s=e-t,c=s*s/i*Math.sign(s),u=0;u<=o;u++){for(var h=[],m=u/o,v=m*s+t,g=0;g<=a;++g){var y=g/a,T=y*l,E=Math.sin(T),b=Math.cos(T);d[3*x]=v*E,d[3*x+1]=m*i-r,d[3*x+2]=v*b,oa.normalize(CT,oa.set(wT,E,-c,b)),f[3*x]=CT.x,f[3*x+1]=CT.y,f[3*x+2]=CT.z,p[2*x]=2*(1-y)%1,p[2*x+1]=m,h.push(x),++x}n.push(h)}for(var A=0;A<o;++A)for(var C=0;C<a;++C){var w=n[A][C],R=n[A+1][C],I=n[A+1][C+1],O=n[A][C+1];_[S]=w,++S,_[S]=O,++S,_[S]=R,++S,_[S]=O,++S,_[S]=I,++S,_[S]=R,++S}}function E(i){for(var n=i?e:t,o=i?1:-1,s=x,c=1;c<=a;++c)d[3*x]=0,d[3*x+1]=r*o,d[3*x+2]=0,f[3*x]=0,f[3*x+1]=o,f[3*x+2]=0,p[2*x]=.5,p[2*x+1]=.5,++x;for(var u=x,h=0;h<=a;++h){var m=h/a*l,v=Math.cos(m),g=Math.sin(m);d[3*x]=n*g,d[3*x+1]=r*o,d[3*x+2]=n*v,f[3*x]=0,f[3*x+1]=o,f[3*x+2]=0,p[2*x]=.5-.5*g*o,p[2*x+1]=.5+.5*v,++x}for(var y=0;y<a;++y){var T=s+y,E=u+y;i?(_[S]=E+1,++S,_[S]=T,++S,_[S]=E,++S):(_[S]=T,++S,_[S]=E+1,++S,_[S]=E,++S)}}}var IT=new oa(0,0,0),OT=new oa(0,0,0),MT=new oa(0,0,0),PT=new oa(0,0,0),kT=new oa(0,0,0),DT=new oa(0,0,0),BT=new oa(0,0,0);var LT=new oa(0,0,0),NT=new oa(0,0,0);var FT=Object.freeze({__proto__:null,box:dT,cone:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return RT(0,e,t,i)},cylinder:RT,plane:function(e){var t=function(e){return(e=_T(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),i=t.width,n=t.length,r=t.widthSegments,a=t.lengthSegments,o=.5*i,s=.5*n,l=[],c=[],u=[],h=new oa(-o,0,-s),_=new oa(o,0,s),d=Math.sqrt(i*i+n*n);oa.set(kT,-o,0,s),oa.set(DT,o,0,s),oa.set(BT,-o,0,-s);for(var f=0;f<=a;f++)for(var p=0;p<=r;p++){var m=p/r,v=f/a;if(oa.lerp(IT,kT,DT,m),oa.lerp(OT,kT,BT,v),oa.subtract(MT,OT,kT),oa.add(PT,IT,MT),l.push(PT.x,PT.y,PT.z),t.includeUV&&c.push(m,v),p<r&&f<a){var g=r+1,y=p+f*g,x=p+(f+1)*g,S=p+1+(f+1)*g,T=p+1+f*g;u.push(y,T,x),u.push(T,S,x)}}var E={positions:l,indices:u,minPos:h,maxPos:_,boundingRadius:d};if(t.includeNormal){var b=(a+1)*(r+1),A=new Array(3*b);E.normals=A;for(var C=0;C<b;++C)A[3*C+0]=0,A[3*C+1]=1,A[3*C+2]=0}return t.includeUV&&(E.uvs=c),E},quad:function(e){var t=_T(e),i={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(i.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(i.uvs=[0,0,0,1,1,1,1,0]),i},sphere:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0!==t.segments?t.segments:32,n=[],r=[],a=[],o=[],s=new oa(-e,-e,-e),l=new oa(e,e,e),c=e,u=0;u<=i;++u)for(var h=u*Math.PI/i,_=Math.sin(h),d=-Math.cos(h),f=0;f<=i;++f){var p=2*f*Math.PI/i-Math.PI/2,m=Math.sin(p),v=Math.cos(p),g=m*_,y=d,x=v*_,S=f/i,T=u/i;if(n.push(g*e,y*e,x*e),r.push(g,y,x),a.push(S,T),u<i&&f<i){var E=i+1,b=E*u+f,A=E*(u+1)+f,C=E*(u+1)+f+1,w=E*u+f+1;o.push(b,w,A),o.push(w,C,A)}}return{positions:n,indices:o,normals:r,uvs:a,minPos:s,maxPos:l,boundingRadius:c}},torus:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.4,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=i.radialSegments||32,r=i.tubularSegments||32,a=i.arc||2*Math.PI,o=[],s=[],l=[],c=[],u=new oa(-e-t,-t,-e-t),h=new oa(e+t,t,e+t),_=e+t,d=0;d<=n;d++)for(var f=0;f<=r;f++){var p=f/r,m=d/n,v=p*a,g=m*Math.PI*2,y=(e+t*Math.cos(g))*Math.sin(v),x=t*Math.sin(g),S=(e+t*Math.cos(g))*Math.cos(v),T=Math.sin(v)*Math.cos(g),E=Math.sin(g),b=Math.cos(v)*Math.cos(g);if(o.push(y,x,S),s.push(T,E,b),l.push(p,m),f<r&&d<n){var A=r+1,C=A*d+f,w=A*(d+1)+f,R=A*(d+1)+f+1,I=A*d+f+1;c.push(C,I,w),c.push(I,R,w)}}return{positions:o,normals:s,uvs:l,indices:c,minPos:u,maxPos:h,boundingRadius:_}},capsule:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=i-e-t,a=n.sides||32,o=n.heightSegments||32,s=t/i,l=r/i,c=e/i,u=Math.floor(o*s),h=Math.floor(o*c),_=Math.floor(o*l),d=r+t-i/2,f=t-i/2,p=t-i/2,m=n.arc||2*Math.PI,v=[],g=[],y=[],x=[],S=Math.max(e,t),T=new oa(-S,-i/2,-S),E=new oa(S,i/2,S),b=i/2,A=0,C=[];return R(),w(),I(),{positions:v,normals:g,uvs:y,indices:x,minPos:T,maxPos:E,boundingRadius:b};function w(){for(var i=(e-t)/r,n=0;n<=_;n++){for(var o=[],c=n/_,u=c*(e-t)+t,h=0;h<=a;++h){var d=h/a,p=c*l+s,S=d*m-m/4,T=Math.sin(S),E=Math.cos(S);v.push(u*T),v.push(c*r+f),v.push(u*E),oa.normalize(LT,oa.set(NT,T,-i,E)),g.push(LT.x),g.push(LT.y),g.push(LT.z),y.push(d,p),o.push(A),++A}C.push(o)}for(var b=0;b<_;++b)for(var w=0;w<a;++w){var R=C[b][w],I=C[b+1][w],O=C[b+1][w+1],M=C[b][w+1];x.push(R),x.push(M),x.push(I),x.push(M),x.push(O),x.push(I)}}function R(){for(var e=0;e<=u;++e)for(var i=e*Math.PI/u/2,n=Math.sin(i),r=-Math.cos(i),s=0;s<=a;++s){var l=2*s*Math.PI/a-Math.PI/2,c=Math.sin(l)*n,h=r,_=Math.cos(l)*n,d=s/a,f=e/o;if(v.push(c*t,h*t+p,_*t),g.push(c,h,_),y.push(d,f),e<u&&s<a){var m=a+1,S=m*e+s,T=m*(e+1)+s,E=m*(e+1)+s+1,b=m*e+s+1;x.push(S,b,T),x.push(b,E,T)}++A}}function I(){for(var t=0;t<=h;++t)for(var i=t*Math.PI/h/2+Math.PI/2,n=Math.sin(i),r=-Math.cos(i),s=0;s<=a;++s){var l=2*s*Math.PI/a-Math.PI/2,u=Math.sin(l)*n,f=r,p=Math.cos(l)*n,m=s/a,S=t/o+(1-c);if(v.push(u*e,f*e+d,p*e),g.push(u,f,p),y.push(m,S),t<h&&s<a){var T=a+1,E=T*t+s+C[_][a]+1,b=T*(t+1)+s+C[_][a]+1,A=T*(t+1)+s+1+C[_][a]+1,w=T*t+s+1+C[_][a]+1;x.push(E,w,b),x.push(w,A,b)}}}},circle:function(e){var t=function(e){return(e=_T(e)).segments=64,e}(e).segments,i=new Array(3*(t+1));i[0]=0,i[1]=0,i[2]=0;var n=new Array(1+2*t);n[0]=0;for(var r=2*Math.PI/t,a=0;a<t;++a){var o=r*a,s=Math.cos(o),l=Math.sin(o),c=3*(a+1);i[c+0]=s,i[c+1]=l,i[c+2]=0;var u=2*a;n[1+u]=a+1,n[1+(u+1)]=a+2}return t>0&&(n[n.length-1]=1),{positions:i,indices:n,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Zo.TRIANGLE_FAN}},translate:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),o=0;o<a;++o){var s=3*o,l=3*o+1,c=3*o+2;e.positions[s]=e.positions[s]+i,e.positions[l]=e.positions[l]+n,e.positions[c]=e.positions[c]+r}return e.minPos&&(e.minPos.x+=i,e.minPos.y+=n,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=i,e.maxPos.y+=n,e.maxPos.z+=r),e},scale:function(e,t){for(var i=t.x||0,n=t.y||0,r=t.z||0,a=Math.floor(e.positions.length/3),o=0;o<a;++o){var s=3*o,l=3*o+1,c=3*o+2;e.positions[s]*=i,e.positions[l]*=n,e.positions[c]*=r}return e.minPos&&(e.minPos.x*=i,e.minPos.y*=n,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=i,e.maxPos.y*=n,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(i,n),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Zo.TRIANGLE_LIST)return e;for(var i=[[0,1],[1,2],[2,0]],n=[],r={},a=0;a<t.length;a+=3)for(var o=0;o<3;++o){var s=t[a+i[o][0]],l=t[a+i[o][1]],c=s>l?l<<16|s:s<<16|l;void 0===r[c]&&(r[c]=0,n.push(s,l))}return e.indices=n,e.primitiveMode=Zo.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],i=[],n={},r=0;r<e.length;r+=3)for(var a=0;a<3;++a){var o=e[r+t[a][0]],s=e[r+t[a][1]],l=o>s?s<<16|o:o<<16|s;void 0===n[l]&&(n[l]=0,i.push(o,s))}return i},invWinding:function(e){for(var t=[],i=0;i<e.length;i+=3)t.push(e[i],e[i+2],e[i+1]);return t},toWavefrontOBJ:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Zo.TRIANGLE_LIST)return"";for(var i=e.positions,n=e.uvs,r=e.normals,a=e.indices,o=function(e){return"".concat(a[e]+1,"/").concat(a[e]+1,"/").concat(a[e]+1)},s="",l=0;l<i.length;l+=3)s+="v ".concat(i[l]*t," ").concat(i[l+1]*t," ").concat(i[l+2]*t,"\n");for(var c=0;c<n.length;c+=2)s+="vt ".concat(n[c]," ").concat(n[c+1],"\n");for(var u=0;u<r.length;u+=3)s+="vn ".concat(r[u]," ").concat(r[u+1]," ").concat(r[u+2],"\n");for(var h=0;h<a.length;h+=3)s+="f ".concat(o(h)," ").concat(o(h+1)," ").concat(o(h+2),"\n");return s},normals:function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=new Array(2*e.length),r=0;r<e.length/3;++r){var a=3*r,o=6*r;n[o+0]=e[a+0],n[o+1]=e[a+1],n[o+2]=e[a+2],n[o+3]=e[a+0]+t[a+0]*i,n[o+4]=e[a+1]+t[a+1]*i,n[o+5]=e[a+2]+t[a+2]*i}return n},applyDefaultGeometryOptions:_T});e("primitives",FT);var zT=null,UT=null,GT=function(){function e(){i(this,e),this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null,this._handle=0,this._handle=np.alloc()}return r(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return np.get(this._handle,$f.ENABLE)},set:function(e){e?this.activate():this._updatePipeline(),np.set(this._handle,$f.ENABLE,e?1:0)}},{key:"useIBL",get:function(){return np.get(this._handle,$f.USE_IBL)},set:function(e){np.set(this._handle,$f.USE_IBL,e?1:0),this._updatePipeline()}},{key:"isRGBE",get:function(){return np.get(this._handle,$f.IS_RGBE)},set:function(e){e&&(UT&&UT.recompileShaders({USE_RGBE_CUBEMAP:e}),this._model&&this._model.setSubModelMaterial(0,UT)),np.set(this._handle,$f.IS_RGBE,e?1:0),this._updatePipeline()}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e||this._default,this._envmap&&(E.director.root.pipeline.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}},{key:"handle",get:function(){return this._handle}}]),r(e,[{key:"activate",value:function(){var e=E.director.root.pipeline;if(this._globalDescriptorSet=e.descriptorSet,this._default=tf.get("default-cube-texture"),this._model||(this._model=new E.renderer.scene.Model),np.set(this._handle,$f.MODEL,this._model.handle),e.ambient.groundAlbedo[3]=this._envmap?this._envmap.mipmapLevel:this._default.mipmapLevel,UT)UT.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{var t=new sm;t.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),UT=new um({parent:t})}zT||(zT=uT(dT({width:2,height:2,length:2}))),this._model.initSubModel(0,zT.renderingSubMeshes[0],UT),this.envmap=this._envmap,this._updateGlobalBinding(),this._updatePipeline()}},{key:"_updatePipeline",value:function(){var e=this.enabled&&this.useIBL?this.isRGBE?2:1:0,t=E.director.root,i=t.pipeline;i.macros.CC_USE_IBL!==e&&(i.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())}},{key:"_updateGlobalBinding",value:function(){var e=this.envmap.getGFXTexture(),t=vh.getSampler(E.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(l_,t),this._globalDescriptorSet.bindTexture(l_,e)}},{key:"destroy",value:function(){this._handle&&(np.free(this._handle),this._handle=0)}}]),e}();E.Skybox=GT;var HT,VT,WT,jT,qT,XT,YT,KT,ZT=new oa,QT=new oa(0,0,-1),JT=new oa,$T=new pa,eE=new oa,tE=new oa,iE=new Ta,nE=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),rE=new zi((function(){return{model:null,depth:0}}),128),aE=new zi((function(){return{model:null,depth:0}}),128);function oE(e,t){var i=0;e.node&&(oa.subtract(ZT,e.node.worldPosition,t.position),i=oa.dot(ZT,t.forward));var n=rE.alloc();return n.model=e,n.depth=i,n}function sE(e,t){var i=0;e.node&&(oa.subtract(ZT,e.node.worldPosition,t.position),i=oa.dot(ZT,t.forward));var n=aE.alloc();return n.model=e,n.depth=i,n}function lE(e,t){var i=t.camera,n=i.scene,r=e.renderObjects;rE.freeArray(r),r.length=0;var a=e.shadowObjects;aE.freeArray(a),a.length=0;var o=n.mainLight,s=e.shadows,l=s.sphere;l.center.set(0,0,0),l.radius=.01,s.enabled&&s.dirty&&(Ma.toArray(nE,s.shadowColor,qh.SHADOW_COLOR_OFFSET),e.descriptorSet.getBuffer(qh.BINDING).update(nE)),o&&s.type===fS.Planar&&function(e,t){var i=e.shadows;if(t.node.hasChangedFlags||i.dirty){i.dirty=!1,t.node.getWorldRotation($T),oa.transformQuat(JT,QT,$T);var n=i.normal,r=i.distance+.001,a=1/oa.dot(n,JT),o=JT.x*a,s=JT.y*a,l=JT.z*a,c=n.x,u=n.y,h=n.z,_=i.matLight;_.m00=1-c*o,_.m01=-c*s,_.m02=-c*l,_.m03=0,_.m04=-u*o,_.m05=1-u*s,_.m06=-u*l,_.m07=0,_.m08=-h*o,_.m09=-h*s,_.m10=1-h*l,_.m11=0,_.m12=o*r,_.m13=s*r,_.m14=l*r,_.m15=1,Ta.toArray(nE,i.matLight,qh.MAT_LIGHT_PLANE_PROJ_OFFSET),e.descriptorSet.getBuffer(qh.BINDING).update(nE)}}(e,o),e.skybox.enabled&&e.skybox.model&&i.clearFlag&tT&&r.push(oE(e.skybox.model,i));for(var c=n.models,u=0;u<c.length;u++){var h=c[u];if(h.enabled)if(t.visibility&Ph.BitMask.UI_2D)(h.node&&t.visibility===h.node.layer||t.visibility===h.visFlags)&&r.push(oE(h,i));else if(h.node&&(t.visibility&h.node.layer)===h.node.layer||t.visibility&h.visFlags){if(h.castShadow&&(Uo.mergeAABB(l,l,h.worldBounds),a.push(sE(h,i))),h.worldBounds&&!Uc.aabb_frustum(h.worldBounds,i.frustum))continue;r.push(oE(h,i))}}}var cE,uE,hE,_E,dE,fE,pE,mE,vE,gE,yE,xE,SE,TE,EE=[],bE=e("UIStage",(HT=ii("UIStage"),VT=Li([Gx]),WT=wi(2),HT((KT=YT=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"renderQueues",XT,c(n)),n._renderQueues=[],n._renderArea=new Es,n}return o(t,e),r(t,[{key:"initialize",value:function(e){return _(s(t.prototype),"initialize",this).call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e,i){_(s(t.prototype),"activate",this).call(this,e,i);for(var n=0;n<this.renderQueues.length;n++){for(var r=0,a=0;a<this.renderQueues[n].stages.length;a++)r|=nf(this.renderQueues[n].stages[a]);var o=qx;switch(this.renderQueues[n].sortMode){case Bx.BACK_TO_FRONT:o=Xx;break;case Bx.FRONT_TO_BACK:o=qx}this._renderQueues[n]=new Yx({isTransparent:this.renderQueues[n].isTransparent,phases:r,sortFunc:o})}}},{key:"destroy",value:function(){}},{key:"render",value:function(e){var t=this._pipeline,i=t.isHDR;t.isHDR=!1;var n=t.device;this._renderQueues[0].clear();for(var r=t.renderObjects,a=0;a<r.length;a++)for(var o=r[a],s=o.model.subModels,l=0;l<s.length;l++)for(var c=s[l].passes,u=0;u<c.length;u++)this._renderQueues[0].insertRenderPass(o,l,u);this._renderQueues[0].sort();var h=e.camera,_=h.viewport;this._renderArea.x=_.x*h.width,this._renderArea.y=_.y*h.height,this._renderArea.width=_.width*h.width,this._renderArea.height=_.height*h.height,EE[0]=h.clearColor;var d=t.commandBuffers[0],f=e.window.framebuffer,p=f.colorTextures[0]?f.renderPass:t.getRenderPass(h.clearFlag);d.beginRenderPass(p,f,this._renderArea,EE,h.clearDepth,h.clearStencil),d.bindDescriptorSet(Gh.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,p,d),d.endRenderPass(),t.isHDR=i}}]),t}(Kg),YT.initInfo={name:"UIStage",priority:Hx.UI,tag:0,renderQueues:[{isTransparent:!0,stages:["default"],sortMode:Bx.BACK_TO_FRONT}]},XT=S((qT=KT).prototype,"renderQueues",[VT,si,WT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jT=qT))||jT)),AE=e("UIFlow",ii("UIFlow")((hE=uE=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"initialize",value:function(e){if(_(s(t.prototype),"initialize",this).call(this,e),0===this._stages.length){var i=new bE;i.initialize(bE.initInfo),this._stages.push(i)}return!0}},{key:"destroy",value:function(){_(s(t.prototype),"destroy",this).call(this)}},{key:"render",value:function(e){this._pipeline.updateUBOs(e),_(s(t.prototype),"render",this).call(this,e)}}]),t}(ry),uE.initInfo={name:"UIFlow",priority:Vx.UI,tag:kx.UI,stages:[]},cE=hE))||cE),CE=new Ta,wE=new Ta,RE=new ua,IE=e("ForwardPipeline",(_E=ii("ForwardPipeline"),dE=Li([Lx]),fE=wi(2),pE=Li([Nx]),mE=wi(3),_E((yE=S((gE=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"renderTextures",yE,c(n)),x(n,"materials",xE,c(n)),n.fog=new rT,n.ambient=new oT,n.skybox=new GT,n.shadows=new mS,n.renderObjects=[],n.shadowObjects=[],n._isHDR=!1,n._shadingScale=1,n._fpScale=1/1024,n._renderPasses=new Map,n._globalUBO=new Float32Array(jh.COUNT),n._shadowUBO=new Float32Array(qh.COUNT),n}return o(t,e),r(t,[{key:"initialize",value:function(e){if(_(s(t.prototype),"initialize",this).call(this,e),0===this._flows.length){var i=new XS;i.initialize(XS.initInfo),this._flows.push(i);var n=new VS;n.initialize(VS.initInfo),this._flows.push(n);var r=new AE;r.initialize(AE.initInfo),this._flows.push(r),r.activate(this)}return!0}},{key:"activate",value:function(){return this._macros={},!!_(s(t.prototype),"activate",this).call(this)&&(!!this._activeRenderer()||(console.error("ForwardPipeline startup failed!"),!1))}},{key:"render",value:function(e){for(var t=0;t<e.length;t++){var i=e[t];lE(this,i);for(var n=0;n<i.flows.length;n++)i.flows[n].render(i)}this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);if(t)return t;var i=this.device,n=new vl,r=new gl;n.format=i.colorFormat,r.format=i.depthStencilFormat,e&Ts.COLOR||(e&tT?n.loadOp=fs.DISCARD:(n.loadOp=fs.LOAD,n.beginLayout=ms.PRESENT_SRC)),(e&Ts.DEPTH_STENCIL)!==Ts.DEPTH_STENCIL&&(e&Ts.DEPTH||(r.depthLoadOp=fs.LOAD),e&Ts.STENCIL||(r.stencilLoadOp=fs.LOAD),r.beginLayout=ms.DEPTH_STENCIL_ATTACHMENT_OPTIMAL);var a=new yl([n],r);return t=i.createRenderPass(a),this._renderPasses.set(e,t),t}},{key:"updateUBOs",value:function(e){this._updateUBO(e);var t=e.camera.scene.mainLight,i=this.device,n=this.shadows;if(t&&n.type===fS.ShadowMap){var r=function(e,t,i){var n=e.shadows;oa.negate(eE,i);var r=Math.sqrt(2)*n.sphere.radius;return oa.multiplyScalar(tE,eE,r),oa.add(tE,tE,n.sphere.center),Ta.fromRT(iE,t,tE),iE}(this,t.node.worldRotation,t.direction);Ta.invert(CE,r);var a=0,o=0;n.orthoSize>n.sphere.radius?(a=n.orthoSize*n.aspect,o=n.orthoSize):(a=n.sphere.radius*n.aspect,o=n.sphere.radius);var s=i.screenSpaceSignY*i.UVSpaceSignY;Ta.ortho(wE,-a,a,-o,o,n.near,n.far,i.clipSpaceMinZ,s),Ta.multiply(wE,wE,CE),Ta.toArray(this._shadowUBO,wE,qh.MAT_LIGHT_VIEW_PROJ_OFFSET),RE.set(n.pcf),ua.toArray(this._shadowUBO,RE,qh.SHADOW_PCF_OFFSET),RE.set(n.size.x,n.size.y),ua.toArray(this._shadowUBO,RE,qh.SHADOW_SIZE_OFFSET)}this._commandBuffers[0].updateBuffer(this._descriptorSet.getBuffer(jh.BINDING),this._globalUBO),this._commandBuffers[0].updateBuffer(this._descriptorSet.getBuffer(qh.BINDING),this._shadowUBO)}},{key:"_activeRenderer",value:function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=e.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,jh.SIZE,jh.SIZE));this._descriptorSet.bindBuffer(jh.BINDING,t);var i=e.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,qh.SIZE,qh.SIZE));this._descriptorSet.bindBuffer(qh.BINDING,i);var n=rh([as.LINEAR,as.LINEAR,as.NONE,os.CLAMP,os.CLAMP,os.CLAMP]),r=vh.getSampler(e,n);return this._descriptorSet.bindSampler(Xh,r),this.macros.CC_USE_HDR=this._isHDR,this.macros.CC_SUPPORT_FLOAT_TEXTURE=this.device.hasFeature(Gs.TEXTURE_FLOAT),!0}},{key:"_updateUBO",value:function(e){this._descriptorSet.update();var t=E.director.root,i=e.camera,n=i.scene.mainLight,r=this.ambient,a=this.fog,o=this._globalUBO,s=this.device,l=Math.floor(s.width),c=Math.floor(s.height);o[jh.TIME_OFFSET]=t.cumulativeTime,o[jh.TIME_OFFSET+1]=t.frameTime,o[jh.TIME_OFFSET+2]=E.director.getTotalFrames(),o[jh.SCREEN_SIZE_OFFSET]=s.width,o[jh.SCREEN_SIZE_OFFSET+1]=s.height,o[jh.SCREEN_SIZE_OFFSET+2]=1/o[jh.SCREEN_SIZE_OFFSET],o[jh.SCREEN_SIZE_OFFSET+3]=1/o[jh.SCREEN_SIZE_OFFSET+1],o[jh.SCREEN_SCALE_OFFSET]=i.width/l*this.shadingScale,o[jh.SCREEN_SCALE_OFFSET+1]=i.height/c*this.shadingScale,o[jh.SCREEN_SCALE_OFFSET+2]=1/o[jh.SCREEN_SCALE_OFFSET],o[jh.SCREEN_SCALE_OFFSET+3]=1/o[jh.SCREEN_SCALE_OFFSET+1],o[jh.NATIVE_SIZE_OFFSET]=l,o[jh.NATIVE_SIZE_OFFSET+1]=c,o[jh.NATIVE_SIZE_OFFSET+2]=1/o[jh.NATIVE_SIZE_OFFSET],o[jh.NATIVE_SIZE_OFFSET+3]=1/o[jh.NATIVE_SIZE_OFFSET+1],Ta.toArray(o,i.matView,jh.MAT_VIEW_OFFSET),Ta.toArray(o,i.node.worldMatrix,jh.MAT_VIEW_INV_OFFSET),Ta.toArray(o,i.matProj,jh.MAT_PROJ_OFFSET),Ta.toArray(o,i.matProjInv,jh.MAT_PROJ_INV_OFFSET),Ta.toArray(o,i.matViewProj,jh.MAT_VIEW_PROJ_OFFSET),Ta.toArray(o,i.matViewProjInv,jh.MAT_VIEW_PROJ_INV_OFFSET),oa.toArray(o,i.position,jh.CAMERA_POS_OFFSET);var u=s.screenSpaceSignY;e.window.hasOffScreenAttachments&&(u*=s.UVSpaceSignY),o[jh.CAMERA_POS_OFFSET+3]=u;var h=i.exposure;if(o[jh.EXPOSURE_OFFSET]=h,o[jh.EXPOSURE_OFFSET+1]=1/h,o[jh.EXPOSURE_OFFSET+2]=this._isHDR?1:0,o[jh.EXPOSURE_OFFSET+3]=this._fpScale/h,n){if(oa.toArray(o,n.direction,jh.MAIN_LIT_DIR_OFFSET),oa.toArray(o,n.color,jh.MAIN_LIT_COLOR_OFFSET),n.useColorTemperature){var _=n.colorTemperatureRGB;o[jh.MAIN_LIT_COLOR_OFFSET]*=_.x,o[jh.MAIN_LIT_COLOR_OFFSET+1]*=_.y,o[jh.MAIN_LIT_COLOR_OFFSET+2]*=_.z}this._isHDR?o[jh.MAIN_LIT_COLOR_OFFSET+3]=n.illuminance*this._fpScale:o[jh.MAIN_LIT_COLOR_OFFSET+3]=n.illuminance*h}else oa.toArray(o,oa.UNIT_Z,jh.MAIN_LIT_DIR_OFFSET),ua.toArray(o,ua.ZERO,jh.MAIN_LIT_COLOR_OFFSET);var d=r.colorArray;this._isHDR?d[3]=r.skyIllum*this._fpScale:d[3]=r.skyIllum*h,o.set(d,jh.AMBIENT_SKY_OFFSET),o.set(r.albedoArray,jh.AMBIENT_GROUND_OFFSET),a.enabled&&(o.set(a.colorArray,jh.GLOBAL_FOG_COLOR_OFFSET),o[jh.GLOBAL_FOG_BASE_OFFSET]=a.fogStart,o[jh.GLOBAL_FOG_BASE_OFFSET+1]=a.fogEnd,o[jh.GLOBAL_FOG_BASE_OFFSET+2]=a.fogDensity,o[jh.GLOBAL_FOG_ADD_OFFSET]=a.fogTop,o[jh.GLOBAL_FOG_ADD_OFFSET+1]=a.fogRange,o[jh.GLOBAL_FOG_ADD_OFFSET+2]=a.fogAtten)}},{key:"destroyUBOs",value:function(){this._descriptorSet&&(this._descriptorSet.getBuffer(jh.BINDING).destroy(),this._descriptorSet.getBuffer(qh.BINDING).destroy())}},{key:"destroy",value:function(){this.destroyUBOs();for(var e=this._renderPasses.values(),i=e.next();!i.done;)i.value.destroy(),i=e.next();return this._commandBuffers.length=0,this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),_(s(t.prototype),"destroy",this).call(this)}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR!==e&&(this._isHDR=e,this._globalUBO[jh.EXPOSURE_OFFSET+2]=this._isHDR?1:0)}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"fpScale",get:function(){return this._fpScale}},{key:"shadowUBO",get:function(){return this._shadowUBO}}]),t}(Dx)).prototype,"renderTextures",[dE,si,fE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xE=S(gE.prototype,"materials",[pE,si,mE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vE=gE))||vE));!function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT",e[e.UI=20]="UI"}(SE||(SE={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.GBUFFER=1]="GBUFFER",e[e.LIGHTING=5]="LIGHTING",e[e.UI=10]="UI"}(TE||(TE={}));var OE,ME,PE,kE,DE,BE,LE,NE,FE,zE,UE,GE,HE,VE,WE,jE,qE,XE,YE,KE,ZE,QE,JE,$E,eb,tb,ib,nb,rb,ab,ob,sb,lb,cb,ub=new $c,hb=function(){function e(t){i(this,e),this._pendingModels=[],this._record=new Map,this._pipeline=t}return r(e,[{key:"createShadowData",value:function(e){for(var t=[],i=this._pipeline.shadows,n=e.isInstancingEnabled?i.instancingMaterial:i.material,r=e.isInstancingEnabled?iS.get(n.passes[0]):null,a=e.subModels,o=0;o<a.length;o++){var s=wf.get(a[o].handle,Tf.SHADER_0);t.push(pf.get(s))}return{model:e,shaders:t,instancedBuffer:r}}},{key:"updateShadowList",value:function(e){this._pendingModels.length=0;var t=this._pipeline.shadows;if(t.enabled&&t.type===fS.Planar){var i=e.camera,n=i.scene,r=i.frustum,a=0!=(i.visibility&Ph.BitMask.DEFAULT);if(n.mainLight&&a)for(var o=n.models,s=0;s<o.length;s++){var l=o[s];if(l.enabled&&l.node&&l.castShadow&&(!l.worldBounds||($c.transform(ub,l.worldBounds,t.matLight),Uc.aabb_frustum(ub,r)))){var c=this.createShadowData(l);this._pendingModels.push(c)}}}}},{key:"recordCommandBuffer",value:function(e,t,i){var n=this._pipeline.shadows;if(n.enabled&&n.type===fS.Planar){var r=this._pendingModels,a=r.length;if(a){var o=iS.get(n.instancingMaterial.passes[0]);o&&o.clear();var s=n.material.passes[0].handle,l=mf.get(bf.get(s,hf.DESCRIPTOR_SET));i.bindDescriptorSet(Gh.MATERIAL,l);for(var c=0;c<a;c++)for(var u=r[c],h=u.model,_=u.shaders,d=u.instancedBuffer,f=0;f<_.length;f++){var p=h.subModels[f],m=_[f];if(d)d.merge(p,h.instancedAttributes,0);else{var v=p.inputAssembler,g=jx.getOrCreatePipelineState(e,s,m,t,v);i.bindPipelineState(g),i.bindDescriptorSet(Gh.LOCAL,p.descriptorSet),i.bindInputAssembler(v),i.draw(v)}}if(o&&o.hasPendingModels){o.uploadBuffers(),l=mf.get(bf.get(o.hPass,hf.DESCRIPTOR_SET)),i.bindDescriptorSet(Gh.MATERIAL,l);for(var y=null,x=0;x<o.instances.length;++x){var S=o.instances[x];if(S.count){var T=pf.get(S.hShader),E=jx.getOrCreatePipelineState(e,o.hPass,T,t,S.ia);y!==E&&(i.bindPipelineState(E),i.bindDescriptorSet(Gh.LOCAL,mf.get(S.hDescriptorSet)),y=E),i.bindInputAssembler(S.ia),i.draw(S.ia)}}}}}}}]),e}(),_b=[new As(0,0,0,0),new As(0,0,0,0),new As(0,0,0,0),new As(0,0,0,0)],db=e("GbufferStage",(OE=ii("GbufferStage"),ME=Li([Gx]),PE=wi(2),OE((NE=LE=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"renderQueues",BE,c(e)),e._renderQueues=[],e._gbufferFrameBuffer=null,e._renderArea=new Es,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=nf("deferred-gbuffer"),e._batchedQueue=new Qx,e._instancedQueue=new Jx,e}return o(t,e),r(t,[{key:"setGbufferFrameBuffer",value:function(e){this._gbufferFrameBuffer=e}}]),r(t,[{key:"initialize",value:function(e){return _(s(t.prototype),"initialize",this).call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e,i){_(s(t.prototype),"activate",this).call(this,e,i);for(var n=0;n<this.renderQueues.length;n++){for(var r=0,a=0;a<this.renderQueues[n].stages.length;a++)r|=nf(this.renderQueues[n].stages[a]);var o=qx;switch(this.renderQueues[n].sortMode){case Bx.BACK_TO_FRONT:o=Xx;break;case Bx.FRONT_TO_BACK:o=qx}this._renderQueues[n]=new Yx({isTransparent:this.renderQueues[n].isTransparent,phases:r,sortFunc:o})}this._planarQueue=new hb(this._pipeline)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(this.renderQueueClearFunc);for(var n=t.renderObjects,r=0,a=0,o=0,s=0;s<n.length;++s){var l=n[s],c=l.model.subModels;for(r=0;r<c.length;++r){var u=c[r],h=u.passes;for(a=0;a<h.length;++a){var _=h[a];if(_.phase===this._phaseID){var d=_.batchingScheme;if(d===xp.INSTANCING){var f=iS.get(_);f.merge(u,l.model.instancedAttributes,a),this._instancedQueue.queue.add(f)}else if(d===xp.VB_MERGING){var p=nS.get(_);p.merge(u,a,l),this._batchedQueue.queue.add(p)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(l,r,a)}}}}var m=t.commandBuffers[0];this._renderQueues.forEach(this.renderQueueSortFunc),this._planarQueue.updateShadowList(e);var v=e.camera,g=v.viewport;this._renderArea.x=g.x*v.width,this._renderArea.y=g.y*v.height,this._renderArea.width=g.width*v.width*t.shadingScale,this._renderArea.height=g.height*v.height*t.shadingScale;var y=this._gbufferFrameBuffer,x=y.renderPass;m.beginRenderPass(x,y,this._renderArea,_b,v.clearDepth,v.clearStencil),m.bindDescriptorSet(Gh.GLOBAL,t.descriptorSet);for(var S=0;S<this.renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(i,x,m);this._instancedQueue.recordCommandBuffer(i,x,m),this._batchedQueue.recordCommandBuffer(i,x,m),this._planarQueue.recordCommandBuffer(i,x,m),m.endRenderPass()}},{key:"renderQueueClearFunc",value:function(e){e.clear()}},{key:"renderQueueSortFunc",value:function(e){e.sort()}}]),t}(Kg),LE.initInfo={name:"GbufferStage",priority:SE.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:Bx.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Bx.BACK_TO_FRONT,stages:["default","planarShadow"]}]},BE=S((DE=NE).prototype,"renderQueues",[ME,si,PE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kE=DE))||kE)),fb=e("GbufferFlow",ii("GbufferFlow")((UE=zE=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gbufferRenderPass=null,n._gbufferRenderTargets=[],n._gbufferFrameBuffer=null,n._depth=null,n._width=0,n._height=0,n}return o(t,e),r(t,[{key:"initialize",value:function(e){if(_(s(t.prototype),"initialize",this).call(this,e),0===this._stages.length){var i=new db;i.initialize(db.initInfo),this._stages.push(i)}return!0}},{key:"activate",value:function(e){_(s(t.prototype),"activate",this).call(this,e);var i=e.device;if(this._width=i.width,this._height=i.height,!this._gbufferRenderPass){var n=new vl;n.format=jo.RGBA32F,n.loadOp=fs.CLEAR,n.storeOp=ps.STORE,n.sampleCount=1,n.beginLayout=ms.UNDEFINED,n.endLayout=ms.COLOR_ATTACHMENT_OPTIMAL;var r=new vl;r.format=jo.RGBA32F,r.loadOp=fs.CLEAR,r.storeOp=ps.STORE,r.sampleCount=1,r.beginLayout=ms.UNDEFINED,r.endLayout=ms.COLOR_ATTACHMENT_OPTIMAL;var a=new vl;a.format=jo.RGBA32F,a.loadOp=fs.CLEAR,a.storeOp=ps.STORE,a.sampleCount=1,a.beginLayout=ms.UNDEFINED,a.endLayout=ms.COLOR_ATTACHMENT_OPTIMAL;var o=new vl;o.format=jo.RGBA32F,o.loadOp=fs.CLEAR,o.storeOp=ps.STORE,o.sampleCount=1,o.beginLayout=ms.UNDEFINED,o.endLayout=ms.COLOR_ATTACHMENT_OPTIMAL;var l=new gl;l.format=i.depthStencilFormat,l.depthLoadOp=fs.CLEAR,l.depthStoreOp=ps.STORE,l.stencilLoadOp=fs.CLEAR,l.stencilStoreOp=ps.STORE,l.sampleCount=1,l.beginLayout=ms.UNDEFINED,l.endLayout=ms.DEPTH_STENCIL_ATTACHMENT_OPTIMAL;var c=new yl([n,r,a,o],l);this._gbufferRenderPass=i.createRenderPass(c)}this._gbufferRenderTargets.length<1&&(this._gbufferRenderTargets.push(i.createTexture(new Il(ss.TEX2D,ls.COLOR_ATTACHMENT|ls.SAMPLED,jo.RGBA32F,this._width,this._height))),this._gbufferRenderTargets.push(i.createTexture(new Il(ss.TEX2D,ls.COLOR_ATTACHMENT|ls.SAMPLED,jo.RGBA32F,this._width,this._height))),this._gbufferRenderTargets.push(i.createTexture(new Il(ss.TEX2D,ls.COLOR_ATTACHMENT|ls.SAMPLED,jo.RGBA32F,this._width,this._height))),this._gbufferRenderTargets.push(i.createTexture(new Il(ss.TEX2D,ls.COLOR_ATTACHMENT|ls.SAMPLED,jo.RGBA32F,this._width,this._height)))),this._depth||(this._depth=i.createTexture(new Il(ss.TEX2D,ls.DEPTH_STENCIL_ATTACHMENT,i.depthStencilFormat,this._width,this._height))),this._gbufferFrameBuffer||(this._gbufferFrameBuffer=i.createFramebuffer(new el(this._gbufferRenderPass,this._gbufferRenderTargets,this._depth)));for(var u=0;u<this._stages.length;++u)this._stages[u].setGbufferFrameBuffer(this._gbufferFrameBuffer)}},{key:"render",value:function(e){var i=this._pipeline;i.updateUBOs(e),_(s(t.prototype),"render",this).call(this,e),i.descriptorSet.bindTexture(Zh,this._gbufferFrameBuffer.colorTextures[0]),i.descriptorSet.bindTexture($h,this._gbufferFrameBuffer.colorTextures[1]),i.descriptorSet.bindTexture(i_,this._gbufferFrameBuffer.colorTextures[2]),i.descriptorSet.bindTexture(a_,this._gbufferFrameBuffer.colorTextures[3])}}]),t}(ry),zE.initInfo={name:"GbufferFlow",priority:TE.GBUFFER,stages:[]},FE=UE))||FE),pb=[new As(0,0,0,1)],mb=e("LightingStage",(GE=ii("LightingStage"),HE=Li([Gx]),VE=wi(2),WE=Li(sm),jE=wi(3),GE((QE=ZE=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"renderQueues",YE,c(e)),e._renderQueues=[],e._renderArea=new Es,x(e,"_deferredMaterial",KE,c(e)),e}return o(t,e),r(t,[{key:"material",set:function(e){this._deferredMaterial!==e&&(this._deferredMaterial=e)}}]),r(t,[{key:"initialize",value:function(e){return _(s(t.prototype),"initialize",this).call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0}},{key:"activate",value:function(e,i){_(s(t.prototype),"activate",this).call(this,e,i);for(var n=0;n<this.renderQueues.length;n++){for(var r=0,a=0;a<this.renderQueues[n].stages.length;a++)r|=nf(this.renderQueues[n].stages[a]);var o=qx;switch(this.renderQueues[n].sortMode){case Bx.BACK_TO_FRONT:o=Xx;break;case Bx.FRONT_TO_BACK:o=qx}this._renderQueues[n]=new Yx({isTransparent:this.renderQueues[n].isTransparent,phases:r,sortFunc:o})}this._planarQueue=new hb(this._pipeline)}},{key:"destroy",value:function(){}},{key:"render",value:function(e){var t=this._pipeline,i=t.device,n=t.commandBuffers[0],r=e.camera,a=r.viewport;if(this._renderArea.x=a.x*r.width,this._renderArea.y=a.y*r.height,this._renderArea.width=a.width*r.width*t.shadingScale,this._renderArea.height=a.height*r.height*t.shadingScale,r.clearFlag&Ts.COLOR)if(t.isHDR){Kx(pb[0],r.clearColor);var o=t.fpScale/r.exposure;pb[0].x*=o,pb[0].y*=o,pb[0].z*=o}else pb[0].x=r.clearColor.x,pb[0].y=r.clearColor.y,pb[0].z=r.clearColor.z;pb[0].w=r.clearColor.w;var s=e.window.framebuffer,l=s.colorTextures[0]?s.renderPass:t.getRenderPass(r.clearFlag);n.beginRenderPass(l,s,this._renderArea,pb,r.clearDepth,r.clearStencil),n.bindDescriptorSet(Gh.GLOBAL,t.descriptorSet);var c=this._deferredMaterial.passes[1].handle,u=pf.get(this._deferredMaterial.passes[1].getShaderVariant()),h=t.quadIA,_=null;null!=c&&null!=u&&null!=h&&(_=jx.getOrCreatePipelineState(i,c,u,l,h)),null!=_&&(n.bindPipelineState(_),n.bindInputAssembler(h),n.draw(h)),n.endRenderPass()}},{key:"renderQueueClearFunc",value:function(e){e.clear()}},{key:"renderQueueSortFunc",value:function(e){e.sort()}}]),t}(Kg),ZE.initInfo={name:"LightingStage",priority:SE.LIGHTING,tag:0,renderQueues:[{isTransparent:!1,sortMode:Bx.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Bx.BACK_TO_FRONT,stages:["default","planarShadow"]}]},YE=S((XE=QE).prototype,"renderQueues",[HE,si,VE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KE=S(XE.prototype,"_deferredMaterial",[WE,si,jE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qE=XE))||qE)),vb=e("LightingFlow",ii("LightingFlow")((eb=$E=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"initialize",value:function(e){if(_(s(t.prototype),"initialize",this).call(this,e),0===this._stages.length){var i=new mb;i.initialize(mb.initInfo),this._stages.push(i)}return!0}},{key:"activate",value:function(e){_(s(t.prototype),"activate",this).call(this,e)}},{key:"render",value:function(e){this._pipeline.updateUBOs(e),_(s(t.prototype),"render",this).call(this,e)}},{key:"destroy",value:function(){_(s(t.prototype),"destroy",this).call(this)}}]),t}(ry),$E.initInfo={name:"LightingFlow",priority:TE.LIGHTING,stages:[]},JE=eb))||JE),gb=new oa,yb=new oa(0,0,-1),xb=new oa,Sb=new pa,Tb=new oa,Eb=new oa,bb=new Ta,Ab=Float32Array.from([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,.3]),Cb=new zi((function(){return{model:null,depth:0}}),128),wb=new zi((function(){return{model:null,depth:0}}),128);function Rb(e,t){var i=0;e.node&&(oa.subtract(gb,e.node.worldPosition,t.position),i=oa.dot(gb,t.forward));var n=Cb.alloc();return n.model=e,n.depth=i,n}function Ib(e,t){var i=0;e.node&&(oa.subtract(gb,e.node.worldPosition,t.position),i=oa.dot(gb,t.forward));var n=wb.alloc();return n.model=e,n.depth=i,n}function Ob(e,t){var i=t.camera,n=i.scene,r=e.renderObjects;Cb.freeArray(r),r.length=0;var a=e.shadowObjects;wb.freeArray(a),a.length=0;var o=n.mainLight,s=e.shadows,l=s.sphere;l.center.set(0,0,0),l.radius=.01,s.enabled&&s.dirty&&(Ma.toArray(Ab,s.shadowColor,qh.SHADOW_COLOR_OFFSET),e.descriptorSet.getBuffer(qh.BINDING).update(Ab)),o&&s.type===fS.Planar&&function(e,t){var i=e.shadows;if(t.node.hasChangedFlags||i.dirty){i.dirty=!1,t.node.getWorldRotation(Sb),oa.transformQuat(xb,yb,Sb);var n=i.normal,r=i.distance+.001,a=1/oa.dot(n,xb),o=xb.x*a,s=xb.y*a,l=xb.z*a,c=n.x,u=n.y,h=n.z,_=i.matLight;_.m00=1-c*o,_.m01=-c*s,_.m02=-c*l,_.m03=0,_.m04=-u*o,_.m05=1-u*s,_.m06=-u*l,_.m07=0,_.m08=-h*o,_.m09=-h*s,_.m10=1-h*l,_.m11=0,_.m12=o*r,_.m13=s*r,_.m14=l*r,_.m15=1,Ta.toArray(Ab,i.matLight,qh.MAT_LIGHT_PLANE_PROJ_OFFSET),e.descriptorSet.getBuffer(qh.BINDING).update(Ab)}}(e,o),e.skybox.enabled&&e.skybox.model&&i.clearFlag&tT&&r.push(Rb(e.skybox.model,i));for(var c=n.models,u=0;u<c.length;u++){var h=c[u];if(h.enabled)if(t.visibility&Ph.BitMask.UI_2D)(h.node&&t.visibility===h.node.layer||t.visibility===h.visFlags)&&r.push(Rb(h,i));else if(h.node&&(t.visibility&h.node.layer)===h.node.layer||t.visibility&h.visFlags){if(h.castShadow&&(Uo.mergeAABB(l,l,h.worldBounds),a.push(Ib(h,i))),h.worldBounds&&!Uc.aabb_frustum(h.worldBounds,i.frustum))continue;r.push(Rb(h,i))}}}var Mb,Pb=new Ta,kb=new Ta,Db=new ua,Bb=(e("DeferredPipeline",(tb=ii("DeferredPipeline"),ib=Li([Lx]),nb=wi(2),rb=Li([Nx]),ab=wi(3),tb((lb=S((sb=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"renderTextures",lb,c(n)),x(n,"materials",cb,c(n)),n.fog=new rT,n.ambient=new oT,n.skybox=new GT,n.shadows=new mS,n.renderObjects=[],n.shadowObjects=[],n._isHDR=!1,n._shadingScale=1,n._fpScale=1/1024,n._renderPasses=new Map,n._globalUBO=new Float32Array(jh.COUNT),n._shadowUBO=new Float32Array(qh.COUNT),n._quadVB=null,n._quadIB=null,n._quadIA=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){if(_(s(t.prototype),"initialize",this).call(this,e),0===this._flows.length){var i=new XS;i.initialize(XS.initInfo),this._flows.push(i);var n=new fb;n.initialize(fb.initInfo),this._flows.push(n);var r=new vb;r.initialize(vb.initInfo),this._flows.push(r);var a=new AE;a.initialize(AE.initInfo),this._flows.push(a),a.activate(this)}return!0}},{key:"activate",value:function(){return this._macros={},!!_(s(t.prototype),"activate",this).call(this)&&(!!this._activeRenderer()||(console.error("DeferredPipeline startup failed!"),!1))}},{key:"render",value:function(e){for(var t=0;t<e.length;t++){var i=e[t];Ob(this,i);for(var n=0;n<i.flows.length;n++)i.flows[n].render(i)}this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},{key:"getRenderPass",value:function(e){var t=this._renderPasses.get(e);if(t)return t;var i=this.device,n=new vl,r=new gl;n.format=i.colorFormat,r.format=i.depthStencilFormat,e&Ts.COLOR||(e&tT?n.loadOp=fs.DISCARD:(n.loadOp=fs.LOAD,n.beginLayout=ms.PRESENT_SRC)),(e&Ts.DEPTH_STENCIL)!==Ts.DEPTH_STENCIL&&(e&Ts.DEPTH||(r.depthLoadOp=fs.LOAD),e&Ts.STENCIL||(r.stencilLoadOp=fs.LOAD),r.beginLayout=ms.DEPTH_STENCIL_ATTACHMENT_OPTIMAL);var a=new yl([n],r);return t=i.createRenderPass(a),this._renderPasses.set(e,t),t}},{key:"updateUBOs",value:function(e){this._updateUBO(e);var t=e.camera.scene.mainLight,i=this.device,n=this.shadows;if(t&&n.type===fS.ShadowMap){var r=function(e,t,i){var n=e.shadows;oa.negate(Tb,i);var r=Math.sqrt(2)*n.sphere.radius;return oa.multiplyScalar(Eb,Tb,r),oa.add(Eb,Eb,n.sphere.center),Ta.fromRT(bb,t,Eb),bb}(this,t.node.worldRotation,t.direction);Ta.invert(Pb,r);var a=0,o=0;n.orthoSize>n.sphere.radius?(a=n.orthoSize*n.aspect,o=n.orthoSize):(a=n.sphere.radius*n.aspect,o=n.sphere.radius);var s=i.screenSpaceSignY*i.UVSpaceSignY;Ta.ortho(kb,-a,a,-o,o,n.near,n.far,i.clipSpaceMinZ,s),Ta.multiply(kb,kb,Pb),Ta.toArray(this._shadowUBO,kb,qh.MAT_LIGHT_VIEW_PROJ_OFFSET),Db.set(n.pcf),ua.toArray(this._shadowUBO,Db,qh.SHADOW_PCF_OFFSET),Db.set(n.size.x,n.size.y),ua.toArray(this._shadowUBO,Db,qh.SHADOW_SIZE_OFFSET)}this._commandBuffers[0].updateBuffer(this._descriptorSet.getBuffer(jh.BINDING),this._globalUBO),this._commandBuffers[0].updateBuffer(this._descriptorSet.getBuffer(qh.BINDING),this._shadowUBO)}},{key:"_activeRenderer",value:function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=e.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,jh.SIZE,jh.SIZE));this._descriptorSet.bindBuffer(jh.BINDING,t);var i=e.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,qh.SIZE,qh.SIZE));this._descriptorSet.bindBuffer(qh.BINDING,i);var n=rh([as.LINEAR,as.LINEAR,as.NONE,os.CLAMP,os.CLAMP,os.CLAMP]),r=vh.getSampler(e,n);return this._descriptorSet.bindSampler(Xh,r),this._descriptorSet.bindSampler(Zh,r),this._descriptorSet.bindSampler($h,r),this._descriptorSet.bindSampler(i_,r),this._descriptorSet.bindSampler(a_,r),this.macros.CC_USE_HDR=this._isHDR,this.macros.CC_SUPPORT_FLOAT_TEXTURE=this.device.hasFeature(Gs.TEXTURE_FLOAT),!!this.createQuadInputAssembler()}},{key:"_updateUBO",value:function(e){this._descriptorSet.update();var t=E.director.root,i=e.camera,n=i.scene.mainLight,r=this.ambient,a=this.fog,o=this._globalUBO,s=this.device,l=Math.floor(s.width),c=Math.floor(s.height);o[jh.TIME_OFFSET]=t.cumulativeTime,o[jh.TIME_OFFSET+1]=t.frameTime,o[jh.TIME_OFFSET+2]=E.director.getTotalFrames(),o[jh.SCREEN_SIZE_OFFSET]=s.width,o[jh.SCREEN_SIZE_OFFSET+1]=s.height,o[jh.SCREEN_SIZE_OFFSET+2]=1/o[jh.SCREEN_SIZE_OFFSET],o[jh.SCREEN_SIZE_OFFSET+3]=1/o[jh.SCREEN_SIZE_OFFSET+1],o[jh.SCREEN_SCALE_OFFSET]=i.width/l*this.shadingScale,o[jh.SCREEN_SCALE_OFFSET+1]=i.height/c*this.shadingScale,o[jh.SCREEN_SCALE_OFFSET+2]=1/o[jh.SCREEN_SCALE_OFFSET],o[jh.SCREEN_SCALE_OFFSET+3]=1/o[jh.SCREEN_SCALE_OFFSET+1],o[jh.NATIVE_SIZE_OFFSET]=l,o[jh.NATIVE_SIZE_OFFSET+1]=c,o[jh.NATIVE_SIZE_OFFSET+2]=1/o[jh.NATIVE_SIZE_OFFSET],o[jh.NATIVE_SIZE_OFFSET+3]=1/o[jh.NATIVE_SIZE_OFFSET+1],Ta.toArray(o,i.matView,jh.MAT_VIEW_OFFSET),Ta.toArray(o,i.node.worldMatrix,jh.MAT_VIEW_INV_OFFSET),Ta.toArray(o,i.matProj,jh.MAT_PROJ_OFFSET),Ta.toArray(o,i.matProjInv,jh.MAT_PROJ_INV_OFFSET),Ta.toArray(o,i.matViewProj,jh.MAT_VIEW_PROJ_OFFSET),Ta.toArray(o,i.matViewProjInv,jh.MAT_VIEW_PROJ_INV_OFFSET),oa.toArray(o,i.position,jh.CAMERA_POS_OFFSET);var u=s.screenSpaceSignY;e.window.hasOffScreenAttachments&&(u*=s.UVSpaceSignY),o[jh.CAMERA_POS_OFFSET+3]=u;var h=i.exposure;if(o[jh.EXPOSURE_OFFSET]=h,o[jh.EXPOSURE_OFFSET+1]=1/h,o[jh.EXPOSURE_OFFSET+2]=this._isHDR?1:0,o[jh.EXPOSURE_OFFSET+3]=this._fpScale/h,n){if(oa.toArray(o,n.direction,jh.MAIN_LIT_DIR_OFFSET),oa.toArray(o,n.color,jh.MAIN_LIT_COLOR_OFFSET),n.useColorTemperature){var _=n.colorTemperatureRGB;o[jh.MAIN_LIT_COLOR_OFFSET]*=_.x,o[jh.MAIN_LIT_COLOR_OFFSET+1]*=_.y,o[jh.MAIN_LIT_COLOR_OFFSET+2]*=_.z}this._isHDR?o[jh.MAIN_LIT_COLOR_OFFSET+3]=n.illuminance*this._fpScale:o[jh.MAIN_LIT_COLOR_OFFSET+3]=n.illuminance*h}else oa.toArray(o,oa.UNIT_Z,jh.MAIN_LIT_DIR_OFFSET),ua.toArray(o,ua.ZERO,jh.MAIN_LIT_COLOR_OFFSET);var d=r.colorArray;this._isHDR?d[3]=r.skyIllum*this._fpScale:d[3]=r.skyIllum*h,o.set(d,jh.AMBIENT_SKY_OFFSET),o.set(r.albedoArray,jh.AMBIENT_GROUND_OFFSET),a.enabled&&(o.set(a.colorArray,jh.GLOBAL_FOG_COLOR_OFFSET),o[jh.GLOBAL_FOG_BASE_OFFSET]=a.fogStart,o[jh.GLOBAL_FOG_BASE_OFFSET+1]=a.fogEnd,o[jh.GLOBAL_FOG_BASE_OFFSET+2]=a.fogDensity,o[jh.GLOBAL_FOG_ADD_OFFSET]=a.fogTop,o[jh.GLOBAL_FOG_ADD_OFFSET+1]=a.fogRange,o[jh.GLOBAL_FOG_ADD_OFFSET+2]=a.fogAtten)}},{key:"destroyUBOs",value:function(){this._descriptorSet&&(this._descriptorSet.getBuffer(jh.BINDING).destroy(),this._descriptorSet.getBuffer(qh.BINDING).destroy())}},{key:"destroy",value:function(){this.destroyUBOs(),this.destroyQuadInputAssembler();for(var e=this._renderPasses.values(),i=e.next();!i.done;)i.value.destroy(),i=e.next();return this._commandBuffers.length=0,this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),_(s(t.prototype),"destroy",this).call(this)}},{key:"createQuadInputAssembler",value:function(){var e=4*Float32Array.BYTES_PER_ELEMENT,t=4*e;if(this._quadVB=this._device.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,t,e)),!this._quadVB)return!1;var i=new Float32Array(16),n=0;i[n++]=-1,i[n++]=-1,i[n++]=0,i[n++]=0,i[n++]=1,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=-1,i[n++]=1,i[n++]=0,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,i[n++]=1,this._quadVB.update(i);var r=Uint8Array.BYTES_PER_ELEMENT,a=6*r;if(this._quadIB=this._device.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,a,r)),!this._quadIB)return!1;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,this._quadIB.update(o);var s=new Array(2);return s[0]=new al("a_position",jo.RG32F),s[1]=new al("a_texCoord",jo.RG32F),this._quadIA=this._device.createInputAssembler(new ol(s,[this._quadVB],this._quadIB)),!0}},{key:"destroyQuadInputAssembler",value:function(){this._quadVB&&(this._quadVB.destroy(),this._quadVB=null),this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadIA&&(this._quadIA.destroy(),this._quadIA=null)}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR!==e&&(this._isHDR=e,this._globalUBO[jh.EXPOSURE_OFFSET+2]=this._isHDR?1:0)}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"fpScale",get:function(){return this._fpScale}},{key:"quadIA",get:function(){return this._quadIA}},{key:"shadowUBO",get:function(){return this._shadowUBO}}]),t}(Dx)).prototype,"renderTextures",[ib,si,nb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cb=S(sb.prototype,"materials",[rb,si,ab],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ob=sb))||ob)),e("pipeline",W_),new Ta),Lb=new zi((function(){return new Yg}),32);!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.UI_BATCH=3]="UI_BATCH",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Mb||(Mb={}));var Nb=rh([as.LINEAR,as.LINEAR,as.NONE,os.CLAMP,os.CLAMP,os.CLAMP]),Fb=rh([as.LINEAR,as.LINEAR,as.LINEAR,os.CLAMP,os.CLAMP,os.CLAMP]),zb=function(){function e(){i(this,e),this.type=Mb.DEFAULT,this.scene=null,this.castShadow=!1,this.receiveShadow=!0,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,list:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._subModelArrayHandle=0,this._poolHandle=0,this._worldBoundsHandle=0,this._localData=new Float32Array(h_.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new ua,this._device=E.director.root.device}return r(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"handle",get:function(){return this._poolHandle}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,Of.set(this._poolHandle,Af.NODE,e.handle)}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e,Of.set(this._poolHandle,Af.TRANSFORM,e.handle)}},{key:"visFlags",get:function(){return Of.get(this._poolHandle,Af.VIS_FLAGS)},set:function(e){Of.set(this._poolHandle,Af.VIS_FLAGS,e)}},{key:"enabled",get:function(){return 1===Of.get(this._poolHandle,Af.ENABLED)},set:function(e){Of.set(this._poolHandle,Af.ENABLED,e?1:0)}}]),r(e,[{key:"initialize",value:function(){this._inited||(this._poolHandle=Of.alloc(),this._subModelArrayHandle=xf.alloc(),Of.set(this._poolHandle,Af.SUB_MODEL_ARRAY,this._subModelArrayHandle),Of.set(this._poolHandle,Af.VIS_FLAGS,Ph.Enum.NONE),Of.set(this._poolHandle,Af.ENABLED,1),this._inited=!0)}},{key:"destroy",value:function(){for(var e=this._subModels,t=0;t<e.length;t++){var i=this._subModels[t];i.destroy(),Lb.free(i)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this.isDynamicBatching=!1,this._poolHandle&&(Of.free(this._poolHandle),this._poolHandle=0,xf.free(this._subModelArrayHandle),this._subModelArrayHandle=0),this._worldBoundsHandle&&(kf.free(this._worldBoundsHandle),this._worldBoundsHandle=0)}},{key:"attachToScene",value:function(e){this.scene=e}},{key:"detachFromScene",value:function(){this.scene=null}},{key:"updateTransform",value:function(e){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._transformUpdated=!0;var i=this._worldBounds;this._modelBounds&&i&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,i),kf.setVec3(this._worldBoundsHandle,Rf.CENTER,i.center),kf.setVec3(this._worldBoundsHandle,Rf.HALF_EXTENSION,i.halfExtents))}}},{key:"updateUBOs",value:function(e){for(var t=this._subModels,i=0;i<t.length;i++)t[i].update();if(this._updateStamp=e,this._transformUpdated){this._transformUpdated=!1;var n=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var a=this.instancedAttributes.list;!function(e,t,i,n){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,i[0]=e.m04,i[1]=e.m05,i[2]=e.m06,i[3]=e.m13,n[0]=e.m08,n[1]=e.m09,n[2]=e.m10,n[3]=e.m14}(n,a[r].view,a[r+1].view,a[r+2].view)}else Ta.toArray(this._localData,n,h_.MAT_WORLD_OFFSET),Ta.inverseTranspose(Bb,n),Ta.toArray(this._localData,Bb,h_.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData)}}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._modelBounds=$c.fromPoints($c.create(),e,t),this._worldBounds=$c.clone(this._modelBounds),0===this._worldBoundsHandle&&(this._worldBoundsHandle=kf.alloc(),Of.set(this._poolHandle,Af.WORLD_BOUNDS,this._worldBoundsHandle)),kf.setVec3(this._worldBoundsHandle,Rf.CENTER,this._worldBounds.center),kf.setVec3(this._worldBoundsHandle,Rf.HALF_EXTENSION,this._worldBounds.halfExtents))}},{key:"initSubModel",value:function(e,t,i){this.initialize();var n=!1;null==this._subModels[e]?(this._subModels[e]=Lb.alloc(),n=!0):this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._updateAttributesAndBinding(e),n&&xf.assign(this._subModelArrayHandle,e,this._subModels[e].handle)}},{key:"setSubModelMesh",value:function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)}},{key:"setSubModelMaterial",value:function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()}},{key:"updateLightingmap",value:function(e,t){ua.toArray(this._localData,t,h_.LIGHTINGMAP_UVPARAM),this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=tf.get("empty-texture"));var i=e.getGFXTexture();if(null!==i)for(var n=vh.getSampler(this._device,e.mipmaps.length>1?Fb:Nb),r=this._subModels,a=0;a<r.length;a++){var o=r[a].descriptorSet;o.bindTexture(O_,i),o.bindSampler(O_,n),o.update()}}},{key:"getMacroPatches",value:function(e){}},{key:"_updateAttributesAndBinding",value:function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet);var i=pf.get(wf.get(t.handle,Tf.SHADER_0));this._updateInstancedAttributes(i.attributes,t.passes[0])}}},{key:"_getInstancedAttributeIndex",value:function(e){for(var t=this.instancedAttributes.list,i=0;i<t.length;i++)if(t[i].name===e)return i;return-1}},{key:"_updateInstancedAttributes",value:function(e,t){if(t.device.hasFeature(Gs.INSTANCED_ARRAYS)){for(var i=0,n=0;n<e.length;n++){var r=e[n];r.isInstanced&&(i+=Ds[r.format].size)}var a=this.instancedAttributes;a.buffer=new Uint8Array(i),a.list.length=0;for(var o=0,s=a.buffer.buffer,l=0;l<e.length;l++){var c=e[l];if(c.isInstanced){var u=c.format,h=Ds[u],_=new(zs(h))(s,o,h.count),d=c.isNormalized;o+=h.size,a.list.push({name:c.name,format:u,isNormalized:d,view:_})}}t.batchingScheme===xp.INSTANCING&&iS.get(t).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex("a_matWorld0"),this._transformUpdated=!0}}},{key:"_initLocalDescriptors",value:function(e){this._localBuffer||(this._localBuffer=this._device.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,h_.SIZE,h_.SIZE)))}},{key:"_updateLocalDescriptors",value:function(e,t){t.bindBuffer(h_.BINDING,this._localBuffer)}}]),e}(),Ub=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._morphRenderingInstance=null,n._usedMaterials=new Set,n}return o(t,e),r(t,[{key:"getMacroPatches",value:function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):void 0}},{key:"initSubModel",value:function(e,i,n){return _(s(t.prototype),"initSubModel",this).call(this,e,i,this._launderMaterial(n))}},{key:"setSubModelMaterial",value:function(e,i){return _(s(t.prototype),"setSubModelMaterial",this).call(this,e,this._launderMaterial(i))}},{key:"_updateLocalDescriptors",value:function(e,i){_(s(t.prototype),"_updateLocalDescriptors",this).call(this,e,i),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,i)}},{key:"_launderMaterial",value:function(e){return e}},{key:"setMorphRendering",value:function(e){this._morphRenderingInstance=e}}]),t}(zb),Gb=[],Hb=new Map,Vb=[{name:"CC_USE_SKINNING",value:!0}];function Wb(e,t){for(var i=0,n=Ta.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){n=e.world,e.stamp=t;break}e.stamp=t,Gb[i++]=e,e=e.parent}for(;i>0;){var r=(e=Gb[--i]).node;Ta.fromRTS(e.local,r.rotation,r.position,r.scale),n=Ta.multiply(e.world,n,e.local)}return n}function jb(e,t){for(var i,n=null,r=0;e!==t;){var a=e.uuid;if(Hb.has(a)){n=Hb.get(a);break}n={node:e,local:new Ta,world:new Ta,stamp:-1,parent:null},Hb.set(a,n),Gb[r++]=n,e=e.parent,n=null}for(;r>0;)(i=Gb[--r]).parent=n,n=i;return n}function qb(e){for(var t=Hb.get(e.uuid)||null;t;)Hb.delete(t.node.uuid),t=t.parent}function Xb(e,t,i,n){for(var r=0;r<i.length;r++){for(var a=i[r],o=-1,s=0;s<a.length;s++)if(a[s]===n){o=s;break}o>=0&&(t.push(r),e.push(o))}}var Yb=new oa,Kb=new oa,Zb=new oa,Qb=new oa,Jb=new Ta,$b=new $c,eA=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this))).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=Mb.SKINNING,e}return o(t,e),r(t,[{key:"destroy",value:function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}_(s(t.prototype),"destroy",this).call(this)}},{key:"bindSkeleton",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=0;n<this._joints.length;n++)qb(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&i){this.transform=t;var r=i.getBoneSpaceBounds(e),a=i.struct.jointMaps;this._ensureEnoughBuffers(a&&a.length||1),this._bufferIndices=i.jointBufferIndices;for(var o=0;o<e.joints.length;o++){var s=r[o],l=t.getChildByPath(e.joints[o]);if(s&&l){var c=jb(l,t),u=e.bindposes[o],h=[],_=[];a?Xb(h,_,a,o):(h.push(o),_.push(0)),this._joints.push({indices:h,buffers:_,bound:s,target:l,bindpose:u,transform:c})}}}}},{key:"updateTransform",value:function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdated=!0),oa.set(Yb,1/0,1/0,1/0),oa.set(Kb,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.bound,a=Wb(n.transform,e);$c.transform($b,r,a),$b.getBoundary(Zb,Qb),oa.min(Yb,Yb,Zb),oa.max(Kb,Kb,Qb)}this._modelBounds&&this._worldBounds&&($c.fromPoints(this._modelBounds,Yb,Kb),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds))}},{key:"updateUBOs",value:function(e){_(s(t.prototype),"updateUBOs",this).call(this,e);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.indices,a=n.buffers,o=n.transform,l=n.bindpose;Ta.multiply(Jb,o.world,l);for(var c=0;c<a.length;c++)_g(this._dataArray[a[c]],12*r[c],Jb)}for(var u=0;u<this._buffers.length;u++)this._buffers[u].update(this._dataArray[u]);return!0}},{key:"initSubModel",value:function(e,i,n){var r=i.vertexBuffers,a=i.iaInfo;a.vertexBuffers=i.jointMappedBuffers,_(s(t.prototype),"initSubModel",this).call(this,e,i,n),a.vertexBuffers=r}},{key:"getMacroPatches",value:function(e){var i=_(s(t.prototype),"getMacroPatches",this).call(this,e);return i?Vb.concat(i):Vb}},{key:"_updateLocalDescriptors",value:function(e,i){_(s(t.prototype),"_updateLocalDescriptors",this).call(this,e,i);var n=this._buffers[this._bufferIndices[e]];n&&i.bindBuffer(m_.BINDING,n)}},{key:"_ensureEnoughBuffers",value:function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,m_.SIZE,m_.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(m_.COUNT))}}]),t}(Ub),tA=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],iA=function(e){function t(){var e;i(this,t),(e=u(this,s(t).call(this))).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=Mb.BAKED_SKINNING,e._dataPoolManager=E.director.root.dataPoolManager;var n=new Float32Array(4),r=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:r,texture:null,boundsInfo:null},e}return o(t,e),r(t,[{key:"destroy",value:function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),_(s(t.prototype),"destroy",this).call(this)}},{key:"bindSkeleton",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(this._skeleton=e,this._mesh=i,e&&t&&i){this.transform=t;var n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new qs(qo.UNIFORM|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,f_.SIZE,f_.SIZE)))}}},{key:"updateTransform",value:function(e){if(_(s(t.prototype),"updateTransform",this).call(this,e),this.uploadedAnim){var i=this._jointsMedium,n=i.animInfo,r=i.boundsInfo[n.data[0]],a=this.transform;this._worldBounds&&r&&r.transform(a._mat,a._pos,a._rot,a._scale,this._worldBounds)}}},{key:"updateUBOs",value:function(e){_(s(t.prototype),"updateUBOs",this).call(this,e);var i=this._jointsMedium.animInfo,n=this._instAnimInfoIdx;n>=0?this.instancedAttributes.list[n].view[0]=i.data[0]:i.dirty&&(i.buffer.update(i.data),i.dirty=!1);return!0}},{key:"createBoundingShape",value:function(e,t){e&&t&&(this._worldBounds=new $c)}},{key:"uploadAnimation",value:function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,i=null;e?(i=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._modelBounds=null):(i=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._modelBounds=i&&i.bounds.get(this._mesh.hash)[0]),this._applyJointTexture(i)}}},{key:"_applyJointTexture",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var i=this._jointsMedium,n=i.buffer,r=i.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),n&&n.update(r);for(var a=e.handle.texture,o=0;o<this._subModels.length;++o){var s=this._subModels[o].descriptorSet;s.bindTexture(g_,a)}}}},{key:"getMacroPatches",value:function(e){var i=_(s(t.prototype),"getMacroPatches",this).call(this,e);return i?i.concat(tA):tA}},{key:"_updateLocalDescriptors",value:function(e,i){_(s(t.prototype),"_updateLocalDescriptors",this).call(this,e,i);var n=this._jointsMedium,r=n.buffer,a=n.texture,o=n.animInfo;if(i.bindBuffer(f_.BINDING,r),i.bindBuffer(p_.BINDING,o.buffer),a){var l=vh.getSampler(this._device,Lg);i.bindTexture(g_,a.handle.texture),i.bindSampler(g_,l)}}},{key:"_updateInstancedAttributes",value:function(e,i){_(s(t.prototype),"_updateInstancedAttributes",this).call(this,e,i),this._instAnimInfoIdx=this._getInstancedAttributeIndex("a_jointAnimInfo"),this.updateInstancedJointTextureInfo()}},{key:"updateInstancedJointTextureInfo",value:function(){var e=this._jointsMedium,t=e.jointTextureInfo,i=e.animInfo,n=this._instAnimInfoIdx;if(n>=0){var r=this.instancedAttributes.list[n].view;r[0]=i.data[0],r[1]=t[1],r[2]=t[2]}}}]),t}(Ub),nA=Object.freeze({__proto__:null,uploadJointData:_g,MINIMUM_JOINT_TEXTURE_SIZE:480,selectJointsMediumFormat:dg,jointTextureSamplerHash:Lg,JointTexturePool:jg,JointAnimationInfo:qg,getWorldMatrix:Wb,getTransform:jb,deleteTransform:qb,SkinningModel:eA,BakedSkinningModel:iA,MorphModel:Ub}),rA=function(){function e(t){i(this,e),this._root=void 0,this._name="",this._cameras=[],this._models=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._scenePoolHandle=0,this._modelArrayHandle=0,this._root=t,this._createHandles()}return r(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"rayResultCanvas",get:function(){return fA}},{key:"rayResultModels",get:function(){return hA}},{key:"rayResultAll",get:function(){return pA}},{key:"rayResultSingleModel",get:function(){return mA}},{key:"handle",get:function(){return this._scenePoolHandle}}],[{key:"registerCreateFunc",value:function(t){t._createSceneFun=function(t){return new e(t)}}}]),r(e,[{key:"initialize",value:function(e){return this._name=e.name,this._createHandles(),!0}},{key:"update",value:function(e){var t=this._mainLight;t&&t.update();for(var i=this._sphereLights,n=0;n<i.length;n++){i[n].update()}for(var r=this._spotLights,a=0;a<r.length;a++){r[a].update()}for(var o=this._models,s=0;s<o.length;s++){var l=o[s];l.enabled&&(l.updateTransform(e),l.updateUBOs(e))}}},{key:"destroy",value:function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._modelArrayHandle&&(Sf.free(this._modelArrayHandle),Lf.free(this._scenePoolHandle),this._modelArrayHandle=0,this._scenePoolHandle=0)}},{key:"addCamera",value:function(e){e.attachToScene(this),this._cameras.push(e)}},{key:"removeCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()}},{key:"removeCameras",value:function(){for(var e,t=y(this._cameras);!(e=t()).done;){e.value.detachFromScene()}this._cameras.splice(0)}},{key:"setMainLight",value:function(e){this._mainLight=e,Lf.set(this._scenePoolHandle,Mf.MAIN_LIGHT,e.handle)}},{key:"unsetMainLight",value:function(e){if(this._mainLight===e){var t=this._directionalLights;t.length?(this._mainLight=t[t.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=nv.ROTATION)):this._mainLight=null}}},{key:"addDirectionalLight",value:function(e){e.attachToScene(this),this._directionalLights.push(e)}},{key:"removeDirectionalLight",value:function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)}},{key:"addSphereLight",value:function(e){e.attachToScene(this),this._sphereLights.push(e)}},{key:"removeSphereLight",value:function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)}},{key:"addSpotLight",value:function(e){e.attachToScene(this),this._spotLights.push(e)}},{key:"removeSpotLight",value:function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)}},{key:"removeSphereLights",value:function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0}},{key:"removeSpotLights",value:function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]}},{key:"addModel",value:function(e){e.attachToScene(this),this._models.push(e),Sf.push(this._modelArrayHandle,e.handle)}},{key:"removeModel",value:function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),this._models.splice(t,1),void Sf.erase(this._modelArrayHandle,t)}},{key:"removeModels",value:function(){for(var e,t=y(this._models);!(e=t()).done;){e.value.detachFromScene()}this._models.length=0,Sf.clear(this._modelArrayHandle)}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e,t=y(this._models);!(e=t()).done;){e.value.onGlobalPipelineStateChanged()}}},{key:"generateModelId",value:function(){return this._modelId++}},{key:"raycastAll",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ph.Enum.DEFAULT|Ph.Enum.UI_2D,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0,n=this.raycastAllModels(e,t,i),r=this.raycastAllCanvas(e,t,i),a=n||r;return pA.length=0,a&&(Array.prototype.push.apply(pA,hA),Array.prototype.push.apply(pA,fA)),a}},{key:"raycastAllModels",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ph.Enum.DEFAULT,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;uA.reset();for(var n,r=y(this._models);!(n=r()).done;){var a=n.value,o=a.transform;if(o&&a.enabled&&a.node.layer&t&~Ph.Enum.IGNORE_RAYCAST&&a.worldBounds){var s=Uc.ray_aabb(e,a.worldBounds);if(!(s<=0||s>=i)){if(a.type===Mb.DEFAULT){Ta.invert(sA,o.getWorldMatrix(sA)),oa.transformMat4(aA.o,e.o,sA),oa.normalize(aA.d,oa.transformMat4Normal(aA.d,e.d,sA)),s=1/0;for(var l=a.subModels,c=0;c<l.length;++c){var u=l[c].subMesh;if(u&&u.geometricInfo){var h=u.geometricInfo,_=h.positions,d=h.indices,f=h.doubleSided;vA(_,d,u.primitiveMode,f,i),s=Math.min(s,lA*oa.multiply(oA,aA.d,o.worldScale).length())}}}if(s<i){var p=uA.add();p.node=a.node,p.distance=s,hA[uA.length-1]=p}}}}return hA.length=uA.length,hA.length>0}},{key:"raycastSingleModel",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ph.Enum.DEFAULT,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0;uA.reset();var r=t,a=r.transform;if(!(a&&r.enabled&&r.node.layer&i&~Ph.Enum.IGNORE_RAYCAST&&r.worldBounds))return!1;var o=Uc.ray_aabb(e,r.worldBounds);if(o<=0||o>=n)return!1;if(r.type===Mb.DEFAULT){Ta.invert(sA,a.getWorldMatrix(sA)),oa.transformMat4(aA.o,e.o,sA),oa.normalize(aA.d,oa.transformMat4Normal(aA.d,e.d,sA)),o=1/0;for(var s=r.subModels,l=0;l<s.length;++l){var c=s[l].subMesh;if(c&&c.geometricInfo){var u=c.geometricInfo,h=u.positions,_=u.indices,d=u.doubleSided;vA(h,_,c.primitiveMode,d,n),o=Math.min(o,lA*oa.multiply(oA,aA.d,a.worldScale).length())}}}if(o<n){var f=uA.add();f.node=r.node,f.distance=o,mA[uA.length-1]=f}return mA.length=uA.length,mA.length>0}},{key:"raycastAllCanvas",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ph.Enum.UI_2D,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/0;dA.reset();var n=E.director.getScene().getComponentsInChildren(E.Canvas);if(null!=n&&n.length>0)for(var r=0;r<n.length;r++){var a=n[r].node;null!=a&&a.active&&this._raycastUI2DNodeRecursiveChildren(e,a,t,i)}return fA.length=dA.length,fA.length>0}},{key:"_raycastUI2DNode",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ph.Enum.UI_2D,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,r=t._uiProps.uiTransformComp;if(!(null==r||t.layer&Ph.Enum.IGNORE_RAYCAST)&&t.layer&i){r.getComputeAABB(_A);var a=Uc.ray_aabb(e,_A);if(!(a<=0)&&a<n){var o=dA.add();return o.node=t,o.distance=a,o}}}},{key:"_raycastUI2DNodeRecursiveChildren",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ph.Enum.UI_2D,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1/0,r=this._raycastUI2DNode(e,t,i,n);null!=r&&(fA[dA.length-1]=r);for(var a,o=y(t.children);!(a=o()).done;){var s=a.value;null!=s&&s.active&&this._raycastUI2DNodeRecursiveChildren(e,s,i,n)}}},{key:"_createHandles",value:function(){this._modelArrayHandle||(this._modelArrayHandle=Sf.alloc(),this._scenePoolHandle=Lf.alloc(),Lf.set(this._scenePoolHandle,Mf.MODEL_ARRAY,this._modelArrayHandle))}}]),e}(),aA=ko.create(),oA=new oa,sA=new Ta,lA=1/0,cA=Go.create(),uA=new Ui((function(){return{node:null,distance:1/0}}),8),hA=[],_A=new $c,dA=new Ui((function(){return{node:null,distance:1/0}}),8),fA=[],pA=[],mA=[],vA=function(e,t,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1/0;if(lA=r,i===Zo.TRIANGLE_LIST)for(var a=t.length,o=0;o<a;o+=3){var s=3*t[o],l=3*t[o+1],c=3*t[o+2];oa.set(cA.a,e[s],e[s+1],e[s+2]),oa.set(cA.b,e[l],e[l+1],e[l+2]),oa.set(cA.c,e[c],e[c+1],e[c+2]);var u=Uc.ray_triangle(aA,cA,n);u<=0||u>=lA||(lA=u)}else if(i===Zo.TRIANGLE_STRIP)for(var h=t.length-2,_=0,d=0;d<h;d+=1){var f=3*t[d-_],p=3*t[d+_+1],m=3*t[d+2];oa.set(cA.a,e[f],e[f+1],e[f+2]),oa.set(cA.b,e[p],e[p+1],e[p+2]),oa.set(cA.c,e[m],e[m+1],e[m+2]),_=~_;var v=Uc.ray_triangle(aA,cA,n);v<=0||v>=lA||(lA=v)}else if(i===Zo.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];oa.set(cA.a,e[y],e[y+1],e[y+2]);for(var x=1;x<g;x+=1){var S=3*t[x],T=3*t[x+1];oa.set(cA.b,e[S],e[S+1],e[S+2]),oa.set(cA.c,e[T],e[T+1],e[T+2]);var E=Uc.ray_triangle(aA,cA,n);E<=0||E>=lA||(lA=E)}}};ka(rA.prototype,"RenderScene.prototype",[{name:"raycastUI",newName:"raycastAllCanvas"},{name:"raycastUI2D",newName:"raycastAllCanvas"},{name:"raycast",newName:"raycastAllModels"},{name:"raycastModels",newName:"raycastAllModels"},{name:"raycastModel",newName:"raycastSingleModel"}]),Da(rA.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Ba(rA.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect in geometry"},{name:"raycastAllModels",suggest:"using intersect in geometry"},{name:"raycastSingleModel",suggest:"using intersect in geometry"},{name:"raycastAllCanvas",suggest:"using intersect in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var gA={};Da(gA,"CameraVisFlags",[{name:"GENERAL"}]),ka(gA,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Ph.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Ph.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Ph.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Ph.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Ph.BitMask,targetName:"UI_2D"}]),E.CameraVisFlags=gA;var yA={};Da(yA,"VisibilityFlags",[{name:"GENERAL"}]),ka(yA,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Ph.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Ph.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Ph.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Ph.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Ph.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Ph.Enum,targetName:"UI_2D"}]),E.VisibilityFlags=yA,ka(Ap.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]);var xA,SA,TA,EA,bA,AA,CA,wA,RA=new oa(0,0,-1),IA=new oa,OA=new pa,MA=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._dir=new oa(1,-1,-1),e._shadowRange=1e3,e._shadowIntensity=0,e._shadowFadeDistance=0,e._shadowDistance=0,e._fadeStart=.8,e._splits=new ua(1,0,0,0),e._biasAutoAdjust=1,e._type=Zx.DIRECTIONAL,e}return o(t,e),r(t,[{key:"shadowRange",set:function(e){this._shadowRange=e},get:function(){return this._shadowRange}},{key:"shadowIntensitywRange",set:function(e){this._shadowIntensity=e}},{key:"shadowIntensity",get:function(){return this._shadowIntensity}},{key:"shadowFadeDistance",set:function(e){this._shadowFadeDistance=e},get:function(){return this._shadowFadeDistance}},{key:"shadowDistance",set:function(e){this._shadowDistance=e},get:function(){return this._shadowDistance}},{key:"fadeStart",set:function(e){this._fadeStart=e},get:function(){return this._fadeStart}},{key:"splits",set:function(e){this._splits=e},get:function(){return this._splits}},{key:"biasAutoAdjust",set:function(e){this._biasAutoAdjust=e},get:function(){return this._biasAutoAdjust}},{key:"direction",set:function(e){this._dir=e,oa.normalize(this._dir,this._dir),hp.setVec3(this._handle,lp.DIRECTION,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(e){hp.set(this._handle,lp.ILLUMINANCE,e)},get:function(){return hp.get(this._handle,lp.ILLUMINANCE)}}]),r(t,[{key:"initialize",value:function(){_(s(t.prototype),"initialize",this).call(this),hp.set(this._handle,lp.ILLUMINANCE,oT.SUN_ILLUM),hp.setVec3(this._handle,lp.DIRECTION,this._dir)}},{key:"update",value:function(){this._node&&this._node.hasChangedFlags&&(this._dir=oa.transformQuat(IA,RA,this._node.getWorldRotation(OA)),oa.normalize(this._dir,this._dir))}}]),t}(tS),PA=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._needUpdate=!1,e._size=.15,e._range=1,e._pos=void 0,e._aabb=void 0,e._type=Zx.SPHERE,e._aabb=$c.create(),e._pos=new oa,e}return o(t,e),r(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e,this._needUpdate=!0},get:function(){return this._range}},{key:"luminance",set:function(e){hp.set(this._handle,lp.ILLUMINANCE,e)},get:function(){return hp.get(this._handle,lp.ILLUMINANCE)}},{key:"aabb",get:function(){return this._aabb}}]),r(t,[{key:"initialize",value:function(){_(s(t.prototype),"initialize",this).call(this),hp.set(this._handle,lp.ILLUMINANCE,1700/eS(this._size))}},{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),$c.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._needUpdate=!1)}}]),t}(tS),kA=new oa(0,0,-1),DA=new pa,BA=new Ta,LA=new Ta,NA=new Ta,FA=new Ta,zA=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._dir=new oa(1,-1,-1),e._size=.15,e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._type=Zx.SPOT,e._aabb=$c.create(),e._frustum=lu.create(),e._pos=new oa,e}return o(t,e),r(t,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(e){this._size=e},get:function(){return this._size}},{key:"range",set:function(e){this._range=e,this._needUpdate=!0},get:function(){return this._range}},{key:"luminance",set:function(e){hp.set(this._handle,lp.ILLUMINANCE,e)},get:function(){return hp.get(this._handle,lp.ILLUMINANCE)}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),r(t,[{key:"initialize",value:function(){_(s(t.prototype),"initialize",this).call(this),hp.set(this._handle,lp.ILLUMINANCE,1700/eS(this._size))}},{key:"update",value:function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),oa.transformQuat(this._dir,kA,this._node.getWorldRotation(DA)),oa.normalize(this._dir,this._dir),hp.setVec3(this._handle,lp.DIRECTION,this._dir),$c.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(BA),Ta.invert(BA,BA),Ta.perspective(LA,this._angle,1,.001,this._range),Ta.multiply(NA,LA,BA),this._frustum.update(NA,FA),this._needUpdate=!1)}}]),t}(tS),UA=Object.freeze({__proto__:null,Ambient:oT,get CameraFOVAxis(){return DS},get CameraProjection(){return BS},get CameraAperture(){return LS},get CameraISO(){return NS},get CameraShutter(){return FS},SKYBOX_FLAG:tT,Camera:iT,CameraVisFlags:gA,VisibilityFlags:yA,DirectionalLight:MA,ColorTemperatureToRGB:$x,get LightType(){return Zx},nt2lm:eS,Light:tS,get ModelType(){return Mb},Model:zb,ShadowType:fS,PCFType:pS,Shadows:mS,RenderScene:rA,Skybox:GT,SphereLight:PA,SpotLight:zA,SubModel:Yg}),GA=function e(){i(this,e),this.material=null,this.vertexCount=0,this.indicesCount=0},HA=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).vData=null,n.uvDirty=!0,n.vertDirty=!0,n._data=[],n._indices=[],n._pivotX=0,n._pivotY=0,n._width=0,n._height=0,n}return o(t,e),r(t,[{key:"updateSizeNPivot",value:function(e,t,i,n){e===this._width&&t===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=e,this._height=t,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}},{key:"clear",value:function(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0}},{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var i=t.length,n=0;for(n=e;n<i;n++)WA.free(t[n]);for(n=i;n<e;n++)t[n]=WA.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}],[{key:"add",value:function(){return jA.add()}},{key:"remove",value:function(e){var t=jA.data.indexOf(e);-1!==t&&(jA.data[t].clear(),jA.removeAt(t))}}]),t}(GA),VA=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).vData=new Float32Array(2304*Float32Array.BYTES_PER_ELEMENT),n.iData=new Uint16Array(1536),n.vertexStart=0,n.indicesStart=0,n.byteStart=0,n.byteCount=0,n._formatByte=9*Float32Array.BYTES_PER_ELEMENT,n}return o(t,e),r(t,[{key:"request",value:function(e,t){var i=this.byteCount+e*this._formatByte,n=this.indicesCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,a=this.iData.length,o=this.vData.length,s=this.iData.length;if(i>r||n>a){for(;r<i||a<n;)r=4*(o*=2),a=s*=2;var l=this.vData;this.vData=new Float32Array(o),this.vData.set(l,0);var c=this.iData;this.iData=new Uint16Array(s),this.iData.set(c,0)}return this.vertexCount+=e,this.indicesCount+=t,this.byteCount=i,!0}},{key:"reset",value:function(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0}}]),t}(GA),WA=new zi((function(){return{x:0,y:0,z:0,u:0,v:0,color:Ma.WHITE.clone()}}),128),jA=new Ui((function(){return new HA}),32),qA=hd,XA=Object.freeze({__proto__:null,addStage:qA,scene:UA,models:nA,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var i=[],n=t.positions.length/3,r=0;r<n;++r)i.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&i.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&i.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&i.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var a=[];a.push(new al(Vo.ATTR_POSITION,jo.RGB32F)),t.normals&&a.push(new al(Vo.ATTR_NORMAL,jo.RGB32F)),t.uvs&&a.push(new al(Vo.ATTR_TEX_COORD,jo.RG32F)),t.colors&&a.push(new al(Vo.ATTR_COLOR,jo.RGB32F));var o=e.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,4*i.length,4*i.length/n));o.update(new Float32Array(i));var s=null;return t.indices&&(s=e.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new ol(a,[o],s))},get RenderQueue(){return ad},get PassStage(){return od},get PropertyType(){return _d},genHandle:fd,getPropertyTypeFromHandle:pd,getTypeFromHandle:md,getSetIndexFromHandle:function(e){return(3145728&e)>>>20},getBindingFromHandle:vd,getOffsetFromHandle:gd,customizeType:yd,type2reader:xd,type2writer:Sd,getDefaultFromType:Ed,overrideMacros:bd,get BatchingSchemes(){return xp},Pass:Ap,programLib:yp,get SamplerInfoIndex(){return Ju},defaultSamplerHash:th,genSamplerHash:rh,samplerLib:vh,nearestPOT:Cp,TextureBufferPool:Wp,MaterialInstance:um,PassInstance:cm});e("renderer",XA);var YA,KA,ZA,QA,JA,$A,eC,tC,iC,nC,rC,aC,oC,sC,lC,cC,uC,hC,_C,dC,fC,pC,mC,vC,gC,yC,xC,SC,TC,EC,bC={parent:null,owner:null,subModelIdx:0},AC=e("RenderableComponent",(xA=ii("cc.RenderableComponent"),SA=Li([sm]),TA=Li(sm),EA=xi("Materials"),xA((CA=S((AA=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_materials",CA,c(n)),x(n,"_visFlags",wA,c(n)),n._materialInstances=[],n._models=[],n}return o(t,e),r(t,[{key:"getMaterial",value:function(e){return e<0||e>=this._materials.length?null:this._materials[e]}},{key:"setMaterial",value:function(e,t){e&&e instanceof um&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var i=this._materialInstances[t];i?i.parent!==this._materials[t]&&(i.destroy(),this._materialInstances[t]=null,this._onMaterialModified(t,this._materials[t])):this._onMaterialModified(t,this._materials[t])}},{key:"getMaterialInstance",value:function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){bC.parent=this._materials[e],bC.owner=this,bC.subModelIdx=e;var t=new um(bC);this.setMaterialInstance(e,t)}return this._materialInstances[e]}},{key:"setMaterialInstance",value:function(e,t){t&&t.parent?t!==this._materialInstances[e]&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):t!==this._materials[e]&&this.setMaterial(t,e)}},{key:"getRenderMaterial",value:function(e){return this._materialInstances[e]||this._materials[e]}},{key:"_collectModels",value:function(){return this._models}},{key:"_attachToScene",value:function(){}},{key:"_detachFromScene",value:function(){}},{key:"_onMaterialModified",value:function(e,t){}},{key:"_onRebuildPSO",value:function(e,t){}},{key:"_clearMaterials",value:function(){}},{key:"_onVisibilityChange",value:function(e){}},{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var i=e.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var i=this._materials.length-t;i<this._materials.length;++i)this.setMaterialInstance(i,null);for(var n=0;n<this._materialInstances.length;n++)this._materialInstances[n]!=e[n]&&this.setMaterialInstance(n,e[n])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){1===this._materials.length&&this._materials[0]===e||this.setMaterialInstance(0,e)}}]),t}(Yr)).prototype,"_materials",[SA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wA=S(AA.prototype,"_visFlags",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ph.Enum.NONE}}),S(AA.prototype,"sharedMaterials",[TA,EA],Object.getOwnPropertyDescriptor(AA.prototype,"sharedMaterials"),AA.prototype),bA=AA))||bA));E.RenderableComponent=AC;var CC=et({OFF:0,ON:1}),wC=et({OFF:0,ON:1}),RC=(YA=ii("cc.ModelLightmapSettings"),KA=li("_recieveShadow"),YA((JA=S((QA=function(){function e(){i(this,e),x(this,"texture",JA,this),x(this,"uvParam",$A,this),x(this,"_bakeable",eC,this),x(this,"_castShadow",tC,this),x(this,"_receiveShadow",iC,this),x(this,"_lightmapSize",nC,this)}return r(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}()).prototype,"texture",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$A=S(QA.prototype,"uvParam",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ua}}),eC=S(QA.prototype,"_bakeable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tC=S(QA.prototype,"_castShadow",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),iC=S(QA.prototype,"_receiveShadow",[KA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nC=S(QA.prototype,"_lightmapSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),S(QA.prototype,"bakeable",[vi],Object.getOwnPropertyDescriptor(QA.prototype,"bakeable"),QA.prototype),S(QA.prototype,"castShadow",[vi],Object.getOwnPropertyDescriptor(QA.prototype,"castShadow"),QA.prototype),S(QA.prototype,"receiveShadow",[vi],Object.getOwnPropertyDescriptor(QA.prototype,"receiveShadow"),QA.prototype),S(QA.prototype,"lightmapSize",[vi],Object.getOwnPropertyDescriptor(QA.prototype,"lightmapSize"),QA.prototype),ZA=QA))||ZA),IC=e("ModelComponent",(rC=ii("cc.MeshRenderer"),aC=mi("i18n:cc.MeshRenderer"),oC=ri(100),sC=_i("Components/MeshRenderer"),lC=Li(CC),cC=Si("i18n:model.shadow_casting_model"),uC=Li(wC),hC=Si("i18n:model.shadow_receiving_model"),_C=Li($_),dC=Si("i18n:model.mesh"),fC=gi((function(){return!!(this.mesh&&this.mesh.struct.morph&&this.mesh.struct.morph.subMeshMorphs.some((function(e){return!!e})))})),rC(pC=aC(pC=oC(pC=sC(pC=hi((EC=TC=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"lightmapSettings",vC,c(e)),x(e,"_mesh",gC,c(e)),x(e,"_shadowCastingMode",yC,c(e)),x(e,"_shadowReceivingMode",xC,c(e)),e._modelType=void 0,e._model=null,e._morphInstance=null,x(e,"_enableMorph",SC,c(e)),e._modelType=zb,e}return o(t,e),r(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t,i=this._mesh;this._mesh=e,null===(t=this._mesh)||void 0===t||t.initialize(),this._watchMorphInMesh(),this._onMeshChanged(i),this._updateModels(),this.enabledInHierarchy&&this._attachToScene()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),r(t,[{key:"onLoad",value:function(){var e;null===(e=this._mesh)||void 0===e||e.initialize(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"onRestore",value:function(){this._updateModels()}},{key:"onEnable",value:function(){this._model||this._updateModels(),this._attachToScene()}},{key:"onDisable",value:function(){this._model&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(E.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}},{key:"setWeights",value:function(e,t){this._morphInstance&&this._morphInstance.setWeights(t,e)}},{key:"setInstancedAttribute",value:function(e,t){if(this.model)for(var i=this.model.instancedAttributes.list,n=0;n<i.length;n++)if(i[n].name===e){i[n].view.set(t);break}}},{key:"_updateLightmap",value:function(e,t,i,n,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()}},{key:"_updateModels",value:function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.node=e.transform=this.node):this._createModel(),this._updateModelParams(),this._onUpdateLightingmap()}}},{key:"_createModel",value:function(){var e=!!this._morphInstance&&this._modelType===zb?Ub:this._modelType,t=this._model=E.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof Ub&&t.setMorphRendering(this._morphInstance)}},{key:"_attachToScene",value:function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!=this._model.scene&&this._detachFromScene(),e.addModel(this._model)}}},{key:"_detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"_updateModelParams",value:function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=nv.POSITION,this._model.transform.hasChangedFlags|=nv.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.subMeshCount:0,t=this._mesh.renderingSubMeshes;if(t)for(var i=0;i<e;++i){var n=this.getRenderMaterial(i),r=t[i];r&&this._model.initSubModel(i,r,n||this._getBuiltinMaterial())}this._model.createBoundingShape(this._mesh.minPosition,this._mesh.maxPosition),this._model.enabled=!0}}},{key:"_onUpdateLightingmap",value:function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}},{key:"_onMaterialModified",value:function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())}},{key:"_onMeshChanged",value:function(e){}},{key:"_clearMaterials",value:function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)}},{key:"_getBuiltinMaterial",value:function(){return tf.get("missing-material")}},{key:"_onVisibilityChange",value:function(e){this._model&&(this._model.visFlags=e)}},{key:"_updateCastShadow",value:function(){this._model&&(this._shadowCastingMode===CC.OFF?this._model.castShadow=!1:(this._shadowCastingMode,CC.ON,"ShadowCastingMode ".concat(this._shadowCastingMode," is not supported."),this._model.castShadow=!0))}},{key:"_updateReceiveShadow",value:function(){this._model&&(this._shadowReceivingMode===wC.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}},{key:"_isBatchingEnabled",value:function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var i=0;i<t.passes.length;++i){if(t.passes[i].batchingScheme)return!0}}return!1}},{key:"_watchMorphInMesh",value:function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){var e=this._mesh.struct.morph;this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,i=0;i<t;++i){var n=e.subMeshMorphs[i];if(n){var r=n.weights||e.weights,a=r?r.slice():new Array(n.targets.length).fill(0);this._morphInstance.setWeights(i,a)}}this._model&&this._model instanceof Ub&&this._model.setMorphRendering(this._morphInstance)}}},{key:"_syncMorphWeights",value:function(e){if(this._morphInstance){var t=this._morphInstance[e];t&&t.renderResources&&t.renderResources.setWeights(t.weights)}}}]),t}(AC),TC.ShadowCastingMode=CC,TC.ShadowReceivingMode=wC,vC=S((mC=EC).prototype,"lightmapSettings",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RC}}),gC=S(mC.prototype,"_mesh",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yC=S(mC.prototype,"_shadowCastingMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CC.OFF}}),xC=S(mC.prototype,"_shadowReceivingMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wC.ON}}),S(mC.prototype,"shadowCastingMode",[lC,cC],Object.getOwnPropertyDescriptor(mC.prototype,"shadowCastingMode"),mC.prototype),S(mC.prototype,"receiveShadow",[uC,hC],Object.getOwnPropertyDescriptor(mC.prototype,"receiveShadow"),mC.prototype),S(mC.prototype,"mesh",[_C,dC],Object.getOwnPropertyDescriptor(mC.prototype,"mesh"),mC.prototype),S(mC.prototype,"enableMorph",[fC],Object.getOwnPropertyDescriptor(mC.prototype,"enableMorph"),mC.prototype),SC=S(mC.prototype,"_enableMorph",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pC=mC))||pC)||pC)||pC)||pC)||pC));function OC(e,t){var i=e.sharedMaterials.length;if(i!==t.sharedMaterials.length)return!1;for(var n=0;n<i;n++)if(e.getRenderMaterial(n)!==t.getRenderMaterial(n))return!1;return!0}e("BatchingUtility",function(){function e(){i(this,e)}return r(e,null,[{key:"batchStaticModel",value:function(e,t){var i=e.getComponentsInChildren(IC);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var n=1;n<i.length;n++){if(!i[0].mesh.validateMergingMesh(i[n].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1;if(!OC(i[0],i[n]))return console.error("the materials of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1}var r=new $_,a=new Ta,o=new Ta;e.getWorldMatrix(o),Ta.invert(o,o);for(var s=0;s<i.length;s++){var l=i[s];l.node.getWorldMatrix(a),Ta.multiply(a,o,a),r.merge(i[s].mesh,a),l.enabled=!1}var c=t.addComponent(IC);return c.mesh=r,c.sharedMaterials=i[0].sharedMaterials,!0}},{key:"unbatchStaticModel",value:function(e,t){for(var i=e.getComponentsInChildren("cc.MeshRenderer"),n=0;n<i.length;n++){i[n].enabled=!0}var r=t.getComponent("cc.MeshRenderer");return r&&r.destroy(),!0}}]),e}());var MC=new oa;function PC(e,t,i,n){n||(n=new oa),e.convertToUINode(t,i,n);var r=i.position;return n.add(r),n}function kC(e,t,i){return i||(i=new oa),e.worldToScreen(t,i),i.x=i.x/E.view.getScaleX(),i.y=i.y/E.view.getScaleY(),i}var DC=e("convertUtils",{WorldNode3DToLocalNodeUI:PC,WorldNode3DToWorldNodeUI:kC});E.pipelineUtils=DC,ka(E.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=t[0],r=t[3]||MC;return n.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]);var BC,LC,NC,FC,zC,UC,GC,HC=Object.freeze({__proto__:null,ccclass:ii,property:oi,requireComponent:ni,executionOrder:ri,disallowMultiple:ai,executeInEditMode:hi,menu:_i,playOnFocus:di,inspector:fi,icon:pi,help:mi,type:Li,integer:Pi,float:ki,boolean:Di,string:Bi});e("_decorator",HC);var VC=ii("cc.MissingClass")((NC=S((LC=function e(){i(this,e),x(this,"_$erialized",NC,this)}).prototype,"_$erialized",[si,ci],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BC=LC))||BC,WC=e("MissingScript",ii("cc.MissingScript")(FC=fi("packages://inspector/inspectors/comps/missing-script.js")((UC=S((zC=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"compiled",UC,c(e)),x(e,"_$erialized",GC,c(e)),e}return o(t,e),r(t,null,[{key:"safeFindClass",value:function(e,i){var n=De(e);return n||(e?(E.deserialize.reportMissingClass(e),t.getMissingWrapper(e,i)):null)}},{key:"getMissingWrapper",value:function(e,i){return i.node&&(/^[0-9a-zA-Z+/]{23}$/.test(e)||Ue.test(e))?t:VC}}]),r(t,[{key:"onLoad",value:function(){G(4600,this.node.name)}}]),t}(Yr)).prototype,"compiled",[vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GC=S(zC.prototype,"_$erialized",[si,ci],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FC=zC))||FC)||FC);E._MissingScript=WC;var jC=function(){function e(){i(this,e),this.uuidList=void 0,this.uuidObjList=void 0,this.uuidPropList=void 0,this._stillUseUrl=void 0,this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this._stillUseUrl=_e(!0)}return r(e,[{key:"reset",value:function(){this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,we(this._stillUseUrl)}},{key:"push",value:function(e,t,i,n){n&&(this._stillUseUrl[this.uuidList.length]=!0),this.uuidList.push(i),this.uuidObjList.push(e),this.uuidPropList.push(t)}}]),e}();function qC(e,t,i,n,r,a){if(t instanceof E.ValueType){r||e.push("if(prop){");var o=de(t);e.push("s._deserializeTypedObject(o".concat(i,",prop,").concat(o,");")),r||e.push("}else o"+i+"=null;")}else e.push("if(prop){"),e.push("s._deserializeObjField(o,prop,"+n+",null,"+!!a+");"),e.push("}else o"+i+"=null;")}jC.pool=void 0,jC.pool=new Ne((function(e){e.reset()}),10),jC.pool.get=function(){return this._get()||new jC};function XC(e,i,n,r,a){var o;r.hasOwnProperty("__deserialize__")?o=r.__deserialize__:(o=function(e,i){for(var n=lt(i),r=i.__values__,a=["var prop;"],o=Ue.test(Le(i)),s=0;s<r.length;s++){var l=r[s],c=void 0,u=void 0;Ht.IDENTIFIER_RE.test(l)?(u='"'+l+'"',c="."+l):c="["+(u=Ht.escapeForJS(l))+"]";var h=c;if(n[l+"$_$formerlySerializedAs"]){var _=n[l+"$_$formerlySerializedAs"];h=Ht.IDENTIFIER_RE.test(_)?"."+_:"["+Ht.escapeForJS(_)+"]"}a.push("prop=d"+h+";"),a.push("if(typeof ".concat("prop",'!=="undefined"){'));var d=n[l+"$_$saveUrlAsAsset"],f=Ht.getDefault(n[l+"$_$default"]);if(o){var p=void 0,m=n[l+"$_$type"];if(void 0===f&&m)p=m===E.String||m===E.Integer||m===E.Float||m===E.Boolean;else{var v=t(f);p="string"===v&&!d||"number"===v||"boolean"===v}p?a.push("o".concat(c,"=prop;")):qC(a,f,c,u,!0,d)}else a.push("if(typeof ".concat("prop",'!=="object"){')+"o"+c+"=prop;}else{"),qC(a,f,c,u,!1,d),a.push("}");a.push("}")}return(E.js.isChildClassOf(i,E._BaseNode)||E.js.isChildClassOf(i,E.Component))&&a.push("d._id&&(o._id=d._id);"),"_$erialized"===r[r.length-1]&&(a.push("o._$erialized=JSON.parse(JSON.stringify(d));"),a.push("s._deserializePrimitiveObject(o._$erialized,d);")),Function("s","o","d","k","t",a.join(""))}(0,r),le(r,"__deserialize__",o,!0)),o(e,i,n,r,a)}var YC=function(){function e(t,n,r,a,o){i(this,e),this.result=void 0,this.customEnv=void 0,this.deserializedList=void 0,this.deserializedData=void 0,this._classFinder=void 0,this._target=void 0,this._ignoreEditorOnly=void 0,this._idList=void 0,this._idObjList=void 0,this._idPropList=void 0,this.result=t,this.customEnv=a,this.deserializedList=[],this.deserializedData=null,this._classFinder=r,this._idList=[],this._idObjList=[],this._idPropList=[]}return r(e,[{key:"deserialize",value:function(e){if(Array.isArray(e)){var t=e,i=t.length;this.deserializedList.length=i;for(var n=0;n<i;n++)t[n]&&(this.deserializedList[n]=this._deserializeObject(t[n],!1));this.deserializedData=i>0?this.deserializedList[0]:[]}else this.deserializedList.length=1,this.deserializedData=e?this._deserializeObject(e,!1):null,this.deserializedList[0]=this.deserializedData;return function(e){var t,i,n,r=e.deserializedList,a=e._idPropList,o=e._idList,s=e._idObjList;for(e._classFinder&&e._classFinder.onDereferenced,t=0;t<o.length;t++)i=a[t],n=o[t],s[t][i]=r[n]}(this),this.deserializedData}},{key:"_deserializeObject",value:function(e,i,n,r,a){var o,s=null,l=null,c=e.__type__;if("TypedArray"===c){var u=e.array;s=new window[e.ctor](u.length);for(var h=0;h<u.length;++h)s[h]=u[h];return s}if(c){if(!(l=this._classFinder(c,e,r,a)))return this._classFinder===De&&E.deserialize.reportMissingClass(c),null;var _=this;(s=new l)._deserialize?s._deserialize(e.content,_):E.Class._isCCClass(l)?XC(_,s,e,l,n):_._deserializeTypedObject(s,e,l)}else if(Array.isArray(e)){s=new Array(e.length);for(var d=0;d<e.length;d++)"object"===t(o=e[d])&&o?this._deserializeObjField(s,o,""+d,null,i):s[d]=o}else s={},this._deserializePrimitiveObject(s,e);return s}},{key:"_deserializeObjField",value:function(e,t,i,n,r){var a=t.__id__;if(void 0===a){var o=t.__uuid__;o?this.result.push(e,i,o,r):e[i]=this._deserializeObject(t,r)}else{var s=this.deserializedList[a];s?e[i]=s:(this._idList.push(a),this._idObjList.push(e),this._idPropList.push(i))}}},{key:"_deserializePrimitiveObject",value:function(e,i){for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];"object"!==t(r)?"__type__"!==n&&(e[n]=r):r?this._deserializeObjField(e,r,n):e[n]=null}}},{key:"_deserializeTypedObject",value:function(e,i,n){if(n===E.Vec2)return e.x=i.x||0,void(e.y=i.y||0);if(n===E.Vec3)return e.x=i.x||0,e.y=i.y||0,void(e.z=i.z||0);if(n!==E.Color){if(n===E.Size)return e.width=i.width||0,void(e.height=i.height||0);for(var r=lt(n),a=n.__props__||Object.keys(e),o=0;o<a.length;o++){var s=a[o],l=i[s];void 0!==l&&i.hasOwnProperty(s)||(l=Ht.getDefault(r[s+"$_$default"])),"object"!==t(l)?e[s]=l:l?this._deserializeObjField(e,l,s):e[s]=null}}else{e.r=i.r||0,e.g=i.g||0,e.b=i.b||0;var c=i.a;e.a=void 0===c?255:c}}}]),e}();function KC(e,t,i){var n=(i=i||{}).classFinder||De,r=i.createAssetRefs||E.sys.platform===E.sys.EDITOR_CORE,a=i.customEnv,o=i.ignoreEditorOnly;"string"==typeof e&&(e=JSON.parse(e));var s=!t;t=t||jC.pool.get();var l=YC.pool.get(t,!1,n,a,o);E.game._isCloning=!0;var c=l.deserialize(e);return E.game._isCloning=!1,YC.pool.put(l),r&&t.assignAssetsBy(EditorExtends.serialize.asAsset),s&&jC.pool.put(t),c}YC.pool=void 0,YC.pool=new Ne((function(e){e.result=null,e.customEnv=null,e.deserializedList.length=0,e.deserializedData=null,e._classFinder=null,e._idList.length=0,e._idObjList.length=0,e._idPropList.length=0}),1),YC.pool.get=function(e,t,i,n,r){var a=this._get();return a?(a.result=e,a.customEnv=n,a._classFinder=i,a):new YC(e,t,i,n,r)},KC.Details=jC,KC.reportMissingClass=function(e){G(5302,e)},KC._Deserializer=YC,E.deserialize=KC;var ZC,QC,JC,$C,ew,tw,iw,nw,rw,aw,ow,sw=Vi.Flags.Destroyed,lw=Vi.Flags.PersistentMask,cw=[];function uw(e,t){var i;if(e instanceof Vi){if(e._instantiate)return E.game._isCloning=!0,i=e._instantiate(),E.game._isCloning=!1,i;if(e instanceof E.Asset)throw new TypeError(X(6903))}return E.game._isCloning=!0,i=hw(e),E.game._isCloning=!1,i}function hw(e,t){var i;if(e._iN$t)i=e._iN$t;else if(e.constructor){i=new(0,e.constructor)}else i=Object.create(null);_w(e,i,t);for(var n=0,r=cw.length;n<r;++n)cw[n]._iN$t=null;return cw.length=0,i}function _w(e,i,n){ze.value(e,"_iN$t",i,!0),cw.push(e);var r=e.constructor;if(E.Class._isCCClass(r))!function(e,i,n,r){for(var a=e.__values__,o=0;o<a.length;o++){var s=a[o],l=i[s];if("object"===t(l)&&l){var c=n[s];c instanceof rt&&c.constructor===l.constructor?c.set(l):n[s]=l._iN$t||dw(l,r)}else n[s]=l}}(r,e,i,n);else for(var a in e)if(e.hasOwnProperty(a)&&(95!==a.charCodeAt(0)||95!==a.charCodeAt(1)||"__type__"===a)){var o=e[a];if("object"===t(o)&&o){if(o===i)continue;i[a]=o._iN$t||dw(o,n)}else i[a]=o}e instanceof Vi&&(i._objFlags&=lw)}function dw(e,i){if(e instanceof rt)return e.clone();if(e instanceof E.Asset)return e;var n;if(Array.isArray(e)){var r=e.length;n=new Array(r),e._iN$t=n;for(var a=0;a<r;++a){var o=e[a];"object"===t(o)&&o?n[a]=o._iN$t||dw(o,i):n[a]=o}return cw.push(e),n}if(e._objFlags&sw)return null;var s=e.constructor;if(E.Class._isCCClass(s)){if(i)if(i instanceof E.Component){if(e instanceof E._BaseNode||e instanceof E.Component)return e}else if(i instanceof E._BaseNode)if(e instanceof E._BaseNode){if(!e.isChildOf(i))return e}else if(e instanceof E.Component&&!e.node.isChildOf(i))return e;n=new s}else if(s===Object)n={};else{if(s)return e;n=Object.create(null)}return _w(e,n,i),n}uw._clone=hw,E.instantiate=uw,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(aw||(aw={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(ow||(ow={}));function fw(e,t){return(t<<3)+e}var pw=e("CompactValueTypeArray",ii("cc.CompactValueTypeArray")((nw=iw=function(){function e(){i(this,e),x(this,"_byteOffset",JC,this),x(this,"_unitCount",$C,this),x(this,"_unitElement",ew,this),x(this,"_length",tw,this)}return r(e,[{key:"decompress",value:function(e){for(var t,i={storageUnit:7&(t=this._unitElement),elementType:t>>3},n=i.storageUnit,r=mw(i.elementType),a=new(vw(n))(e,this._byteOffset,this._unitCount),o=new Array(this._length),s=0;s<this._length;++s)o[s]=r.decompress(a,s);return o}}],[{key:"lengthFor",value:function(e,t,i){return mw(t).requiredUnits*e.length*vw(i).BYTES_PER_ELEMENT}},{key:"compress",value:function(t,i,n,r,a,o){for(var s=mw(i),l=vw(n),c=s.requiredUnits*t.length,u=new l(r,a,c),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=fw(n,i),_._byteOffset=o,_._unitCount=c,_._length=t.length,_}}]),e}(),iw.StorageUnit=aw,iw.ElementType=ow,JC=S((QC=nw).prototype,"_byteOffset",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$C=S(QC.prototype,"_unitCount",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ew=S(QC.prototype,"_unitElement",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fw(aw.Uint8,ow.Scalar)}}),tw=S(QC.prototype,"_length",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZC=QC))||ZC);function mw(e){return gw[e]}function vw(e){switch(e){case aw.Uint8:return Uint8Array;case aw.Uint16:return Uint16Array;case aw.Uint32:return Uint32Array;case aw.Int8:return Int8Array;case aw.Int16:return Int16Array;case aw.Int32:return Int32Array;case aw.Float32:return Float32Array;case aw.Float64:return Float64Array}}var gw=(a(rw={},ow.Scalar,{requiredUnits:1,compress:function(e,t,i){e[t]=i},decompress:function(e,t){return e[t]}}),a(rw,ow.Vec2,{requiredUnits:2,compress:function(e,t,i){e[2*t]=i.x,e[2*t+1]=i.y},decompress:function(e,t){return new oa(e[2*t],e[2*t+1])}}),a(rw,ow.Vec3,{requiredUnits:3,compress:function(e,t,i){e[3*t]=i.x,e[3*t+1]=i.y,e[3*t+2]=i.z},decompress:function(e,t){return new oa(e[3*t],e[3*t+1],e[3*t+2])}}),a(rw,ow.Vec4,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new ua(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),a(rw,ow.Quat,{requiredUnits:4,compress:function(e,t,i){e[4*t]=i.x,e[4*t+1]=i.y,e[4*t+2]=i.z,e[4*t+3]=i.w},decompress:function(e,t){return new pa(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}}),a(rw,ow.Mat4,{requiredUnits:16,compress:function(e,t,i){Ta.toArray(e,i,16*t)},decompress:function(e,t){return Ta.fromArray(new Ta,e,16*t)}}),rw);function yw(e){var t=[];return function e(t,i){for(var n,r=y(i);!(n=r()).done;){var a=n.value;Array.isArray(a)?e(t,a):t.push(a)}}(t,e),t.join("")}E._decorator=HC;var xw=Vi.Flags.Destroyed,Sw=Vi.Flags.PersistentMask,Tw=Ht.IDENTIFIER_RE,Ew={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},bw=Ht.escapeForJS,Aw=function(){function e(t,n){i(this,e),this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=n}return r(e,[{key:"toString",value:function(){return"var "+this.varName+"="+this.expression+";"}}]),e}();function Cw(e,t){return t instanceof Aw?new Aw(t.varName,e+t.expression):e+t}function ww(e,t,i){Array.isArray(i)?(i[0]=Cw(t,i[0]),e.push(i)):e.push(Cw(t,i)+";")}var Rw=function(){function e(t){i(this,e),this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}return r(e,[{key:"append",value:function(e,t){this._exps.push([e,t])}},{key:"writeCode",value:function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];ww(e,t+Iw(n[0])+"=",n[1])}}}]),e}();function Iw(e){return Tw.test(e)?"."+e:"["+bw(e)+"]"}Rw.pool=void 0,Rw.pool=new Ne((function(e){e._exps.length=0,e._targetExp=null}),1),Rw.pool.get=function(e){var t=this._get()||new Rw;return t._targetExp=e,t};var Ow,Mw,Pw,kw,Dw,Bw,Lw,Nw=function(){function e(t,n){var r;i(this,e),this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=n,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=_e(),Ee(this.funcModuleCache,Ew),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(r="var "+this.globalVariables.join(",")+";");var a=yw(["return (function(R){",r||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",a)(this.objs,this.funcs);for(var o=0,s=this.objsToClear_iN$t.length;o<s;++o)this.objsToClear_iN$t[o]._iN$t=null;this.objsToClear_iN$t.length=0}return r(e,[{key:"getFuncModule",value:function(e,t){var i=de(e);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=e===Function("return "+i)())return this.funcModuleCache[i]=i,i}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var o="F["+a+"]";return t&&(o="("+o+")"),this.funcModuleCache[i]=o,o}},{key:"getObjRef",value:function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"}},{key:"setValueType",value:function(e,t,i,n){var r=Rw.pool.get(n),a=t.constructor.__props__;a||(a=Object.keys(t));for(var o=0;o<a.length;o++){var s=a[o],l=i[s];if(t[s]!==l){var c=this.enumerateField(i,s,l);r.append(s,c)}}r.writeCode(e),Rw.pool.put(r)}},{key:"enumerateCCClass",value:function(e,i,n){for(var r=n.__values__,a=lt(n),o=0;o<r.length;o++){var s=r[o],l=i[s],c=a[s+"$_$default"];if(!Fw(c,l))if("object"===t(l)&&l instanceof E.ValueType&&(c=Ht.getDefault(c))&&c.constructor===l.constructor){var u="o"+Iw(s);this.setValueType(e,c,l,u)}else this.setObjProp(e,i,s,l)}}},{key:"instantiateArray",value:function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new Aw(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n){ww(i,t+"["+n+"]=",this.enumerateField(e,n,e[n]))}return i}},{key:"enumerateField",value:function(e,i,n){if("object"===t(n)&&n){var r=n._iN$t;if(r){var a=r.globalVar;if(!a){a=r.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(a);var o=r.source[0];r.source[0]=Cw(a+"=",o)}return a}return Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?bw(n):("_objFlags"===i&&e instanceof Vi&&(n&=Sw),n)}},{key:"setObjProp",value:function(e,t,i,n){ww(e,"o"+Iw(i)+"=",this.enumerateField(t,i,n))}},{key:"enumerateObject",value:function(e,i){var n=i.constructor;if(E.Class._isCCClass(n))this.enumerateCCClass(e,i,n);else for(var r in i)if(i.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var a=i[r];"object"===t(a)&&a&&a===i._iN$t||this.setObjProp(e,i,r,a)}}},{key:"instantiateObj",value:function(e){if(e instanceof E.ValueType)return Ht.getNewValueTypeCode(e);if(e instanceof E.Asset)return this.getObjRef(e);if(e._objFlags&xw)return null;var t,i=e.constructor;if(E.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof E.Component){if(e instanceof E._BaseNode||e instanceof E.Component)return this.getObjRef(e)}else if(this.parent instanceof E._BaseNode)if(e instanceof E._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof E.Component&&!e.node.isChildOf(this.parent))return this.getObjRef(e);t=new Aw("o","new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new Aw("o","{}");else{if(i)return this.getObjRef(e);t=new Aw("o","Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]}}]),e}();function Fw(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t){if(e instanceof E.ValueType&&e.equals(t))return!0;if(Array.isArray(e)&&Array.isArray(t)||e.constructor===Object&&t.constructor===Object)try{return Array.isArray(e)&&Array.isArray(t)&&0===e.length&&0===t.length}catch(e){}}return!1}var zw,Uw,Gw,Hw,Vw=et({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Ww=e("Prefab",ii("cc.Prefab")((Lw=Bw=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"data",Pw,c(e)),x(e,"optimizationPolicy",kw,c(e)),x(e,"asyncLoadAssets",Dw,c(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}return o(t,e),r(t,[{key:"createNode",value:function(e){var t=E.instantiate(this);t.name=this.name,e(null,t)}},{key:"compileCreateFunction",value:function(){var e,t;this._createFunction=(e=this.data,t=e instanceof E._BaseNode&&e,new Nw(e,t).result)}},{key:"_doInstantiate",value:function(e){return this.data._prefab?this.data._prefab._synced=!0:G(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)}},{key:"_instantiate",value:function(){var e;return this.optimizationPolicy!==Vw.SINGLE_INSTANCE&&(this.optimizationPolicy===Vw.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):(this.data._prefab._synced=!0,e=this.data._instantiate()),++this._instantiatedTimes,e}}]),t}(cn),Bw.OptimizationPolicy=Vw,Bw.OptimizationPolicyThreshold=3,Pw=S((Mw=Lw).prototype,"data",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kw=S(Mw.prototype,"optimizationPolicy",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vw.AUTO}}),Dw=S(Mw.prototype,"asyncLoadAssets",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ow=Mw))||Ow);E.Prefab=Ww,fe(E,"cc._Prefab","Prefab");var jw,qw,Xw,Yw=e("SceneAsset",ii("cc.SceneAsset")((Gw=S((Uw=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"scene",Gw,c(n)),x(n,"asyncLoadAssets",Hw,c(n)),n}return o(t,e),t}(cn)).prototype,"scene",[vi,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hw=S(Uw.prototype,"asyncLoadAssets",[vi,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zw=Uw))||zw);E.SceneAsset=Yw;var Kw,Zw,Qw,Jw=e("SpriteAtlas",ii("cc.SpriteAtlas")((Xw=S((qw=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"spriteFrames",Xw,c(n)),n}return o(t,e),r(t,[{key:"getTexture",value:function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null}},{key:"getSpriteFrame",value:function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null}},{key:"getSpriteFrames",value:function(){for(var e=[],t=this.spriteFrames,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i];e.push(t[r])}return e}},{key:"_serialize",value:function(e){for(var t=[],i=0,n=Object.keys(this.spriteFrames);i<n.length;i++){var r=n[i],a=this.spriteFrames[r],o=a?a._uuid:"";o&&e&&(o=EditorExtends.UuidUtils.compressUuid(o,!0)),t.push(r),t.push(o)}return{name:this._name,spriteFrames:t}}},{key:"_deserialize",value:function(e,t){var i=e;this._name=i.name;var n=i.spriteFrames;this.spriteFrames=_e();for(var r=0;r<n.length;r+=2)t.result.push(this.spriteFrames,n[r],n[r+1])}}]),t}(cn)).prototype,"spriteFrames",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _e()}}),jw=qw))||jw);E.SpriteAtlas=Jw;var $w,eR,tR,iR=e("TextAsset",ii("cc.TextAsset")((Qw=S((Zw=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"text",Qw,c(n)),n}return o(t,e),r(t,[{key:"toString",value:function(){return this.text}}]),t}(cn)).prototype,"text",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Kw=Zw))||Kw);E.TextAsset=iR;var nR=e("JsonAsset",ii("cc.JsonAsset")((tR=S((eR=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"json",tR,c(n)),n}return o(t,e),t}(cn)).prototype,"json",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$w=eR))||$w);E.JsonAsset=nR;var rR="0123456789abcdef".split(""),aR=["","","",""],oR=aR.concat(aR,"-",aR,"-",aR,"-",aR,"-",aR,aR,aR),sR=oR.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function lR(e){var t=e.split("@")[0];if(22!==t.length)return e;oR[0]=e[0],oR[1]=e[1];for(var i=2,n=2;i<22;i+=2){var r=We[e.charCodeAt(i)],a=We[e.charCodeAt(i+1)];oR[sR[n++]]=rR[r>>2],oR[sR[n++]]=rR[(3&r)<<2|a>>4],oR[sR[n++]]=rR[15&a]}return e.replace(t,oR.join(""))}var cR={_rawAssets:"",normalize:function(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e},raw:function(e){if((e=this.normalize(e)).startsWith("resources/")){var t=E.loader._getResUuid(e.slice(10),E.Asset,null,!0);if(t)return E.AssetLibrary.getLibUrlNoExt(t,!0)+uo(e)}else V(7002,e);return this._rawAssets+e},_init:function(e){this._rawAssets=go(e)+"/"}};E.url=cR,e("url",cR);var uR=function e(t,n){i(this,e),this.uuid=void 0,this.type=void 0,this.uuid=t,this.type=n};function hR(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}var _R,dR=function(){function e(){i(this,e),this._pathToUuid=void 0,this._pathToUuid=_e(!0)}return r(e,[{key:"getUuid",value:function(e,t){e=cR.normalize(e);var i=this._pathToUuid[e];if(i)if(Array.isArray(i)){if(!t)return i[0].uuid;for(var n=0;n<i.length;n++){var r=i[n];if(Ce(r.type,t))return r.uuid}}else if(!t||Ce(i.type,t))return i.uuid;return""}},{key:"getUuidArray",value:function(e,t,i){"/"===(e=cR.normalize(e))[e.length-1]&&(e=e.slice(0,-1));var n=this._pathToUuid,r=[];for(var a in n)if(a.startsWith(e)&&hR(a,e)||!e){var o=n[a];if(Array.isArray(o))for(var s=0;s<o.length;s++){var l=o[s];t&&!Ce(l.type,t)||(r.push(l.uuid),i&&i.push(a))}else t&&!Ce(o.type,t)||(r.push(o.uuid),i&&i.push(a))}return r}},{key:"add",value:function(e,t,i,n){n&&(e=e.substring(0,e.length-uo(e).length));var r=new uR(t,i);qe(this._pathToUuid,e,r,n)}},{key:"_getInfo_DEBUG",value:function(e,t){for(var i=this._pathToUuid,n=Object.keys(i),r=0;r<n.length;++r){var a=n[r],o=i[a];if(Array.isArray(o))for(var s=0;s<o.length;s++){var l=o[s];if(l.uuid===e)return t.path=a,t.type=l.type,!0}else if(o.uuid===e)return t.path=a,t.type=o.type,!0}return!1}},{key:"reset",value:function(){this._pathToUuid=_e(!0)}}]),e}(),fR=0|998*Math.random(),pR=_e(!0),mR=[];!function(e){e[e.WORKING=0]="WORKING",e[e.COMPLETE=1]="COMPLETE",e[e.ERROR=2]="ERROR"}(_R||(_R={}));var vR=_e(!0);function gR(e){if(e){var t=e.split("?");if(t&&t[0]&&t[1]){var i={};return t[1].split("&").forEach((function(e){var t=e.split("=");i[t[0]]=t[1]})),i}}}function yR(e,i){var n="object"===t(e)?e.url:e,r={queueId:i,id:n,url:n,rawUrl:void 0,urlParam:gR(n),type:"",error:null,content:null,complete:!1,states:{},deps:null,isScene:e.uuid&&E.game._sceneInfos.find((function(t){return t.uuid===e.uuid}))};if("object"===t(e)&&(Ee(r,e),e.skips))for(var a=0;a<e.skips.length;a++){var o=e.skips[a];r.states[o]=_R.COMPLETE}return r.rawUrl=r.url,n&&!r.type&&(r.type=uo(n).toLowerCase().substr(1)),r}var xR=[];function SR(e,t,i){if(!e||!t)return!1;var n=!1;if(xR.push(t.id),t.deps){var r,a,o=t.deps;for(r=0;r<o.length;r++){if((a=o[r]).id===e.id){n=!0;break}if(!(xR.indexOf(a.id)>=0)&&(a.deps&&SR(e,a,!0))){n=!0;break}}}return i||(xR.length=0),n}var TR=e("LoadingItems",function(e){function t(e,n,r,a){var o;return i(this,t),(o=u(this,s(t).call(this))).onProgress=void 0,o.onComplete=void 0,o.map=_e(!0),o.completed={},o.totalCount=0,o.completedCount=0,o.active=void 0,o._id=void 0,o._pipeline=void 0,o._errorUrls=[],o._appending=!1,o._ownerQueue=null,o._id=++fR,pR[o._id]=c(o),o._pipeline=e,o.onProgress=r,o.onComplete=a,o._pipeline?o.active=!0:o.active=!1,n&&(n.length>0?o.append(n):o.allComplete()),o}return o(t,e),r(t,[{key:"append",value:function(e,i){var n=this;if(!this.active)return[];i&&!i.deps&&(i.deps=[]),this._appending=!0;var r,a,o,s,l=[];for(r=0;r<e.length;++r){if((a=e[r]).queueId&&!this.map[a.id]){if(this.map[a.id]=a,i&&i.deps.push(a),a.complete||SR(i,a)){this.totalCount++,this.itemComplete(a.id);continue}if("continue"===function(){var e=n,r=pR[a.queueId];return r&&(n.totalCount++,t.registerQueueDep(i||n._id,a.id),r.addListener(a.id,(function(t){e.itemComplete(t.id)}))),"continue"}())continue}if("string"==typeof((s=a).url||s)){var c=(o=yR(a,this._id)).id;this.map[c]||(this.map[c]=o,this.totalCount++,i&&i.deps.push(o),t.registerQueueDep(i||this._id,c),l.push(o))}}return this._appending=!1,this.completedCount===this.totalCount?this.allComplete():this._pipeline.flowIn(l),l}},{key:"_childOnProgress",value:function(e){if(this.onProgress){var t=vR[this._id];this.onProgress(t?t.completed.length:this.completedCount,t?t.deps.length:this.totalCount,e)}}},{key:"allComplete",value:function(){var e=0===this._errorUrls.length?null:this._errorUrls;this.onComplete&&this.onComplete(e,this)}},{key:"isCompleted",value:function(){return this.completedCount>=this.totalCount}},{key:"isItemCompleted",value:function(e){return!!this.completed[e]}},{key:"exists",value:function(e){return!!this.map[e]}},{key:"getContent",value:function(e){var t=this.map[e],i=null;return t&&(t.content?i=t.content:t.alias&&(i=t.alias.content)),i}},{key:"getError",value:function(e){var t=this.map[e],i=null;return t&&(t.error?i=t.error:t.alias&&(i=t.alias.error)),i}},{key:"removeItem",value:function(e){var t=this.map[e];t&&this.completed[t.alias||e]&&(delete this.completed[e],delete this.map[e],t.alias&&(delete this.completed[t.alias.id],delete this.map[t.alias.id]),this.completedCount--,this.totalCount--)}},{key:"itemComplete",value:function(e){var i=this.map[e];if(i){var n=this._errorUrls.indexOf(e);if(i.error&&-1===n?this._errorUrls.push(e):i.error||-1===n||this._errorUrls.splice(n,1),t.finishDep(i.id),this.emit(e,i),this.removeAll(e),this.completed[e]=i,this.completedCount++,this.onProgress){var r=vR[this._id];this.onProgress(r?r.completed.length:this.completedCount,r?r.deps.length:this.totalCount,i)}!this._appending&&this.completedCount>=this.totalCount&&this.allComplete()}}},{key:"destroy",value:function(){this.active=!1,this._appending=!1,this._pipeline=null,this._ownerQueue=null,this._errorUrls.length=0,this.onProgress=void 0,this.onComplete=void 0,this.map=_e(!0),this.completed={},this.totalCount=0,this.completedCount=0,this.clear(),pR[this._id]=null,vR[this._id]&&(vR[this._id].completed.length=0,vR[this._id].deps.length=0),-1===mR.indexOf(this)&&mR.length<10&&mR.push(this)}},{key:"addListener",value:function(e,i,n){return _(s(t.prototype),"on",this).call(this,e,i,n)}},{key:"hasListener",value:function(e,i,n){return _(s(t.prototype),"hasEventListener",this).call(this,e,i,n)}},{key:"removeListener",value:function(e,i,n){return _(s(t.prototype),"off",this).call(this,e,i,n)}},{key:"removeAllListeners",value:function(e){_(s(t.prototype),"removeAll",this).call(this,e)}}],[{key:"create",value:function(e,i,n,r){void 0===n?"function"==typeof i&&(r=i,i=n=null):void 0===r&&("function"==typeof i?(r=n,n=i,i=null):(r=n,n=null));var a=mR.pop();return a?(a._pipeline=e,a.onProgress=n,a.onComplete=r,pR[a._id]=a,a._pipeline&&(a.active=!0),i&&a.append(i)):a=new t(e,i,n,r),a}},{key:"getQueue",value:function(e){return e.queueId?pR[e.queueId]:null}},{key:"itemComplete",value:function(e){var t=pR[e.queueId];t&&t.itemComplete(e.id)}},{key:"initQueueDeps",value:function(e){var t=vR[e._id];t?(t.completed.length=0,t.deps.length=0):t=vR[e._id]={completed:[],deps:[]}}},{key:"registerQueueDep",value:function(e,t){var i=e.queueId||e;if(!i)return!1;var n=vR[i];if(n)-1===n.deps.indexOf(t)&&n.deps.push(t);else if(e.id)for(var r in vR){var a=vR[r];-1!==a.deps.indexOf(e.id)&&-1===a.deps.indexOf(t)&&a.deps.push(t)}}},{key:"finishDep",value:function(e){for(var t in vR){var i=vR[t];-1!==i.deps.indexOf(e)&&-1===i.completed.indexOf(e)&&i.completed.push(e)}}}]),t}(Ji));TR.ItemState=new E.Enum(_R),E.LoadingItems=TR;var ER=TR.ItemState;function bR(e,t){var i=e.id,n=t.states[i],r=e.next,a=e.pipeline;if(!t.error&&n!==ER.WORKING&&n!==ER.ERROR)if(n===ER.COMPLETE)r?bR(r,t):a.flowOut(t);else{t.states[i]=ER.WORKING;var o=e.handle(t,(function(e,n){e?(t.error=e,t.states[i]=ER.ERROR,a.flowOut(t)):(n&&(t.content=n),t.states[i]=ER.COMPLETE,r?bR(r,t):a.flowOut(t))}));o instanceof Error?(t.error=o,t.states[i]=ER.ERROR,a.flowOut(t)):void 0!==o&&(null!==o&&(t.content=o),t.states[i]=ER.COMPLETE,r?bR(r,t):a.flowOut(t))}}var AR=e("Pipeline",function(){function e(t){i(this,e),this._pipes=void 0,this._cache=_e(!0),this._pipes=t;for(var n=0;n<t.length;++n){var r=t[n];r.handle&&r.id&&(r.pipeline=this,r.next=n<t.length-1?t[n+1]:null)}}return r(e,[{key:"insertPipe",value:function(e,t){if(!e.handle||!e.id||t>this._pipes.length)G(4921);else if(this._pipes.indexOf(e)>0)G(4922);else{e.pipeline=this;var i=null;t<this._pipes.length&&(i=this._pipes[t]);var n=null;t>0&&(n=this._pipes[t-1]),n&&(n.next=e),e.next=i,this._pipes.splice(t,0,e)}}},{key:"insertPipeAfter",value:function(e,t){var i=this._pipes.indexOf(e);i<0||this.insertPipe(t,i+1)}},{key:"appendPipe",value:function(e){e.handle&&e.id&&(e.pipeline=this,e.next=null,this._pipes.length>0&&(this._pipes[this._pipes.length-1].next=e),this._pipes.push(e))}},{key:"flowIn",value:function(e){var t,i,n=this._pipes[0];if(n){for(t=0;t<e.length;t++)(i=e[t]).isScene||(this._cache[i.id]=i);for(t=0;t<e.length;t++)bR(n,i=e[t])}else for(t=0;t<e.length;t++)this.flowOut(e[t])}},{key:"flowInDeps",value:function(e,t,i){return TR.create(this,(function(e,t){i(e,t),t.destroy()})).append(t,e)}},{key:"flowOut",value:function(e){e.error?delete this._cache[e.id]:this._cache[e.id]||e.isScene||(this._cache[e.id]=e),e.complete=!0,TR.itemComplete(e)}},{key:"copyItemStates",value:function(e,t){if(t instanceof Array)for(var i=0;i<t.length;++i)t[i].states=e.states;else t.states=e.states}},{key:"getItem",value:function(e){var t=this._cache[e];return t?(t.alias&&(t=t.alias),t):t}},{key:"removeItem",value:function(e){var t=this._cache[e];return t&&t.complete&&delete this._cache[e],t}},{key:"clear",value:function(){for(var e in this._cache){var t=this._cache[e];delete this._cache[e],t.complete||(t.error=new Error("Canceled manually"),this.flowOut(t))}}}]),e}());AR.ItemState=ER,E.Pipeline=AR;var CR="MD5Pipe",wR=/(\.[^.\n\\/]*)$/,RR=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var IR=function(){function e(t,n,r){i(this,e),this.id=CR,this.async=!1,this.pipeline=null,this.md5AssetsMap=void 0,this.md5NativeAssetsMap=void 0,this.libraryBase=void 0,this.id=CR,this.async=!1,this.pipeline=null,this.md5AssetsMap=t,this.md5NativeAssetsMap=n,this.libraryBase=r}return r(e,[{key:"handle",value:function(e){var t=!1;return"ttf"===e.type&&(t=!0),e.url=this.transformURL(e.url,t),e}},{key:"transformURL",value:function(e,t){var i=function(e){var t=e.match(RR);return t?t[1]:""}(e);if(i){var n=(!e.match(this.libraryBase)?this.md5NativeAssetsMap:this.md5AssetsMap)[i];if(n)if(t){var r=E.path.dirname(e),a=E.path.basename(e);e="".concat(r,".").concat(n,"/").concat(a)}else{var o=!1;e=e.replace(wR,(function(e,t){return o=!0,"."+n+t})),o||(e=e+"."+n)}}return e}}]),e}();IR.ID=CR,AR.MD5Pipe=IR;var OR,MR=function(){function e(){i(this,e),this.jsons={}}return r(e,[{key:"load",value:function(e,t){t.length!==e.length&&V(4915);for(var i=0;i<e.length;i++){var n=e[i],r=t[i];this.jsons[n]=r}}},{key:"retrieve",value:function(e){return this.jsons[e]||null}}]),e}(),PR=function(){function e(){i(this,e),this.contents={}}return r(e,[{key:"load",value:function(e,t){var i=t.data;i.length!==e.length&&V(4915);for(var n=0;n<e.length;n++)this.contents[e[n]]={base:i[n][0],mipmaps:i[n][1]}}},{key:"retrieve",value:function(e){var t=this.contents[e];return t?{__type__:ze._getClassId(Oh),content:t}:null}}]),e}(),kR=/\?/;function DR(e){return E.game.config.noCache&&"string"==typeof e&&(kR.test(e)?e+="&_t="+(new Date-0):e+="?_t="+(new Date-0)),e}function BR(e,i){if(Array.isArray(e))for(var n=0,r=e.length;n<r;n++)BR(e[n],i);else if("object"===t(e))for(var a in e)BR(e[a],i),Number.isNaN(Number(a))||(e[i[a]]=e[a],delete e[a]);return null}!function(e){e[e.Invalid=0]="Invalid",e[e.Removed=1]="Removed",e[e.Downloading=2]="Downloading",e[e.Loaded=3]="Loaded"}(OR||(OR={}));var LR=function e(){i(this,e),this.unpacker=void 0,this.state=void 0,this.unpacker=null,this.state=OR.Invalid},NR={},FR={},zR={};function UR(e,t){return new Error("Can not retrieve "+e+" from packer "+t)}function GR(e){for(var t in FR=e,e)for(var i=e[t],n=0;n<i.length;n++){var r=i[n],a=1===i.length;qe(NR,r,t,a)}}function HR(e,t,i){var n=E.AssetLibrary.getLibUrlNoExt(t)+".json";E.loader.load({url:n,ignoreMaxConcurrency:!0},(function(n,r){if(n)return V(4916,e),i(n);var a=VR(e,t,r);a?i(null,a):i(UR(e,t))}))}function VR(e,t,i){var n=zR[t];if(n.state!==OR.Loaded){if("string"==typeof i&&(i=JSON.parse(i)),i.keys&&i.data){var r=i.keys;BR(i=i.data,r)}Array.isArray(i)?n.unpacker=new MR:i.type===Le(Oh)&&(n.unpacker=new PR),n.unpacker.load(FR[t],i),n.state=OR.Loaded}return n.unpacker.retrieve(e)}function WR(e){for(var t=OR.Invalid,i="",n=0;n<e.length;n++){var r=e[n],a=zR[r];if(a){var o=a.state;if(o===OR.Loaded)return r;o>t&&(t=o,i=r)}}return t!==OR.Invalid?i:e[0]}function jR(e,t){var i=e.uuid,n=NR[i];if(n){Array.isArray(n)&&(n=WR(n));var r=zR[n];if(r&&r.state===OR.Loaded){var a=r.unpacker.retrieve(i);return a||UR(i,n)}return r||(console.log("Create unpacker %s for %s",n,i),(r=zR[n]=new LR).state=OR.Downloading),HR(i,n,t),null}}var qR=Object.freeze({__proto__:null,initPacks:GR,_loadNewPack:HR,_doPreload:function(e,t){var i=zR[e];i||((i=zR[e]=new LR).state=OR.Downloading),i.state!==OR.Loaded&&(i.unpacker=new MR,i.unpacker.load(FR[e],t),i.state=OR.Loaded)},_doLoadNewPack:VR,_selectLoadedPack:WR,load:jR}),XR=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;var YR=Object.create(null),KR=function(){function e(t){i(this,e),this.id="SubPackPipe",this.async=!1,this.pipeline=null;var n=function(e){var i=t[e];i.uuids&&i.uuids.forEach((function(e){var t=lR(e),n=t.split("@").map((function(e){return encodeURIComponent(e)}));t=n.join("@"),YR[t]=i.path}))};for(var r in t)n(r)}return r(e,[{key:"handle",value:function(e){return e.url=this.transformURL(e.url),null}},{key:"transformURL",value:function(e){var t=function(e){var t=e.match(XR);return t?t[1]:""}(e);if(t){var i=YR[t];if(i)return e.replace("res/raw-assets/",i+"raw-assets/")}return e}}]),e}();KR.ID="SubPackPipe",AR.SubPackPipe=KR;var ZR="",QR="",JR=_e(!0);function $R(e,t){this.url=e,this.type=t}var eI,tI={_uuidToAsset:{},loadAsset:function(e,t,i){if("string"!=typeof e)return Ke(t,new Error("[AssetLibrary] uuid must be string"),null);var n={uuid:e,type:"uuid"};i&&i.existingAsset&&(n.existingAsset=i.existingAsset),E.loader.load(n,(function(e,i){e||!i?e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+(e?e.message:"Unknown error")):(i.constructor,E.SceneAsset),t&&t(e,i)}))},getLibUrlNoExt:function(e,t){var i=e.split("@").map((function(e){return encodeURIComponent(e)}));return e=i.join("@"),ZR+e.slice(0,2)+"/"+e},_queryAssetInfoInEditor:function(e,t){t(new Error("Unable to load resource: EditorExtends is not defined."))},_getAssetInfoInRuntime:function(e,t){t=t||{url:null,raw:!1};var i=JR[e];return i&&!Ce(i.type,E.Asset)?(t.url=QR+i.url,t.raw=!0):(t.url=this.getLibUrlNoExt(e)+".json",t.raw=!1),t},_uuidInSettings:function(e){return e in JR},queryAssetInfo:function(e,t){var i=this._getAssetInfoInRuntime(e);t(null,i.url,i.raw)},parseUuidInEditor:function(e){},loadJson:function(e,t){var i=""+((new Date).getTime()+Math.random()),n={uuid:i,type:"uuid",content:e,skips:[E.loader.assetLoader.id,E.loader.downloader.id]};E.loader.load(n,(function(e,n){if(e)e=new Error("[AssetLibrary] loading JSON or dependencies failed: "+e.message);else if(function(e){return e&&(e.constructor===E.SceneAsset||e instanceof E.Scene)}(n)){var r=E.loader._getReferenceKey(i);E.loader.removeItem(r)}n._uuid="",t&&t(e,n)}))},getAssetByUuid:function(e){return tI._uuidToAsset[e]||null},init:function(e){var t=e.libraryPath;t=t.replace(/\\/g,"/"),ZR=E.path.stripSep(t)+"/",QR=e.rawAssetsBase;var i=e.md5AssetsMap;if(i&&i.import){var n=0,r=_e(!0),a=i.import;for(n=0;n<a.length;n+=2){var o=lR(a[n]).split("@").map((function(e){return encodeURIComponent(e)}));r[o.join("@")]=a[n+1]}var s=_e(!0);for(a=i["raw-assets"],n=0;n<a.length;n+=2){var l=lR(a[n]).split("@").map((function(e){return encodeURIComponent(e)}));s[l.join("@")]=a[n+1]}var c=new IR(r,s,ZR);E.loader.insertPipeAfter(E.loader.assetLoader,c),E.loader.md5Pipe=c}var u=e.subPackages;if(u){E.loader.downloader.setSubPackages(u);var h=new KR(u);E.loader.insertPipeAfter(E.loader.assetLoader,h),E.loader.subPackPipe=h}var _=E.loader._assetTables;for(var d in _)_[d].reset();var f=e.rawAssets;if(f)for(var p in f){var m=f[p];for(var v in m){var g=m[v],y=g[0],x=g[1],S=De(x);if(S){JR[v]=new $R(p+"/"+y,S);var T=1===g[2];_[p]||(_[p]=new dR),_[p].add(y,v,S,!T)}else k("Cannot get",x)}}e.packedAssets&&GR(e.packedAssets),E.url._init(e.mountPaths&&e.mountPaths.assets||QR+"assets")}};E.AssetLibrary=tI,e("AssetLibrary",tI);var iI,nI,rI,aI=e("Font",ii("cc.Font")(eI=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),t}(cn))||eI);E.Font=aI;var oI,sI,lI,cI,uI,hI,_I,dI,fI=e("TTFFont",ii("cc.TTFFont")((rI=S((nI=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_fontFamily",rI,c(n)),n}return o(t,e),r(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}}]),t}(aI)).prototype,"_fontFamily",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(nI.prototype,"_nativeAsset",[Ni,Bi],Object.getOwnPropertyDescriptor(nI.prototype,"_nativeAsset"),nI.prototype),iI=nI))||iI);E.TTFFont=fI;var pI,mI=e("BitmapFont",(oI=ii("cc.BitmapFont"),sI=Li(Pd),oI((uI=S((cI=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"fntDataStr",uI,c(n)),x(n,"spriteFrame",hI,c(n)),x(n,"fontSize",_I,c(n)),x(n,"fntConfig",dI,c(n)),n}return o(t,e),t}(aI)).prototype,"fntDataStr",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hI=S(cI.prototype,"spriteFrame",[sI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_I=S(cI.prototype,"fontSize",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),dI=S(cI.prototype,"fntConfig",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lI=cI))||lI));E.BitmapFont=mI;var vI=e("LabelAtlas",ii("cc.LabelAtlas")(pI=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),t}(mI))||pI);E.LabelAtlas=vI;var gI=[],yI=function(){function e(){i(this,e),this.id="AssetLoader",this.async=!0,this.pipeline=null}return r(e,[{key:"handle",value:function(e,t){var i=e.uuid;if(!i)return e.content||null;E.AssetLibrary.queryAssetInfo(i,(function(n,r,a){if(n)t(n);else if(e.url=e.rawUrl=r,e.isRawAsset=a,a){var o=uo(r).toLowerCase();if(!o)return void t(new Error(X(4931,i,r)));o=o.substr(1);var s=TR.getQueue(e);gI[0]={queueId:e.queueId,id:r,url:r,type:o,error:null,alias:e,complete:!0},s&&s.append(gI),e.type=o,t(null,e.content)}else e.type="uuid",t(null,e.content)}))}}]),e}();function xI(e,t){var i=E.loader.getItem(e);if(i){var n=i.dependKeys;if(n)for(var r=0;r<n.length;r++){var a=n[r];t[a]||(t[a]=!0,xI(a,t))}}}function SI(e,t){if(e._uuid){var i=E.loader._getReferenceKey(e);t[i]||(t[i]=!0,xI(i,t))}}function TI(e,i){for(var n=Object.getOwnPropertyNames(e),r=0;r<n.length;r++){var a=e[n[r]];if("object"===t(a)&&a)if(Array.isArray(a))for(var o=0;o<a.length;o++){var s=a[o];s instanceof ln&&SI(s,i)}else if(a.constructor&&a.constructor!==Object)a instanceof ln&&SI(a,i);else for(var l=Object.getOwnPropertyNames(a),c=0;c<l.length;c++){var u=a[l[c]];u instanceof ln&&SI(u,i)}}}function EI(e,t){for(var i=0;i<e._components.length;i++)TI(e._components[i],t);for(var n=0;n<e._children.length;n++)EI(e._children[n],t)}function bI(e){var t={};return xI(e,t),Object.keys(t)}function AI(e,t){var i=e.url,n=E.loader.getXMLHttpRequest(),r="Load binary data failed: "+i;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;e?t(null,e):t({status:n.status,errorMessage:r+"(no response)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}function CI(e,t){var i=e.url;i=DR(i);var n=E.loader.getXMLHttpRequest(),r="Load text file failed: "+i;n.open("GET",i,!0),n.overrideMimeType&&n.overrideMimeType("text/plain; charset=utf-8"),n.onload=function(){4===n.readyState?200===n.status||0===n.status?t(null,n.responseText):t({status:n.status,errorMessage:r+"(wrong status)"}):t({status:n.status,errorMessage:r+"(wrong readyState)"})},n.onerror=function(){t({status:n.status,errorMessage:r+"(error)"})},n.ontimeout=function(){t({status:n.status,errorMessage:r+"(time out)"})},n.send(null)}yI.ID="AssetLoader",AR.AssetLoader=yI;var wI=Gn.__videoSupport,RI=wI&&wI.format;function II(){return null}function OI(e,t,i){var n=e.url,r=document,a=document.createElement("script");function o(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",o,!1),a.removeEventListener("error",s,!1),t(null,n)}function s(){a.parentNode&&a.parentNode.removeChild(a),a.removeEventListener("load",o,!1),a.removeEventListener("error",s,!1),t(new Error(X(4928,n)))}a.async=!!i,a.src=DR(n),a.addEventListener("load",o,!1),a.addEventListener("error",s,!1),r.body.appendChild(a)}function MI(e,t,i,n){void 0===i&&(i=!0);var r=DR(e.url);function a(){n.removeEventListener("load",a),n.removeEventListener("error",o),n.id=e.id,t(null,n)}function o(){n.removeEventListener("load",a),n.removeEventListener("error",o),"https:"!==window.location.protocol&&n.crossOrigin&&"anonymous"===n.crossOrigin.toLowerCase()?MI(e,t,!1,n):t(new Error(X(4930,r)))}if(n=n||new Image,i&&"file:"!==window.location.protocol?n.crossOrigin="anonymous":n.crossOrigin=null,n.complete&&n.naturalWidth>0&&n.src===r)return n;n.addEventListener("load",a),n.addEventListener("error",o),n.src=r}var PI={js:OI,png:MI,jpg:MI,bmp:MI,jpeg:MI,gif:MI,ico:MI,tiff:MI,webp:MI,image:MI,pvr:AI,pkm:AI,astc:AI,mp3:Pr,ogg:Pr,wav:Pr,m4a:Pr,mp4:function(e,t){if(!RI||0===RI.length)return new Error(X(7703));var i=document.createElement("video"),n=document.createElement("source");i.appendChild(n);var r=new XMLHttpRequest;r.open("GET",e.url,!0),r.responseType="blob",r.onload=function(){200===this.status&&(n.src=URL.createObjectURL(this.response),t(null,i))},r.onerror=function(){var i="load video failure - "+e.url;M(i),t(i)},r.send()},txt:CI,xml:CI,vsh:CI,fsh:CI,atlas:CI,tmx:CI,tsx:CI,json:CI,ExportJson:CI,plist:CI,fnt:CI,font:II,eot:II,ttf:II,woff:II,svg:II,ttc:II,uuid:function(e,t){var i=jR(e,t);return void 0===i?this.extMap.json(e,t):i||void 0},binary:AI,bin:AI,default:CI},kI=e("Downloader",function(){function e(t){i(this,e),this.id="Downloader",this.async=!0,this.pipeline=null,this.extMap=void 0,this._curConcurrent=0,this._loadQueue=[],this._subPackages={},this.extMap=Ee(t,PI)}return r(e,[{key:"setSubPackages",value:function(e){this._subPackages=e}},{key:"addHandlers",value:function(e){Ee(this.extMap,e)}},{key:"_handleLoadQueue",value:function(){for(;this._curConcurrent<E.macro.DOWNLOAD_MAX_CONCURRENT;){var e=this._loadQueue.shift();if(!e)break;var t=this.handle(e.item,e.callback);void 0!==t&&(t instanceof Error?e.callback(t):e.callback(null,t))}}},{key:"handle",value:function(e,t){var i=this,n=this.extMap[e.type]||this.extMap.default,r=void 0;if(this._curConcurrent<E.macro.DOWNLOAD_MAX_CONCURRENT){if(this._curConcurrent++,void 0!==(r=n.call(this,e,(function(e,n){i._curConcurrent=Math.max(0,i._curConcurrent-1),i._handleLoadQueue(),t&&t(e,n)}))))return this._curConcurrent=Math.max(0,this._curConcurrent-1),this._handleLoadQueue(),r}else if(e.ignoreMaxConcurrency){if(void 0!==(r=n.call(this,e,t)))return r}else this._loadQueue.push({item:e,callback:t})}},{key:"loadSubpackage",value:function(e,t){var i=this._subPackages[e];i?i.loaded?t&&t():OI({url:i.path},(function(e){e||(i.loaded=!0),t&&t(e)})):t&&t(new Error("Can't find subpackage ".concat(e)))}}]),e}());kI.ID="Downloader",kI.PackDownloader=qR,AR.Downloader=kI;var DI=new(function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"parse",value:function(e){var t=this._parseXML(e),i=t.documentElement;if("plist"!==i.tagName)return G(5100),{};for(var n=null,r=0,a=i.childNodes.length;r<a&&1!==(n=i.childNodes[r]).nodeType;r++);return t=null,this._parseNode(n)}},{key:"_parseNode",value:function(e){var t=null,i=e.tagName;if("dict"===i)t=this._parseDict(e);else if("array"===i)t=this._parseArray(e);else if("string"===i)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var n=0;n<e.childNodes.length;n++)t+=e.childNodes[n].nodeValue}else"false"===i?t=!1:"true"===i?t=!0:"real"===i?t=parseFloat(e.firstChild.nodeValue):"integer"===i&&(t=parseInt(e.firstChild.nodeValue,10));return t}},{key:"_parseArray",value:function(e){for(var t=[],i=0,n=e.childNodes.length;i<n;i++){var r=e.childNodes[i];1===r.nodeType&&t.push(this._parseNode(r))}return t}},{key:"_parseDict",value:function(e){for(var t={},i=null,n=0,r=e.childNodes.length;n<r;n++){var a=e.childNodes[n];1===a.nodeType&&("key"===a.tagName?i=a.firstChild.nodeValue:t[i]=this._parseNode(a))}return t}}]),t}(function(){function e(){i(this,e),this._isSupportDOMParser=void 0,this._parser=void 0,window.DOMParser?(this._isSupportDOMParser=!0,this._parser=new DOMParser):(this._isSupportDOMParser=!1,this._parser=null)}return r(e,[{key:"parse",value:function(e){return this._parseXML(e)}},{key:"_parseXML",value:function(e){var t;return this._isSupportDOMParser?t=this._parser.parseFromString(e,"text/xml"):((t=new ActiveXObject("Microsoft.XMLDOM")).async="false",t.loadXML(e)),t}}]),e}()));function BI(e){return e&&(e[0]&&"cc.Scene"===e[0].__type__||e[1]&&"cc.Scene"===e[1].__type__||e[0]&&"cc.Prefab"===e[0].__type__)}function LI(e,i){var n,r;if("string"==typeof e.content)try{if((n=JSON.parse(e.content)).keys&&n.data){var a=n.keys;BR(n=n.data,a)}}catch(t){return new Error(X(4923,e.id,t.stack))}else{if("object"!==t(e.content))return new Error(X(4924));n=e.content}if(null==n)return new Error(X(4923,e.id));var o=BI(n);r=o?E._MissingScript.safeFindClass:function(e){var t=De(e);return t||(G(4903,e),Object)};var s,l=E.deserialize.Details.pool.get();try{s=E.deserialize(n,l,{classFinder:r,target:e.existingAsset,customEnv:e})}catch(t){return E.deserialize.Details.pool.put(l),console.error(t),new Error("Failed to load asset ".concat(e.id,", exception occurs during deserialization: ").concat(t.stack,"."))}s._uuid=e.uuid;var c=function(e,t,i,n){var r,a,o,s=i.uuidList,l=i.uuidObjList,c=i.uuidPropList,u=i._stillUseUrl,h=e.dependKeys=[];if(n)for(r=[],a=0;a<s.length;a++){o=s[a];var _=l[a],d=c[a],f=E.AssetLibrary._getAssetInfoInRuntime(o);if(f.raw){var p=f.url;_[d]=p,h.push(p)}else r.push({type:"uuid",uuid:o,deferredLoadRaw:!0,_owner:_,_ownerProp:d,_stillUseUrl:u[a]})}else{for(r=new Array(s.length),a=0;a<s.length;a++)o=s[a],r[a]={type:"uuid",uuid:o,_owner:l[a],_ownerProp:c[a],_stillUseUrl:u[a]};t._native&&!t.constructor.preventPreloadNativeObject&&r.push({url:t.nativeUrl,_owner:t,_ownerProp:"_nativeAsset"})}return r}(e,s,l,function(e,t,i){var n=t.deferredLoadRaw;return n?e instanceof E.Asset&&e.constructor.preventDeferredLoadDependents&&(n=!1):i&&(e instanceof E.SceneAsset||e instanceof E.Prefab)&&(n=e.asyncLoadAssets),n}(s,e,o));E.deserialize.Details.pool.put(l);var u=function(e,t){if(!e&&t.onLoaded)try{t.onLoaded()}catch(t){e=t}i(e,t)};if(0===c.length)return u(null,s);!function(e,t,i,n,r){t.content=i;var a=t.dependKeys;e.flowInDeps(t,n,(function(e,t){var o,s=t.map;for(var l in s)(o=s[l]).uuid&&o.content&&(o.content._uuid=o.uuid);for(var c=0;c<n.length;c++){var u=function(e){var t=e.content;this._stillUseUrl&&(t=t?t.nativeUrl:e.rawUrl),this._owner[this._ownerProp]=t,e.uuid!==i._uuid&&a.indexOf(e.id)<0&&a.push(e.id)},h=n[c],_=h.uuid,d=h.url;h._owner,h._ownerProp;if(o=s[d]){var f=h;if(o.complete||o.content)o.error?E._throw(o.error):u.call(f,o);else{var p=TR.getQueue(o);p&&p.addListener(_,u,f)}}}i instanceof E.SceneAsset&&i.scene&&function(){for(var e=Object.create(null),t=0,n=a.length;t<n;t++)e[a[t]]=!0,bI(a[t]).forEach((function(t){e[t]=!0}));i.scene.dependAssets=Object.keys(e)}(),r(e,i)}))}(this.pipeline,e,s,c,u)}LI.isSceneObj=BI;var NI,FI=null,zI={},UI=-1,GI=[],HI=function(){if(!NI)if(window.FontFace){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);NI=e?parseInt(e[1],10)>42:!t}else NI=!1;return NI};function VI(){for(var e=!0,t=Date.now(),i=GI.length-1;i>=0;i--){var n=GI[i],r=n.fontFamilyName;if(t-n.startTime>3e3)G(4933,r),n.callback(null,r),GI.splice(i,1);else{var a=n.refWidth;FI.font="40px "+r,a!==Eu(FI,"BES bswy:->@123")?(GI.splice(i,1),n.callback(null,r)):e=!1}}e&&(clearInterval(UI),UI=-1)}function WI(e,t){var i=e.url,n=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var i,n=e.lastIndexOf("/");i=-1===n?e.substring(0,t)+"_LABEL":e.substring(n+1,t)+"_LABEL";-1!==i.indexOf(" ")&&(i='"'+i+'"');return i}(i);if(zI[n])return n;if(!FI){var r=document.createElement("canvas");r.width=100,r.height=100,FI=r.getContext("2d")}var a="40px "+n;FI.font=a;var o=Eu(FI,"BES bswy:->@123"),s=document.createElement("style");s.type="text/css";var l="";isNaN(n-0)?l+="@font-face { font-family:"+n+"; src:":l+="@font-face { font-family:'"+n+"'; src:",l+="url('"+i+"');",s.textContent=l+"}",document.body.appendChild(s);var c=document.createElement("div"),u=c.style;if(u.fontFamily=n,c.innerHTML=".",u.position="absolute",u.left="-100px",u.top="-100px",document.body.appendChild(c),HI())!function(e,t,i){var n,r=new Promise((function(i,n){!function r(){Date.now()-e>=3e3?n():document.fonts.load("40px "+t).then((function(e){e.length>=1?i():setTimeout(r,100)}),(function(){n()}))}()})),a=new Promise((function(e,t){n=setTimeout(t,3e3)}));Promise.race([a,r]).then((function(){n&&(clearTimeout(n),n=null),i(null,t)}),(function(){G(4933,t),i(null,t)}))}(Date.now(),n,t);else{var h={fontFamilyName:n,refWidth:o,callback:t,startTime:Date.now()};GI.push(h),-1===UI&&(UI=setInterval(VI,100))}zI[n]=s}function jI(e){if("string"!=typeof e.content)return new Error("JSON Loader: Input item doesn't contain string content");try{return JSON.parse(e.content)}catch(t){return new Error("JSON Loader: Parse json ["+e.id+"] failed : "+t)}}function qI(e){if(e._owner instanceof E.Asset)return null;var t=e.content;if(E.sys.platform!==E.sys.FB_PLAYABLE_ADS&&!(t instanceof Image))return new Error("Image Loader: Input item doesn't contain Image content");var i=e.rawUrl,n=e.imageAsset||new $u;return n._uuid=e.uuid,n._url=i,n._setRawAsset(i,!1),n._nativeAsset=t,n}function XI(e,t){if(e._owner instanceof E.Asset)return null;var i=new E.AudioClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i}function YI(e){return e.load?e.load(e.content):e.content}function KI(e,t){return e[t]<<8|e[t+1]}var ZI={png:qI,jpg:qI,bmp:qI,jpeg:qI,gif:qI,ico:qI,tiff:qI,webp:qI,image:qI,pvr:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Int32Array(t,0,13);if(55727696===i[0]){var n=i[7],r=i[6],a=i[12]+52;return t=t.slice(a,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:n,height:r}}if(559044176===i[11]){var o=i[0],s=i[1],l=i[2];return t=t.slice(o,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:l,height:s}}return new Error("Invalid magic number in PVR header")},pkm:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t),n=KI(i,6);if(0!==n&&1!==n&&3!==n)return new Error("Invalid magic number in ETC header");var r=KI(i,12),a=KI(i,14);return KI(i,8),KI(i,10),t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:r,height:a}},astc:function(e){var t=e.content instanceof ArrayBuffer?e.content:e.content.buffer,i=new Uint8Array(t);if(1554098963!==i[0]+(i[1]<<8)+(i[2]<<16)+(i[3]<<24))return new Error("Invalid magic number in ASTC header");var n=i[4],r=i[5],a=i[6];if((n<3||n>6||r<3||r>6||a<3||a>6)&&(n<4||7===n||9===n||11===n||n>12||r<4||7===r||9===r||11===r||r>12||1!==a))return new Error("Invalid block number in ASTC header");var o=function(e,t){return 4===e?Wu.RGBA_ASTC_4x4:5===e?4===t?Wu.RGBA_ASTC_5x4:Wu.RGBA_ASTC_5x5:6===e?5===t?Wu.RGBA_ASTC_6x5:Wu.RGBA_ASTC_6x6:8===e?5===t?Wu.RGBA_ASTC_8x5:6===t?Wu.RGBA_ASTC_8x6:Wu.RGBA_ASTC_8x8:10===e?5===t?Wu.RGBA_ASTC_10x5:6===t?Wu.RGBA_ASTC_10x6:8===t?Wu.RGBA_ASTC_10x8:Wu.RGBA_ASTC_10x10:10===t?Wu.RGBA_ASTC_12x10:Wu.RGBA_ASTC_12x12}(n,r),s=i[7]+(i[8]<<8)+(i[9]<<16),l=i[10]+(i[11]<<8)+(i[12]<<16);return t=t.slice(16,t.byteLength),{_data:new Uint8Array(t),_compressed:!0,width:s,height:l,format:o}},mp3:XI,ogg:XI,wav:XI,m4a:XI,mp4:function(e,t){if(e._owner instanceof E.Asset)return null;var i=new E.VideoClip;return i._setRawAsset(e.rawUrl,!1),i._nativeAsset=e.content,i},json:jI,ExportJson:jI,plist:function(e){if("string"!=typeof e.content)return new Error("Plist Loader: Input item doesn't contain string content");var t=DI.parse(e.content);return t||new Error("Plist Loader: Parse ["+e.id+"] failed")},uuid:LI,prefab:LI,fire:LI,scene:LI,binary:YI,bin:YI,font:WI,eot:WI,ttf:WI,woff:WI,svg:WI,ttc:WI,default:function(){return null}},QI=e("Loader",function(){function e(t){i(this,e),this.id="Loader",this.async=!0,this.pipeline=null,this.extMap=void 0,this.extMap=Ee(t,ZI)}return r(e,[{key:"addHandlers",value:function(e){this.extMap=Ee(this.extMap,e)}},{key:"handle",value:function(e,t){return(this.extMap[e.type]||this.extMap.default).call(this,e,t)}}]),e}());QI.ID="Loader",AR.Loader=QI;var JI=Object.create(null);function $I(){return window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")}JI.assets=new dR,JI.internal=new dR;var eO={url:null,raw:!1};function tO(e){var i,n,r;if("object"===t(e)){if(n=e,e.url)return n;i=e.uuid}else n={},i=e;return r=n.type?"uuid"===n.type:E.AssetLibrary._uuidInSettings(i),E.AssetLibrary._getAssetInfoInRuntime(i,eO),n.url=r?eO.url:i,eO.url&&"uuid"===n.type&&eO.raw?(n.type=null,n.isRawAsset=!0):r||(n.isRawAsset=!0),n}var iO=[],nO=[],rO=function(e){function n(){var e;i(this,n);var t=new yI,r=new kI,a=new QI;return(e=u(this,s(n).call(this,[t,r,a]))).getXMLHttpRequest=void 0,e.assetLoader=void 0,e.md5Pipe=void 0,e.downloader=void 0,e.loader=void 0,e.onProgress=void 0,e._assetTables=void 0,e._autoReleaseSetting=void 0,e._releasedAssetChecker_DEBUG=void 0,e.getXMLHttpRequest=$I,e.assetLoader=t,e.md5Pipe=null,e.downloader=r,e.loader=a,e.onProgress=null,e._assetTables=JI,e._autoReleaseSetting=_e(!0),e}return o(n,e),r(n,[{key:"init",value:function(e){}},{key:"addDownloadHandlers",value:function(e){this.downloader.addHandlers(e)}},{key:"addLoadHandlers",value:function(e){this.loader.addHandlers(e)}},{key:"load",value:function(e,t,i){void 0===i&&(i=t,t=this.onProgress||null);var n,r,a=this,o=!1;e instanceof Array?n=e:e?(o=!0,n=[e]):n=[],iO.length=0;for(var s=0;s<n.length;++s){var l=n[s];if(l&&l.id&&(G(4920,l.id),l.uuid||l.url||(l.url=l.id)),(r=tO(l)).url||r.uuid){var c=this._cache[r.url];iO.push(c||r)}}var u=TR.create(this,t,(function(e,t){Ke((function(){if(i){if(o){var n=r.url;i.call(a,t.getError(n),t.getContent(n))}else i.call(a,e,t);i=null}t.destroy()}))}));TR.initQueueDeps(u),u.append(iO),iO.length=0}},{key:"flowInDeps",value:function(e,t,i){nO.length=0;for(var n=0;n<t.length;++n){var r=tO(t[n]);if(r.url||r.uuid){var a=this._cache[r.url];a?nO.push(a):nO.push(r)}}var o=TR.create(this,e?function(e,t,i){o._ownerQueue&&o._ownerQueue.onProgress&&o._ownerQueue._childOnProgress(i)}:null,(function(t,n){i(t,n),e&&e.deps&&(e.deps.length=0),n.destroy()}));if(e){var s=TR.getQueue(e);o._ownerQueue=s&&s._ownerQueue||s}var l=o.append(nO,e);return nO.length=0,l}},{key:"loadRes",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var o=this,s=o._getResUuid(e,t,i,!0);s?this.load({type:"uuid",uuid:s},n,(function(e,t){t&&o.setAutoReleaseRecursively(s,!1),r&&r(e,t)})):o._urlNotFound(e,t,r)}},{key:"loadResDir",value:function(e,t,i,n,r){if(5!==arguments.length&&(r=n,n=i,i="assets"),JI[i]){var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;var o=[],s=JI[i].getUuidArray(e,t,o);this._loadResUuids(s,n,(function(e,t,i){for(var n=t.length,a=0;a<n;++a)if(t[a]instanceof Jw){var o=t[a].getSpriteFrames();for(var s in o){var l=o[s];t.push(l),i&&i.push("".concat(i[a],"/").concat(l.name))}}r&&r(e,t,i)}),o)}}},{key:"loadResArray",value:function(e,t,i,n,r){5!==arguments.length&&(r=n,n=i,i="assets");var a=this._parseLoadResArgs(t,n,r);t=a.type,n=a.onProgress,r=a.onComplete;for(var o=[],s=0;s<e.length;s++){var l=e[s],c=this._getResUuid(l,t,i,!0);if(!c)return void this._urlNotFound(l,t,r);o.push(c)}this._loadResUuids(o,n,r)}},{key:"getRes",value:function(e,t){var i=this._cache[e];if(!i){var n=this._getResUuid(e,t,null,!0);if(!n)return null;var r=this._getReferenceKey(n);i=this._cache[r]}return i&&i.alias&&(i=i.alias),i&&i.complete?i.content:null}},{key:"getResCount",value:function(){return Object.keys(this._cache).length}},{key:"getDependsRecursively",value:function(e){if(e){var t=this._getReferenceKey(e),i=bI(t);return i.push(t),i}return[]}},{key:"release",value:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];this.release(i)}else if(e){var n=this._getReferenceKey(e),r=this.getItem(n);if(r){this.removeItem(n);if((e=r.content)instanceof cn){var a=e.nativeUrl;a&&this.release(a),e.destroy()}}}}},{key:"releaseAsset",value:function(e){var t=e._uuid;t&&this.release(t)}},{key:"releaseRes",value:function(e,t,i){var n=this._getResUuid(e,t,i,!0);n?this.release(n):V(4914,e)}},{key:"releaseResDir",value:function(e,t,i){if(JI[i=i||"assets"])for(var n=JI[i].getUuidArray(e,t),r=0;r<n.length;r++){var a=n[r];this.release(a)}}},{key:"releaseAll",value:function(){for(var e in this._cache)this.release(e)}},{key:"removeItem",value:function(e){var t=AR.prototype.removeItem.call(this,e);return delete this._autoReleaseSetting[e],t}},{key:"setAutoRelease",value:function(e,t){var i=this._getReferenceKey(e);i&&(this._autoReleaseSetting[i]=!!t)}},{key:"setAutoReleaseRecursively",value:function(e,t){t=!!t;var i=this._getReferenceKey(e);if(i){this._autoReleaseSetting[i]=t;for(var n=bI(i),r=0;r<n.length;r++){var a=n[r];this._autoReleaseSetting[a]=t}}}},{key:"isAutoRelease",value:function(e){var t=this._getReferenceKey(e);return!!t&&!!this._autoReleaseSetting[t]}},{key:"_getResUuid",value:function(e,t,i,n){var r="",a=JI[i=i||"assets"];if(e&&a){var o=e.indexOf("?");if(-1!==o&&(e=e.substr(0,o)),!(r=a.getUuid(e,t))){var s=uo(e);s&&(e=e.slice(0,-s.length),(r=a.getUuid(e,t))&&!n&&G(4901,e,s))}}return!r&&t&&(Ce(t,Pd)||Ce(t,Oh)||Ce(t,kd))&&G(4934),r}},{key:"_getReferenceKey",value:function(e){var i;return"object"===t(e)?i=e._uuid||null:"string"==typeof e&&(i=this._getResUuid(e,void 0,void 0,!0)||e),i?(E.AssetLibrary._getAssetInfoInRuntime(i,eO),this._cache[eO.url]?eO.url:i):(G(4800,e),i)}},{key:"_urlNotFound",value:function(e,t,i){Ke((function(){e=E.url.normalize(e);var n="".concat(t?de(t):"Asset",' in "resources/').concat(e,'" does not exist.');i&&i(new Error(n),[])}))}},{key:"_parseLoadResArgs",value:function(e,t,i){if(void 0===i){var n=Ce(e,E.RawAsset);t?(i=t,n&&(t=this.onProgress||null)):void 0!==t||n||(i=e,t=this.onProgress||null,e=null),void 0===t||n||(t=e,e=null)}return{type:e,onProgress:t,onComplete:i}}},{key:"_loadResUuids",value:function(e,t,i,n){if(e.length>0){var r=this,a=e.map((function(e){return{type:"uuid",uuid:e}}));this.load(a,t,(function(e,t){if(i){for(var o=[],s=n&&[],l=0;l<a.length;++l){var c=a[l].uuid,u=r._getReferenceKey(c),h=t.getContent(u);h&&(r.setAutoReleaseRecursively(c,!1),o.push(h),s&&s.push(n[l]))}n?i(e,o,s):i(e,o)}}))}else i&&Ke((function(){n?i(null,[],[]):i(null,[])}))}}]),n}(AR),aO=e("loader",E.loader=new rO);var oO,sO,lO,cO,uO,hO,_O,dO,fO=Object.freeze({__proto__:null,loadImage:function(e,t,i){q(!!e,3103);var n=aO.getRes(e);return n?n.loaded?(t&&t.call(i,null,n),n):(n.once("load",(function(){t&&t.call(i,null,n)}),i),n):(n=new $u,aO.load({url:e,imageAsset:n},(function(e,r){if(e)return t&&t.call(i,e||new Error("Unknown error")),n;t&&t.call(i,null,r)})),n)},cacheImage:function(e,t){if(e&&t){var i=new $u(t),n={id:e,url:e,error:null,content:i,complete:!1};return aO.flowOut(n),i}},postLoadImage:function(e,t){e.loaded?t&&t():e.nativeUrl?aO.load({url:e.nativeUrl,skips:e.isCompressed?void 0:["Loader"]},(function(i,n){n&&(e.loaded||(e._nativeAsset=n)),t&&t(i)})):t&&t()}});e("textureUtil",fO);var pO=e("Skeleton",(oO=ii("cc.Skeleton"),sO=Li([pt]),lO=Li([Ta]),oO((hO=S((uO=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_joints",hO,c(n)),x(n,"_bindposes",_O,c(n)),x(n,"_hash",dO,c(n)),n._invBindposes=null,n}return o(t,e),r(t,[{key:"destroy",value:function(){return E.director.root.dataPoolManager.releaseSkeleton(this),_(s(t.prototype),"destroy",this).call(this)}},{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new Ta;Ta.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var i=this._bindposes[t];e+=i.m00.toPrecision(2)+" "+i.m01.toPrecision(2)+" "+i.m02.toPrecision(2)+" "+i.m03.toPrecision(2)+" "+i.m04.toPrecision(2)+" "+i.m05.toPrecision(2)+" "+i.m06.toPrecision(2)+" "+i.m07.toPrecision(2)+" "+i.m08.toPrecision(2)+" "+i.m09.toPrecision(2)+" "+i.m10.toPrecision(2)+" "+i.m11.toPrecision(2)+" "+i.m12.toPrecision(2)+" "+i.m13.toPrecision(2)+" "+i.m14.toPrecision(2)+" "+i.m15.toPrecision(2)+"\n"}this._hash=rl(e,666)}return this._hash}}]),t}(cn)).prototype,"_joints",[sO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_O=S(uO.prototype,"_bindposes",[lO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dO=S(uO.prototype,"_hash",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cO=uO))||cO));E.Skeleton=pO,ka($_.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),Da($_.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]),Da(yh.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),ka(om.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]),E.textureUtil=fO;var mO={topLeft:E.v2(0,0),topRight:E.v2(0,0),top:E.v2(0,0),bottomLeft:E.v2(0,0),bottomRight:E.v2(0,0),bottom:E.v2(0,0),center:E.v2(0,0),left:E.v2(0,0),right:E.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,a=r+i,o=n+t;this.topLeft.x=n,this.topLeft.y=a,this.topRight.x=o,this.topRight.y=a,this.top.x=n+t/2,this.top.y=a,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=o,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=o,this.right.y=r+i/2}};E.visibleRect=mO;var vO=new ia,gO=e("Touch",function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;i(this,e),this._point=new ia,this._prevPoint=new ia,this._lastModified=0,this._id=0,this._startPoint=new ia,this._startPointCaptured=!1,this.setTouchInfo(r,t,n)}return r(e,[{key:"lastModified",get:function(){return this._lastModified}}]),r(e,[{key:"getLocation",value:function(e){return e||(e=new ia),e.set(this._point.x,this._point.y),e}},{key:"getLocationX",value:function(){return this._point.x}},{key:"getLocationY",value:function(){return this._point.y}},{key:"getUILocation",value:function(e){return e||(e=new ia),e.set(this._point.x,this._point.y),E.view._convertPointWithScale(e),e}},{key:"getUILocationX",value:function(){var e=E.view.getViewportRect();return(this._point.x-e.x)/E.view.getScaleX()}},{key:"getUILocationY",value:function(){var e=E.view.getViewportRect();return(this._point.y-e.y)/E.view.getScaleY()}},{key:"getPreviousLocation",value:function(e){return e||(e=new ia),e.set(this._prevPoint.x,this._prevPoint.y),e}},{key:"getUIPreviousLocation",value:function(e){return e||(e=new ia),e.set(this._prevPoint.x,this._prevPoint.y),E.view._convertPointWithScale(e),e}},{key:"getStartLocation",value:function(e){return e||(e=new ia),e.set(this._startPoint.x,this._startPoint.y),e}},{key:"getUIStartLocation",value:function(e){return e||(e=new ia),e.set(this._startPoint.x,this._startPoint.y),E.view._convertPointWithScale(e),e}},{key:"getDelta",value:function(e){return e||(e=new ia),e.set(this._point),e.subtract(this._prevPoint),e}},{key:"getUIDelta",value:function(e){return e||(e=new ia),vO.set(this._point),vO.subtract(this._prevPoint),e.set(E.view.getScaleX(),E.view.getScaleY()),ia.divide(e,vO,e),e}},{key:"getLocationInView",value:function(e){return e||(e=new ia),e.set(this._point.x,E.view._designResolutionSize.height-this._point.y),e}},{key:"getPreviousLocationInView",value:function(e){return e||(e=new ia),e.set(this._prevPoint.x,E.view._designResolutionSize.height-this._prevPoint.y),e}},{key:"getStartLocationInView",value:function(e){return e||(e=new ia),e.set(this._startPoint.x,E.view._designResolutionSize.height-this._startPoint.y),e}},{key:"getID",value:function(){return this._id}},{key:"setTouchInfo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;this._prevPoint=this._point,this._point=new ia(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new ia(this._point),this._startPointCaptured=!0)}},{key:"setPoint",value:function(e,i){"object"===t(e)?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=i||0),this._lastModified=E.director.getCurrentTime()}},{key:"setPrevPoint",value:function(e,i){"object"===t(e)?this._prevPoint=new ia(e.x,e.y):this._prevPoint=new ia(e||0,i||0),this._lastModified=E.director.getCurrentTime()}}]),e}());E.Touch=gO;var yO,xO=Sh.TOUCH_TIMEOUT,SO=new ia,TO=new ia,EO=e("Acceleration",(function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;i(this,e),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=n,this.z=r,this.timestamp=a}));E.internal.Acceleration=EO;var bO=new(function(){function e(){i(this,e),this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new ia,this._prevMousePoint=new ia,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._pointLocked=!1}return r(e,[{key:"handleTouchesBegin",value:function(e){for(var t=[],i=this._touchesIntegerDict,n=0;n<e.length;++n){var r=e[n],a=r.getID();if(null!==a)if(void 0===i[a]){var o=this._getUnUsedIndex();if(-1===o){z(2300,o);continue}r.getLocation(SO);var s=new gO(SO.x,SO.y,a);this._touches[o]=s,r.getPreviousLocation(SO),s.setPrevPoint(SO),i[a]=o,t.push(s)}}if(t.length>0){var l=new dm(t,!1,dm.BEGAN,Sh.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Am.dispatchEvent(l)}}},{key:"handleTouchesMove",value:function(e){for(var t=[],i=this._touches,n=0;n<e.length;++n){var r=e[n],a=r.getID();if(null!==a){var o=this._touchesIntegerDict[a];void 0!==o&&i[o]&&(r.getLocation(SO),i[o].setPoint(SO),r.getPreviousLocation(SO),i[o].setPrevPoint(SO),t.push(i[o]))}}if(t.length>0){var s=new dm(t,!1,dm.MOVED,Sh.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Am.dispatchEvent(s)}}},{key:"handleTouchesEnd",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new dm(t,!1,dm.ENDED,Sh.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Am.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"handleTouchesCancel",value:function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new dm(t,!1,dm.CANCELLED,Sh.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);Am.dispatchEvent(i)}this._preTouchPool.length=0}},{key:"getSetOfTouchesEndOrCancel",value:function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var a=e[r],o=a.getID();if(null!==o){var s=n[o];void 0!==s&&i[s]&&(a.getLocation(SO),i[s].setPoint(SO),a.getPreviousLocation(SO),i[s].setPrevPoint(SO),t.push(i[s]),this._removeUsedIndexBit(s),delete n[o])}}return t}},{key:"getHTMLElementPosition",value:function(e){var t=document.documentElement,i=Gn.os===Gn.OS_IOS&&Gn.isBrowser?window.screenLeft:window.pageXOffset;i-=t.clientLeft;var n=Gn.os===Gn.OS_IOS&&Gn.isBrowser?window.screenTop:window.pageYOffset;if(n-=t.clientTop,e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}}},{key:"getPreTouch",value:function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){t=i[r];break}return t||(t=e),t}},{key:"setPreTouch",value:function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}},{key:"getTouchByXY",value:function(e,t,i,n){var r=this._preTouchPoint,a=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(a.x=r.x+e.movementX,a.y=r.y-e.movementY);var o=new gO(a.x,a.y,0);return o.setPrevPoint(r.x,r.y),r.x=a.x,r.y=a.y,o}},{key:"getMouseEvent",value:function(e,t,i){var n=this._prevMousePoint,r=new _m(i,!1,n);return n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r}},{key:"getPointByEvent",value:function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop,{x:e.clientX,y:e.clientY})}},{key:"getTouchesByEvent",value:function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,a=e.changedTouches.length,o=0;o<a;o++){var s=e.changedTouches[o];if(s){var l=void 0;l=Gn.BROWSER_TYPE_FIREFOX===Gn.browserType?n.convertToLocationInView(s.pageX,s.pageY,t,SO):n.convertToLocationInView(s.clientX,s.clientY,t,SO);var c=void 0;if(null!=s.identifier?(c=new gO(l.x,l.y,s.identifier),this.getPreTouch(c).getLocation(TO),c.setPrevPoint(TO.x,TO.y),this.setPreTouch(c)):(c=new gO(l.x,l.y)).setPrevPoint(r.x,r.y),r.x=l.x,r.y=l.y,i.push(c),!Sh.ENABLE_MULTI_TOUCH)break}}return i}},{key:"registerSystemEvent",value:function(e){if(!this._isRegisterEvent&&e){this._glView=E.view;var t=Gn.isMobile,i="mouse"in Gn.capabilities,n="touches"in Gn.capabilities;i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),this._registerKeyboardEvent(),this._isRegisterEvent=!0}}},{key:"setAccelerometerEnabled",value:function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=E.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}}},{key:"didAccelerate",value:function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;a&&(i=this._accelMinus*(a.x||0)*.1,n=this._accelMinus*(a.y||0)*.1,r=.1*(a.z||0))}else{var o=e;i=(o.gamma||0)/90*.981,n=-(o.beta||0)/90*.981,r=(o.alpha||0)/90*.981}if(E.view._isRotated){var s=i;i=-n,n=s}t.x=i,t.y=n,t.z=r,t.timestamp=e.timeStamp||Date.now();var l=t.x;90===window.orientation?(t.x=-t.y,t.y=l):-90===window.orientation?(t.x=t.y,t.y=-l):180===window.orientation&&(t.x=-t.x,t.y=-t.y),E.sys.os===E.sys.OS_ANDROID&&E.sys.browserType!==E.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}}},{key:"update",value:function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,Am.dispatchEvent(new fm(this._acceleration))),this._accelCurTime+=e}},{key:"setAccelerometerInterval",value:function(e){this._accelInterval!==e&&(this._accelInterval=e)}},{key:"_getUnUsedIndex",value:function(){for(var e=this._indexBitsUsed,t=E.director.getCurrentTime(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n.lastModified>xO){this._removeUsedIndexBit(i);var r=n.getID();return null!==r&&delete this._touchesIntegerDict[r],i}e>>=1}return-1}},{key:"_removeUsedIndexBit",value:function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}}},{key:"_registerMouseEvents",value:function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)}},{key:"_registerPointerLockEvent",value:function(){var e=this,t=function(){var t=E.game.canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)}},{key:"_registerWindowMouseEvents",value:function(e){var t=this;window.addEventListener("mousedown",(function(){t._mousePressed=!0}),!1),window.addEventListener("mouseup",(function(i){if(t._mousePressed){t._mousePressed=!1;var n=t.getHTMLElementPosition(e),r=t.getPointByEvent(i,n);if(!Oa(n.left,n.top,n.width,n.height).contains(new ia(r.x,r.y))){t.handleTouchesEnd([t.getTouchByXY(i,r.x,r.y,n)]);var a=t.getMouseEvent(r,n,_m.UP);a.setButton(i.button),Am.dispatchEvent(a)}}}),!1)}},{key:"_registerElementMouseEvents",value:function(e,t){var i=this,n=function(t,n,r){e.addEventListener(t,(function(t){var a=i.getHTMLElementPosition(e),o=i.getPointByEvent(t,a),s=i.getMouseEvent(o,a,n);s.setButton(t.button),r(t,s,o,a),Am.dispatchEvent(s),t.stopPropagation(),t.preventDefault()}))};t||(n("mousedown",_m.DOWN,(function(t,n,r,a){i._mousePressed=!0,i.handleTouchesBegin([i.getTouchByXY(t,r.x,r.y,a)]),e.focus()})),n("mouseup",_m.UP,(function(e,t,n,r){i._mousePressed=!1,i.handleTouchesEnd([i.getTouchByXY(e,n.x,n.y,r)])})),n("mousemove",_m.MOVE,(function(e,t,n,r){i.handleTouchesMove([i.getTouchByXY(e,n.x,n.y,r)]),i._mousePressed||t.setButton(_m.BUTTON_MISSING),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)}))),n("mousewheel",_m.SCROLL,(function(e,t,i,n){t.setScrollData(0,e.wheelDelta)})),n("DOMMouseScroll",_m.SCROLL,(function(e,t,i,n){t.setScrollData(0,-120*e.detail)}))}},{key:"_registerMousePointerEvents",value:function(e){var t=this,i={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel},n=function(n){var r=i[n];e.addEventListener(n,(function(i){var n=t.getHTMLElementPosition(e);n.left-=document.documentElement.scrollLeft,n.top-=document.documentElement.scrollTop,r.call(t,[t.getTouchByXY(i,i.clientX,i.clientY,n)]),i.stopPropagation()}),!1)};for(var r in i)n(r)}},{key:"_registerTouchEvents",value:function(e){var t=this,i=function(i){return function(n){if(n.changedTouches){var r=t.getHTMLElementPosition(e),a=document.body;r.left-=a.scrollLeft||0,r.top-=a.scrollTop||0,i(t.getTouchesByEvent(n,r)),n.stopPropagation(),n.preventDefault()}}};e.addEventListener("touchstart",i((function(i){t.handleTouchesBegin(i),e.focus()})),!1),e.addEventListener("touchmove",i((function(e){t.handleTouchesMove(e)})),!1),e.addEventListener("touchend",i((function(e){t.handleTouchesEnd(e)})),!1),e.addEventListener("touchcancel",i((function(e){t.handleTouchesCancel(e)})),!1)}},{key:"_registerKeyboardEvent",value:function(){var e=E.game.canvas;e.addEventListener("keydown",(function(e){Am.dispatchEvent(new pm(e,!0)),e.stopPropagation(),e.preventDefault()}),!1),e.addEventListener("keyup",(function(e){Am.dispatchEvent(new pm(e,!1)),e.stopPropagation(),e.preventDefault()}),!1)}},{key:"_registerAccelerometerEvent",value:function(){var e=this;this._acceleration=new EO,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,E.sys.browserType===E.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";yO=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,yO,!1)}},{key:"_unregisterAccelerometerEvent",value:function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";yO&&window.removeEventListener(e,yO,!1)}},{key:"_getUsefulTouches",value:function(){var e=[],t=this._touchesIntegerDict;for(var i in t){var n=t[parseInt(i)];if(null!=n){var r=this._touches[n];e.push(r)}}return e}}]),e}());E.internal.inputManager=bO;var AO=e("Game",function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).frame=null,n.container=null,n.canvas=null,n.renderType=-1,n.eventTargetOn=_(s(t.prototype),"on",c(n)),n.eventTargetOnce=_(s(t.prototype),"once",c(n)),n.config={},n.onStart=null,n._persistRootNodes={},n._paused=!0,n._configLoaded=!1,n._isCloning=!1,n._inited=!1,n._rendererInitialized=!1,n._gfxDevice=null,n._intervalId=null,n._lastTime=null,n._frameTime=null,n._sceneInfos=[],n.collisionMatrix=[],n.groupList=[],n}return o(t,e),r(t,[{key:"setFrameRate",value:function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e),isNaN(e)&&(e=60)),t.frameRate=e,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}},{key:"getFrameRate",value:function(){return this.config.frameRate||0}},{key:"step",value:function(){E.director.mainLoop()}},{key:"pause",value:function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}},{key:"resume",value:function(){this._paused&&(this._paused=!1,this._runMainLoop())}},{key:"isPaused",value:function(){return this._paused}},{key:"restart",value:function(){E.director.once(E.Director.EVENT_AFTER_DRAW,(function(){for(var e in E.game._persistRootNodes)E.game.removePersistRootNode(E.game._persistRootNodes[e]);E.director.getScene().destroy(),E.Object._deferredDestroy(),E.director.reset(),E.game.onStart(),E.game._safeEmit(E.Game.EVENT_RESTART)}))}},{key:"end",value:function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),close()}},{key:"on",value:function(e,i,n,r){this._inited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOn(e,i,n,r)}},{key:"once",value:function(e,i,n){this._inited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOnce(e,i,n)}},{key:"init",value:function(e){return this._initConfig(e),this.config.assetOptions&&tI.init(this.config.assetOptions),this._initEngine(),this._initEvents(),E.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),this._inited}},{key:"run",value:function(e,i){var n=this;if(this._initEvents(),"function"!=typeof e&&i){var r=this.onStart;this.init(r),this.onStart=i}else this.onStart=e;this._setAnimFrame(),this._runMainLoop(),CO.config.registerSystemEvent&&bO.registerSystemEvent(CO.canvas);var a=E.internal.SplashScreen,o="5d45ba66-829a-46d3-948e-2ed3fa7ee421";E.loader.load({uuid:o},(function(e,i){if(e)console.warn("Failed load renderpipeline: ".concat(o,", engine failed to initialize, will fallback to default pipeline")),console.warn(e),n.setRenderPipeline();else try{n.setRenderPipeline(i)}catch(e){console.warn(e),console.warn("Failed load renderpipeline: ".concat(o,", engine failed to initialize, will fallback to default pipeline")),n.setRenderPipeline()}if(n._safeEmit(t.EVENT_GAME_INITED),a){var r=E.internal.SplashScreen.instance;r.main(E.director.root),r.setOnFinish((function(){n.onStart&&n.onStart()})),r.loadFinish=!0}else n.onStart&&n.onStart()}))}},{key:"addPersistRootNode",value:function(e){if(E.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=E.director._scene;if(E.isValid(i))if(e.parent){if(!(e.parent instanceof E.Scene))return void G(3801);if(e.parent!==i)return void G(3802)}else e.parent=i;this._persistRootNodes[t]=e,e._persistNode=!0}}else G(3800)}},{key:"removePersistRootNode",value:function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1)}},{key:"isPersistRootNode",value:function(e){return e._persistNode}},{key:"_initEngine",value:function(){this._initDevice(),E.director._init(),console.log("Cocos Creator 3D v"+E.ENGINE_VERSION),this.emit(t.EVENT_ENGINE_INITED),this._inited=!0}},{key:"_setAnimFrame",value:function(){this._lastTime=new Date;var e=E.game.config.frameRate;this._frameTime=1e3/e,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),60!==e&&30!==e?(window.rAF=this._stTime,window.cAF=this._ctTime):(window.rAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime,window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)}},{key:"_stTime",value:function(e){var t=(new Date).getTime(),i=Math.max(0,t-E.game._lastTime),n=Math.max(0,E.game._frameTime-i),r=window.setTimeout(e,n);return E.game._lastTime=t+n,r}},{key:"_ctTime",value:function(e){window.clearTimeout(e)}},{key:"_runMainLoop",value:function(){var e,t=this,i=this.config,n=E.director,r=!0,a=i.frameRate;K(!!i.showFPS),n.startAnimation(),e=function(i){t._paused||(t._intervalId=window.rAF(e),30===a&&(r=!r)||n.mainLoop(i))},this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(e),this._paused=!1}},{key:"_initConfig",value:function(e){"number"!=typeof e.debugMode&&(e.debugMode=0),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this._sceneInfos=e.scenes||[],this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],B(e.debugMode),this.config=e,this._configLoaded=!0}},{key:"_determineRenderType",value:function(){var e=this.config,i=parseInt(e.renderMode);this.renderType=t.RENDER_TYPE_CANVAS;var n=!1;if(0===i?E.sys.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,n=!0):E.sys.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):1===i&&E.sys.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):2===i&&E.sys.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(X(3820,i))}},{key:"_initDevice",value:function(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var e=[],i=!!window.WebGL2RenderingContext,n=window.navigator.userAgent.toLowerCase();(-1!==n.indexOf("safari")&&-1===n.indexOf("chrome")||Gn.browserType===Gn.BROWSER_TYPE_UC)&&(i=!1),i&&E.WebGL2Device&&e.push(E.WebGL2Device),E.WebGLDevice&&e.push(E.WebGLDevice);for(var r=new Js(this.canvas,Sh.ENABLE_WEBGL_ANTIALIAS,!1,window.devicePixelRatio,Math.floor(screen.width*window.devicePixelRatio),Math.floor(screen.height*window.devicePixelRatio),Wh),a=0;a<e.length&&(this._gfxDevice=new e[a],!this._gfxDevice.initialize(r));a++);}if(!this._gfxDevice)return console.error("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){if(!E._isContextMenuEnable)return!1}}}},{key:"_initEvents",value:function(){var e,i=window;void 0!==document.hidden?e="hidden":void 0!==document.mozHidden?e="mozHidden":void 0!==document.msHidden?e="msHidden":void 0!==document.webkitHidden&&(e="webkitHidden");var n=!1;function r(){n||(n=!0,E.game.emit(t.EVENT_HIDE))}function a(e,i,r,a,o){n&&(n=!1,E.game.emit(t.EVENT_SHOW,e,i,r,a,o))}if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],s=0;s<o.length;s++)document.addEventListener(o[s],(function(t){var i=document[e];(i=i||t.hidden)?r():a()}));else i.addEventListener("blur",r),i.addEventListener("focus",a);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(i.onfocus=a),"onpageshow"in window&&"onpagehide"in window&&(i.addEventListener("pagehide",r),i.addEventListener("pageshow",a),document.addEventListener("pagehide",r),document.addEventListener("pageshow",a)),this.on(t.EVENT_HIDE,(function(){E.game.pause()})),this.on(t.EVENT_SHOW,(function(){E.game.resume()}))}},{key:"setRenderPipeline",value:function(e){E.director.root.setRenderPipeline(e)||this.setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)}},{key:"_safeEmit",value:function(e){this.emit(e)}},{key:"inited",get:function(){return this._inited}}]),t}(tn));AO.EVENT_HIDE="game_on_hide",AO.EVENT_SHOW="game_on_show",AO.EVENT_GAME_INITED="game_inited",AO.EVENT_ENGINE_INITED="engine_inited",AO.EVENT_RENDERER_INITED="renderer_inited",AO.EVENT_RESTART="game_on_restart",AO.RENDER_TYPE_CANVAS=0,AO.RENDER_TYPE_WEBGL=1,AO.RENDER_TYPE_OPENGL=2,E.Game=AO;var CO=e("game",E.game=new AO),wO=new(function(){function e(){i(this,e),this.html=void 0,this.meta={width:"device-width"},this.adaptationType=E.sys.browserType}return r(e,[{key:"init",value:function(){this.html=document.getElementsByTagName("html")[0]}},{key:"availWidth",value:function(e){return E.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth}},{key:"availHeight",value:function(e){return E.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight}}]),e}());switch(E.sys.os===E.sys.OS_IOS&&(wO.adaptationType=E.sys.BROWSER_TYPE_SAFARI),wO.adaptationType){case E.sys.BROWSER_TYPE_SAFARI:wO.meta["minimal-ui"]="true";case E.sys.BROWSER_TYPE_SOUGOU:case E.sys.BROWSER_TYPE_UC:wO.availWidth=function(e){return e.clientWidth},wO.availHeight=function(e){return e.clientHeight}}var RO=e("View",function(e){function t(){var e;i(this,t),(e=u(this,s(t).call(this)))._resizeWithBrowserSize=void 0,e._designResolutionSize=void 0,e._originalDesignResolutionSize=void 0,e._frameSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._devicePixelRatio=void 0,e._maxPixelRatio=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resizing=void 0,e._orientationChanging=void 0,e._isRotated=void 0,e._orientation=void 0,e._isAdjustViewport=void 0,e._antiAliasEnabled=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;c(e);var n=IO,r=OO;return e._frameSize=new wa(0,0),e._designResolutionSize=new wa(0,0),e._originalDesignResolutionSize=new wa(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Ia(0,0,0,0),e._visibleRect=new Ia(0,0,0,0),e._autoFullScreen=!1,e._devicePixelRatio=1,e._maxPixelRatio=2,e._retinaEnabled=!1,e._resizeCallback=null,e._resizing=!1,e._resizeWithBrowserSize=!1,e._orientationChanging=!0,e._isRotated=!1,e._orientation=E.macro.ORIENTATION_AUTO,e._isAdjustViewport=!0,e._antiAliasEnabled=!1,e._rpExactFit=new MO(n.EQUAL_TO_FRAME,r.EXACT_FIT),e._rpShowAll=new MO(n.EQUAL_TO_FRAME,r.SHOW_ALL),e._rpNoBorder=new MO(n.EQUAL_TO_FRAME,r.NO_BORDER),e._rpFixedHeight=new MO(n.EQUAL_TO_FRAME,r.FIXED_HEIGHT),e._rpFixedWidth=new MO(n.EQUAL_TO_FRAME,r.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,E.game.once(E.Game.EVENT_ENGINE_INITED,e.init,c(e)),e}return o(t,e),r(t,[{key:"init",value:function(){wO.init(),this._initFrameSize(),this.enableAntiAlias(!0);var e=E.game.canvas.width,t=E.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,E.winSize.width=this._visibleRect.width,E.winSize.height=this._visibleRect.height,E.visibleRect&&E.visibleRect.init(this._visibleRect)}},{key:"resizeWithBrowserSize",value:function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}},{key:"setResizeCallback",value:function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)}},{key:"setOrientation",value:function(e){(e&=E.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)}},{key:"adjustViewportMeta",value:function(e){this._isAdjustViewport=e}},{key:"enableRetina",value:function(e){this._retinaEnabled=!!e}},{key:"isRetinaEnabled",value:function(){return this._retinaEnabled}},{key:"enableAntiAlias",value:function(e){if(this._antiAliasEnabled!==e)if(this._antiAliasEnabled=e,E.game.renderType===E.Game.RENDER_TYPE_WEBGL){var t=E.loader._cache;for(var i in t){var n=t[i],r=n&&n.content instanceof E.Texture2D?n.content:null;if(r){var a=E.Texture2D.Filter;e?r.setFilters(a.LINEAR,a.LINEAR):r.setFilters(a.NEAREST,a.NEAREST)}}}else if(E.game.renderType===E.Game.RENDER_TYPE_CANVAS){var o=E.game.canvas.getContext("2d");o.imageSmoothingEnabled=e,o.mozImageSmoothingEnabled=e}}},{key:"isAntiAliasEnabled",value:function(){return this._antiAliasEnabled}},{key:"enableAutoFullScreen",value:function(e){e&&e!==this._autoFullScreen&&E.sys.isMobile&&E.sys.browserType!==E.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,E.screen.autoFullScreen(E.game.frame)):this._autoFullScreen=!1}},{key:"isAutoFullScreenEnabled",value:function(){return this._autoFullScreen}},{key:"setCanvasSize",value:function(e,t){var i=E.game.canvas,n=E.game.container;this._devicePixelRatio=window.devicePixelRatio,i.width=e*this._devicePixelRatio,i.height=t*this._devicePixelRatio,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()}},{key:"getCanvasSize",value:function(){return new wa(E.game.canvas.width,E.game.canvas.height)}},{key:"getFrameSize",value:function(){return new wa(this._frameSize.width,this._frameSize.height)}},{key:"setFrameSize",value:function(e,t){this._frameSize.width=e,this._frameSize.height=t,E.frame.style.width=e+"px",E.frame.style.height=t+"px",this._resizeEvent()}},{key:"getVisibleSize",value:function(){return new wa(this._visibleRect.width,this._visibleRect.height)}},{key:"getVisibleSizeInPixel",value:function(){return new wa(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}},{key:"getVisibleOrigin",value:function(){return new ia(this._visibleRect.x,this._visibleRect.y)}},{key:"getVisibleOriginInPixel",value:function(){return new ia(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}},{key:"getResolutionPolicy",value:function(){return this._resolutionPolicy}},{key:"setResolutionPolicy",value:function(e){var t=this;if(e instanceof MO)t._resolutionPolicy=e;else{var i=MO;e===i.EXACT_FIT&&(t._resolutionPolicy=t._rpExactFit),e===i.SHOW_ALL&&(t._resolutionPolicy=t._rpShowAll),e===i.NO_BORDER&&(t._resolutionPolicy=t._rpNoBorder),e===i.FIXED_HEIGHT&&(t._resolutionPolicy=t._rpFixedHeight),e===i.FIXED_WIDTH&&(t._resolutionPolicy=t._rpFixedWidth)}}},{key:"setDesignResolutionSize",value:function(e,t,i){if(e>0||t>0){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),E.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var a=this._viewportRect,o=this._visibleRect,s=r.viewport;a.x=s.x,a.y=s.y,a.width=s.width,a.height=s.height,o.x=0,o.y=0,o.width=s.width/this._scaleX,o.height=s.height/this._scaleY}n.postApply(this),E.winSize.width=this._visibleRect.width,E.winSize.height=this._visibleRect.height,mO&&mO.init(this._visibleRect),this.emit("design-resolution-changed")}else z(2201)}else V(2200)}},{key:"getDesignResolutionSize",value:function(){return new wa(this._designResolutionSize.width,this._designResolutionSize.height)}},{key:"setRealPixelResolution",value:function(e,t,i){this._setViewportMeta({width:e},!0),document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,i)}},{key:"getViewportRect",value:function(){return this._viewportRect}},{key:"getScaleX",value:function(){return this._scaleX}},{key:"getScaleY",value:function(){return this._scaleY}},{key:"getDevicePixelRatio",value:function(){return this._devicePixelRatio}},{key:"convertToLocationInView",value:function(e,t,i,n){var r=n||new ia,a=this._devicePixelRatio*(e-i.left),o=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(r.x=E.game.canvas.width-o,r.y=a):(r.x=a,r.y=o),r}},{key:"_convertPointWithScale",value:function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY}},{key:"_resizeEvent",value:function(){var e=E.view,t=e._frameSize.width,i=e._frameSize.height,n=e._isRotated;if(E.sys.isMobile){var r=E.game.container.style,a=r.margin;r.margin="0",r.display="none",e._initFrameSize(),r.margin=a,r.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==n||e._frameSize.width!==t||e._frameSize.height!==i){var o=e._originalDesignResolutionSize.width,s=e._originalDesignResolutionSize.height;e._resizing=!0,o>0&&e.setDesignResolutionSize(o,s,e._resolutionPolicy),e._resizing=!1,e.emit("canvas-resize"),e._resizeCallback&&e._resizeCallback.call()}}},{key:"_orientationChange",value:function(){E.view._orientationChanging=!0,E.view._resizeEvent()}},{key:"_initFrameSize",value:function(){var e=this._frameSize,t=wO.availWidth(E.game.frame),i=wO.availHeight(E.game.frame),n=t>=i;!E.sys.isMobile||n&&this._orientation&E.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&E.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,E.game.container.style["-webkit-transform"]="rotate(0deg)",E.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,E.game.container.style["-webkit-transform"]="rotate(90deg)",E.game.container.style.transform="rotate(90deg)",E.game.container.style["-webkit-transform-origin"]="0px 0px 0px",E.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,E.game.canvas.style["-webkit-transform"]="translateZ(0px)",E.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((function(){E.view._orientationChanging=!1}),1e3)}},{key:"_adjustSizeKeepCanvasSize",value:function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;e>0&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)}},{key:"_setViewportMeta",value:function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,a,o=document.getElementsByName("viewport"),s=o?o[0]:null;for(r in n=s?s.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(a=new RegExp(r+"s*=s*[^,]+"),n.replace(a,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,s&&(s.content=n),document.head.appendChild(i)}},{key:"_adjustViewportMeta",value:function(){this._isAdjustViewport&&(this._setViewportMeta(wO.meta,!1),this._isAdjustViewport=!1)}},{key:"_convertMouseToLocation",value:function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y)}},{key:"_convertTouchWidthScale",value:function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n}},{key:"_convertTouchesWithScale",value:function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,a=this._scaleY,o=0;o<e.length;o++){var s=e[o];t=s._point,i=s._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/a,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/a}}}]),t}(tn));RO.instance=void 0;var IO=function(){function e(){i(this,e),this.name="ContainerStrategy"}return r(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){}},{key:"postApply",value:function(e){}},{key:"_setupContainer",value:function(e,t,i){var n=E.game.canvas,r=E.game.container;E.sys.os===E.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),r.style.width=n.style.width=t+"px",r.style.height=n.style.height=i+"px";var a=e._devicePixelRatio=1;e.isRetinaEnabled()&&(a=e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),n.width=t*a,n.height=i*a}},{key:"_fixContainer",value:function(){document.body.insertBefore(E.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=E.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0}}]),e}();IO.EQUAL_TO_FRAME=void 0,IO.PROPORTION_TO_FRAME=void 0;var OO=function(){function e(){i(this,e),this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}return r(e,[{key:"preApply",value:function(e){}},{key:"apply",value:function(e,t){return{scale:[1,1]}}},{key:"postApply",value:function(e){}},{key:"_buildResult",value:function(e,t,i,n,r,a){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var o=new Ia(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,a],this._result.viewport=o,this._result}}]),e}();OO.EXACT_FIT=void 0,OO.SHOW_ALL=void 0,OO.NO_BORDER=void 0,OO.FIXED_HEIGHT=void 0,OO.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).name="EqualToFrame",n}return o(t,e),r(t,[{key:"apply",value:function(e){var t=e._frameSize.height,i=E.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"}}]),t}(IO),t=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).name="ProportionalToFrame",n}return o(t,e),r(t,[{key:"apply",value:function(e,t){var i,n,r=e._frameSize.width,a=e._frameSize.height,o=E.game.container.style,s=t.width,l=t.height,c=r/s,u=a/l;c<u?(i=r,n=l*c):(i=s*u,n=a);var h=Math.round((r-i)/2),_=Math.round((a-n)/2);i=r-2*h,n=a-2*_,this._setupContainer(e,i,n),e._isRotated?o.margin="0 0 0 "+a+"px":o.margin="0px",o.paddingLeft=h+"px",o.paddingRight=h+"px",o.paddingTop=_+"px",o.paddingBottom=_+"px"}}]),t}(IO),n=("undefined"==typeof window?global:window).__globalAdapter;n&&(n.adaptContainerStrategy&&n.adaptContainerStrategy(IO.prototype),n.adaptView&&n.adaptView(RO.prototype)),IO.EQUAL_TO_FRAME=new e,IO.PROPORTION_TO_FRAME=new t;var a=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).name="ExactFit",n}return o(t,e),r(t,[{key:"apply",value:function(e,t){var i=E.game.canvas.width,n=E.game.canvas.height,r=i/t.width,a=n/t.height;return this._buildResult(i,n,i,n,r,a)}}]),t}(OO),l=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).name="ShowAll",n}return o(t,e),r(t,[{key:"apply",value:function(e,t){var i,n,r=E.game.canvas.width,a=E.game.canvas.height,o=t.width,s=t.height,l=r/o,c=a/s,u=0;return l<c?(i=r,n=s*(u=l)):(i=o*(u=c),n=a),this._buildResult(r,a,i,n,u,u)}}]),t}(OO),c=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).name="NoBorder",n}return o(t,e),r(t,[{key:"apply",value:function(e,t){var i,n,r,a=E.game.canvas.width,o=E.game.canvas.height,s=t.width,l=t.height,c=a/s,u=o/l;return c<u?(n=s*(i=u),r=o):(n=a,r=l*(i=c)),this._buildResult(a,o,n,r,i,i)}}]),t}(OO),h=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).name="FixedHeight",n}return o(t,e),r(t,[{key:"apply",value:function(e,t){var i=E.game.canvas.width,n=E.game.canvas.height,r=n/t.height,a=i,o=n;return this._buildResult(i,n,a,o,r,r)}}]),t}(OO),_=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).name="FixedWidth",n}return o(t,e),r(t,[{key:"apply",value:function(e,t){var i=E.game.canvas.width,n=E.game.canvas.height,r=i/t.width,a=i,o=n;return this._buildResult(i,n,a,o,r,r)}}]),t}(OO);OO.EXACT_FIT=new a,OO.SHOW_ALL=new l,OO.NO_BORDER=new c,OO.FIXED_HEIGHT=new h,OO.FIXED_WIDTH=new _}();var MO=e("ResolutionPolicy",function(){function e(t,n){i(this,e),this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(n)}return r(e,[{key:"preApply",value:function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)}},{key:"apply",value:function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)}},{key:"postApply",value:function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)}},{key:"setContainerStrategy",value:function(e){e instanceof IO&&(this._containerStrategy=e)}},{key:"setContentStrategy",value:function(e){e instanceof OO&&(this._contentStrategy=e)}},{key:"canvasSize",get:function(){return E.v2(E.game.canvas.width,E.game.canvas.height)}}]),e}());MO.EXACT_FIT=0,MO.NO_BORDER=1,MO.SHOW_ALL=2,MO.FIXED_HEIGHT=3,MO.FIXED_WIDTH=4,MO.UNKNOWN=5,MO.ContainerStrategy=IO,MO.ContentStrategy=OO,E.ResolutionPolicy=MO;var PO=e("view",RO.instance=E.view=new RO);E.winSize=new wa;var kO=null,DO=null,BO=null,LO=null,NO=e("SystemEvent",function(e){function t(){return i(this,t),u(this,s(t).call(this))}return o(t,e),r(t,[{key:"setAccelerometerEnabled",value:function(e){e&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){console.log("Device Motion Event request permission: ".concat(e)),bO.setAccelerometerEnabled("granted"===e)})):bO.setAccelerometerEnabled(e)}},{key:"setAccelerometerInterval",value:function(e){bO.setAccelerometerInterval(e)}},{key:"on",value:function(e,i,n,r){return _(s(t.prototype),"on",this).call(this,e,i,n,r),e!==lm.KEY_DOWN&&e!==lm.KEY_UP||kO||(kO=mm.create({event:mm.KEYBOARD,onKeyPressed:function(e,t){t.type=lm.KEY_DOWN,FO.emit(t.type,t)},onKeyReleased:function(e,t){t.type=lm.KEY_UP,FO.emit(t.type,t)}}),Am.addListener(kO,256)),e===lm.DEVICEMOTION&&(DO||(DO=mm.create({event:mm.ACCELERATION,callback:function(e,t){t.type=lm.DEVICEMOTION,E.systemEvent.emit(t.type,t)}}),Am.addListener(DO,256))),e!==lm.TOUCH_START&&e!==lm.TOUCH_MOVE&&e!==lm.TOUCH_END&&e!==lm.TOUCH_CANCEL||BO||(BO=mm.create({event:mm.TOUCH_ONE_BY_ONE,onTouchBegan:function(e,t){return t.type=lm.TOUCH_START,E.systemEvent.emit(t.type,e,t),!0},onTouchMoved:function(e,t){t.type=lm.TOUCH_MOVE,E.systemEvent.emit(t.type,e,t)},onTouchEnded:function(e,t){t.type=lm.TOUCH_END,E.systemEvent.emit(t.type,e,t)},onTouchCancelled:function(e,t){t.type=lm.TOUCH_CANCEL,E.systemEvent.emit(t.type,e,t)}}),Am.addListener(BO,256)),e!==lm.MOUSE_DOWN&&e!==lm.MOUSE_MOVE&&e!==lm.MOUSE_UP&&e!==lm.MOUSE_WHEEL||LO||(LO=mm.create({event:mm.MOUSE,onMouseDown:function(e){e.type=lm.MOUSE_DOWN,E.systemEvent.emit(e.type,e)},onMouseMove:function(e){e.type=lm.MOUSE_MOVE,E.systemEvent.emit(e.type,e)},onMouseUp:function(e){e.type=lm.MOUSE_UP,E.systemEvent.emit(e.type,e)},onMouseScroll:function(e){e.type=lm.MOUSE_WHEEL,E.systemEvent.emit(e.type,e)}}),Am.addListener(LO,256)),i}},{key:"off",value:function(e,i,n){if(_(s(t.prototype),"off",this).call(this,e,i,n),kO&&(e===lm.KEY_DOWN||e===lm.KEY_UP)){var r=this.hasEventListener(lm.KEY_DOWN),a=this.hasEventListener(lm.KEY_UP);r||a||(Am.removeListener(kO),kO=null)}if(DO&&e===lm.DEVICEMOTION&&(Am.removeListener(DO),DO=null),BO&&(e===lm.TOUCH_START||e===lm.TOUCH_MOVE||e===lm.TOUCH_END||e===lm.TOUCH_CANCEL)){var o=this.hasEventListener(lm.TOUCH_START),l=this.hasEventListener(lm.TOUCH_MOVE),c=this.hasEventListener(lm.TOUCH_END),u=this.hasEventListener(lm.TOUCH_CANCEL);o||l||c||u||(Am.removeListener(BO),BO=null)}if(LO&&(e===lm.MOUSE_DOWN||e===lm.MOUSE_MOVE||e===lm.MOUSE_UP||e===lm.MOUSE_WHEEL)){var h=this.hasEventListener(lm.MOUSE_DOWN),d=this.hasEventListener(lm.MOUSE_MOVE),f=this.hasEventListener(lm.MOUSE_UP),p=this.hasEventListener(lm.MOUSE_WHEEL);h||d||f||p||(Am.removeListener(LO),LO=null)}}}]),t}(tn));NO.EventType=lm,E.SystemEvent=NO;var FO=e("systemEvent",new NO);E.systemEvent=FO,ka(lm,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);var zO,UO,GO,HO,VO,WO,jO,qO,XO,YO,KO,ZO,QO,JO,$O,eM,tM,iM,nM=e("screen",{_supportsFullScreen:!1,_onfullscreenchange:null,_onfullscreenerror:null,_preOnFullScreenError:null,_preOnTouch:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init:function(){this._fn={};var e,t,i,n,r=this._fnMap;for(e=0,t=r.length;e<t;e++)if((i=r[e])&&void 0!==document[i[1]]){for(e=0,n=i.length;e<n;e++)this._fn[r[0][e]]=i[e];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},get supportsFullScreen(){return this._supportsFullScreen},fullScreen:function(){return!!this._supportsFullScreen&&(void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement])},requestFullScreen:function(e,t,i){if(this._supportsFullScreen){if(e=e||document.documentElement,t){var n=this._fn.fullscreenchange;this._onfullscreenchange&&document.removeEventListener(n,this._onfullscreenchange),this._onfullscreenchange=t,document.addEventListener(n,t,!1)}if(i){var r=this._fn.fullscreenerror;this._onfullscreenerror&&document.removeEventListener(r,this._onfullscreenerror),this._onfullscreenerror=i,document.addEventListener(r,i,{once:!0})}var a=e[this._fn.requestFullscreen]();return window.Promise&&a instanceof Promise&&a.catch((function(e){})),a}},exitFullScreen:function(){var e;return this.fullScreen()&&(e=document[this._fn.exitFullscreen]()).catch((function(e){})),e},autoFullScreen:function(e,t){e=e||document.body,this._ensureFullScreen(e,t),this.requestFullScreen(e,t)},disableAutoFullScreen:function(e){if(this._preOnTouch){var t=E.game.canvas||e,i=this._touchEvent;t.removeEventListener(i,this._preOnTouch),this._preOnTouch=null}},_ensureFullScreen:function(e,t){var i=this,n=E.game.canvas||e,r=this._fn.fullscreenerror,a=this._touchEvent,o=function(){i._preOnFullScreenError=null;i._preOnTouch&&n.removeEventListener(a,i._preOnTouch),i._preOnTouch=function(){i._preOnTouch=null,i.requestFullScreen(e,t)},n.addEventListener(a,i._preOnTouch,{once:!0})};this._preOnFullScreenError&&e.removeEventListener(r,this._preOnFullScreenError),this._preOnFullScreenError=o,e.addEventListener(r,o,{once:!0})}});nM.init(),E.screen=nM,nt(ns),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(iM||(iM=e("InstanceMaterialType",{})));var rM,aM,oM,sM,lM,cM,uM,hM,_M,dM,fM,pM,mM,vM,gM,yM,xM,SM,TM,EM,bM,AM,CM,wM,RM,IM,OM,MM,PM,kM,DM,BM,LM,NM,FM,zM,UM,GM,HM,VM,WM,jM,qM,XM={parent:null,owner:null,subModelIdx:0},YM=e("UIRenderable",(zO=ii("cc.UIRenderable"),UO=ni(jv),GO=Li(ns),HO=wi(0),VO=Si(""),WO=Li(ns),jO=wi(1),qO=Si(""),XO=wi(2),YO=Si(""),zO(KO=UO(KO=ai(KO=hi((tM=eM=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._uiMaterial=null,n._uiMaterialIns=null,n._uiMaterialDirty=!1,n._uiMatInsDirty=!1,x(n,"_srcBlendFactor",QO,c(n)),x(n,"_dstBlendFactor",JO,c(n)),x(n,"_color",$O,c(n)),n._assembler=null,n._postAssembler=null,n._renderData=null,n._renderDataFlag=!0,n._renderFlag=!0,n._delegateSrc=null,n._instanceMaterialType=iM.ADD_COLOR_AND_TEXTURE,n._blendTemplate={blendState:{targets:[{blendSrc:ns.SRC_ALPHA,blendDst:ns.ONE_MINUS_SRC_ALPHA}]}},n._lastParent=null,n}return o(t,e),r(t,[{key:"getUIRenderMaterial",value:function(){return this._uiMaterialIns||this._uiMaterial}},{key:"getUIMaterialInstance",value:function(){return this._uiMaterialIns&&!this._uiMatInsDirty||(XM.owner=this,XM.parent=this._uiMaterial,this._uiMaterialIns=new um(XM),this._uiMatInsDirty=!1),this._uiMaterialIns}},{key:"__preload",value:function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}},{key:"onEnable",value:function(){this.node.on(lm.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(lm.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=this._canRender()}},{key:"onDisable",value:function(){this.node.off(lm.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(lm.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}},{key:"onDestroy",value:function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++)this._materialInstances[e].destroy();this._uiMaterialIns&&this._uiMaterialIns.destroy(),this._renderData=null}},{key:"markForUpdateRenderData",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._renderFlag=this._canRender(),e&&this._renderFlag){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else e||(this._renderDataFlag=e)}},{key:"requestRenderData",value:function(){var e=HA.add();return this._renderData=e,e}},{key:"destroyRenderData",value:function(){this._renderData&&(HA.remove(this._renderData),this._renderData=null)}},{key:"updateAssembler",value:function(e){this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(e))}},{key:"postUpdateAssembler",value:function(e){this._renderFlag&&this._postRender(e)}},{key:"_render",value:function(e){}},{key:"_postRender",value:function(e){}},{key:"_checkAndUpdateRenderData",value:function(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}},{key:"_canRender",value:function(){return this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)}},{key:"_postCanRender",value:function(){}},{key:"_updateColor",value:function(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}},{key:"_updateBlendFunc",value:function(){var e=this.getMaterial(0),t=this._blendTemplate.blendState.targets[0];return e?(t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(e=this.material,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,e.overridePipelineStates(this._blendTemplate,0)),e):((null!==this._uiMaterialIns&&this._uiMatInsDirty||t.blendDst!==this._dstBlendFactor||t.blendSrc!==this._srcBlendFactor)&&(e=this.getUIMaterialInstance(),t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,e.overridePipelineStates(this._blendTemplate,0)),e||this.getUIRenderMaterial())}},{key:"_nodeStateChange",value:function(e){this._renderData&&this.markForUpdateRenderData();for(var i,n=y(this.node.children);!(i=n()).done;){var r=i.value.getComponent(t);r&&r.markForUpdateRenderData()}}},{key:"_updateBuiltinMaterial",value:function(){var e=!1;if(this._uiMaterial||(e=!0),this._uiMaterial&&!this._uiMaterialDirty)return this._uiMaterial;switch(this._instanceMaterialType){case iM.ADD_COLOR:this._uiMaterial=tf.get("ui-base-material");break;case iM.ADD_COLOR_AND_TEXTURE:this._uiMaterial=tf.get("ui-sprite-material");break;case iM.GRAYSCALE:this._uiMaterial=tf.get("ui-sprite-gray-material");break;case iM.USE_ALPHA_SEPARATED:this._uiMaterial=tf.get("ui-sprite-alpha-sep-material");break;case iM.USE_ALPHA_SEPARATED_AND_GRAY:this._uiMaterial=tf.get("ui-sprite-gray-alpha-sep-material");break;default:this._uiMaterial=tf.get("ui-sprite-material")}return this._uiMaterialDirty=!1,e||(this._uiMatInsDirty=!0),this._uiMaterial}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"uiMaterial",get:function(){return this._uiMaterial},set:function(e){this._uiMaterial=e}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}}]),t}(AC),eM.BlendState=ns,eM.Assembler=null,eM.PostAssembler=null,S((ZO=tM).prototype,"srcBlendFactor",[GO,HO,VO],Object.getOwnPropertyDescriptor(ZO.prototype,"srcBlendFactor"),ZO.prototype),S(ZO.prototype,"dstBlendFactor",[WO,jO,qO],Object.getOwnPropertyDescriptor(ZO.prototype,"dstBlendFactor"),ZO.prototype),S(ZO.prototype,"color",[XO,YO],Object.getOwnPropertyDescriptor(ZO.prototype,"color"),ZO.prototype),QO=S(ZO.prototype,"_srcBlendFactor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ns.SRC_ALPHA}}),JO=S(ZO.prototype,"_dstBlendFactor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ns.ONE_MINUS_SRC_ALPHA}}),$O=S(ZO.prototype,"_color",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.WHITE.clone()}}),KO=ZO))||KO)||KO)||KO)||KO));!function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(VM||(VM={})),nt(VM),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(WM||(WM={})),nt(WM),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(jM||(jM={})),nt(jM),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(qM||(qM={}));var KM,ZM,QM,JM,$M,eP,tP,iP,nP,rP,aP,oP,sP,lP,cP,uP,hP,_P,dP,fP,pP,mP,vP,gP,yP,xP,SP,TP,EP,bP,AP,CP,wP,RP,IP,OP,MP,PP,kP,DP,BP,LP,NP,FP,zP,UP,GP,HP,VP,WP,jP,qP,XP,YP,KP,ZP,QP,JP,$P,ek,tk,ik,nk,rk,ak,ok,sk,lk,ck,uk,hk,_k,dk,fk,pk,mk,vk,gk,yk,xk,Sk,Tk,Ek,bk,Ak,Ck,wk,Rk,Ik,Ok,Mk,Pk,kk,Dk=e("SpriteComponent",(rM=ii("cc.Sprite"),aM=mi("i18n:cc.Sprite"),oM=ri(110),sM=_i("UI/Render/Sprite"),lM=Li(Jw),cM=wi(4),uM=Si(" Atlas "),hM=Li(Pd),_M=wi(5),dM=Si(" Sprite  SpriteFrame "),fM=Li(VM),pM=wi(6),mM=Si("\n- Simple \n- Sliced UI  \n- Filled"),vM=Li(WM),gM=Si("HorizontalVerticalRadial"),yM=Si(" 0 ~ 1"),xM=Ti([0,1,.1]),SM=Si(" 0 ~ 1 "),TM=Ti([-1,1,.1]),EM=Si(" 0 ~ 1 "),bM=wi(8),AM=Si(""),CM=Li(jM),wM=wi(7),RM=Si(" Sprite CUSTOM TRIMMED RAW "),rM(IM=aM(IM=oM(IM=sM((HM=GM=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_spriteFrame",MM,c(n)),x(n,"_type",PM,c(n)),x(n,"_fillType",kM,c(n)),x(n,"_sizeMode",DM,c(n)),x(n,"_fillCenter",BM,c(n)),x(n,"_fillStart",LM,c(n)),x(n,"_fillRange",NM,c(n)),x(n,"_isTrimmedMode",FM,c(n)),x(n,"_useGrayscale",zM,c(n)),x(n,"_atlas",UM,c(n)),n}return o(t,e),r(t,[{key:"__preload",value:function(){this.changeMaterialForDefine(),_(s(t.prototype),"__preload",this).call(this),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}},{key:"onEnable",value:function(){_(s(t.prototype),"onEnable",this).call(this),this._activateMaterial(),this.getMaterial(0)&&this._updateBlendFunc()}},{key:"onDestroy",value:function(){_(s(t.prototype),"onDestroy",this).call(this),this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load")}},{key:"changeSpriteFrameFromAtlas",value:function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")}},{key:"changeMaterialForDefine",value:function(){var e;this._spriteFrame&&(e=this._spriteFrame.texture);var t=!1;if(e instanceof yh){var i=e.getPixelFormat();t=i===Wu.RGBA_ETC1||i===Wu.RGB_A_PVRTC_4BPPV1||i===Wu.RGB_A_PVRTC_2BPPV1}t&&this.grayscale?this._instanceMaterialType=iM.USE_ALPHA_SEPARATED_AND_GRAY:t?this._instanceMaterialType=iM.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=iM.GRAYSCALE:this._instanceMaterialType=iM.ADD_COLOR_AND_TEXTURE,this._uiMaterialDirty=!0}},{key:"_render",value:function(e){e.commitComp(this,this._spriteFrame.getGFXTexture(),this._assembler,this._spriteFrame.texture.getGFXSampler())}},{key:"_canRender",value:function(){if(!_(s(t.prototype),"_canRender",this).call(this))return!1;var e=this._spriteFrame;return!(!e||!e.textureLoaded())}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._updateColor())}},{key:"_applySpriteSize",value:function(){if(this._spriteFrame){if(jM.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(jM.TRIMMED===this._sizeMode){var t=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}}},{key:"_resized",value:function(){}},{key:"_activateMaterial",value:function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);E.game.renderType!==E.game.RENDER_TYPE_CANVAS?(e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)):this.markForUpdateRenderData()}},{key:"_onTextureLoaded",value:function(){this.isValid&&(this.changeMaterialForDefine(),this._applySpriteSize())}},{key:"_applySpriteFrame",value:function(e){var t=this._spriteFrame;this._renderData&&(e&&e.off("load",this._markForUpdateUvDirty),t&&t.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!e||!t||e.uvHash!==t.uvHash),this._renderDataFlag=this._renderData.uvDirty),t&&(e&&t===e||(t.loaded?this._onTextureLoaded():t.once("load",this._onTextureLoaded,this)))}},{key:"_markForUpdateUvDirty",value:function(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===WM.RADIAL||this._fillType===WM.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===VM.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=vn(e,-1,1),this._type===VM.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=vn(e,-1,1),this._type===VM.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===VM.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this._instanceMaterialType=!0===e?iM.GRAYSCALE:iM.ADD_COLOR_AND_TEXTURE,this._uiMaterialDirty=!0)}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==jM.CUSTOM&&this._applySpriteSize())}}]),t}(YM),GM.FillType=WM,GM.Type=VM,GM.SizeMode=jM,GM.EventType=qM,S((OM=HM).prototype,"spriteAtlas",[lM,cM,uM],Object.getOwnPropertyDescriptor(OM.prototype,"spriteAtlas"),OM.prototype),S(OM.prototype,"spriteFrame",[hM,_M,dM],Object.getOwnPropertyDescriptor(OM.prototype,"spriteFrame"),OM.prototype),S(OM.prototype,"type",[fM,pM,mM],Object.getOwnPropertyDescriptor(OM.prototype,"type"),OM.prototype),S(OM.prototype,"fillType",[vM,gM],Object.getOwnPropertyDescriptor(OM.prototype,"fillType"),OM.prototype),S(OM.prototype,"fillCenter",[yM],Object.getOwnPropertyDescriptor(OM.prototype,"fillCenter"),OM.prototype),S(OM.prototype,"fillStart",[xM,SM],Object.getOwnPropertyDescriptor(OM.prototype,"fillStart"),OM.prototype),S(OM.prototype,"fillRange",[TM,EM],Object.getOwnPropertyDescriptor(OM.prototype,"fillRange"),OM.prototype),S(OM.prototype,"trim",[bM,AM],Object.getOwnPropertyDescriptor(OM.prototype,"trim"),OM.prototype),S(OM.prototype,"grayscale",[vi],Object.getOwnPropertyDescriptor(OM.prototype,"grayscale"),OM.prototype),S(OM.prototype,"sizeMode",[CM,wM,RM],Object.getOwnPropertyDescriptor(OM.prototype,"sizeMode"),OM.prototype),MM=S(OM.prototype,"_spriteFrame",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PM=S(OM.prototype,"_type",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VM.SIMPLE}}),kM=S(OM.prototype,"_fillType",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WM.HORIZONTAL}}),DM=S(OM.prototype,"_sizeMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jM.TRIMMED}}),BM=S(OM.prototype,"_fillCenter",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ia(0,0)}}),LM=S(OM.prototype,"_fillStart",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NM=S(OM.prototype,"_fillRange",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FM=S(OM.prototype,"_isTrimmedMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zM=S(OM.prototype,"_useGrayscale",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UM=S(OM.prototype,"_atlas",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IM=OM))||IM)||IM)||IM)||IM)),Bk=new oa(0,1,0),Lk=new oa,Nk=new pa,Fk=(KM=ii("cc.AmbientInfo"),ZM=Li(dt),KM(($M=S((JM=function(){function e(){i(this,e),x(this,"_skyColor",$M,this),x(this,"_skyIllum",eP,this),x(this,"_groundAlbedo",tP,this),this._resource=null}return r(e,[{key:"activate",value:function(e){this._resource=e,this._resource.skyColor=this._skyColor,this._resource.skyIllum=this._skyIllum,this._resource.groundAlbedo=this._groundAlbedo}},{key:"skyColor",set:function(e){this._skyColor.set(e),this._resource&&(this._resource.skyColor=this._skyColor)},get:function(){return this._skyColor}},{key:"skyIllum",set:function(e){this._skyIllum=e,this._resource&&(this._resource.skyIllum=this.skyIllum)},get:function(){return this._skyIllum}},{key:"groundAlbedo",set:function(e){this._groundAlbedo.set(e),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)},get:function(){return this._groundAlbedo}}]),e}()).prototype,"_skyColor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma(51,128,204,1)}}),eP=S(JM.prototype,"_skyIllum",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oT.SKY_ILLUM}}),tP=S(JM.prototype,"_groundAlbedo",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma(51,51,51,255)}}),S(JM.prototype,"skyColor",[vi],Object.getOwnPropertyDescriptor(JM.prototype,"skyColor"),JM.prototype),S(JM.prototype,"skyIllum",[vi,ZM],Object.getOwnPropertyDescriptor(JM.prototype,"skyIllum"),JM.prototype),S(JM.prototype,"groundAlbedo",[vi],Object.getOwnPropertyDescriptor(JM.prototype,"groundAlbedo"),JM.prototype),QM=JM))||QM);E.AmbientInfo=Fk;var zk=(iP=ii("cc.SkyboxInfo"),nP=Li(kd),rP=Li(kd),iP((sP=S((oP=function(){function e(){i(this,e),x(this,"_envmap",sP,this),x(this,"_isRGBE",lP,this),x(this,"_enabled",cP,this),x(this,"_useIBL",uP,this),this._resource=null}return r(e,[{key:"activate",value:function(e){this._resource=e,this._resource.activate(),this._resource.enabled=this._enabled,this._resource.isRGBE=this._isRGBE,this._resource.envmap=this._envmap,this._resource.useIBL=this._useIBL}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=this._enabled)},get:function(){return this._enabled}},{key:"useIBL",set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)},get:function(){return this._useIBL}},{key:"envmap",set:function(e){this._envmap=e,this._resource&&(this._resource.envmap=this._envmap)},get:function(){return this._envmap}},{key:"isRGBE",set:function(e){this._isRGBE=e,this._resource&&(this._resource.isRGBE=this._isRGBE)},get:function(){return this._isRGBE}}]),e}()).prototype,"_envmap",[nP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lP=S(oP.prototype,"_isRGBE",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cP=S(oP.prototype,"_enabled",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uP=S(oP.prototype,"_useIBL",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(oP.prototype,"enabled",[vi],Object.getOwnPropertyDescriptor(oP.prototype,"enabled"),oP.prototype),S(oP.prototype,"useIBL",[vi],Object.getOwnPropertyDescriptor(oP.prototype,"useIBL"),oP.prototype),S(oP.prototype,"envmap",[vi,rP],Object.getOwnPropertyDescriptor(oP.prototype,"envmap"),oP.prototype),S(oP.prototype,"isRGBE",[vi],Object.getOwnPropertyDescriptor(oP.prototype,"isRGBE"),oP.prototype),aP=oP))||aP);E.SkyboxInfo=zk;var Uk=(hP=ii("cc.FogInfo"),_P=Li(nT),dP=Li(dt),fP=Ti([0,1]),pP=Ai(.01),mP=wi(3),vP=gi((function(){return this._type!==nT.LAYERED&&this._type!==nT.LINEAR})),gP=Li(dt),yP=Ai(.1),xP=wi(4),SP=gi((function(){return this._type===nT.LINEAR})),TP=Li(dt),EP=Ai(.1),bP=wi(5),AP=gi((function(){return this._type===nT.LINEAR})),CP=Li(dt),wP=Ai(.1),RP=wi(6),IP=gi((function(){return this._type!==nT.LINEAR})),OP=Li(dt),MP=Ai(.1),PP=wi(7),kP=gi((function(){return this._type===nT.LAYERED})),DP=Li(dt),BP=Ai(.1),LP=wi(8),NP=gi((function(){return this._type===nT.LAYERED})),hP((ZP=KP=function(){function e(){i(this,e),x(this,"_type",UP,this),x(this,"_fogColor",GP,this),x(this,"_enabled",HP,this),x(this,"_fogDensity",VP,this),x(this,"_fogStart",WP,this),x(this,"_fogEnd",jP,this),x(this,"_fogAtten",qP,this),x(this,"_fogTop",XP,this),x(this,"_fogRange",YP,this),this._resource=null}return r(e,[{key:"activate",value:function(e){this._resource=e,this._resource.enabled=this._enabled,this._resource.fogColor=this._fogColor,this._resource.type=this._type,this._resource.fogDensity=this._fogDensity,this._resource.fogStart=this._fogStart,this._resource.fogEnd=this._fogEnd,this._resource.fogAtten=this._fogAtten,this._resource.fogTop=this._fogTop,this._resource.fogRange=this._fogRange}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"fogColor",set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)},get:function(){return this._fogColor}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),KP.FogType=nT,UP=S((zP=ZP).prototype,"_type",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nT.LINEAR}}),GP=S(zP.prototype,"_fogColor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma("#C8C8C8")}}),HP=S(zP.prototype,"_enabled",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VP=S(zP.prototype,"_fogDensity",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),WP=S(zP.prototype,"_fogStart",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),jP=S(zP.prototype,"_fogEnd",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),qP=S(zP.prototype,"_fogAtten",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),XP=S(zP.prototype,"_fogTop",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),YP=S(zP.prototype,"_fogRange",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),S(zP.prototype,"enabled",[vi],Object.getOwnPropertyDescriptor(zP.prototype,"enabled"),zP.prototype),S(zP.prototype,"fogColor",[vi],Object.getOwnPropertyDescriptor(zP.prototype,"fogColor"),zP.prototype),S(zP.prototype,"type",[vi,_P],Object.getOwnPropertyDescriptor(zP.prototype,"type"),zP.prototype),S(zP.prototype,"fogDensity",[dP,fP,pP,Ci,mP,vP],Object.getOwnPropertyDescriptor(zP.prototype,"fogDensity"),zP.prototype),S(zP.prototype,"fogStart",[gP,yP,xP,SP],Object.getOwnPropertyDescriptor(zP.prototype,"fogStart"),zP.prototype),S(zP.prototype,"fogEnd",[TP,EP,bP,AP],Object.getOwnPropertyDescriptor(zP.prototype,"fogEnd"),zP.prototype),S(zP.prototype,"fogAtten",[CP,wP,RP,IP],Object.getOwnPropertyDescriptor(zP.prototype,"fogAtten"),zP.prototype),S(zP.prototype,"fogTop",[OP,MP,PP,kP],Object.getOwnPropertyDescriptor(zP.prototype,"fogTop"),zP.prototype),S(zP.prototype,"fogRange",[DP,BP,LP,NP],Object.getOwnPropertyDescriptor(zP.prototype,"fogRange"),zP.prototype),FP=zP))||FP),Gk=(QP=ii("cc.ShadowsInfo"),JP=Li(fS),$P=gi((function(){return this._type===fS.Planar})),ek=Li(dt),tk=gi((function(){return this._type===fS.Planar})),ik=Li(pS),nk=gi((function(){return this._type===fS.ShadowMap})),rk=Li(dt),ak=gi((function(){return this._type===fS.ShadowMap})),ok=Li(dt),sk=gi((function(){return this._type===fS.ShadowMap})),lk=Li(dt),ck=gi((function(){return this._type===fS.ShadowMap})),uk=gi((function(){return this._type===fS.ShadowMap})),hk=Li(dt),_k=gi((function(){return this._type===fS.ShadowMap})),QP((pk=S((fk=function(){function e(){i(this,e),x(this,"_type",pk,this),x(this,"_enabled",mk,this),x(this,"_normal",vk,this),x(this,"_distance",gk,this),x(this,"_shadowColor",yk,this),x(this,"_pcf",xk,this),x(this,"_near",Sk,this),x(this,"_far",Tk,this),x(this,"_aspect",Ek,this),x(this,"_orthoSize",bk,this),x(this,"_size",Ak,this),this._resource=null}return r(e,[{key:"setPlaneFromNode",value:function(e){e.getWorldRotation(Nk),this.normal=oa.transformQuat(Lk,Bk,Nk),e.getWorldPosition(Lk),this.distance=oa.dot(this._normal,Lk)}},{key:"activate",value:function(e){this._resource=e,this._resource.type=this._type,this._resource.near=this._near,this._resource.far=this._far,this._resource.orthoSize=this._orthoSize,this._resource.size=this._size,this._resource.normal=this._normal,this._resource.distance=this._distance,this._resource.shadowColor=this._shadowColor,this._resource.enabled=this._enabled}},{key:"enabled",set:function(e){this._enabled=e,this._resource&&(this._resource.enabled=e)},get:function(){return this._enabled}},{key:"type",set:function(e){this._type=e,this._resource&&(this._resource.type=e)},get:function(){return this._type}},{key:"shadowColor",set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)},get:function(){return this._shadowColor}},{key:"normal",set:function(e){oa.copy(this._normal,e),this._resource&&(this._resource.normal=e)},get:function(){return this._normal}},{key:"distance",set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)},get:function(){return this._distance}},{key:"pcf",set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)},get:function(){return this._pcf}},{key:"near",set:function(e){this._near=e,this._resource&&(this._resource.near=e)},get:function(){return this._near}},{key:"far",set:function(e){this._far=e,this._resource&&(this._resource.far=e)},get:function(){return this._far}},{key:"orthoSize",set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)},get:function(){return this._orthoSize}},{key:"shadowMapSize",set:function(e){this._size.set(e),this._resource&&(this._resource.size=e)},get:function(){return this._size}},{key:"aspect",set:function(e){this._aspect=e,this._resource&&(this._resource.aspect=e)},get:function(){return this._aspect}}]),e}()).prototype,"_type",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fS.Planar}}),mk=S(fk.prototype,"_enabled",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vk=S(fk.prototype,"_normal",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(0,1,0)}}),gk=S(fk.prototype,"_distance",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yk=S(fk.prototype,"_shadowColor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma(0,0,0,76)}}),xk=S(fk.prototype,"_pcf",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pS.HARD}}),Sk=S(fk.prototype,"_near",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Tk=S(fk.prototype,"_far",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),Ek=S(fk.prototype,"_aspect",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bk=S(fk.prototype,"_orthoSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Ak=S(fk.prototype,"_size",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ia(512,512)}}),S(fk.prototype,"enabled",[vi],Object.getOwnPropertyDescriptor(fk.prototype,"enabled"),fk.prototype),S(fk.prototype,"type",[vi,JP],Object.getOwnPropertyDescriptor(fk.prototype,"type"),fk.prototype),S(fk.prototype,"shadowColor",[vi],Object.getOwnPropertyDescriptor(fk.prototype,"shadowColor"),fk.prototype),S(fk.prototype,"normal",[$P],Object.getOwnPropertyDescriptor(fk.prototype,"normal"),fk.prototype),S(fk.prototype,"distance",[ek,tk],Object.getOwnPropertyDescriptor(fk.prototype,"distance"),fk.prototype),S(fk.prototype,"pcf",[ik,nk],Object.getOwnPropertyDescriptor(fk.prototype,"pcf"),fk.prototype),S(fk.prototype,"near",[rk,ak],Object.getOwnPropertyDescriptor(fk.prototype,"near"),fk.prototype),S(fk.prototype,"far",[ok,sk],Object.getOwnPropertyDescriptor(fk.prototype,"far"),fk.prototype),S(fk.prototype,"orthoSize",[lk,ck],Object.getOwnPropertyDescriptor(fk.prototype,"orthoSize"),fk.prototype),S(fk.prototype,"shadowMapSize",[uk],Object.getOwnPropertyDescriptor(fk.prototype,"shadowMapSize"),fk.prototype),S(fk.prototype,"aspect",[hk,_k],Object.getOwnPropertyDescriptor(fk.prototype,"aspect"),fk.prototype),dk=fk))||dk);E.ShadowsInfo=Gk;var Hk,Vk,Wk,jk,qk=(Ck=ii("cc.SceneGlobals"),wk=Li(zk),Ck((Ok=S((Ik=function(){function e(){i(this,e),x(this,"ambient",Ok,this),x(this,"shadows",Mk,this),x(this,"_skybox",Pk,this),x(this,"fog",kk,this)}return r(e,[{key:"activate",value:function(){var e=E.director.root.pipeline;this.ambient.activate(e.ambient),this.skybox.activate(e.skybox),this.shadows.activate(e.shadows),this.fog.activate(e.fog)}},{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}()).prototype,"ambient",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fk}}),Mk=S(Ik.prototype,"shadows",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Gk}}),Pk=S(Ik.prototype,"_skybox",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zk}}),kk=S(Ik.prototype,"fog",[vi,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Uk}}),S(Ik.prototype,"skybox",[vi,wk],Object.getOwnPropertyDescriptor(Ik.prototype,"skybox"),Ik.prototype),Rk=Ik))||Rk);E.SceneGlobals=qk;var Xk,Yk=e("Scene",ii("cc.Scene")((S((Vk=function(e){function t(e){var n;return i(this,t),x(n=u(this,s(t).call(this,e)),"autoReleaseAssets",Wk,c(n)),x(n,"_globals",jk,c(n)),n._renderScene=null,n.dependAssets=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=oa.ZERO,n._rot=pa.IDENTITY,n._scale=oa.ONE,n._mat=Ta.IDENTITY,n._dirtyFlags=0,n._activeInHierarchy=!1,E.director&&E.director.root&&(n._renderScene=E.director.root.createScene({})),n._inited=!E.game||!E.game._isCloning,n}return o(t,e),r(t,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}}]),r(t,[{key:"destroy",value:function(){var e=_(s(t.prototype),"destroy",this).call(this);return E.director.root.destroyScene(this._renderScene),this._activeInHierarchy=!1,e}},{key:"addComponent",value:function(e){throw new Error(X(3822))}},{key:"_onHierarchyChanged",value:function(){}},{key:"_onBatchCreated",value:function(){_(s(t.prototype),"_onBatchCreated",this).call(this);for(var e=this._children.length,i=0;i<e;++i)this._children[i]._onBatchCreated()}},{key:"_onBatchRestored",value:function(){this._onBatchCreated()}},{key:"getPosition",value:function(e){return oa.copy(e||new oa,oa.ZERO)}},{key:"getRotation",value:function(e){return pa.copy(e||new pa,pa.IDENTITY)}},{key:"getScale",value:function(e){return oa.copy(e||new oa,oa.ONE)}},{key:"getWorldPosition",value:function(e){return oa.copy(e||new oa,oa.ZERO)}},{key:"getWorldRotation",value:function(e){return pa.copy(e||new pa,pa.IDENTITY)}},{key:"getWorldScale",value:function(e){return oa.copy(e||new oa,oa.ONE)}},{key:"getWorldMatrix",value:function(e){return Ta.copy(e||new Ta,Ta.IDENTITY)}},{key:"getWorldRS",value:function(e){return Ta.copy(e||new Ta,Ta.IDENTITY)}},{key:"getWorldRT",value:function(e){return Ta.copy(e||new Ta,Ta.IDENTITY)}},{key:"updateWorldTransform",value:function(){}},{key:"_instantiate",value:function(){}},{key:"_load",value:function(){this._inited||(this._onBatchCreated(),this._inited=!0),this.walk(xv._setScene)}},{key:"_activate",value:function(e){e=!1!==e,E.director._nodeActivator.activateNode(this,e),this._globals.activate()}},{key:"position",get:function(){return oa.ZERO}},{key:"worldPosition",get:function(){return oa.ZERO}},{key:"rotation",get:function(){return pa.IDENTITY}},{key:"worldRotation",get:function(){return pa.IDENTITY}},{key:"scale",get:function(){return oa.ONE}},{key:"worldScale",get:function(){return oa.ONE}},{key:"eulerAngles",get:function(){return oa.ZERO}},{key:"worldMatrix",get:function(){return Ta.IDENTITY}}]),t}(xv)).prototype,"globals",[vi],Object.getOwnPropertyDescriptor(Vk.prototype,"globals"),Vk.prototype),Wk=S(Vk.prototype,"autoReleaseAssets",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jk=S(Vk.prototype,"_globals",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qk}}),Hk=Vk))||Hk);E.Scene=Yk;var Kk=Vi.Flags.HideInHierarchy,Zk=e("PrivateNode",ii("cc.PrivateNode")(Xk=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,e)))._objFlags|=Kk,n}return o(t,e),t}(ig))||Xk);E.PrivateNode=Zk;var Qk=Fe.fastRemoveAt,Jk=Vi.Flags.IsStartCalled,$k=Vi.Flags.IsOnEnableCalled;Vi.Flags.IsEditorOnEnableCalled;function eD(e,t){for(var i=t.constructor._executionOrder,n=t._id,r=0,a=e.length-1,o=a>>>1;r<=a;o=r+a>>>1){var s=e[o],l=s.constructor._executionOrder;if(l>i)a=o-1;else if(l<i)r=o+1;else{var c=s._id;if(c>n)a=o-1;else{if(!(c<n))return o;r=o+1}}}return~r}function tD(e,t){for(var i=e.array,n=e.i+1;n<i.length;){var r=i[n];r._enabled&&r.node._activeInHierarchy?++n:(e.removeAt(n),t&&(r._objFlags&=~t))}}var iD=function e(t){i(this,e),this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var n=Q;this._zero=new n([]),this._neg=new n([]),this._pos=new n([]),this._invoke=t};function nD(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}iD.stableRemoveInactive=tD;var rD=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)}},{key:"cancelInactive",value:function(e){tD(this._zero,e),tD(this._neg,e),tD(this._pos,e)}},{key:"invoke",value:function(){var e=this._neg;e.array.length>0&&(e.array.sort(nD),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(nD),this._invoke(t),t.array.length=0)}}]),t}(iD),aD=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"add",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,n=eD(i,e);n<0&&i.splice(~n,0,e)}}},{key:"remove",value:function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,n=eD(i.array,e);n>=0&&i.removeAt(n)}}},{key:"invoke",value:function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)}}]),t}(iD);function oD(e,t,i){var n="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",r=t?Function("it","dt",n):Function("it",n);return function(e,t,i){return function(n,r){try{t(n,r)}catch(t){E._throw(t);var a=n.array;for(i&&(a[n.i]._objFlags|=i),++n.i;n.i<a.length;++n.i)try{e(a[n.i],r)}catch(e){E._throw(e),i&&(a[n.i]._objFlags|=i)}}}}(Function("c","dt",e),r,i)}var sD=oD("c.start();c._objFlags|="+Jk,!1,Jk),lD=oD("c.update(dt)",!0),cD=oD("c.lateUpdate(dt)",!0),uD=function(e){var t=E.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var n=i[e.i];if(n._enabled)n.onEnable(),!n.node._activeInHierarchy||t._onEnabled(n)}},hD=function(){function e(){i(this,e),this._deferredComps=[],this.unscheduleAll()}return r(e,[{key:"unscheduleAll",value:function(){this.startInvoker=new rD(sD),this.updateInvoker=new aD(lD),this.lateUpdateInvoker=new aD(cD),this._updating=!1}},{key:"_onEnabled",value:function(e){E.director.getScheduler().resumeTarget(e),e._objFlags|=$k,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)}},{key:"_onDisabled",value:function(e){E.director.getScheduler().pauseTarget(e),e._objFlags&=~$k;var t=this._deferredComps.indexOf(e);t>=0?Qk(this._deferredComps,t):(!e.start||e._objFlags&Jk||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))}},{key:"enableComp",value:function(e,t){if(!(e._objFlags&$k)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}}},{key:"disableComp",value:function(e){e._objFlags&$k&&(e.onDisable&&e.onDisable(),this._onDisabled(e))}},{key:"startPhase",value:function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}},{key:"updatePhase",value:function(e){this.updateInvoker.invoke(e)}},{key:"lateUpdatePhase",value:function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()}},{key:"_startForNewComps",value:function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}},{key:"_scheduleImmediate",value:function(e){"function"!=typeof e.start||e._objFlags&Jk||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)}},{key:"_deferredSchedule",value:function(){for(var e=this._deferredComps,t=0,i=e.length;t<i;t++)this._scheduleImmediate(e[t]);e.length=0}}]),e}(),_D=Vi.Flags.IsPreloadStarted,dD=Vi.Flags.IsOnLoadStarted,fD=Vi.Flags.IsOnLoadCalled,pD=Vi.Flags.Deactivating,mD=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"add",value:function(e){this._zero.array.push(e)}},{key:"remove",value:function(e){this._zero.fastRemove(e)}},{key:"cancelInactive",value:function(e){iD.stableRemoveInactive(this._zero,e)}},{key:"invoke",value:function(){this._invoke(this._zero),this._zero.array.length=0}}]),t}(iD),vD=oD("c.__preload();"),gD=oD("c.onLoad();c._objFlags|="+fD,!1,fD),yD=new Ne(4);function xD(e,t,i){t?e._removeComponent(t):Fe.removeAt(e._components,i)}yD.get=function(){var e=this._get()||{preload:new mD(vD),onLoad:new rD(gD),onEnable:new rD(uD)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var SD,TD,ED,bD,AD,CD,wD,RD,ID,OD=e("NodeActivator",function(){function e(){i(this,e),this.resetComp=void 0,this.reset()}return r(e,[{key:"reset",value:function(){this._activatingStack=[]}},{key:"activateNode",value:function(e,t){if(t){var i=yD.get();this._activatingStack.push(i),this._activateNodeRecursively(e,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),yD.put(i)}else{this._deactivateNodeRecursively(e);for(var n,r=y(this._activatingStack);!(n=r()).done;){var a=n.value;a.preload.cancelInactive(_D),a.onLoad.cancelInactive(dD),a.onEnable.cancelInactive()}}e.emit("active-in-hierarchy-changed",e)}},{key:"activateComp",value:function(e,t,i,n){if(e._objFlags&_D||(e._objFlags|=_D,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&dD||(e._objFlags|=dD,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=fD):e._objFlags|=fD),e._enabled){if(!e.node._activeInHierarchy)return;E.director._compScheduler.enableComp(e,n)}}},{key:"destroyComp",value:function(e){E.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&fD&&e.onDestroy()}},{key:"_activateNodeRecursively",value:function(e,t,i,n){if(e._objFlags&pD)V(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,a=0;a<r;++a){var o=e._components[a];o instanceof E.Component?this.activateComp(o,t,i,n):(xD(e,o,a),--a,--r)}e._childArrivalOrder=e._children.length;for(var s=0,l=e._children.length;s<l;++s){var c=e._children[s];c._active&&this._activateNodeRecursively(c,t,i,n)}e._onPostActivated(!0)}}},{key:"_deactivateNodeRecursively",value:function(e){e._objFlags|=pD,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var n=e._components[i];if(n._enabled&&(E.director._compScheduler.disableComp(n),e._activeInHierarchy))return void(e._objFlags&=~pD)}for(var r=0,a=e._children.length;r<a;++r){var o=e._children[r];if(o._activeInHierarchy&&(this._deactivateNodeRecursively(o),e._activeInHierarchy))return void(e._objFlags&=~pD)}e._onPostActivated(!1),e._objFlags&=~pD}}]),e}());ka(xv.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),ka(ig.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new ia),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new wa),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setContentSize(e,t)}}]),Da(ig.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),Da(Ph,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),ka(Ph,"Layers",[{name:"Default",newName:"DEFAULT",target:Ph.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Ph.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Ph.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Ph.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Ph.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Ph.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Ph.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Ph.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Ph,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Ph,targetName:"Layers"}]),Da(Ph.Enum,"Layers.Enum",[{name:"ALWAYS"}]),Da(Ph.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var MD=e("SubContextView",(SD=ii("cc.SubContextView"),TD=mi("i18n:cc.SubContextView"),ED=ri(110),bD=ni(jv),AD=_i("Components/SubContextView"),CD=Si(""),SD(wD=TD(wD=ED(wD=bD(wD=AD((S((RD=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_fps",ID,c(e)),e._sprite=void 0,e._imageAsset=void 0,e._context=void 0,e._updatedTime=0,e._updateInterval=0,e._firstlyEnabled=!0,e._sprite=null,e._imageAsset=new $u,e._context=null,e._updatedTime=performance.now(),e}return o(t,e),r(t,[{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1/e,this._updateSubContextFrameRate())}}]),r(t,[{key:"onLoad",value:function(){if(window.__globalAdapter&&__globalAdapter.getOpenDataContext){this._updateInterval=1e3/this._fps,this._context=__globalAdapter.getOpenDataContext(),this.reset();var e=this._imageAsset,t=this._context.canvas;if(e.reset(t),e._texture.create(t.width,t.height),this._sprite=this.node.getComponent(Dk),this._sprite||(this._sprite=this.node.addComponent(Dk)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._imageAsset._texture;else{var i=new E.SpriteFrame;i.texture=this._imageAsset._texture,this._sprite.spriteFrame=i}}else this.enabled=!1}},{key:"onEnable",value:function(){this._firstlyEnabled&&this._context?(this._context.postMessage({fromEngine:!0,event:"boot"}),this._firstlyEnabled=!1):this._runSubContextMainLoop(),this._registerNodeEvent(),this._updateSubContextFrameRate(),this.updateSubContextViewport()}},{key:"onDisable",value:function(){this._unregisterNodeEvent(),this._stopSubContextMainLoop()}},{key:"update",value:function(e){if(void 0===e)return this._context&&this._context.postMessage({fromEngine:!0,event:"step"}),void this._updateSubContextTexture();performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())}},{key:"reset",value:function(){if(this._context){this.updateSubContextViewport();var e=this._context.canvas,t=this.node.getComponent(jv);e&&(e.width=t.width,e.height=t.height)}}},{key:"updateSubContextViewport",value:function(){if(this._context){var e=this.node.getComponent(jv).getBoundingBoxToWorld(),t=PO.getScaleX(),i=PO.getScaleY(),n=PO.getViewportRect();this._context.postMessage({fromEngine:!0,event:"viewport",x:e.x*t+n.x,y:e.y*i+n.y,width:e.width*t,height:e.height*i})}}},{key:"_updateSubContextTexture",value:function(){var e=this._imageAsset;if(e&&this._context&&!(e.width<=0||e.height<=0)){var t=this._context.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._imageAsset._texture.create(t.width,t.height),this._imageAsset._texture.uploadData(t)}}},{key:"_registerNodeEvent",value:function(){this.node.on(ig.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.on(ig.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off(ig.EventType.TRANSFORM_CHANGED,this.updateSubContextViewport,this),this.node.off(ig.EventType.SIZE_CHANGED,this.updateSubContextViewport,this)}},{key:"_runSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!0})}},{key:"_stopSubContextMainLoop",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"mainLoop",value:!1})}},{key:"_updateSubContextFrameRate",value:function(){this._context&&this._context.postMessage({fromEngine:!0,event:"frameRate",value:this._fps})}}]),t}(Yr)).prototype,"fps",[CD],Object.getOwnPropertyDescriptor(RD.prototype,"fps"),RD.prototype),ID=S(RD.prototype,"_fps",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),wD=RD))||wD)||wD)||wD)||wD)||wD));E.SubContextView=MD;var PD=e("System",function(){function e(){i(this,e),this._id="",this._priority=0,this._executeInEditMode=!1}return r(e,[{key:"init",value:function(){}},{key:"update",value:function(e){}},{key:"postUpdate",value:function(e){}},{key:"priority",set:function(e){this._priority=e},get:function(){return this._priority}},{key:"id",set:function(e){this._id=e},get:function(){return this._id}}],[{key:"sortByPriority",value:function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0}}]),e}()),kD=new ie("Scheduler"),DD=function e(t,n,r,a){i(this,e),this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=n,this.paused=r,this.markedForDeletion=a};DD.get=function(e,t,i,n){var r=DD._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=i,r.markedForDeletion=n):r=new DD(e,t,i,n),r},DD.put=function(e){DD._listEntries.length<20&&(e.target=null,DD._listEntries.push(e))},DD._listEntries=[];var BD=function e(t,n,r,a){i(this,e),this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=n,this.target=r,this.callback=a};BD.get=function(e,t,i,n){var r=BD._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=i,r.callback=n):r=new BD(e,t,i,n),r},BD.put=function(e){BD._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,BD._hashUpdateEntries.push(e))},BD._hashUpdateEntries=[];var LD=function e(t,n,r,a,o,s){i(this,e),this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=n,this.timerIndex=r,this.currentTimer=a,this.currentTimerSalvaged=o,this.paused=s};LD.get=function(e,t,i,n,r,a){var o=LD._hashTimerEntries.pop();return o?(o.timers=e,o.target=t,o.timerIndex=i,o.currentTimer=n,o.currentTimerSalvaged=r,o.paused=a):o=new LD(e,t,i,n,r,a),o},LD.put=function(e){LD._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,LD._hashTimerEntries.push(e))},LD._hashTimerEntries=[];var ND=function(){function e(){i(this,e),this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}return r(e,[{key:"initWithCallback",value:function(e,t,i,n,r,a){return this._lock=!1,this._scheduler=e,this._target=i,this._callback=t,this._elapsed=-1,this._interval=n,this._delay=a,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===E.macro.REPEAT_FOREVER,!0}},{key:"getInterval",value:function(){return this._interval}},{key:"setInterval",value:function(e){this._interval=e}},{key:"update",value:function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}},{key:"getCallback",value:function(){return this._callback}},{key:"trigger",value:function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}},{key:"cancel",value:function(){this._scheduler.unschedule(this._callback,this._target)}}]),e}();ND._timers=[],ND.get=function(){return ND._timers.pop()||new ND},ND.put=function(e){ND._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,ND._timers.push(e))};var FD=e("Scheduler",function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=_e(!0),e._hashForTimers=_e(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}return o(t,e),r(t,null,[{key:"enableForTarget",value:function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?G(1513):e.id=kD.getNewId())}}]),r(t,[{key:"setTimeScale",value:function(e){this._timeScale=e}},{key:"getTimeScale",value:function(){return this._timeScale}},{key:"update",value:function(e){var t,i,n,r,a;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,n=(i=this._updatesNegList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updates0List).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,n=(i=this._updatesPosList).length;t<n;t++)(r=i[t]).paused||r.markedForDeletion||r.target.update(e);var o=this._arrayForTimers;for(t=0;t<o.length;t++){if(a=o[t],this._currentTarget=a,this._currentTargetSalvaged=!1,!a.paused)for(a.timerIndex=0;a.timerIndex<a.timers.length;++a.timerIndex)a.currentTimer=a.timers[a.timerIndex],a.currentTimerSalvaged=!1,a.currentTimer.update(e),a.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,i=this._updatesNegList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updates0List;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,i=this._updatesPosList;t<i.length;)(r=i[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null}},{key:"schedule",value:function(e,t,i,n,r,a){if("function"!=typeof e){var o=e;e=t,t=o}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(a=!!n,n=E.macro.REPEAT_FOREVER,r=0),q(t,1502);var s=t.uuid||t.id;if(s){var l,c,u=this._hashForTimers[s];if(u?u.paused!==a&&G(1511):(u=LD.get(null,t,0,null,null,a),this._arrayForTimers.push(u),this._hashForTimers[s]=u),null==u.timers)u.timers=[];else for(c=0;c<u.timers.length;++c)if((l=u.timers[c])&&e===l._callback)return z(1507,l.getInterval(),i),void(l._interval=i);(l=ND.get()).initWithCallback(this,e,t,i,n,r),u.timers.push(l),this._currentTarget===u&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else V(1510)}},{key:"scheduleUpdate",value:function(e,t,i){var n=e.uuid||e.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return z(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(e)}var a,o=DD.get(e,t,i,!1);0===t?(a=this._updates0List,this._appendIn(a,o)):(a=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(a,o,t)),this._hashForUpdates[n]=BD.get(a,o,e,null)}else V(1510)}},{key:"unschedule",value:function(e,t){if(t&&e){var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(n)for(var r=n.timers,a=0,o=r.length;a<o;a++){var s=r[a];if(e===s._callback)return s!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(a,1),ND.put(s),n.timerIndex>=a&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}else V(1510)}}},{key:"unscheduleUpdate",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForUpdates[t];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else V(1510)}}},{key:"unscheduleAllForTarget",value:function(e){if(e){var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];if(i){var n=i.timers;n.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,a=n.length;r<a;r++)ND.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(e)}else V(1510)}}},{key:"unscheduleAll",value:function(){this.unscheduleAllWithMinPriority(E.Scheduler.PRIORITY_SYSTEM)}},{key:"unscheduleAllWithMinPriority",value:function(e){var t,i,n,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)i=r[t],this.unscheduleAllForTarget(i.target);var a=0;if(e<0)for(t=0;t<this._updatesNegList.length;)a=this._updatesNegList.length,(n=this._updatesNegList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)a=this._updates0List.length,(n=this._updates0List[t])&&this.unscheduleUpdate(n.target),a===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)a=this._updatesPosList.length,(n=this._updatesPosList[t])&&n.priority>=e&&this.unscheduleUpdate(n.target),a===this._updatesPosList.length&&t++}},{key:"isScheduled",value:function(e,t){q(e,1508),q(t,1509);var i=t.uuid||t.id;if(i){var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,a=0;a<r.length;++a){if(e===r[a]._callback)return!0}return!1}V(1510)}},{key:"pauseAllTargets",value:function(){return this.pauseAllTargetsWithMinPriority(E.Scheduler.PRIORITY_SYSTEM)}},{key:"pauseAllTargetsWithMinPriority",value:function(e){var t,i,n,r,a=[],o=this._arrayForTimers;for(i=0,n=o.length;i<n;i++)(t=o[i])&&(t.paused=!0,a.push(t.target));if(e<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));if(e<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,a.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=e&&(r.paused=!0,a.push(r.target));return a}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])}},{key:"pauseTarget",value:function(e){q(e,1503);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!0);var n=this._hashForUpdates[t];n&&(n.entry.paused=!0)}else V(1510)}},{key:"resumeTarget",value:function(e){q(e,1504);var t=e.uuid||e.id;if(t){var i=this._hashForTimers[t];i&&(i.paused=!1);var n=this._hashForUpdates[t];n&&(n.entry.paused=!1)}else V(1510)}},{key:"isTargetPaused",value:function(e){q(e,1505);var t=e.uuid||e.id;if(!t)return V(1510),!1;var i=this._hashForTimers[t];if(i)return i.paused;var n=this._hashForUpdates[t];return!!n&&n.entry.paused}},{key:"_removeHashElement",value:function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}LD.put(e)}},{key:"_removeUpdateFromHash",value:function(e){var t=e.target.uuid||e.target.id,i=this._hashForUpdates[t];if(i){for(var n=i.list,r=i.entry,a=0,o=n.length;a<o;a++)if(n[a]===r){n.splice(a,1);break}delete this._hashForUpdates[t],DD.put(r),BD.put(i)}}},{key:"_priorityIn",value:function(e,t,i){for(var n=0;n<e.length;n++)if(i<e[n].priority)return void e.splice(n,0,t);e.push(t)}},{key:"_appendIn",value:function(e,t){e.push(t)}}]),t}(PD));FD.PRIORITY_SYSTEM=1<<31,FD.PRIORITY_NON_SYSTEM=FD.PRIORITY_SYSTEM+1,FD.ID="scheduler",E.Scheduler=FD;var zD=function(){function e(t){i(this,e),this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new jg(t),this.jointAnimationInfo=new qg(t)}return r(e,[{key:"releaseSkeleton",value:function(e){this.jointTexturePool.releaseSkeleton(e)}},{key:"releaseAnimationClip",value:function(e){this.jointTexturePool.releaseAnimationClip(e)}},{key:"clear",value:function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()}}]),e}(),UD=[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_COLOR,jo.RGBA32F)],GD=[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_TEX_COORD,jo.RG32F),new al(Vo.ATTR_COLOR,jo.RGBA32F)];function HD(e){for(var t=0,i=0;i<e.length;i++){var n=e[i];t+=Ds[n.format].count}return t}function VD(e){for(var t=0,i=0;i<e.length;i++){var n=e[i];t+=Ds[n.format].size}return t}var WD=Object.freeze({__proto__:null,vfmt:UD,vfmtPosUvColor:GD,getAttributeFormatBytes:HD,getAttributeStride:VD});e("UIVertexFormat",WD);var jD,qD=e("MeshBuffer",function(){function e(t){i(this,e),this.vData=null,this.iData=null,this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this._attributes=null,this._vertexBuffers=[],this._indexBuffer=null,this._iaInfo=null,this._batcher=void 0,this._dirty=!1,this._vertexFormatBytes=0,this._initVDataCount=0,this._initIDataCount=1536,this._outOfCallback=null,this._hInputAssemblers=[],this._nextFreeIAHandle=0,this._batcher=t}return r(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}}]),r(e,[{key:"initialize",value:function(e,t){this._outOfCallback=t;var i=HD(e);this._vertexFormatBytes=i*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes;var n=Float32Array.BYTES_PER_ELEMENT*i;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this._indexBuffer=this._batcher.device.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,r,r))),this._attributes=e,this._iaInfo=new ol(this.attributes,this.vertexBuffers,this.indexBuffer),this._reallocBuffer()}},{key:"request",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6;this.lastByteOffset=this.byteOffset;var i=this.byteOffset+e*this._vertexFormatBytes,n=this.indicesOffset+t;if(e+this.vertexOffset>65535)return this._batcher.autoMergeBatches(),this._outOfCallback&&this._outOfCallback.call(this._batcher,e,t),!1;var r=this.vData.byteLength,a=this.iData.length;if(i>r||n>a){for(;r<i||a<n;)this._initVDataCount*=2,this._initIDataCount*=2,r=4*this._initVDataCount,a=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=e,this.indicesOffset+=t,this.byteOffset=i,this._dirty=!0,!0}},{key:"reset",value:function(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1}},{key:"destroy",value:function(){this._attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this._indexBuffer=null;for(var e=0;e<this._hInputAssemblers.length;e++)vf.free(this._hInputAssemblers[e]);this._hInputAssemblers.length=0}},{key:"recordBatch",value:function(){var e=this.indicesOffset-this.indicesStart;if(!e)return 0;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(vf.alloc(this._batcher.device,this._iaInfo));var t=this._hInputAssemblers[this._nextFreeIAHandle++],i=vf.get(t);return i.firstIndex=this.indicesStart,i.indexCount=e,t}},{key:"uploadData",value:function(){if(0!==this.byteOffset&&this._dirty){var e=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),t=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(e),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(t)}}},{key:"_reallocBuffer",value:function(){this._reallocVData(!0),this._reallocIData(!0)}},{key:"_reallocVData",value:function(e){var t;if(this.vData&&(t=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),t&&e)for(var i=new Uint8Array(this.vData.buffer),n=0,r=t.length;n<r;n++)i[n]=t[n]}},{key:"_reallocIData",value:function(e){var t=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),t&&e)for(var i=this.iData,n=0,r=t.length;n<r;n++)i[n]=t[n]}}]),e}());qD.OPACITY_OFFSET=8,function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL"}(jD||(jD={}));var XD=e("StencilManager",function(){function e(){i(this,e),this.stage=jD.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:es.ALWAYS,stencilMask:65535,writeMask:65535,failOp:ts.KEEP,zFailOp:ts.KEEP,passOp:ts.KEEP,ref:1}}return r(e,[{key:"pushMask",value:function(e){this._maskStack.push(e)}},{key:"clear",value:function(){this.stage=jD.CLEAR}},{key:"enterLevel",value:function(){this.stage=jD.ENTER_LEVEL}},{key:"enableMask",value:function(){this.stage=jD.ENABLED}},{key:"exitMask",value:function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=jD.DISABLED:this.stage=jD.ENABLED)}},{key:"handleMaterial",value:function(e){var t=this._stencilPattern;if(this.stage===jD.DISABLED)t.stencilTest=!1,t.func=es.ALWAYS,t.failOp=ts.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1;else if(t.stencilTest=!0,this.stage===jD.ENABLED)t.func=es.EQUAL,t.failOp=ts.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask();else if(this.stage===jD.CLEAR){var i=this._maskStack[this._maskStack.length-1];t.func=es.NEVER,t.failOp=i.inverted?ts.REPLACE:ts.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}else if(this.stage===jD.ENTER_LEVEL){var n=this._maskStack[this._maskStack.length-1];t.func=es.NEVER,t.failOp=n.inverted?ts.ZERO:ts.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()}return this._changed(e.passes[0])}},{key:"getWriteMask",value:function(){return 1<<this._maskStack.length-1}},{key:"getExitWriteMask",value:function(){return 1<<this._maskStack.length}},{key:"getStencilRef",value:function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e}},{key:"reset",value:function(){this._maskStack.length=0,this.stage=jD.DISABLED}},{key:"_changed",value:function(e){var t=e.depthStencilState,i=this._stencilPattern;return i.stencilTest!==t.stencilTestFront||i.func!==t.stencilFuncFront||i.failOp!==t.stencilFailOpFront||i.zFailOp!==t.stencilZFailOpFront||i.passOp!==t.stencilPassOpFront||i.stencilMask!==t.stencilReadMaskFront||i.writeMask!==t.stencilWriteMaskFront||i.ref!==t.stencilRefFront}},{key:"pattern",get:function(){return this._stencilPattern}}]),e}());XD.sharedManager=null,XD.sharedManager=new XD;var YD=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this))).type=Mb.UI_BATCH,e}return o(t,e),r(t,[{key:"initialize",value:function(){_(s(t.prototype),"initialize",this).call(this),this._subModel=new KD,this._subModel.initialize(),this._subModels[0]=this._subModel}},{key:"updateTransform",value:function(){}},{key:"updateUBOs",value:function(e){for(var t=this._subModels,i=0;i<t.length;i++)t[i].update();this._updateStamp=e,this._transformUpdated&&(this._transformUpdated=!1)}},{key:"directInitialize",value:function(e){this._subModel.directInitialize(e.material.passes,e.hInputAssembler,e.hDescriptorSet),xf.assign(this._subModelArrayHandle,0,this._subModel.handle)}},{key:"destroy",value:function(){this._subModel.destroy(),_(s(t.prototype),"destroy",this).call(this)}}]),t}(zb),KD=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"initialize",value:function(){this._handle=wf.alloc(),wf.set(this._handle,Tf.PRIORITY,Dh.DEFAULT)}},{key:"directInitialize",value:function(e,t,i){this._passes=e,this._flushPassInfo(),wf.set(this._handle,Tf.INPUT_ASSEMBLER,t),wf.set(this._handle,Tf.DESCRIPTOR_SET,i),this._inputAssembler=vf.get(t),this._descriptorSet=mf.get(i)}},{key:"destroy",value:function(){wf.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=Dh.DEFAULT,this._handle=0,this._patches=null,this._subMesh=null,this._passes=null}}]),t}(Yg),ZD=new Bl(null),QD=function(){function e(){i(this,e),this.bufferBatch=null,this.camera=null,this.model=null,this.material=null,this.texture=null,this.sampler=null,this.hInputAssembler=0,this.hDescriptorSet=0,this.useLocalData=null,this.isStatic=!1;var t=E.director.root,n=qp.get("builtin-sprite").shaders[0].name;yp.getGFXShader(t.device,n,{USE_TEXTURE:!0},t.pipeline),ZD.layout=yp.getPipelineLayout(n).setLayouts[Gh.LOCAL],this.hDescriptorSet=mf.alloc(t.device,ZD)}return r(e,[{key:"destroy",value:function(e){this.hDescriptorSet&&(mf.free(this.hDescriptorSet),this.hDescriptorSet=0)}},{key:"clear",value:function(){this.bufferBatch=null,this.hInputAssembler=0,this.camera=null,this.material=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1}}]),e}(),JD=function(){function e(){i(this,e),this._material=null,this._pass=null,this._hDescriptorSet=0,this._refCount=0}return r(e,[{key:"initialize",value:function(e){return!!e.material&&(this._material=new sm,this._material.copy(e.material),this._pass=this._material.passes[0],this._pass.update(),this._hDescriptorSet=bf.get(this._pass.handle,hf.DESCRIPTOR_SET),!0)}},{key:"increase",value:function(){return this._refCount++,this._refCount}},{key:"decrease",value:function(){return this._refCount--,0===this._refCount&&this.destroy(),this._refCount}},{key:"destroy",value:function(){this._material&&(this._material.destroy(),this._material=null),this._refCount=0}},{key:"material",get:function(){return this._material}},{key:"pass",get:function(){return this._pass}},{key:"hDescriptorSet",get:function(){return this._hDescriptorSet}}]),e}(),$D=function(){function e(t){var n=this;i(this,e),this.device=void 0,this._screens=[],this._bufferBatchPool=new Ui((function(){return new qD(n)}),128),this._drawBatchPool=void 0,this._scene=void 0,this._attributes=[],this._meshBuffers=[],this._meshBufferUseCount=0,this._uiMaterials=new Map,this._canvasMaterials=new Map,this._batches=void 0,this._uiModelPool=null,this._modelInUse=void 0,this._emptyMaterial=new sm,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currCanvas=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._parentOpacity=1,this._root=t,this.device=t.device,this._scene=this._root.createScene({name:"GUIScene"}),this._uiModelPool=new zi((function(){var e=E.director.root.createModel(YD);return e.enabled=!0,e.visFlags|=Ph.Enum.UI_3D,e}),2),this._modelInUse=new Gi(10),this._batches=new Gi(64),this._drawBatchPool=new zi((function(){return new QD}),128),E.director.on(E.Director.EVENT_BEFORE_DRAW,this.update,this)}return r(e,[{key:"renderScene",get:function(){return this._scene}},{key:"currBufferBatch",get:function(){return this._currMeshBuffer},set:function(e){e&&(this._currMeshBuffer=e)}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}}]),r(e,[{key:"initialize",value:function(){return this._attributes=GD,this._requireBufferBatch(),!0}},{key:"destroy",value:function(){for(var e=0;e<this._batches.array.length;e++)this._batches.array[e].destroy(this);for(var t=0;t<this._meshBuffers.length;t++)this._meshBuffers[t].destroy();this._meshBuffers.splice(0)}},{key:"getRenderSceneGetter",value:function(){return Object.getOwnPropertyDescriptor(Object.getPrototypeOf(this),"renderScene").get.bind(this)}},{key:"_getUIMaterial",value:function(e){if(this._uiMaterials.has(e.hash))return this._uiMaterials.get(e.hash);var t=new JD;return t.initialize({material:e}),this._uiMaterials.set(e.hash,t),t}},{key:"_removeUIMaterial",value:function(e){this._uiMaterials.has(e)&&0===this._uiMaterials.get(e).decrease()&&this._uiMaterials.delete(e)}},{key:"addScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;i++){var n=t[i];if(n.camera){var r=n.camera.view.visibility,a=this._canvasMaterials.get(r);if(a){for(var o=a.keys(),s=o.next();!s.done;)this._removeUIMaterial(s.value),s=o.next();a.clear()}}}this._screens.push(e),this._screens.sort(this._screenSort);for(var l=0;l<t.length;l++){var c=t[l];c.camera&&(c.camera.view.visibility=Ph.BitMask.UI_2D|l+1,this._canvasMaterials.has(c.camera.view.visibility)||this._canvasMaterials.set(c.camera.view.visibility,new Map))}}},{key:"getScreen",value:function(e){for(var t=this._screens,i=0;i<t.length;++i){var n=t[i];if(n.camera&&n.camera.view.visibility===e)return n}return null}},{key:"removeScreen",value:function(e){var t=this,i=this._screens.indexOf(e);if(-1!==i){if(this._screens.splice(i,1),e.camera){for(var n=this._canvasMaterials.get(e.camera.view.visibility),r=n.keys(),a=r.next();!a.done;)this._removeUIMaterial(a.value),a=r.next();n.clear()}for(var o,s=i;s<this._screens.length;s++)(o=this._screens[s].camera)&&function(){var e=t._canvasMaterials.get(o.view.visibility);o.view.visibility=Ph.BitMask.UI_2D|s+1;var i=t._canvasMaterials.get(o.view.visibility);e.forEach((function(e,t){i.set(t,e)})),e.clear()}()}}},{key:"update",value:function(e){if(this._renderScreens(),this._batches.length>0)for(var t=this._meshBuffers,i=0;i<t.length;++i){var n=t[i];n.uploadData(),n.reset()}this.render(),this._reset()}},{key:"sortScreens",value:function(){this._screens.sort(this._screenSort)}},{key:"render",value:function(){for(var e=0,t=0;t<this._modelInUse.length;t++)this._scene.removeModel(this._modelInUse.get(t)),this._uiModelPool.free(this._modelInUse.get(t));if(this._modelInUse.clear(),this._batches.length)for(var i=0;i<this._batches.length;++i){var n=this._batches.array[i];if(n.model){if(n.camera){var r=n.camera.view.visibility;n.model.visFlags=r,n.model.node.layer=r}for(var a=n.model.subModels,o=0;o<a.length;o++)a[o].priority=e++}else{var s=mf.get(n.hDescriptorSet),l=Fh.SAMPLER_SPRITE;s.bindTexture(l,n.texture),s.bindSampler(l,n.sampler),s.update();var c=this._uiModelPool.alloc();if(c.directInitialize(n),this._scene.addModel(c),c.subModels[0].priority=e++,n.camera){var u=n.camera.view.visibility;c.visFlags=u,null==this._canvasMaterials.get(u).get(n.material.hash)&&this._canvasMaterials.get(u).set(n.material.hash,1)}this._modelInUse.push(c)}}}},{key:"commitComp",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2?arguments[2]:void 0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=e,a=t,o=n,s=r.getRenderMaterial(0);s||(s=r._updateBuiltinMaterial(),s=r._updateBlendFunc()),this._currMaterial===s&&this._currTexture===a&&this._currSampler===o||(this.autoMergeBatches(this._currComponent),this._currComponent=r,this._currMaterial=s,this._currTexture=a,this._currSampler=o),i&&(i.fillBuffers(r,this),this._applyOpacity(r))}},{key:"commitModel",value:function(e,t,i){if(this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(),i){var n=!1;if(XD.sharedManager.handleMaterial(i)){var r=XD.sharedManager.pattern;i.overridePipelineStates({depthStencilState:{stencilTestFront:r.stencilTest,stencilFuncFront:r.func,stencilReadMaskFront:r.stencilMask,stencilWriteMaskFront:r.writeMask,stencilFailOpFront:r.failOp,stencilZFailOpFront:r.zFailOp,stencilPassOpFront:r.passOp,stencilRefFront:r.ref,stencilTestBack:r.stencilTest,stencilFuncBack:r.func,stencilReadMaskBack:r.stencilMask,stencilWriteMaskBack:r.writeMask,stencilFailOpBack:r.failOp,stencilZFailOpBack:r.zFailOp,stencilPassOpBack:r.passOp,stencilRefBack:r.ref}}),n=!0}if(n&&t)for(var a=0;a<t.subModels.length;a++)t.setSubModelMaterial(a,i)}var o=this._currCanvas,s=this._drawBatchPool.alloc();s.camera=o&&o.camera,s.model=t,s.bufferBatch=null,s.material=i,s.texture=null,s.sampler=null,this._currMaterial=this._emptyMaterial,this._currComponent=null,this._currTexture=null,this._currSampler=null,this._batches.push(s)}},{key:"commitStaticBatch",value:function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()}},{key:"autoMergeBatches",value:function(e){var t=this._currMeshBuffer,i=this._currCanvas,n=t.recordBatch(),r=this._currMaterial;if(n&&r){if(e&&XD.sharedManager.handleMaterial(r)){this._currMaterial=r=e.getUIMaterialInstance();var a=XD.sharedManager.pattern;r.overridePipelineStates({depthStencilState:{stencilTestFront:a.stencilTest,stencilFuncFront:a.func,stencilReadMaskFront:a.stencilMask,stencilWriteMaskFront:a.writeMask,stencilFailOpFront:a.failOp,stencilZFailOpFront:a.zFailOp,stencilPassOpFront:a.passOp,stencilRefFront:a.ref,stencilTestBack:a.stencilTest,stencilFuncBack:a.func,stencilReadMaskBack:a.stencilMask,stencilWriteMaskBack:a.writeMask,stencilFailOpBack:a.failOp,stencilZFailOpBack:a.zFailOp,stencilPassOpBack:a.passOp,stencilRefBack:a.ref}})}var o=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();o.camera=i&&i.camera,o.bufferBatch=t,o.material=r,o.texture=this._currTexture,o.sampler=this._currSampler,o.hInputAssembler=n,this._batches.push(o),t.vertexStart=t.vertexOffset,t.indicesStart=t.indicesOffset,t.byteStart=t.byteOffset}}},{key:"forceMergeBatches",value:function(e,t){this._currMaterial=e,this._currTexture=t,this.autoMergeBatches()}},{key:"finishMergeBatches",value:function(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null}},{key:"_destroyUIMaterials",value:function(){for(var e=this._uiMaterials.values(),t=e.next();!t.done;){t.value.destroy(),t=e.next()}this._uiMaterials.clear()}},{key:"_walk",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=e.children.length,n=this._parentOpacity;if(this._parentOpacity*=e._uiProps.opacity,this._preprocess(e),i>0&&!e._static)for(var r=e.children,a=0;a<r.length;++a){var o=r[a];this._walk(o,t)}this._postprocess(e),this._parentOpacity=n,t+=1}},{key:"_renderScreens",value:function(){for(var e=this._screens,t=0;t<e.length;++t){var i=e[t];i.enabledInHierarchy&&(this._currCanvas=i,this._recursiveScreenNode(i.node))}}},{key:"_preprocess",value:function(e){if(e._uiProps.uiTransformComp){e._uiProps.uiTransformComp._canvas=this._currCanvas;var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.updateAssembler(this)}}},{key:"_postprocess",value:function(e){var t=e._uiProps.uiComp;t&&t.enabledInHierarchy&&t.postUpdateAssembler(this)}},{key:"_recursiveScreenNode",value:function(e){this._walk(e),this.autoMergeBatches(this._currComponent)}},{key:"_reset",value:function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._parentOpacity=1,this._batches.clear(),this._currMaterial=this._emptyMaterial,this._currCanvas=null,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._meshBufferUseCount=0,this._requireBufferBatch(),XD.sharedManager.reset()}},{key:"_createMeshBuffer",value:function(){var e=this._bufferBatchPool.add();return e.initialize(this._attributes,this._requireBufferBatch.bind(this)),this._meshBuffers.push(e),e}},{key:"_requireBufferBatch",value:function(){this._meshBufferUseCount>=this._meshBuffers.length?this._currMeshBuffer=this._createMeshBuffer():this._currMeshBuffer=this._meshBuffers[this._meshBufferUseCount],this._meshBufferUseCount++,2===arguments.length&&this._currMeshBuffer.request(arguments[0],arguments[1])}},{key:"_screenSort",value:function(e,t){var i=e.priority-t.priority;return 0===i?e.node.getSiblingIndex()-t.node.getSiblingIndex():i}},{key:"_applyOpacity",value:function(e){for(var t=e.color.a/255,i=this._parentOpacity=this._parentOpacity*t,n=this._currMeshBuffer.byteOffset>>2,r=this._currMeshBuffer.vData,a=this._currMeshBuffer.lastByteOffset>>2;a<n;a+=9)r[a+qD.OPACITY_OFFSET]=i;this._currMeshBuffer.lastByteOffset=this._currMeshBuffer.byteOffset}}]),e}(),eB=function(){function e(t){i(this,e),this._title="",this._width=1,this._height=1,this._nativeWidth=1,this._nativeHeight=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._poolHandle=0}return r(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"framebuffer",get:function(){return yf.get(Yf.get(this._poolHandle,Vf.FRAMEBUFFER))}},{key:"shouldSyncSizeWithSwapchain",get:function(){return this._shouldSyncSizeWithSwapchain}},{key:"hasOnScreenAttachments",get:function(){return 1===Yf.get(this._poolHandle,Vf.HAS_ON_SCREEN_ATTACHMENTS)}},{key:"hasOffScreenAttachments",get:function(){return 1===Yf.get(this._poolHandle,Vf.HAS_OFF_SCREEN_ATTACHMENTS)}},{key:"handle",get:function(){return this._poolHandle}}],[{key:"registerCreateFunc",value:function(t){t._createWindowFun=function(t){return new e(t)}}}]),r(e,[{key:"initialize",value:function(e,t){this._poolHandle=Yf.alloc(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchainBufferIndices&&(this._swapchainBufferIndices=t.swapchainBufferIndices),void 0!==t.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=t.shouldSyncSizeWithSwapchain),this._width=t.width,this._height=t.height,this._nativeWidth=this._width,this._nativeHeight=this._height;for(var i=t.renderPassInfo,n=i.colorAttachments,r=i.depthStencilAttachment,a=0;a<n.length;a++)n[a].format===jo.UNKNOWN&&(n[a].format=e.colorFormat);r&&r.format===jo.UNKNOWN&&(r.format=e.depthStencilFormat),this._renderPass=e.createRenderPass(t.renderPassInfo);for(var o=0;o<n.length;o++){var s=null;this._swapchainBufferIndices&1<<o?Yf.set(this._poolHandle,Vf.HAS_ON_SCREEN_ATTACHMENTS,1):(s=e.createTexture(new Il(ss.TEX2D,ls.COLOR_ATTACHMENT|ls.SAMPLED,n[o].format,this._width,this._height)),Yf.set(this._poolHandle,Vf.HAS_OFF_SCREEN_ATTACHMENTS,1)),this._colorTextures.push(s)}r&&(this._swapchainBufferIndices>=0?(this._depthStencilTexture=e.createTexture(new Il(ss.TEX2D,ls.DEPTH_STENCIL_ATTACHMENT|ls.SAMPLED,r.format,this._width,this._height)),Yf.set(this._poolHandle,Vf.HAS_OFF_SCREEN_ATTACHMENTS,1)):Yf.set(this._poolHandle,Vf.HAS_ON_SCREEN_ATTACHMENTS,1));var l=yf.alloc(e,new el(this._renderPass,this._colorTextures,this._depthStencilTexture));return Yf.set(this._poolHandle,Vf.FRAMEBUFFER,l),!0}},{key:"destroy",value:function(){this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._poolHandle&&(yf.get(Yf.get(this._poolHandle,Vf.FRAMEBUFFER)).destroy(),this._poolHandle=0)}},{key:"resize",value:function(e,t){if(this._width=e,this._height=t,e>this._nativeWidth||t>this._nativeHeight){this._nativeWidth=e,this._nativeHeight=t;var i=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(e,t),i=!0);for(var n=0;n<this._colorTextures.length;n++){var r=this._colorTextures[n];r&&(r.resize(e,t),i=!0)}var a=yf.get(Yf.get(this._poolHandle,Vf.FRAMEBUFFER));i&&a&&(a.destroy(),a.initialize(new el(this._renderPass,this._colorTextures,this._depthStencilTexture)))}}}]),e}(),tB=function(){function e(t){var n=this;i(this,e),this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._ui=null,this._dataPoolMgr=void 0,this._scenes=[],this._cameras=[],this._views=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._poolHandle=0,this._device=t,this._dataPoolMgr=new zD(t),rA.registerCreateFunc(this),eB.registerCreateFunc(this),this._cameraPool=new zi((function(){return new iT(n._device)}),4)}return r(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",set:function(e){this._curWindow=e},get:function(){return this._curWindow}},{key:"tempWindow",set:function(e){this._tempWindow=e},get:function(){return this._tempWindow}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"ui",get:function(){return this._ui}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return jf.get(this._poolHandle,Gf.CUMULATIVE_TIME)}},{key:"frameTime",get:function(){return jf.get(this._poolHandle,Gf.FRAME_TIME)}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0},get:function(){return this._fixedFPS}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"handle",get:function(){return this._poolHandle}}]),r(e,[{key:"initialize",value:function(e){var t=this;this._poolHandle=jf.alloc();var i=new vl,n=new gl;n.depthStoreOp=ps.DISCARD,n.stencilStoreOp=ps.DISCARD;var r=new yl([i],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:r,swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,tf.initBuiltinRes(this._device),E.view.on("design-resolution-changed",(function(){var e=E.game.canvas.width,i=E.game.canvas.height;t.resize(e,i)}),this),!0}},{key:"destroy",value:function(){this.clearCameras(),this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._ui&&(this._ui.destroy(),this._ui=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._poolHandle&&(jf.free(this._poolHandle),this._poolHandle=0)}},{key:"resize",value:function(e,t){this._device.resize(e,t),this._mainWindow.resize(e,t);for(var i,n=y(this._windows);!(i=n()).done;){var r=i.value;r.shouldSyncSizeWithSwapchain&&r.resize(e,t)}for(var a,o=y(this._cameras);!(a=o()).done;){var s=a.value;s.isWindowSize&&s.resize(e,t)}}},{key:"setRenderPipeline",value:function(e){return e||(e=this.createDefaultPipeline()),this._pipeline=e,!!this._pipeline.activate()&&(this.onGlobalPipelineStateChanged(),this._ui=new $D(this),!!this._ui.initialize()||(this.destroy(),!1))}},{key:"createDefaultPipeline",value:function(){var e=new IE;return e.initialize({flows:[]}),e}},{key:"onGlobalPipelineStateChanged",value:function(){for(var e=0;e<this._cameras.length;e++)this._cameras[e].view.onGlobalPipelineStateChanged();for(var t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged()}},{key:"activeWindow",value:function(e){this._curWindow=e}},{key:"resetCumulativeTime",value:function(){jf.set(this._poolHandle,Gf.CUMULATIVE_TIME,0)}},{key:"frameMove",value:function(e){if(jf.set(this._poolHandle,Gf.FRAME_TIME,e),++this._frameCount,jf.set(this._poolHandle,Gf.CUMULATIVE_TIME,jf.get(this._poolHandle,Gf.CUMULATIVE_TIME)+e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),this._pipeline){this._device.acquire(),this._views.length=0;for(var t=this._cameras,i=E.director.getTotalFrames(),n=0;n<t.length;n++){var r=this._cameras[n],a=r.view;a.isEnable&&a.window&&(r.update(),r.scene.update(i),this._views.push(a))}this._pipeline.render(this._views),this._device.present()}}},{key:"createWindow",value:function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t}},{key:"destroyWindow",value:function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)}},{key:"destroyWindows",value:function(){for(var e,t=y(this._windows);!(e=t()).done;){e.value.destroy()}this._windows=[]}},{key:"createScene",value:function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t}},{key:"destroyScene",value:function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)}},{key:"destroyScenes",value:function(){for(var e,t=y(this._scenes);!(e=t()).done;){e.value.destroy()}this._scenes=[]}},{key:"createView",value:function(e){var t=new Wx;return t.initialize(e),t}},{key:"attachCamera",value:function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortViews()}},{key:"detachCamera",value:function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)}},{key:"clearCameras",value:function(){this._cameras.length=0}},{key:"createModel",value:function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new zi((function(){return new e}),10)),t=this._modelPools.get(e));var i=t.alloc();return i.initialize(),i}},{key:"destroyModel",value:function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.destroy(),e.scene&&e.scene.removeModel(e)):console.warn("'".concat(e.constructor.name,"'is not in the model pool and cannot be destroyed by destroyModel."))}},{key:"createCamera",value:function(){return this._cameraPool.alloc()}},{key:"destroyCamera",value:function(e){this._cameraPool.free(e),e.destroy(),e.scene&&e.scene.removeCamera(e),e.isWindowSize=!0}},{key:"createLight",value:function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new zi((function(){return new e}),4)),t=this._lightPools.get(e));var i=t.alloc();return i.initialize(),i}},{key:"destroyLight",value:function(e){var t=this._lightPools.get(e.constructor);if(e.destroy(),t&&(t.free(e),e.scene))switch(e.type){case Zx.SPHERE:e.scene.removeSphereLight(e);break;case Zx.SPOT:e.scene.removeSpotLight(e)}}},{key:"sortViews",value:function(){this._cameras.sort((function(e,t){return e.view.priority-t.view.priority}))}}]),e}();E.Root=tB;var iB=e("Director",function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._purgeDirectorInNextLoop=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._lastUpdate=void 0,e._deltaTime=void 0,e._startTime=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._purgeDirectorInNextLoop=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._lastUpdate=0,e._deltaTime=0,e._startTime=0,e._scheduler=new FD,e._compScheduler=new hD,e._nodeActivator=new OD,e._systems=[],E.game.once(AO.EVENT_RENDERER_INITED,e._initOnRendererInitialized,c(e)),e}return o(t,e),r(t,[{key:"calculateDeltaTime",value:function(e){e||(e=performance.now()),this._deltaTime=e>this._lastUpdate?(e-this._lastUpdate)/1e3:0,this._lastUpdate=e}},{key:"convertToGL",value:function(e){var t=E.game.container,i=E.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,o=i._devicePixelRatio*(e.x-r),s=i._devicePixelRatio*(a+n.height-e.y);return i._isRotated?aa(i._viewportRect.width-s,o):aa(o,s)}},{key:"convertToUI",value:function(e){var t=E.game.container,i=E.view,n=t.getBoundingClientRect(),r=n.left+window.pageXOffset-t.clientLeft,a=n.top+window.pageYOffset-t.clientTop,o=aa(0,0);return i._isRotated?(o.x=r+e.y/i._devicePixelRatio,o.y=a+n.height-(i._viewportRect.width-e.x)/i._devicePixelRatio):(o.x=r+e.x*i._devicePixelRatio,o.y=a+n.height-e.y*i._devicePixelRatio),o}},{key:"end",value:function(){this._purgeDirectorInNextLoop=!0}},{key:"getWinSize",value:function(){return Ra(E.winSize)}},{key:"getWinSizeInPixels",value:function(){return Ra(E.winSize)}},{key:"pause",value:function(){this._paused||(this._paused=!0)}},{key:"purgeCachedData",value:function(){E.loader.releaseAll()}},{key:"purgeDirector",value:function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),Am&&Am.setEnabled(!1),E.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),E.loader.releaseAll()}},{key:"reset",value:function(){this.purgeDirector(),this.emit(t.EVENT_RESET),Am&&Am.setEnabled(!0),this.startAnimation()}},{key:"runSceneImmediate",value:function(e,t,i){q(e instanceof E.Scene,1216);var n=E.loader._getReferenceKey(e.uuid);E.loader.removeItem(n),e._load();for(var r=Object.keys(E.game._persistRootNodes).map((function(e){return E.game._persistRootNodes[e]})),a=0;a<r.length;a++){var o=r[a];o.emit(E.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var s=e.getChildByUuid(o.uuid);if(s){var l=s.getSiblingIndex();s._destroyImmediate(),e.insertChild(o,l)}else o.parent=e}var c=this._scene;!function(e,t,i){var n=E.loader._autoReleaseSetting,r=_e();if(t)for(var a=0;a<t.length;a++)r[t[a]]=!0;for(var o=0;o<i.length;o++)EI(i[o],r);if(e)for(var s=0;s<e.length;s++){var l=e[s];!1===n[l]||r[l]||E.loader.release(l)}for(var c=Object.keys(n),u=0;u<c.length;u++){var h=c[u];!0!==n[h]||r[h]||E.loader.release(h)}}(c&&c.autoReleaseAssets&&c.dependAssets,e.dependAssets,r),E.isValid(c)&&c.destroy(),this._scene=null,Vi._deferredDestroy(),t&&t(),this.emit(E.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,e),this.emit(E.Director.EVENT_AFTER_SCENE_LAUNCH,e)}},{key:"runScene",value:function(e,t,i){var n=this;q(e,1205),q(e instanceof E.Scene,1216),e._load(),this.once(E.Director.EVENT_AFTER_DRAW,(function(){n.runSceneImmediate(e,t,i)}))}},{key:"_getSceneUuid",value:function(e){var t=E.game._sceneInfos;if("string"==typeof e){e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e);for(var i=0;i<t.length;i++){var n=t[i];if(n.url.endsWith(e))return n}}else if("number"==typeof e){if(0<=e&&e<t.length)return t[e];V(1206,e)}else V(1207,e);return null}},{key:"loadScene",value:function(e,t,i){if(this._loadingScene)return G(1208,e,this._loadingScene),!1;var n=this._getSceneUuid(e);if(n){var r=n.uuid;return this.emit(E.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,this._loadSceneByUuid(r,t,i),!0}return V(1209,e),!1}},{key:"preloadScene",value:function(e,t,i){var n,r;void 0===i?(r=t,n=void 0):(r=i,n=t);var a=this._getSceneUuid(e);if(a)this.emit(E.Director.EVENT_BEFORE_SCENE_LOADING,e),E.loader.load({uuid:a.uuid,type:"uuid"},n,(function(t,i){t&&V(1210,e,t.message),r&&r(t,i)}));else{var o='Can not preload the scene "'+e+'" because it is not in the build settings.';r&&r(new Error(o)),k("preloadScene: "+o)}}},{key:"_loadSceneByUuid",value:function(e,t,i,n){var r,a;r=t,a=i,console.time("LoadScene "+e),E.AssetLibrary.loadAsset(e,(function(t,i){console.timeEnd("LoadScene "+e);var n=AB;if(n._loadingScene="",t)k(t="Failed to load scene: "+t);else{if(i instanceof E.SceneAsset){var o=i.scene;return o._id=i._uuid,o._name=i._name,void n.runSceneImmediate(o,a,r)}k(t="The asset "+e+" is not a scene")}r&&r(t)}))}},{key:"resume",value:function(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||z(1200),this._paused=!1,this._deltaTime=0)}},{key:"setDepthTest",value:function(e){E.Camera.main&&(E.Camera.main.depth=!!e)}},{key:"setClearColor",value:function(e){E.Camera.main&&(E.Camera.main.backgroundColor=e)}},{key:"getRunningScene",value:function(){return this._scene}},{key:"getScene",value:function(){return this._scene}},{key:"getAnimationInterval",value:function(){return 1e3/E.game.getFrameRate()}},{key:"setAnimationInterval",value:function(e){E.game.setFrameRate(Math.round(1e3/e))}},{key:"getDeltaTime",value:function(){return this._deltaTime}},{key:"getTotalTime",value:function(){return performance.now()-this._startTime}},{key:"getCurrentTime",value:function(){return this._lastUpdate}},{key:"getTotalFrames",value:function(){return this._totalFrames}},{key:"isPaused",value:function(){return this._paused}},{key:"getScheduler",value:function(){return this._scheduler}},{key:"setScheduler",value:function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(FD.ID,e,200))}},{key:"registerSystem",value:function(e,t,i){t.id=e,t.priority=i,t.init(),this._systems.push(t),this._systems.sort(PD.sortByPriority)}},{key:"unregisterSystem",value:function(e){Fe.fastRemove(this._systems,e),this._systems.sort(PD.sortByPriority)}},{key:"getSystem",value:function(e){return this._systems.find((function(t){return t.id===e}))}},{key:"getAnimationManager",value:function(){return this.getSystem(E.AnimationManager.ID)}},{key:"startAnimation",value:function(){this._invalid=!1,this._lastUpdate=performance.now()}},{key:"stopAnimation",value:function(){this._invalid=!0}},{key:"mainLoop",value:function(e){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this._invalid){this.calculateDeltaTime(e);var i=this._deltaTime;if(!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(i);for(var n=0;n<this._systems.length;++n)this._systems[n].update(i);this._compScheduler.lateUpdatePhase(i),this.emit(t.EVENT_AFTER_UPDATE),Vi._deferredDestroy();for(var r=0;r<this._systems.length;++r)this._systems[r].postUpdate(i)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this.emit(t.EVENT_AFTER_DRAW),Am.frameUpdateListeners(),ig.bookOfChange.clear(),this._totalFrames++}}},{key:"_initOnRendererInitialized",value:function(){this._totalFrames=0,this._lastUpdate=performance.now(),this._startTime=this._lastUpdate,this._paused=!1,this._purgeDirectorInNextLoop=!1,Am&&Am.setEnabled(!0),this.registerSystem(FD.ID,this._scheduler,200),this.emit(t.EVENT_INIT)}},{key:"_init",value:function(){E.loader.init(this),this._root=new tB(E.game._gfxDevice);return!!this._root.initialize({})||(V(1217),!1)}},{key:"root",get:function(){return this._root}}]),t}(tn));iB.EVENT_INIT="director_init",iB.EVENT_RESET="director_reset",iB.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",iB.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",iB.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",iB.EVENT_BEFORE_UPDATE="director_before_update",iB.EVENT_AFTER_UPDATE="director_after_update",iB.EVENT_BEFORE_DRAW="director_before_draw",iB.EVENT_AFTER_DRAW="director_after_draw",iB.EVENT_BEFORE_PHYSICS="director_before_physics",iB.EVENT_AFTER_PHYSICS="director_after_physics",iB.instance=void 0,E.Director=iB;var nB,rB,aB,oB,sB,lB,cB,uB,hB,_B,dB,fB,pB,mB,vB,gB,yB,xB,SB,TB,EB,bB,AB=e("director",iB.instance=E.director=new iB),CB=e("EventHandler",(nB=ii("cc.ClickEvent"),rB=Li(E.Node),nB((sB=S((oB=function(){function e(){i(this,e),x(this,"target",sB,this),x(this,"component",lB,this),x(this,"_componentId",cB,this),x(this,"handler",uB,this),x(this,"customEventData",hB,this)}return r(e,[{key:"emit",value:function(e){var t=this.target;if(E.isValid(t)){this._genCompIdIfNeeded();var i=E.js._getClassById(this._componentId),n=t.getComponent(i);if(E.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(n,e))}}}},{key:"_compName2Id",value:function(e){var t=E.js.getClassByName(e);return E.js._getClassId(t)}},{key:"_compId2Name",value:function(e){var t=E.js._getClassById(e);return E.js.getClassName(t)}},{key:"_genCompIdIfNeeded",value:function(){this._componentId||(this._componentName=this.component,this.component="")}},{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}],[{key:"emitEvents",value:function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var a=0,o=t.length;a<o;a++){var s=t[a];s instanceof e&&s.emit(n)}}}]),e}()).prototype,"target",[rB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lB=S(oB.prototype,"component",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cB=S(oB.prototype,"_componentId",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uB=S(oB.prototype,"handler",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hB=S(oB.prototype,"customEventData",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aB=oB))||aB));E.Component.EventHandler=CB;var wB,RB,IB,OB,MB,PB,kB,DB,BB,LB,NB,FB,zB,UB,GB,HB,VB,WB,jB,qB,XB,YB,KB,ZB,QB,JB,$B,eL,tL,iL,nL,rL,aL,oL,sL,lL,cL,uL,hL,_L,dL,fL,pL,mL,vL,gL,yL,xL,SL,TL,EL,bL,AL,CL,wL,RL,IL,OL,ML,PL,kL,DL,BL,LL,NL,FL,zL,UL,GL,HL,VL,WL,jL,qL,XL,YL,KL,ZL,QL,JL,$L,eN,tN,iN,nN,rN,aN,oN,sN,lN,cN,uN,hN,_N,dN,fN,pN,mN,vN,gN,yN,xN,SN,TN,EN,bN,AN,CN,wN,RN,IN,ON,MN,PN,kN,DN=e("SkinningModelComponent",(_B=ii("cc.SkinnedMeshRenderer"),dB=mi("i18n:cc.SkinnedMeshRenderer"),fB=ri(100),pB=_i("Components/SkinnedMeshRenderer"),mB=Li(pO),vB=Li(ig),gB=Li(pO),yB=Li(ig),xB=Si("i18n:model.skinning_root"),_B(SB=dB(SB=fB(SB=hi(SB=pB((EB=S((TB=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_skeleton",EB,c(e)),x(e,"_skinningRoot",bB,c(e)),e._clip=null,e._modelType=iA,e}return o(t,e),r(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){e!==this._skinningRoot&&(this._skinningRoot=e,this._updateModelType(),this._update())}},{key:"model",get:function(){return this._model}}]),r(t,[{key:"__preload",value:function(){this._updateModelType()}},{key:"uploadAnimation",value:function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)}},{key:"setUseBakedAnimation",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=e?iA:eA;this._modelType!==t&&(this._modelType=t,this._model&&(E.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))}},{key:"setMaterial",value:function(e,i){_(s(t.prototype),"setMaterial",this).call(this,e,i),this._modelType===eA&&this.getMaterialInstance(i)}},{key:"_updateModelParams",value:function(){this._update(),_(s(t.prototype),"_updateModelParams",this).call(this)}},{key:"_updateModelType",value:function(){if(this._skinningRoot){var e=this._skinningRoot.getComponent("cc.SkeletalAnimation");e&&this.setUseBakedAnimation(e.useBakedAnimation)}}},{key:"_update",value:function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))}}]),t}(IC)).prototype,"_skeleton",[mB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bB=S(TB.prototype,"_skinningRoot",[vB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(TB.prototype,"skeleton",[gB],Object.getOwnPropertyDescriptor(TB.prototype,"skeleton"),TB.prototype),S(TB.prototype,"skinningRoot",[yB,xB],Object.getOwnPropertyDescriptor(TB.prototype,"skinningRoot"),TB.prototype),SB=TB))||SB)||SB)||SB)||SB)||SB)),BN=new al(Vo.ATTR_BATCH_ID,jo.R32F),LN=new al(Vo.ATTR_BATCH_UV,jo.RG32F),NN=Ds[BN.format].size+Ds[LN.format].size,FN=e("SkinningModelUnit",(wB=ii("cc.SkinnedMeshUnit"),RB=Li($_),IB=Li(pO),OB=Li(sm),MB=Li(DN),wB((DB=S((kB=function(){function e(){i(this,e),x(this,"mesh",DB,this),x(this,"skeleton",BB,this),x(this,"material",LB,this),x(this,"_localTransform",NB,this),x(this,"_offset",FB,this),x(this,"_size",zB,this)}return r(e,[{key:"offset",set:function(e){ia.copy(this._offset,e)},get:function(){return this._offset}},{key:"size",set:function(e){ia.copy(this._size,e)},get:function(){return this._size}},{key:"copyFrom",set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&hg(e.node,e.skinningRoot,this._localTransform))},get:function(){return null}}]),e}()).prototype,"mesh",[RB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BB=S(kB.prototype,"skeleton",[IB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),LB=S(kB.prototype,"material",[OB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NB=S(kB.prototype,"_localTransform",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ta}}),FB=S(kB.prototype,"_offset",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ia(0,0)}}),zB=S(kB.prototype,"_size",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ia(1,1)}}),S(kB.prototype,"offset",[vi],Object.getOwnPropertyDescriptor(kB.prototype,"offset"),kB.prototype),S(kB.prototype,"size",[vi],Object.getOwnPropertyDescriptor(kB.prototype,"size"),kB.prototype),S(kB.prototype,"copyFrom",[MB],Object.getOwnPropertyDescriptor(kB.prototype,"copyFrom"),kB.prototype),PB=kB))||PB)),zN=new Ta,UN=(new Ta,new oa),GN=e("SkinnedMeshBatchRenderer",(UB=ii("cc.SkinnedMeshBatchRenderer"),GB=mi("i18n:cc.SkinnedMeshBatchRenderer"),HB=ri(100),VB=_i("Components/SkinnedMeshBatchRenderer"),WB=Si("i18n:batched_skinning_model.atlas_size"),jB=Li([pt]),qB=Si("i18n:batched_skinning_model.batchable_texture_names"),XB=Li([FN]),YB=Si("i18n:batched_skinning_model.units"),KB=gi(!1),ZB=gi(!1),UB(QB=GB(QB=HB(QB=hi(QB=VB(($B=S((JB=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"atlasSize",$B,c(n)),x(n,"batchableTextureNames",eL,c(n)),x(n,"units",tL,c(n)),n._textures={},n._batchMaterial=null,n}return o(t,e),r(t,[{key:"onLoad",value:function(){_(s(t.prototype),"onLoad",this).call(this),this.cook()}},{key:"onDestroy",value:function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),_(s(t.prototype),"onDestroy",this).call(this)}},{key:"_onMaterialModified",value:function(e,i){this.cookMaterials(),_(s(t.prototype),"_onMaterialModified",this).call(this,e,this.getMaterialInstance(e))}},{key:"cook",value:function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}},{key:"cookMaterials",value:function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterialInstance(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var i=t.effectAsset.techniques[t.technique],n=function(n){var r=i.passes[n];if(!r.properties)return"continue";var a=function(i){if(r.properties[i].type>=Wo.SAMPLER1D){var a=null;e.batchableTextureNames.find((function(e){return e===i}))?((a=e._textures[i])||(a=e.createTexture(i)),e.cookTextures(a,i,n)):e.units.some((function(e){return a=e.material&&e.material.getProperty(i,n)})),a&&t.setProperty(i,a,n)}else{for(var o=[],s=0;s<e.units.length;s++){var l=e.units[s];l.material&&o.push(l.material.getProperty(i.slice(0,-3),n))}t.setProperty(i,o,n)}};for(var o in r.properties)a(o)},r=0;r<i.passes.length;r++)n(r)}else console.warn("incomplete batch material!")}},{key:"cookSkeletons",value:function(){if(this._skinningRoot){for(var e=[],t=[],i=0;i<this.units.length;i++){var n=this.units[i];if(n&&n.skeleton){var r=n.skeleton;Ta.invert(zN,n._localTransform);for(var a=function(i){var n=r.joints[i];if(e.findIndex((function(e){return e===n}))>=0)return"continue";e.push(n),t.push(Ta.multiply(new Ta,r.bindposes[i]||Ta.IDENTITY,zN))},o=0;o<r.joints.length;o++)a(o)}}var s=Array.from(Array(e.length).keys()).sort((function(t,i){return e[t]>e[i]?1:e[t]<e[i]?-1:0})),l=new pO;l.joints=e.map((function(e,t,i){return i[s[t]]})),l.bindposes=t.map((function(e,t,i){return i[s[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=l}else console.warn("no skinning root specified!")}},{key:"cookMeshes",value:function(){for(var e=this,t=!1,i=0;i<this.units.length;i++){if(this.units[i].mesh){t=!0;break}}if(t&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new $_;for(var n=0,r=jo.UNKNOWN,a=0,o=jo.UNKNOWN,s=0,l=jo.UNKNOWN,c=0,u=jo.UNKNOWN,h=0,_=jo.UNKNOWN,d=new Array(this.units.length),f=this.units.length,p=0;p<f;p++){var m=this.units[p];m&&m.skeleton&&(d[p]=m.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var v=function(t){var i=e.units[t];if(!i||!i.mesh||!i.mesh.data)return"continue";var f=e._createUnitMesh(t,i.mesh),p=new DataView(f.data.buffer);Ta.inverseTranspose(zN,i._localTransform);for(var m=i.offset,v=i.size,g=function(e){var g=f.struct.vertexBundles[e];n=g.view.offset,r=jo.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var x=g.attributes[y];if(x.name===Vo.ATTR_POSITION){r=x.format;break}n+=Ds[x.format].size}if(r){for(var S=Gu(p,r,n,g.view.length,g.view.stride),T=0;T<S.length;T+=3)oa.fromArray(UN,S,T),oa.transformMat4(UN,UN,i._localTransform),oa.toArray(S,UN,T);Uu(p,S,r,n,g.view.stride)}a=g.view.offset,o=jo.UNKNOWN;for(var E=0;E<g.attributes.length;E++){var b=g.attributes[E];if(b.name===Vo.ATTR_NORMAL){o=b.format;break}a+=Ds[b.format].size}if(o){for(var A=Gu(p,o,a,g.view.length,g.view.stride),C=0;C<A.length;C+=3)oa.fromArray(UN,A,C),oa.transformMat4Normal(UN,UN,zN),oa.toArray(A,UN,C);Uu(p,A,o,a,g.view.stride)}s=g.view.offset,l=jo.UNKNOWN;for(var w=0;w<g.attributes.length;w++){var R=g.attributes[w];if(R.name===Vo.ATTR_TANGENT){l=R.format;break}s+=Ds[R.format].size}if(l){for(var I=Gu(p,l,s,g.view.length,g.view.stride),O=0;O<I.length;O+=3)oa.fromArray(UN,I,O),oa.transformMat4Normal(UN,UN,zN),oa.toArray(I,UN,O);Uu(p,I,l,s,g.view.stride)}c=g.view.offset,u=jo.UNKNOWN;for(var M=0;M<g.attributes.length;M++){var P=g.attributes[M];if(P.name===Vo.ATTR_BATCH_UV){u=P.format;break}c+=Ds[P.format].size}u&&Hu(p,(function(e,t){var i,n=0===t?"x":"y";return(e=(i=e)-Math.floor(i))*v[n]+m[n]}),u,c,g.view.length,g.view.stride,p);var k=d[t];if(!k)return"continue";h=g.view.offset,_=jo.UNKNOWN;for(var D=0;D<g.attributes.length;D++){var B=g.attributes[D];if(B.name===Vo.ATTR_JOINTS){_=B.format;break}h+=Ds[B.format].size}_&&Hu(p,(function(e){return k[e]}),_,h,g.view.length,g.view.stride,p)},y=0;y<f.struct.vertexBundles.length;y++)g(y);e._mesh.merge(f)},g=0;g<f;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}}},{key:"cookTextures",value:function(e,t,i){for(var n=[],r=[],a=[],o=[],s=0;s<this.units.length;s++){var l=this.units[s];if(l.material){var c=l.material.getProperty(t,i);if(c&&c.image&&c.image.data){var u=new Ms;u.texOffset.x=l.offset.x*this.atlasSize,u.texOffset.y=l.offset.y*this.atlasSize,u.texExtent.width=l.size.x*this.atlasSize,u.texExtent.height=l.size.y*this.atlasSize;var h=c.image.data;h instanceof HTMLCanvasElement||h instanceof HTMLImageElement?(n.push(h),r.push(u)):(a.push(h),o.push(u))}}}var _=e.getGFXTexture(),d=E.director.root.device;a.length>0&&d.copyBuffersToTexture(a,_,o),n.length>0&&d.copyTexImagesToTexture(n,_,r)}},{key:"createTexture",value:function(e){var t=new Oh;return t.setFilters(qu.LINEAR,qu.LINEAR),t.setMipFilter(qu.LINEAR),t.reset({width:this.atlasSize,height:this.atlasSize,format:Wu.RGBA8888}),t.loaded=!0,this._textures[e]=t,t}},{key:"resizeAtlases",value:function(){for(var e in this._textures){this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:Wu.RGBA8888})}}},{key:"_createUnitMesh",value:function(e,t){for(var i=JSON.parse(JSON.stringify(t.struct)),n={},r=0;r<t.struct.primitives.length;r++){for(var a=t.struct.primitives[r],o=0,s=jo.UNKNOWN,l=0;l<a.vertexBundelIndices.length;l++){var c=t.struct.vertexBundles[a.vertexBundelIndices[l]];o=c.view.offset,s=jo.UNKNOWN;for(var u=0;u<c.attributes.length;u++){var h=c.attributes[u];if(h.name===Vo.ATTR_TEX_COORD){s=h.format;break}o+=Ds[h.format].size}if(s)break}if(void 0===n[l]){n[l]=[s,o];var _=i.vertexBundles[l];_.attributes.push(BN),_.attributes.push(LN),_.view.offset=0,_.view.length+=_.view.count*NN,_.view.stride+=NN}}for(var d=0,f=0;f<i.vertexBundles.length;f++)d+=i.vertexBundles[f].view.length;for(var m=0;m<i.primitives.length;m++){var v=i.primitives[m];v.indexView&&(v.indexView.offset=d,d+=v.indexView.length)}var g=new Uint8Array(d),y=t.data,x=new DataView(g.buffer),S=new DataView(y.buffer),T=E.sys.isLittleEndian;for(var b in n)for(var A=i.vertexBundles[b],C=t.struct.vertexBundles[b],w=p(n[b],2),R=Gu(S,w[0],w[1],C.view.length,C.view.stride),I=C.view,O=A.view,M=I.stride,P=O.stride,k=I.offset,D=O.offset,B=0;B<O.count;B++){var L=y.subarray(k,k+M);g.set(L,D),x.setFloat32(D+M,e),x.setFloat32(D+M+4,R[2*B],T),x.setFloat32(D+M+8,R[2*B+1],T),D+=P,k+=M}for(var N=0;N<i.primitives.length;N++){var F=t.struct.primitives[N],z=i.primitives[N];if(F.indexView&&z.indexView)for(var U=F.indexView.stride,G=z.indexView.stride,H=F.indexView.offset,V=z.indexView.offset,W=0;W<z.indexView.count;W++){var j=y.subarray(H,H+U);g.set(j,V),V+=G,H+=U}}var q=new $_;return q.reset({struct:i,data:g}),q}},{key:"mesh",get:function(){return _(s(t.prototype),"mesh",this)},set:function(e){f(s(t.prototype),"mesh",e,this,!0)}},{key:"skeleton",get:function(){return _(s(t.prototype),"skeleton",this)},set:function(e){f(s(t.prototype),"skeleton",e,this,!0)}}]),t}(DN)).prototype,"atlasSize",[si,WB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),eL=S(JB.prototype,"batchableTextureNames",[jB,si,qB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tL=S(JB.prototype,"units",[XB,si,YB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),S(JB.prototype,"mesh",[Ni,KB],Object.getOwnPropertyDescriptor(JB.prototype,"mesh"),JB.prototype),S(JB.prototype,"skeleton",[Ni,ZB],Object.getOwnPropertyDescriptor(JB.prototype,"skeleton"),JB.prototype),QB=JB))||QB)||QB)||QB)||QB)||QB)),HN=new oa,VN=et(BS),WN=et(DS),jN=et(LS),qN=et(FS),XN=et(NS),YN=et({SKYBOX:tT|Ts.DEPTH_STENCIL,SOLID_COLOR:Ts.ALL,DEPTH_ONLY:Ts.DEPTH_STENCIL,DONT_CLEAR:Ts.NONE}),KN=e("CameraComponent",(iL=ii("cc.Camera"),nL=mi("i18n:cc.Camera"),rL=_i("Components/Camera"),aL=wi(0),oL=Si("i18n:camera.priority"),sL=Li(Ph.BitMask),lL=wi(1),cL=Si("i18n:camera.visibility"),uL=Li(YN),hL=wi(2),_L=Si("i18n:camera.clear_flags"),dL=wi(3),fL=Si("i18n:camera.color"),pL=wi(4),mL=Si("i18n:camera.depth"),vL=wi(5),gL=Si("i18n:camera.stencil"),yL=Li(VN),xL=wi(6),SL=Si("i18n:camera.projection"),TL=Li(WN),EL=wi(7),bL=Si("i18n:camera.fov_axis"),AL=wi(8),CL=Si("i18n:camera.fov"),wL=wi(9),RL=Si("i18n:camera.ortho_height"),IL=wi(10),OL=Si("i18n:camera.near"),ML=wi(11),PL=Si("i18n:camera.far"),kL=Li(jN),DL=wi(12),BL=Si("i18n:camera.aperture"),LL=Li(qN),NL=wi(13),FL=Si("i18n:camera.shutter"),zL=Li(XN),UL=wi(14),GL=Si("i18n:camera.ISO"),HL=wi(15),VL=Si("i18n:camera.rect"),WL=Li(om),jL=wi(16),qL=Si("i18n:camera.target_texture"),iL(XL=nL(XL=rL(XL=hi((fN=dN=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_projection",KL,c(n)),x(n,"_priority",ZL,c(n)),x(n,"_fov",QL,c(n)),x(n,"_fovAxis",JL,c(n)),x(n,"_orthoHeight",$L,c(n)),x(n,"_near",eN,c(n)),x(n,"_far",tN,c(n)),x(n,"_color",iN,c(n)),x(n,"_depth",nN,c(n)),x(n,"_stencil",rN,c(n)),x(n,"_clearFlags",aN,c(n)),x(n,"_rect",oN,c(n)),x(n,"_aperture",sN,c(n)),x(n,"_shutter",lN,c(n)),x(n,"_iso",cN,c(n)),x(n,"_screenScale",uN,c(n)),x(n,"_visibility",hN,c(n)),x(n,"_targetTexture",_N,c(n)),n._camera=null,n._inEditorMode=!1,n._flows=void 0,n}return o(t,e),r(t,[{key:"onLoad",value:function(){E.director.on(E.Director.EVENT_AFTER_SCENE_LAUNCH,this.onSceneChanged,this),this._createCamera()}},{key:"onEnable",value:function(){this.node.hasChangedFlags|=nv.POSITION,this._camera&&this._attachToScene()}},{key:"onDisable",value:function(){this._camera&&this._detachFromScene()}},{key:"onDestroy",value:function(){this._camera&&(E.director.root.destroyCamera(this._camera),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}},{key:"screenPointToRay",value:function(e,t,i){return i||(i=ko.create()),this._camera&&this._camera.screenPointToRay(i,e,t),i}},{key:"worldToScreen",value:function(e,t){return t||(t=new oa),this._camera&&this._camera.worldToScreen(t,e),t}},{key:"screenToWorld",value:function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t}},{key:"convertToUINode",value:function(e,t,i){if(i||(i=new oa),!this._camera)return i;this.worldToScreen(e,HN);var n=t.getComponent("cc.UITransform"),r=PO.getVisibleSize(),a=HN.x-.5*this._camera.width,o=HN.y-.5*this._camera.height;return HN.x=a/E.view.getScaleX()+.5*r.width,HN.y=o/E.view.getScaleY()+.5*r.height,n&&n.convertToNodeSpaceAR(HN,i),i}},{key:"_createCamera",value:function(){this._camera=E.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?E.director.root&&E.director.root.mainWindow:E.director.root&&E.director.root.tempWindow,priority:this._priority,flows:this._flows}),this._camera&&(this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=xn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()}},{key:"_attachToScene",value:function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}},{key:"_detachFromScene",value:function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}},{key:"onSceneChanged",value:function(e){this._camera&&null==this._camera.scene&&this._attachToScene()}},{key:"_chechTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)}},{key:"_updateTargetTexture",value:function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}}},{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===DS.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=xn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&(this._camera.viewport=e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._chechTargetTextureEvent(t),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?E.director.root&&E.director.root.mainWindow:E.director.root&&E.director.root.tempWindow)}},{key:"flows",set:function(e){this._camera&&(this._camera.flows=e),this._flows=e}}]),t}(Yr),dN.ProjectionType=VN,dN.FOVAxis=WN,dN.ClearFlag=YN,dN.Aperture=jN,dN.Shutter=qN,dN.ISO=XN,KL=S((YL=fN).prototype,"_projection",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VN.PERSPECTIVE}}),ZL=S(YL.prototype,"_priority",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QL=S(YL.prototype,"_fov",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),JL=S(YL.prototype,"_fovAxis",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WN.VERTICAL}}),$L=S(YL.prototype,"_orthoHeight",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),eN=S(YL.prototype,"_near",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tN=S(YL.prototype,"_far",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),iN=S(YL.prototype,"_color",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma("#333333")}}),nN=S(YL.prototype,"_depth",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rN=S(YL.prototype,"_stencil",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aN=S(YL.prototype,"_clearFlags",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YN.SOLID_COLOR}}),oN=S(YL.prototype,"_rect",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ia(0,0,1,1)}}),sN=S(YL.prototype,"_aperture",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jN.F16_0}}),lN=S(YL.prototype,"_shutter",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qN.D125}}),cN=S(YL.prototype,"_iso",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XN.ISO100}}),uN=S(YL.prototype,"_screenScale",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),hN=S(YL.prototype,"_visibility",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return G_}}),_N=S(YL.prototype,"_targetTexture",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(YL.prototype,"priority",[aL,oL],Object.getOwnPropertyDescriptor(YL.prototype,"priority"),YL.prototype),S(YL.prototype,"visibility",[sL,lL,cL],Object.getOwnPropertyDescriptor(YL.prototype,"visibility"),YL.prototype),S(YL.prototype,"clearFlags",[uL,hL,_L],Object.getOwnPropertyDescriptor(YL.prototype,"clearFlags"),YL.prototype),S(YL.prototype,"clearColor",[dL,fL],Object.getOwnPropertyDescriptor(YL.prototype,"clearColor"),YL.prototype),S(YL.prototype,"clearDepth",[pL,mL],Object.getOwnPropertyDescriptor(YL.prototype,"clearDepth"),YL.prototype),S(YL.prototype,"clearStencil",[vL,gL],Object.getOwnPropertyDescriptor(YL.prototype,"clearStencil"),YL.prototype),S(YL.prototype,"projection",[yL,xL,SL],Object.getOwnPropertyDescriptor(YL.prototype,"projection"),YL.prototype),S(YL.prototype,"fovAxis",[TL,EL,bL],Object.getOwnPropertyDescriptor(YL.prototype,"fovAxis"),YL.prototype),S(YL.prototype,"fov",[AL,CL],Object.getOwnPropertyDescriptor(YL.prototype,"fov"),YL.prototype),S(YL.prototype,"orthoHeight",[wL,RL],Object.getOwnPropertyDescriptor(YL.prototype,"orthoHeight"),YL.prototype),S(YL.prototype,"near",[IL,OL],Object.getOwnPropertyDescriptor(YL.prototype,"near"),YL.prototype),S(YL.prototype,"far",[ML,PL],Object.getOwnPropertyDescriptor(YL.prototype,"far"),YL.prototype),S(YL.prototype,"aperture",[kL,DL,BL],Object.getOwnPropertyDescriptor(YL.prototype,"aperture"),YL.prototype),S(YL.prototype,"shutter",[LL,NL,FL],Object.getOwnPropertyDescriptor(YL.prototype,"shutter"),YL.prototype),S(YL.prototype,"iso",[zL,UL,GL],Object.getOwnPropertyDescriptor(YL.prototype,"iso"),YL.prototype),S(YL.prototype,"rect",[HL,VL],Object.getOwnPropertyDescriptor(YL.prototype,"rect"),YL.prototype),S(YL.prototype,"targetTexture",[WL,jL,qL],Object.getOwnPropertyDescriptor(YL.prototype,"targetTexture"),YL.prototype),XL=YL))||XL)||XL)||XL)||XL));E.Camera=KN;var ZN,QN,JN,$N,eF,tF,iF,nF,rF,aF,oF,sF,lF,cF,uF,hF,_F,dF,fF,pF,mF,vF,gF,yF,xF,SF,TF,EF,bF,AF,CF,wF,RF,IF,OF,MF,PF,kF,DF,BF,LF,NF,FF,zF,UF,GF,HF,VF,WF,jF,qF=et({LUMINOUS_POWER:0,LUMINANCE:1}),XF=ii("cc.StaticLightSettings")((vN=S((mN=function(){function e(){i(this,e),x(this,"_editorOnly",vN,this),x(this,"_bakeable",gN,this),x(this,"_castShadow",yN,this)}return r(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}()).prototype,"_editorOnly",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gN=S(mN.prototype,"_bakeable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yN=S(mN.prototype,"_castShadow",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(mN.prototype,"editorOnly",[vi],Object.getOwnPropertyDescriptor(mN.prototype,"editorOnly"),mN.prototype),S(mN.prototype,"bakeable",[vi],Object.getOwnPropertyDescriptor(mN.prototype,"bakeable"),mN.prototype),S(mN.prototype,"castShadow",[vi],Object.getOwnPropertyDescriptor(mN.prototype,"castShadow"),mN.prototype),pN=mN))||pN,YF=e("LightComponent",(xN=ii("cc.Light"),SN=Si("i18n:lights.color"),TN=Si("i18n:lights.use_color_temperature"),EN=Ti([1e3,15e3,1]),bN=Si("i18n:lights.color_temperature"),AN=Li(XF),xN((kN=PN=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_color",RN,c(e)),x(e,"_useColorTemperature",IN,c(e)),x(e,"_colorTemperature",ON,c(e)),x(e,"_staticSettings",MN,c(e)),e._type=Zx.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=tS,e}return o(t,e),r(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(this._light.color.x=e.r/255,this._light.color.y=e.g/255,this._light.color.z=e.b/255)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}}]),r(t,[{key:"onLoad",value:function(){this._createLight()}},{key:"onEnable",value:function(){this._attachToScene()}},{key:"onDisable",value:function(){this._detachFromScene()}},{key:"onDestroy",value:function(){this._destroyLight()}},{key:"_createLight",value:function(){this._light||(this._light=E.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node}},{key:"_destroyLight",value:function(){this._light&&(E.director.root.destroyLight(this),this._light=null)}},{key:"_attachToScene",value:function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case Zx.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case Zx.SPHERE:e.addSphereLight(this._light);break;case Zx.SPOT:e.addSpotLight(this._light)}}}},{key:"_detachFromScene",value:function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case Zx.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case Zx.SPHERE:e.removeSphereLight(this._light);break;case Zx.SPOT:e.removeSpotLight(this._light)}}}}]),t}(Yr),PN.Type=Zx,PN.PhotometricTerm=qF,RN=S((wN=kN).prototype,"_color",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.WHITE.clone()}}),IN=S(wN.prototype,"_useColorTemperature",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ON=S(wN.prototype,"_colorTemperature",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),MN=S(wN.prototype,"_staticSettings",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new XF}}),S(wN.prototype,"color",[SN],Object.getOwnPropertyDescriptor(wN.prototype,"color"),wN.prototype),S(wN.prototype,"useColorTemperature",[TN],Object.getOwnPropertyDescriptor(wN.prototype,"useColorTemperature"),wN.prototype),S(wN.prototype,"colorTemperature",[Ci,EN,bN],Object.getOwnPropertyDescriptor(wN.prototype,"colorTemperature"),wN.prototype),S(wN.prototype,"staticSettings",[AN],Object.getOwnPropertyDescriptor(wN.prototype,"staticSettings"),wN.prototype),CN=wN))||CN)),KF=e("DirectionalLightComponent",(ZN=ii("cc.DirectionalLight"),QN=mi("i18n:cc.DirectionalLight"),JN=_i("Light/DirectionalLight"),$N=Ri("lx"),eF=Si("i18n:lights.illuminance"),ZN(tF=QN(tF=JN(tF=hi((nF=S((iF=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_illuminance",nF,c(e)),e._type=Zx.DIRECTIONAL,e._light=null,e._lightType=MA,e}return o(t,e),r(t,[{key:"illuminance",get:function(){return this._illuminance},set:function(e){this._illuminance=e,this._light&&(this._light.illuminance=this._illuminance)}}]),r(t,[{key:"_createLight",value:function(){_(s(t.prototype),"_createLight",this).call(this),this._light&&(this.illuminance=this._illuminance)}}]),t}(YF)).prototype,"_illuminance",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),S(iF.prototype,"illuminance",[$N,eF],Object.getOwnPropertyDescriptor(iF.prototype,"illuminance"),iF.prototype),tF=iF))||tF)||tF)||tF)||tF)),ZF=e("SphereLightComponent",(rF=ii("cc.SphereLight"),aF=mi("i18n:cc.SphereLight"),oF=_i("Light/SphereLight"),sF=Ri("lm"),lF=Si("i18n:lights.luminous_power"),cF=Ri("cd/m"),uF=Si("i18n:lights.luminance"),hF=Li(qF),_F=Si("i18n:lights.term"),dF=Si("i18n:lights.size"),fF=Si("i18n:lights.range"),rF(pF=aF(pF=oF(pF=hi((vF=S((mF=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_size",vF,c(e)),x(e,"_luminance",gF,c(e)),x(e,"_term",yF,c(e)),x(e,"_range",xF,c(e)),e._type=Zx.SPHERE,e._light=null,e._lightType=PA,e}return o(t,e),r(t,[{key:"luminousPower",get:function(){return this._luminance*eS(this._size)},set:function(e){this._luminance=e/eS(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),r(t,[{key:"_createLight",value:function(){_(s(t.prototype),"_createLight",this).call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range)}}]),t}(YF)).prototype,"_size",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),gF=S(mF.prototype,"_luminance",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/eS(.15)}}),yF=S(mF.prototype,"_term",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qF.LUMINOUS_POWER}}),xF=S(mF.prototype,"_range",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),S(mF.prototype,"luminousPower",[sF,lF],Object.getOwnPropertyDescriptor(mF.prototype,"luminousPower"),mF.prototype),S(mF.prototype,"luminance",[cF,uF],Object.getOwnPropertyDescriptor(mF.prototype,"luminance"),mF.prototype),S(mF.prototype,"term",[hF,_F],Object.getOwnPropertyDescriptor(mF.prototype,"term"),mF.prototype),S(mF.prototype,"size",[dF],Object.getOwnPropertyDescriptor(mF.prototype,"size"),mF.prototype),S(mF.prototype,"range",[fF],Object.getOwnPropertyDescriptor(mF.prototype,"range"),mF.prototype),pF=mF))||pF)||pF)||pF)||pF)),QF=e("SpotLightComponent",(SF=ii("cc.SpotLight"),TF=mi("i18n:cc.SpotLight"),EF=_i("Light/SpotLight"),bF=Ri("lm"),AF=Si("i18n:lights.luminous_power"),CF=Ri("cd/m"),wF=Si("i18n:lights.luminance"),RF=Li(qF),IF=Si("i18n:lights.term"),OF=Si("i18n:lights.size"),MF=Si("i18n:lights.range"),PF=Ti([2,180,1]),kF=Si("The spot light cone angle"),SF(DF=TF(DF=EF(DF=hi((LF=S((BF=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_size",LF,c(e)),x(e,"_luminance",NF,c(e)),x(e,"_term",FF,c(e)),x(e,"_range",zF,c(e)),x(e,"_spotAngle",UF,c(e)),e._type=Zx.SPOT,e._light=null,e._lightType=zA,e}return o(t,e),r(t,[{key:"luminousPower",get:function(){return this._luminance*eS(this._size)},set:function(e){this._luminance=e/eS(this._size),this._light&&(this._light.luminance=this._luminance)}},{key:"luminance",get:function(){return this._luminance},set:function(e){this._luminance=e,this._light&&(this._light.luminance=e)}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=xn(e))}}]),r(t,[{key:"_createLight",value:function(){_(s(t.prototype),"_createLight",this).call(this),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle)}}]),t}(YF)).prototype,"_size",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),NF=S(BF.prototype,"_luminance",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/eS(.15)}}),FF=S(BF.prototype,"_term",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qF.LUMINOUS_POWER}}),zF=S(BF.prototype,"_range",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),UF=S(BF.prototype,"_spotAngle",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),S(BF.prototype,"luminousPower",[bF,AF],Object.getOwnPropertyDescriptor(BF.prototype,"luminousPower"),BF.prototype),S(BF.prototype,"luminance",[CF,wF],Object.getOwnPropertyDescriptor(BF.prototype,"luminance"),BF.prototype),S(BF.prototype,"term",[RF,IF],Object.getOwnPropertyDescriptor(BF.prototype,"term"),BF.prototype),S(BF.prototype,"size",[OF],Object.getOwnPropertyDescriptor(BF.prototype,"size"),BF.prototype),S(BF.prototype,"range",[MF],Object.getOwnPropertyDescriptor(BF.prototype,"range"),BF.prototype),S(BF.prototype,"spotAngle",[Ci,PF,kF],Object.getOwnPropertyDescriptor(BF.prototype,"spotAngle"),BF.prototype),DF=BF))||DF)||DF)||DF)||DF));Da(IC.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),ka(KN,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),ka(KN.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),E.CameraComponent=KN,ze.setClassAlias(KN,"cc.CameraComponent"),E.LightComponent=YF,ze.setClassAlias(YF,"cc.LightComponent"),E.DirectionalLightComponent=KF,ze.setClassAlias(KF,"cc.DirectionalLightComponent"),E.SphereLightComponent=ZF,ze.setClassAlias(ZF,"cc.SphereLightComponent"),E.SpotLightComponent=QF,ze.setClassAlias(QF,"cc.SpotLightComponent"),E.ModelComponent=IC,ze.setClassAlias(IC,"cc.ModelComponent"),E.SkinningModelComponent=DN,ze.setClassAlias(DN,"cc.SkinningModelComponent"),E.SkinningModelUnit=FN,ze.setClassAlias(FN,"cc.SkinningModelUnit"),E.BatchedSkinningModelComponent=GN,ze.setClassAlias(GN,"cc.BatchedSkinningModelComponent"),E.utils=hT;var JF,$F,ez,tz,iz=ii("cc.animation.UniformProxyFactory")((VF=S((HF=function(){function e(t,n){i(this,e),x(this,"passIndex",VF,this),x(this,"uniformName",WF,this),x(this,"channelIndex",jF,this),this.passIndex=n||0,this.uniformName=t||""}return r(e,[{key:"forTarget",value:function(e){var t=e.passes[this.passIndex],i=t.getHandle(this.uniformName);if(!i)throw new Error('Material "'.concat(e.name,'" has no uniform "').concat(this.uniformName,'"'));var n=Ap.getPropertyTypeFromHandle(i);if(n===_d.UBO){var r=void 0===this.channelIndex?i:t.getHandle(this.uniformName,this.channelIndex,Wo.FLOAT);if(!r)throw new Error('Uniform "'.concat(this.uniformName," (in material ").concat(e.name,") has no channel ").concat(this.channelIndex,'"'));return function(e,t){for(var i,n=y(e.shaderInfo.blocks);!(i=n()).done;)for(var r,a=y(i.value.members);!(r=a()).done;){var o=r.value;if(o.name===t)return o.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(r,e)}}:{set:function(e){t.setUniform(r,e)}}}if(n===_d.SAMPLER){var a=Ap.getBindingFromHandle(i),o=t.properties[this.uniformName],s=o&&o.value?o.value+"-texture":Ed(o.type),l=tf.get(s);return l||(P("Illegal texture default value: ".concat(s,".")),l=tf.get("default-texture")),{set:function(e){e||(e=l);var i=e.getGFXTexture();i&&i.width&&i.height&&(t.bindTexture(a,i),e instanceof yh&&t.bindSampler(a,vh.getSampler(E.game._gfxDevice,e.getSamplerHash())))}}}throw new Error("Animations are not available for uniforms with property type ".concat(n,"."))}}]),e}()).prototype,"passIndex",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WF=S(HF.prototype,"uniformName",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),jF=S(HF.prototype,"channelIndex",[ki],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),GF=HF))||GF;var nz,rz,az,oz,sz,lz=ii("cc.animation.MorphWeightsValueProxy")((ez=S(($F=function(){function e(){i(this,e),x(this,"subMeshIndex",ez,this)}return r(e,[{key:"forTarget",value:function(e){var t=this;return{set:function(i){e.setWeights(i,t.subMeshIndex)}}}}]),e}()).prototype,"subMeshIndex",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JF=$F))||JF,cz=ii("cc.animation.MorphWeightsAllValueProxy")(tz=function(){function e(){i(this,e)}return r(e,[{key:"forTarget",value:function(e){return{set:function(t){for(var i,n,r=null!==(i=null===(n=e.mesh)||void 0===n?void 0:n.struct.primitives.length)&&void 0!==i?i:0,a=0;a<r;++a)e.setWeights(t,a)}}}}]),e}())||tz;function uz(e,t,n,a){var o,s,l,c,u,h=new t,_=new t,d=new t,f=ii(e)((l=S((s=function(){function e(n,r,a){i(this,e),x(this,"dataPoint",l,this),x(this,"inTangent",c,this),x(this,"outTangent",u,this),this.dataPoint=n||new t,this.inTangent=r||new t,this.outTangent=a||new t}return r(e,[{key:"lerp",value:function(e,t,i){var r=this.dataPoint,o=e.dataPoint;_=n(_,this.inTangent,i),d=n(d,e.outTangent,i);var s=t*t*t,l=t*t,c=s-2*l+t,u=-2*s+3*l,f=s-l;return h=n(h,r,2*s-3*l+1),h=a(h,h,_,c),h=a(h,h,o,u),h=a(h,h,d,f)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}()).prototype,"dataPoint",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=S(s.prototype,"inTangent",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),u=S(s.prototype,"outTangent",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),o=s))||o;if(t===pa){var p=f.prototype.lerp;f.prototype.lerp=function(e,t,i){var n=p.call(this,e,t,i);return pa.normalize(n,n),n}}return f}var hz=e("CubicSplineVec2Value",uz("cc.CubicSplineVec2Value",ia,ia.multiplyScalar,ia.scaleAndAdd));E.CubicSplineVec2Value=hz;var _z=e("CubicSplineVec3Value",uz("cc.CubicSplineVec3Value",oa,oa.multiplyScalar,oa.scaleAndAdd));E.CubicSplineVec3Value=_z;var dz=e("CubicSplineVec4Value",uz("cc.CubicSplineVec4Value",ua,ua.multiplyScalar,ua.scaleAndAdd));E.CubicSplineVec4Value=dz;var fz=e("CubicSplineQuatValue",uz("cc.CubicSplineQuatValue",pa,pa.multiplyScalar,pa.scaleAndAdd));E.CubicSplineQuatValue=fz;var pz=e("CubicSplineNumberValue",ii("cc.CubicSplineNumberValue")((az=S((rz=function(){function e(t,n,r){i(this,e),x(this,"dataPoint",az,this),x(this,"inTangent",oz,this),x(this,"outTangent",sz,this),this.dataPoint=t,this.inTangent=n,this.outTangent=r}return r(e,[{key:"lerp",value:function(e,t,i){var n=this.dataPoint,r=e.dataPoint,a=t*t*t,o=t*t;return n*(2*a-3*o+1)+this.outTangent*i*(a-2*o+t)+r*(-2*a+3*o)+e.inTangent*i*(a-o)}},{key:"getNoLerp",value:function(){return this.dataPoint}}]),e}()).prototype,"dataPoint",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oz=S(rz.prototype,"inTangent",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sz=S(rz.prototype,"outTangent",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nz=rz))||nz);function mz(e){return e*e}function vz(e){return e*(2-e)}function gz(e){return e*e*e}function yz(e){return--e*e*e+1}function xz(e){return e*e*e*e}function Sz(e){return 1- --e*e*e*e}function Tz(e){return e*e*e*e*e}function Ez(e){return--e*e*e*e*e+1}function bz(e){return 1-Math.cos(e*Math.PI/2)}function Az(e){return Math.sin(e*Math.PI/2)}function Cz(e){return 0===e?0:Math.pow(1024,e-1)}function wz(e){return 1===e?1:1-Math.pow(2,-10*e)}function Rz(e){return 1-Math.sqrt(1-e*e)}function Iz(e){return Math.sqrt(1- --e*e)}function Oz(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/.4))}function Mz(e){var t,i=.1;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*e)*Math.sin((e-t)*(2*Math.PI)/.4)+1)}function Pz(e){var t=1.70158;return e*e*((t+1)*e-t)}function kz(e){var t=1.70158;return--e*e*((t+1)*e+t)+1}function Dz(e){return 1-Bz(1-e)}function Bz(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}E.CubicSplineNumberValue=pz,e("animation",Object.freeze({__proto__:null,UniformProxyFactory:iz,MorphWeightsValueProxy:lz,MorphWeightsAllValueProxy:cz,isPropertyPath:ng,isCustomPath:rg,HierarchyPath:ag,ComponentPath:og,evaluatePath:sg,CubicSplineVec2Value:hz,CubicSplineVec3Value:_z,CubicSplineVec4Value:dz,CubicSplineQuatValue:fz,CubicSplineNumberValue:pz}));var Lz=qz(mz,vz),Nz=qz(gz,yz),Fz=qz(xz,Sz),zz=qz(Tz,Ez),Uz=qz(bz,Az),Gz=qz(Cz,wz),Hz=qz(Rz,Iz),Vz=qz(Oz,Mz),Wz=qz(Pz,kz),jz=qz(Dz,Bz);function qz(e,t){return function(i){return i<.5?t(2*i)/2:e(2*i-1)/2+.5}}var Xz=Object.freeze({__proto__:null,constant:function(){return 0},linear:function(e){return e},quadIn:mz,quadOut:vz,quadInOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)},cubicIn:gz,cubicOut:yz,cubicInOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)},quartIn:xz,quartOut:Sz,quartInOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)},quintIn:Tz,quintOut:Ez,quintInOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)},sineIn:bz,sineOut:Az,sineInOut:function(e){return.5*(1-Math.cos(Math.PI*e))},expoIn:Cz,expoOut:wz,expoInOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))},circIn:Rz,circOut:Iz,circInOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)},elasticIn:Oz,elasticOut:Mz,elasticInOut:function(e){var t,i=.1,n=.4;return 0===e?0:1===e?1:(!i||i<1?(i=1,t=.1):t=n*Math.asin(1/i)/(2*Math.PI),(e*=2)<1?i*Math.pow(2,10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)*-.5:i*Math.pow(2,-10*(e-=1))*Math.sin((e-t)*(2*Math.PI)/n)*.5+1)},backIn:Pz,backOut:kz,backInOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)},bounceIn:Dz,bounceOut:Bz,bounceInOut:function(e){return e<.5?.5*Dz(2*e):.5*Bz(2*e-1)+.5},smooth:function(e){return e<=0?0:e>=1?1:e*e*(3-2*e)},fade:function(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)},quadOutIn:Lz,cubicOutIn:Nz,quartOutIn:Fz,quintOutIn:zz,sineOutIn:Uz,expoOutIn:Gz,circOutIn:Hz,elasticOutIn:Vz,backOutIn:Wz,bounceOutIn:jz});e("easing",Xz);function Yz(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(a>t+1e-6)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}function Kz(e,t,i,n,r){var a=1-r;return e*a*a*a+3*t*a*a*r+3*i*a*r*r+n*r*r*r}E.bezier=Kz;var Zz=Math.cos,Qz=Math.acos,Jz=Math.max,$z=2*Math.PI,eU=Math.sqrt;function tU(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function iU(e,t){var i=function(e,t){var i,n,r,a,o=t-0,s=t-e[0],l=3*o,c=3*s,u=3*(t-e[2]),h=1/(-o+c-u+(t-1)),_=(l-6*s+u)*h,d=_*(1/3),f=(-l+c)*h,p=1/3*(3*f-_*_),m=p*(1/3),v=(2*_*_*_-9*_*f+27*(o*h))/27,g=v/2,y=g*g+m*m*m;if(y<0){var x=1/3*-p,S=eU(x*x*x),T=-v/(2*S),E=Qz(T<-1?-1:T>1?1:T),b=2*tU(S);return n=b*Zz(E*(1/3))-d,r=b*Zz((E+$z)*(1/3))-d,a=b*Zz((E+2*$z)*(1/3))-d,0<=n&&n<=1?0<=r&&r<=1?0<=a&&a<=1?Jz(n,r,a):Jz(n,r):0<=a&&a<=1?Jz(n,a):n:0<=r&&r<=1?0<=a&&a<=1?Jz(r,a):r:a}if(0===y)return r=-(i=g<0?tU(-g):-tU(g))-d,0<=(n=2*i-d)&&n<=1?0<=r&&r<=1?Jz(n,r):n:r;var A=eU(y);return n=(i=tU(-g+A))-tU(g+A)-d}(e,t),n=1-i;return 0*n*n*n+3*e[1]*i*n*n+3*e[3]*i*i*n+1*i*i*i}E.bezierByTime=iU;var nU=e("RatioSampler",function(){function e(t){var n,r;i(this,e),this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var a=!0,o=1,s=t.length;o<s;o++)if(n=t[o]-t[o-1],1===o)r=n;else if(Math.abs(n-r)>1e-6){a=!1;break}this._findRatio=a?sU:Yz}return r(e,[{key:"sample",value:function(e){return this._findRatio(this.ratios,e)}}]),e}());E.RatioSampler=nU;var rU=e("AnimCurve",function(){function e(t,n){i(this,e),this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var r=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=r(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(r);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var a=0,o=Object.keys(t.easingMethods);a<o.length;a++){var s=o[a];this.types[s]=r(t.easingMethods[s])}}else this.type=null;var l=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=TU(l)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}return r(e,null,[{key:"Bezier",value:function(e){return e}}]),r(e,[{key:"hasLerp",value:function(){return!!this._lerp}},{key:"valueAt",value:function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var i=0;i<this._array.length;++i)this._array[i]=this._values[this._array.length*e+i];return this._array}},{key:"valueBetween",value:function(e,t,i,n,r){if(this._lerp){var a=this.types?this.types[t]:this.type,o=r-i,s=(e-i)/o;if(a&&(s=oU(s,a)),void 0===this._array){var l=this._values[t],c=this._values[n];return this._lerp(l,c,s,o*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*n+u];this._array[u]=this._lerp(h,_,s,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var d=0;d<this._array.length;++d)this._array[d]=this._values[this._array.length*t+d];return this._array}},{key:"empty",value:function(){return 0===this._values.length}},{key:"constant",value:function(){return 1===this._values.length}}]),e}());rU.Linear=null,E.AnimCurve=rU;e("EventInfo",function(){function e(){i(this,e),this.events=[]}return r(e,[{key:"add",value:function(e,t){this.events.push({func:e||"",params:t||[]})}}]),e}());function aU(e,t,i){var n=t.sample(i);if(n<0)if((n=~n)<=0)n=0;else{if(!(n>=t.ratios.length))return e.valueBetween(i,n-1,t.ratios[n-1],n,t.ratios[n]);n=t.ratios.length-1}return e.valueAt(n)}function oU(e,t){if("string"==typeof t){var i=Xz[t];i?e=i(e):V(3906,t)}else Array.isArray(t)&&(e=iU(t,e));return e}function sU(e,t){var i=e.length-1;if(0===i)return 0;var n=e[0];if(t<n)return 0;var r=e[i];if(t>r)return i;var a=(t=(t-n)/(r-n))/(1/i),o=0|a;return a-o<1e-6?o:o+1-a<1e-6?o+1:~(o+1)}E.sampleAnimationCurve=aU;var lU,cU,uU,hU,_U,dU,fU,pU,mU,vU,gU,yU,xU,SU,TU=function(){function e(e,t,i,n){return e.lerp(t,i,n)}return function(i){if(null!==i){if("number"==typeof i)return yn;if("object"===t(i)&&i.constructor){if(i instanceof pa)return n=new pa,function(e,t,i,r){return pa.slerp(n,e,t,i)};if(i instanceof rt)return function(e){var t=new e;return function(i,n,r){return e.lerp(t,i,n,r),t}}(i.constructor);if(i.constructor===Number)return yn;if("function"==typeof i.lerp)return e}var n}}}(),EU=e("AnimationClip",ii("cc.AnimationClip")((SU=xU=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"sample",uU,c(n)),x(n,"speed",hU,c(n)),x(n,"wrapMode",_U,c(n)),x(n,"events",dU,c(n)),x(n,"_duration",fU,c(n)),x(n,"_keys",pU,c(n)),x(n,"_stepness",mU,c(n)),x(n,"_curves",vU,c(n)),x(n,"_commonTargets",gU,c(n)),x(n,"_hash",yU,c(n)),n.frameRate=0,n._ratioSamplers=[],n._runtimeCurves=void 0,n._runtimeEvents=void 0,n._data=null,n}return o(t,e),r(t,[{key:"onLoaded",value:function(){this.frameRate=this.sample,this._decodeCVTAs()}},{key:"getPropertyCurves",value:function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}},{key:"updateEventDatas",value:function(){delete this._runtimeEvents}},{key:"getEventGroupIndexAtRatio",value:function(e){return this._runtimeEvents||this._createRuntimeEvents(),function(e,t){for(var i=0,n=e.length-1,r=n>>>1;i<=n;r=i+n>>>1){var a=e[r];if(a>t+1e-6)n=r-1;else{if(!(a<t-1e-6))return r;i=r+1}}return~i}(this._runtimeEvents.ratios,e)}},{key:"hasEvents",value:function(){return 0!==this.events.length}},{key:"destroy",value:function(){return E.director.root.dataPoolManager.releaseAnimationClip(this),lg.destroy(this),_(s(t.prototype),"destroy",this).call(this)}},{key:"_createPropertyCurves",value:function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new nU(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new rU(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}})),this._applyStepness()}},{key:"_createRuntimeEvents",value:function(){for(var e,t=this,i=[],n=[],r=function(){var r=e.value,a=r.frame/t._duration,o=i.findIndex((function(e){return e===a}));o<0&&(o=i.length,i.push(a),n.push({events:[]})),n[o].events.push({functionName:r.func,parameters:r.params})},a=y(this.events.sort((function(e,t){return e.frame-t.frame})));!(e=a()).done;)r();this._runtimeEvents={ratios:i,eventGroups:n}}},{key:"_applyStepness",value:function(){this._runtimeCurves}},{key:"_decodeCVTAs",value:function(){var e=ArrayBuffer.isView(this._nativeAsset)?this._nativeAsset.buffer:this._nativeAsset;if(e){for(var t=this._keys,i=0;i<t.length;++i){var n=t[i];n instanceof pw&&(t[i]=n.decompress(e))}for(var r=0;r<this._curves.length;++r){var a=this._curves[r];a.data.values instanceof pw&&(a.data.values=a.data.values.decompress(e))}}}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"eventGroups",get:function(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}},{key:"stepness",get:function(){return this._stepness},set:function(e){this._stepness=e,this._applyStepness()}},{key:"hash",get:function(){if(this._hash)return this._hash;var e=this._nativeAsset,t=new Uint8Array(ArrayBuffer.isView(e)?e.buffer:e);return this._hash=rl(t,666)}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"data",get:function(){return this._data}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}}],[{key:"createWithSpriteFrames",value:function(e,i){if(!Array.isArray(e))return V(3905),null;var n=new t;n.sample=i||n.sample,n.duration=e.length/n.sample;for(var r=1/n.sample,a=new Array(e.length),o=new Array(a.length),s=0;s<e.length;s++)a[s]=s*r,o[s]=e[s];return n.keys=[a],n.curves=[{modifiers:[new og("cc.Sprite"),"spriteFrame"],data:{keys:0,values:o}}],n}}]),t}(cn),xU.preventDeferredLoadDependents=!0,xU.WrapMode=su,uU=S((cU=SU).prototype,"sample",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),hU=S(cU.prototype,"speed",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),_U=S(cU.prototype,"wrapMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return su.Normal}}),dU=S(cU.prototype,"events",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fU=S(cU.prototype,"_duration",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pU=S(cU.prototype,"_keys",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mU=S(cU.prototype,"_stepness",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vU=S(cU.prototype,"_curves",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gU=S(cU.prototype,"_commonTargets",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yU=S(cU.prototype,"_hash",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lU=cU))||lU);function bU(e,t,i){var n,r=t[t.length-1];if(0!==t.length&&ng(r)&&!i){var a=sg.apply(void 0,[e].concat(m(t.slice(0,t.length-1))));if(null===a)return null;n={isProxy:!1,object:a,property:r}}else{if(!i)return k("Empty animation curve."),null;var o=sg.apply(void 0,[e].concat(m(t)));if(null===o)return null;n={isProxy:!0,proxy:i.forTarget(o)}}return{setValue:function(e){n.isProxy?n.proxy.set(e):n.object[n.property]=e},getValue:function(){return n.isProxy?n.proxy.get?n.proxy.get():(k("Target doesn't provide a get method."),null):n.object[n.property]}}}function AU(e,t,i){var n=bU(e,t,i);if(null===n)return null;var r=n.getValue(),a=wU(r);if(!a)return k("Value is not copyable!"),null;var o=a.createBuffer(),s=a.copy;return Object.assign(n,{peek:function(){return o},pull:function(){var e=n.getValue();s(o,e)},push:function(){n.setValue(o)}})}E.AnimationClip=EU;var CU,wU=((CU=new Map).set(ia,{createBuffer:function(){return new ia},copy:ia.copy}),CU.set(oa,{createBuffer:function(){return new oa},copy:oa.copy}),CU.set(ua,{createBuffer:function(){return new ua},copy:ua.copy}),CU.set(Ma,{createBuffer:function(){return new Ma},copy:Ma.copy}),function(e){return CU.get(null==e?void 0:e.constructor)}),RU=function(){function e(){i(this,e),this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}return r(e,[{key:"play",value:function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(X(3912)):(this._isPlaying=!0,this.onPlay())}},{key:"stop",value:function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}},{key:"pause",value:function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}},{key:"resume",value:function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}},{key:"step",value:function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}},{key:"update",value:function(e){}},{key:"onPlay",value:function(){}},{key:"onPause",value:function(){}},{key:"onResume",value:function(){}},{key:"onStop",value:function(){}},{key:"onError",value:function(e){}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),IU=function(){function e(){i(this,e),this._nodeBlendStates=new Map}return r(e,[{key:"ref",value:function(e,t){var i=this._nodeBlendStates.get(e);i||(i={dirty:!1,properties:{}},this._nodeBlendStates.set(e,i));var n=i.properties[t];return n||(n=i.properties[t]=new PU(i,OU(t)?new oa:new pa)),++n.refCount,n}},{key:"deRef",value:function(e,t){var i=this._nodeBlendStates.get(e);if(i){var n=i.properties[t];n&&(--n.refCount,n.refCount>0||(delete i.properties[t],function(e){return!(e.properties.position||e.properties.rotation||e.properties.eulerAngles||e.properties.scale)}(i)&&this._nodeBlendStates.delete(e)))}}},{key:"apply",value:function(){this._nodeBlendStates.forEach((function(e,t){if(e.dirty){e.dirty=!1;var i,n,r,a=e.properties,o=a.position,s=a.scale,l=a.rotation,c=a.eulerAngles,u=!1;o&&0!==o.weight&&(o.weight=0,i=o.value,u=!0),s&&0!==s.weight&&(s.weight=0,n=s.value,u=!0),l&&0!==l.weight&&(l.weight=0,r=l.value,u=!0),c&&0!==c.weight&&(c.weight=0,r=c.value,u=!0),u&&t.setRTS(r,i,n)}}))}}]),e}();function OU(e){return!function(e){return"rotation"===e}(e)}var MU,PU=function(){function e(t,n){i(this,e),this.weight=0,this.value=void 0,this.refCount=0,this._node=void 0,this._node=t,this.value=n}return r(e,[{key:"markAsDirty",value:function(){this._node.dirty=!0}}]),e}();function kU(e,t,i){return 0===i.weight&&oa.zero(i.value),0===t?i.value:1===t?oa.copy(i.value,e):oa.scaleAndAdd(i.value,i.value,e,t)}function DU(e,t,i){if(0===i.weight&&pa.identity(i.value),0===t)return i.value;if(1===t)return pa.copy(i.value,e);var n=t/(i.weight+t);return pa.slerp(i.value,i.value,e,n)}!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(MU||(MU={})),nt(MU);var BU=function(){function e(t,n,r){i(this,e),this.commonTargetIndex=void 0,this._curve=void 0,this._boundTarget=void 0,this._rootTargetProperty=void 0,this._curveDetail=void 0,this._curve=t.curve,this._curveDetail=t,this._boundTarget=r}return r(e,[{key:"applySample",value:function(e,t,i,n,r){var a;this._curve.empty()||(a=this._curve.hasLerp()&&i?this._curve.valueBetween(e,n.from,n.fromRatio,n.to,n.toRatio):this._curve.valueAt(t),this._setValue(a,r))}},{key:"_setValue",value:function(e,t){this._boundTarget.setValue(e)}},{key:"propertyName",get:function(){return this._rootTargetProperty||""}},{key:"curveDetail",get:function(){return this._curveDetail}}]),e}();var LU=e("AnimationState",function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return i(this,t),(n=u(this,s(t).call(this))).duration=1,n.speed=1,n.time=0,n.weight=0,n.frameRate=0,n._wrapMode=su.Normal,n._repeatCount=1,n._currentFramePlayed=!1,n._delay=0,n._delayTime=0,n._wrappedInfo=new cu,n._lastWrapInfo=null,n._lastWrapInfoEvent=null,n._process=n.process,n._target=null,n._targetNode=null,n._clip=void 0,n._name=void 0,n._lastIterations=void 0,n._samplerSharedGroups=[],n._commonTargetStatuses=[],n._curveLoaded=!1,n._ignoreIndex=-1,n._blendStateBuffer=null,n._blendStateWriters=[],n._allowLastFrame=!1,n._clip=e,n._name=r||e&&e.name,n}return o(t,e),r(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){this._wrapMode=e,this.time=0,e&ou.Loop?this.repeatCount=1/0:this.repeatCount=1}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&ou.ShouldWrap,i=(this.wrapMode&ou.Reverse)===ou.Reverse;this._process=e!==1/0||t||i?this.process:this.simpleProcess}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}}]),r(t,[{key:"initialize",value:function(e,t){var i,n,r=this;if(!this._curveLoaded){this._curveLoaded=!0,this._destroyBlendStateWriters(),this._samplerSharedGroups.length=0,this._blendStateBuffer=null!==(i=null===(n=E.director.getAnimationManager())||void 0===n?void 0:n.blendState)&&void 0!==i?i:null,this._targetNode=e;var a=this._clip;this.duration=a.duration,this.speed=a.speed,this.wrapMode=a.wrapMode,this.frameRate=a.sample,(this.wrapMode&ou.Loop)===ou.Loop?this.repeatCount=1/0:this.repeatCount=1;var o=function(e,t,i,n,a){if(!function(e){var t;if(1===e.length&&"string"==typeof e[0])t=e[0];else if(e.length>1){for(var i=0;i<e.length-1;++i)if(!(e[i]instanceof ag))return!1;t=e[e.length-1]}switch(t){case"position":case"scale":case"rotation":case"eulerAngles":return!0;default:return!1}}(i)||!r._blendStateBuffer)return e(t,i,n);var o=sg.apply(void 0,[t].concat(m(i.slice(0,i.length-1))));if(null!==o&&o instanceof ig){var s=i[i.length-1],l=function(e,t,i,n,r){var a=OU(i)?kU:DU,o=e.ref(t,i),s=!1,l=-1;return{destroy:function(){o&&(e.deRef(t,i),o=null)},forTarget:function(){return{get:function(){return t[i]},set:function(e){if(o){var t=n.weight;if(r)if(1!==t||t!==l)s=!1;else if(s)return;a(e,t,o),o.weight+=t,o.markAsDirty(),s=!0,l=t}}}}}}(r._blendStateBuffer,o,s,r,a);return r._blendStateWriters.push(l),e(t,[],l)}return null};this._commonTargetStatuses=a.commonTargets.map((function(t,i){var n=o(AU,e,t.modifiers,t.valueAdapter,!1);return null===n?null:{target:n,changed:!1}})),t||(t=a.getPropertyCurves());for(var s=function(i){var n=t[i],a=r._samplerSharedGroups.find((function(e){return e.sampler===n.sampler}));a||(a={sampler:n.sampler,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}},r._samplerSharedGroups.push(a));var s=void 0;if(void 0===n.commonTarget)s=e;else{var l=r._commonTargetStatuses[n.commonTarget];if(!l)return"continue";s=l.target.peek()}var c=o(bU,s,n.modifiers,n.valueAdapter,n.curve.constant());if(null===c);else{var u=new BU(n,s,c);u.commonTargetIndex=n.commonTarget,a.curves.push(u)}},l=0;l<t.length;++l)s(l)}}},{key:"destroy",value:function(){this._destroyBlendStateWriters()}},{key:"emit",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];E.director.getAnimationManager().pushDelayEvent(this._emit,this,t)}},{key:"on",value:function(e,t,i){return this._target&&this._target.isValid?this._target.on(e,t,i):null}},{key:"once",value:function(e,t,i){return this._target&&this._target.isValid?this._target.once(e,t,i):null}},{key:"off",value:function(e,t,i){this._target&&this._target.isValid&&this._target.off(e,t,i)}},{key:"allowLastFrameEvent",value:function(e){this._allowLastFrame=e}},{key:"_setEventTarget",value:function(e){this._target=e}},{key:"setTime",value:function(e){this._currentFramePlayed=!1,this.time=e||0,this._lastWrapInfoEvent=null,this._ignoreIndex=-1;var t=this.getWrappedInfo(e,this._wrappedInfo),i=t.direction,n=this._clip.getEventGroupIndexAtRatio(t.ratio);n<0&&(n=~n-1,i<0&&(n+=1),this._ignoreIndex=n)}},{key:"update",value:function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())}},{key:"_needReverse",value:function(e){var t=this.wrapMode,i=!1;(t&ou.PingPong)===ou.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(i=!i));return(t&ou.Reverse)===ou.Reverse&&(i=!i),i}},{key:"getWrappedInfo",value:function(e,t){t=t||new cu;var i=!1,n=this.duration,r=this.repeatCount,a=e>0?e/n:-e/n;if(a>=r){a=r,i=!0;var o=r-(0|r);0===o&&(o=1),e=o*n*(e>0?1:-1)}if(e>n){var s=e%n;e=0===s?n:s}else e<0&&0!==(e%=n)&&(e+=n);var l=!1,c=this._wrapMode&ou.ShouldWrap;c&&(l=this._needReverse(a));var u=l?-1:1;return this.speed<0&&(u*=-1),c&&l&&(e=n-e),t.ratio=e/n,t.time=e,t.direction=u,t.stopped=i,t.iterations=a,t}},{key:"sample",value:function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.ratio),this._sampleEvents(e),e}},{key:"process",value:function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new cu(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(MU.LASTFRAME,this),e.set(t));t.stopped&&(this.stop(),this.emit(MU.FINISHED,this))}},{key:"simpleProcess",value:function(){var e=this.duration,t=this.time%e;t<0&&(t+=e);var i=t/e;this._sampleCurves(i),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(void 0===this._lastIterations&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(MU.LASTFRAME,this),this._lastIterations=i)}},{key:"cache",value:function(e){}},{key:"onPlay",value:function(){this.setTime(0),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(MU.PLAY,this)}},{key:"onStop",value:function(){this.isPaused||this._onPauseOrStop(),this.emit(MU.STOP,this)}},{key:"onResume",value:function(){this._onReplayOrResume(),this.emit(MU.RESUME,this)}},{key:"onPause",value:function(){this._onPauseOrStop(),this.emit(MU.PAUSE,this)}},{key:"_sampleCurves",value:function(e){for(var t=0;t<this._commonTargetStatuses.length;++t){var i=this._commonTargetStatuses[t];i&&(i.target.pull(),i.changed=!1)}for(var n=0,r=this._samplerSharedGroups.length;n<r;++n){var a=this._samplerSharedGroups[n],o=a.sampler,s=a.samplerResultCache,l=0,c=!1;o?(l=o.sample(e))<0&&((l=~l)<=0?l=0:l>=o.ratios.length?l=o.ratios.length-1:(c=!0,s.from=l-1,s.fromRatio=o.ratios[s.from],s.to=l,s.toRatio=o.ratios[s.to],l=s.from)):l=0;for(var u=0,h=a.curves.length;u<h;++u){var _=a.curves[u];if(_.applySample(e,l,c,s,this.weight),void 0!==_.commonTargetIndex){var d=this._commonTargetStatuses[_.commonTargetIndex];d&&(d.changed=!0)}}}for(var f=0;f<this._commonTargetStatuses.length;++f){var p=this._commonTargetStatuses[f];p&&(p.changed&&p.target.push())}}},{key:"_sampleEvents",value:function(e){var t=this._clip.eventGroups.length,i=e.direction,n=this._clip.getEventGroupIndexAtRatio(e.ratio);if(n<0&&(n=~n-1,i<0&&(n+=1)),this._ignoreIndex!==n&&(this._ignoreIndex=-1),e.frameIndex=n,!this._lastWrapInfoEvent)return this._fireEvent(n),void(this._lastWrapInfoEvent=new cu(e));var r=this.wrapMode,a=NU(e.iterations),o=this._lastWrapInfoEvent,s=NU(o.iterations),l=o.frameIndex,c=o.direction,u=-1!==s&&a!==s;if(l===n&&u&&1===t)this._fireEvent(0);else if(l!==n||u){i=c;do{if(l!==n){if(-1===i&&0===l&&n>0?((r&ou.PingPong)===ou.PingPong?i*=-1:l=t,s++):1===i&&l===t-1&&n<t-1&&((r&ou.PingPong)===ou.PingPong?i*=-1:l=-1,s++),l===n)break;if(s>a)break}l+=i,E.director.getAnimationManager().pushDelayEvent(this._fireEvent,this,[l])}while(l!==n&&l>-1&&l<t)}this._lastWrapInfoEvent.set(e)}},{key:"_emit",value:function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)}},{key:"_fireEvent",value:function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._clip.eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var i,n=t[e],r=this._targetNode.components,a=y(n.events);!(i=a()).done;)for(var o,s=i.value,l=s.functionName,c=y(r);!(o=c()).done;){var u=o.value,h=u[l];"function"==typeof h&&h.apply(u,s.parameters)}}}},{key:"_onReplayOrResume",value:function(){E.director.getAnimationManager().addAnimation(this)}},{key:"_onPauseOrStop",value:function(){E.director.getAnimationManager().removeAnimation(this)}},{key:"_destroyBlendStateWriters",value:function(){for(var e=0;e<this._blendStateWriters.length;++e)this._blendStateWriters[e].destroy();this._blendStateWriters.length=0}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(RU));function NU(e){return e-(0|e)==0&&(e-=1),0|e}E.AnimationState=LU;var FU,zU,UU,GU,HU,VU,WU,jU,qU,XU,YU,KU,ZU,QU,JU,$U,eG,tG=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._managedStates=[],e._fadings=[],e}return o(t,e),r(t,[{key:"update",value:function(e){if(!this.isMotionless){for(var t=0;t<this._managedStates.length;++t){var i=this._managedStates[t].state;i&&(i.weight=0)}for(var n=1,r=this._fadings.length,a=0;a<this._fadings.length;++a){var o=this._fadings[a];o.easeTime+=e;var s=0===o.easeDuration?1:gn(o.easeTime/o.easeDuration),l=s*n;if(n*=1-s,o.target.state&&(o.target.state.weight+=l),o.easeTime>=o.easeDuration){r=a+1,o.easeTime=o.easeDuration;break}}if(r!==this._fadings.length){for(var c=r;c<this._fadings.length;++c){var u=this._fadings[c];--u.target.reference,u.target.reference<=0&&(u.target.state&&u.target.state.stop(),$(this._managedStates,u.target))}this._fadings.splice(r)}for(var h=0;h<this._managedStates.length;++h){var _=this._managedStates[h].state;_&&_.isMotionless&&_.sample()}}}},{key:"crossFade",value:function(e,t){var i;0===this._managedStates.length&&(t=0),0===t&&this.clear();var n=this._managedStates.find((function(t){return t.state===e}));n?(null===(i=n.state)||void 0===i?void 0:i.isMotionless)&&n.state.play():(n={state:e,reference:0},e&&e.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:n})}},{key:"clear",value:function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0}},{key:"onPlay",value:function(){_(s(t.prototype),"onPlay",this).call(this),E.director.getAnimationManager().addCrossFade(this)}},{key:"onPause",value:function(){_(s(t.prototype),"onPause",this).call(this),E.director.getAnimationManager().removeCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var i=this._managedStates[e].state;i&&i.pause()}}},{key:"onResume",value:function(){_(s(t.prototype),"onResume",this).call(this),E.director.getAnimationManager().addCrossFade(this);for(var e=0;e<this._managedStates.length;++e){var i=this._managedStates[e].state;i&&i.resume()}}},{key:"onStop",value:function(){_(s(t.prototype),"onStop",this).call(this),E.director.getAnimationManager().removeCrossFade(this),this.clear()}}]),t}(RU),iG=e("AnimationComponent",(FU=ii("cc.Animation"),zU=mi("i18n:cc.Animation"),UU=ri(99),GU=_i("Components/Animation"),HU=Li([EU]),VU=Si(""),WU=Li(EU),jU=Si(""),qU=Si(""),XU=Li([EU]),FU(YU=zU(YU=UU(YU=hi(YU=GU((eG=$U=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"playOnLoad",ZU,c(n)),n._crossFade=new tG,n._nameToState=_e(!0),x(n,"_clips",QU,c(n)),x(n,"_defaultClip",JU,c(n)),n._hasBeenPlayed=!1,n}return o(t,e),r(t,[{key:"onLoad",value:function(){for(var e in this.clips=this._clips,this._nameToState){this._nameToState[e].initialize(this.node)}}},{key:"start",value:function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}},{key:"onEnable",value:function(){this._crossFade.resume()}},{key:"onDisable",value:function(){this._crossFade.pause()}},{key:"onDestroy",value:function(){for(var e in this._crossFade.stop(),this._nameToState){this._nameToState[e].destroy()}this._nameToState=_e(!0)}},{key:"play",value:function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)}},{key:"crossFade",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3;this._hasBeenPlayed=!0;var i=this._nameToState[e];i&&(this._crossFade.play(),this._crossFade.crossFade(i,t))}},{key:"pause",value:function(){this._crossFade.pause()}},{key:"resume",value:function(){this._crossFade.resume()}},{key:"stop",value:function(){this._crossFade.stop()}},{key:"getAnimationState",value:function(e){return this.getState(e)}},{key:"getState",value:function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null}},{key:"createState",value:function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)}},{key:"removeState",value:function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])}},{key:"addClip",value:function(e,t){return ee(this._clips,e)||this._clips.push(e),this.createState(e,t)}},{key:"removeClip",value:function(e,t){var i;for(var n in this._nameToState){var r=this._nameToState[n];if(r.clip===e){i=r;break}}if(e===this._defaultClip){if(!t)return void G(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!t)return void G(3903);i.stop()}this._clips=this._clips.filter((function(t){return t!==e})),i&&delete this._nameToState[i.name]}},{key:"on",value:function(e,i,n,r){var a=_(s(t.prototype),"on",this).call(this,e,i,n,r);return e===MU.LASTFRAME&&this._syncAllowLastFrameEvent(),a}},{key:"once",value:function(e,i,n){var r=_(s(t.prototype),"once",this).call(this,e,i,n);return e===MU.LASTFRAME&&this._syncAllowLastFrameEvent(),r}},{key:"off",value:function(e,i,n){_(s(t.prototype),"off",this).call(this,e,i,n),e===MU.LASTFRAME&&this._syncDisallowLastFrameEvent()}},{key:"_createState",value:function(e,t){return new LU(e,t)}},{key:"_doCreateState",value:function(e,t){var i=this._createState(e,t);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener(MU.LASTFRAME)),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}},{key:"_getStateByNameOrDefaultClip",value:function(e){if(!e){if(!this._defaultClip)return null;e=this._defaultClip.name}var t=this._nameToState[e];return t||null}},{key:"_removeStateOfAutomaticClip",value:function(e){for(var t in this._nameToState){var i=this._nameToState[t];nG(e,i.clip)&&(i.stop(),delete this._nameToState[t])}}},{key:"_syncAllowLastFrameEvent",value:function(){if(this.hasEventListener(MU.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)}},{key:"_syncDisallowLastFrameEvent",value:function(){if(!this.hasEventListener(MU.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)}},{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var i,n=y(this._clips);!(i=n()).done;){var r=i.value;r&&this._removeStateOfAutomaticClip(r)}for(var a,o=y(e);!(a=o()).done;){var s=a.value;s&&this.createState(s)}var l=e.find((function(e){return nG(e,t._defaultClip)}));this._defaultClip=l||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){(this._defaultClip=e,e)&&(this._clips.findIndex((function(t){return nG(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}($i(Yr)),$U.EventType=MU,S((KU=eG).prototype,"clips",[HU,VU],Object.getOwnPropertyDescriptor(KU.prototype,"clips"),KU.prototype),S(KU.prototype,"defaultClip",[WU,jU],Object.getOwnPropertyDescriptor(KU.prototype,"defaultClip"),KU.prototype),ZU=S(KU.prototype,"playOnLoad",[si,qU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QU=S(KU.prototype,"_clips",[XU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JU=S(KU.prototype,"_defaultClip",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YU=KU))||YU)||YU)||YU)||YU)||YU));function nG(e,t){return e===t||!(!e||!t||e.name!==t.name&&e._uuid!==t._uuid)}var rG,aG,oG,sG,lG,cG,uG,hG,_G,dG,fG,pG,mG,vG,gG,yG,xG,SG,TG,EG,bG=new Ta,AG=new Ta,CG=[],wG=e("SkeletalAnimationState",function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return i(this,t),(n=u(this,s(t).call(this,e,r)))._frames=1,n._bakedDuration=0,n._animInfo=null,n._sockets=[],n._animInfoMgr=void 0,n._comps=[],n._parent=null,n._curvesInited=!1,n._animInfoMgr=E.director.root.dataPoolManager.jointAnimationInfo,n}return o(t,e),r(t,[{key:"initialize",value:function(e){if(!this._curveLoaded){this._comps.length=0;for(var i=e.getComponentsInChildren(DN),n=0;n<i.length;++n){var r=i[n];r.skinningRoot===e&&this._comps.push(r)}this._parent=e.getComponent("cc.SkeletalAnimation");var a=this._parent.useBakedAnimation;_(s(t.prototype),"initialize",this).call(this,e,a?CG:void 0),this._curvesInited=!a;var o=lg.getOrExtract(this.clip).info;this._frames=o.frames-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/o.sample}}},{key:"onPlay",value:function(){if(_(s(t.prototype),"onPlay",this).call(this),this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this._clip);for(var e=0;e<this._comps.length;++e)this._comps[e].uploadAnimation(this.clip)}else this._sampleCurves=_(s(t.prototype),"_sampleCurves",this),this.duration=this._clip.duration,this._curvesInited||(this._curveLoaded=!1,_(s(t.prototype),"initialize",this).call(this,this._targetNode),this._curvesInited=!0)}},{key:"rebuildSocketCurves",value:function(e){if(this._sockets.length=0,!this._targetNode)return null;for(var t=this._targetNode,i=0;i<e.length;++i){var n=e[i],r=t.getChildByPath(n.path);if(n.target){for(var a=lg.getOrExtract(this.clip),o=n.path,s=a.data[o],l=r,c=void 0;!s;){var u=o.lastIndexOf("/");if(o=o.substring(0,u),s=a.data[o],l&&(c||(c=Ta.identity(AG)),Ta.fromRTS(bG,l.rotation,l.position,l.scale),Ta.multiply(c,bG,c),l=l.parent),u<0)break}for(var h=s&&s.worldMatrix.values,_=a.info.frames,d=[],f=0;f<_;f++){var p=void 0;p=h&&c?Ta.multiply(bG,h[f],c):h?h[f]:c||Ta.IDENTITY;var m={pos:new oa,rot:new pa,scale:new oa};Ta.toRTS(p,m.rot,m.pos,m.scale),d.push(m)}this._sockets.push({target:n.target,frames:d})}}}},{key:"_sampleCurvesBaked",value:function(e){var t=this._animInfo,i=e*this._frames+.5|0;if(i!==t.data[0]){t.data[0]=i,t.dirty=!0;for(var n=0;n<this._sockets.length;++n){var r=this._sockets[n],a=r.target,o=r.frames[i],s=o.pos,l=o.rot,c=o.scale;a.setRTS(l,s,c)}}}}]),t}(LU)),RG=e("Socket",(rG=ii("cc.SkeletalAnimationComponent.Socket"),aG=Li(ig),rG((lG=S((sG=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;i(this,e),x(this,"path",lG,this),x(this,"target",cG,this),this.path=t,this.target=n}).prototype,"path",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cG=S(sG.prototype,"target",[aG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oG=sG))||oG)),IG=new Ta,OG=new Ta;function MG(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=0;n<e.children.length;n++){var r=e.children[n];if(r){var a=t?"".concat(t,"/").concat(r.name):r.name;i.push(a),MG(r,a,i)}}return i}var PG,kG,DG,BG=e("SkeletalAnimationComponent",(uG=ii("cc.SkeletalAnimation"),hG=mi("i18n:cc.SkeletalAnimation"),_G=ri(99),dG=_i("Components/SkeletalAnimation"),fG=Li([RG]),pG=Si("i18n:animation.sockets"),mG=Si("i18n:animation.use_baked_animation"),vG=Li([RG]),uG(gG=hG(gG=_G(gG=hi(gG=dG((EG=TG=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_useBakedAnimation",xG,c(n)),x(n,"_sockets",SG,c(n)),n}return o(t,e),r(t,[{key:"onDestroy",value:function(){_(s(t.prototype),"onDestroy",this).call(this),E.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),E.director.getAnimationManager().removeSockets(this.node,this._sockets)}},{key:"start",value:function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,_(s(t.prototype),"start",this).call(this)}},{key:"querySockets",value:function(){var e=this._defaultClip&&Object.keys(lg.getOrExtract(this._defaultClip).data).sort().reduce((function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e}),[])||[];if(!e.length)return["please specify a valid default animation clip first"];for(var t=[],i=0;i<e.length;i++){var n=e[i],r=this.node.getChildByPath(n);r&&(t.push(n),MG(r,n,t))}return t}},{key:"rebuildSocketAnimations",value:function(){for(var e,t=y(this._sockets);!(e=t()).done;){var i=e.value,n=this.node.getChildByPath(i.path),r=i.target;n&&r&&(r.name="".concat(i.path.substring(i.path.lastIndexOf("/")+1)," Socket"),r.parent=this.node,hg(n,this.node,IG),Ta.fromRTS(OG,r.rotation,r.position,r.scale),Ta.equals(OG,IG)||(r.matrix=IG))}for(var a=0,o=Object.keys(this._nameToState);a<o.length;a++){var s=o[a];this._nameToState[s].rebuildSocketCurves(this._sockets)}}},{key:"createSocket",value:function(e){var t=this._sockets.find((function(t){return t.path===e}));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;var i=new ig;return i.parent=this.node,this._sockets.push(new RG(e,i)),this.rebuildSocketAnimations(),i}},{key:"_createState",value:function(e,t){return new wG(e,t)}},{key:"_doCreateState",value:function(e,i){var n=_(s(t.prototype),"_doCreateState",this).call(this,e,i);return n.rebuildSocketCurves(this._sockets),n}},{key:"sockets",get:function(){return this._sockets},set:function(e){if(!this._useBakedAnimation){var t=E.director.getAnimationManager();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(e){this._useBakedAnimation=e;for(var t=this.node.getComponentsInChildren(DN),i=0;i<t.length;++i){var n=t[i];n.skinningRoot===this.node&&n.setUseBakedAnimation(this._useBakedAnimation)}this._useBakedAnimation?E.director.getAnimationManager().removeSockets(this.node,this._sockets):E.director.getAnimationManager().addSockets(this.node,this._sockets)}}]),t}(iG),TG.Socket=RG,S((yG=EG).prototype,"sockets",[fG,pG],Object.getOwnPropertyDescriptor(yG.prototype,"sockets"),yG.prototype),S(yG.prototype,"useBakedAnimation",[mG],Object.getOwnPropertyDescriptor(yG.prototype,"useBakedAnimation"),yG.prototype),xG=S(yG.prototype,"_useBakedAnimation",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SG=S(yG.prototype,"_sockets",[vG],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gG=yG))||gG)||gG)||gG)||gG)||gG));ka(iG.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return iG.prototype.removeState.call(this,e.name)}}]),E.AnimationComponent=iG,ze.setClassAlias(iG,"cc.AnimationComponent"),E.SkeletalAnimationComponent=BG,ze.setClassAlias(BG,"cc.SkeletalAnimationComponent");var LG,NG,FG,zG,UG=e("AnimationManager",ii((DG=kG=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._anims=new Q([]),n._delayEvents=[],n._blendStateBuffer=new IU,n._crossFades=[],n._sockets=[],n}return o(t,e),r(t,[{key:"addCrossFade",value:function(e){this._crossFades.push(e)}},{key:"removeCrossFade",value:function(e){$(this._crossFades,e)}},{key:"update",value:function(e){for(var t=this._delayEvents,i=this._crossFades,n=this._sockets,r=0,a=i.length;r<a;r++)i[r].update(e);var o=this._anims,s=o.array;for(o.i=0;o.i<s.length;++o.i){var l=s[o.i];l.isMotionless||l.update(e)}this._blendStateBuffer.apply();for(var c=E.director.getTotalFrames(),u=0,h=n.length;u<h;u++){var _=n[u],d=_.target,f=_.transform;d.matrix=Wb(f,c)}for(var p=0,m=t.length;p<m;p++){var v=t[p];v.fn.apply(v.thisArg,v.args)}t.length=0}},{key:"destruct",value:function(){}},{key:"addAnimation",value:function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)}},{key:"removeAnimation",value:function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):V(3907)}},{key:"pushDelayEvent",value:function(e,t,i){this._delayEvents.push({fn:e,thisArg:t,args:i})}},{key:"addSockets",value:function(e,t){for(var i=this,n=function(n){var r=t[n];if(i._sockets.find((function(e){return e.target===r.target})))return"continue";var a=e.getChildByPath(r.path),o=r.target&&a&&jb(a,e);o&&i._sockets.push({target:r.target,transform:o})},r=0;r<t.length;++r)n(r)}},{key:"removeSockets",value:function(e,t){for(var i=0;i<t.length;++i)for(var n=t[i],r=0;r<this._sockets.length;++r){var a=this._sockets[r];if(a.target===n.target){qb(a.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}},{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(PD),kG.ID="animation",PG=DG))||PG);AB.on(iB.EVENT_INIT,(function(){var e=new UG;AB.registerSystem(UG.ID,e,FD.PRIORITY_SYSTEM)})),E.AnimationManager=UG,E.easing=Xz;var GG=e("HierachyModifier",ii("cc.HierachyModifier")(LG=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),t}(ag))||LG);E.HierachyModifier=GG;var HG=e("ComponentModifier",ii("cc.ComponentModifier")(NG=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),t}(og))||NG);E.ComponentModifier=HG;var VG=e("CurveValueAdapter",ii("cc.CurveValueAdapter")(FG=function(){function e(){i(this,e)}return r(e,[{key:"forTarget",value:function(e){return{set:function(){}}}}]),e}())||FG);E.CurveValueAdapter=VG;var WG=e("UniformCurveValueAdapter",ii("cc.UniformCurveValueAdapter")(zG=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),t}(iz))||zG);function jG(e){return"string"==typeof e}function qG(e){return"number"==typeof e}function XG(e,t){return e instanceof t}E.UniformCurveValueAdapter=WG,E.isPropertyModifier=jG,E.isElementModifier=qG,E.isCustomTargetModifier=XG;var YG,KG=function(){function e(t,n,r){i(this,e),this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=n,this._accumStart=r}return r(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),r(e,[{key:"sample",value:function(e){this._average(this._value,e)}},{key:"human",value:function(){var e=this._opts,t=e.average,i=e.isInteger,n=t?this._averageValue:this._value;return i?Math.round(n):Math.round(100*n)/100}},{key:"alarm",value:function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}},{key:"_average",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this._opts.average){this._accumValue+=e,++this._accumSamples;var i=t;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}]),e}(),ZG=ii("cc.PerfCounter")(YG=function(e){function t(e,n,r){var a;return i(this,t),(a=u(this,s(t).call(this,e,n,r)))._time=void 0,a._time=r,a}return o(t,e),r(t,[{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._time=e}},{key:"end",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._value=e-this._time,this._average(this._value)}},{key:"tick",value:function(){this.end(),this.start()}},{key:"frame",value:function(e){var t=e,i=t-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=t,this._average(this._value))}}]),t}(KG))||YG,QG={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},JG={frame:{desc:"Frame time (ms)",min:0,max:50,average:500},fps:{desc:"Framerate (FPS)",below:30,average:500,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},$G=23,eH=.4,tH=8,iH=256,nH=256,rH=e("Profiler",function(){function e(){i(this,e),this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new Ms,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=nH/(Object.keys(JG).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}return r(e,[{key:"isShowingStats",value:function(){return this._showFPS}},{key:"hideStats",value:function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),E.game.off(E.Game.EVENT_RESTART,this.generateNode,this),E.director.off(E.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),E.director.off(E.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),E.director.off(E.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),E.director.off(E.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),E.director.off(E.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),E.director.off(E.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)}},{key:"showStats",value:function(){this._showFPS||(this._device||(this._device=E.director.root.device),this.generateCanvas(),this.generateStats(),E.game.once(E.Game.EVENT_ENGINE_INITED,this.generateNode,this),E.game.on(E.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),E.director.on(E.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),E.director.on(E.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),E.director.on(E.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),E.director.on(E.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),E.director.on(E.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),E.director.on(E.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)}},{key:"generateCanvas",value:function(){if(!this._canvasDone){var e=iH,t=nH;this._ctx&&this._canvas&&(this._canvas.width=e,this._canvas.height=t,this._canvas.style.width="".concat(this._canvas.width),this._canvas.style.height="".concat(this._canvas.height),this._ctx.font="".concat($G,"px Arial"),this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new Il(ss.TEX2D,ls.SAMPLED|ls.TRANSFER_DST,jo.RGBA8,e,t)),this._region.texExtent.width=e,this._region.texExtent.height=t)}}},{key:"generateStats",value:function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var i in JG){var n=JG[i];this._ctx.fillText(n.desc,0,t*this._lineHeight),n.counter=new ZG(i,n,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<"0123456789. ".length;++r){var a=this._ctx.measureText("0123456789. "[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,a)}for(var o=0;o<"0123456789. ".length;++o)this._ctx.fillText("0123456789. "[o],o*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=JG,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}}},{key:"generateNode",value:function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new ig("PROFILER_NODE"),E.game.addPersistRootNode(this._rootNode);var e=new ig("Profiler_Camera");e.setPosition(0,0,1.5),e.parent=this._rootNode;var t=e.addComponent("cc.Camera");t.projection=KN.ProjectionType.ORTHO,t.near=1,t.far=2,t.orthoHeight=this._device.height,t.visibility=Ph.BitMask.PROFILER,t.clearFlags=Ts.NONE,t.priority=4294967295,t.flows=["UIFlow"];var i=new ig("Profiler_Root");i.parent=this._rootNode;for(var n=eH,r=n/this._totalLines,a=n/this._wordHeight,o=r/$G,s=this._eachNumWidth*this._canvas.width*o,l=[0,n,0,a,n,0,a,0,0,0,0,0],c=[0,2,1,0,3,2],u=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],h=0,_=0;_<this._totalLines;_++)for(var d=0;d<tH;d++){l.push(a+d*s,n-_*r,0),l.push(a+(d+1)*s,n-_*r,0),l.push(a+(d+1)*s,n-(_+1)*r,0),l.push(a+d*s,n-(_+1)*r,0),h=4*(_*tH+d+1),c.push(0+h,2+h,1+h,0+h,3+h,2+h);var f=_*tH+d,p=Math.floor(f/4),m=f-4*p;u.push(0,this._wordHeight,p,m),u.push(this._eachNumWidth,this._wordHeight,p,m),u.push(this._eachNumWidth,1,p,m),u.push(0,1,p,m)}for(var v=this._device.screenSpaceSignY,g=1;g<l.length;g+=3)l[g]*=v;var y=i.addComponent(IC);y.mesh=uT({positions:l,indices:c,colors:u});var x=new sm;x.initialize({effectName:"util/profiler"}),x.setProperty("offset",new ua(-.9,-.9*v,this._eachNumWidth,0));var S=this.pass=x.passes[0],T=S.getBinding("mainTexture"),b=S.getBinding("digits");S.bindTexture(T,this._texture),this.digitsData=S.blocks[b],y.material=x,y.node.layer=Ph.Enum.PROFILER,this._inited=!0}}},{key:"beforeUpdate",value:function(){if(this._stats){var e=performance.now();this._stats.frame.counter.end(e),this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}}},{key:"afterUpdate",value:function(){if(this._stats){var e=performance.now();E.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}}},{key:"beforePhysics",value:function(){if(this._stats){var e=performance.now();this._stats.physics.counter.start(e)}}},{key:"afterPhysics",value:function(){if(this._stats){var e=performance.now();this._stats.physics.counter.end(e)}}},{key:"beforeDraw",value:function(){if(this._stats){var e=performance.now();this._stats.render.counter.start(e)}}},{key:"afterDraw",value:function(){if(this._stats&&this._inited){var e=performance.now();if(this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),!(e-this.lastTime<500)){this.lastTime=e;var t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;var i=0,n=this.digitsData;for(var r in this._stats){var a=this._stats[r];a.counter.sample(e);for(var o=a.counter.human().toString(),s=tH-1;s>=0;s--){var l=i*tH+s,c=o[o.length-(tH-s)],u=QG[c];void 0===u&&(u=11),n[l]=u}i++}this.pass._rootBufferDirty=!0}}}}]),e}()),aH=e("profiler",new rH);E.profiler=aH;var oH=function(){function e(){i(this,e),this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return r(e,[{key:"main",value:function(e){if(null==e)return console.error("RENDER ROOT IS NULL.");if(window._CCSettings&&window._CCSettings.splashScreen?(this.setting=window._CCSettings.splashScreen,this.setting.totalTime=null!=this.setting.totalTime?this.setting.totalTime:3e3,this.setting.base64src=this.setting.base64src||"",this.setting.effect=this.setting.effect||"FADE-INOUT",this.setting.clearColor=this.setting.clearColor||new As(.88,.88,.88,1),this.setting.displayRatio=null!=this.setting.displayRatio?this.setting.displayRatio:.4,this.setting.displayWatermark=null==this.setting.displayWatermark||this.setting.displayWatermark):this.setting={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new As(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0},""===this.setting.base64src||this.setting.totalTime<=0)return this.callBack&&this.callBack(),this.callBack=null,this.setting=null,void(this._directCall=!0);E.view.enableRetina(!0);var t=window._CCSettings.designResolution;t?E.view.setDesignResolutionSize(t.width,t.height,t.policy):E.view.setDesignResolutionSize(960,640,4),this.root=e,this.device=e.device,E.game.once(E.Game.EVENT_GAME_INITED,(function(){E.director._lateUpdate=performance.now()}),E.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.clearColors=[this.setting.clearColor],this.screenWidth=this.device.width,this.screenHeight=this.device.height,this.image=new Image,this.image.onload=this.init.bind(this),this.image.src=this.setting.base64src}},{key:"setOnFinish",value:function(t){if(this._directCall&&t)return e._ins=null,t();this.callBack=t}},{key:"_tryToStart",value:function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide())}},{key:"init",value:function(){var e=this;this.initCMD(),this.initIA(),this.initPSO(),this.setting.displayWatermark&&this.initText();this.handle=requestAnimationFrame((function t(i){if(!e.cancelAnimate){e.startTime<0&&(e.startTime=i);var n=i-e.startTime,r=yz(gn(n/e.setting.totalTime));"NONE"===e.setting.effect&&(r=1),e.material.setProperty("u_precent",r),e.material.passes[0].update(),e.setting.displayWatermark&&e.textMaterial&&(e.textMaterial.setProperty("u_precent",r),e.textMaterial.passes[0].update()),e.frame(i),n>e.setting.totalTime&&(e.splashFinish=!0),requestAnimationFrame(t)}}))}},{key:"hide",value:function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))}},{key:"frame",value:function(e){if(!this.cancelAnimate){var t=this.device;t.acquire();var i=this.cmdBuff,n=this.framebuffer,r=this.renderArea;i.begin(),i.beginRenderPass(n.renderPass,n,r,this.clearColors,1,0);var a=this.material.passes[0].handle,o=jx.getOrCreatePipelineState(t,a,this.shader,n.renderPass,this.assmebler);if(i.bindPipelineState(o),i.bindDescriptorSet(Gh.MATERIAL,mf.get(bf.get(a,hf.DESCRIPTOR_SET))),i.bindInputAssembler(this.assmebler),i.draw(this.assmebler),this.setting.displayWatermark&&this.textShader&&this.textAssmebler){var s=this.textMaterial.passes[0].handle,l=jx.getOrCreatePipelineState(t,s,this.textShader,n.renderPass,this.textAssmebler);i.bindPipelineState(l),i.bindDescriptorSet(Gh.MATERIAL,mf.get(bf.get(s,hf.DESCRIPTOR_SET))),i.bindInputAssembler(this.textAssmebler),i.draw(this.textAssmebler)}i.endRenderPass(),i.end(),t.queue.submit([i]),t.present()}}},{key:"initText",value:function(){this.textImg=document.createElement("canvas"),this.textImg.width=330,this.textImg.height=30,this.textImg.style.width="".concat(this.textImg.width),this.textImg.style.height="".concat(this.textImg.height);var e=this.textImg.getContext("2d");e.font="".concat(18,"px Arial"),e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";var t="Powered by Cocos Creator 3D",i=e.measureText(t);e.fillText(t,(330-i.width)/2,6),this.textRegion=new Ms,this.textRegion.texExtent.width=this.textImg.width,this.textRegion.texExtent.height=this.textImg.height,this.textRegion.texExtent.depth=1,this.textTexture=this.device.createTexture(new Il(ss.TEX2D,ls.SAMPLED|ls.TRANSFER_DST,jo.RGBA8,this.textImg.width,this.textImg.height)),this.device.copyTexImagesToTexture([this.textImg],this.textTexture,[this.textRegion]),this.textMaterial=new sm,this.textMaterial.initialize({effectName:"util/splash-screen"});var n=this.textMaterial.passes[0],r=n.getBinding("mainTexture");n.bindTexture(r,this.textTexture),this.textShader=pf.get(n.getShaderVariant()),mf.get(bf.get(n.handle,hf.DESCRIPTOR_SET)).update();var a=4*Float32Array.BYTES_PER_ELEMENT,o=4*a;this.textVB=this.device.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,o,a));var s=new Float32Array(16),l=-this.textImg.width/2,c=-this.textImg.height/2;c=this.screenWidth<this.screenHeight?(l=-this.screenWidth/2*.5)/(this.textImg.width/this.textImg.height):(l=-this.screenHeight/2*.5)/(this.textImg.width/this.textImg.height);var u=0;s[u++]=l,s[u++]=c,s[u++]=0,s[u++]=1,s[u++]=-l,s[u++]=c,s[u++]=1,s[u++]=1,s[u++]=l,s[u++]=-c,s[u++]=0,s[u++]=0,s[u++]=-l,s[u++]=-c,s[u++]=1,s[u++]=0;for(var h=0;h<s.length;h+=4)s[h]=s[h]+this.screenWidth/2,s[h+1]=s[h+1]+.1*this.screenHeight;for(var _=this.device.screenSpaceSignY,d=0;d<s.length;d+=4)s[d]=s[d]/this.screenWidth*2-1,s[d+1]=(s[d+1]/this.screenHeight*2-1)*_;this.textVB.update(s);var f=Uint16Array.BYTES_PER_ELEMENT,p=6*f;this.textIB=this.device.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,p,f));var m=new Uint16Array(6);m[0]=0,m[1]=1,m[2]=2,m[3]=1,m[4]=3,m[5]=2,this.textIB.update(m);var v=[new al("a_position",jo.RG32F),new al("a_texCoord",jo.RG32F)],g=new ol(v,[this.textVB],this.textIB);this.textAssmebler=this.device.createInputAssembler(g)}},{key:"initCMD",value:function(){var e=this.device;this.renderArea=new Es(0,0,e.width,e.height),this.framebuffer=this.root.mainWindow.framebuffer,this.cmdBuff=e.commandBuffer}},{key:"initIA",value:function(){var e=this.device,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t;this.vertexBuffers=e.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,i,t));var n=new Float32Array(16),r=-this.image.width/2,a=-this.image.height/2;a=this.screenWidth<this.screenHeight?(r=-this.screenWidth/2*this.setting.displayRatio)/(this.image.width/this.image.height):(r=-this.screenHeight/2*this.setting.displayRatio)/(this.image.width/this.image.height);var o=0;n[o++]=r,n[o++]=a,n[o++]=0,n[o++]=1,n[o++]=-r,n[o++]=a,n[o++]=1,n[o++]=1,n[o++]=r,n[o++]=-a,n[o++]=0,n[o++]=0,n[o++]=-r,n[o++]=-a,n[o++]=1,n[o++]=0;for(var s=0;s<n.length;s+=4)n[s]=n[s]+this.screenWidth/2,n[s+1]=n[s+1]+this.screenHeight/2;for(var l=e.screenSpaceSignY,c=0;c<n.length;c+=4)n[c]=n[c]/this.screenWidth*2-1,n[c+1]=(n[c+1]/this.screenHeight*2-1)*l;this.vertexBuffers.update(n);var u=Uint16Array.BYTES_PER_ELEMENT,h=6*u;this.indicesBuffers=e.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,h,u));var _=new Uint16Array(6);_[0]=0,_[1]=1,_[2]=2,_[3]=1,_[4]=3,_[5]=2,this.indicesBuffers.update(_);var d=[new al("a_position",jo.RG32F),new al("a_texCoord",jo.RG32F)],f=new ol(d,[this.vertexBuffers],this.indicesBuffers);this.assmebler=e.createInputAssembler(f)}},{key:"initPSO",value:function(){var e=this.device;this.material=new sm,this.material.initialize({effectName:"util/splash-screen"});var t=new Sl;t.addressU=os.CLAMP,t.addressV=os.CLAMP,this.sampler=e.createSampler(t),this.texture=e.createTexture(new Il(ss.TEX2D,ls.SAMPLED|ls.TRANSFER_DST,jo.RGBA8,this.image.width,this.image.height));var i=this.material.passes[0],n=i.getBinding("mainTexture");i.bindTexture(n,this.texture),this.shader=pf.get(i.getShaderVariant());var r=mf.get(bf.get(i.handle,hf.DESCRIPTOR_SET));r.bindSampler(n,this.sampler),r.update(),this.region=new Ms,this.region.texExtent.width=this.image.width,this.region.texExtent.height=this.image.height,this.region.texExtent.depth=1,e.copyTexImagesToTexture([this.image],this.texture,[this.region])}},{key:"destroy",value:function(){this.callBack=null,this.clearColors=null,this.device=null,this.image=null,this.framebuffer=null,this.renderArea=null,this.region=null,this.cmdBuff=null,this.shader=null,this.material.destroy(),this.material=null,this.texture.destroy(),this.texture=null,this.assmebler.destroy(),this.assmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler.destroy(),this.sampler=null,this.setting.displayWatermark&&this.textImg&&(this.textImg=null,this.textRegion=null,this.textShader=null,this.textMaterial.destroy(),this.textMaterial=null,this.textTexture.destroy(),this.textTexture=null,this.textAssmebler.destroy(),this.textAssmebler=null,this.textVB.destroy(),this.textVB=null,this.textIB.destroy(),this.textIB=null),this.setting=null,e._ins=null}},{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return null==e._ins&&(e._ins=new e),e._ins}}]),e}();oH._ins=void 0,E.internal.SplashScreen=oH;var sH={};ka(sH,"vmath",[{name:"vec2",newName:"Vec2",target:ro,targetName:"math"},{name:"vec3",newName:"Vec3",target:ro,targetName:"math"},{name:"vec4",newName:"Vec4",target:ro,targetName:"math"},{name:"quat",newName:"Quat",target:ro,targetName:"math"},{name:"mat3",newName:"Mat3",target:ro,targetName:"math"},{name:"mat4",newName:"Mat4",target:ro,targetName:"math"},{name:"color4",newName:"Color",target:ro,targetName:"math"},{name:"rect",newName:"Rect",target:ro,targetName:"math"},{name:"approx",newName:"approx",target:ro,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:ro,targetName:"math"},{name:"equals",newName:"equals",target:ro,targetName:"math"},{name:"clamp",newName:"clamp",target:ro,targetName:"math"},{name:"clamp01",newName:"clamp01",target:ro,targetName:"math"},{name:"lerp",newName:"lerp",target:ro,targetName:"math"},{name:"toRadian",newName:"toRadian",target:ro,targetName:"math"},{name:"toDegree",newName:"toDegree",target:ro,targetName:"math"},{name:"random",newName:"random",target:ro,targetName:"math"},{name:"randomRange",newName:"randomRange",target:ro,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:ro,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:ro,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:ro,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:ro,targetName:"math"},{name:"repeat",newName:"repeat",target:ro,targetName:"math"},{name:"pingPong",newName:"pingPong",target:ro,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:ro,targetName:"math"}]),E.vmath=sH,ka(FD.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:FD,targetName:"Scheduler"}]),ka(dm.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:dm,targetName:"EventTouch"}]),ka(E,"cc",[{name:"GFXDynamicState",newName:"GFXDynamicStateFlagBit"},{name:"GFXBindingType",newName:"GFXDescriptorType"},{name:"GFXBindingLayout",newName:"GFXDescriptorSet"}]),Da(Zs.prototype,"GFXCommandBuffer.prototype",[{name:"bindBindingLayout",suggest:"Use `bindDescriptorSet` instead"}]),ka(Yg.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),Da(Yg.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),E.math=ro,E.geometry=fu;var lH,cH,uH,hH,_H,dH,fH,pH,mH,vH=e("NodePool",function(){function e(t){i(this,e),this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}return r(e,[{key:"size",value:function(){return this._pool.length}},{key:"clear",value:function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0}},{key:"put",value:function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}}},{key:"get",value:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];var n=this._pool.length-1;if(n<0)return null;var r=this._pool[n];this._pool.length=n;var a=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return a&&a.reuse&&a.reuse(arguments),r}}]),e}());E.NodePool=vH,function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(mH||(mH={})),nt(mH);var gH=e("Primitive",(lH=ii("cc.Primitive"),cH=Li(mH),lH((pH=fH=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:mH.BOX;return i(this,t),x(e=u(this,s(t).call(this)),"type",_H,c(e)),x(e,"info",dH,c(e)),e.type=n,e}return o(t,e),r(t,[{key:"onLoaded",value:function(){uT(FT[mH[this.type].toLowerCase()](this.info),this)}}]),t}($_),fH.PrimitiveType=mH,_H=S((hH=pH).prototype,"type",[cH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mH.BOX}}),dH=S(hH.prototype,"info",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),uH=hH))||uH));E.Primitive=gH,E.renderer=XA,E.primitives=FT;var yH,xH=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuDescriptorSet=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,i=t.bindings,n=t.descriptorCount,r=t.descriptorIndices;this._buffers=Array(n).fill(null),this._textures=Array(n).fill(null),this._samplers=Array(n).fill(null);var a=[];this._gpuDescriptorSet={gpuDescriptors:a,descriptorIndices:r};for(var o=0;o<i.length;++o)for(var s=i[o],l=0;l<s.count;l++)a.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null});return!0}},{key:"destroy",value:function(){this._layout=null,this._gpuDescriptorSet=null}},{key:"update",value:function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&kl){var i=this._buffers[t];i&&(e[t].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else e[t].type&Dl&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}},{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(Ll);function SH(e,t){switch(e){case jo.R8:return t.UNSIGNED_BYTE;case jo.R8SN:return t.BYTE;case jo.R8UI:return t.UNSIGNED_BYTE;case jo.R8I:return t.BYTE;case jo.R16F:return yH.HALF_FLOAT_OES;case jo.R16UI:return t.UNSIGNED_SHORT;case jo.R16I:return t.SHORT;case jo.R32F:return t.FLOAT;case jo.R32UI:return t.UNSIGNED_INT;case jo.R32I:return t.INT;case jo.RG8:return t.UNSIGNED_BYTE;case jo.RG8SN:return t.BYTE;case jo.RG8UI:return t.UNSIGNED_BYTE;case jo.RG8I:return t.BYTE;case jo.RG16F:return yH.HALF_FLOAT_OES;case jo.RG16UI:return t.UNSIGNED_SHORT;case jo.RG16I:return t.SHORT;case jo.RG32F:return t.FLOAT;case jo.RG32UI:return t.UNSIGNED_INT;case jo.RG32I:return t.INT;case jo.RGB8:case jo.SRGB8:return t.UNSIGNED_BYTE;case jo.RGB8SN:return t.BYTE;case jo.RGB8UI:return t.UNSIGNED_BYTE;case jo.RGB8I:return t.BYTE;case jo.RGB16F:return yH.HALF_FLOAT_OES;case jo.RGB16UI:return t.UNSIGNED_SHORT;case jo.RGB16I:return t.SHORT;case jo.RGB32F:return t.FLOAT;case jo.RGB32UI:return t.UNSIGNED_INT;case jo.RGB32I:return t.INT;case jo.BGRA8:case jo.RGBA8:case jo.SRGB8_A8:return t.UNSIGNED_BYTE;case jo.RGBA8SN:return t.BYTE;case jo.RGBA8UI:return t.UNSIGNED_BYTE;case jo.RGBA8I:return t.BYTE;case jo.RGBA16F:return yH.HALF_FLOAT_OES;case jo.RGBA16UI:return t.UNSIGNED_SHORT;case jo.RGBA16I:return t.SHORT;case jo.RGBA32F:return t.FLOAT;case jo.RGBA32UI:return t.UNSIGNED_INT;case jo.RGBA32I:return t.INT;case jo.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case jo.R11G11B10F:return t.FLOAT;case jo.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case jo.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case jo.RGB10A2:return t.UNSIGNED_BYTE;case jo.RGB10A2UI:return t.UNSIGNED_INT;case jo.RGB9E5:return t.UNSIGNED_BYTE;case jo.D16:return t.UNSIGNED_SHORT;case jo.D16S8:return yH.UNSIGNED_INT_24_8_WEBGL;case jo.D24:return t.UNSIGNED_INT;case jo.D24S8:return yH.UNSIGNED_INT_24_8_WEBGL;case jo.D32F:return t.UNSIGNED_INT;case jo.D32F_S8:return yH.UNSIGNED_INT_24_8_WEBGL;case jo.BC1:case jo.BC1_SRGB:case jo.BC2:case jo.BC2_SRGB:case jo.BC3:case jo.BC3_SRGB:case jo.BC4:return t.UNSIGNED_BYTE;case jo.BC4_SNORM:return t.BYTE;case jo.BC5:return t.UNSIGNED_BYTE;case jo.BC5_SNORM:return t.BYTE;case jo.BC6H_SF16:case jo.BC6H_UF16:return t.FLOAT;case jo.BC7:case jo.BC7_SRGB:case jo.ETC_RGB8:case jo.ETC2_RGB8:case jo.ETC2_SRGB8:case jo.ETC2_RGB8_A1:case jo.ETC2_SRGB8_A1:case jo.ETC2_RGB8:case jo.ETC2_SRGB8:case jo.EAC_R11:return t.UNSIGNED_BYTE;case jo.EAC_R11SN:return t.BYTE;case jo.EAC_RG11:return t.UNSIGNED_BYTE;case jo.EAC_RG11SN:return t.BYTE;case jo.PVRTC_RGB2:case jo.PVRTC_RGBA2:case jo.PVRTC_RGB4:case jo.PVRTC_RGBA4:case jo.PVRTC2_2BPP:case jo.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case jo.ASTC_RGBA_4x4:case jo.ASTC_RGBA_5x4:case jo.ASTC_RGBA_5x5:case jo.ASTC_RGBA_6x5:case jo.ASTC_RGBA_6x6:case jo.ASTC_RGBA_8x5:case jo.ASTC_RGBA_8x6:case jo.ASTC_RGBA_8x8:case jo.ASTC_RGBA_10x5:case jo.ASTC_RGBA_10x6:case jo.ASTC_RGBA_10x8:case jo.ASTC_RGBA_10x10:case jo.ASTC_RGBA_12x10:case jo.ASTC_RGBA_12x12:case jo.ASTC_SRGBA_4x4:case jo.ASTC_SRGBA_5x4:case jo.ASTC_SRGBA_5x5:case jo.ASTC_SRGBA_6x5:case jo.ASTC_SRGBA_6x6:case jo.ASTC_SRGBA_8x5:case jo.ASTC_SRGBA_8x6:case jo.ASTC_SRGBA_8x8:case jo.ASTC_SRGBA_10x5:case jo.ASTC_SRGBA_10x6:case jo.ASTC_SRGBA_10x8:case jo.ASTC_SRGBA_10x10:case jo.ASTC_SRGBA_12x10:case jo.ASTC_SRGBA_12x12:default:return t.UNSIGNED_BYTE}}function TH(e,t){switch(e){case jo.A8:return t.ALPHA;case jo.L8:return t.LUMINANCE;case jo.LA8:return t.LUMINANCE_ALPHA;case jo.RGB8:case jo.RGB16F:case jo.RGB32F:return t.RGB;case jo.BGRA8:case jo.RGBA8:case jo.RGBA16F:case jo.RGBA32F:return t.RGBA;case jo.R5G6B5:return t.RGB565;case jo.RGB5A1:return t.RGB5_A1;case jo.RGBA4:return t.RGBA4;case jo.D16:return t.DEPTH_COMPONENT;case jo.D16S8:return t.DEPTH_STENCIL;case jo.D24:return t.DEPTH_COMPONENT;case jo.D24S8:return t.DEPTH_STENCIL;case jo.D32F:return t.DEPTH_COMPONENT;case jo.D32F_S8:return t.DEPTH_STENCIL;case jo.BC1:return yH.COMPRESSED_RGB_S3TC_DXT1_EXT;case jo.BC1_ALPHA:return yH.COMPRESSED_RGBA_S3TC_DXT1_EXT;case jo.BC1_SRGB:return yH.COMPRESSED_SRGB_S3TC_DXT1_EXT;case jo.BC1_SRGB_ALPHA:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case jo.BC2:return yH.COMPRESSED_RGBA_S3TC_DXT3_EXT;case jo.BC2_SRGB:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case jo.BC3:return yH.COMPRESSED_RGBA_S3TC_DXT5_EXT;case jo.BC3_SRGB:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case jo.ETC_RGB8:return yH.COMPRESSED_RGB_ETC1_WEBGL;case jo.ETC2_RGB8:return yH.COMPRESSED_RGB8_ETC2;case jo.ETC2_SRGB8:return yH.COMPRESSED_SRGB8_ETC2;case jo.ETC2_RGB8_A1:return yH.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jo.ETC2_SRGB8_A1:return yH.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jo.ETC2_RGBA8:return yH.COMPRESSED_RGBA8_ETC2_EAC;case jo.ETC2_SRGB8_A8:return yH.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case jo.EAC_R11:return yH.COMPRESSED_R11_EAC;case jo.EAC_R11SN:return yH.COMPRESSED_SIGNED_R11_EAC;case jo.EAC_RG11:return yH.COMPRESSED_RG11_EAC;case jo.EAC_RG11SN:return yH.COMPRESSED_SIGNED_RG11_EAC;case jo.PVRTC_RGB2:return yH.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case jo.PVRTC_RGBA2:return yH.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case jo.PVRTC_RGB4:return yH.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case jo.PVRTC_RGBA4:return yH.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case jo.ASTC_RGBA_4x4:return yH.COMPRESSED_RGBA_ASTC_4x4_KHR;case jo.ASTC_RGBA_5x4:return yH.COMPRESSED_RGBA_ASTC_5x4_KHR;case jo.ASTC_RGBA_5x5:return yH.COMPRESSED_RGBA_ASTC_5x5_KHR;case jo.ASTC_RGBA_6x5:return yH.COMPRESSED_RGBA_ASTC_6x5_KHR;case jo.ASTC_RGBA_6x6:return yH.COMPRESSED_RGBA_ASTC_6x6_KHR;case jo.ASTC_RGBA_8x5:return yH.COMPRESSED_RGBA_ASTC_8x5_KHR;case jo.ASTC_RGBA_8x6:return yH.COMPRESSED_RGBA_ASTC_8x6_KHR;case jo.ASTC_RGBA_8x8:return yH.COMPRESSED_RGBA_ASTC_8x8_KHR;case jo.ASTC_RGBA_10x5:return yH.COMPRESSED_RGBA_ASTC_10x5_KHR;case jo.ASTC_RGBA_10x6:return yH.COMPRESSED_RGBA_ASTC_10x6_KHR;case jo.ASTC_RGBA_10x8:return yH.COMPRESSED_RGBA_ASTC_10x8_KHR;case jo.ASTC_RGBA_10x10:return yH.COMPRESSED_RGBA_ASTC_10x10_KHR;case jo.ASTC_RGBA_12x10:return yH.COMPRESSED_RGBA_ASTC_12x10_KHR;case jo.ASTC_RGBA_12x12:return yH.COMPRESSED_RGBA_ASTC_12x12_KHR;case jo.ASTC_SRGBA_4x4:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case jo.ASTC_SRGBA_5x4:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case jo.ASTC_SRGBA_5x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case jo.ASTC_SRGBA_6x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case jo.ASTC_SRGBA_6x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case jo.ASTC_SRGBA_8x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case jo.ASTC_SRGBA_8x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case jo.ASTC_SRGBA_8x8:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case jo.ASTC_SRGBA_10x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case jo.ASTC_SRGBA_10x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case jo.ASTC_SRGBA_10x8:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case jo.ASTC_SRGBA_10x10:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case jo.ASTC_SRGBA_12x10:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case jo.ASTC_SRGBA_12x12:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function EH(e,t){switch(e){case jo.A8:return t.ALPHA;case jo.L8:return t.LUMINANCE;case jo.LA8:return t.LUMINANCE_ALPHA;case jo.RGB8:case jo.RGB16F:case jo.RGB32F:return t.RGB;case jo.BGRA8:case jo.RGBA8:case jo.RGBA16F:case jo.RGBA32F:return t.RGBA;case jo.R5G6B5:return t.RGB;case jo.RGB5A1:case jo.RGBA4:return t.RGBA;case jo.D16:return t.DEPTH_COMPONENT;case jo.D16S8:return t.DEPTH_STENCIL;case jo.D24:return t.DEPTH_COMPONENT;case jo.D24S8:return t.DEPTH_STENCIL;case jo.D32F:return t.DEPTH_COMPONENT;case jo.D32F_S8:return t.DEPTH_STENCIL;case jo.BC1:return yH.COMPRESSED_RGB_S3TC_DXT1_EXT;case jo.BC1_ALPHA:return yH.COMPRESSED_RGBA_S3TC_DXT1_EXT;case jo.BC1_SRGB:return yH.COMPRESSED_SRGB_S3TC_DXT1_EXT;case jo.BC1_SRGB_ALPHA:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case jo.BC2:return yH.COMPRESSED_RGBA_S3TC_DXT3_EXT;case jo.BC2_SRGB:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case jo.BC3:return yH.COMPRESSED_RGBA_S3TC_DXT5_EXT;case jo.BC3_SRGB:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case jo.ETC_RGB8:return yH.COMPRESSED_RGB_ETC1_WEBGL;case jo.ETC2_RGB8:return yH.COMPRESSED_RGB8_ETC2;case jo.ETC2_SRGB8:return yH.COMPRESSED_SRGB8_ETC2;case jo.ETC2_RGB8_A1:return yH.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jo.ETC2_SRGB8_A1:return yH.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jo.ETC2_RGBA8:return yH.COMPRESSED_RGBA8_ETC2_EAC;case jo.ETC2_SRGB8_A8:return yH.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case jo.EAC_R11:return yH.COMPRESSED_R11_EAC;case jo.EAC_R11SN:return yH.COMPRESSED_SIGNED_R11_EAC;case jo.EAC_RG11:return yH.COMPRESSED_RG11_EAC;case jo.EAC_RG11SN:return yH.COMPRESSED_SIGNED_RG11_EAC;case jo.PVRTC_RGB2:return yH.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case jo.PVRTC_RGBA2:return yH.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case jo.PVRTC_RGB4:return yH.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case jo.PVRTC_RGBA4:return yH.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case jo.ASTC_RGBA_4x4:return yH.COMPRESSED_RGBA_ASTC_4x4_KHR;case jo.ASTC_RGBA_5x4:return yH.COMPRESSED_RGBA_ASTC_5x4_KHR;case jo.ASTC_RGBA_5x5:return yH.COMPRESSED_RGBA_ASTC_5x5_KHR;case jo.ASTC_RGBA_6x5:return yH.COMPRESSED_RGBA_ASTC_6x5_KHR;case jo.ASTC_RGBA_6x6:return yH.COMPRESSED_RGBA_ASTC_6x6_KHR;case jo.ASTC_RGBA_8x5:return yH.COMPRESSED_RGBA_ASTC_8x5_KHR;case jo.ASTC_RGBA_8x6:return yH.COMPRESSED_RGBA_ASTC_8x6_KHR;case jo.ASTC_RGBA_8x8:return yH.COMPRESSED_RGBA_ASTC_8x8_KHR;case jo.ASTC_RGBA_10x5:return yH.COMPRESSED_RGBA_ASTC_10x5_KHR;case jo.ASTC_RGBA_10x6:return yH.COMPRESSED_RGBA_ASTC_10x6_KHR;case jo.ASTC_RGBA_10x8:return yH.COMPRESSED_RGBA_ASTC_10x8_KHR;case jo.ASTC_RGBA_10x10:return yH.COMPRESSED_RGBA_ASTC_10x10_KHR;case jo.ASTC_RGBA_12x10:return yH.COMPRESSED_RGBA_ASTC_12x10_KHR;case jo.ASTC_RGBA_12x12:return yH.COMPRESSED_RGBA_ASTC_12x12_KHR;case jo.ASTC_SRGBA_4x4:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case jo.ASTC_SRGBA_5x4:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case jo.ASTC_SRGBA_5x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case jo.ASTC_SRGBA_6x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case jo.ASTC_SRGBA_6x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case jo.ASTC_SRGBA_8x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case jo.ASTC_SRGBA_8x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case jo.ASTC_SRGBA_8x8:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case jo.ASTC_SRGBA_10x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case jo.ASTC_SRGBA_10x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case jo.ASTC_SRGBA_10x8:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case jo.ASTC_SRGBA_10x10:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case jo.ASTC_SRGBA_12x10:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case jo.ASTC_SRGBA_12x12:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function bH(e,t){switch(e){case Wo.BOOL:return t.BOOL;case Wo.BOOL2:return t.BOOL_VEC2;case Wo.BOOL3:return t.BOOL_VEC3;case Wo.BOOL4:return t.BOOL_VEC4;case Wo.INT:return t.INT;case Wo.INT2:return t.INT_VEC2;case Wo.INT3:return t.INT_VEC3;case Wo.INT4:return t.INT_VEC4;case Wo.UINT:return t.UNSIGNED_INT;case Wo.FLOAT:return t.FLOAT;case Wo.FLOAT2:return t.FLOAT_VEC2;case Wo.FLOAT3:return t.FLOAT_VEC3;case Wo.FLOAT4:return t.FLOAT_VEC4;case Wo.MAT2:return t.FLOAT_MAT2;case Wo.MAT3:return t.FLOAT_MAT3;case Wo.MAT4:return t.FLOAT_MAT4;case Wo.SAMPLER2D:return t.SAMPLER_2D;case Wo.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Wo.UNKNOWN}}function AH(e){switch(e){case Wo.BOOL:case Wo.BOOL2:case Wo.BOOL3:case Wo.BOOL4:case Wo.INT:case Wo.INT2:case Wo.INT3:case Wo.INT4:case Wo.UINT:return Int32Array;case Wo.FLOAT:case Wo.FLOAT2:case Wo.FLOAT3:case Wo.FLOAT4:case Wo.MAT2:case Wo.MAT3:case Wo.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function CH(e,t){switch(e){case t.BOOL:return Wo.BOOL;case t.BOOL_VEC2:return Wo.BOOL2;case t.BOOL_VEC3:return Wo.BOOL3;case t.BOOL_VEC4:return Wo.BOOL4;case t.INT:return Wo.INT;case t.INT_VEC2:return Wo.INT2;case t.INT_VEC3:return Wo.INT3;case t.INT_VEC4:return Wo.INT4;case t.UNSIGNED_INT:return Wo.UINT;case t.FLOAT:return Wo.FLOAT;case t.FLOAT_VEC2:return Wo.FLOAT2;case t.FLOAT_VEC3:return Wo.FLOAT3;case t.FLOAT_VEC4:return Wo.FLOAT4;case t.FLOAT_MAT2:return Wo.MAT2;case t.FLOAT_MAT3:return Wo.MAT3;case t.FLOAT_MAT4:return Wo.MAT4;case t.SAMPLER_2D:return Wo.SAMPLER2D;case t.SAMPLER_CUBE:return Wo.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),Wo.UNKNOWN}}function wH(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function RH(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(yH||(yH={}));var IH,OH=[512,513,514,515,516,517,518,519],MH=[0,7680,7681,7682,7683,5386,34055,34056],PH=[32774,32778,32779,32774,32774],kH=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(IH||(IH={}));var DH=function e(t){i(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},BH=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,IH.BEGIN_RENDER_PASS))).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new Es,e.clearFlag=Ts.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return o(t,e),r(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),t}(DH),LH=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,IH.BIND_STATES))).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=[],e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return o(t,e),r(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(DH),NH=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,IH.DRAW))).drawInfo=new Vs,e}return o(t,e),r(t,[{key:"clear",value:function(){}}]),t}(DH),FH=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,IH.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return o(t,e),r(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(DH),zH=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,IH.COPY_BUFFER_TO_TEXTURE))).gpuTexture=null,e.buffers=[],e.regions=[],e}return o(t,e),r(t,[{key:"clear",value:function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}]),t}(DH),UH=function(){function e(){i(this,e),this.cmds=new Gi(1),this.beginRenderPassCmds=new Gi(1),this.bindStatesCmds=new Gi(1),this.drawCmds=new Gi(1),this.updateBufferCmds=new Gi(1),this.copyBufferToTextureCmds=new Gi(1)}return r(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function GH(e,t,i,n,r){if(t.usage&qo.UNIFORM)ArrayBuffer.isView(i)?t.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&qo.INDIRECT)t.indirects.length=n,Array.prototype.push.apply(t.indirects,i.drawInfos);else{var a=i,o=e.gl,s=e.stateCache;switch(t.glTarget){case o.ARRAY_BUFFER:e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=HH.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case o.ELEMENT_ARRAY_BUFFER:e.useVAO&&s.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=HH.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}r===a.byteLength?o.bufferSubData(t.glTarget,n,a):o.bufferSubData(t.glTarget,n,a.slice(0,r))}}var HH={gpuPipelineState:null,gpuInputAssembler:null,reverseCW:!1,glPrimitive:0};function VH(e,t,i,n,r,a,o){var s=e.gl,l=e.stateCache,c=0;if(i&&t){if(l.glFramebuffer!==i.glFramebuffer){s.bindFramebuffer(s.FRAMEBUFFER,i.glFramebuffer),l.glFramebuffer=i.glFramebuffer;var u=!!i.glFramebuffer;if(u!==HH.reverseCW){HH.reverseCW=u;var h=!e.stateCache.rs.isFrontFaceCCW;s.frontFace(h?s.CCW:s.CW),e.stateCache.rs.isFrontFaceCCW=h}}l.viewport.left===n.x&&l.viewport.top===n.y&&l.viewport.width===n.width&&l.viewport.height===n.height||(s.viewport(n.x,n.y,n.width,n.height),l.viewport.left=n.x,l.viewport.top=n.y,l.viewport.width=n.width,l.viewport.height=n.height),l.scissorRect.x===n.x&&l.scissorRect.y===n.y&&l.scissorRect.width===n.width&&l.scissorRect.height===n.height||(s.scissor(n.x,n.y,n.width,n.height),l.scissorRect.x=n.x,l.scissorRect.y=n.y,l.scissorRect.width=n.width,l.scissorRect.height=n.height);var _=r.length;e.WEBGL_draw_buffers||(_=1);for(var d=0;d<_;++d){var f=t.colorAttachments[d];if(f.format!==jo.UNKNOWN)switch(f.loadOp){case fs.LOAD:break;case fs.CLEAR:l.bs.targets[0].blendColorMask!==rs.ALL&&s.colorMask(!0,!0,!0,!0);var p=r[0];s.clearColor(p.x,p.y,p.z,p.w),c|=s.COLOR_BUFFER_BIT;break;case fs.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==jo.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case fs.LOAD:break;case fs.CLEAR:l.dss.depthWrite||s.depthMask(!0),s.clearDepth(a),c|=s.DEPTH_BUFFER_BIT;break;case fs.DISCARD:}if(Ds[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case fs.LOAD:break;case fs.CLEAR:l.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),l.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(o),c|=s.STENCIL_BUFFER_BIT;break;case fs.DISCARD:}}if(c&&s.clear(c),c&s.COLOR_BUFFER_BIT){var m=l.bs.targets[0].blendColorMask;if(m!==rs.ALL){var v=(m&rs.R)!==rs.NONE,g=(m&rs.G)!==rs.NONE,y=(m&rs.B)!==rs.NONE,x=(m&rs.A)!==rs.NONE;s.colorMask(v,g,y,x)}}c&s.DEPTH_BUFFER_BIT&&!l.dss.depthWrite&&s.depthMask(!1),c&s.STENCIL_BUFFER_BIT&&(l.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),l.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function WH(e,t,i,n,r,a,o,s,l,c,u,h,_){var d,f,p,m=e.gl,v=e.stateCache,g=t&&t.gpuShader,y=!1;if(t&&HH.gpuPipelineState!==t){if(HH.gpuPipelineState=t,HH.glPrimitive=t.glPrimitive,t.gpuShader){var x=t.gpuShader.glProgram;v.glProgram!==x&&(m.useProgram(x),v.glProgram=x,y=!0)}var S=t.rs;if(S){if(v.rs.cullMode!==S.cullMode){switch(S.cullMode){case $o.NONE:m.disable(m.CULL_FACE);break;case $o.FRONT:m.enable(m.CULL_FACE),m.cullFace(m.FRONT);break;case $o.BACK:m.enable(m.CULL_FACE),m.cullFace(m.BACK)}v.rs.cullMode=S.cullMode}var T=HH.reverseCW?!S.isFrontFaceCCW:S.isFrontFaceCCW;v.rs.isFrontFaceCCW!==T&&(m.frontFace(T?m.CCW:m.CW),v.rs.isFrontFaceCCW=T),v.rs.depthBias===S.depthBias&&v.rs.depthBiasSlop===S.depthBiasSlop||(m.polygonOffset(S.depthBias,S.depthBiasSlop),v.rs.depthBias=S.depthBias,v.rs.depthBiasSlop=S.depthBiasSlop),v.rs.lineWidth!==S.lineWidth&&(m.lineWidth(S.lineWidth),v.rs.lineWidth=S.lineWidth)}var E=t.dss;E&&(v.dss.depthTest!==E.depthTest&&(E.depthTest?m.enable(m.DEPTH_TEST):m.disable(m.DEPTH_TEST),v.dss.depthTest=E.depthTest),v.dss.depthWrite!==E.depthWrite&&(m.depthMask(E.depthWrite),v.dss.depthWrite=E.depthWrite),v.dss.depthFunc!==E.depthFunc&&(m.depthFunc(OH[E.depthFunc]),v.dss.depthFunc=E.depthFunc),v.dss.stencilTestFront===E.stencilTestFront&&v.dss.stencilTestBack===E.stencilTestBack||(E.stencilTestFront||E.stencilTestBack?m.enable(m.STENCIL_TEST):m.disable(m.STENCIL_TEST),v.dss.stencilTestFront=E.stencilTestFront,v.dss.stencilTestBack=E.stencilTestBack),v.dss.stencilFuncFront===E.stencilFuncFront&&v.dss.stencilRefFront===E.stencilRefFront&&v.dss.stencilReadMaskFront===E.stencilReadMaskFront||(m.stencilFuncSeparate(m.FRONT,OH[E.stencilFuncFront],E.stencilRefFront,E.stencilReadMaskFront),v.dss.stencilFuncFront=E.stencilFuncFront,v.dss.stencilRefFront=E.stencilRefFront,v.dss.stencilReadMaskFront=E.stencilReadMaskFront),v.dss.stencilFailOpFront===E.stencilFailOpFront&&v.dss.stencilZFailOpFront===E.stencilZFailOpFront&&v.dss.stencilPassOpFront===E.stencilPassOpFront||(m.stencilOpSeparate(m.FRONT,MH[E.stencilFailOpFront],MH[E.stencilZFailOpFront],MH[E.stencilPassOpFront]),v.dss.stencilFailOpFront=E.stencilFailOpFront,v.dss.stencilZFailOpFront=E.stencilZFailOpFront,v.dss.stencilPassOpFront=E.stencilPassOpFront),v.dss.stencilWriteMaskFront!==E.stencilWriteMaskFront&&(m.stencilMaskSeparate(m.FRONT,E.stencilWriteMaskFront),v.dss.stencilWriteMaskFront=E.stencilWriteMaskFront),v.dss.stencilFuncBack===E.stencilFuncBack&&v.dss.stencilRefBack===E.stencilRefBack&&v.dss.stencilReadMaskBack===E.stencilReadMaskBack||(m.stencilFuncSeparate(m.BACK,OH[E.stencilFuncBack],E.stencilRefBack,E.stencilReadMaskBack),v.dss.stencilFuncBack=E.stencilFuncBack,v.dss.stencilRefBack=E.stencilRefBack,v.dss.stencilReadMaskBack=E.stencilReadMaskBack),v.dss.stencilFailOpBack===E.stencilFailOpBack&&v.dss.stencilZFailOpBack===E.stencilZFailOpBack&&v.dss.stencilPassOpBack===E.stencilPassOpBack||(m.stencilOpSeparate(m.BACK,MH[E.stencilFailOpBack],MH[E.stencilZFailOpBack],MH[E.stencilPassOpBack]),v.dss.stencilFailOpBack=E.stencilFailOpBack,v.dss.stencilZFailOpBack=E.stencilZFailOpBack,v.dss.stencilPassOpBack=E.stencilPassOpBack),v.dss.stencilWriteMaskBack!==E.stencilWriteMaskBack&&(m.stencilMaskSeparate(m.BACK,E.stencilWriteMaskBack),v.dss.stencilWriteMaskBack=E.stencilWriteMaskBack));var b=t.bs;if(b){v.bs.isA2C!==b.isA2C&&(b.isA2C?m.enable(m.SAMPLE_ALPHA_TO_COVERAGE):m.disable(m.SAMPLE_ALPHA_TO_COVERAGE),v.bs.isA2C=b.isA2C),v.bs.blendColor.x===b.blendColor.x&&v.bs.blendColor.y===b.blendColor.y&&v.bs.blendColor.z===b.blendColor.z&&v.bs.blendColor.w===b.blendColor.w||(m.blendColor(b.blendColor.x,b.blendColor.y,b.blendColor.z,b.blendColor.w),v.bs.blendColor.x=b.blendColor.x,v.bs.blendColor.y=b.blendColor.y,v.bs.blendColor.z=b.blendColor.z,v.bs.blendColor.w=b.blendColor.w);var A=b.targets[0],C=v.bs.targets[0];C.blend!==A.blend&&(A.blend?m.enable(m.BLEND):m.disable(m.BLEND),C.blend=A.blend),C.blendEq===A.blendEq&&C.blendAlphaEq===A.blendAlphaEq||(m.blendEquationSeparate(PH[A.blendEq],PH[A.blendAlphaEq]),C.blendEq=A.blendEq,C.blendAlphaEq=A.blendAlphaEq),C.blendSrc===A.blendSrc&&C.blendDst===A.blendDst&&C.blendSrcAlpha===A.blendSrcAlpha&&C.blendDstAlpha===A.blendDstAlpha||(m.blendFuncSeparate(kH[A.blendSrc],kH[A.blendDst],kH[A.blendSrcAlpha],kH[A.blendDstAlpha]),C.blendSrc=A.blendSrc,C.blendDst=A.blendDst,C.blendSrcAlpha=A.blendSrcAlpha,C.blendDstAlpha=A.blendDstAlpha),C.blendColorMask!==A.blendColorMask&&(m.colorMask((A.blendColorMask&rs.R)!==rs.NONE,(A.blendColorMask&rs.G)!==rs.NONE,(A.blendColorMask&rs.B)!==rs.NONE,(A.blendColorMask&rs.A)!==rs.NONE),C.blendColorMask=A.blendColorMask)}}if(t&&t.gpuPipelineLayout&&g){for(var w=g.glBlocks.length,R=t.gpuPipelineLayout.dynamicOffsetIndices,I=0;I<w;I++){var O=g.glBlocks[I],M=n[O.set],P=M&&M.gpuDescriptors[O.binding],D=null,B=0;if(P&&P.gpuBuffer){var L=P.gpuBuffer,N=R[O.set],F=N&&N[O.binding];F>=0&&(B=r[F]),"vf32"in L?D=L.vf32:(B+=L.offset,D=L.gpuBuffer.vf32),B>>=2}if(D)for(var z=O.glActiveUniforms.length,U=0;U<z;U++){var G=O.glActiveUniforms[U];switch(G.glType){case m.BOOL:case m.INT:for(var H=0;H<G.array.length;++H){var V=G.begin+B+H;if(D[V]!==G.array[H]){for(var W=H,j=V;W<G.array.length;++W,++j)G.array[W]=D[j];m.uniform1iv(G.glLoc,G.array);break}}break;case m.BOOL_VEC2:case m.INT_VEC2:for(var q=0;q<G.array.length;++q){var X=G.begin+B+q;if(D[X]!==G.array[q]){for(var Y=q,K=X;Y<G.array.length;++Y,++K)G.array[Y]=D[K];m.uniform2iv(G.glLoc,G.array);break}}break;case m.BOOL_VEC3:case m.INT_VEC3:for(var Z=0;Z<G.array.length;++Z){var Q=G.begin+B+Z;if(D[Q]!==G.array[Z]){for(var J=Z,$=Q;J<G.array.length;++J,++$)G.array[J]=D[$];m.uniform3iv(G.glLoc,G.array);break}}break;case m.BOOL_VEC4:case m.INT_VEC4:for(var ee=0;ee<G.array.length;++ee){var te=G.begin+B+ee;if(D[te]!==G.array[ee]){for(var ie=ee,ne=te;ie<G.array.length;++ie,++ne)G.array[ie]=D[ne];m.uniform4iv(G.glLoc,G.array);break}}break;case m.FLOAT:for(var re=0;re<G.array.length;++re){var ae=G.begin+B+re;if(D[ae]!==G.array[re]){for(var oe=re,se=ae;oe<G.array.length;++oe,++se)G.array[oe]=D[se];m.uniform1fv(G.glLoc,G.array);break}}break;case m.FLOAT_VEC2:for(var le=0;le<G.array.length;++le){var ce=G.begin+B+le;if(D[ce]!==G.array[le]){for(var ue=le,he=ce;ue<G.array.length;++ue,++he)G.array[ue]=D[he];m.uniform2fv(G.glLoc,G.array);break}}break;case m.FLOAT_VEC3:for(var _e=0;_e<G.array.length;++_e){var de=G.begin+B+_e;if(D[de]!==G.array[_e]){for(var fe=_e,pe=de;fe<G.array.length;++fe,++pe)G.array[fe]=D[pe];m.uniform3fv(G.glLoc,G.array);break}}break;case m.FLOAT_VEC4:for(var me=0;me<G.array.length;++me){var ve=G.begin+B+me;if(D[ve]!==G.array[me]){for(var ge=me,ye=ve;ge<G.array.length;++ge,++ye)G.array[ge]=D[ye];m.uniform4fv(G.glLoc,G.array);break}}break;case m.FLOAT_MAT2:for(var xe=0;xe<G.array.length;++xe){var Se=G.begin+B+xe;if(D[Se]!==G.array[xe]){for(var Te=xe,Ee=Se;Te<G.array.length;++Te,++Ee)G.array[Te]=D[Ee];m.uniformMatrix2fv(G.glLoc,!1,G.array);break}}break;case m.FLOAT_MAT3:for(var be=0;be<G.array.length;++be){var Ae=G.begin+B+be;if(D[Ae]!==G.array[be]){for(var Ce=be,we=Ae;Ce<G.array.length;++Ce,++we)G.array[Ce]=D[we];m.uniformMatrix3fv(G.glLoc,!1,G.array);break}}break;case m.FLOAT_MAT4:for(var Re=0;Re<G.array.length;++Re){var Ie=G.begin+B+Re;if(D[Ie]!==G.array[Re]){for(var Oe=Re,Me=Ie;Oe<G.array.length;++Oe,++Me)G.array[Oe]=D[Me];m.uniformMatrix4fv(G.glLoc,!1,G.array);break}}}}else k("Buffer binding '".concat(O.name,"' at set ").concat(O.set," binding ").concat(O.binding," is not bounded"))}for(var Pe=g.glSamplers.length,ke=0;ke<Pe;ke++)for(var De=g.glSamplers[ke],Be=n[De.set],Le=Be&&Be.descriptorIndices[De.binding],Ne=Be&&Be.gpuDescriptors[Le],Fe=De.units.length,ze=0;ze<Fe;ze++){var Ue=De.units[ze];if(Ne&&Ne.gpuSampler){if(Ne.gpuTexture&&Ne.gpuTexture.size>0){var Ge=Ne.gpuTexture,He=v.glTexUnits[Ue];He.glTexture!==Ge.glTexture&&(v.texUnit!==Ue&&(m.activeTexture(m.TEXTURE0+Ue),v.texUnit=Ue),Ge.glTexture?m.bindTexture(Ge.glTarget,Ge.glTexture):m.bindTexture(Ge.glTarget,e.nullTex2D.gpuTexture.glTexture),He.glTexture=Ge.glTexture);var Ve=Ne.gpuSampler;Ge.isPowerOf2?(d=Ve.glWrapS,f=Ve.glWrapT):(d=m.CLAMP_TO_EDGE,f=m.CLAMP_TO_EDGE),p=Ge.isPowerOf2?Ge.mipLevel<=1&&(Ve.glMinFilter===m.LINEAR_MIPMAP_NEAREST||Ve.glMinFilter===m.LINEAR_MIPMAP_LINEAR)?m.LINEAR:Ve.glMinFilter:Ve.glMinFilter===m.LINEAR||Ve.glMinFilter===m.LINEAR_MIPMAP_NEAREST||Ve.glMinFilter===m.LINEAR_MIPMAP_LINEAR?m.LINEAR:m.NEAREST,Ge.glWrapS!==d&&(v.texUnit!==Ue&&(m.activeTexture(m.TEXTURE0+Ue),v.texUnit=Ue),m.texParameteri(Ge.glTarget,m.TEXTURE_WRAP_S,d),Ge.glWrapS=d),Ge.glWrapT!==f&&(v.texUnit!==Ue&&(m.activeTexture(m.TEXTURE0+Ue),v.texUnit=Ue),m.texParameteri(Ge.glTarget,m.TEXTURE_WRAP_T,f),Ge.glWrapT=f),Ge.glMinFilter!==p&&(v.texUnit!==Ue&&(m.activeTexture(m.TEXTURE0+Ue),v.texUnit=Ue),m.texParameteri(Ge.glTarget,m.TEXTURE_MIN_FILTER,p),Ge.glMinFilter=p),Ge.glMagFilter!==Ve.glMagFilter&&(v.texUnit!==Ue&&(m.activeTexture(m.TEXTURE0+Ue),v.texUnit=Ue),m.texParameteri(Ge.glTarget,m.TEXTURE_MAG_FILTER,Ve.glMagFilter),Ge.glMagFilter=Ve.glMagFilter)}Ne=Be.gpuDescriptors[++Le]}else k("Sampler binding '".concat(De.name,"' at set ").concat(De.set," binding ").concat(De.binding," index ").concat(ze," is not bounded"))}}if(i&&g&&(y||HH.gpuInputAssembler!==i)){HH.gpuInputAssembler=i;var We=e.ANGLE_instanced_arrays;if(e.useVAO){var je=e.OES_vertex_array_object,qe=i.glVAOs.get(g.glProgram);if(!qe){var Xe;qe=je.createVertexArrayOES(),i.glVAOs.set(g.glProgram,qe),je.bindVertexArrayOES(qe),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null),v.glArrayBuffer=null,v.glElementArrayBuffer=null;for(var Ye=g.glInputs.length,Ke=0;Ke<Ye;Ke++){var Ze=g.glInputs[Ke];Xe=null;for(var Qe=i.glAttribs.length,Je=0;Je<Qe;Je++){var $e=i.glAttribs[Je];if($e.name===Ze.name){Xe=$e;break}}if(Xe){v.glArrayBuffer!==Xe.glBuffer&&(m.bindBuffer(m.ARRAY_BUFFER,Xe.glBuffer),v.glArrayBuffer=Xe.glBuffer);for(var et=0;et<Xe.componentCount;++et){var tt=Ze.glLoc+et,it=Xe.offset+Xe.size*et;m.enableVertexAttribArray(tt),v.glCurrentAttribLocs[tt]=!0,m.vertexAttribPointer(tt,Xe.count,Xe.glType,Xe.isNormalized,Xe.stride,it),We&&We.vertexAttribDivisorANGLE(tt,Xe.isInstanced?1:0)}}}var nt=i.gpuIndexBuffer;nt&&m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,nt.glBuffer),je.bindVertexArrayOES(null),m.bindBuffer(m.ARRAY_BUFFER,null),m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null),v.glArrayBuffer=null,v.glElementArrayBuffer=null}v.glVAO!==qe&&(je.bindVertexArrayOES(qe),v.glVAO=qe)}else{for(var rt=0;rt<e.maxVertexAttributes;++rt)v.glCurrentAttribLocs[rt]=!1;for(var at=g.glInputs.length,ot=0;ot<at;ot++){for(var st=g.glInputs[ot],lt=null,ct=i.glAttribs.length,ut=0;ut<ct;ut++){var ht=i.glAttribs[ut];if(ht.name===st.name){lt=ht;break}}if(lt){v.glArrayBuffer!==lt.glBuffer&&(m.bindBuffer(m.ARRAY_BUFFER,lt.glBuffer),v.glArrayBuffer=lt.glBuffer);for(var _t=0;_t<lt.componentCount;++_t){var dt=st.glLoc+_t,ft=lt.offset+lt.size*_t;!v.glEnabledAttribLocs[dt]&&dt>=0&&(m.enableVertexAttribArray(dt),v.glEnabledAttribLocs[dt]=!0),v.glCurrentAttribLocs[dt]=!0,m.vertexAttribPointer(dt,lt.count,lt.glType,lt.isNormalized,lt.stride,ft),We&&We.vertexAttribDivisorANGLE(dt,lt.isInstanced?1:0)}}}var pt=i.gpuIndexBuffer;pt&&v.glElementArrayBuffer!==pt.glBuffer&&(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,pt.glBuffer),v.glElementArrayBuffer=pt.glBuffer);for(var mt=0;mt<e.maxVertexAttributes;++mt)v.glEnabledAttribLocs[mt]!==v.glCurrentAttribLocs[mt]&&(m.disableVertexAttribArray(mt),v.glEnabledAttribLocs[mt]=!1)}}if(t&&t.dynamicStates.length)for(var vt=t.dynamicStates.length,gt=0;gt<vt;gt++){switch(t.dynamicStates[gt]){case gs.VIEWPORT:a&&(v.viewport.left===a.left&&v.viewport.top===a.top&&v.viewport.width===a.width&&v.viewport.height===a.height||(m.viewport(a.left,a.top,a.width,a.height),v.viewport.left=a.left,v.viewport.top=a.top,v.viewport.width=a.width,v.viewport.height=a.height));break;case gs.SCISSOR:o&&(v.scissorRect.x===o.x&&v.scissorRect.y===o.y&&v.scissorRect.width===o.width&&v.scissorRect.height===o.height||(m.scissor(o.x,o.y,o.width,o.height),v.scissorRect.x=o.x,v.scissorRect.y=o.y,v.scissorRect.width=o.width,v.scissorRect.height=o.height));break;case gs.LINE_WIDTH:s&&v.rs.lineWidth!==s&&(m.lineWidth(s),v.rs.lineWidth=s);break;case gs.DEPTH_BIAS:l&&(v.rs.depthBias===l.constantFactor&&v.rs.depthBiasSlop===l.slopeFactor||(m.polygonOffset(l.constantFactor,l.slopeFactor),v.rs.depthBias=l.constantFactor,v.rs.depthBiasSlop=l.slopeFactor));break;case gs.BLEND_CONSTANTS:v.bs.blendColor.x===c[0]&&v.bs.blendColor.y===c[1]&&v.bs.blendColor.z===c[2]&&v.bs.blendColor.w===c[3]||(m.blendColor(c[0],c[1],c[2],c[3]),v.bs.blendColor.x=c[0],v.bs.blendColor.y=c[1],v.bs.blendColor.z=c[2],v.bs.blendColor.w=c[3]);break;case gs.STENCIL_WRITE_MASK:if(h)switch(h.face){case ys.FRONT:v.dss.stencilWriteMaskFront!==h.writeMask&&(m.stencilMaskSeparate(m.FRONT,h.writeMask),v.dss.stencilWriteMaskFront=h.writeMask);break;case ys.BACK:v.dss.stencilWriteMaskBack!==h.writeMask&&(m.stencilMaskSeparate(m.BACK,h.writeMask),v.dss.stencilWriteMaskBack=h.writeMask);break;case ys.ALL:v.dss.stencilWriteMaskFront===h.writeMask&&v.dss.stencilWriteMaskBack===h.writeMask||(m.stencilMask(h.writeMask),v.dss.stencilWriteMaskFront=h.writeMask,v.dss.stencilWriteMaskBack=h.writeMask)}break;case gs.STENCIL_COMPARE_MASK:if(_)switch(_.face){case ys.FRONT:v.dss.stencilRefFront===_.reference&&v.dss.stencilReadMaskFront===_.compareMask||(m.stencilFuncSeparate(m.FRONT,OH[v.dss.stencilFuncFront],_.reference,_.compareMask),v.dss.stencilRefFront=_.reference,v.dss.stencilReadMaskFront=_.compareMask);break;case ys.BACK:v.dss.stencilRefBack===_.reference&&v.dss.stencilReadMaskBack===_.compareMask||(m.stencilFuncSeparate(m.BACK,OH[v.dss.stencilFuncBack],_.reference,_.compareMask),v.dss.stencilRefBack=_.reference,v.dss.stencilReadMaskBack=_.compareMask);break;case ys.ALL:v.dss.stencilRefFront===_.reference&&v.dss.stencilReadMaskFront===_.compareMask&&v.dss.stencilRefBack===_.reference&&v.dss.stencilReadMaskBack===_.compareMask||(m.stencilFunc(OH[v.dss.stencilFuncBack],_.reference,_.compareMask),v.dss.stencilRefFront=_.reference,v.dss.stencilReadMaskFront=_.compareMask,v.dss.stencilRefBack=_.reference,v.dss.stencilReadMaskBack=_.compareMask)}}}}function jH(e,t){var i=e.gl,n=e.ANGLE_instanced_arrays,r=HH.gpuInputAssembler,a=HH.glPrimitive;if(r)if(r.gpuIndirectBuffer)for(var o=r.gpuIndirectBuffer.indirects.length,s=0;s<o;s++){var l=r.gpuIndirectBuffer.indirects[s],c=r.gpuIndexBuffer;if(l.instanceCount&&n)if(c){if(l.indexCount>0){var u=l.firstIndex*c.stride;n.drawElementsInstancedANGLE(a,l.indexCount,r.glIndexType,u,l.instanceCount)}}else l.vertexCount>0&&n.drawArraysInstancedANGLE(a,l.firstVertex,l.vertexCount,l.instanceCount);else if(c){if(l.indexCount>0){var h=l.firstIndex*c.stride;i.drawElements(a,l.indexCount,r.glIndexType,h)}}else l.vertexCount>0&&i.drawArrays(a,l.firstVertex,l.vertexCount)}else{var _=r.gpuIndexBuffer;if(t.instanceCount&&n)if(_){if(t.indexCount>0){var d=t.firstIndex*_.stride;n.drawElementsInstancedANGLE(a,t.indexCount,r.glIndexType,d,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstancedANGLE(a,t.firstVertex,t.vertexCount,t.instanceCount);else if(_){if(t.indexCount>0){var f=t.firstIndex*_.stride;i.drawElements(a,t.indexCount,r.glIndexType,f)}}else t.vertexCount>0&&i.drawArrays(a,t.firstVertex,t.vertexCount)}}var qH=new Array(IH.COUNT);function XH(e,t){qH.fill(0);for(var i=0;i<t.cmds.length;++i){var n=t.cmds.array[i],r=qH[n]++;switch(n){case IH.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[r];VH(e,a.gpuRenderPass,a.gpuFramebuffer,a.renderArea,a.clearColors,a.clearDepth,a.clearStencil);break;case IH.BIND_STATES:var o=t.bindStatesCmds.array[r];WH(e,o.gpuPipelineState,o.gpuInputAssembler,o.gpuDescriptorSets,o.dynamicOffsets,o.viewport,o.scissor,o.lineWidth,o.depthBias,o.blendConstants,o.depthBounds,o.stencilWriteMask,o.stencilCompareMask);break;case IH.DRAW:jH(e,t.drawCmds.array[r].drawInfo);break;case IH.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];GH(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case IH.COPY_BUFFER_TO_TEXTURE:var l=t.copyBufferToTextureCmds.array[r];YH(e,l.buffers,l.gpuTexture,l.regions)}}}function YH(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var o=0,s=1,l=1,c=0,u=Ds[i.format].isCompressed;switch(i.glTarget){case r.TEXTURE_2D:for(var h=0;h<n.length;h++){var _=n[h];s=_.texExtent.width,l=_.texExtent.height;var d=t[o++];u?i.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,l,i.glFormat,d):i.glInternalFmt===yH.COMPRESSED_RGB_ETC1_WEBGL||e.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,i.glInternalFmt,s,l,0,d):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,l,i.glFormat,d):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,l,i.glFormat,i.glType,d)}break;case r.TEXTURE_CUBE_MAP:for(var f=0;f<n.length;f++){var p=n[f],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(c=p.texSubres.baseArrayLayer;c<m;++c){s=p.texExtent.width,l=p.texExtent.height;var v=t[o++];u?i.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL||i.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,l,i.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,p.texSubres.mipLevel,i.glInternalFmt,s,l,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,l,i.glFormat,i.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&us.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var KH=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuBuffer=null,n._gpuBufferView=null,n._uniformBuffer=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&qo.INDIRECT&&(this._indirectBuffer=new js),this._flags&Yo.BAKUP_BUFFER&&(this._bakcupBuffer=new Uint8Array(this._size),this._device.memoryStatus.bufferSize+=this._size),this._usage&qo.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,vf32:null,indirects:[],glTarget:0,glBuffer:null},e.usage&qo.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&qo.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Xo.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&qo.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=HH.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&qo.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var o=i.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.useVAO&&n.glVAO&&(e.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=HH.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&qo.UNIFORM?(t.glTarget=i.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&qo.INDIRECT||t.usage&qo.TRANSFER_DST||t.usage&qo.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}},{key:"destroy",value:function(){var e,t;this._gpuBuffer&&(e=this._device,(t=this._gpuBuffer).glBuffer&&(e.gl.deleteBuffer(t.glBuffer),t.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null),this._bakcupBuffer=null}},{key:"resize",value:function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;if(t!==e){if(this._size=e,this._count=this._size/this._stride,this._bakcupBuffer){var i=this._bakcupBuffer;this._bakcupBuffer=new Uint8Array(this._size),this._bakcupBuffer.set(i),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e}var n,r,a,o,s;this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer?this._gpuBuffer.buffer=this._uniformBuffer:this._bakcupBuffer&&(this._gpuBuffer.buffer=this._bakcupBuffer),this._gpuBuffer.size=e,e>0&&(n=this._device,r=this._gpuBuffer,a=n.gl,o=n.stateCache,s=r.memUsage&Xo.HOST?a.DYNAMIC_DRAW:a.STATIC_DRAW,r.usage&qo.VERTEX?(n.useVAO&&o.glVAO&&(n.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=HH.gpuInputAssembler=null),n.stateCache.glArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ARRAY_BUFFER,r.buffer,s):a.bufferData(a.ARRAY_BUFFER,r.size,s),a.bindBuffer(a.ARRAY_BUFFER,null),n.stateCache.glArrayBuffer=null):r.usage&qo.INDEX?(n.useVAO&&o.glVAO&&(n.OES_vertex_array_object.bindVertexArrayOES(null),o.glVAO=HH.gpuInputAssembler=null),n.stateCache.glElementArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.buffer,s):a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.size,s),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),n.stateCache.glElementArrayBuffer=null):r.usage&qo.UNIFORM?r.buffer&&(r.vf32=new Float32Array(r.buffer.buffer)):(r.usage&qo.INDIRECT||r.usage&qo.TRANSFER_DST||r.usage&qo.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),r.glTarget=a.NONE),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e))}}}},{key:"update",value:function(e,t,i){if(this._isBufferView)console.warn("cannot update through buffer views!");else{var n;if(n=void 0!==i?i:this._usage&qo.INDIRECT?0:e.byteLength,this._bakcupBuffer&&e!==this._bakcupBuffer.buffer){var r=new Uint8Array(e,0,i);this._bakcupBuffer.set(r,t)}GH(this._device,this._gpuBuffer,e,t||0,n)}}},{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(Ys),ZH=function(){function e(t,n){i(this,e),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(n),this._freeCmds=new Gi(n);for(var r=0;r<n;++r)this._frees[r]=new t;this._freeIdx=n-1}return r(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var a=n,o=0;a<t;++a,++o)this._frees[a]=i[o];this._freeIdx+=n}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),QH=function(){function e(){i(this,e),this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new ZH(BH,1),this.bindStatesCmdPool=new ZH(LH,1),this.drawCmdPool=new ZH(NH,1),this.updateBufferCmdPool=new ZH(FH,1),this.copyBufferToTextureCmdPool=new ZH(zH,1)}return r(e,[{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),e}(),JH=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).cmdPackage=new UH,n._webGLAllocator=null,n._isInRenderPass=!1,n._curGPUPipelineState=null,n._curGPUInputAssembler=null,n._curGPUDescriptorSets=[],n._curDynamicOffsets=[],n._curViewport=null,n._curScissor=null,n._curLineWidth=null,n._curDepthBias=null,n._curBlendConstants=[],n._curDepthBounds=null,n._curStencilWriteMask=null,n._curStencilCompareMask=null,n._isStateInvalied=!1,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;for(var t=this._device.bindingMappingInfo.bufferOffsets.length,i=0;i<t;i++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}},{key:"begin",value:function(e){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(var t=0;t<this._curDynamicOffsets.length;t++)this._curDynamicOffsets[t].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var o=this._webGLAllocator.beginRenderPassCmdPool.alloc(BH);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea=i,o.clearColors.length=n.length;for(var s=0;s<n.length;++s)o.clearColors[s]=n[s];o.clearDepth=r,o.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(IH.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}},{key:"bindDescriptorSet",value:function(e,t,i){var n=t.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=n,this._isStateInvalied=!0),i){for(var r=this._curDynamicOffsets[e],a=0;a<i.length;a++)r[a]=i[a];r.length=i.length,this._isStateInvalied=!0}}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport=new bs(e.left,e.top,e.width,e.height,e.minDepth,e.maxDepth)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor=new Es(e.x,e.y,e.width,e.height)}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,e),this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===ds.PRIMARY&&this._isInRenderPass||this._type===ds.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._webGLAllocator.drawCmdPool.alloc(NH);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(IH.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===ds.PRIMARY&&!this._isInRenderPass||this._type===ds.SECONDARY){var r=e.gpuBuffer;if(r){var a=this._webGLAllocator.updateBufferCmdPool.alloc(FH),o=0,s=null;e.usage&qo.INDIRECT||(o=void 0!==n?n:t.byteLength),s=t,a.gpuBuffer=r,a.buffer=s,a.offset=void 0!==i?i:0,a.size=o,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(IH.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBuffersToTexture",value:function(e,t,i){if(this._type===ds.PRIMARY&&!this._isInRenderPass||this._type===ds.SECONDARY){var n=t.gpuTexture;if(n){var r=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(zH);r&&(r.gpuTexture=n,r.regions=i,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(IH.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var o=0;o<n.cmdPackage.bindStatesCmds.length;++o){var s=n.cmdPackage.bindStatesCmds.array[o];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var c=n.cmdPackage.drawCmds.array[l];++c.refCount,this.cmdPackage.drawCmds.push(c)}for(var u=0;u<n.cmdPackage.updateBufferCmds.length;++u){var h=n.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<n.cmdPackage.copyBufferToTextureCmds.length;++_){var d=n.cmdPackage.copyBufferToTextureCmds.array[_];++d.refCount,this.cmdPackage.copyBufferToTextureCmds.push(d)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(LH);if(e){e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets);for(var t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets[t]);e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,Array.prototype.push.apply(e.blendConstants,this._curBlendConstants),e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(IH.BIND_STATES),this._isStateInvalied=!1}}},{key:"webGLDevice",get:function(){return this._device}}]),t}(Zs),$H=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"initialize",value:function(e){return!0}},{key:"destroy",value:function(){}},{key:"wait",value:function(){}},{key:"reset",value:function(){}}]),t}(Vl),eV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuFramebuffer=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null,0!==e.depStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0.");for(var t=0;t<e.colorMipmapLevels.length;++t)0!==e.colorMipmapLevels[t]&&console.warn("The mipmap level of th texture image to be attached of color attachment ".concat(t," should be 0. Convert to 0."));for(var i=[],n=0;n<e.colorTextures.length;++n){var r=e.colorTextures[n];r&&i.push(r.gpuTexture)}var a=null;return e.depthStencilTexture&&(a=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:i,gpuDepthStencilTexture:a,glFramebuffer:null},function(e,t){if(t.gpuColorTextures.length||t.gpuDepthStencilTexture){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var o=t.gpuColorTextures[a];o&&(o.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,o.glTarget,o.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,o.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var s=t.gpuDepthStencilTexture;if(s){var l=Ds[s.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,s.glRenderbuffer)}e.WEBGL_draw_buffers&&e.WEBGL_draw_buffers.drawBuffersWEBGL(n);var c=i.checkFramebufferStatus(i.FRAMEBUFFER);if(c!==i.FRAMEBUFFER_COMPLETE)switch(c){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}}(this._device,this._gpuFramebuffer),!0}},{key:"destroy",value:function(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)}},{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(tl),tV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuInputAssembler=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,o=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Error index buffer stride.")}var s=null;return e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:s,glAttribs:[],glIndexType:o,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],o=void 0!==a.stream?a.stream:0,s=t.gpuVertexBuffers[o],l=SH(a.format,i),c=Ds[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:s.glBuffer,glType:l,size:c,count:Ds[a.format].count,stride:s.stride,componentCount:RH(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[o]},n[o]+=c}}(this._device,this._gpuInputAssembler),!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var i=t.glVAOs.values(),n=i.next();!n.done;)e.OES_vertex_array_object.deleteVertexArrayOES(n.value),n=i.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}},{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(sl),iV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuDescriptorSetLayout=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,i=0;i<this._bindings.length;i++){var n=this._bindings[i];this._descriptorIndices.push(t),t+=n.count}this._descriptorIndices.push(t);for(var r=[],a=0;a<this._bindings.length;a++){var o=this._bindings[a];if(o.descriptorType&zl)for(var s=0;s<o.count;s++)r.push(a)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:r,descriptorIndices:this._descriptorIndices,descriptorCount:t},!0}},{key:"destroy",value:function(){this._bindings.length=0}},{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Ul),nV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuPipelineLayout=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],i=[],n=[],r=0,a=0,o=0;o<this._setLayouts.length;o++){var s=this._setLayouts[o],l=s.gpuDescriptorSetLayout.dynamicBindings,c=s.bindings,u=[];i.push(s.gpuDescriptorSetLayout);for(var h=0,_=0;h<c.length;h++)if(l[_]===h)for(u.push(a);l[_]===h;)_++,a++;else u.push(-1);t.push(u),n.push(r),r+=l.length}return this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetCount:r,dynamicOffsetOffsets:n,dynamicOffsetIndices:t},!0}},{key:"destroy",value:function(){this._setLayouts.length=0}},{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Hl),rV=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],aV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuPipelineState=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var t=[],i=0;i<31;i++)this._dynamicStates&1<<i&&t.push(1<<i);return this._gpuPipelineState={glPrimitive:rV[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:t},!0}},{key:"destroy",value:function(){this._gpuPipelineState=null}},{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(fl),oV=[],sV=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"beginRenderPass",value:function(e,t,i,n,r,a){VH(this._device,e.gpuRenderPass,t.gpuFramebuffer,i,n,r,a),this._isInRenderPass=!0}},{key:"draw",value:function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),jH(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var r,a=e.gpuBuffer;if(a)void 0===i&&(i=0),r=void 0!==n?n:e.usage&qo.INDIRECT?0:t.byteLength,GH(this._device,a,t,i,r)}}},{key:"copyBuffersToTexture",value:function(e,t,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var n=t.gpuTexture;n&&YH(this._device,e,n,i)}}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){var n=e[i];XH(this._device,n.cmdPackage),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){oV.length=0;for(var e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(oV,this._curDynamicOffsets[e]);WH(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,oV,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1}}]),t}(JH),lV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).numDrawCalls=0,n.numInstances=0,n.numTris=0,n}return o(t,e),r(t,[{key:"initialize",value:function(e){return this._type=e.type,!0}},{key:"destroy",value:function(){}},{key:"submit",value:function(e,t){if(!this._isAsync)for(var i=e.length,n=0;n<i;n++){var r=e[n];this.numDrawCalls+=r.numDrawCalls,this.numInstances+=r.numInstances,this.numTris+=r.numTris}}},{key:"clear",value:function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}]),t}(ml),cV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuRenderPass=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subPasses&&(this._subPasses=e.subPasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}},{key:"destroy",value:function(){this._gpuRenderPass=null}},{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(xl),uV=[10497,33648,33071,33071],hV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuSampler=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._minFilter=e.minFilter,this._magFilter=e.magFilter,this._mipFilter=e.mipFilter,this._addressU=e.addressU,this._addressV=e.addressV,this._addressW=e.addressW,this._maxAnisotropy=e.maxAnisotropy,this._cmpFunc=e.cmpFunc,this._borderColor=e.borderColor,this._minLOD=e.minLOD,this._maxLOD=e.maxLOD,this._mipLODBias=e.mipLODBias;var t=0,i=0,n=this._minFilter,r=this._magFilter,a=this._mipFilter;t=n===as.LINEAR||n===as.ANISOTROPIC?a===as.LINEAR||a===as.ANISOTROPIC?9987:a===as.POINT?9985:9729:a===as.LINEAR||a===as.ANISOTROPIC?9986:a===as.POINT?9984:9728,i=r===as.LINEAR||r===as.ANISOTROPIC?9729:9728;var o=uV[this._addressU],s=uV[this._addressV],l=uV[this._addressW];return this._gpuSampler={glMinFilter:t,glMagFilter:i,glWrapS:o,glWrapT:s,glWrapR:l},!0}},{key:"destroy",value:function(){this._gpuSampler=null}},{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Tl),_V=function(e){function n(){var e,t;i(this,n);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(t=u(this,(e=s(n)).call.apply(e,[this].concat(a))))._gpuShader=null,t}return o(n,e),r(n,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks,samplers:e.samplers,gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var i=0;i<e.stages.length;++i){var n=e.stages[i];this._gpuShader.gpuStages[i]={type:n.stage,source:n.source,glShader:null}}return function(e,i){for(var n=e.gl,r=function(e){var t=i.gpuStages[e],r=0,a="",o=1;switch(t.type){case hs.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case hs.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(t.glShader=s,n.shaderSource(t.glShader,t.source),n.compileShader(t.glShader),!n.getShaderParameter(t.glShader,n.COMPILE_STATUS))){console.error(a+" in '"+i.name+"' compilation failed."),console.error("Shader source dump:",t.source.replace(/^|\n/g,(function(){return"\n".concat(o++," ")}))),console.error(n.getShaderInfoLog(t.glShader));for(var l=0;l<i.gpuStages.length;l++){var c=i.gpuStages[e];c.glShader&&(n.deleteShader(c.glShader),c.glShader=null)}return{v:void 0}}},a=0;a<i.gpuStages.length;a++){var o=r(a);if("object"===t(o))return o.v}var s=n.createProgram();if(s){i.glProgram=s;for(var l=0;l<i.gpuStages.length;l++){var c=i.gpuStages[l];n.attachShader(i.glProgram,c.glShader)}if(n.linkProgram(i.glProgram),e.destroyShadersImmediately)for(var u=0;u<i.gpuStages.length;u++){var h=i.gpuStages[u];h.glShader&&(n.detachShader(i.glProgram,h.glShader),n.deleteShader(h.glShader),h.glShader=null)}if(!n.getProgramParameter(i.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+i.name+"'."),void console.error(n.getProgramInfoLog(i.glProgram));console.info("Shader '"+i.name+"' compilation succeeded.");var _=n.getProgramParameter(i.glProgram,n.ACTIVE_ATTRIBUTES);i.glInputs=new Array(_);for(var d=0;d<_;++d){var f=n.getActiveAttrib(i.glProgram,d);if(f){var p=void 0,m=f.name.indexOf("[");p=-1!==m?f.name.substr(0,m):f.name;var v=n.getAttribLocation(i.glProgram,p),g=CH(f.type,n),y=wH(f.type,n);i.glInputs[d]={binding:v,name:p,type:g,stride:y,count:f.size,size:y*f.size,glType:f.type,glLoc:v}}}if(i.blocks.length>0){i.glBlocks=new Array(i.blocks.length);for(var x=0;x<i.blocks.length;++x){var S=i.blocks[x],T={set:S.set,binding:S.binding,name:S.name,size:0,glUniforms:new Array(S.members.length),glActiveUniforms:[]};i.glBlocks[x]=T;for(var E=0;E<S.members.length;++E){var b=S.members[E],A=bH(b.type,n),C=AH(b.type),w=wH(A,n),R=w*b.count,I=T.size/4,O=new C(R/4);T.glUniforms[E]={binding:-1,name:b.name,type:b.type,stride:w,count:b.count,size:R,offset:T.size,glType:A,glLoc:-1,array:O,begin:I},T.size+=R}}}if(i.samplers.length>0){i.glSamplers=new Array(i.samplers.length);for(var M=0;M<i.samplers.length;++M){var P=i.samplers[M];i.glSamplers[M]={set:P.set,binding:P.binding,name:P.name,type:P.type,count:P.count,units:[],glUnits:null,glType:bH(P.type,n),glLoc:null}}}for(var k=n.getProgramParameter(i.glProgram,n.ACTIVE_UNIFORMS),D=0;D<k;++D){var B=n.getActiveUniform(i.glProgram,D);if(B)if(!(B.type===n.SAMPLER_2D||B.type===n.SAMPLER_CUBE)){var L=n.getUniformLocation(i.glProgram,B.name);if(null!==L){var N=void 0,F=B.name.indexOf("[");N=-1!==F?B.name.substr(0,F):B.name;for(var z=0;z<i.glBlocks.length;z++)for(var U=i.glBlocks[z],G=0;G<U.glUniforms.length;G++){var H=U.glUniforms[G];if(H.name===N){H.glLoc=L,U.glActiveUniforms.push(H);break}}}}}for(var V=[],W=[],j=e.bindingMappingInfo,q=e.stateCache.texUnitCacheMap,X=0,Y=0;Y<i.blocks.length;++Y)i.blocks[Y].set===j.flexibleSet&&X++;for(var K=0,Z=0;Z<i.samplers.length;++Z){var Q=i.samplers[Z],J=n.getUniformLocation(i.glProgram,Q.name);if(J&&(V.push(i.glSamplers[Z]),W.push(J)),void 0===q[Q.name]){var $=Q.binding+j.samplerOffsets[Q.set]+K;Q.set===j.flexibleSet&&($-=X),q[Q.name]=$%e.maxTextureUnits,K+=Q.count-1}}if(V.length){for(var ee=[],te=0;te<V.length;++te){var ie=V[te],ne=q[ie.name];if(void 0!==ne){ie.glLoc=W[te];for(var re=0;re<ie.count;++re){for(;ee[ne];)ne=(ne+1)%e.maxTextureUnits;ie.units.push(ne),ee[ne]=!0}}}for(var ae=0,oe=0;oe<V.length;++oe){var se=V[oe];if(!se.glLoc){se.glLoc=W[oe];for(var le=0;le<se.count;++le){for(;ee[ae];)ae=(ae+1)%e.maxTextureUnits;void 0===q[se.name]&&(q[se.name]=ae),se.units.push(ae),ee[ae]=!0}}}e.stateCache.glProgram!==i.glProgram&&n.useProgram(i.glProgram);for(var ce=0;ce<V.length;ce++){var ue=V[ce];ue.glUnits=new Int32Array(ue.units),n.uniform1iv(ue.glLoc,ue.glUnits)}e.stateCache.glProgram!==i.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var he=0;he<i.glBlocks.length;)i.glBlocks[he].glActiveUniforms.length?he++:(i.glBlocks[he]=i.glBlocks[i.glBlocks.length-1],i.glBlocks.length--);i.glSamplers=V}}(this._device,this._gpuShader),!0}},{key:"destroy",value:function(){this._gpuShader&&(!function(e,t){if(t.glProgram){var i=e.gl;if(!e.destroyShadersImmediately)for(var n=0;n<t.gpuStages.length;n++){var r=t.gpuStages[n];r.glShader&&(i.detachShader(t.glProgram,r.glShader),i.deleteShader(r.glShader),r.glShader=null)}i.deleteProgram(t.glProgram),t.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)}},{key:"gpuShader",get:function(){return this._gpuShader}}]),n}(Rl),dV=function(){function e(){i(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new bs,this.scissorRect=new Es(0,0,0,0),this.rs=new ll,this.dss=new cl,this.bs=new hl,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return r(e,[{key:"initialize",value:function(e,t){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)}}]),e}(),fV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuTexture=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){return"texture"in e?(console.log("WebGL does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=Ol(this._width)&&Ol(this._height),this._size=Ls(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._flags&us.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;t.glInternalFmt=TH(t.format,i),t.glFormat=EH(t.format,i),t.glType=SH(t.format,i);var n=t.width,r=t.height;switch(t.type){case ss.TEX2D:t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&V(9100,a,e.maxTextureSize),!e.WEBGL_depth_texture&&Ds[t.format].hasDepth){var o=i.createRenderbuffer();o&&t.size>0&&(t.glRenderbuffer=o,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),t.glInternalFmt===i.DEPTH_COMPONENT&&(t.glInternalFmt=i.DEPTH_COMPONENT16),i.renderbufferStorage(i.RENDERBUFFER,t.glInternalFmt,n,r))}else if(t.samples===cs.X1){var s=i.createTexture();if(s&&t.size>0){t.glTexture=s;var l=e.stateCache.glTexUnits[e.stateCache.texUnit];if(l.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),l.glTexture=t.glTexture),Ds[t.format].isCompressed)if(t.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL)for(var c=0;c<t.mipLevel;++c){var u=Bs(t.format,n,r,1),h=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,c,t.glInternalFmt,n,r,0,h),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var _=Bs(t.format,2,2,1),d=new Uint8Array(_);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternalFmt,2,2,0,d)}else for(var f=0;f<t.mipLevel;++f)i.texImage2D(i.TEXTURE_2D,f,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}else i.deleteTexture(s)}break;case ss.CUBE:t.glTarget=i.TEXTURE_CUBE_MAP;var p=Math.max(n,r);p>e.maxCubeMapTextureSize&&V(9100,p,e.maxTextureSize);var m=i.createTexture();if(m&&t.size>0){t.glTexture=m;var v=e.stateCache.glTexUnits[e.stateCache.texUnit];if(v.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),v.glTexture=t.glTexture),Ds[t.format].isCompressed)if(t.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL)for(var g=0;g<6;++g){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y){var x=Bs(t.format,n,r,1),S=new Uint8Array(x);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+g,y,t.glInternalFmt,n,r,0,S),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var T=0;T<6;++T){var E=Bs(t.format,2,2,1),b=new Uint8Array(E);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+T,0,t.glInternalFmt,2,2,0,b)}else for(var A=0;A<6;++A){n=t.width,r=t.height;for(var C=0;C<t.mipLevel;++C)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+A,C,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=i.REPEAT,t.glWrapT=i.REPEAT):(t.glWrapS=i.CLAMP_TO_EDGE,t.glWrapT=i.CLAMP_TO_EDGE),t.glMinFilter=i.LINEAR,t.glMagFilter=i.LINEAR,i.texParameteri(t.glTarget,i.TEXTURE_WRAP_S,t.glWrapS),i.texParameteri(t.glTarget,i.TEXTURE_WRAP_T,t.glWrapT),i.texParameteri(t.glTarget,i.TEXTURE_MIN_FILTER,t.glMinFilter),i.texParameteri(t.glTarget,i.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=ss.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}},{key:"destroy",value:function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=Ls(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;t.glInternalFmt=TH(t.format,i),t.glFormat=EH(t.format,i),t.glType=SH(t.format,i);var n=t.width,r=t.height;switch(t.type){case ss.TEX2D:t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&V(9100,a,e.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,t.glInternalFmt,n,r);else if(t.glTexture){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),Ds[t.format].isCompressed){if(t.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL)for(var s=0;s<t.mipLevel;++s){var l=Bs(t.format,n,r,1),c=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,s,t.glInternalFmt,n,r,0,c),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var u=0;u<t.mipLevel;++u)i.texImage2D(i.TEXTURE_2D,u,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;case ss.CUBE:t.glTarget=i.TEXTURE_CUBE_MAP;var h=Math.max(n,r);h>e.maxCubeMapTextureSize&&V(9100,h,e.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),Ds[t.format].isCompressed){if(t.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL)for(var d=0;d<6;++d){n=t.width,r=t.height;for(var f=0;f<t.mipLevel;++f){var p=Bs(t.format,n,r,1),m=new Uint8Array(p);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+d,f,t.glInternalFmt,n,r,0,m),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}}else for(var v=0;v<6;++v){n=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=ss.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size)}},{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Pl),pV=e("WebGLDevice",function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).stateCache=new dV,n.cmdAllocator=new QH,n.nullTex2D=null,n.nullTexCube=null,n._webGLRC=null,n._isAntialias=!0,n._isPremultipliedAlpha=!0,n._useVAO=!1,n._destroyShadersImmediately=!0,n._noCompressedTexSubImage2D=!1,n._bindingMappingInfo=new Qs,n._webGLContextLostHandler=null,n._extensions=null,n._EXT_texture_filter_anisotropic=null,n._EXT_frag_depth=null,n._EXT_shader_texture_lod=null,n._EXT_sRGB=null,n._OES_vertex_array_object=null,n._EXT_color_buffer_half_float=null,n._WEBGL_color_buffer_float=null,n._WEBGL_compressed_texture_etc1=null,n._WEBGL_compressed_texture_etc=null,n._WEBGL_compressed_texture_pvrtc=null,n._WEBGL_compressed_texture_astc=null,n._WEBGL_compressed_texture_s3tc=null,n._WEBGL_compressed_texture_s3tc_srgb=null,n._WEBGL_debug_shaders=null,n._WEBGL_draw_buffers=null,n._WEBGL_lose_context=null,n._WEBGL_depth_texture=null,n._WEBGL_debug_renderer_info=null,n._OES_texture_half_float=null,n._OES_texture_half_float_linear=null,n._OES_texture_float=null,n._OES_texture_float_linear=null,n._OES_standard_derivatives=null,n._OES_element_index_uint=null,n._ANGLE_instanced_arrays=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=e.isAntialias,this._isPremultipliedAlpha=e.isPremultipliedAlpha,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{var t={alpha:Sh.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(e){return console.error(e),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener("webglcontextlost",this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Us.WEBGL,this._deviceName="WebGL";var i=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this.stateCache.initialize(this._maxTextureUnits,this._maxVertexAttributes),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=jo.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=jo.D24S8:this._depthStencilFmt=jo.D24:8===this._stencilBits?this._depthStencilFmt=jo.D16S8:this._depthStencilFmt=jo.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){for(var r,a=y(this._extensions);!(r=a()).done;){n+=r.value+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),Gn.browserType===Gn.BROWSER_TYPE_UC&&(this._ANGLE_instanced_arrays=null),Gn.os===Gn.OS_IOS&&Gn.osMainVersion<=10&&(this._destroyShadersImmediately=!1),this._features.fill(!1),this._WEBGL_color_buffer_float&&(this._features[Gs.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[Gs.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[Gs.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[Gs.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[Gs.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[Gs.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[Gs.FORMAT_RGB8]=!0,this._WEBGL_depth_texture&&(this._features[Gs.FORMAT_D16]=!0,this._features[Gs.FORMAT_D24]=!0,this._features[Gs.FORMAT_D24S8]=!0),this._OES_element_index_uint&&(this._features[Gs.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[Gs.INSTANCED_ARRAYS]=!0);var o="";this._WEBGL_compressed_texture_etc1&&(this._features[Gs.FORMAT_ETC1]=!0,o+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[Gs.FORMAT_ETC2]=!0,o+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[Gs.FORMAT_DXT]=!0,o+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[Gs.FORMAT_PVRTC]=!0,o+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[Gs.FORMAT_ASTC]=!0,o+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+o),this.initStates(i),this._queue=this.createQueue(new pl(xs.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Ks(this._queue)),this.nullTex2D=this.createTexture(new Il(ss.TEX2D,ls.SAMPLED,jo.RGBA8,2,2,us.GEN_MIPMAP)),this.nullTexCube=this.createTexture(new Il(ss.TEX2D,ls.SAMPLED,jo.RGBA8,2,2,us.CUBEMAP|us.GEN_MIPMAP,6));var s=new Ms;s.texExtent.width=2,s.texExtent.height=2;var l=new Uint8Array(this.nullTex2D.size);return l.fill(0),this.copyBuffersToTexture([l],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([l,l,l,l,l,l],this.nullTexCube,[s]),!0}},{key:"destroy",value:function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener("webglcontextlost",this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGLRC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"acquire",value:function(){this.cmdAllocator.releaseCmds()}},{key:"present",value:function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}},{key:"createCommandBuffer",value:function(e){var t=new(e.type===ds.PRIMARY?sV:JH)(this);return t.initialize(e),t}},{key:"createBuffer",value:function(e){var t=new KH(this);return t.initialize(e)?t:null}},{key:"createTexture",value:function(e){var t=new fV(this);return t.initialize(e)?t:null}},{key:"createSampler",value:function(e){var t=new hV(this);return t.initialize(e)?t:null}},{key:"createDescriptorSet",value:function(e){var t=new xH(this);return t.initialize(e)?t:null}},{key:"createShader",value:function(e){var t=new _V(this);return t.initialize(e)?t:null}},{key:"createInputAssembler",value:function(e){var t=new tV(this);return t.initialize(e)?t:null}},{key:"createRenderPass",value:function(e){var t=new cV(this);return t.initialize(e)?t:null}},{key:"createFramebuffer",value:function(e){var t=new eV(this);return t.initialize(e)?t:null}},{key:"createDescriptorSetLayout",value:function(e){var t=new iV(this);return t.initialize(e)?t:null}},{key:"createPipelineLayout",value:function(e){var t=new nV(this);return t.initialize(e)?t:null}},{key:"createPipelineState",value:function(e){var t=new aV(this);return t.initialize(e)?t:null}},{key:"createFence",value:function(e){var t=new $H(this);return t.initialize(e)?t:null}},{key:"createQueue",value:function(e){var t=new lV(this);return t.initialize(e)?t:null}},{key:"copyBuffersToTexture",value:function(e,t,i){YH(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var o=0,s=0;switch(i.glTarget){case r.TEXTURE_2D:for(var l=0;l<n.length;l++){var c=n[l];r.texSubImage2D(r.TEXTURE_2D,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,i.glFormat,i.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<n.length;u++){var h=n[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,i.glFormat,i.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&us.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGLRC,r=e.gpuFramebuffer,a=r.gpuColorTextures[0].format,o=EH(a,n),s=SH(a,n),l=zs(Ds[a]),c=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);for(var u,h=new l(t),_=y(i);!(u=_()).done;){var d=u.value,f=d.texExtent.width,p=d.texExtent.height;n.readPixels(d.texOffset.x,d.texOffset.y,f,p,o,s,h)}this.stateCache.glFramebuffer!==c&&(n.bindFramebuffer(n.FRAMEBUFFER,c),this.stateCache.glFramebuffer=c)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this.gl.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.disable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}},{key:"_onWebGLContextLost",value:function(e){G(11e3),P(e)}},{key:"gl",get:function(){return this._webGLRC}},{key:"webGLQueue",get:function(){return this._queue}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"destroyShadersImmediately",get:function(){return this._destroyShadersImmediately}},{key:"noCompressedTexSubImage2D",get:function(){return this._noCompressedTexSubImage2D}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"EXT_frag_depth",get:function(){return this._EXT_frag_depth}},{key:"EXT_shader_texture_lod",get:function(){return this._EXT_shader_texture_lod}},{key:"EXT_sRGB",get:function(){return this._EXT_sRGB}},{key:"OES_vertex_array_object",get:function(){return this._OES_vertex_array_object}},{key:"WEBGL_color_buffer_float",get:function(){return this._WEBGL_color_buffer_float}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_astc",get:function(){return this._WEBGL_compressed_texture_astc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_draw_buffers",get:function(){return this._WEBGL_draw_buffers}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}},{key:"WEBGL_depth_texture",get:function(){return this._WEBGL_depth_texture}},{key:"WEBGL_debug_renderer_info",get:function(){return this._WEBGL_debug_renderer_info}},{key:"OES_texture_half_float",get:function(){return this._OES_texture_half_float}},{key:"OES_texture_half_float_linear",get:function(){return this._OES_texture_half_float_linear}},{key:"OES_texture_float",get:function(){return this._OES_texture_float}},{key:"OES_standard_derivatives",get:function(){return this._OES_standard_derivatives}},{key:"OES_element_index_uint",get:function(){return this._OES_element_index_uint}},{key:"ANGLE_instanced_arrays",get:function(){return this._ANGLE_instanced_arrays}}]),t}($s));E.WebGLDevice=pV;var mV=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuDescriptorSet=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,i=t.bindings,n=t.descriptorCount,r=t.descriptorIndices;this._buffers=Array(n).fill(null),this._textures=Array(n).fill(null),this._samplers=Array(n).fill(null);var a=[];this._gpuDescriptorSet={gpuDescriptors:a,descriptorIndices:r};for(var o=0;o<i.length;++o)for(var s=i[o],l=0;l<s.count;l++)a.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null});return!0}},{key:"destroy",value:function(){this._layout=null,this._gpuDescriptorSet=null}},{key:"update",value:function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&kl?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&Dl&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}}},{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(Ll),vV=[10497,33648,33071,33071],gV=[1,2,4,8,16,32,64],yV=new Float32Array(4);function xV(e,t){switch(e){case jo.R8:return t.UNSIGNED_BYTE;case jo.R8SN:return t.BYTE;case jo.R8UI:return t.UNSIGNED_BYTE;case jo.R8I:return t.BYTE;case jo.R16F:return t.HALF_FLOAT;case jo.R16UI:return t.UNSIGNED_SHORT;case jo.R16I:return t.SHORT;case jo.R32F:return t.FLOAT;case jo.R32UI:return t.UNSIGNED_INT;case jo.R32I:return t.INT;case jo.RG8:return t.UNSIGNED_BYTE;case jo.RG8SN:return t.BYTE;case jo.RG8UI:return t.UNSIGNED_BYTE;case jo.RG8I:return t.BYTE;case jo.RG16F:return t.HALF_FLOAT;case jo.RG16UI:return t.UNSIGNED_SHORT;case jo.RG16I:return t.SHORT;case jo.RG32F:return t.FLOAT;case jo.RG32UI:return t.UNSIGNED_INT;case jo.RG32I:return t.INT;case jo.RGB8:case jo.SRGB8:return t.UNSIGNED_BYTE;case jo.RGB8SN:return t.BYTE;case jo.RGB8UI:return t.UNSIGNED_BYTE;case jo.RGB8I:return t.BYTE;case jo.RGB16F:return t.HALF_FLOAT;case jo.RGB16UI:return t.UNSIGNED_SHORT;case jo.RGB16I:return t.SHORT;case jo.RGB32F:return t.FLOAT;case jo.RGB32UI:return t.UNSIGNED_INT;case jo.RGB32I:return t.INT;case jo.BGRA8:case jo.RGBA8:case jo.SRGB8_A8:return t.UNSIGNED_BYTE;case jo.RGBA8SN:return t.BYTE;case jo.RGBA8UI:return t.UNSIGNED_BYTE;case jo.RGBA8I:return t.BYTE;case jo.RGBA16F:return t.HALF_FLOAT;case jo.RGBA16UI:return t.UNSIGNED_SHORT;case jo.RGBA16I:return t.SHORT;case jo.RGBA32F:return t.FLOAT;case jo.RGBA32UI:return t.UNSIGNED_INT;case jo.RGBA32I:return t.INT;case jo.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case jo.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case jo.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case jo.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case jo.RGB10A2:case jo.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case jo.RGB9E5:return t.FLOAT;case jo.D16:return t.UNSIGNED_SHORT;case jo.D16S8:return t.UNSIGNED_INT_24_8;case jo.D24:return t.UNSIGNED_INT;case jo.D24S8:return t.UNSIGNED_INT_24_8;case jo.D32F:return t.FLOAT;case jo.D32F_S8:return t.FLOAT_32_UNSIGNED_INT_24_8_REV;case jo.BC1:case jo.BC1_SRGB:case jo.BC2:case jo.BC2_SRGB:case jo.BC3:case jo.BC3_SRGB:case jo.BC4:return t.UNSIGNED_BYTE;case jo.BC4_SNORM:return t.BYTE;case jo.BC5:return t.UNSIGNED_BYTE;case jo.BC5_SNORM:return t.BYTE;case jo.BC6H_SF16:case jo.BC6H_UF16:return t.FLOAT;case jo.BC7:case jo.BC7_SRGB:case jo.ETC_RGB8:case jo.ETC2_RGB8:case jo.ETC2_SRGB8:case jo.ETC2_RGB8_A1:case jo.ETC2_SRGB8_A1:case jo.ETC2_RGB8:case jo.ETC2_SRGB8:case jo.EAC_R11:return t.UNSIGNED_BYTE;case jo.EAC_R11SN:return t.BYTE;case jo.EAC_RG11:return t.UNSIGNED_BYTE;case jo.EAC_RG11SN:return t.BYTE;case jo.PVRTC_RGB2:case jo.PVRTC_RGBA2:case jo.PVRTC_RGB4:case jo.PVRTC_RGBA4:case jo.PVRTC2_2BPP:case jo.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case jo.ASTC_RGBA_4x4:case jo.ASTC_RGBA_5x4:case jo.ASTC_RGBA_5x5:case jo.ASTC_RGBA_6x5:case jo.ASTC_RGBA_6x6:case jo.ASTC_RGBA_8x5:case jo.ASTC_RGBA_8x6:case jo.ASTC_RGBA_8x8:case jo.ASTC_RGBA_10x5:case jo.ASTC_RGBA_10x6:case jo.ASTC_RGBA_10x8:case jo.ASTC_RGBA_10x10:case jo.ASTC_RGBA_12x10:case jo.ASTC_RGBA_12x12:case jo.ASTC_SRGBA_4x4:case jo.ASTC_SRGBA_5x4:case jo.ASTC_SRGBA_5x5:case jo.ASTC_SRGBA_6x5:case jo.ASTC_SRGBA_6x6:case jo.ASTC_SRGBA_8x5:case jo.ASTC_SRGBA_8x6:case jo.ASTC_SRGBA_8x8:case jo.ASTC_SRGBA_10x5:case jo.ASTC_SRGBA_10x6:case jo.ASTC_SRGBA_10x8:case jo.ASTC_SRGBA_10x10:case jo.ASTC_SRGBA_12x10:case jo.ASTC_SRGBA_12x12:default:return t.UNSIGNED_BYTE}}function SV(e,t){switch(e){case jo.A8:return t.ALPHA;case jo.L8:return t.LUMINANCE;case jo.LA8:return t.LUMINANCE_ALPHA;case jo.R8:return t.R8;case jo.R8SN:return t.R8_SNORM;case jo.R8UI:return t.R8UI;case jo.R8I:return t.R8I;case jo.RG8:return t.RG8;case jo.RG8SN:return t.RG8_SNORM;case jo.RG8UI:return t.RG8UI;case jo.RG8I:return t.RG8I;case jo.RGB8:return t.RGB8;case jo.RGB8SN:return t.RGB8_SNORM;case jo.RGB8UI:return t.RGB8UI;case jo.RGB8I:return t.RGB8I;case jo.BGRA8:case jo.RGBA8:return t.RGBA8;case jo.RGBA8SN:return t.RGBA8_SNORM;case jo.RGBA8UI:return t.RGBA8UI;case jo.RGBA8I:return t.RGBA8I;case jo.R16I:return t.R16I;case jo.R16UI:return t.R16UI;case jo.R16F:return t.R16F;case jo.RG16I:return t.RG16I;case jo.RG16UI:return t.RG16UI;case jo.RG16F:return t.RG16F;case jo.RGB16I:return t.RGB16I;case jo.RGB16UI:return t.RGB16UI;case jo.RGB16F:return t.RGB16F;case jo.RGBA16I:return t.RGBA16I;case jo.RGBA16UI:return t.RGBA16UI;case jo.RGBA16F:return t.RGBA16F;case jo.R32I:return t.R32I;case jo.R32UI:return t.R32UI;case jo.R32F:return t.R32F;case jo.RG32I:return t.RG32I;case jo.RG32UI:return t.RG32UI;case jo.RG32F:return t.RG32F;case jo.RGB32I:return t.RGB32I;case jo.RGB32UI:return t.RGB32UI;case jo.RGB32F:return t.RGB32F;case jo.RGBA32I:return t.RGBA32I;case jo.RGBA32UI:return t.RGBA32UI;case jo.RGBA32F:return t.RGBA32F;case jo.R5G6B5:return t.RGB565;case jo.RGB5A1:return t.RGB5_A1;case jo.RGBA4:return t.RGBA4;case jo.RGB10A2:return t.RGB10_A2;case jo.RGB10A2UI:return t.RGB10_A2UI;case jo.R11G11B10F:return t.R11F_G11F_B10F;case jo.D16:return t.DEPTH_COMPONENT16;case jo.D16S8:return t.DEPTH24_STENCIL8;case jo.D24:return t.DEPTH_COMPONENT24;case jo.D24S8:return t.DEPTH24_STENCIL8;case jo.D32F:return t.DEPTH_COMPONENT32F;case jo.D32F_S8:return t.DEPTH32F_STENCIL8;case jo.BC1:return yH.COMPRESSED_RGB_S3TC_DXT1_EXT;case jo.BC1_ALPHA:return yH.COMPRESSED_RGBA_S3TC_DXT1_EXT;case jo.BC1_SRGB:return yH.COMPRESSED_SRGB_S3TC_DXT1_EXT;case jo.BC1_SRGB_ALPHA:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case jo.BC2:return yH.COMPRESSED_RGBA_S3TC_DXT3_EXT;case jo.BC2_SRGB:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case jo.BC3:return yH.COMPRESSED_RGBA_S3TC_DXT5_EXT;case jo.BC3_SRGB:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case jo.ETC_RGB8:return yH.COMPRESSED_RGB_ETC1_WEBGL;case jo.ETC2_RGB8:return yH.COMPRESSED_RGB8_ETC2;case jo.ETC2_SRGB8:return yH.COMPRESSED_SRGB8_ETC2;case jo.ETC2_RGB8_A1:return yH.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jo.ETC2_SRGB8_A1:return yH.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jo.ETC2_RGBA8:return yH.COMPRESSED_RGBA8_ETC2_EAC;case jo.ETC2_SRGB8_A8:return yH.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case jo.EAC_R11:return yH.COMPRESSED_R11_EAC;case jo.EAC_R11SN:return yH.COMPRESSED_SIGNED_R11_EAC;case jo.EAC_RG11:return yH.COMPRESSED_RG11_EAC;case jo.EAC_RG11SN:return yH.COMPRESSED_SIGNED_RG11_EAC;case jo.PVRTC_RGB2:return yH.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case jo.PVRTC_RGBA2:return yH.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case jo.PVRTC_RGB4:return yH.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case jo.PVRTC_RGBA4:return yH.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case jo.ASTC_RGBA_4x4:return yH.COMPRESSED_RGBA_ASTC_4x4_KHR;case jo.ASTC_RGBA_5x4:return yH.COMPRESSED_RGBA_ASTC_5x4_KHR;case jo.ASTC_RGBA_5x5:return yH.COMPRESSED_RGBA_ASTC_5x5_KHR;case jo.ASTC_RGBA_6x5:return yH.COMPRESSED_RGBA_ASTC_6x5_KHR;case jo.ASTC_RGBA_6x6:return yH.COMPRESSED_RGBA_ASTC_6x6_KHR;case jo.ASTC_RGBA_8x5:return yH.COMPRESSED_RGBA_ASTC_8x5_KHR;case jo.ASTC_RGBA_8x6:return yH.COMPRESSED_RGBA_ASTC_8x6_KHR;case jo.ASTC_RGBA_8x8:return yH.COMPRESSED_RGBA_ASTC_8x8_KHR;case jo.ASTC_RGBA_10x5:return yH.COMPRESSED_RGBA_ASTC_10x5_KHR;case jo.ASTC_RGBA_10x6:return yH.COMPRESSED_RGBA_ASTC_10x6_KHR;case jo.ASTC_RGBA_10x8:return yH.COMPRESSED_RGBA_ASTC_10x8_KHR;case jo.ASTC_RGBA_10x10:return yH.COMPRESSED_RGBA_ASTC_10x10_KHR;case jo.ASTC_RGBA_12x10:return yH.COMPRESSED_RGBA_ASTC_12x10_KHR;case jo.ASTC_RGBA_12x12:return yH.COMPRESSED_RGBA_ASTC_12x12_KHR;case jo.ASTC_SRGBA_4x4:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case jo.ASTC_SRGBA_5x4:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case jo.ASTC_SRGBA_5x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case jo.ASTC_SRGBA_6x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case jo.ASTC_SRGBA_6x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case jo.ASTC_SRGBA_8x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case jo.ASTC_SRGBA_8x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case jo.ASTC_SRGBA_8x8:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case jo.ASTC_SRGBA_10x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case jo.ASTC_SRGBA_10x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case jo.ASTC_SRGBA_10x8:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case jo.ASTC_SRGBA_10x10:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case jo.ASTC_SRGBA_12x10:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case jo.ASTC_SRGBA_12x12:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL internal format failed."),t.RGBA}}function TV(e,t){switch(e){case jo.A8:return t.ALPHA;case jo.L8:return t.LUMINANCE;case jo.LA8:return t.LUMINANCE_ALPHA;case jo.R8:case jo.R8SN:return t.RED;case jo.R8UI:case jo.R8I:return t.RED;case jo.RG8:case jo.RG8SN:case jo.RG8UI:case jo.RG8I:return t.RG;case jo.RGB8:case jo.RGB8SN:case jo.RGB8UI:case jo.RGB8I:return t.RGB;case jo.BGRA8:case jo.RGBA8:case jo.RGBA8SN:case jo.RGBA8UI:case jo.RGBA8I:return t.RGBA;case jo.R16UI:case jo.R16I:case jo.R16F:return t.RED;case jo.RG16UI:case jo.RG16I:case jo.RG16F:return t.RG;case jo.RGB16UI:case jo.RGB16I:case jo.RGB16F:return t.RGB;case jo.RGBA16UI:case jo.RGBA16I:case jo.RGBA16F:return t.RGBA;case jo.R32UI:case jo.R32I:case jo.R32F:return t.RED;case jo.RG32UI:case jo.RG32I:case jo.RG32F:return t.RG;case jo.RGB32UI:case jo.RGB32I:case jo.RGB32F:return t.RGB;case jo.RGBA32UI:case jo.RGBA32I:case jo.RGBA32F:case jo.RGB10A2:return t.RGBA;case jo.R11G11B10F:case jo.R5G6B5:return t.RGB;case jo.RGB5A1:case jo.RGBA4:return t.RGBA;case jo.D16:return t.DEPTH_COMPONENT;case jo.D16S8:return t.DEPTH_STENCIL;case jo.D24:return t.DEPTH_COMPONENT;case jo.D24S8:return t.DEPTH_STENCIL;case jo.D32F:return t.DEPTH_COMPONENT;case jo.D32F_S8:return t.DEPTH_STENCIL;case jo.BC1:return yH.COMPRESSED_RGB_S3TC_DXT1_EXT;case jo.BC1_ALPHA:return yH.COMPRESSED_RGBA_S3TC_DXT1_EXT;case jo.BC1_SRGB:return yH.COMPRESSED_SRGB_S3TC_DXT1_EXT;case jo.BC1_SRGB_ALPHA:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case jo.BC2:return yH.COMPRESSED_RGBA_S3TC_DXT3_EXT;case jo.BC2_SRGB:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case jo.BC3:return yH.COMPRESSED_RGBA_S3TC_DXT5_EXT;case jo.BC3_SRGB:return yH.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case jo.ETC_RGB8:return yH.COMPRESSED_RGB_ETC1_WEBGL;case jo.ETC2_RGB8:return yH.COMPRESSED_RGB8_ETC2;case jo.ETC2_SRGB8:return yH.COMPRESSED_SRGB8_ETC2;case jo.ETC2_RGB8_A1:return yH.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jo.ETC2_SRGB8_A1:return yH.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case jo.ETC2_RGBA8:return yH.COMPRESSED_RGBA8_ETC2_EAC;case jo.ETC2_SRGB8_A8:return yH.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case jo.EAC_R11:return yH.COMPRESSED_R11_EAC;case jo.EAC_R11SN:return yH.COMPRESSED_SIGNED_R11_EAC;case jo.EAC_RG11:return yH.COMPRESSED_RG11_EAC;case jo.EAC_RG11SN:return yH.COMPRESSED_SIGNED_RG11_EAC;case jo.PVRTC_RGB2:return yH.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case jo.PVRTC_RGBA2:return yH.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case jo.PVRTC_RGB4:return yH.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case jo.PVRTC_RGBA4:return yH.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case jo.ASTC_RGBA_4x4:return yH.COMPRESSED_RGBA_ASTC_4x4_KHR;case jo.ASTC_RGBA_5x4:return yH.COMPRESSED_RGBA_ASTC_5x4_KHR;case jo.ASTC_RGBA_5x5:return yH.COMPRESSED_RGBA_ASTC_5x5_KHR;case jo.ASTC_RGBA_6x5:return yH.COMPRESSED_RGBA_ASTC_6x5_KHR;case jo.ASTC_RGBA_6x6:return yH.COMPRESSED_RGBA_ASTC_6x6_KHR;case jo.ASTC_RGBA_8x5:return yH.COMPRESSED_RGBA_ASTC_8x5_KHR;case jo.ASTC_RGBA_8x6:return yH.COMPRESSED_RGBA_ASTC_8x6_KHR;case jo.ASTC_RGBA_8x8:return yH.COMPRESSED_RGBA_ASTC_8x8_KHR;case jo.ASTC_RGBA_10x5:return yH.COMPRESSED_RGBA_ASTC_10x5_KHR;case jo.ASTC_RGBA_10x6:return yH.COMPRESSED_RGBA_ASTC_10x6_KHR;case jo.ASTC_RGBA_10x8:return yH.COMPRESSED_RGBA_ASTC_10x8_KHR;case jo.ASTC_RGBA_10x10:return yH.COMPRESSED_RGBA_ASTC_10x10_KHR;case jo.ASTC_RGBA_12x10:return yH.COMPRESSED_RGBA_ASTC_12x10_KHR;case jo.ASTC_RGBA_12x12:return yH.COMPRESSED_RGBA_ASTC_12x12_KHR;case jo.ASTC_SRGBA_4x4:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case jo.ASTC_SRGBA_5x4:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case jo.ASTC_SRGBA_5x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case jo.ASTC_SRGBA_6x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case jo.ASTC_SRGBA_6x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case jo.ASTC_SRGBA_8x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case jo.ASTC_SRGBA_8x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case jo.ASTC_SRGBA_8x8:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case jo.ASTC_SRGBA_10x5:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case jo.ASTC_SRGBA_10x6:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case jo.ASTC_SRGBA_10x8:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case jo.ASTC_SRGBA_10x10:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case jo.ASTC_SRGBA_12x10:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case jo.ASTC_SRGBA_12x12:return yH.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported GFXFormat, convert to WebGL format failed."),t.RGBA}}function EV(e,t){switch(e){case Wo.BOOL:return t.BOOL;case Wo.BOOL2:return t.BOOL_VEC2;case Wo.BOOL3:return t.BOOL_VEC3;case Wo.BOOL4:return t.BOOL_VEC4;case Wo.INT:return t.INT;case Wo.INT2:return t.INT_VEC2;case Wo.INT3:return t.INT_VEC3;case Wo.INT4:return t.INT_VEC4;case Wo.UINT:return t.UNSIGNED_INT;case Wo.FLOAT:return t.FLOAT;case Wo.FLOAT2:return t.FLOAT_VEC2;case Wo.FLOAT3:return t.FLOAT_VEC3;case Wo.FLOAT4:return t.FLOAT_VEC4;case Wo.MAT2:return t.FLOAT_MAT2;case Wo.MAT2X3:return t.FLOAT_MAT2x3;case Wo.MAT2X4:return t.FLOAT_MAT2x4;case Wo.MAT3X2:return t.FLOAT_MAT3x2;case Wo.MAT3:return t.FLOAT_MAT3;case Wo.MAT3X4:return t.FLOAT_MAT3x4;case Wo.MAT4X2:return t.FLOAT_MAT4x2;case Wo.MAT4X3:return t.FLOAT_MAT4x3;case Wo.MAT4:return t.FLOAT_MAT4;case Wo.SAMPLER2D:return t.SAMPLER_2D;case Wo.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case Wo.SAMPLER3D:return t.SAMPLER_3D;case Wo.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Wo.UNKNOWN}}function bV(e,t){switch(e){case t.BOOL:return Wo.BOOL;case t.BOOL_VEC2:return Wo.BOOL2;case t.BOOL_VEC3:return Wo.BOOL3;case t.BOOL_VEC4:return Wo.BOOL4;case t.INT:return Wo.INT;case t.INT_VEC2:return Wo.INT2;case t.INT_VEC3:return Wo.INT3;case t.INT_VEC4:return Wo.INT4;case t.UNSIGNED_INT:return Wo.UINT;case t.UNSIGNED_INT_VEC2:return Wo.UINT2;case t.UNSIGNED_INT_VEC3:return Wo.UINT3;case t.UNSIGNED_INT_VEC4:return Wo.UINT4;case t.UNSIGNED_INT:return Wo.UINT;case t.FLOAT:return Wo.FLOAT;case t.FLOAT_VEC2:return Wo.FLOAT2;case t.FLOAT_VEC3:return Wo.FLOAT3;case t.FLOAT_VEC4:return Wo.FLOAT4;case t.FLOAT_MAT2:return Wo.MAT2;case t.FLOAT_MAT2x3:return Wo.MAT2X3;case t.FLOAT_MAT2x4:return Wo.MAT2X4;case t.FLOAT_MAT3x2:return Wo.MAT3X2;case t.FLOAT_MAT3:return Wo.MAT3;case t.FLOAT_MAT3x4:return Wo.MAT3X4;case t.FLOAT_MAT4x2:return Wo.MAT4X2;case t.FLOAT_MAT4x3:return Wo.MAT4X3;case t.FLOAT_MAT4:return Wo.MAT4;case t.SAMPLER_2D:return Wo.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return Wo.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return Wo.SAMPLER3D;case t.SAMPLER_CUBE:return Wo.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GFXType failed."),Wo.UNKNOWN}}function AV(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function CV(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var wV,RV=[512,513,514,515,516,517,518,519],IV=[0,7680,7681,7682,7683,5386,34055,34056],OV=[32774,32778,32779,32774,32774],MV=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(wV||(wV={}));var PV=function e(t){i(this,e),this.cmdType=void 0,this.refCount=0,this.cmdType=t},kV=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,wV.BEGIN_RENDER_PASS))).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new Es,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return o(t,e),r(t,[{key:"clear",value:function(){this.gpuFramebuffer=null,this.clearColors.length=0}}]),t}(PV),DV=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,wV.BIND_STATES))).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.viewport=null,e.scissor=null,e.lineWidth=null,e.depthBias=null,e.blendConstants=[],e.depthBounds=null,e.stencilWriteMask=null,e.stencilCompareMask=null,e}return o(t,e),r(t,[{key:"clear",value:function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}]),t}(PV),BV=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,wV.DRAW))).drawInfo=new Vs,e}return o(t,e),r(t,[{key:"clear",value:function(){}}]),t}(PV),LV=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,wV.UPDATE_BUFFER))).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return o(t,e),r(t,[{key:"clear",value:function(){this.gpuBuffer=null,this.buffer=null}}]),t}(PV),NV=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this,wV.COPY_BUFFER_TO_TEXTURE))).gpuTexture=null,e.buffers=[],e.regions=[],e}return o(t,e),r(t,[{key:"clear",value:function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}]),t}(PV),FV=function(){function e(){i(this,e),this.cmds=new Gi(1),this.beginRenderPassCmds=new Gi(1),this.bindStatesCmds=new Gi(1),this.drawCmds=new Gi(1),this.updateBufferCmds=new Gi(1),this.copyBufferToTextureCmds=new Gi(1)}return r(e,[{key:"clearCmds",value:function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}]),e}();function zV(e,t,i,n,r){if(t.usage&qo.INDIRECT)t.indirects.length=n,Array.prototype.push.apply(t.indirects,i.drawInfos);else{var a=i,o=e.gl,s=e.stateCache;switch(t.glTarget){case o.ARRAY_BUFFER:s.glVAO&&(o.bindVertexArray(null),s.glVAO=UV.gpuInputAssembler=null),s.glArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,t.glBuffer),s.glArrayBuffer=t.glBuffer),r===a.byteLength?o.bufferSubData(t.glTarget,n,a):o.bufferSubData(t.glTarget,n,a.slice(0,r));break;case o.ELEMENT_ARRAY_BUFFER:s.glVAO&&(o.bindVertexArray(null),s.glVAO=UV.gpuInputAssembler=null),s.glElementArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,t.glBuffer),s.glElementArrayBuffer=t.glBuffer),r===a.byteLength?o.bufferSubData(t.glTarget,n,a):o.bufferSubData(t.glTarget,n,a.slice(0,r));break;case o.UNIFORM_BUFFER:s.glUniformBuffer!==t.glBuffer&&(o.bindBuffer(o.UNIFORM_BUFFER,t.glBuffer),s.glUniformBuffer=t.glBuffer),r===a.byteLength?o.bufferSubData(t.glTarget,n,a):o.bufferSubData(t.glTarget,n,new Float32Array(a,0,r/4));break;default:return void console.error("Unsupported GFXBufferType, update buffer failed.")}}}var UV={gpuPipelineState:null,gpuInputAssembler:null,reverseCW:!1,glPrimitive:0,invalidateAttachments:[]};function GV(e,t,i,n,r,a,o){var s=e.gl,l=e.stateCache,c=0;if(i&&t){if(l.glFramebuffer!==i.glFramebuffer){s.bindFramebuffer(s.FRAMEBUFFER,i.glFramebuffer),l.glFramebuffer=i.glFramebuffer;var u=!!i.glFramebuffer;if(u!==UV.reverseCW){UV.reverseCW=u;var h=!e.stateCache.rs.isFrontFaceCCW;s.frontFace(h?s.CCW:s.CW),e.stateCache.rs.isFrontFaceCCW=h}}l.viewport.left===n.x&&l.viewport.top===n.y&&l.viewport.width===n.width&&l.viewport.height===n.height||(s.viewport(n.x,n.y,n.width,n.height),l.viewport.left=n.x,l.viewport.top=n.y,l.viewport.width=n.width,l.viewport.height=n.height),l.scissorRect.x===n.x&&l.scissorRect.y===n.y&&l.scissorRect.width===n.width&&l.scissorRect.height===n.height||(s.scissor(n.x,n.y,n.width,n.height),l.scissorRect.x=n.x,l.scissorRect.y=n.y,l.scissorRect.width=n.width,l.scissorRect.height=n.height),UV.invalidateAttachments.length=0;for(var _=0;_<r.length;++_){var d=t.colorAttachments[_];if(d.format!==jo.UNKNOWN)switch(d.loadOp){case fs.LOAD:break;case fs.CLEAR:if(l.bs.targets[0].blendColorMask!==rs.ALL&&s.colorMask(!0,!0,!0,!0),i.isOffscreen)yV[0]=r[_].x,yV[1]=r[_].y,yV[2]=r[_].z,yV[3]=r[_].w,s.clearBufferfv(s.COLOR,_,yV);else{var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),c|=s.COLOR_BUFFER_BIT}break;case fs.DISCARD:UV.invalidateAttachments.push(s.COLOR_ATTACHMENT0+_)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==jo.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case fs.LOAD:break;case fs.CLEAR:l.dss.depthWrite||s.depthMask(!0),s.clearDepth(a),c|=s.DEPTH_BUFFER_BIT;break;case fs.DISCARD:UV.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(Ds[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case fs.LOAD:break;case fs.CLEAR:l.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),l.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(o),c|=s.STENCIL_BUFFER_BIT;break;case fs.DISCARD:UV.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(i.glFramebuffer&&UV.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,UV.invalidateAttachments),c&&s.clear(c),c&s.COLOR_BUFFER_BIT){var p=l.bs.targets[0].blendColorMask;if(p!==rs.ALL){var m=(p&rs.R)!==rs.NONE,v=(p&rs.G)!==rs.NONE,g=(p&rs.B)!==rs.NONE,y=(p&rs.A)!==rs.NONE;s.colorMask(m,v,g,y)}}c&s.DEPTH_BUFFER_BIT&&!l.dss.depthWrite&&s.depthMask(!1),c&s.STENCIL_BUFFER_BIT&&(l.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),l.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function HV(e,t,i,n,r,a,o,s,l,c,u,h,_){var d=e.gl,f=e.stateCache,p=t&&t.gpuShader,m=!1;if(t&&UV.gpuPipelineState!==t){if(UV.gpuPipelineState=t,UV.glPrimitive=t.glPrimitive,p){var v=p.glProgram;f.glProgram!==v&&(d.useProgram(v),f.glProgram=v,m=!0)}var g=t.rs;if(g){if(f.rs.cullMode!==g.cullMode){switch(g.cullMode){case $o.NONE:d.disable(d.CULL_FACE);break;case $o.FRONT:d.enable(d.CULL_FACE),d.cullFace(d.FRONT);break;case $o.BACK:d.enable(d.CULL_FACE),d.cullFace(d.BACK)}e.stateCache.rs.cullMode=g.cullMode}var y=g.isFrontFaceCCW!==UV.reverseCW;e.stateCache.rs.isFrontFaceCCW!==y&&(d.frontFace(y?d.CCW:d.CW),e.stateCache.rs.isFrontFaceCCW=y),e.stateCache.rs.depthBias===g.depthBias&&e.stateCache.rs.depthBiasSlop===g.depthBiasSlop||(d.polygonOffset(g.depthBias,g.depthBiasSlop),e.stateCache.rs.depthBias=g.depthBias,e.stateCache.rs.depthBiasSlop=g.depthBiasSlop),e.stateCache.rs.lineWidth!==g.lineWidth&&(d.lineWidth(g.lineWidth),e.stateCache.rs.lineWidth=g.lineWidth)}var x=t.dss;x&&(f.dss.depthTest!==x.depthTest&&(x.depthTest?d.enable(d.DEPTH_TEST):d.disable(d.DEPTH_TEST),f.dss.depthTest=x.depthTest),f.dss.depthWrite!==x.depthWrite&&(d.depthMask(x.depthWrite),f.dss.depthWrite=x.depthWrite),f.dss.depthFunc!==x.depthFunc&&(d.depthFunc(RV[x.depthFunc]),f.dss.depthFunc=x.depthFunc),f.dss.stencilTestFront===x.stencilTestFront&&f.dss.stencilTestBack===x.stencilTestBack||(x.stencilTestFront||x.stencilTestBack?d.enable(d.STENCIL_TEST):d.disable(d.STENCIL_TEST),f.dss.stencilTestFront=x.stencilTestFront,f.dss.stencilTestBack=x.stencilTestBack),f.dss.stencilFuncFront===x.stencilFuncFront&&f.dss.stencilRefFront===x.stencilRefFront&&f.dss.stencilReadMaskFront===x.stencilReadMaskFront||(d.stencilFuncSeparate(d.FRONT,RV[x.stencilFuncFront],x.stencilRefFront,x.stencilReadMaskFront),f.dss.stencilFuncFront=x.stencilFuncFront,f.dss.stencilRefFront=x.stencilRefFront,f.dss.stencilReadMaskFront=x.stencilReadMaskFront),f.dss.stencilFailOpFront===x.stencilFailOpFront&&f.dss.stencilZFailOpFront===x.stencilZFailOpFront&&f.dss.stencilPassOpFront===x.stencilPassOpFront||(d.stencilOpSeparate(d.FRONT,IV[x.stencilFailOpFront],IV[x.stencilZFailOpFront],IV[x.stencilPassOpFront]),f.dss.stencilFailOpFront=x.stencilFailOpFront,f.dss.stencilZFailOpFront=x.stencilZFailOpFront,f.dss.stencilPassOpFront=x.stencilPassOpFront),f.dss.stencilWriteMaskFront!==x.stencilWriteMaskFront&&(d.stencilMaskSeparate(d.FRONT,x.stencilWriteMaskFront),f.dss.stencilWriteMaskFront=x.stencilWriteMaskFront),f.dss.stencilFuncBack===x.stencilFuncBack&&f.dss.stencilRefBack===x.stencilRefBack&&f.dss.stencilReadMaskBack===x.stencilReadMaskBack||(d.stencilFuncSeparate(d.BACK,RV[x.stencilFuncBack],x.stencilRefBack,x.stencilReadMaskBack),f.dss.stencilFuncBack=x.stencilFuncBack,f.dss.stencilRefBack=x.stencilRefBack,f.dss.stencilReadMaskBack=x.stencilReadMaskBack),f.dss.stencilFailOpBack===x.stencilFailOpBack&&f.dss.stencilZFailOpBack===x.stencilZFailOpBack&&f.dss.stencilPassOpBack===x.stencilPassOpBack||(d.stencilOpSeparate(d.BACK,IV[x.stencilFailOpBack],IV[x.stencilZFailOpBack],IV[x.stencilPassOpBack]),f.dss.stencilFailOpBack=x.stencilFailOpBack,f.dss.stencilZFailOpBack=x.stencilZFailOpBack,f.dss.stencilPassOpBack=x.stencilPassOpBack),f.dss.stencilWriteMaskBack!==x.stencilWriteMaskBack&&(d.stencilMaskSeparate(d.BACK,x.stencilWriteMaskBack),f.dss.stencilWriteMaskBack=x.stencilWriteMaskBack));var S=t.bs;if(S){f.bs.isA2C!==S.isA2C&&(S.isA2C?d.enable(d.SAMPLE_ALPHA_TO_COVERAGE):d.disable(d.SAMPLE_ALPHA_TO_COVERAGE),f.bs.isA2C=S.isA2C),f.bs.blendColor.x===S.blendColor.x&&f.bs.blendColor.y===S.blendColor.y&&f.bs.blendColor.z===S.blendColor.z&&f.bs.blendColor.w===S.blendColor.w||(d.blendColor(S.blendColor.x,S.blendColor.y,S.blendColor.z,S.blendColor.w),f.bs.blendColor.x=S.blendColor.x,f.bs.blendColor.y=S.blendColor.y,f.bs.blendColor.z=S.blendColor.z,f.bs.blendColor.w=S.blendColor.w);var T=S.targets[0],E=f.bs.targets[0];E.blend!==T.blend&&(T.blend?d.enable(d.BLEND):d.disable(d.BLEND),E.blend=T.blend),E.blendEq===T.blendEq&&E.blendAlphaEq===T.blendAlphaEq||(d.blendEquationSeparate(OV[T.blendEq],OV[T.blendAlphaEq]),E.blendEq=T.blendEq,E.blendAlphaEq=T.blendAlphaEq),E.blendSrc===T.blendSrc&&E.blendDst===T.blendDst&&E.blendSrcAlpha===T.blendSrcAlpha&&E.blendDstAlpha===T.blendDstAlpha||(d.blendFuncSeparate(MV[T.blendSrc],MV[T.blendDst],MV[T.blendSrcAlpha],MV[T.blendDstAlpha]),E.blendSrc=T.blendSrc,E.blendDst=T.blendDst,E.blendSrcAlpha=T.blendSrcAlpha,E.blendDstAlpha=T.blendDstAlpha),E.blendColorMask!==T.blendColorMask&&(d.colorMask((T.blendColorMask&rs.R)!==rs.NONE,(T.blendColorMask&rs.G)!==rs.NONE,(T.blendColorMask&rs.B)!==rs.NONE,(T.blendColorMask&rs.A)!==rs.NONE),E.blendColorMask=T.blendColorMask)}}if(t&&t.gpuPipelineLayout&&p){for(var b=p.glBlocks.length,A=t.gpuPipelineLayout.dynamicOffsetIndices,C=0;C<b;C++){var w=p.glBlocks[C],R=n[w.set],I=R&&R.gpuDescriptors[w.binding];if(I&&I.gpuBuffer){var O=A[w.set],M=O&&O[w.binding],P=I.gpuBuffer.glOffset;M>=0&&(P+=r[M]),f.glBindUBOs[w.glBinding]===I.gpuBuffer.glBuffer&&f.glBindUBOOffsets[w.glBinding]===P||(P?d.bindBufferRange(d.UNIFORM_BUFFER,w.glBinding,I.gpuBuffer.glBuffer,P,I.gpuBuffer.size):d.bindBufferBase(d.UNIFORM_BUFFER,w.glBinding,I.gpuBuffer.glBuffer),f.glUniformBuffer=f.glBindUBOs[w.glBinding]=I.gpuBuffer.glBuffer,f.glBindUBOOffsets[w.glBinding]=P)}else k("Buffer binding '".concat(w.name,"' at set ").concat(w.set," binding ").concat(w.binding," is not bounded"))}for(var D=p.glSamplers.length,B=0;B<D;B++)for(var L=p.glSamplers[B],N=n[L.set],F=N&&N.descriptorIndices[L.binding],z=N&&N.gpuDescriptors[F],U=0;U<L.units.length;U++){var G=L.units[U],H=f.glTexUnits[G];if(z&&z.gpuTexture&&z.gpuSampler){if(z.gpuTexture&&z.gpuTexture.size>0){var V=z.gpuTexture;H.glTexture!==V.glTexture&&(f.texUnit!==G&&(d.activeTexture(d.TEXTURE0+G),f.texUnit=G),V.glTexture?d.bindTexture(V.glTarget,V.glTexture):d.bindTexture(V.glTarget,e.nullTex2D.gpuTexture.glTexture),H.glTexture=V.glTexture);var W=z.gpuSampler;f.glSamplerUnits[G]!==W.glSampler&&(d.bindSampler(G,W.glSampler),f.glSamplerUnits[G]=W.glSampler)}z=N.gpuDescriptors[++F]}else k("Sampler binding '".concat(L.name,"' at set ").concat(L.set," binding ").concat(L.binding," index ").concat(U," is not bounded"))}}if(i&&p&&(m||UV.gpuInputAssembler!==i))if(UV.gpuInputAssembler=i,e.useVAO){var j=i.glVAOs.get(p.glProgram);if(!j){var q;j=d.createVertexArray(),i.glVAOs.set(p.glProgram,j),d.bindVertexArray(j),d.bindBuffer(d.ARRAY_BUFFER,null),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null),f.glArrayBuffer=null,f.glElementArrayBuffer=null;for(var X=0;X<p.glInputs.length;X++){var Y=p.glInputs[X];q=null;for(var K=0;K<i.glAttribs.length;K++){var Z=i.glAttribs[K];if(Z.name===Y.name){q=Z;break}}if(q){f.glArrayBuffer!==q.glBuffer&&(d.bindBuffer(d.ARRAY_BUFFER,q.glBuffer),f.glArrayBuffer=q.glBuffer);for(var Q=0;Q<q.componentCount;++Q){var J=Y.glLoc+Q,$=q.offset+q.size*Q;d.enableVertexAttribArray(J),f.glCurrentAttribLocs[J]=!0,d.vertexAttribPointer(J,q.count,q.glType,q.isNormalized,q.stride,$),d.vertexAttribDivisor(J,q.isInstanced?1:0)}}}var ee=i.gpuIndexBuffer;ee&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,ee.glBuffer),d.bindVertexArray(null),d.bindBuffer(d.ARRAY_BUFFER,null),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null),f.glArrayBuffer=null,f.glElementArrayBuffer=null}f.glVAO!==j&&(d.bindVertexArray(j),f.glVAO=j)}else{for(var te=0;te<e.maxVertexAttributes;++te)f.glCurrentAttribLocs[te]=!1;for(var ie=0;ie<p.glInputs.length;ie++){for(var ne=p.glInputs[ie],re=null,ae=0;ae<i.glAttribs.length;ae++){var oe=i.glAttribs[ae];if(oe.name===ne.name){re=oe;break}}if(re){f.glArrayBuffer!==re.glBuffer&&(d.bindBuffer(d.ARRAY_BUFFER,re.glBuffer),f.glArrayBuffer=re.glBuffer);for(var se=0;se<re.componentCount;++se){var le=ne.glLoc+se,ce=re.offset+re.size*se;!f.glEnabledAttribLocs[le]&&le>=0&&(d.enableVertexAttribArray(le),f.glEnabledAttribLocs[le]=!0),f.glCurrentAttribLocs[le]=!0,d.vertexAttribPointer(le,re.count,re.glType,re.isNormalized,re.stride,ce),d.vertexAttribDivisor(le,re.isInstanced?1:0)}}}var ue=i.gpuIndexBuffer;ue&&f.glElementArrayBuffer!==ue.glBuffer&&(d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,ue.glBuffer),f.glElementArrayBuffer=ue.glBuffer);for(var he=0;he<e.maxVertexAttributes;++he)f.glEnabledAttribLocs[he]!==f.glCurrentAttribLocs[he]&&(d.disableVertexAttribArray(he),f.glEnabledAttribLocs[he]=!1)}if(t&&t.dynamicStates.length)for(var _e=t.dynamicStates.length,de=0;de<_e;de++){switch(t.dynamicStates[de]){case gs.VIEWPORT:a&&(f.viewport.left===a.left&&f.viewport.top===a.top&&f.viewport.width===a.width&&f.viewport.height===a.height||(d.viewport(a.left,a.top,a.width,a.height),f.viewport.left=a.left,f.viewport.top=a.top,f.viewport.width=a.width,f.viewport.height=a.height));break;case gs.SCISSOR:o&&(f.scissorRect.x===o.x&&f.scissorRect.y===o.y&&f.scissorRect.width===o.width&&f.scissorRect.height===o.height||(d.scissor(o.x,o.y,o.width,o.height),f.scissorRect.x=o.x,f.scissorRect.y=o.y,f.scissorRect.width=o.width,f.scissorRect.height=o.height));break;case gs.LINE_WIDTH:s&&f.rs.lineWidth!==s&&(d.lineWidth(s),f.rs.lineWidth=s);break;case gs.DEPTH_BIAS:l&&(f.rs.depthBias===l.constantFactor&&f.rs.depthBiasSlop===l.slopeFactor||(d.polygonOffset(l.constantFactor,l.slopeFactor),f.rs.depthBias=l.constantFactor,f.rs.depthBiasSlop=l.slopeFactor));break;case gs.BLEND_CONSTANTS:f.bs.blendColor.x===c[0]&&f.bs.blendColor.y===c[1]&&f.bs.blendColor.z===c[2]&&f.bs.blendColor.w===c[3]||(d.blendColor(c[0],c[1],c[2],c[3]),f.bs.blendColor.x=c[0],f.bs.blendColor.y=c[1],f.bs.blendColor.z=c[2],f.bs.blendColor.w=c[3]);break;case gs.STENCIL_WRITE_MASK:if(h)switch(h.face){case ys.FRONT:f.dss.stencilWriteMaskFront!==h.writeMask&&(d.stencilMaskSeparate(d.FRONT,h.writeMask),f.dss.stencilWriteMaskFront=h.writeMask);break;case ys.BACK:f.dss.stencilWriteMaskBack!==h.writeMask&&(d.stencilMaskSeparate(d.BACK,h.writeMask),f.dss.stencilWriteMaskBack=h.writeMask);break;case ys.ALL:f.dss.stencilWriteMaskFront===h.writeMask&&f.dss.stencilWriteMaskBack===h.writeMask||(d.stencilMask(h.writeMask),f.dss.stencilWriteMaskFront=h.writeMask,f.dss.stencilWriteMaskBack=h.writeMask)}break;case gs.STENCIL_COMPARE_MASK:if(_)switch(_.face){case ys.FRONT:f.dss.stencilRefFront===_.reference&&f.dss.stencilReadMaskFront===_.compareMask||(d.stencilFuncSeparate(d.FRONT,RV[f.dss.stencilFuncFront],_.reference,_.compareMask),f.dss.stencilRefFront=_.reference,f.dss.stencilReadMaskFront=_.compareMask);break;case ys.BACK:f.dss.stencilRefBack===_.reference&&f.dss.stencilReadMaskBack===_.compareMask||(d.stencilFuncSeparate(d.BACK,RV[f.dss.stencilFuncBack],_.reference,_.compareMask),f.dss.stencilRefBack=_.reference,f.dss.stencilReadMaskBack=_.compareMask);break;case ys.ALL:f.dss.stencilRefFront===_.reference&&f.dss.stencilReadMaskFront===_.compareMask&&f.dss.stencilRefBack===_.reference&&f.dss.stencilReadMaskBack===_.compareMask||(d.stencilFunc(RV[f.dss.stencilFuncBack],_.reference,_.compareMask),f.dss.stencilRefFront=_.reference,f.dss.stencilReadMaskFront=_.compareMask,f.dss.stencilRefBack=_.reference,f.dss.stencilReadMaskBack=_.compareMask)}}}}function VV(e,t){var i=e.gl,n=UV.gpuInputAssembler,r=UV.glPrimitive;if(n)if(n.gpuIndirectBuffer)for(var a=n.gpuIndirectBuffer.indirects,o=0;o<a.length;o++){var s=a[o],l=n.gpuIndexBuffer;if(s.instanceCount)if(l){if(s.indexCount>0){var c=s.firstIndex*l.stride;i.drawElementsInstanced(r,s.indexCount,n.glIndexType,c,s.instanceCount)}}else s.vertexCount>0&&i.drawArraysInstanced(r,s.firstVertex,s.vertexCount,s.instanceCount);else if(l){if(s.indexCount>0){var u=s.firstIndex*l.stride;i.drawElements(r,s.indexCount,n.glIndexType,u)}}else s.vertexCount>0&&i.drawArrays(r,s.firstVertex,s.vertexCount)}else if(t.instanceCount)if(n.gpuIndexBuffer){if(t.indexCount>0){var h=t.firstIndex*n.gpuIndexBuffer.stride;i.drawElementsInstanced(r,t.indexCount,n.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&i.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(n.gpuIndexBuffer){if(t.indexCount>0){var _=t.firstIndex*n.gpuIndexBuffer.stride;i.drawElements(r,t.indexCount,n.glIndexType,_)}}else t.vertexCount>0&&i.drawArrays(r,t.firstVertex,t.vertexCount)}var WV=new Array(wV.COUNT);function jV(e,t){WV.fill(0);for(var i=0;i<t.cmds.length;++i){var n=t.cmds.array[i],r=WV[n]++;switch(n){case wV.BEGIN_RENDER_PASS:var a=t.beginRenderPassCmds.array[r];GV(e,a.gpuRenderPass,a.gpuFramebuffer,a.renderArea,a.clearColors,a.clearDepth,a.clearStencil);break;case wV.BIND_STATES:var o=t.bindStatesCmds.array[r];HV(e,o.gpuPipelineState,o.gpuInputAssembler,o.gpuDescriptorSets,o.dynamicOffsets,o.viewport,o.scissor,o.lineWidth,o.depthBias,o.blendConstants,o.depthBounds,o.stencilWriteMask,o.stencilCompareMask);break;case wV.DRAW:VV(e,t.drawCmds.array[r].drawInfo);break;case wV.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];zV(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case wV.COPY_BUFFER_TO_TEXTURE:var l=t.copyBufferToTextureCmds.array[r];qV(e,l.buffers,l.gpuTexture,l.regions)}}}function qV(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var o=0,s=1,l=1,c=0,u=Ds[i.format].isCompressed;switch(i.glTarget){case r.TEXTURE_2D:for(var h=0;h<n.length;h++){var _=n[h];s=_.texExtent.width,l=_.texExtent.height;var d=t[o++];u?i.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,l,i.glFormat,d):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,i.glInternalFmt,s,l,0,d):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,l,i.glFormat,i.glType,d)}break;case r.TEXTURE_CUBE_MAP:for(var f=0;f<n.length;f++){var p=n[f],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(c=p.texSubres.baseArrayLayer;c<m;++c){s=p.texExtent.width,l=p.texExtent.height;var v=t[o++];u?i.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,l,i.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,p.texSubres.mipLevel,i.glInternalFmt,s,l,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+c,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,l,i.glFormat,i.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&us.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var XV,YV,KV,ZV,QV,JV,$V,eW,tW,iW,nW,rW,aW,oW,sW,lW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuBuffer=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&qo.INDIRECT&&(this._indirectBuffer=new js),this._flags&Yo.BAKUP_BUFFER&&(this._bakcupBuffer=new Uint8Array(this._size),this._device.memoryStatus.bufferSize+=this._size),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,indirects:[],glTarget:0,glBuffer:null,glOffset:0},e.usage&qo.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),function(e,t){var i=e.gl,n=e.stateCache,r=t.memUsage&Xo.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(t.usage&qo.VERTEX){t.glTarget=i.ARRAY_BUFFER;var a=i.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=UV.gpuInputAssembler=null),e.stateCache.glArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),i.bufferData(i.ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&qo.INDEX){t.glTarget=i.ELEMENT_ARRAY_BUFFER;var o=i.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.useVAO&&n.glVAO&&(i.bindVertexArray(null),n.glVAO=UV.gpuInputAssembler=null),e.stateCache.glElementArrayBuffer!==t.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&qo.UNIFORM){t.glTarget=i.UNIFORM_BUFFER;var s=i.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(i.bindBuffer(i.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),i.bufferData(i.UNIFORM_BUFFER,t.size,r),i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&qo.INDIRECT||t.usage&qo.TRANSFER_DST||t.usage&qo.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),t.glTarget=i.NONE}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}},{key:"destroy",value:function(){this._gpuBuffer&&(this._isBufferView||(!function(e,t){var i=e.gl;if(t.glBuffer){switch(t.glTarget){case i.ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(i.bindVertexArray(null),e.stateCache.glVAO=UV.gpuInputAssembler=null),i.bindBuffer(i.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:e.useVAO&&e.stateCache.glVAO&&(i.bindVertexArray(null),e.stateCache.glVAO=UV.gpuInputAssembler=null),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case i.UNIFORM_BUFFER:i.bindBuffer(i.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}i.deleteBuffer(t.glBuffer),t.glBuffer=null}}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null),this._bakcupBuffer=null}},{key:"resize",value:function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;if(t!==e){if(this._size=e,this._count=this._size/this._stride,this._bakcupBuffer){var i=this._bakcupBuffer;this._bakcupBuffer=new Uint8Array(this._size),this._bakcupBuffer.set(i),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e}var n,r,a,o,s;this._gpuBuffer&&(this._bakcupBuffer&&(this._gpuBuffer.buffer=this._bakcupBuffer),this._gpuBuffer.size=e,e>0&&(n=this._device,r=this._gpuBuffer,a=n.gl,o=n.stateCache,s=r.memUsage&Xo.HOST?a.DYNAMIC_DRAW:a.STATIC_DRAW,r.usage&qo.VERTEX?(n.useVAO&&o.glVAO&&(a.bindVertexArray(null),o.glVAO=UV.gpuInputAssembler=null),o.glArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ARRAY_BUFFER,r.buffer,s):a.bufferData(a.ARRAY_BUFFER,r.size,s),a.bindBuffer(a.ARRAY_BUFFER,null),o.glArrayBuffer=null):r.usage&qo.INDEX?(n.useVAO&&o.glVAO&&(a.bindVertexArray(null),o.glVAO=UV.gpuInputAssembler=null),n.stateCache.glElementArrayBuffer!==r.glBuffer&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.buffer,s):a.bufferData(a.ELEMENT_ARRAY_BUFFER,r.size,s),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),n.stateCache.glElementArrayBuffer=null):r.usage&qo.UNIFORM?(n.stateCache.glUniformBuffer!==r.glBuffer&&a.bindBuffer(a.UNIFORM_BUFFER,r.glBuffer),a.bufferData(a.UNIFORM_BUFFER,r.size,s),a.bindBuffer(a.UNIFORM_BUFFER,null),n.stateCache.glUniformBuffer=null):(r.usage&qo.INDIRECT||r.usage&qo.TRANSFER_DST||r.usage&qo.TRANSFER_SRC||console.error("Unsupported GFXBufferType, create buffer failed."),r.glTarget=a.NONE),this._device.memoryStatus.bufferSize-=t,this._device.memoryStatus.bufferSize+=e))}}}},{key:"update",value:function(e,t,i){if(this._isBufferView)console.warn("cannot update through buffer views!");else{var n;if(n=void 0!==i?i:this._usage&qo.INDIRECT?0:e.byteLength,this._bakcupBuffer&&e!==this._bakcupBuffer.buffer){var r=new Uint8Array(e,0,i);this._bakcupBuffer.set(r,t)}zV(this._device,this._gpuBuffer,e,t||0,n)}}},{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(Ys),cW=function(){function e(t,n){i(this,e),this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(n),this._freeCmds=new Gi(n);for(var r=0;r<n;++r)this._frees[r]=new t;this._freeIdx=n-1}return r(e,[{key:"alloc",value:function(e){if(this._freeIdx<0){var t=2*this._frees.length,i=this._frees;this._frees=new Array(t);for(var n=t-i.length,r=0;r<n;++r)this._frees[r]=new e;for(var a=n,o=0;a<t;++a,++o)this._frees[a]=i[o];this._freeIdx+=n}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s}},{key:"free",value:function(e){0==--e.refCount&&this._freeCmds.push(e)}},{key:"freeCmds",value:function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])}},{key:"release",value:function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()}}]),e}(),uW=function(){function e(){i(this,e),this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new cW(kV,1),this.bindStatesCmdPool=new cW(DV,1),this.drawCmdPool=new cW(BV,1),this.updateBufferCmdPool=new cW(LV,1),this.copyBufferToTextureCmdPool=new cW(NV,1)}return r(e,[{key:"clearCmds",value:function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()}},{key:"releaseCmds",value:function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}]),e}(),hW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).cmdPackage=new FV,n._webGLAllocator=null,n._isInRenderPass=!1,n._curGPUPipelineState=null,n._curGPUDescriptorSets=[],n._curGPUInputAssembler=null,n._curDynamicOffsets=[],n._curViewport=null,n._curScissor=null,n._curLineWidth=null,n._curDepthBias=null,n._curBlendConstants=[],n._curDepthBounds=null,n._curStencilWriteMask=null,n._curStencilCompareMask=null,n._isStateInvalied=!1,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._type=e.type,this._queue=e.queue,this._webGLAllocator=this._device.cmdAllocator;for(var t=this._device.bindingMappingInfo.bufferOffsets.length,i=0;i<t;i++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0}},{key:"destroy",value:function(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}},{key:"begin",value:function(e){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(var t=0;t<this._curDynamicOffsets.length;t++)this._curDynamicOffsets[t].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}},{key:"end",value:function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}},{key:"beginRenderPass",value:function(e,t,i,n,r,a){var o=this._webGLAllocator.beginRenderPassCmdPool.alloc(kV);o.gpuRenderPass=e.gpuRenderPass,o.gpuFramebuffer=t.gpuFramebuffer,o.renderArea=i;for(var s=0;s<n.length;++s)o.clearColors[s]=n[s];o.clearDepth=r,o.clearStencil=a,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(wV.BEGIN_RENDER_PASS),this._isInRenderPass=!0}},{key:"endRenderPass",value:function(){this._isInRenderPass=!1}},{key:"bindPipelineState",value:function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)}},{key:"bindDescriptorSet",value:function(e,t,i){var n=t.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=n,this._isStateInvalied=!0),i){for(var r=this._curDynamicOffsets[e],a=0;a<i.length;a++)r[a]=i[a];r.length=i.length,this._isStateInvalied=!0}}},{key:"bindInputAssembler",value:function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0}},{key:"setViewport",value:function(e){this._curViewport?this._curViewport.left===e.left&&this._curViewport.top===e.top&&this._curViewport.width===e.width&&this._curViewport.height===e.height&&this._curViewport.minDepth===e.minDepth&&this._curViewport.maxDepth===e.maxDepth||(this._curViewport.left=e.left,this._curViewport.top=e.top,this._curViewport.width=e.width,this._curViewport.height=e.height,this._curViewport.minDepth=e.minDepth,this._curViewport.maxDepth=e.maxDepth,this._isStateInvalied=!0):this._curViewport=new bs(e.left,e.top,e.width,e.height,e.minDepth,e.maxDepth)}},{key:"setScissor",value:function(e){this._curScissor?this._curScissor.x===e.x&&this._curScissor.y===e.y&&this._curScissor.width===e.width&&this._curScissor.height===e.height||(this._curScissor.x=e.x,this._curScissor.y=e.y,this._curScissor.width=e.width,this._curScissor.height=e.height,this._isStateInvalied=!0):this._curScissor=new Es(e.x,e.y,e.width,e.height)}},{key:"setLineWidth",value:function(e){this._curLineWidth!==e&&(this._curLineWidth=e,this._isStateInvalied=!0)}},{key:"setDepthBias",value:function(e,t,i){this._curDepthBias?this._curDepthBias.constantFactor===e&&this._curDepthBias.clamp===t&&this._curDepthBias.slopeFactor===i||(this._curDepthBias.constantFactor=e,this._curDepthBias.clamp=t,this._curDepthBias.slopeFactor=i,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:e,clamp:t,slopeFactor:i},this._isStateInvalied=!0)}},{key:"setBlendConstants",value:function(e){4!==e.length||this._curBlendConstants[0]===e[0]&&this._curBlendConstants[1]===e[1]&&this._curBlendConstants[2]===e[2]&&this._curBlendConstants[3]===e[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,e),this._isStateInvalied=!0)}},{key:"setDepthBound",value:function(e,t){this._curDepthBounds&&this._curDepthBounds.minBounds===e&&this._curDepthBounds.maxBounds===t||(this._curDepthBounds={minBounds:e,maxBounds:t},this._isStateInvalied=!0)}},{key:"setStencilWriteMask",value:function(e,t){this._curStencilWriteMask?this._curStencilWriteMask.face===e&&this._curStencilWriteMask.writeMask===t||(this._curStencilWriteMask.face=e,this._curStencilWriteMask.writeMask=t,this._isStateInvalied=!0):(this._curStencilWriteMask={face:e,writeMask:t},this._isStateInvalied=!0)}},{key:"setStencilCompareMask",value:function(e,t,i){this._curStencilCompareMask?this._curStencilCompareMask.face===e&&this._curStencilCompareMask.reference===t&&this._curStencilCompareMask.compareMask===i||(this._curStencilCompareMask.face=e,this._curStencilCompareMask.reference=t,this._curStencilCompareMask.compareMask=i,this._isStateInvalied=!0):(this._curStencilCompareMask={face:e,reference:t,compareMask:i},this._isStateInvalied=!0)}},{key:"draw",value:function(e){if(this._type===ds.PRIMARY&&this._isInRenderPass||this._type===ds.SECONDARY){this._isStateInvalied&&this.bindStates();var t=this._webGLAllocator.drawCmdPool.alloc(BV);t.drawInfo.vertexCount=e.vertexCount,t.drawInfo.firstVertex=e.firstVertex,t.drawInfo.indexCount=e.indexCount,t.drawInfo.firstIndex=e.firstIndex,t.drawInfo.vertexOffset=e.vertexOffset,t.drawInfo.instanceCount=e.instanceCount,t.drawInfo.firstInstance=e.firstInstance,this.cmdPackage.drawCmds.push(t),this.cmdPackage.cmds.push(wV.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._type===ds.PRIMARY&&!this._isInRenderPass||this._type===ds.SECONDARY){var r=e.gpuBuffer;if(r){var a=this._webGLAllocator.updateBufferCmdPool.alloc(LV),o=0,s=null;e.usage&qo.INDIRECT||(o=void 0!==n?n:t.byteLength),s=t,a.gpuBuffer=r,a.buffer=s,a.offset=void 0!==i?i:0,a.size=o,this.cmdPackage.updateBufferCmds.push(a),this.cmdPackage.cmds.push(wV.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}},{key:"copyBuffersToTexture",value:function(e,t,i){if(this._type===ds.PRIMARY&&!this._isInRenderPass||this._type===ds.SECONDARY){var n=t.gpuTexture;if(n){var r=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(NV);r.gpuTexture=n,r.regions=i,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(wV.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){for(var n=e[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var a=n.cmdPackage.beginRenderPassCmds.array[r];++a.refCount,this.cmdPackage.beginRenderPassCmds.push(a)}for(var o=0;o<n.cmdPackage.bindStatesCmds.length;++o){var s=n.cmdPackage.bindStatesCmds.array[o];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var l=0;l<n.cmdPackage.drawCmds.length;++l){var c=n.cmdPackage.drawCmds.array[l];++c.refCount,this.cmdPackage.drawCmds.push(c)}for(var u=0;u<n.cmdPackage.updateBufferCmds.length;++u){var h=n.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<n.cmdPackage.copyBufferToTextureCmds.length;++_){var d=n.cmdPackage.copyBufferToTextureCmds.array[_];++d.refCount,this.cmdPackage.copyBufferToTextureCmds.push(d)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){var e=this._webGLAllocator.bindStatesCmdPool.alloc(DV);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets);for(var t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets[t]);e.gpuInputAssembler=this._curGPUInputAssembler,e.viewport=this._curViewport,e.scissor=this._curScissor,e.lineWidth=this._curLineWidth,e.depthBias=this._curDepthBias,Array.prototype.push.apply(e.blendConstants,this._curBlendConstants),e.depthBounds=this._curDepthBounds,e.stencilWriteMask=this._curStencilWriteMask,e.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(wV.BIND_STATES),this._isStateInvalied=!1}},{key:"webGLDevice",get:function(){return this._device}}]),t}(Zs),_W=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._sync=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){return!0}},{key:"destroy",value:function(){}},{key:"wait",value:function(){if(this._sync){var e=this._device.gl;e.clientWaitSync(this._sync,0,e.TIMEOUT_IGNORED)}}},{key:"reset",value:function(){this._sync&&(this._device.gl.deleteSync(this._sync),this._sync=null)}},{key:"insert",value:function(){var e=this._device.gl;this._sync&&e.deleteSync(this._sync),this._sync=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0)}}]),t}(Vl),dW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuFramebuffer=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null,0!==e.depStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0.");for(var t=0;t<e.colorMipmapLevels.length;++t)0!==e.colorMipmapLevels[t]&&console.warn("The mipmap level of th texture image to be attached of color attachment ".concat(t," should be 0. Convert to 0."));for(var i=[],n=0;n<e.colorTextures.length;n++){var r=e.colorTextures[n];r&&i.push(r.gpuTexture)}var a=null;return e.depthStencilTexture&&(a=e.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:i,gpuDepthStencilTexture:a,glFramebuffer:null},function(e,t){if(t.gpuColorTextures.length||t.gpuDepthStencilTexture){var i=e.gl,n=[],r=i.createFramebuffer();if(r){t.glFramebuffer=r,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var o=t.gpuColorTextures[a];o&&(o.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,o.glTarget,o.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,o.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+a))}var s=t.gpuDepthStencilTexture;if(s){var l=Ds[s.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,s.glRenderbuffer)}i.drawBuffers(n);var c=i.checkFramebufferStatus(i.FRAMEBUFFER);if(c!==i.FRAMEBUFFER_COMPLETE)switch(c){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}}(this._device,this._gpuFramebuffer),!0}},{key:"destroy",value:function(){var e,t;this._gpuFramebuffer&&(e=this._device,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),t.glFramebuffer=null),this._gpuFramebuffer=null)}},{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(tl),fW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuInputAssembler=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){if(0===e.vertexBuffers.length)return console.error("GFXInputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{var t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var i=new Array(e.vertexBuffers.length),n=0;n<e.vertexBuffers.length;++n){var r=e.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var a=null,o=0;if(e.indexBuffer&&(a=e.indexBuffer.gpuBuffer))switch(a.stride){case 1:o=5121;break;case 2:o=5123;break;case 4:o=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;return e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:i,gpuIndexBuffer:a,gpuIndirectBuffer:s,glAttribs:[],glIndexType:o,glVAOs:new Map},function(e,t){var i=e.gl;t.glAttribs=new Array(t.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var a=t.attributes[r],o=void 0!==a.stream?a.stream:0,s=t.gpuVertexBuffers[o],l=xV(a.format,i),c=Ds[a.format].size;t.glAttribs[r]={name:a.name,glBuffer:s.glBuffer,glType:l,size:c,count:Ds[a.format].count,stride:s.stride,componentCount:CV(l,i),isNormalized:void 0!==a.isNormalized&&a.isNormalized,isInstanced:void 0!==a.isInstanced&&a.isInstanced,offset:n[o]},n[o]+=c}}(this._device,this._gpuInputAssembler),!0}},{key:"destroy",value:function(){var e=this._device;this._gpuInputAssembler&&e.useVAO&&function(e,t){for(var i=t.glVAOs.values(),n=i.next();!n.done;)e.gl.deleteVertexArray(n.value),n=i.next();t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null}},{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(sl),pW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuDescriptorSetLayout=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,i=0;i<this._bindings.length;i++){var n=this._bindings[i];this._descriptorIndices.push(t),t+=n.count}this._descriptorIndices.push(t);for(var r=[],a=0;a<this._bindings.length;a++){var o=this._bindings[a];if(o.descriptorType&zl)for(var s=0;s<o.count;s++)r.push(a)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:r,descriptorIndices:this._descriptorIndices,descriptorCount:t},!0}},{key:"destroy",value:function(){this._bindings.length=0}},{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(Ul),mW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuPipelineLayout=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],i=[],n=[],r=0,a=0,o=0;o<this._setLayouts.length;o++){var s=this._setLayouts[o],l=s.gpuDescriptorSetLayout.dynamicBindings,c=s.bindings,u=[];i.push(s.gpuDescriptorSetLayout);for(var h=0,_=0;h<c.length;h++)if(l[_]===h)for(u.push(a);l[_]===h;)_++,a++;else u.push(-1);t.push(u),n.push(r),r+=l.length}return this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetCount:r,dynamicOffsetOffsets:n,dynamicOffsetIndices:t},!0}},{key:"destroy",value:function(){this._setLayouts.length=0}},{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Hl),vW=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],gW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuPipelineState=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout,this._rs=e.rasterizerState,this._dss=e.depthStencilState,this._bs=e.blendState,this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var t=[],i=0;i<31;i++)this._dynamicStates&1<<i&&t.push(1<<i);return this._gpuPipelineState={glPrimitive:vW[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:t},!0}},{key:"destroy",value:function(){this._gpuPipelineState=null}},{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(fl),yW=[],xW=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"beginRenderPass",value:function(e,t,i,n,r,a){GV(this._device,e.gpuRenderPass,t.gpuFramebuffer,i,n,r,a),this._isInRenderPass=!0}},{key:"draw",value:function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),VV(this._device,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var t=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=t/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(t-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}},{key:"updateBuffer",value:function(e,t,i,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var r,a=e.gpuBuffer;if(a)void 0===i&&(i=0),r=void 0!==n?n:e.usage&qo.INDIRECT?0:t.byteLength,zV(this._device,a,t,i,r)}}},{key:"copyBuffersToTexture",value:function(e,t,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var n=t.gpuTexture;n&&qV(this._device,e,n,i)}}},{key:"execute",value:function(e,t){for(var i=0;i<t;++i){var n=e[i];jV(this._device,n.cmdPackage),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}}},{key:"bindStates",value:function(){yW.length=0;for(var e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(yW,this._curDynamicOffsets[e]);HV(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,yW,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1}}]),t}(hW),SW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).numDrawCalls=0,n.numInstances=0,n.numTris=0,n}return o(t,e),r(t,[{key:"initialize",value:function(e){return this._type=e.type,!0}},{key:"destroy",value:function(){}},{key:"submit",value:function(e,t){if(!this._isAsync)for(var i=0;i<e.length;i++){var n=e[i];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}t&&t.insert()}},{key:"clear",value:function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}]),t}(ml),TW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuRenderPass=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){return this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,e.subPasses&&(this._subPasses=e.subPasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}},{key:"destroy",value:function(){this._gpuRenderPass=null}},{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(xl),EW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuSampler=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){var t,i,n,r;return this._minFilter=e.minFilter,this._magFilter=e.magFilter,this._mipFilter=e.mipFilter,this._addressU=e.addressU,this._addressV=e.addressV,this._addressW=e.addressW,this._maxAnisotropy=e.maxAnisotropy,this._cmpFunc=e.cmpFunc,this._borderColor=e.borderColor,this._minLOD=e.minLOD,this._maxLOD=e.maxLOD,this._mipLODBias=e.mipLODBias,this._gpuSampler={glSampler:null,minFilter:this._minFilter,magFilter:this._magFilter,mipFilter:this._mipFilter,addressU:this._addressU,addressV:this._addressV,addressW:this._addressW,minLOD:this._minLOD,maxLOD:this._maxLOD,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},t=this._device,i=this._gpuSampler,n=t.gl,(r=n.createSampler())&&(i.minFilter===as.LINEAR||i.minFilter===as.ANISOTROPIC?i.mipFilter===as.LINEAR||i.mipFilter===as.ANISOTROPIC?i.glMinFilter=n.LINEAR_MIPMAP_LINEAR:i.mipFilter===as.POINT?i.glMinFilter=n.LINEAR_MIPMAP_NEAREST:i.glMinFilter=n.LINEAR:i.mipFilter===as.LINEAR||i.mipFilter===as.ANISOTROPIC?i.glMinFilter=n.NEAREST_MIPMAP_LINEAR:i.mipFilter===as.POINT?i.glMinFilter=n.NEAREST_MIPMAP_NEAREST:i.glMinFilter=n.NEAREST,i.magFilter===as.LINEAR||i.magFilter===as.ANISOTROPIC?i.glMagFilter=n.LINEAR:i.glMagFilter=n.NEAREST,i.glWrapS=vV[i.addressU],i.glWrapT=vV[i.addressV],i.glWrapR=vV[i.addressW],i.glSampler=r,n.samplerParameteri(r,n.TEXTURE_MIN_FILTER,i.glMinFilter),n.samplerParameteri(r,n.TEXTURE_MAG_FILTER,i.glMagFilter),n.samplerParameteri(r,n.TEXTURE_WRAP_S,i.glWrapS),n.samplerParameteri(r,n.TEXTURE_WRAP_T,i.glWrapT),n.samplerParameteri(r,n.TEXTURE_WRAP_R,i.glWrapR),n.samplerParameterf(r,n.TEXTURE_MIN_LOD,i.minLOD),n.samplerParameterf(r,n.TEXTURE_MAX_LOD,i.maxLOD)),!0}},{key:"destroy",value:function(){var e,t;this._gpuSampler&&(e=this._device,(t=this._gpuSampler).glSampler&&(e.gl.deleteSampler(t.glSampler),t.glSampler=null),this._gpuSampler=null)}},{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Tl),bW=function(e){function n(){var e,t;i(this,n);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(t=u(this,(e=s(n)).call.apply(e,[this].concat(a))))._gpuShader=null,t}return o(n,e),r(n,[{key:"initialize",value:function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks,samplers:e.samplers,gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(var i=0;i<e.stages.length;++i){var n=e.stages[i];this._gpuShader.gpuStages[i]={type:n.stage,source:n.source,glShader:null}}return function(e,i){for(var n=e.gl,r=function(e){var t=i.gpuStages[e],r=0,a="",o=1;switch(t.type){case hs.VERTEX:a="VertexShader",r=n.VERTEX_SHADER;break;case hs.FRAGMENT:a="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported GFXShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(t.glShader=s,n.shaderSource(t.glShader,"#version 300 es\n"+t.source),n.compileShader(t.glShader),!n.getShaderParameter(t.glShader,n.COMPILE_STATUS))){console.error(a+" in '"+i.name+"' compilation failed."),console.error("Shader source dump:",t.source.replace(/^|\n/g,(function(){return"\n".concat(o++," ")}))),console.error(n.getShaderInfoLog(t.glShader));for(var l=0;l<i.gpuStages.length;l++){var c=i.gpuStages[e];c.glShader&&(n.deleteShader(c.glShader),c.glShader=null)}return{v:void 0}}},a=0;a<i.gpuStages.length;a++){var o=r(a);if("object"===t(o))return o.v}var s=n.createProgram();if(s){i.glProgram=s;for(var l=0;l<i.gpuStages.length;l++){var c=i.gpuStages[l];n.attachShader(i.glProgram,c.glShader)}n.linkProgram(i.glProgram);for(var u=0;u<i.gpuStages.length;u++){var h=i.gpuStages[u];h.glShader&&(n.detachShader(i.glProgram,h.glShader),n.deleteShader(h.glShader),h.glShader=null)}if(!n.getProgramParameter(i.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+i.name+"'."),void console.error(n.getProgramInfoLog(i.glProgram));console.info("Shader '"+i.name+"' compilation succeeded.");var _=n.getProgramParameter(i.glProgram,n.ACTIVE_ATTRIBUTES);i.glInputs=new Array(_);for(var d=0;d<_;++d){var f=n.getActiveAttrib(i.glProgram,d);if(f){var p=void 0,m=f.name.indexOf("[");p=-1!==m?f.name.substr(0,m):f.name;var v=n.getAttribLocation(i.glProgram,p),g=bV(f.type,n),y=AV(f.type,n);i.glInputs[d]={name:p,type:g,stride:y,count:f.size,size:y*f.size,glType:f.type,glLoc:v}}}var x,S,T,E,b=n.getProgramParameter(i.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(b){i.glBlocks=new Array(b);for(var A=0;A<b;++A){var C=(x=n.getActiveUniformBlockName(i.glProgram,A)).indexOf("[");-1!==C&&(x=x.substr(0,C)),E=null;for(var w=0;w<i.blocks.length;w++)if(i.blocks[w].name===x){E=i.blocks[w];break}if(E){S=A,T=n.getActiveUniformBlockParameter(i.glProgram,S,n.UNIFORM_BLOCK_DATA_SIZE);var R=E.binding+(e.bindingMappingInfo.bufferOffsets[E.set]||0);n.uniformBlockBinding(i.glProgram,S,R),i.glBlocks[A]={set:E.set,binding:E.binding,idx:S,name:x,size:T,glBinding:R}}else k("Block '".concat(x,"' does not bound"))}}if(i.samplers.length>0){i.glSamplers=new Array(i.samplers.length);for(var I=0;I<i.samplers.length;++I){var O=i.samplers[I];i.glSamplers[I]={set:O.set,binding:O.binding,name:O.name,type:O.type,count:O.count,units:[],glUnits:null,glType:EV(O.type,n),glLoc:null}}}for(var M=[],P=[],D=e.bindingMappingInfo,B=e.stateCache.texUnitCacheMap,L=0,N=0;N<i.blocks.length;++N)i.blocks[N].set===D.flexibleSet&&L++;for(var F=0,z=0;z<i.samplers.length;++z){var U=i.samplers[z],G=n.getUniformLocation(i.glProgram,U.name);if(G&&(M.push(i.glSamplers[z]),P.push(G)),void 0===B[U.name]){var H=U.binding+D.samplerOffsets[U.set]+F;U.set===D.flexibleSet&&(H-=L),B[U.name]=H%e.maxTextureUnits,F+=U.count-1}}if(M.length){for(var V=[],W=0;W<M.length;++W){var j=M[W],q=B[j.name];if(void 0!==q){j.glLoc=P[W];for(var X=0;X<j.count;++X){for(;V[q];)q=(q+1)%e.maxTextureUnits;j.units.push(q),V[q]=!0}}}for(var Y=0,K=0;K<M.length;++K){var Z=M[K];if(!Z.glLoc){for(Z.glLoc=P[K];V[Y];)Y++;for(var Q=0;Q<Z.count;++Q){for(;V[Y];)Y=(Y+1)%e.maxTextureUnits;void 0===B[Z.name]&&(B[Z.name]=Y),Z.units.push(Y),V[Y]=!0}}}e.stateCache.glProgram!==i.glProgram&&n.useProgram(i.glProgram);for(var J=0;J<M.length;J++){var $=M[J];$.glUnits=new Int32Array($.units),n.uniform1iv($.glLoc,$.glUnits)}e.stateCache.glProgram!==i.glProgram&&n.useProgram(e.stateCache.glProgram)}i.glSamplers=M}}(this._device,this._gpuShader),!0}},{key:"destroy",value:function(){var e,t;this._gpuShader&&(e=this._device,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),t.glProgram=null),this._gpuShader=null)}},{key:"gpuShader",get:function(){return this._gpuShader}}]),n}(Rl),AW=function(){function e(){i(this,e),this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new bs,this.scissorRect=new Es(0,0,0,0),this.rs=new ll,this.dss=new cl,this.bs=new hl,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return r(e,[{key:"initialize",value:function(e,t,i){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=i,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=i,this.glCurrentAttribLocs.fill(!1)}}]),e}(),CW=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._gpuTexture=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){return"texture"in e?(console.log("WebGL2 does not support texture view."),!1):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=Ol(this._width)&&Ol(this._height),this._size=Ls(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._flags&us.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(e,t){var i=e.gl;t.glInternalFmt=SV(t.format,i),t.glFormat=TV(t.format,i),t.glType=xV(t.format,i);var n=t.width,r=t.height;switch(t.type){case ss.TEX2D:t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&V(9100,a,e.maxTextureSize),t.samples===cs.X1){var o=i.createTexture();if(o&&t.size>0){t.glTexture=o;var s=e.stateCache.glTexUnits[e.stateCache.texUnit];if(s.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),s.glTexture=t.glTexture),Ds[t.format].isCompressed)if(t.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL)for(var l=0;l<t.mipLevel;++l){var c=Bs(t.format,n,r,1),u=new Uint8Array(c);i.compressedTexImage2D(i.TEXTURE_2D,l,t.glInternalFmt,n,r,0,u),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var h=Bs(t.format,2,2,1),_=new Uint8Array(h);i.compressedTexImage2D(i.TEXTURE_2D,0,t.glInternalFmt,2,2,0,_)}else for(var d=0;d<t.mipLevel;++d)i.texImage2D(i.TEXTURE_2D,d,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else i.deleteTexture(o)}else{var f=i.createRenderbuffer();f&&t.size>0&&(t.glRenderbuffer=f,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,gV[t.samples],t.glInternalFmt,t.width,t.height))}break;case ss.CUBE:t.glTarget=i.TEXTURE_CUBE_MAP;var p=Math.max(n,r);p>e.maxCubeMapTextureSize&&V(9100,p,e.maxTextureSize);var m=i.createTexture();if(m&&t.size>0){t.glTexture=m;var v=e.stateCache.glTexUnits[e.stateCache.texUnit];if(v.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),v.glTexture=t.glTexture),Ds[t.format].isCompressed)if(t.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL)for(var g=0;g<6;++g){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y){var x=Bs(t.format,n,r,1),S=new Uint8Array(x);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+g,y,t.glInternalFmt,n,r,0,S),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var T=0;T<6;++T){var E=Bs(t.format,2,2,1),b=new Uint8Array(E);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+T,0,t.glInternalFmt,2,2,0,b)}else for(var A=0;A<6;++A){n=t.width,r=t.height;for(var C=0;C<t.mipLevel;++C)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+A,C,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=ss.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}},{key:"destroy",value:function(){var e,t;this._gpuTexture&&(e=this._device,(t=this._gpuTexture).glTexture&&(e.gl.deleteTexture(t.glTexture),t.glTexture=null),t.glRenderbuffer&&(e.gl.deleteRenderbuffer(t.glRenderbuffer),t.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._buffer=null}},{key:"resize",value:function(e,t){var i=this._size;this._width=e,this._height=t,this._size=Ls(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){var i=e.gl;t.glInternalFmt=SV(t.format,i),t.glFormat=TV(t.format,i),t.glType=xV(t.format,i);var n=t.width,r=t.height;switch(t.type){case ss.TEX2D:t.glTarget=i.TEXTURE_2D;var a=Math.max(n,r);if(a>e.maxTextureSize&&V(9100,a,e.maxTextureSize),t.samples===cs.X1){var o=e.stateCache.glTexUnits[e.stateCache.texUnit];if(o.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_2D,t.glTexture),o.glTexture=t.glTexture),Ds[t.format].isCompressed){if(t.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL)for(var s=0;s<t.mipLevel;++s){var l=Bs(t.format,n,r,1),c=new Uint8Array(l);i.compressedTexImage2D(i.TEXTURE_2D,s,t.glInternalFmt,n,r,0,c),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var u=0;u<t.mipLevel;++u)i.texImage2D(i.TEXTURE_2D,u,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else{var h=i.createRenderbuffer();h&&t.size>0&&(t.glRenderbuffer=h,e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),i.renderbufferStorageMultisample(i.RENDERBUFFER,gV[t.samples],t.glInternalFmt,t.width,t.height))}break;case ss.CUBE:t.type=ss.CUBE,t.glTarget=i.TEXTURE_CUBE_MAP;var _=Math.max(n,r);_>e.maxCubeMapTextureSize&&V(9100,_,e.maxTextureSize);var d=e.stateCache.glTexUnits[e.stateCache.texUnit];if(d.glTexture!==t.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,t.glTexture),d.glTexture=t.glTexture),Ds[t.format].isCompressed){if(t.glInternalFmt!==yH.COMPRESSED_RGB_ETC1_WEBGL)for(var f=0;f<6;++f){n=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var m=Bs(t.format,n,r,1),v=new Uint8Array(m);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,t.glInternalFmt,n,r,0,v),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}}else for(var g=0;g<6;++g){n=t.width,r=t.height;for(var y=0;y<t.mipLevel;++y)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+g,y,t.glInternalFmt,n,r,0,t.glFormat,t.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported GFXTextureType, create texture failed."),t.type=ss.TEX2D,t.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size)}},{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Pl),wW=e("WebGL2Device",function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).stateCache=new AW,n.cmdAllocator=new uW,n.nullTex2D=null,n.nullTexCube=null,n._webGL2RC=null,n._isAntialias=!0,n._isPremultipliedAlpha=!0,n._useVAO=!0,n._bindingMappingInfo=new Qs,n._webGLContextLostHandler=null,n._extensions=null,n._EXT_texture_filter_anisotropic=null,n._OES_texture_float_linear=null,n._OES_texture_half_float_linear=null,n._EXT_color_buffer_float=null,n._EXT_disjoint_timer_query_webgl2=null,n._WEBGL_compressed_texture_etc1=null,n._WEBGL_compressed_texture_etc=null,n._WEBGL_compressed_texture_pvrtc=null,n._WEBGL_compressed_texture_astc=null,n._WEBGL_compressed_texture_s3tc=null,n._WEBGL_compressed_texture_s3tc_srgb=null,n._WEBGL_debug_renderer_info=null,n._WEBGL_texture_storage_multisample=null,n._WEBGL_debug_shaders=null,n._WEBGL_lose_context=null,n}return o(t,e),r(t,[{key:"initialize",value:function(e){this._canvas=e.canvasElm,this._isAntialias=e.isAntialias,this._isPremultipliedAlpha=e.isPremultipliedAlpha,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{var t={alpha:Sh.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGL2RC=this._canvas.getContext("webgl2",t)}catch(e){return console.warn(e),!1}if(!this._webGL2RC)return console.warn("This device does not support WebGL2."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener("webglcontextlost",this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL2 device initialized."),this._gfxAPI=Us.WEBGL2,this._deviceName="WebGL2";var i=this._webGL2RC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=i.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=i.getParameter(i.RENDERER),this._vendor=i.getParameter(i.VENDOR)),this._version=i.getParameter(i.VERSION),this._maxVertexAttributes=i.getParameter(i.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxUniformBufferBindings=i.getParameter(i.MAX_UNIFORM_BUFFER_BINDINGS),this._maxUniformBlockSize=i.getParameter(i.MAX_UNIFORM_BLOCK_SIZE),this._maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),this._uboOffsetAlignment=i.getParameter(i.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this._depthBits=i.getParameter(i.DEPTH_BITS),this._stencilBits=i.getParameter(i.STENCIL_BITS),this.stateCache.initialize(this._maxTextureUnits,this._maxUniformBufferBindings,this._maxVertexAttributes),this._devicePixelRatio=e.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(e.nativeWidth||this._width,0),this._nativeHeight=Math.max(e.nativeHeight||this._height,0),this._colorFmt=jo.RGBA8,32===this._depthBits?8===this._stencilBits?this._depthStencilFmt=jo.D32F_S8:this._depthStencilFmt=jo.D32F:24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=jo.D24S8:this._depthStencilFmt=jo.D24:8===this._stencilBits?this._depthStencilFmt=jo.D16S8:this._depthStencilFmt=jo.D16,this._extensions=i.getSupportedExtensions();var n="";if(this._extensions){for(var r,a=y(this._extensions);!(r=a()).done;){n+=r.value+" "}console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_color_buffer_float=this.getExtension("EXT_color_buffer_float"),this._EXT_disjoint_timer_query_webgl2=this.getExtension("EXT_disjoint_timer_query_webgl2"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_texture_storage_multisample=this.getExtension("WEBGL_texture_storage_multisample"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._features.fill(!1),this._features[Gs.TEXTURE_FLOAT]=!0,this._features[Gs.TEXTURE_HALF_FLOAT]=!0,this._features[Gs.FORMAT_R11G11B10F]=!0,this._features[Gs.FORMAT_RGB8]=!0,this._features[Gs.FORMAT_D16]=!0,this._features[Gs.FORMAT_D24]=!0,this._features[Gs.FORMAT_D32F]=!0,this._features[Gs.FORMAT_D24S8]=!0,this._features[Gs.FORMAT_D32FS8]=!0,this._features[Gs.MSAA]=!0,this._features[Gs.ELEMENT_INDEX_UINT]=!0,this._features[Gs.INSTANCED_ARRAYS]=!0,this._EXT_color_buffer_float&&(this._features[Gs.COLOR_FLOAT]=!0,this._features[Gs.COLOR_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[Gs.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[Gs.TEXTURE_HALF_FLOAT_LINEAR]=!0);var o="";this._WEBGL_compressed_texture_etc1&&(this._features[Gs.FORMAT_ETC1]=!0,o+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[Gs.FORMAT_ETC2]=!0,o+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[Gs.FORMAT_DXT]=!0,o+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[Gs.FORMAT_PVRTC]=!0,o+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[Gs.FORMAT_ASTC]=!0,o+="astc "),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info("SCREEN_SIZE: "+this._width+" x "+this._height),console.info("NATIVE_SIZE: "+this._nativeWidth+" x "+this._nativeHeight),console.info("MAX_VERTEX_ATTRIBS: "+this._maxVertexAttributes),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("MAX_FRAGMENT_UNIFORM_VECTORS: "+this._maxFragmentUniformVectors),console.info("MAX_TEXTURE_IMAGE_UNITS: "+this._maxTextureUnits),console.info("MAX_VERTEX_TEXTURE_IMAGE_UNITS: "+this._maxVertexTextureUnits),console.info("MAX_UNIFORM_BUFFER_BINDINGS: "+this._maxUniformBufferBindings),console.info("MAX_UNIFORM_BLOCK_SIZE: "+this._maxUniformBlockSize),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),console.info("UNIFORM_BUFFER_OFFSET_ALIGNMENT: "+this._uboOffsetAlignment),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+o),this.initStates(i),this._queue=this.createQueue(new pl(xs.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Ks(this._queue)),this.nullTex2D=this.createTexture(new Il(ss.TEX2D,ls.SAMPLED,jo.RGBA8,2,2,us.GEN_MIPMAP)),this.nullTexCube=new CW(this),this.nullTexCube.initialize(new Il(ss.TEX2D,ls.SAMPLED,jo.RGBA8,2,2,us.CUBEMAP|us.GEN_MIPMAP,6));var s=new Ms;s.texExtent.width=2,s.texExtent.height=2;var l=new Uint8Array(this.nullTex2D.size);return l.fill(0),this.copyBuffersToTexture([l],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([l,l,l,l,l,l],this.nullTexCube,[s]),!0}},{key:"destroy",value:function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener("webglcontextlost",this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGL2RC=null}},{key:"resize",value:function(e,t){this._width===e&&this._height===t||(console.info("Resizing device: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._width=e,this._height=t)}},{key:"acquire",value:function(){this.cmdAllocator.releaseCmds()}},{key:"present",value:function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()}},{key:"createCommandBuffer",value:function(e){var t=new(e.type===ds.PRIMARY?xW:hW)(this);return t.initialize(e)?t:null}},{key:"createBuffer",value:function(e){var t=new lW(this);return t.initialize(e)?t:null}},{key:"createTexture",value:function(e){var t=new CW(this);return t.initialize(e)?t:null}},{key:"createSampler",value:function(e){var t=new EW(this);return t.initialize(e)?t:null}},{key:"createDescriptorSet",value:function(e){var t=new mV(this);return t.initialize(e)?t:null}},{key:"createShader",value:function(e){var t=new bW(this);return t.initialize(e)?t:null}},{key:"createInputAssembler",value:function(e){var t=new fW(this);return t.initialize(e)?t:null}},{key:"createRenderPass",value:function(e){var t=new TW(this);return t.initialize(e)?t:null}},{key:"createFramebuffer",value:function(e){var t=new dW(this);return t.initialize(e)?t:null}},{key:"createDescriptorSetLayout",value:function(e){var t=new pW(this);return t.initialize(e)?t:null}},{key:"createPipelineLayout",value:function(e){var t=new mW(this);return t.initialize(e)?t:null}},{key:"createPipelineState",value:function(e){var t=new gW(this);return t.initialize(e)?t:null}},{key:"createFence",value:function(e){var t=new _W(this);return t.initialize(e)?t:null}},{key:"createQueue",value:function(e){var t=new SW(this);return t.initialize(e)?t:null}},{key:"copyBuffersToTexture",value:function(e,t,i){qV(this,e,t.gpuTexture,i)}},{key:"copyTexImagesToTexture",value:function(e,t,i){!function(e,t,i,n){var r=e.gl,a=e.stateCache.glTexUnits[e.stateCache.texUnit];a.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),a.glTexture=i.glTexture);var o=0,s=0;switch(i.glTarget){case r.TEXTURE_2D:for(var l=0;l<n.length;l++){var c=n[l];r.texSubImage2D(r.TEXTURE_2D,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,i.glFormat,i.glType,t[o++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<n.length;u++){var h=n[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,i.glFormat,i.glType,t[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&us.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}(this,e,t.gpuTexture,i)}},{key:"copyFramebufferToBuffer",value:function(e,t,i){var n=this._webGL2RC,r=e.gpuFramebuffer,a=r.gpuColorTextures[0].format,o=TV(a,n),s=xV(a,n),l=zs(Ds[a]),c=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==r.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,r.glFramebuffer),this.stateCache.glFramebuffer=r.glFramebuffer);for(var u,h=new l(t),_=y(i);!(u=_()).done;){var d=u.value,f=d.texExtent.width,p=d.texExtent.height;n.readPixels(d.texOffset.x,d.texOffset.y,f,p,o,s,h)}this.stateCache.glFramebuffer!==c&&(n.bindFramebuffer(n.FRAMEBUFFER,c),this.stateCache.glFramebuffer=c)}},{key:"blitFramebuffer",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){var o=e.gl;e.stateCache.glReadFramebuffer!==t.glFramebuffer&&(o.bindFramebuffer(o.READ_FRAMEBUFFER,t.glFramebuffer),e.stateCache.glReadFramebuffer=t.glFramebuffer);var s=i.glFramebuffer!==e.stateCache.glFramebuffer;s&&o.bindFramebuffer(o.DRAW_FRAMEBUFFER,i.glFramebuffer);var l=0;t.gpuColorTextures.length>0&&(l|=o.COLOR_BUFFER_BIT),t.gpuDepthStencilTexture&&(l|=o.DEPTH_BUFFER_BIT,Ds[t.gpuDepthStencilTexture.format].hasStencil&&(l|=o.STENCIL_BUFFER_BIT));var c=a===as.LINEAR||a===as.ANISOTROPIC?o.LINEAR:o.NEAREST;o.blitFramebuffer(n.x,n.y,n.x+n.width,n.y+n.height,r.x,r.y,r.x+r.width,r.y+r.height,l,c),s&&o.bindFramebuffer(o.FRAMEBUFFER,e.stateCache.glFramebuffer)}(this,e.gpuFramebuffer,t.gpuFramebuffer,i,n,r)}},{key:"getExtension",value:function(e){for(var t=["","WEBKIT_","MOZ_"],i=0;i<t.length;++i){var n=this.gl.getExtension(t[i]+e);if(n)return n}return null}},{key:"initStates",value:function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}},{key:"_onWebGLContextLost",value:function(e){G(11e3),P(e)}},{key:"gl",get:function(){return this._webGL2RC}},{key:"isAntialias",get:function(){return this._isAntialias}},{key:"isPremultipliedAlpha",get:function(){return this._isPremultipliedAlpha}},{key:"useVAO",get:function(){return this._useVAO}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}},{key:"EXT_texture_filter_anisotropic",get:function(){return this._EXT_texture_filter_anisotropic}},{key:"OES_texture_float_linear",get:function(){return this._OES_texture_float_linear}},{key:"EXT_color_buffer_float",get:function(){return this._EXT_color_buffer_float}},{key:"EXT_disjoint_timer_query_webgl2",get:function(){return this._EXT_disjoint_timer_query_webgl2}},{key:"WEBGL_compressed_texture_etc1",get:function(){return this._WEBGL_compressed_texture_etc1}},{key:"WEBGL_compressed_texture_etc",get:function(){return this._WEBGL_compressed_texture_etc}},{key:"WEBGL_compressed_texture_pvrtc",get:function(){return this._WEBGL_compressed_texture_pvrtc}},{key:"WEBGL_compressed_texture_s3tc",get:function(){return this._WEBGL_compressed_texture_s3tc}},{key:"WEBGL_compressed_texture_s3tc_srgb",get:function(){return this._WEBGL_compressed_texture_s3tc_srgb}},{key:"WEBGL_texture_storage_multisample",get:function(){return this._WEBGL_texture_storage_multisample}},{key:"WEBGL_debug_shaders",get:function(){return this._WEBGL_debug_shaders}},{key:"WEBGL_lose_context",get:function(){return this._WEBGL_lose_context}}]),t}($s));E.WebGL2Device=wW;var RW,IW,OW,MW,PW,kW,DW,BW,LW,NW,FW,zW,UW,GW,HW,VW,WW,jW,qW,XW,YW,KW,ZW,QW,JW,$W,ej,tj,ij,nj,rj,aj,oj=e("BillboardComponent",(XV=ii("cc.Billboard"),YV=mi("i18n:cc.Billboard"),KV=_i("Components/Billboard"),ZV=Li(Oh),QV=Li(Oh),JV=Si("billboard"),$V=Si("billboard"),eW=Si("billboard"),tW=Si("billboard"),XV(iW=YV(iW=KV(iW=hi((rW=S((nW=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_texture",rW,c(e)),x(e,"_height",aW,c(e)),x(e,"_width",oW,c(e)),x(e,"_rotation",sW,c(e)),e._model=null,e._mesh=null,e._material=null,e._uniform=new ua(1,1,0,0),e}return o(t,e),r(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*Sn(this._rotation))/100},set:function(e){this._rotation=xn(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),r(t,[{key:"onLoad",value:function(){this.createModel()}},{key:"onEnable",value:function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture}},{key:"onDisable",value:function(){this.detachFromScene()}},{key:"attachToScene",value:function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"createModel",value:function(){this._mesh=uT({primitiveMode:Zo.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[Ma.WHITE.r,Ma.WHITE.g,Ma.WHITE.b,Ma.WHITE.a,Ma.WHITE.r,Ma.WHITE.g,Ma.WHITE.b,Ma.WHITE.a,Ma.WHITE.r,Ma.WHITE.g,Ma.WHITE.b,Ma.WHITE.a,Ma.WHITE.r,Ma.WHITE.g,Ma.WHITE.b,Ma.WHITE.a],attributes:[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_TEX_COORD,jo.RG32F),new al(Vo.ATTR_COLOR,jo.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var e=this._model=E.director.root.createModel(zb,this.node);e.node=e.transform=this.node,null==this._material&&(this._material=new sm,this._material.copy(tf.get("default-billboard-material"))),e.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)}}]),t}(Yr)).prototype,"_texture",[ZV],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(nW.prototype,"texture",[QV,JV],Object.getOwnPropertyDescriptor(nW.prototype,"texture"),nW.prototype),aW=S(nW.prototype,"_height",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S(nW.prototype,"height",[$V],Object.getOwnPropertyDescriptor(nW.prototype,"height"),nW.prototype),oW=S(nW.prototype,"_width",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S(nW.prototype,"width",[eW],Object.getOwnPropertyDescriptor(nW.prototype,"width"),nW.prototype),sW=S(nW.prototype,"_rotation",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S(nW.prototype,"rotation",[tW],Object.getOwnPropertyDescriptor(nW.prototype,"rotation"),nW.prototype),iW=nW))||iW)||iW)||iW)||iW)),sj=[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_TEX_COORD,jo.RGBA32F),new al(Vo.ATTR_TEX_COORD1,jo.RGB32F),new al(Vo.ATTR_COLOR,jo.RGBA8,!0)],lj=new oa,cj=new oa,uj=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e.type=Mb.LINE,e._capacity=100,e._iaInfo=new js([new Vs]),e._iaInfoBuffer=e._device.createBuffer(new qs(qo.INDIRECT,Xo.HOST|Xo.DEVICE,Ws,Ws)),e}return o(t,e),r(t,[{key:"setCapacity",value:function(e){this._capacity=e,this.createBuffer()}},{key:"createBuffer",value:function(){this._vertSize=0;for(var e,t=y(sj);!(e=t()).done;){var i=e.value;i.offset=this._vertSize,this._vertSize+=Ds[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"updateMaterial",value:function(e){this._material=e,_(s(t.prototype),"setSubModelMaterial",this).call(this,0,e)}},{key:"createSubMeshData",value:function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var a=2*r;i[n++]=a,i[n++]=a+1,i[n++]=a+2,i[n++]=a+3,i[n++]=a+2,i[n++]=a+1}var o=this._device.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return o.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new K_([e],sj,Zo.TRIANGLE_LIST,o,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t}},{key:"addLineVertexData",value:function(e,t,i){if(e.length>1){var n=0;oa.subtract(lj,e[1],e[0]),this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=lj.x,this._vdataF32[n++]=lj.y,this._vdataF32[n++]=lj.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=lj.x,this._vdataF32[n++]=lj.y,this._vdataF32[n++]=lj.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){oa.subtract(lj,e[r-1],e[r]),oa.subtract(cj,e[r+1],e[r]),oa.subtract(cj,cj,lj);var a=r/e.length;this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=0,this._vdataF32[n++]=cj.x,this._vdataF32[n++]=cj.y,this._vdataF32[n++]=cj.z,this._vdataUint32[n++]=i.evaluate(a,1)._val,this._vdataF32[n++]=e[r].x,this._vdataF32[n++]=e[r].y,this._vdataF32[n++]=e[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(a,1),this._vdataF32[n++]=a,this._vdataF32[n++]=1,this._vdataF32[n++]=cj.x,this._vdataF32[n++]=cj.y,this._vdataF32[n++]=cj.z,this._vdataUint32[n++]=i.evaluate(a,1)._val}oa.subtract(lj,e[e.length-1],e[e.length-2]),this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=lj.x,this._vdataF32[n++]=lj.y,this._vdataF32[n++]=lj.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=e[e.length-1].x,this._vdataF32[n++]=e[e.length-1].y,this._vdataF32[n++]=e[e.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=t.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=lj.x,this._vdataF32[n++]=lj.y,this._vdataF32[n++]=lj.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))}},{key:"updateIA",value:function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)}},{key:"destroySubMeshData",value:function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}]),t}(zb),hj=et({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),_j=e("CurveRange",(RW=ii("cc.CurveRange"),IW=Li(hj),OW=Li(du),MW=Li(du),PW=Li(du),RW((WW=VW=function(){function e(){i(this,e),x(this,"mode",BW,this),x(this,"curve",LW,this),x(this,"curveMin",NW,this),x(this,"curveMax",FW,this),x(this,"constant",zW,this),x(this,"constantMin",UW,this),x(this,"constantMax",GW,this),x(this,"multiplier",HW,this)}return r(e,[{key:"evaluate",value:function(e,t){switch(this.mode){case hj.Constant:return this.constant;case hj.Curve:return this.curve.evaluate(e)*this.multiplier;case hj.TwoCurves:return yn(this.curveMin.evaluate(e),this.curveMax.evaluate(e),t)*this.multiplier;case hj.TwoConstants:return yn(this.constantMin,this.constantMax,t)}}},{key:"getMax",value:function(){switch(this.mode){case hj.Constant:return this.constant;case hj.Curve:return this.multiplier;case hj.TwoConstants:return this.constantMax;case hj.TwoCurves:return this.multiplier}return 0}},{key:"_onBeforeSerialize",value:function(e){return(!1)[this.mode]}}]),e}(),VW.Mode=hj,BW=S((DW=WW).prototype,"mode",[IW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hj.Constant}}),LW=S(DW.prototype,"curve",[OW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new du}}),NW=S(DW.prototype,"curveMin",[MW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new du}}),FW=S(DW.prototype,"curveMax",[PW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new du}}),zW=S(DW.prototype,"constant",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UW=S(DW.prototype,"constantMin",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GW=S(DW.prototype,"constantMax",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HW=S(DW.prototype,"multiplier",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kW=DW))||kW));function dj(e,t,i){switch(e.mode){case hj.Constant:return e.constant;case hj.Curve:return e.curve.evaluate(t)*e.multiplier;case hj.TwoCurves:return 0===i?e.curveMin.evaluate(t)*e.multiplier:e.curveMax.evaluate(t)*e.multiplier;case hj.TwoConstants:return 0===i?e.constantMin:e.constantMax;default:return 0}}function fj(e){switch(e.mode){case hj.TwoConstants:case hj.TwoCurves:return 2;default:return 1}}function pj(e,t,i){var n=new $u({width:t,height:i,_data:e,_compressed:!1,format:Wu.RGBA32F}),r=new Oh;return r.setFilters(qu.NEAREST,qu.NEAREST),r.setMipFilter(qu.NONE),r.setWrapMode(ju.CLAMP_TO_EDGE,ju.CLAMP_TO_EDGE,ju.CLAMP_TO_EDGE),r.image=n,r}function mj(e,t,i,n,r){for(var a=Math.max(fj(t),fj(i),fj(n)),o=new Float32Array(e*a*4),s=[t,i,n],l=1/(e-1),c=0;c<a;c++)for(var u=0;u<3;u++)for(var h=s[u],_=0,d=0,f=0;f<e;f++){var p=dj(h,l*f,c);d=r?p:(_+=p)/(f+1),o[4*f+u]=d}return pj(o,e,a)}var vj,gj,yj,xj,Sj,Tj,Ej,bj,Aj,Cj,wj,Rj,Ij,Oj,Mj,Pj,kj,Dj,Bj,Lj,Nj,Fj,zj,Uj,Gj,Hj,Vj,Wj,jj,qj,Xj,Yj,Kj,Zj,Qj,Jj,$j,eq,tq,iq,nq,rq,aq,oq,sq,lq,cq,uq,hq,_q,dq,fq,pq,mq=et({Blend:0,Fixed:1}),vq=(ii("cc.ColorKey")((XW=S((qW=function e(){i(this,e),x(this,"color",XW,this),x(this,"time",YW,this)}).prototype,"color",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.WHITE.clone()}}),YW=S(qW.prototype,"time",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jW=qW)),ii("cc.AlphaKey")((QW=S((ZW=function e(){i(this,e),x(this,"alpha",QW,this),x(this,"time",JW,this)}).prototype,"alpha",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),JW=S(ZW.prototype,"time",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KW=ZW)),ii("cc.Gradient")((aj=rj=function(){function e(){i(this,e),x(this,"colorKeys",tj,this),x(this,"alphaKeys",ij,this),x(this,"mode",nj,this),this._color=void 0,this._color=Ma.WHITE.clone()}return r(e,[{key:"setKeys",value:function(e,t){this.colorKeys=e,this.alphaKeys=t}},{key:"sortKeys",value:function(){this.colorKeys.length>1&&this.colorKeys.sort((function(e,t){return e.time-t.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(e,t){return e.time-t.time}))}},{key:"evaluate",value:function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color}},{key:"randomColor",value:function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color}},{key:"getRGB",value:function(e){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(Ma.WHITE),this._color);e=In(e,1);for(var t=1;t<this.colorKeys.length;++t){var i=this.colorKeys[t-1].time,n=this.colorKeys[t].time;if(e>=i&&e<n){if(this.mode===mq.Fixed)return this.colorKeys[t].color;var r=(e-i)/(n-i);return Ma.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var a=this.colorKeys.length-1;e<this.colorKeys[0].time?Ma.lerp(this._color,Ma.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[a].time&&Ma.lerp(this._color,this.colorKeys[a].color,Ma.BLACK,(e-this.colorKeys[a].time)/(1-this.colorKeys[a].time))}},{key:"getAlpha",value:function(e){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=In(e,1);for(var t=1;t<this.alphaKeys.length;++t){var i=this.alphaKeys[t-1].time,n=this.alphaKeys[t].time;if(e>=i&&e<n){if(this.mode===mq.Fixed)return this.alphaKeys[t].alpha;var r=(e-i)/(n-i);return yn(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var a=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?yn(255,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[a].time?yn(this.alphaKeys[a].alpha,255,(e-this.alphaKeys[a].time)/(1-this.alphaKeys[a].time)):void 0}}]),e}(),rj.Mode=mq,tj=S((ej=aj).prototype,"colorKeys",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),ij=S(ej.prototype,"alphaKeys",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),nj=S(ej.prototype,"mode",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mq.Blend}}),$W=ej))||$W),gq=et({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),yq=(vj=ii("cc.GradientRange"),gj=Li(gq),yj=Li(vq),xj=Li(vq),Sj=Li(vq),Tj=Li(gq),vj((kj=Pj=function(){function e(){i(this,e),x(this,"color",Aj,this),x(this,"colorMin",Cj,this),x(this,"colorMax",wj,this),x(this,"gradient",Rj,this),x(this,"gradientMin",Ij,this),x(this,"gradientMax",Oj,this),x(this,"_mode",Mj,this),this._color=Ma.WHITE.clone()}return r(e,[{key:"evaluate",value:function(e,t){switch(this._mode){case gq.Color:return this.color;case gq.TwoColors:return Ma.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case gq.RandomColor:return this.gradient.randomColor();case gq.Gradient:return this.gradient.evaluate(e);case gq.TwoGradients:return Ma.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}}},{key:"_onBeforeSerialize",value:function(e){return(!1)[this._mode]}},{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),Pj.Mode=gq,S((bj=kj).prototype,"mode",[gj],Object.getOwnPropertyDescriptor(bj.prototype,"mode"),bj.prototype),Aj=S(bj.prototype,"color",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.WHITE.clone()}}),Cj=S(bj.prototype,"colorMin",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.WHITE.clone()}}),wj=S(bj.prototype,"colorMax",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.WHITE.clone()}}),Rj=S(bj.prototype,"gradient",[yj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vq}}),Ij=S(bj.prototype,"gradientMin",[xj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vq}}),Oj=S(bj.prototype,"gradientMax",[Sj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vq}}),Mj=S(bj.prototype,"_mode",[Tj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gq.Color}}),Ej=bj))||Ej);function xq(e,t,i){switch(e.mode){case gq.Color:return e.color;case gq.TwoColors:return 0===i?e.colorMin:e.colorMax;case gq.RandomColor:return e.gradient.randomColor();case gq.Gradient:return e.gradient.evaluate(t);case gq.TwoGradients:return 0===i?e.gradientMin.evaluate(t):e.gradientMax.evaluate(t);default:return e.color}}function Sq(e,t){for(var i=function(e){switch(e.mode){case gq.TwoColors:case gq.TwoGradients:return 2;default:return 1}}(t),n=new Uint8Array(e*i*4),r=1/(e-1),a=0,o=0;o<i;o++)for(var s=0;s<e;s++){var l=xq(t,r*s,o);n[a]=l.r,n[a+1]=l.g,n[a+2]=l.b,n[a+3]=l.a,a+=4}var c=new Oh;return c.create(e,i,Wu.RGBA8888),c.setFilters(qu.LINEAR,qu.LINEAR),c.setWrapMode(ju.CLAMP_TO_EDGE,ju.CLAMP_TO_EDGE),c.uploadData(n),c}var Tq,Eq,bq,Aq,Cq,wq,Rq,Iq,Oq,Mq,Pq,kq,Dq,Bq,Lq,Nq,Fq,zq,Uq,Gq,Hq,Vq,Wq,jq,qq,Xq,Yq,Kq,Zq,Qq,Jq,$q,eX={parent:null,owner:null,subModelIdx:0},tX={CC_USE_WORLD_SPACE:!1},iX=e("LineComponent",(Dj=ii("cc.Line"),Bj=mi("i18n:cc.Line"),Lj=_i("Components/Line"),Nj=Li(Oh),Fj=Li(Oh),zj=wi(0),Uj=Si(""),Gj=wi(1),Hj=Si(""),Vj=Li([oa]),Wj=Li([oa]),jj=wi(2),qj=Si(""),Xj=Li(_j),Yj=Li(_j),Kj=wi(3),Zj=Si(""),Qj=Li(ia),Jj=wi(4),$j=Si(""),eq=Li(ia),tq=wi(5),iq=Si(""),nq=Li(yq),rq=Li(yq),aq=wi(6),oq=Si(""),Dj(sq=Bj(sq=Lj(sq=hi((cq=S((lq=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_texture",cq,c(e)),e._material=null,e._materialInstance=null,x(e,"_worldSpace",uq,c(e)),x(e,"_positions",hq,c(e)),x(e,"_width",_q,c(e)),x(e,"_tile",dq,c(e)),x(e,"_offset",fq,c(e)),x(e,"_color",pq,c(e)),e._model=null,e._tile_offset=new ua,e}return o(t,e),r(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._materialInstance&&this._materialInstance.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._materialInstance&&(tX.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(tX),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),r(t,[{key:"onLoad",value:function(){var e=this._model=E.director.root.createModel(uj);e.node=e.transform=this.node,null==this._material&&(this._material=new sm,this._material.copy(tf.get("default-trail-material")),tX.CC_USE_WORLD_SPACE=this.worldSpace,eX.parent=this._material,eX.subModelIdx=0,this._materialInstance=new um(eX),this._materialInstance.recompileShaders(tX)),e.updateMaterial(this._materialInstance),e.setCapacity(100)}},{key:"onEnable",value:function(){this._model&&(this.attachToScene(),this.texture=this.texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))}},{key:"onDisable",value:function(){this._model&&this.detachFromScene()}},{key:"attachToScene",value:function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}}]),t}(Yr)).prototype,"_texture",[Nj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(lq.prototype,"texture",[Fj,zj,Uj],Object.getOwnPropertyDescriptor(lq.prototype,"texture"),lq.prototype),uq=S(lq.prototype,"_worldSpace",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(lq.prototype,"worldSpace",[Gj,Hj],Object.getOwnPropertyDescriptor(lq.prototype,"worldSpace"),lq.prototype),hq=S(lq.prototype,"_positions",[Vj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),S(lq.prototype,"positions",[Wj,jj,qj],Object.getOwnPropertyDescriptor(lq.prototype,"positions"),lq.prototype),_q=S(lq.prototype,"_width",[Xj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),S(lq.prototype,"width",[Yj,Kj,Zj],Object.getOwnPropertyDescriptor(lq.prototype,"width"),lq.prototype),dq=S(lq.prototype,"_tile",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ia(1,1)}}),S(lq.prototype,"tile",[Qj,Jj,$j],Object.getOwnPropertyDescriptor(lq.prototype,"tile"),lq.prototype),fq=S(lq.prototype,"_offset",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ia(0,0)}}),S(lq.prototype,"offset",[eq,tq,iq],Object.getOwnPropertyDescriptor(lq.prototype,"offset"),lq.prototype),pq=S(lq.prototype,"_color",[nq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yq}}),S(lq.prototype,"color",[rq,aq,oq],Object.getOwnPropertyDescriptor(lq.prototype,"color"),lq.prototype),sq=lq))||sq)||sq)||sq)||sq)),nX=function e(t){i(this,e),this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new oa(0,0,0),this.velocity=new oa(0,0,0),this.animatedVelocity=new oa(0,0,0),this.ultimateVelocity=new oa(0,0,0),this.angularVelocity=new oa(0,0,0),this.axisOfRotation=new oa(0,0,0),this.rotation=new oa(0,0,0),this.startSize=new oa(0,0,0),this.size=new oa(0,0,0),this.startColor=Ma.WHITE.clone(),this.color=Ma.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0},rX="colorModule",aX="forceModule",oX="limitModule",sX="rotationModule",lX="sizeModule",cX="velocityModule",uX="textureModule",hX=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],_X=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],dX=function(){function e(){i(this,e),this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}return r(e,[{key:"bindTarget",value:function(e){this.target=e}},{key:"update",value:function(e,t){}}]),e}(),fX=et({World:0,Local:1,Custom:2}),pX=et({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),mX=et({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),vX=et({Base:0,Edge:1,Shell:2,Volume:3}),gX=et({Random:0,Loop:1,PingPong:2}),yX=et({Particles:0}),xX=et({Stretch:0}),SX=23541,TX=39825,EX=90794,bX=212165,AX=125292,CX=197866,wX=156497,RX=984136,IX=91041,OX=(Tq=ii("cc.ColorOvertimeModule"),Eq=wi(0),bq=Li(yq),Aq=wi(1),Tq((Rq=S((wq=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_enable",Rq,c(n)),x(n,"color",Iq,c(n)),n.name=rX,n}return o(t,e),r(t,[{key:"animate",value:function(e){e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,An(e.randomSeed+IX)))}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(dX)).prototype,"_enable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(wq.prototype,"enable",[Eq],Object.getOwnPropertyDescriptor(wq.prototype,"enable"),wq.prototype),Iq=S(wq.prototype,"color",[bq,si,Aq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yq}}),Cq=wq))||Cq),MX=new oa(0,0,-1);function PX(e,t,i,n){return t!==e?(e===fX.World||Ta.invert(i,i),Ta.getRotation(n,i),!0):(pa.set(n,0,0,0,1),!1)}function kX(e,t){ia.set(e,Math.cos(t),Math.sin(t))}function DX(e){var t=En(-1,1),i=En(0,2*Math.PI),n=Math.sqrt(1-t*t),r=n*Math.cos(i),a=n*Math.sin(i);oa.set(e,r,a,t)}function BX(e,t,i){DX(e),oa.multiplyScalar(e,e,t+(i-t)*Tn())}function LX(e,t,i,n){kX(e,n),e.z=0,oa.multiplyScalar(e,e,t+(i-t)*Tn())}function NX(e){for(var t=0;t<e.length;t++){var i=t+bn(0,e.length-t),n=e[i];e[i]=e[t],e[t]=n}}function FX(){var e=En(-1,1);return 0===e&&e++,Zr(e)}var zX,UX,GX,HX,VX,WX,jX,qX,XX,YX,KX,ZX,QX,JX,$X,eY,tY,iY,nY,rY,aY,oY,sY,lY,cY,uY,hY,_Y,dY,fY,pY,mY,vY,gY,yY,xY,SY,TY,EY,bY,AY,CY,wY,RY,IY,OY,MY,PY,kY,DY,BY,LY,NY,FY,zY,UY,GY,HY,VY=bX,WY=new oa,jY=(Oq=ii("cc.ForceOvertimeModule"),Mq=wi(0),Pq=Li(_j),kq=Ti([-1,1]),Dq=wi(2),Bq=Si("X "),Lq=Li(_j),Nq=Ti([-1,1]),Fq=wi(3),zq=Si("Y "),Uq=Li(_j),Gq=Ti([-1,1]),Hq=wi(4),Vq=Si("Z "),Wq=Li(fX),jq=wi(1),qq=Si(""),Oq((Kq=S((Yq=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_enable",Kq,c(e)),x(e,"x",Zq,c(e)),x(e,"y",Qq,c(e)),x(e,"z",Jq,c(e)),x(e,"space",$q,c(e)),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name=aX,e.rotation=new pa,e.needTransform=!1,e.needUpdate=!0,e}return o(t,e),r(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),r(t,[{key:"update",value:function(e,t){this.needTransform=PX(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=oa.set(WY,this.x.evaluate(i,An(e.randomSeed+VY)),this.y.evaluate(i,An(e.randomSeed+VY)),this.z.evaluate(i,An(e.randomSeed+VY)));this.needTransform&&oa.transformQuat(n,n,this.rotation),oa.scaleAndAdd(e.velocity,e.velocity,n,t),oa.copy(e.ultimateVelocity,e.velocity)}}]),t}(dX)).prototype,"_enable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(Yq.prototype,"enable",[Mq],Object.getOwnPropertyDescriptor(Yq.prototype,"enable"),Yq.prototype),Zq=S(Yq.prototype,"x",[Pq,si,kq,Dq,Bq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),Qq=S(Yq.prototype,"y",[Lq,si,Nq,Fq,zq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),Jq=S(Yq.prototype,"z",[Uq,si,Gq,Hq,Vq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),$q=S(Yq.prototype,"space",[Wq,si,jq,qq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fX.Local}}),Xq=Yq))||Xq),qY=SX,XY=new oa,YY=new oa,KY=(zX=ii("cc.LimitVelocityOvertimeModule"),UX=wi(0),GX=Li(_j),HX=Ti([-1,1]),VX=wi(4),WX=Si("X "),jX=Li(_j),qX=Ti([-1,1]),XX=wi(5),YX=Si("Y "),KX=Li(_j),ZX=Ti([-1,1]),QX=wi(6),JX=Si("Z "),$X=Li(_j),eY=Ti([-1,1]),tY=wi(3),iY=Si(""),nY=wi(7),rY=Si(""),aY=wi(2),oY=Si(""),sY=Li(fX),lY=wi(1),cY=Si(""),zX((_Y=S((hY=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_enable",_Y,c(e)),x(e,"limitX",dY,c(e)),x(e,"limitY",fY,c(e)),x(e,"limitZ",pY,c(e)),x(e,"limit",mY,c(e)),x(e,"dampen",vY,c(e)),x(e,"separateAxes",gY,c(e)),x(e,"space",yY,c(e)),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name=oX,e.rotation=void 0,e.needTransform=void 0,e.rotation=new pa,e.needTransform=!1,e.needUpdate=!0,e}return o(t,e),r(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),r(t,[{key:"update",value:function(e,t){this.needTransform=PX(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=XY;this.separateAxes?(oa.set(YY,this.limitX.evaluate(i,An(e.randomSeed+qY)),this.limitY.evaluate(i,An(e.randomSeed+qY)),this.limitZ.evaluate(i,An(e.randomSeed+qY))),this.needTransform&&oa.transformQuat(YY,YY,this.rotation),oa.set(n,ZY(e.ultimateVelocity.x,YY.x,this.dampen),ZY(e.ultimateVelocity.y,YY.y,this.dampen),ZY(e.ultimateVelocity.z,YY.z,this.dampen))):(oa.normalize(n,e.ultimateVelocity),oa.multiplyScalar(n,n,ZY(e.ultimateVelocity.length(),this.limit.evaluate(i,An(e.randomSeed+qY)),this.dampen))),oa.copy(e.ultimateVelocity,n)}}]),t}(dX)).prototype,"_enable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(hY.prototype,"enable",[UX],Object.getOwnPropertyDescriptor(hY.prototype,"enable"),hY.prototype),dY=S(hY.prototype,"limitX",[GX,si,HX,VX,WX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),fY=S(hY.prototype,"limitY",[jX,si,qX,XX,YX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),pY=S(hY.prototype,"limitZ",[KX,si,ZX,QX,JX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),mY=S(hY.prototype,"limit",[$X,si,eY,tY,iY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),vY=S(hY.prototype,"dampen",[si,nY,rY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),gY=S(hY.prototype,"separateAxes",[si,aY,oY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yY=S(hY.prototype,"space",[sY,si,lY,cY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fX.Local}}),uY=hY))||uY);function ZY(e,t,i){var n=Math.sign(e),r=Math.abs(e);return r>t&&(r=yn(r,t,i)),r*n}var QY,JY,$Y,eK,tK,iK,nK,rK,aK,oK,sK,lK,cK,uK,hK,_K,dK,fK,pK,mK,vK,gK,yK,xK,SK,TK,EK,bK,AK,CK,wK,RK,IK,OK,MK,PK,kK,DK,BK,LK,NK,FK,zK,UK,GK,HK,VK,WK,jK,qK,XK,YK,KK,ZK,QK,JK,$K,eZ,tZ,iZ,nZ,rZ,aZ,oZ,sZ,lZ,cZ,uZ,hZ,_Z,dZ,fZ,pZ,mZ,vZ,gZ,yZ,xZ,SZ,TZ,EZ,bZ,AZ,CZ,wZ,RZ,IZ,OZ,MZ,PZ,kZ,DZ,BZ,LZ,NZ,FZ,zZ,UZ,GZ,HZ,VZ,WZ,jZ,qZ,XZ,YZ,KZ,ZZ,QZ,JZ,$Z,eQ,tQ,iQ,nQ,rQ,aQ,oQ,sQ,lQ,cQ,uQ,hQ,_Q,dQ,fQ,pQ,mQ,vQ,gQ,yQ,xQ,SQ,TQ,EQ,bQ,AQ,CQ,wQ,RQ,IQ,OQ,MQ,PQ,kQ,DQ,BQ,LQ,NQ,FQ,zQ,UQ,GQ,HQ,VQ,WQ,jQ,qQ,XQ,YQ,KQ,ZQ,QQ,JQ,$Q,eJ,tJ,iJ,nJ=AX,rJ=(xY=ii("cc.RotationOvertimeModule"),SY=wi(0),TY=wi(1),EY=Si(""),bY=Li(_j),AY=Ti([-1,1]),CY=wi(2),wY=Si(" X "),RY=Li(_j),IY=Ti([-1,1]),OY=wi(3),MY=Si(" Y "),PY=Li(_j),kY=Ti([-1,1]),DY=wi(4),BY=Si(" Z "),xY((FY=S((NY=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_enable",FY,c(n)),x(n,"_separateAxes",zY,c(n)),x(n,"x",UY,c(n)),x(n,"y",GY,c(n)),x(n,"z",HY,c(n)),n.name=sX,n}return o(t,e),r(t,[{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime;if(this._separateAxes){var n=An(e.randomSeed+nJ);e.rotation.x+=this.x.evaluate(i,n)*t,e.rotation.y+=this.y.evaluate(i,n)*t,e.rotation.z+=this.z.evaluate(i,n)*t}else e.rotation.z+=this.z.evaluate(i,An(e.randomSeed+nJ))*t}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),t}(dX)).prototype,"_enable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(NY.prototype,"enable",[SY],Object.getOwnPropertyDescriptor(NY.prototype,"enable"),NY.prototype),zY=S(NY.prototype,"_separateAxes",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(NY.prototype,"separateAxes",[TY,EY],Object.getOwnPropertyDescriptor(NY.prototype,"separateAxes"),NY.prototype),UY=S(NY.prototype,"x",[bY,si,AY,Ii,CY,wY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),GY=S(NY.prototype,"y",[RY,si,IY,Ii,OY,MY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),HY=S(NY.prototype,"z",[PY,si,kY,Ii,DY,BY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),LY=NY))||LY),aJ=TX,oJ=(QY=ii("cc.SizeOvertimeModule"),JY=wi(0),$Y=wi(1),eK=Si(""),tK=Li(_j),iK=wi(2),nK=Si(""),rK=Li(_j),aK=wi(3),oK=Si(" X "),sK=Li(_j),lK=wi(4),cK=Si(" Y "),uK=Li(_j),hK=wi(5),_K=Si(" Z "),QY((pK=S((fK=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_enable",pK,c(n)),x(n,"separateAxes",mK,c(n)),x(n,"size",vK,c(n)),x(n,"x",gK,c(n)),x(n,"y",yK,c(n)),x(n,"z",xK,c(n)),n.name=lX,n}return o(t,e),r(t,[{key:"animate",value:function(e,t){if(this.separateAxes){var i=1-e.remainingLifetime/e.startLifetime,n=An(e.randomSeed+aJ);e.size.x=e.startSize.x*this.x.evaluate(i,n),e.size.y=e.startSize.y*this.y.evaluate(i,n),e.size.z=e.startSize.z*this.z.evaluate(i,n)}else oa.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,An(e.randomSeed+aJ)))}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(dX)).prototype,"_enable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(fK.prototype,"enable",[JY],Object.getOwnPropertyDescriptor(fK.prototype,"enable"),fK.prototype),mK=S(fK.prototype,"separateAxes",[si,$Y,eK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vK=S(fK.prototype,"size",[tK,si,iK,nK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),gK=S(fK.prototype,"x",[rK,si,aK,oK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),yK=S(fK.prototype,"y",[sK,si,lK,cK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),xK=S(fK.prototype,"z",[uK,si,hK,_K],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),dK=fK))||dK),sJ=EX,lJ=et({Grid:0}),cJ=et({WholeSheet:0,SingleRow:1}),uJ=(SK=ii("cc.TextureAnimationModule"),TK=li("numTilesX"),EK=li("numTilesY"),bK=wi(0),AK=Li(lJ),CK=Li(lJ),wK=wi(1),RK=Si(" Grid "),IK=wi(2),OK=Si("X "),MK=wi(3),PK=Si("Y "),kK=Li(cJ),DK=wi(4),BK=Si(""),LK=Li(_j),NK=wi(7),FK=Si(""),zK=Li(_j),UK=wi(8),GK=Si(""),HK=wi(9),VK=Si(""),WK=wi(5),jK=Si("\n SingleRow "),qK=wi(6),XK=Si("\n SingleRow  randomRow "),SK((ZK=S((KK=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_enable",ZK,c(n)),x(n,"_numTilesX",QK,c(n)),x(n,"_numTilesY",JK,c(n)),x(n,"_mode",$K,c(n)),x(n,"animation",eZ,c(n)),x(n,"frameOverTime",tZ,c(n)),x(n,"startFrame",iZ,c(n)),x(n,"cycleCount",nZ,c(n)),x(n,"_flipU",rZ,c(n)),x(n,"_flipV",aZ,c(n)),x(n,"_uvChannelMask",oZ,c(n)),x(n,"randomRow",sZ,c(n)),x(n,"rowIndex",lZ,c(n)),n.name=uX,n}return o(t,e),r(t,[{key:"init",value:function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=this.startFrame.evaluate(i,An(e.randomSeed+sJ))/(this.numTilesX*this.numTilesY);if(this.animation===cJ.WholeSheet)e.frameIndex=In(this.cycleCount*(this.frameOverTime.evaluate(i,An(e.randomSeed+sJ))+n),1);else if(this.animation===cJ.SingleRow){var r=1/this.numTilesY;if(this.randomRow){var a=In(this.cycleCount*(this.frameOverTime.evaluate(i,An(e.randomSeed+sJ))+n),1),o=e.startRow*r,s=o+r;e.frameIndex=yn(o,s,a)}else{var l=this.rowIndex*r,c=l+r;e.frameIndex=yn(l,c,In(this.cycleCount*(this.frameOverTime.evaluate(i,An(e.randomSeed+sJ))+n),1))}}}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,e,this)))}},{key:"mode",get:function(){return this._mode},set:function(e){e===lJ.Grid||console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(e){this._numTilesX!==e&&(this._numTilesX=e,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(e){this._numTilesY!==e&&(this._numTilesY=e,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(e){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(e){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(e){console.error("particle texture animation's uvChannelMask is not supported!")}}]),t}(dX)).prototype,"_enable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QK=S(KK.prototype,"_numTilesX",[TK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JK=S(KK.prototype,"_numTilesY",[EK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S(KK.prototype,"enable",[bK],Object.getOwnPropertyDescriptor(KK.prototype,"enable"),KK.prototype),$K=S(KK.prototype,"_mode",[AK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lJ.Grid}}),S(KK.prototype,"mode",[CK,wK,RK],Object.getOwnPropertyDescriptor(KK.prototype,"mode"),KK.prototype),S(KK.prototype,"numTilesX",[IK,OK],Object.getOwnPropertyDescriptor(KK.prototype,"numTilesX"),KK.prototype),S(KK.prototype,"numTilesY",[MK,PK],Object.getOwnPropertyDescriptor(KK.prototype,"numTilesY"),KK.prototype),eZ=S(KK.prototype,"animation",[kK,si,DK,BK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cJ.WholeSheet}}),tZ=S(KK.prototype,"frameOverTime",[LK,si,NK,FK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),iZ=S(KK.prototype,"startFrame",[zK,si,UK,GK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),nZ=S(KK.prototype,"cycleCount",[si,HK,VK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rZ=S(KK.prototype,"_flipU",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aZ=S(KK.prototype,"_flipV",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oZ=S(KK.prototype,"_uvChannelMask",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),sZ=S(KK.prototype,"randomRow",[si,WK,jK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lZ=S(KK.prototype,"rowIndex",[si,qK,XK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YK=KK))||YK),hJ=CX,_J=wX,dJ=RX,fJ=new oa,pJ=(cZ=ii("cc.VelocityOvertimeModule"),uZ=wi(0),hZ=Li(_j),_Z=Ti([-1,1]),dZ=wi(2),fZ=Si("X "),pZ=Li(_j),mZ=Ti([-1,1]),vZ=wi(3),gZ=Si("Y "),yZ=Li(_j),xZ=Ti([-1,1]),SZ=wi(4),TZ=Si("Z "),EZ=Li(_j),bZ=Ti([-1,1]),AZ=wi(5),CZ=Si(" CPU "),wZ=Li(fX),RZ=wi(1),IZ=Si(""),cZ((PZ=S((MZ=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_enable",PZ,c(e)),x(e,"x",kZ,c(e)),x(e,"y",DZ,c(e)),x(e,"z",BZ,c(e)),x(e,"speedModifier",LZ,c(e)),x(e,"space",NZ,c(e)),e.rotation=void 0,e.needTransform=void 0,e.name=cX,e.rotation=new pa,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}return o(t,e),r(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),r(t,[{key:"update",value:function(e,t){this.needTransform=PX(e,this.space,t,this.rotation)}},{key:"animate",value:function(e,t){var i=1-e.remainingLifetime/e.startLifetime,n=oa.set(fJ,this.x.evaluate(i,An(e.randomSeed^hJ)),this.y.evaluate(i,An(e.randomSeed^_J)),this.z.evaluate(i,An(e.randomSeed^dJ)));this.needTransform&&oa.transformQuat(n,n,this.rotation),oa.add(e.animatedVelocity,e.animatedVelocity,n),oa.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),oa.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,An(e.randomSeed+hJ)))}}]),t}(dX)).prototype,"_enable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(MZ.prototype,"enable",[uZ],Object.getOwnPropertyDescriptor(MZ.prototype,"enable"),MZ.prototype),kZ=S(MZ.prototype,"x",[hZ,si,_Z,dZ,fZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),DZ=S(MZ.prototype,"y",[pZ,si,mZ,vZ,gZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),BZ=S(MZ.prototype,"z",[yZ,si,xZ,SZ,TZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),LZ=S(MZ.prototype,"speedModifier",[EZ,si,bZ,AZ,CZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),NZ=S(MZ.prototype,"space",[wZ,si,RZ,IZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fX.Local}}),OZ=MZ))||OZ),mJ=(FZ=ii("cc.Burst"),zZ=Li(_j),FZ((HZ=S((GZ=function(){function e(){i(this,e),x(this,"_time",HZ,this),x(this,"_repeatCount",VZ,this),x(this,"repeatInterval",WZ,this),x(this,"count",jZ,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}return r(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),r(e,[{key:"update",value:function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var i=In(e._time-e.startDelay.evaluate(0,1),e.duration)-t;i=i>0?i:0;var n=In(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=i&&this._curTime<n&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(n-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},{key:"getMaxCount",value:function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)}}]),e}()).prototype,"_time",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S(GZ.prototype,"time",[vi],Object.getOwnPropertyDescriptor(GZ.prototype,"time"),GZ.prototype),VZ=S(GZ.prototype,"_repeatCount",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),S(GZ.prototype,"repeatCount",[vi],Object.getOwnPropertyDescriptor(GZ.prototype,"repeatCount"),GZ.prototype),WZ=S(GZ.prototype,"repeatInterval",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),jZ=S(GZ.prototype,"count",[zZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),UZ=GZ))||UZ),vJ=new oa(0,0,0),gJ=new Array,yJ=new oa(.5,.5,.5),xJ=(qZ=ii("cc.ShapeModule"),XZ=wi(13),YZ=Si(""),KZ=wi(14),ZZ=Si(""),QZ=wi(15),JZ=Si(""),$Z=wi(6),eQ=Si(""),tQ=wi(5),iQ=Si("\n"),nQ=wi(0),rQ=Li(mX),aQ=li("shapeType"),oQ=wi(1),sQ=Li(mX),lQ=Si(""),cQ=Li(vX),uQ=wi(2),hQ=Si(""),_Q=wi(16),dQ=Si(""),fQ=wi(17),pQ=Si(""),mQ=wi(18),vQ=Si(""),gQ=wi(19),yQ=Si(" 0 "),xQ=wi(3),SQ=Si(""),TQ=wi(4),EQ=Si(" Box :\n - 0 \n - 1 \n - 0 ~ 1 "),bQ=Li(gX),AQ=wi(7),CQ=Si(""),wQ=wi(9),RQ=Si(""),IQ=Li(_j),OQ=wi(10),MQ=Si(""),PQ=wi(11),kQ=Si("\n"),DQ=wi(12),BQ=Si(" Box "),qZ((S((NQ=function(){function e(){i(this,e),x(this,"_enable",FQ,this),x(this,"_shapeType",zQ,this),x(this,"emitFrom",UQ,this),x(this,"alignToDirection",GQ,this),x(this,"randomDirectionAmount",HQ,this),x(this,"sphericalDirectionAmount",VQ,this),x(this,"randomPositionAmount",WQ,this),x(this,"radius",jQ,this),x(this,"radiusThickness",qQ,this),x(this,"arcMode",XQ,this),x(this,"arcSpread",YQ,this),x(this,"arcSpeed",KQ,this),x(this,"length",ZQ,this),x(this,"boxThickness",QQ,this),x(this,"_position",JQ,this),x(this,"_rotation",$Q,this),x(this,"_scale",eJ,this),x(this,"_arc",tJ,this),x(this,"_angle",iJ,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new Ta,this.quat=new pa,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}return r(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return Sn(this._arc)},set:function(e){this._arc=xn(e)}},{key:"angle",get:function(){return Math.round(100*Sn(this._angle))/100},set:function(e){this._angle=xn(e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case mX.Box:this.emitFrom===vX.Base&&(this.emitFrom=vX.Volume);break;case mX.Cone:this.emitFrom===vX.Edge&&(this.emitFrom=vX.Base);break;case mX.Sphere:case mX.Hemisphere:this.emitFrom!==vX.Base&&this.emitFrom!==vX.Edge||(this.emitFrom=vX.Volume)}}}]),r(e,[{key:"onInit",value:function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time}},{key:"emit",value:function(e){switch(this.shapeType){case mX.Box:!function(e,t,i,n){switch(e){case vX.Volume:r=i,a=yJ,oa.set(r,En(-a.x,a.x),En(-a.y,a.y),En(-a.z,a.z));break;case vX.Shell:gJ.splice(0,gJ.length),gJ.push(En(-.5,.5)),gJ.push(En(-.5,.5)),gJ.push(.5*FX()),NX(gJ),SJ(gJ,t),oa.set(i,gJ[0],gJ[1],gJ[2]);break;case vX.Edge:gJ.splice(0,gJ.length),gJ.push(En(-.5,.5)),gJ.push(.5*FX()),gJ.push(.5*FX()),NX(gJ),SJ(gJ,t),oa.set(i,gJ[0],gJ[1],gJ[2]);break;default:console.warn(e+" is not supported for box emitter.")}var r,a;oa.copy(n,MX)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case mX.Circle:!function(e,t,i,n,r){LX(n,e*(1-t),e,i),oa.normalize(r,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case mX.Cone:!function(e,t,i,n,r,a,o,s){switch(e){case vX.Base:LX(o,t*(1-i),t,n),ia.multiplyScalar(s,o,Math.sin(r)),s.z=-Math.cos(r)*t,oa.normalize(s,s),o.z=0;break;case vX.Shell:kX(o,n),ia.multiplyScalar(s,o,Math.sin(r)),s.z=-Math.cos(r),oa.normalize(s,s),ia.multiplyScalar(o,o,t),o.z=0;break;case vX.Volume:LX(o,t*(1-i),t,n),ia.multiplyScalar(s,o,Math.sin(r)),s.z=-Math.cos(r)*t,oa.normalize(s,s),o.z=0,oa.add(o,o,oa.multiplyScalar(vJ,s,a*Tn()/-s.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case mX.Sphere:!function(e,t,i,n,r){switch(e){case vX.Volume:BX(n,t*(1-i),t),oa.normalize(r,n);break;case vX.Shell:DX(n),oa.multiplyScalar(n,n,t),oa.normalize(r,n);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case mX.Hemisphere:!function(e,t,i,n,r){switch(e){case vX.Volume:BX(n,t*(1-i),t),n.z>0&&(n.z*=-1),oa.normalize(r,n);break;case vX.Shell:DX(n),oa.multiplyScalar(n,n,t),n.z>0&&(n.z*=-1),oa.normalize(r,n);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(e.position.x+=En(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=En(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=En(-this.randomPositionAmount,this.randomPositionAmount)),oa.transformQuat(e.velocity,e.velocity,this.quat),oa.transformMat4(e.position,e.position,this.mat),this.sphericalDirectionAmount>0){var t=oa.normalize(vJ,e.position);oa.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time}},{key:"constructMat",value:function(){pa.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),Ta.fromRTS(this.mat,this.quat,this._position,this._scale)}},{key:"generateArcAngle",value:function(){if(this.arcMode===gX.Random)return En(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case gX.Loop:return In(e,this._arc);case gX.PingPong:return On(e,this._arc)}}}]),e}()).prototype,"position",[XZ,YZ],Object.getOwnPropertyDescriptor(NQ.prototype,"position"),NQ.prototype),S(NQ.prototype,"rotation",[KZ,ZZ],Object.getOwnPropertyDescriptor(NQ.prototype,"rotation"),NQ.prototype),S(NQ.prototype,"scale",[QZ,JZ],Object.getOwnPropertyDescriptor(NQ.prototype,"scale"),NQ.prototype),S(NQ.prototype,"arc",[$Z,eQ],Object.getOwnPropertyDescriptor(NQ.prototype,"arc"),NQ.prototype),S(NQ.prototype,"angle",[tQ,iQ],Object.getOwnPropertyDescriptor(NQ.prototype,"angle"),NQ.prototype),FQ=S(NQ.prototype,"_enable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(NQ.prototype,"enable",[nQ],Object.getOwnPropertyDescriptor(NQ.prototype,"enable"),NQ.prototype),zQ=S(NQ.prototype,"_shapeType",[rQ,aQ,oQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mX.Cone}}),S(NQ.prototype,"shapeType",[sQ,lQ],Object.getOwnPropertyDescriptor(NQ.prototype,"shapeType"),NQ.prototype),UQ=S(NQ.prototype,"emitFrom",[cQ,si,uQ,hQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vX.Volume}}),GQ=S(NQ.prototype,"alignToDirection",[si,_Q,dQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HQ=S(NQ.prototype,"randomDirectionAmount",[si,fQ,pQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VQ=S(NQ.prototype,"sphericalDirectionAmount",[si,mQ,vQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),WQ=S(NQ.prototype,"randomPositionAmount",[si,gQ,yQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jQ=S(NQ.prototype,"radius",[si,xQ,SQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qQ=S(NQ.prototype,"radiusThickness",[si,TQ,EQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),XQ=S(NQ.prototype,"arcMode",[bQ,si,AQ,CQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gX.Random}}),YQ=S(NQ.prototype,"arcSpread",[si,wQ,RQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KQ=S(NQ.prototype,"arcSpeed",[IQ,si,OQ,MQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),ZQ=S(NQ.prototype,"length",[si,PQ,kQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),QQ=S(NQ.prototype,"boxThickness",[si,DQ,BQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(0,0,0)}}),JQ=S(NQ.prototype,"_position",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(0,0,0)}}),$Q=S(NQ.prototype,"_rotation",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(0,0,0)}}),eJ=S(NQ.prototype,"_scale",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(1,1,1)}}),tJ=S(NQ.prototype,"_arc",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xn(360)}}),iJ=S(NQ.prototype,"_angle",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xn(25)}}),LQ=NQ))||LQ);function SJ(e,t){t.x>0&&(e[0]+=.5*En(-t.x,t.x),e[0]=vn(e[0],-.5,.5)),t.y>0&&(e[1]+=.5*En(-t.y,t.y),e[1]=vn(e[1],-.5,.5)),t.z>0&&(e[2]+=.5*En(-t.z,t.z),e[2]=vn(e[2],-.5,.5))}var TJ,EJ,bJ,AJ,CJ,wJ,RJ,IJ,OJ,MJ,PJ,kJ,DJ,BJ,LJ,NJ,FJ,zJ,UJ,GJ,HJ,VJ,WJ,jJ,qJ,XJ,YJ,KJ,ZJ,QJ=[0,0,1,0,0,1,1,1],JJ=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._capacity=void 0,e._vertAttrs=void 0,e._vertSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._iaInfoBufferReady=!0,e._material=null,e.type=Mb.PARTICLE_BATCH,e._capacity=0,e._vertAttrs=null,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=new js([new Vs]),e._iaInfoBuffer=e._device.createBuffer(new qs(qo.INDIRECT,Xo.HOST|Xo.DEVICE,Ws,Ws)),e._subMeshData=null,e._mesh=null,e}return o(t,e),r(t,[{key:"setCapacity",value:function(e){var t=this._capacity!==e;this._capacity=e,this._subMeshData&&t&&this.rebuild()}},{key:"setVertexAttributes",value:function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;for(var i,n=y(this._vertAttrs);!(i=n()).done;){var r=i.value;r.offset=this._vertSize,this._vertSize+=Ds[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}}},{key:"createSubMeshData",value:function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex((function(e){return e.name===Vo.ATTR_TEX_COORD3})),n=this._vertAttrs[i++].offset;if(this._mesh.copyAttribute(0,Vo.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Vo.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[this._vertAttrs.findIndex((function(e){return e.name===Vo.ATTR_TEX_COORD}))].offset,this._mesh.copyAttribute(0,Vo.ATTR_TEX_COORD,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,Vo.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),a=0;a<this._vertCount;++a)r[a*this._vertAttrsFloatCount+n/4]=Ma.WHITE._val;for(var o=new Float32Array(t),s=1;s<this._capacity;s++)o.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var l=new Uint16Array(this._capacity*this._indexCount);if(this._mesh){this._mesh.copyIndices(0,l);for(var c=1;c<this._capacity;c++)for(var u=0;u<this._indexCount;u++)l[c*this._indexCount+u]=l[u]+c*this._vertCount}else for(var h=0,_=0;_<this._capacity;++_){var d=4*_;l[h++]=d,l[h++]=d+1,l[h++]=d+2,l[h++]=d+3,l[h++]=d+2,l[h++]=d+1}var f=this._device.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return f.update(l),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBufferReady||(this._iaInfoBuffer.initialize(new qs(qo.INDIRECT,Xo.HOST|Xo.DEVICE,Ws,Ws)),this._iaInfoBufferReady=!0),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new K_([e],this._vertAttrs,Zo.TRIANGLE_LIST,f,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t}},{key:"updateMaterial",value:function(e){this._material=e,this.setSubModelMaterial(0,e)}},{key:"addParticleVertexData",value:function(e,t){if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(e*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,n+=2,this._vdataF32[n++]=t[1].z,this._vdataF32[n++]=t[2].x,this._vdataF32[n++]=t[2].y,this._vdataF32[n++]=t[2].z,this._vdataF32[n++]=t[3].x,this._vdataF32[n++]=t[3].y,this._vdataF32[n++]=t[3].z,this._vdataUint32[n++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}}},{key:"addGPUParticleVertexData",value:function(e,t,i){for(var n=t*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var a=n;this._vdataF32[a++]=e.position.x,this._vdataF32[a++]=e.position.y,this._vdataF32[a++]=e.position.z,this._vdataF32[a++]=i,this._vdataF32[a++]=e.startSize.x,this._vdataF32[a++]=e.startSize.y,this._vdataF32[a++]=e.startSize.z,this._vdataF32[a++]=QJ[2*r],this._vdataF32[a++]=e.rotation.x,this._vdataF32[a++]=e.rotation.y,this._vdataF32[a++]=e.rotation.z,this._vdataF32[a++]=QJ[2*r+1],this._vdataF32[a++]=e.startColor.r/255,this._vdataF32[a++]=e.startColor.g/255,this._vdataF32[a++]=e.startColor.b/255,this._vdataF32[a++]=e.startColor.a/255,this._vdataF32[a++]=e.velocity.x,this._vdataF32[a++]=e.velocity.y,this._vdataF32[a++]=e.velocity.z,this._vdataF32[a++]=e.startLifetime,this._vdataF32[a++]=e.randomSeed,n+=this._vertAttrsFloatCount}}},{key:"updateGPUParticles",value:function(e,t,i){for(var n=this._vertAttrsFloatCount*this._vertCount,r=0,a=0,o=0,s=0;s<e;++s)r=s*n,a=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(t-a)<i&&(o=--e*n,this._vdataF32.copyWithin(r,o,o+n),s--);return e}},{key:"constructAttributeIndex",value:function(){if(this._vertAttrs){var e=this._vertAttrs.findIndex((function(e){return"a_position_starttime"===e.name})),t=this._vertAttrs[e].offset;this._startTimeOffset=t/4+3,e=this._vertAttrs.findIndex((function(e){return"a_dir_life"===e.name})),t=this._vertAttrs[e].offset,this._lifeTimeOffset=t/4+3}}},{key:"updateIA",value:function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)}},{key:"clear",value:function(){this._subModels[0].inputAssembler.indexCount=0}},{key:"destroy",value:function(){_(s(t.prototype),"destroy",this).call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer.destroy()}},{key:"rebuild",value:function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)}},{key:"destroySubMeshData",value:function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBufferReady=!1)}}]),t}(zb),$J=function(){function e(t){i(this,e),this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=t}return r(e,[{key:"onInit",value:function(e){this._particleSystem=e}},{key:"onEnable",value:function(){if(this._particleSystem){this.attachToScene();var e=this._model;e&&(e.node=e.transform=this._particleSystem.node,e.enabled=this._particleSystem.enabledInHierarchy)}}},{key:"onDisable",value:function(){this.detachFromScene()}},{key:"onDestroy",value:function(){this._model&&(E.director.root.destroyModel(this._model),this._model=null)}},{key:"attachToScene",value:function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))}},{key:"detachFromScene",value:function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}},{key:"setVertexAttributes",value:function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===pX.Mesh?this._renderInfo.mesh:null,this._vertAttrs)}},{key:"_initModel",value:function(){this._model||(this._model=E.director.root.createModel(JJ),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)}},{key:"updateTrailMaterial",value:function(){}},{key:"getDefaultTrailMaterial",value:function(){return null}}]),e}(),e$=new oa,t$=new Ta,i$=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],n$=[0,0,1,0,0,1,1,1],r$=[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_TEX_COORD,jo.RGB32F),new al(Vo.ATTR_TEX_COORD1,jo.RGB32F),new al(Vo.ATTR_TEX_COORD2,jo.RGB32F),new al(Vo.ATTR_COLOR,jo.RGBA8,!0)],a$=[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_TEX_COORD,jo.RGB32F),new al(Vo.ATTR_TEX_COORD1,jo.RGB32F),new al(Vo.ATTR_TEX_COORD2,jo.RGB32F),new al(Vo.ATTR_COLOR,jo.RGBA8,!0),new al(Vo.ATTR_COLOR1,jo.RGB32F)],o$=[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_TEX_COORD,jo.RGB32F),new al(Vo.ATTR_TEX_COORD1,jo.RGB32F),new al(Vo.ATTR_TEX_COORD2,jo.RGB32F),new al(Vo.ATTR_COLOR,jo.RGBA8,!0),new al(Vo.ATTR_TEX_COORD3,jo.RGB32F),new al(Vo.ATTR_NORMAL,jo.RGB32F),new al(Vo.ATTR_COLOR1,jo.RGBA8,!0)],s$={parent:null,owner:null,subModelIdx:0},l$=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,e)))._defines=void 0,n._trailDefines=void 0,n._frameTile_velLenScale=void 0,n._defaultMat=null,n._node_scale=void 0,n._attrs=void 0,n._particles=null,n._defaultTrailMat=null,n._updateList=new Map,n._animateList=new Map,n._runAnimateList=new Array,n._fillDataFunc=null,n._uScaleHandle=0,n._uLenHandle=0,n._inited=!1,n._model=null,n._frameTile_velLenScale=new ua(1,1,0,0),n._node_scale=new ua,n._attrs=new Array(5),n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},n._trailDefines={CC_USE_WORLD_SPACE:!0},n}return o(t,e),r(t,[{key:"onInit",value:function(e){var i=this;_(s(t.prototype),"onInit",this).call(this,e),this._particles=new Ui((function(){return new nX(i)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0}},{key:"clear",value:function(){this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData()}},{key:"updateRenderMode",value:function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()}},{key:"getFreeParticle",value:function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()}},{key:"getDefaultTrailMaterial",value:function(){return this._defaultTrailMat}},{key:"setNewParticle",value:function(e){}},{key:"_initModuleList",value:function(){var e=this;i$.forEach((function(t){var i=e._particleSystem[t];i&&i.enable&&(i.needUpdate&&(e._updateList[i.name]=i),i.needAnimate&&(e._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var t=0,i=hX.length;t<i;t++){var n=this._animateList[hX[t]];n&&this._runAnimateList.push(n)}}},{key:"enableModule",value:function(e,t,i){t?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[e],delete this._updateList[e]),this._runAnimateList.length=0;for(var n=0,r=hX.length;n<r;n++){var a=this._animateList[hX[n]];a&&this._runAnimateList.push(a)}}},{key:"updateParticles",value:function(e){var t=this,i=this._particleSystem;if(!i)return this._particles.length;switch(i.node.getWorldMatrix(t$),i.scaleSpace){case fX.Local:i.node.getScale(this._node_scale);break;case fX.World:i.node.getWorldScale(this._node_scale)}(i.getMaterialInstance(0)||this._defaultMat).passes[0].setUniform(this._uScaleHandle,this._node_scale),this._updateList.forEach((function(e,t){e.update(i._simulationSpace,t$)}));var n=i._trailModule,r=n&&n.enable;r&&n.update();for(var a=function(a){var s=t._particles.data[a];if(s.remainingLifetime-=e,oa.set(s.animatedVelocity,0,0,0),s.remainingLifetime<0)return r&&n.removeParticle(s),t._particles.removeAt(a),--a,o=a,"continue";s.velocity.y-=9.8*i.gravityModifier.evaluate(1-s.remainingLifetime/s.startLifetime,An(s.randomSeed))*e,oa.copy(s.ultimateVelocity,s.velocity),t._runAnimateList.forEach((function(t){t.animate(s,e)})),oa.scaleAndAdd(s.position,s.position,s.ultimateVelocity,e),r&&n.animate(s,e),o=a},o=0;o<this._particles.length;++o)a(o);return this._particles.length}},{key:"updateRenderData",value:function(){for(var e=0,t=0;t<this._particles.length;++t){var i=this._particles.data[t],n=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(n=i.frameIndex),e=4*t,this._fillDataFunc(i,e,n)}this._model.updateIA(this._particles.length)}},{key:"getParticleCount",value:function(){return this._particles.length}},{key:"onMaterialModified",value:function(e,t){this._inited&&(0===e?this.updateMaterialParams():this.updateTrailMaterial())}},{key:"onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t);var i=this._particleSystem._trailModule;i&&i._trailModel&&1===e&&i._trailModel.setSubModelMaterial(0,t)}},{key:"_setFillFunc",value:function(){this._renderInfo.renderMode===pX.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===pX.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData}},{key:"_fillMeshData",value:function(e,t,i){var n=t/4,r=0;this._attrs[r++]=e.position,e$.z=i,this._attrs[r++]=e$,this._attrs[r++]=e.size,this._attrs[r++]=e.rotation,this._attrs[r++]=e.color._val,this._model.addParticleVertexData(n,this._attrs)}},{key:"_fillStrecthedData",value:function(e,t,i){for(var n=0,r=0;r<4;++r)n=0,this._attrs[n++]=e.position,e$.x=n$[2*r],e$.y=n$[2*r+1],e$.z=i,this._attrs[n++]=e$,this._attrs[n++]=e.size,this._attrs[n++]=e.rotation,this._attrs[n++]=e.color._val,this._attrs[n++]=e.ultimateVelocity,this._attrs[n++]=e.ultimateVelocity,this._model.addParticleVertexData(t++,this._attrs)}},{key:"_fillNormalData",value:function(e,t,i){for(var n=0,r=0;r<4;++r)n=0,this._attrs[n++]=e.position,e$.x=n$[2*r],e$.y=n$[2*r+1],e$.z=i,this._attrs[n++]=e$,this._attrs[n++]=e.size,this._attrs[n++]=e.rotation,this._attrs[n++]=e.color._val,this._attrs[n++]=null,this._model.addParticleVertexData(t++,this._attrs)}},{key:"_setVertexAttrib",value:function(){switch(this._renderInfo.renderMode){case pX.StrecthedBillboard:this._vertAttrs=a$.slice();break;case pX.Mesh:this._vertAttrs=o$.slice();break;default:this._vertAttrs=r$.slice()}}},{key:"updateMaterialParams",value:function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!=t){var i=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1!==i.indexOf("particle")&&-1===i.indexOf("particle-gpu")||e.setMaterial(null,0)}null==e.sharedMaterial&&null==this._defaultMat&&(s$.parent=tf.get("default-particle-material"),s$.owner=this._particleSystem,s$.subModelIdx=0,this._defaultMat=new um(s$),null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var n=e.getMaterialInstance(0)||this._defaultMat;e._simulationSpace===fX.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=n.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale");var a=this._renderInfo.renderMode,o=this._frameTile_velLenScale;a===pX.Billboard?this._defines.CC_RENDER_MODE=0:a===pX.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,o.z=this._renderInfo.velocityScale,o.w=this._renderInfo.lengthScale):a===pX.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:a===pX.VerticalBillboard?this._defines.CC_RENDER_MODE=3:a===pX.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode ".concat(a," not support."));var s=e._textureAnimationModule;s&&s.enable?(ia.set(o,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,o)):r.setUniform(this._uLenHandle,o),n.recompileShaders(this._defines),this._model&&this._model.updateMaterial(n)}}},{key:"updateTrailMaterial",value:function(){if(this._particleSystem){var e=this._particleSystem,t=e._trailModule;if(t&&t.enable){e.simulationSpace===fX.World||t.space===fX.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var i=e.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(s$.parent=tf.get("default-trail-material"),s$.owner=this._particleSystem,s$.subModelIdx=1,this._defaultTrailMat=new um(s$)),(i=i||this._defaultTrailMat).recompileShaders(this._trailDefines),t.updateMaterial()}}}}]),t}($J),c$=new Ta,u$=new ua,h$=new pa,_$="a_position_starttime",d$="a_size_uv",f$="a_rotation_uv",p$="a_color",m$="a_dir_life",v$="a_rndSeed",g$=[new al(_$,jo.RGBA32F),new al(d$,jo.RGBA32F),new al(f$,jo.RGBA32F),new al(p$,jo.RGBA32F),new al(m$,jo.RGBA32F),new al(v$,jo.R32F)],y$=[new al(_$,jo.RGBA32F),new al(d$,jo.RGBA32F),new al(f$,jo.RGBA32F),new al(p$,jo.RGBA32F),new al(m$,jo.RGBA32F),new al(v$,jo.R32F),new al(Vo.ATTR_TEX_COORD,jo.RGB32F),new al(Vo.ATTR_TEX_COORD3,jo.RGB32F),new al(Vo.ATTR_NORMAL,jo.RGB32F),new al(Vo.ATTR_COLOR1,jo.RGBA8,!0)],x$={parent:null,owner:null,subModelIdx:0},S$=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this,e)))._defines=void 0,n._frameTile_velLenScale=void 0,n._node_scale=void 0,n._vertAttrs=[],n._defaultMat=null,n._particleNum=0,n._tempParticle=null,n._colorTexture=null,n._forceTexture=null,n._velocityTexture=null,n._rotationTexture=null,n._sizeTexture=null,n._animTexture=null,n._uTimeHandle=0,n._uRotHandle=0,n._inited=!1,n._frameTile_velLenScale=new ua(1,1,0,0),n._node_scale=new ua,n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},n._tempParticle=new nX(null),n._particleNum=0,n}return o(t,e),r(t,[{key:"onInit",value:function(e){_(s(t.prototype),"onInit",this).call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0}},{key:"updateRenderMode",value:function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()}},{key:"setVertexAttributes",value:function(){_(s(t.prototype),"setVertexAttributes",this).call(this),this._model.constructAttributeIndex()}},{key:"clear",value:function(){this._particleNum=0,this.updateRenderData()}},{key:"onDestroy",value:function(){_(s(t.prototype),"onDestroy",this).call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()}},{key:"enableModule",value:function(e,t,i){var n=this._particleSystem.getMaterialInstance(0)||this._defaultMat;n&&(this.initShaderUniform(n),n.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,n))}},{key:"getFreeParticle",value:function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle}},{key:"setNewParticle",value:function(e){this._model.addGPUParticleVertexData(e,this._particleNum,this._particleSystem._time),this._particleNum++}},{key:"updateParticles",value:function(e){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,e),this.updateShaderUniform(e),this._particleNum}},{key:"updateRenderData",value:function(){this._model.updateIA(this._particleNum)}},{key:"updateShaderUniform",value:function(e){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(t){var i=t.passes[0];u$.x=this._particleSystem._time,u$.y=e,i.setUniform(this._uTimeHandle,u$),this._particleSystem.node.getWorldRotation(h$),i.setUniform(this._uRotHandle,h$)}}},{key:"initShaderUniform",value:function(e){var t=e.passes[0];this._uTimeHandle=t.getHandle("u_timeDelta"),this._uRotHandle=t.getHandle("u_worldRot"),t.setUniform(t.getHandle("scale"),this._node_scale),t.setUniform(t.getHandle("frameTile_velLenScale"),this._frameTile_velLenScale),u$.x=32,u$.y=1/32,t.setUniform(t.getHandle("u_sampleInfo"),u$);var i=!1,n=this._particleSystem._forceOvertimeModule;if(i=n&&n.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=i,i){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=mj(32,n.x,n.y,n.z);var r=t.getHandle("force_over_time_tex0"),a=Ap.getBindingFromHandle(r);t.bindSampler(a,this._forceTexture.getGFXSampler()),t.bindTexture(a,this._forceTexture.getGFXTexture());var o=t.getHandle("u_force_space");t.setUniform(o,n.space);var s=t.getHandle("u_force_mode");t.setUniform(s,this._forceTexture.height)}var l=this._particleSystem._velocityOvertimeModule;if(i=l&&l.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=i,i){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(e,t,i,n,r,a){for(var o=Math.max(fj(t),fj(i),fj(n),fj(r)),s=new Float32Array(e*o*4),l=[t,i,n,r],c=1/(e-1),u=0;u<o;u++)for(var h=0;h<4;h++)for(var _=l[h],d=0,f=0,p=0;p<e;p++){var m=dj(_,c*p,u);f=a?m:(d+=m)/(p+1),s[4*p+h]=f}return pj(s,e,o)}(32,l.x,l.y,l.z,l.speedModifier);var c=t.getHandle("velocity_over_time_tex0"),u=Ap.getBindingFromHandle(c);t.bindSampler(u,this._velocityTexture.getGFXSampler()),t.bindTexture(u,this._velocityTexture.getGFXTexture());var h=t.getHandle("u_velocity_space");t.setUniform(h,l.space);var _=t.getHandle("u_velocity_mode");t.setUniform(_,this._velocityTexture.height)}var d=this._particleSystem._colorOverLifetimeModule;if(i=d&&d.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=i,i){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=Sq(32,d.color);var f=t.getHandle("color_over_time_tex0"),p=Ap.getBindingFromHandle(f);t.bindSampler(p,this._colorTexture.getGFXSampler()),t.bindTexture(p,this._colorTexture.getGFXTexture());var m=t.getHandle("u_color_mode");t.setUniform(m,this._colorTexture.height)}var v=this._particleSystem._rotationOvertimeModule;if(i=v&&v.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=i,i){this._rotationTexture&&this._rotationTexture.destroy(),v.separateAxes?this._rotationTexture=mj(32,v.x,v.y,v.z):this._rotationTexture=function(e,t,i){for(var n=fj(t),r=new Float32Array(e*n*4),a=1/(e-1),o=0,s=0;s<n;s++)for(var l=0;l<e;l++){var c=dj(t,a*l,s);r[o+2]=c,o+=4}return pj(r,e,n)}(32,v.z);var g=t.getHandle("rotation_over_time_tex0"),y=Ap.getBindingFromHandle(g);t.bindSampler(y,this._rotationTexture.getGFXSampler()),t.bindTexture(y,this._rotationTexture.getGFXTexture());var x=t.getHandle("u_rotation_mode");t.setUniform(x,this._rotationTexture.height)}var S=this._particleSystem._sizeOvertimeModule;if(i=S&&S.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=i,i){this._sizeTexture&&this._sizeTexture.destroy(),S.separateAxes?this._sizeTexture=mj(32,S.x,S.y,S.z,!0):this._sizeTexture=function(e,t,i){for(var n=fj(t),r=new Float32Array(e*n*4),a=1/(e-1),o=0,s=0,l=0,c=0;c<n;c++){o=0;for(var u=0;u<e;u++){var h=dj(t,a*u,c);s=i?h:(o+=h)/(u+1),r[l]=s,r[l+1]=s,r[l+2]=s,l+=4}}return pj(r,e,n)}(32,S.size,!0);var T=t.getHandle("size_over_time_tex0"),E=Ap.getBindingFromHandle(T);t.bindSampler(E,this._sizeTexture.getGFXSampler()),t.bindTexture(E,this._sizeTexture.getGFXTexture());var b=t.getHandle("u_size_mode");t.setUniform(b,this._sizeTexture.height)}var A=this._particleSystem._textureAnimationModule;if(i=A&&A.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=i,i){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(e,t,i,n){for(var r=Math.max(fj(t),fj(i)),a=new Float32Array(e*r*4),o=[t,i],s=1/(e-1),l=0;l<r;l++)for(var c=0;c<2;c++)for(var u=o[c],h=0,_=0,d=0;d<e;d++){var f=dj(u,s*d,l);_=n?f:(h+=f)/(d+1),a[4*d+c]=_}return pj(a,e,r)}(32,A.startFrame,A.frameOverTime);var C=t.getHandle("texture_animation_tex0"),w=Ap.getBindingFromHandle(C);t.bindSampler(w,this._animTexture.getGFXSampler()),t.bindTexture(w,this._animTexture.getGFXTexture());var R=t.getHandle("u_anim_info");u$.x=this._animTexture.height,u$.y=A.numTilesX*A.numTilesY,u$.z=A.cycleCount,t.setUniform(R,u$)}}},{key:"getParticleCount",value:function(){return this._particleNum}},{key:"onMaterialModified",value:function(e,t){this._inited&&this.updateMaterialParams()}},{key:"onRebuildPSO",value:function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t)}},{key:"_setVertexAttrib",value:function(){switch(this._renderInfo.renderMode){case pX.StrecthedBillboard:this._vertAttrs=g$.slice();break;case pX.Mesh:this._vertAttrs=y$.slice();break;default:this._vertAttrs=g$.slice()}}},{key:"updateMaterialParams",value:function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!==t){var i=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1===i.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=t.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==e.sharedMaterial&&null==this._defaultMat&&(x$.parent=tf.get("default-particle-gpu-material"),x$.owner=e,x$.subModelIdx=0,this._defaultMat=new um(x$),null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var n=e.getMaterialInstance(0)||this._defaultMat;switch(e.node.getWorldMatrix(c$),e.scaleSpace){case fX.Local:e.node.getScale(this._node_scale);break;case fX.World:e.node.getWorldScale(this._node_scale)}e._simulationSpace===fX.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===pX.Billboard?this._defines.CC_RENDER_MODE=0:r===pX.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===pX.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===pX.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===pX.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode ".concat(r," not support."));var a=e._textureAnimationModule;a&&a.enable&&ia.set(this._frameTile_velLenScale,a.numTilesX,a.numTilesY),this.initShaderUniform(n),n.recompileShaders(this._defines),this._model&&this._model.updateMaterial(n)}}}]),t}($J);function T$(){var e=AB.root.device;return!!(e.maxVertexTextureUnits>=8&&e.hasFeature(Gs.TEXTURE_FLOAT))||(E.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var E$,b$,A$,C$,w$,R$,I$,O$,M$,P$,k$,D$,B$,L$,N$,F$,z$,U$,G$,H$,V$,W$,j$,q$,X$,Y$,K$,Z$,Q$,J$,$$,e0,t0,i0,n0,r0,a0,o0,s0,l0,c0,u0,h0,_0,d0,f0,p0,m0,v0,g0,y0,x0,S0,T0,E0,b0,A0,C0,w0,R0,I0,O0,M0,P0,k0,D0,B0,L0,N0,F0,z0,U0,G0,H0,V0,W0,j0,q0,X0,Y0,K0,Z0,Q0,J0,$0,e1,t1,i1,n1,r1,a1,o1,s1,l1,c1,u1,h1,_1,d1,f1,p1,m1,v1,g1,y1,x1,S1,T1,E1,b1,A1,C1,w1,R1,I1,O1,M1,P1,k1,D1,B1,L1,N1,F1,z1,U1,G1,H1,V1,W1,j1,q1,X1,Y1,K1,Z1,Q1,J1,$1,e2,t2,i2,n2,r2,a2,o2,s2,l2,c2,u2,h2,_2,d2,f2,p2,m2,v2,g2,y2,x2,S2,T2,E2,b2,A2,C2,w2,R2,I2,O2,M2,P2,k2,D2,B2,L2,N2,F2,z2,U2,G2,H2,V2,W2,j2,q2,X2,Y2,K2,Z2,Q2,J2,$2,e4,t4,i4,n4,r4,a4,o4,s4,l4=(TJ=ii("cc.ParticleSystemRenderer"),EJ=Li(pX),bJ=wi(0),AJ=Si(""),CJ=wi(1),wJ=Si(" StrecthedBillboard ,"),RJ=wi(2),IJ=Si(" StrecthedBillboard ,"),OJ=Li(pX),MJ=Li($_),PJ=wi(7),kJ=Si(""),DJ=Li(sm),BJ=wi(8),LJ=Si(""),NJ=Li(sm),FJ=wi(9),zJ=Si(""),UJ=wi(10),GJ=Si("GPU"),TJ((ZJ=function(){function e(){i(this,e),x(this,"_renderMode",WJ,this),x(this,"_velocityScale",jJ,this),x(this,"_lengthScale",qJ,this),x(this,"_mesh",XJ,this),x(this,"_mainTexture",YJ,this),x(this,"_useGPU",KJ,this),this._particleSystem=null}return r(e,[{key:"onInit",value:function(e){this._particleSystem=e;var t=this._useGPU&&T$();this._particleSystem.processor=t?new S$(this):new l$(this),this._particleSystem.processor.onInit(e)}},{key:"_switchProcessor",value:function(){this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new S$(this):new l$(this),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule()}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem.setMaterial(e,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(e){this._mainTexture=e}},{key:"useGPU",get:function(){return this._useGPU},set:function(e){this._useGPU!==e&&(T$()?this._useGPU=e:this._useGPU=!1,this._switchProcessor())}}]),e}(),VJ=ZJ,S(VJ.prototype,"renderMode",[EJ,bJ,AJ],Object.getOwnPropertyDescriptor(VJ.prototype,"renderMode"),VJ.prototype),S(VJ.prototype,"velocityScale",[CJ,wJ],Object.getOwnPropertyDescriptor(VJ.prototype,"velocityScale"),VJ.prototype),S(VJ.prototype,"lengthScale",[RJ,IJ],Object.getOwnPropertyDescriptor(VJ.prototype,"lengthScale"),VJ.prototype),WJ=S(VJ.prototype,"_renderMode",[OJ,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pX.Billboard}}),jJ=S(VJ.prototype,"_velocityScale",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qJ=S(VJ.prototype,"_lengthScale",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),XJ=S(VJ.prototype,"_mesh",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(VJ.prototype,"mesh",[MJ,PJ,kJ],Object.getOwnPropertyDescriptor(VJ.prototype,"mesh"),VJ.prototype),S(VJ.prototype,"particleMaterial",[DJ,BJ,LJ],Object.getOwnPropertyDescriptor(VJ.prototype,"particleMaterial"),VJ.prototype),S(VJ.prototype,"trailMaterial",[NJ,FJ,zJ],Object.getOwnPropertyDescriptor(VJ.prototype,"trailMaterial"),VJ.prototype),YJ=S(VJ.prototype,"_mainTexture",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KJ=S(VJ.prototype,"_useGPU",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(VJ.prototype,"useGPU",[UJ,GJ],Object.getOwnPropertyDescriptor(VJ.prototype,"useGPU"),VJ.prototype),HJ=VJ))||HJ),c4=Math.cos(xn(100)),u4={position:new oa,velocity:new oa},h4=new pa,_4=new Ta,d4=new oa,f4=new oa,p4=new Ma,m4=function(){function e(t){for(i(this,e),this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new oa,lifetime:0,width:0,velocity:new oa,direction:0,color:new Ma})}return r(e,[{key:"getElement",value:function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])}},{key:"addElement",value:function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new oa,lifetime:0,width:0,velocity:new oa,direction:0,color:new Ma}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]}},{key:"iterateElement",value:function(e,t,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,a=this.start;a<r;a++)t(e,this.trailElements[a%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)}},{key:"count",value:function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start}},{key:"clear",value:function(){this.start=-1,this.end=-1}}]),e}(),v4=(E$=ii("cc.TrailModule"),b$=wi(0),A$=Li(yX),C$=wi(1),w$=Si("Particle"),R$=Li(_j),I$=wi(3),O$=Si(""),M$=wi(5),P$=Si(""),k$=Li(fX),D$=wi(6),B$=Si("WorldLocal"),L$=Li(xX),N$=wi(8),F$=Si("StretchRepeat"),z$=wi(9),U$=Si(""),G$=Li(_j),H$=wi(10),V$=Si(""),W$=wi(11),j$=Si(""),q$=Li(yq),X$=wi(12),Y$=Si(""),K$=Li(yq),Z$=wi(13),Q$=Si(""),J$=Li(fX),E$((S((e0=function(){function e(){i(this,e),x(this,"_enable",t0,this),x(this,"mode",i0,this),x(this,"lifeTime",n0,this),x(this,"_minParticleDistance",r0,this),x(this,"existWithParticles",a0,this),x(this,"textureMode",o0,this),x(this,"widthFromParticle",s0,this),x(this,"widthRatio",l0,this),x(this,"colorFromParticle",c0,this),x(this,"colorOverTrail",u0,this),x(this,"colorOvertime",h0,this),x(this,"_space",_0,this),x(this,"_particleSystem",d0,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new js([new Vs]),this._vertAttrs=[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_TEX_COORD,jo.RGBA32F),new al(Vo.ATTR_TEX_COORD1,jo.RGB32F),new al(Vo.ATTR_COLOR,jo.RGBA8,!0)],this._vertSize=0;for(var t,n=y(this._vertAttrs);!(t=n()).done;){var r=t.value;this._vertSize+=Ds[r.format].size}this._particleTrail=new Map}return r(e,[{key:"enable",get:function(){return this._enable},set:function(e){e===this._enable&&this._trailModel||(e&&!this._enable&&(this._enable=e,this._particleSystem.processor.updateTrailMaterial()),e&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e),e?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e,this._particleSystem&&this._particleSystem.processor.updateTrailMaterial()}}]),r(e,[{key:"onInit",value:function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;for(var t=0,i=e.startLifetime.getMax(),n=e.rateOverTime.getMax(),r=e.duration,a=0,o=e.bursts.length;a<o;a++){t+=e.bursts[a].getMaxCount(e)*Math.ceil(i/r)}this._trailNum=Math.ceil(i*this.lifeTime.getMax()*60*(n*r+t)),this._trailSegments=new zi((function(){return new m4(10)}),Math.ceil(n*r)),this._enable&&(this.enable=this._enable)}},{key:"onEnable",value:function(){this._attachToScene()}},{key:"onDisable",value:function(){this._particleTrail.clear(),this._detachFromScene()}},{key:"_attachToScene",value:function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))}},{key:"_detachFromScene",value:function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)}},{key:"destroy",value:function(){this.destroySubMeshData(),this._trailModel&&(AB.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy((function(e){e.trailElements.length=0})),this._trailSegments=null)}},{key:"clear",value:function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData()}}},{key:"updateMaterial",value:function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))}},{key:"update",value:function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===fX.World&&this._particleSystem._simulationSpace===fX.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(_4),this._particleSystem.node.getWorldRotation(h4)):this._needTransform=!1}},{key:"animate",value:function(e,t){if(this._trailSegments){var i=this._particleTrail.get(e);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(e,i);var n=i.getElement(i.end-1);if(this._needTransform?oa.transformMat4(d4,e.position,_4):oa.copy(d4,e.position),!(n&&(i.iterateElement(this,this._updateTrailElement,e,t),oa.squaredDistance(n.position,d4)<this._minSquaredDistance))&&(n=i.addElement())){oa.copy(n.position,d4),n.lifetime=0,this.widthFromParticle?n.width=e.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var a=i.getElement(i.end-2);oa.subtract(a.velocity,n.position,a.position)}else if(r>2){var o=i.getElement(i.end-2),s=i.getElement(i.end-3);oa.subtract(d4,s.position,o.position),oa.subtract(f4,n.position,o.position),oa.subtract(o.velocity,f4,d4),oa.equals(oa.ZERO,o.velocity)&&oa.copy(o.velocity,d4),oa.normalize(o.velocity,o.velocity),this._checkDirectionReverse(o,s)}this.colorFromParticle?n.color.set(e.color):n.color.set(this.colorOvertime.evaluate(0,1))}}}},{key:"removeParticle",value:function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))}},{key:"updateRenderData",value:function(){this.vbOffset=0,this.ibOffset=0;for(var e,t=y(this._particleTrail.keys());!(e=t()).done;){var i=e.value,n=this._particleTrail.get(i);if(-1!==n.start){var r=4*this.vbOffset/this._vertSize,a=n.start>=n.end?n.end+n.trailElements.length:n.end,o=a-n.start,s=1/o,l=n.trailElements[n.start];this._fillVertexBuffer(l,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var c=n.start+1;c<a;c++){var u=n.trailElements[c%n.trailElements.length],h=c-n.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-h/o,1),r,1-h*s,h,5)}if(this._needTransform?oa.transformMat4(u4.position,i.position,_4):oa.copy(u4.position,i.position),1===o||2===o){var _=n.getElement(n.end-1);oa.subtract(_.velocity,u4.position,_.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=_.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=_.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=_.velocity.z,this._vbF32[this.vbOffset-4]=_.velocity.x,this._vbF32[this.vbOffset-3]=_.velocity.y,this._vbF32[this.vbOffset-2]=_.velocity.z,oa.subtract(u4.velocity,u4.position,_.position),this._checkDirectionReverse(u4,_)}else if(o>2){var d=n.getElement(n.end-1),f=n.getElement(n.end-2);oa.subtract(d4,f.position,d.position),oa.subtract(f4,u4.position,d.position),oa.normalize(d4,d4),oa.normalize(f4,f4),oa.subtract(d.velocity,f4,d4),oa.normalize(d.velocity,d.velocity),this._checkDirectionReverse(d,f),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(d,this.colorOverTrail.evaluate(s,1),r,s,o-1,5),oa.subtract(u4.velocity,u4.position,d.position),oa.normalize(u4.velocity,u4.velocity),this._checkDirectionReverse(u4,d)}this.widthFromParticle?u4.width=i.size.x*this.widthRatio.evaluate(0,1):u4.width=this.widthRatio.evaluate(0,1),u4.color=i.color,oa.equals(u4.velocity,oa.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(u4,this.colorOverTrail.evaluate(0,1),r,0,o,1)}}this.updateIA(this.ibOffset)}},{key:"updateIA",value:function(e){var t=this._trailModel&&this._trailModel.subModels;if(t&&t.length>0){var i=t[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=e,this._iaInfoBuffer.update(this._iaInfo)}}},{key:"_createModel",value:function(){this._trailModel||(this._trailModel=E.director.root.createModel(zb))}},{key:"rebuild",value:function(){var e=AB.root.device,t=e.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),t.update(i);var n=e.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,6*this._trailNum*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*this._trailNum),n.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer(new qs(qo.INDIRECT,Xo.HOST|Xo.DEVICE,Ws,Ws)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new K_([t],this._vertAttrs,Zo.TRIANGLE_LIST,n,this._iaInfoBuffer);var r=this._trailModel;r&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)}},{key:"_updateTrailElement",value:function(e,t,i,n){return t.lifetime+=n,e.colorFromParticle?(t.color.set(i.color),t.color.multiply(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),e.widthFromParticle?t.width=i.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime}},{key:"_fillVertexBuffer",value:function(e,t,i,n,r,a){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,p4.set(e.color),p4.multiply(t),this._vbUint32[this.vbOffset++]=p4._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=p4._val,1&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&a&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)}},{key:"_checkDirectionReverse",value:function(e,t){oa.dot(e.velocity,t.velocity)<c4?e.direction=1-t.direction:e.direction=t.direction}},{key:"destroySubMeshData",value:function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)}}]),e}()).prototype,"enable",[b$],Object.getOwnPropertyDescriptor(e0.prototype,"enable"),e0.prototype),t0=S(e0.prototype,"_enable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i0=S(e0.prototype,"mode",[A$,si,C$,w$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yX.Particles}}),n0=S(e0.prototype,"lifeTime",[R$,si,I$,O$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),r0=S(e0.prototype,"_minParticleDistance",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),S(e0.prototype,"minParticleDistance",[M$,P$],Object.getOwnPropertyDescriptor(e0.prototype,"minParticleDistance"),e0.prototype),S(e0.prototype,"space",[k$,D$,B$],Object.getOwnPropertyDescriptor(e0.prototype,"space"),e0.prototype),a0=S(e0.prototype,"existWithParticles",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),o0=S(e0.prototype,"textureMode",[L$,si,N$,F$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xX.Stretch}}),s0=S(e0.prototype,"widthFromParticle",[si,z$,U$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),l0=S(e0.prototype,"widthRatio",[G$,si,H$,V$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),c0=S(e0.prototype,"colorFromParticle",[si,W$,j$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),u0=S(e0.prototype,"colorOverTrail",[q$,si,X$,Y$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yq}}),h0=S(e0.prototype,"colorOvertime",[K$,si,Z$,Q$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yq}}),_0=S(e0.prototype,"_space",[J$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fX.World}}),d0=S(e0.prototype,"_particleSystem",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$$=e0))||$$),g4=new Ta,y4=new pa,x4=e("ParticleSystemComponent",(f0=ii("cc.ParticleSystem"),p0=mi("i18n:cc.ParticleSystem"),m0=_i("Components/ParticleSystem"),v0=ri(99),g0=wi(1),y0=Si(""),x0=Li(yq),S0=wi(8),T0=Si(""),E0=Li(fX),b0=wi(9),A0=Si(""),C0=wi(10),w0=Si(""),R0=li("startSize"),I0=Li(_j),O0=wi(10),M0=Si(""),P0=Li(_j),k0=wi(10),D0=Si(""),B0=Li(_j),L0=wi(10),N0=Si(""),F0=Li(_j),z0=Ti([-1,1]),U0=wi(11),G0=Si(""),H0=wi(12),V0=Si(""),W0=Li(_j),j0=Ti([-1,1]),q0=wi(12),X0=Si(""),Y0=Li(_j),K0=Ti([-1,1]),Z0=wi(12),Q0=Si(""),J0=Li(_j),$0=li("startRotation"),e1=Ti([-1,1]),t1=wi(12),i1=Si(""),n1=Li(_j),r1=wi(6),a1=Si(""),o1=Li(_j),s1=wi(7),l1=Si(""),c1=wi(0),u1=Si(""),h1=wi(2),_1=Si(""),d1=wi(3),f1=Si(""),p1=Li(fX),m1=wi(4),v1=Si(""),g1=wi(5),y1=Si(""),x1=wi(2),S1=Si(""),T1=Li(_j),E1=Ti([-1,1]),b1=wi(13),A1=Si(""),C1=Li(_j),w1=wi(14),R1=Si(""),I1=Li(_j),O1=wi(15),M1=Si(""),P1=Li([mJ]),k1=wi(16),D1=Si(""),B1=Li(sm),L1=xi("Materials"),N1=gi(!1),F1=Li(OX),z1=Li(OX),U1=wi(23),G1=Si(""),H1=Li(xJ),V1=Li(xJ),W1=wi(17),j1=Si(""),q1=Li(oJ),X1=Li(oJ),Y1=wi(21),K1=Si(""),Z1=Li(pJ),Q1=Li(pJ),J1=wi(18),$1=Si(""),e2=Li(jY),t2=Li(jY),i2=wi(19),n2=Si(""),r2=Li(KY),a2=Li(KY),o2=wi(20),s2=Si(""),l2=Li(rJ),c2=Li(rJ),u2=wi(22),h2=Si(""),_2=Li(uJ),d2=Li(uJ),f2=wi(24),p2=Si(""),m2=Li(v4),v2=Li(v4),g2=wi(25),y2=Si(""),x2=Li(l4),S2=wi(26),T2=Si(""),E2=wi(27),b2=Si(" enable "),f0(A2=p0(A2=m0(A2=v0(A2=hi((S((C2=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"startColor",w2,c(e)),x(e,"scaleSpace",R2,c(e)),x(e,"startSize3D",I2,c(e)),x(e,"startSizeX",O2,c(e)),x(e,"startSizeY",M2,c(e)),x(e,"startSizeZ",P2,c(e)),x(e,"startSpeed",k2,c(e)),x(e,"startRotation3D",D2,c(e)),x(e,"startRotationX",B2,c(e)),x(e,"startRotationY",L2,c(e)),x(e,"startRotationZ",N2,c(e)),x(e,"startDelay",F2,c(e)),x(e,"startLifetime",z2,c(e)),x(e,"duration",U2,c(e)),x(e,"loop",G2,c(e)),x(e,"simulationSpeed",H2,c(e)),x(e,"playOnAwake",V2,c(e)),x(e,"gravityModifier",W2,c(e)),x(e,"rateOverTime",j2,c(e)),x(e,"rateOverDistance",q2,c(e)),x(e,"bursts",X2,c(e)),x(e,"_colorOverLifetimeModule",Y2,c(e)),x(e,"_shapeModule",K2,c(e)),x(e,"_sizeOvertimeModule",Z2,c(e)),x(e,"_velocityOvertimeModule",Q2,c(e)),x(e,"_forceOvertimeModule",J2,c(e)),x(e,"_limitVelocityOvertimeModule",$2,c(e)),x(e,"_rotationOvertimeModule",e4,c(e)),x(e,"_textureAnimationModule",t4,c(e)),x(e,"_trailModule",i4,c(e)),x(e,"renderer",n4,c(e)),x(e,"enableCulling",r4,c(e)),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,x(e,"_prewarm",a4,c(e)),x(e,"_capacity",o4,c(e)),x(e,"_simulationSpace",s4,c(e)),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new oa,e._curWPos=new oa,e._customData1=new ia,e._customData2=new ia,e._subEmitters=[],e}return o(t,e),r(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=Math.floor(e),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"sharedMaterials",get:function(){return _(s(t.prototype),"sharedMaterials",this)},set:function(e){f(s(t.prototype),"sharedMaterials",e,this,!0)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(e){e&&(this._colorOverLifetimeModule=e)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(e){e&&(this._shapeModule=e)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(e){e&&(this._sizeOvertimeModule=e)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(e){e&&(this._velocityOvertimeModule=e)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(e){e&&(this._forceOvertimeModule=e)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(e){e&&(this._limitVelocityOvertimeModule=e)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(e){e&&(this._rotationOvertimeModule=e)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(e){e&&(this._textureAnimationModule=e)}},{key:"trailModule",get:function(){return this._trailModule},set:function(e){e&&(this._trailModule=e)}}]),r(t,[{key:"onLoad",value:function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()}},{key:"_onMaterialModified",value:function(e,t){this.processor.onMaterialModified(e,t)}},{key:"_onRebuildPSO",value:function(e,t){this.processor.onRebuildPSO(e,t)}},{key:"_collectModels",value:function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models}},{key:"_attachToScene",value:function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()}},{key:"_detachFromScene",value:function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()}},{key:"bindModule",value:function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)}},{key:"play",value:function(){this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem()}},{key:"pause",value:function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)}},{key:"stop",value:function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0}},{key:"clear",value:function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear())}},{key:"getParticleCount",value:function(){return this.processor.getParticleCount()}},{key:"setCustomData1",value:function(e,t){ia.set(this._customData1,e,t)}},{key:"setCustomData2",value:function(e,t){ia.set(this._customData2,e,t)}},{key:"onDestroy",value:function(){this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy()}},{key:"onEnable",value:function(){this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()}},{key:"onDisable",value:function(){this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable()}},{key:"update",value:function(e){var t=e*this.simulationSpeed;this._isPlaying&&(this._time+=t,this._emit(t),0!==this.processor.updateParticles(t)||this._isEmitting||this.stop(),this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData())}},{key:"_onVisibilityChange",value:function(e){this.processor._model&&(this.processor._model.visFlags=e)}},{key:"emit",value:function(e,t){var i=this._time/this.duration;this._simulationSpace===fX.World&&(this.node.getWorldMatrix(g4),this.node.getWorldRotation(y4));for(var n=0;n<e;++n){var r=this.processor.getFreeParticle();if(null===r)return;var a=An(bn(0,2147483647));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(r):(oa.set(r.position,0,0,0),oa.copy(r.velocity,MX)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(r),oa.multiplyScalar(r.velocity,r.velocity,this.startSpeed.evaluate(i,a)),this._simulationSpace===fX.World&&(oa.transformMat4(r.position,r.position,g4),oa.transformQuat(r.velocity,r.velocity,y4)),oa.copy(r.ultimateVelocity,r.velocity),this.startRotation3D?oa.set(r.rotation,this.startRotationX.evaluate(i,a),this.startRotationY.evaluate(i,a),this.startRotationZ.evaluate(i,a)):oa.set(r.rotation,0,0,this.startRotationZ.evaluate(i,a)),this.startSize3D?oa.set(r.startSize,this.startSizeX.evaluate(i,a),this.startSizeY.evaluate(i,a),this.startSizeZ.evaluate(i,a)):(oa.set(r.startSize,this.startSizeX.evaluate(i,a),1,1),r.startSize.y=r.startSize.x),oa.copy(r.size,r.startSize),r.startColor.set(this.startColor.evaluate(i,a)),r.color.set(r.startColor),r.startLifetime=this.startLifetime.evaluate(i,a)+t,r.remainingLifetime=r.startLifetime,r.randomSeed=bn(0,233280),this.processor.setNewParticle(r)}}},{key:"_prewarmSystem",value:function(){this.startDelay.mode=hj.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.processor.updateParticles(1)}},{key:"_emit",value:function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,this._emitRateTimeCounter>1&&this._isEmitting){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,e)}this.node.getWorldPosition(this._curWPos);var n=oa.distance(this._curWPos,this._oldWPos);if(oa.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=n*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}for(var a,o=y(this.bursts);!(a=o()).done;){a.value.update(this,e)}}}},{key:"_resetPosition",value:function(){this.node.getWorldPosition(this._oldWPos),oa.copy(this._curWPos,this._oldWPos)}},{key:"addSubEmitter",value:function(e){this._subEmitters.push(e)}},{key:"removeSubEmitter",value:function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)}},{key:"addBurst",value:function(e){this.bursts.push(e)}},{key:"removeBurst",value:function(e){this.bursts.splice(this.bursts.indexOf(e),1)}},{key:"_onBeforeSerialize",value:function(e){var t=this;return this.enableCulling?e.filter((function(e){return!_X.includes(e)||t[e]&&t[e].enable})):e}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}(AC)).prototype,"capacity",[g0,y0],Object.getOwnPropertyDescriptor(C2.prototype,"capacity"),C2.prototype),w2=S(C2.prototype,"startColor",[x0,si,S0,T0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yq}}),R2=S(C2.prototype,"scaleSpace",[E0,si,b0,A0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fX.Local}}),I2=S(C2.prototype,"startSize3D",[si,C0,w0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),O2=S(C2.prototype,"startSizeX",[R0,I0,O0,M0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),M2=S(C2.prototype,"startSizeY",[P0,si,k0,D0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),P2=S(C2.prototype,"startSizeZ",[B0,si,L0,N0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),k2=S(C2.prototype,"startSpeed",[F0,si,z0,U0,G0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),D2=S(C2.prototype,"startRotation3D",[si,H0,V0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),B2=S(C2.prototype,"startRotationX",[W0,si,j0,Ii,q0,X0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),L2=S(C2.prototype,"startRotationY",[Y0,si,K0,Ii,Z0,Q0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),N2=S(C2.prototype,"startRotationZ",[J0,$0,e1,Ii,t1,i1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),F2=S(C2.prototype,"startDelay",[n1,si,r1,a1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),z2=S(C2.prototype,"startLifetime",[o1,si,s1,l1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),U2=S(C2.prototype,"duration",[si,c1,u1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),G2=S(C2.prototype,"loop",[si,h1,_1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),S(C2.prototype,"prewarm",[d1,f1],Object.getOwnPropertyDescriptor(C2.prototype,"prewarm"),C2.prototype),S(C2.prototype,"simulationSpace",[p1,si,m1,v1],Object.getOwnPropertyDescriptor(C2.prototype,"simulationSpace"),C2.prototype),H2=S(C2.prototype,"simulationSpeed",[si,g1,y1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),V2=S(C2.prototype,"playOnAwake",[si,x1,S1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),W2=S(C2.prototype,"gravityModifier",[T1,si,E1,b1,A1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),j2=S(C2.prototype,"rateOverTime",[C1,si,w1,R1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),q2=S(C2.prototype,"rateOverDistance",[I1,si,O1,M1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _j}}),X2=S(C2.prototype,"bursts",[P1,si,k1,D1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),S(C2.prototype,"sharedMaterials",[Ni,B1,si,L1,N1],Object.getOwnPropertyDescriptor(C2.prototype,"sharedMaterials"),C2.prototype),Y2=S(C2.prototype,"_colorOverLifetimeModule",[F1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(C2.prototype,"colorOverLifetimeModule",[z1,U1,G1],Object.getOwnPropertyDescriptor(C2.prototype,"colorOverLifetimeModule"),C2.prototype),K2=S(C2.prototype,"_shapeModule",[H1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(C2.prototype,"shapeModule",[V1,W1,j1],Object.getOwnPropertyDescriptor(C2.prototype,"shapeModule"),C2.prototype),Z2=S(C2.prototype,"_sizeOvertimeModule",[q1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(C2.prototype,"sizeOvertimeModule",[X1,Y1,K1],Object.getOwnPropertyDescriptor(C2.prototype,"sizeOvertimeModule"),C2.prototype),Q2=S(C2.prototype,"_velocityOvertimeModule",[Z1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(C2.prototype,"velocityOvertimeModule",[Q1,J1,$1],Object.getOwnPropertyDescriptor(C2.prototype,"velocityOvertimeModule"),C2.prototype),J2=S(C2.prototype,"_forceOvertimeModule",[e2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(C2.prototype,"forceOvertimeModule",[t2,i2,n2],Object.getOwnPropertyDescriptor(C2.prototype,"forceOvertimeModule"),C2.prototype),$2=S(C2.prototype,"_limitVelocityOvertimeModule",[r2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(C2.prototype,"limitVelocityOvertimeModule",[a2,o2,s2],Object.getOwnPropertyDescriptor(C2.prototype,"limitVelocityOvertimeModule"),C2.prototype),e4=S(C2.prototype,"_rotationOvertimeModule",[l2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(C2.prototype,"rotationOvertimeModule",[c2,u2,h2],Object.getOwnPropertyDescriptor(C2.prototype,"rotationOvertimeModule"),C2.prototype),t4=S(C2.prototype,"_textureAnimationModule",[_2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(C2.prototype,"textureAnimationModule",[d2,f2,p2],Object.getOwnPropertyDescriptor(C2.prototype,"textureAnimationModule"),C2.prototype),i4=S(C2.prototype,"_trailModule",[m2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S(C2.prototype,"trailModule",[v2,g2,y2],Object.getOwnPropertyDescriptor(C2.prototype,"trailModule"),C2.prototype),n4=S(C2.prototype,"renderer",[x2,si,S2,T2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new l4}}),r4=S(C2.prototype,"enableCulling",[si,E2,b2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),a4=S(C2.prototype,"_prewarm",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),o4=S(C2.prototype,"_capacity",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),s4=S(C2.prototype,"_simulationSpace",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fX.Local}}),A2=C2))||A2)||A2)||A2)||A2)||A2)),S4=e("ParticleUtils",function(){function e(){i(this,e)}return r(e,null,[{key:"instantiate",value:function(e){return this.registeredSceneEvent||(AB.on(iB.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new zi((function(){return uw(e)||new ig}),1)),this.particleSystemPool.get(e._uuid).alloc()}},{key:"destroy",value:function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))}},{key:"play",value:function(e){for(var t,i=y(e.getComponentsInChildren(x4));!(t=i()).done;){t.value.play()}}},{key:"stop",value:function(e){for(var t,i=y(e.getComponentsInChildren(x4));!(t=i()).done;){t.value.stop()}}},{key:"onSceneUnload",value:function(){this.particleSystemPool.forEach((function(e){e.destroy((function(e){e.destroy()}))})),this.particleSystemPool.clear()}}]),e}());function T4(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}S4.particleSystemPool=new Map,S4.registeredSceneEvent=!1,Da(mJ.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),E.ParticleSystemComponent=x4,ze.setClassAlias(x4,"cc.ParticleSystemComponent"),E.BillboardComponent=oj,ze.setClassAlias(oj,"cc.BillboardComponent"),E.LineComponent=iX,ze.setClassAlias(iX,"cc.LineComponent"),E.ParticleUtils=S4;var E4,b4,A4,C4,w4,R4,I4,O4=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e,t){e.exports=function e(t,i,n){function r(o,s){if(!i[o]){if(!t[o]){if(!s&&T4)return T4();if(a)return a(o,!0);throw new Error("Cannot find module '"+o+"'")}var l=i[o]={exports:{}};t[o][0].call(l.exports,(function(e){return r(t[o][1][e]||e)}),l,l.exports,e,t,i,n)}return i[o].exports}for(var a=T4,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(e,t,i){t.exports={name:"@cocos/cannon",version:"1.1.1-exp.4",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se), JayceLai",keywords:["cannon.js","cocos","creator","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -c -m"},main:"./build/cannon.min.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t,i){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World"),Octree:e("./utils/Octree"),CMath:e("./math/CMath")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/CMath":27,"./math/Mat3":29,"./math/Quaternion":30,"./math/Transform":31,"./math/Vec3":32,"./objects/Body":33,"./objects/RaycastVehicle":34,"./objects/RigidVehicle":35,"./objects/SPHSystem":36,"./objects/Spring":37,"./shapes/Box":39,"./shapes/ConvexPolyhedron":40,"./shapes/Cylinder":41,"./shapes/Heightfield":42,"./shapes/Particle":43,"./shapes/Plane":44,"./shapes/Shape":45,"./shapes/Sphere":46,"./shapes/Trimesh":47,"./solver/GSSolver":48,"./solver/Solver":49,"./solver/SplitSolver":50,"./utils/EventTarget":51,"./utils/Octree":52,"./utils/Pool":53,"./utils/Vec3Pool":56,"./world/Narrowphase":57,"./world/World":58}],3:[function(e,t,i){var n=e("../math/Vec3");function r(e){e=e||{},this.lowerBound=new n,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new n,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=r;var a=new n;r.prototype.setFromPoints=function(e,t,i,n){var r=this.lowerBound,o=this.upperBound,s=i;r.copy(e[0]),s&&s.vmult(r,r),o.copy(r);for(var l=1;l<e.length;l++){var c=e[l];s&&(s.vmult(c,a),c=a),c.x>o.x&&(o.x=c.x),c.x<r.x&&(r.x=c.x),c.y>o.y&&(o.y=c.y),c.y<r.y&&(r.y=c.y),c.z>o.z&&(o.z=c.z),c.z<r.z&&(r.z=c.z)}return t&&(t.vadd(r,r),t.vadd(o,o)),n&&(r.x-=n,r.y-=n,r.z-=n,o.x+=n,o.y+=n,o.z+=n),this},r.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},r.prototype.clone=function(){return(new r).copy(this)},r.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},r.prototype.overlaps=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound,a=n.x<=i.x&&i.x<=r.x||t.x<=r.x&&r.x<=i.x,o=n.y<=i.y&&i.y<=r.y||t.y<=r.y&&r.y<=i.y,s=n.z<=i.z&&i.z<=r.z||t.z<=r.z&&r.z<=i.z;return a&&o&&s},r.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},r.prototype.contains=function(e){var t=this.lowerBound,i=this.upperBound,n=e.lowerBound,r=e.upperBound;return t.x<=n.x&&i.x>=r.x&&t.y<=n.y&&i.y>=r.y&&t.z<=n.z&&i.z>=r.z},r.prototype.getCorners=function(e,t,i,n,r,a,o,s){var l=this.lowerBound,c=this.upperBound;e.copy(l),t.set(c.x,l.y,l.z),i.set(c.x,c.y,l.z),n.set(l.x,c.y,c.z),r.set(c.x,l.y,c.z),a.set(l.x,c.y,l.z),o.set(l.x,l.y,c.z),s.copy(c)};var o=[new n,new n,new n,new n,new n,new n,new n,new n];r.prototype.toLocalFrame=function(e,t){var i=o,n=i[0],r=i[1],a=i[2],s=i[3],l=i[4],c=i[5],u=i[6],h=i[7];this.getCorners(n,r,a,s,l,c,u,h);for(var _=0;8!==_;_++){var d=i[_];e.pointToLocal(d,d)}return t.setFromPoints(i)},r.prototype.toWorldFrame=function(e,t){var i=o,n=i[0],r=i[1],a=i[2],s=i[3],l=i[4],c=i[5],u=i[6],h=i[7];this.getCorners(n,r,a,s,l,c,u,h);for(var _=0;8!==_;_++){var d=i[_];e.pointToWorld(d,d)}return t.setFromPoints(i)},r.prototype.overlapsRay=function(e){var t=1/e._direction.x,i=1/e._direction.y,n=1/e._direction.z,r=(this.lowerBound.x-e.from.x)*t,a=(this.upperBound.x-e.from.x)*t,o=(this.lowerBound.y-e.from.y)*i,s=(this.upperBound.y-e.from.y)*i,l=(this.lowerBound.z-e.from.z)*n,c=(this.upperBound.z-e.from.z)*n,u=Math.max(Math.max(Math.min(r,a),Math.min(o,s)),Math.min(l,c)),h=Math.min(Math.min(Math.max(r,a),Math.max(o,s)),Math.max(l,c));return!(h<0||h<u)}},{"../math/Vec3":32,"../utils/Utils":55}],4:[function(e,t,i){function n(){this.matrix=[]}(t.exports=n).prototype.get=function(e,t){if((e=e.index)<(t=t.index)){var i=t;t=e,e=i}return this.matrix[(e*(e+1)>>1)+t-1]},n.prototype.set=function(e,t,i){if((e=e.index)<(t=t.index)){var n=t;t=e,e=n}this.matrix[(e*(e+1)>>1)+t-1]=i?1:0},n.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t,i){var n=e("../objects/Body"),r=e("../math/Vec3"),a=e("../math/Quaternion");function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),(t.exports=o).prototype.collisionPairs=function(e,t,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")},o.prototype.needBroadphaseCollision=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)&&(!(!e.hasTrigger&&!t.hasTrigger)||0==(e.type&n.STATIC)&&e.sleepState!==n.SLEEPING||0==(t.type&n.STATIC)&&t.sleepState!==n.SLEEPING)},o.prototype.intersectionTest=function(e,t,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,i,n):this.doBoundingSphereBroadphase(e,t,i,n)};var s=new r;new r,new a,new r,o.prototype.doBoundingSphereBroadphase=function(e,t,i,n){var r=s;t.position.vsub(e.position,r);var a=Math.pow(e.boundingRadius+t.boundingRadius,2);r.norm2()<a&&(i.push(e),n.push(t))},o.prototype.doBoundingBoxBroadphase=function(e,t,i,n){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(i.push(e),n.push(t))};var l={keys:[]},c=[],u=[];o.prototype.makePairsUnique=function(e,t){for(var i=l,n=c,r=u,a=e.length,o=0;o!==a;o++)n[o]=e[o],r[o]=t[o];for(e.length=0,o=t.length=0;o!==a;o++){var s=n[o].id,h=r[o].id;i[_=s<h?s+","+h:h+","+s]=o,i.keys.push(_)}for(o=0;o!==i.keys.length;o++){var _=i.keys.pop(),d=i[_];e.push(n[d]),t.push(r[d]),delete i[_]}},o.prototype.setWorld=function(e){};var h=new r;o.boundingSphereCheck=function(e,t){var i=h;return e.position.vsub(t.position,i),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>i.norm2()},o.prototype.aabbQuery=function(e,t,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":30,"../math/Vec3":32,"../objects/Body":33,"../shapes/Plane":44,"../shapes/Shape":45}],6:[function(e,t,i){t.exports=o;var n=e("./Broadphase"),r=e("../math/Vec3"),a=e("../shapes/Shape");function o(e,t,i,a,o){n.apply(this),this.nx=i||10,this.ny=a||10,this.nz=o||10,this.aabbMin=e||new r(100,100,100),this.aabbMax=t||new r(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(s<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var l=0;l<s;l++)this.bins[l]=[],this.binLengths[l]=0}(o.prototype=new n).constructor=o;var s=new r;new r,o.prototype.collisionPairs=function(e,t,i){for(var n=e.numObjects(),r=e.bodies,o=this.aabbMax,l=this.aabbMin,c=this.nx,u=this.ny,h=this.nz,_=u*h,d=h,f=o.x,p=o.y,m=o.z,v=l.x,g=l.y,y=l.z,x=c/(f-v),S=u/(p-g),T=h/(m-y),E=(f-v)/c,b=(p-g)/u,A=(m-y)/h,C=.5*Math.sqrt(E*E+b*b+A*A),w=a.types,R=w.SPHERE,I=w.PLANE,O=(w.BOX,w.COMPOUND,w.CONVEXPOLYHEDRON,this.bins),M=this.binLengths,P=this.bins.length,k=0;k!==P;k++)M[k]=0;var D=Math.ceil;function B(e,t,i,n,r,a,o){var s=(e-v)*x|0,l=(t-g)*S|0,f=(i-y)*T|0,p=D((n-v)*x),m=D((r-g)*S),E=D((a-y)*T);s<0?s=0:c<=s&&(s=c-1),l<0?l=0:u<=l&&(l=u-1),f<0?f=0:h<=f&&(f=h-1),p<0?p=0:c<=p&&(p=c-1),m<0?m=0:u<=m&&(m=u-1),E<0?E=0:h<=E&&(E=h-1),l*=d,f*=1,p*=_,m*=d,E*=1;for(var b=s*=_;b<=p;b+=_)for(var A=l;A<=m;A+=d)for(var C=f;C<=E;C+=1){var w=b+A+C;O[w][M[w]++]=o}}for(l=Math.min,o=Math.max,k=0;k!==n;k++){var L=(te=r[k]).shape;switch(L.type){case R:var N=te.position.x,F=te.position.y,z=te.position.z,U=L.radius;B(N-U,F-U,z-U,N+U,F+U,z+U,te);break;case I:L.worldNormalNeedsUpdate&&L.computeWorldNormal(te.quaternion);var G=L.worldNormal,H=v+.5*E-te.position.x,V=g+.5*b-te.position.y,W=y+.5*A-te.position.z,j=s;j.set(H,V,W);for(var q=0,X=0;q!==c;q++,X+=_,j.y=V,j.x+=E)for(var Y=0,K=0;Y!==u;Y++,K+=d,j.z=W,j.y+=b)for(var Z=0,Q=0;Z!==h;Z++,Q+=1,j.z+=A)if(j.dot(G)<C){var J=X+K+Q;O[J][M[J]++]=te}break;default:te.aabbNeedsUpdate&&te.computeAABB(),B(te.aabb.lowerBound.x,te.aabb.lowerBound.y,te.aabb.lowerBound.z,te.aabb.upperBound.x,te.aabb.upperBound.y,te.aabb.upperBound.z,te)}}for(k=0;k!==P;k++){var $=M[k];if(1<$){var ee=O[k];for(q=0;q!==$;q++){var te=ee[q];for(Y=0;Y!==q;Y++){var ie=ee[Y];this.needBroadphaseCollision(te,ie)&&this.intersectionTest(te,ie,t,i)}}}}this.makePairsUnique(t,i)}},{"../math/Vec3":32,"../shapes/Shape":45,"./Broadphase":5}],7:[function(e,t,i){t.exports=a;var n=e("./Broadphase"),r=e("./AABB");function a(){n.apply(this)}((a.prototype=new n).constructor=a).prototype.collisionPairs=function(e,t,i){var n,r,a,o,s=e.bodies,l=s.length;for(n=0;n!==l;n++)for(r=0;r!==n;r++)a=s[n],o=s[r],this.needBroadphaseCollision(a,o)&&this.intersectionTest(a,o,t,i)},new r,a.prototype.aabbQuery=function(e,t,i){i=i||[];for(var n=0;n<e.bodies.length;n++){var r=e.bodies[n];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&i.push(r)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t,i){function n(){this.matrix={}}(t.exports=n).prototype.get=function(e,t){if((e=e.id)<(t=t.id)){var i=t;t=e,e=i}return e+"-"+t in this.matrix},n.prototype.set=function(e,t,i){if((e=e.id)<(t=t.id)){var n=t;t=e,e=n}i?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(e){}},{}],9:[function(e,t,i){function n(){this.current=[],this.previous=[]}function r(e,t){e.push((4294901760&t)>>16,65535&t)}(t.exports=n).prototype.getKey=function(e,t){if(t<e){var i=t;t=e,e=i}return e<<16|t},n.prototype.set=function(e,t){for(var i=this.getKey(e,t),n=this.current,r=0;i>n[r];)r++;if(i!==n[r]){for(t=n.length-1;r<=t;t--)n[t+1]=n[t];n[r]=i}},n.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},n.prototype.getDiff=function(e,t){for(var i=this.current,n=this.previous,a=i.length,o=n.length,s=0,l=0;l<a;l++){for(var c=i[l];c>n[s];)s++;c===n[s]||r(e,c)}for(l=s=0;l<o;l++){for(var u=n[l];u>i[s];)s++;i[s]===u||r(t,u)}}},{}],10:[function(e,t,i){t.exports=c;var n=e("../math/Vec3"),r=e("../math/Quaternion"),a=e("../math/Transform"),o=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),s=e("../shapes/Shape"),l=e("../collision/AABB");function c(e,t){this.from=e?e.clone():new n,this.to=t?t.clone():new n,this._direction=new n,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new o,this.hasHit=!1,this.callback=function(e){}}(c.prototype.constructor=c).CLOSEST=1,c.ANY=2,c.ALL=4;var u=new l,h=[];c.prototype.intersectWorld=function(e,t){return this.mode=t.mode||c.ANY,this.result=t.result||new o,this.skipBackfaces=!!t.skipBackfaces,this.checkCollisionResponse=!!t.checkCollisionResponse,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(u),h.length=0,e.broadphase.aabbQuery(e,u,h),this.intersectBodies(h),this.hasHit};var _=new n,d=new n;function f(e,t,i,n){n.vsub(t,N),i.vsub(t,_),e.vsub(t,d);var r,a,o=N.dot(N),s=N.dot(_),l=N.dot(d),c=_.dot(_),u=_.dot(d);return 0<=(r=c*l-s*u)&&0<=(a=o*u-s*l)&&r+a<o*c-s*s}c.pointInTriangle=f;var p=new n,m=new r;c.prototype.intersectBody=function(e,t){t&&(this.result=t,this._updateDirection());var i=this.checkCollisionResponse;if((!i||e.collisionResponse)&&0!=(this.collisionFilterGroup&e.collisionFilterMask)&&0!=(e.collisionFilterGroup&this.collisionFilterMask))for(var n=p,r=m,a=0,o=e.shapes.length;a<o;a++){var s=e.shapes[a];if((!i||s.collisionResponse)&&(e.quaternion.mult(e.shapeOrientations[a],r),e.quaternion.vmult(e.shapeOffsets[a],n),n.vadd(e.position,n),this.intersectShape(s,r,n,e),this.result._shouldStop))break}},c.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var i=0,n=e.length;!this.result._shouldStop&&i<n;i++)this.intersectBody(e[i])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(e,t,i,n){if(!(function(e,t,i){i.vsub(e,N);var n=N.dot(t);return t.mult(n,F),F.vadd(e,F),i.distanceTo(F)}(this.from,this._direction,i)>e.boundingSphereRadius)){var r=this[e.type];r&&r.call(this,e,t,i,n,e)}},new n,new n;var v=new n,g=new n,y=new n,x=new n;new n,new o,c.prototype.intersectBox=function(e,t,i,n,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,i,n,r)},c.prototype[s.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(e,t,i,r,a){var o=this.from,s=this.to,l=this._direction,c=new n(0,0,1);t.vmult(c,c);var u=new n;o.vsub(i,u);var h=u.dot(c);if(s.vsub(i,u),!(0<h*u.dot(c)||o.distanceTo(s)<h)){var _=c.dot(l);if(!(Math.abs(_)<this.precision)){var d=new n,f=new n,p=new n;o.vsub(i,d);var m=-c.dot(d)/_;l.scale(m,f),o.vadd(f,p),this.reportIntersection(c,p,a,r,-1)}}},c.prototype[s.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(e){var t=this.to,i=this.from;e.lowerBound.x=Math.min(t.x,i.x),e.lowerBound.y=Math.min(t.y,i.y),e.lowerBound.z=Math.min(t.z,i.z),e.upperBound.x=Math.max(t.x,i.x),e.upperBound.y=Math.max(t.y,i.y),e.upperBound.z=Math.max(t.z,i.z)};var S={faceList:[0]},T=new n,E=new c,b=[];c.prototype.intersectHeightfield=function(e,t,i,n,r){e.data,e.elementSize;var o=E;o.from.copy(this.from),o.to.copy(this.to),a.pointToLocalFrame(i,t,o.from,o.from),a.pointToLocalFrame(i,t,o.to,o.to),o._updateDirection();var s,c,u,h,_=b;s=c=0,u=h=e.data.length-1;var d=new l;o.getAABB(d),e.getIndexOfPosition(d.lowerBound.x,d.lowerBound.y,_,!0),s=Math.max(s,_[0]),c=Math.max(c,_[1]),e.getIndexOfPosition(d.upperBound.x,d.upperBound.y,_,!0),u=Math.min(u,_[0]+1),h=Math.min(h,_[1]+1);for(var f=s;f<u;f++)for(var p=c;p<h;p++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(f,p,d),d.overlapsRay(o)){if(e.getConvexTrianglePillar(f,p,!1),a.pointToWorldFrame(i,t,e.pillarOffset,T),this.intersectConvex(e.pillarConvex,t,T,n,r,S),this.result._shouldStop)return;e.getConvexTrianglePillar(f,p,!0),a.pointToWorldFrame(i,t,e.pillarOffset,T),this.intersectConvex(e.pillarConvex,t,T,n,r,S)}}},c.prototype[s.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var A=new n,C=new n;c.prototype.intersectSphere=function(e,t,i,n,r){var a=this.from,o=this.to,s=e.radius,l=Math.pow(o.x-a.x,2)+Math.pow(o.y-a.y,2)+Math.pow(o.z-a.z,2),c=2*((o.x-a.x)*(a.x-i.x)+(o.y-a.y)*(a.y-i.y)+(o.z-a.z)*(a.z-i.z)),u=Math.pow(a.x-i.x,2)+Math.pow(a.y-i.y,2)+Math.pow(a.z-i.z,2)-Math.pow(s,2),h=Math.pow(c,2)-4*l*u,_=A,d=C;if(!(h<0))if(0==h)a.lerp(o,h,_),_.vsub(i,d),d.normalize(),this.reportIntersection(d,_,r,n,-1);else{var f=(-c-Math.sqrt(h))/(2*l),p=(-c+Math.sqrt(h))/(2*l);if(0<=f&&f<=1&&(a.lerp(o,f,_),_.vsub(i,d),d.normalize(),this.reportIntersection(d,_,r,n,-1)),this.result._shouldStop)return;0<=p&&p<=1&&(a.lerp(o,p,_),_.vsub(i,d),d.normalize(),this.reportIntersection(d,_,r,n,-1))}},c.prototype[s.types.SPHERE]=c.prototype.intersectSphere;var w=new n,R=(new n,new n,new n);c.prototype.intersectConvex=function(e,t,i,n,r,a){for(var o=w,s=R,l=a&&a.faceList||null,c=e.faces,u=e.vertices,h=e.faceNormals,_=this._direction,d=this.from,p=this.to,m=d.distanceTo(p),S=l?l.length:c.length,T=this.result,E=0;!T._shouldStop&&E<S;E++){var b=l?l[E]:E,A=c[b],C=h[b],I=t,O=i;s.copy(u[A[0]]),I.vmult(s,s),s.vadd(O,s),s.vsub(d,s),I.vmult(C,o);var M=_.dot(o);if(!(Math.abs(M)<this.precision)){var P=o.dot(s)/M;if(!(P<0)){_.mult(P,v),v.vadd(d,v),g.copy(u[A[0]]),I.vmult(g,g),O.vadd(g,g);for(var k=1;!T._shouldStop&&k<A.length-1;k++){y.copy(u[A[k]]),x.copy(u[A[k+1]]),I.vmult(y,y),I.vmult(x,x),O.vadd(y,y),O.vadd(x,x);var D=v.distanceTo(d);!f(v,g,y,x)&&!f(v,y,g,x)||m<D||this.reportIntersection(o,v,r,n,b)}}}}},c.prototype[s.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var I=new n,O=new n,M=new n,P=new n,k=new n,D=new n,B=(new l,[]),L=new a;c.prototype.intersectTrimesh=function(e,t,i,n,r,o){var s=I,l=B,c=L,u=R,h=O,_=M,d=P,p=D,m=k,S=(o&&o.faceList,e.indices),T=(e.vertices,e.faceNormals,this.from),E=this.to,b=this._direction;c.position.copy(i),c.quaternion.copy(t),a.vectorToLocalFrame(i,t,b,h),a.pointToLocalFrame(i,t,T,_),a.pointToLocalFrame(i,t,E,d),d.x*=e.scale.x,d.y*=e.scale.y,d.z*=e.scale.z,_.x*=e.scale.x,_.y*=e.scale.y,_.z*=e.scale.z,d.vsub(_,h),h.normalize();var A=_.distanceSquared(d);e.tree.rayQuery(this,c,l);for(var C=0,w=l.length;!this.result._shouldStop&&C!==w;C++){var N=l[C];e.getNormal(N,s),e.getVertex(S[3*N],g),g.vsub(_,u);var F=h.dot(s),z=s.dot(u)/F;if(!(z<0)){h.scale(z,v),v.vadd(_,v),e.getVertex(S[3*N+1],y),e.getVertex(S[3*N+2],x);var U=v.distanceSquared(_);!f(v,y,g,x)&&!f(v,g,y,x)||A<U||(a.vectorToWorldFrame(t,s,m),a.pointToWorldFrame(i,t,v,p),this.reportIntersection(m,p,r,n,N))}}l.length=0},c.prototype[s.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(e,t,i,n,r){var a=this.from,o=this.to,s=a.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&0<e.dot(this._direction)))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(a,o,e,t,i,n,s),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(s<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(a,o,e,t,i,n,s));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(a,o,e,t,i,n,s),l._shouldStop=!0}};var N=new n,F=new n},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":30,"../math/Transform":31,"../math/Vec3":32,"../shapes/Box":39,"../shapes/ConvexPolyhedron":40,"../shapes/Shape":45}],11:[function(e,t,i){var n=e("../math/Vec3");function r(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}(t.exports=r).prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},r.prototype.abort=function(){this._shouldStop=!0},r.prototype.set=function(e,t,i,n,r,a,o){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=r,this.body=a,this.distance=o}},{"../math/Vec3":32}],12:[function(e,t,i){e("../shapes/Shape");var n=e("../collision/Broadphase");function r(e){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)},this._removeBodyHandler=function(e){var i=t.indexOf(e.body);-1!==i&&t.splice(i,1)},e&&this.setWorld(e)}((t.exports=r).prototype=new n).setWorld=function(e){for(var t=this.axisList.length=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},r.insertionSortX=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.x<=n.aabb.lowerBound.x);r--)e[r+1]=e[r];e[r+1]=n}return e},r.insertionSortY=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.y<=n.aabb.lowerBound.y);r--)e[r+1]=e[r];e[r+1]=n}return e},r.insertionSortZ=function(e){for(var t=1,i=e.length;t<i;t++){for(var n=e[t],r=t-1;0<=r&&!(e[r].aabb.lowerBound.z<=n.aabb.lowerBound.z);r--)e[r+1]=e[r];e[r+1]=n}return e},r.prototype.collisionPairs=function(e,t,i){var n,a,o=this.axisList,s=o.length,l=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==s;n++){var c=o[n];for(a=n+1;a<s;a++){var u=o[a];if(this.needBroadphaseCollision(c,u)){if(!r.checkBounds(c,u,l))break;this.intersectionTest(c,u,t,i)}}}},r.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,i=e.length,n=0;n!==i;n++){var a=e[n];a.aabbNeedsUpdate&&a.computeAABB()}0===t?r.insertionSortX(e):1===t?r.insertionSortY(e):2===t&&r.insertionSortZ(e)},r.checkBounds=function(e,t,i){var n,r;0===i?(n=e.position.x,r=t.position.x):1===i?(n=e.position.y,r=t.position.y):2===i&&(n=e.position.z,r=t.position.z);var a=e.boundingRadius;return r-t.boundingRadius<n+a},r.prototype.autoDetectAxis=function(){for(var e=0,t=0,i=0,n=0,r=0,a=0,o=this.axisList,s=o.length,l=1/s,c=0;c!==s;c++){var u=o[c],h=u.position.x;e+=h,t+=h*h;var _=u.position.y;i+=_,n+=_*_;var d=u.position.z;r+=d,a+=d*d}var f=t-e*e*l,p=n-i*i*l,m=a-r*r*l;this.axisIndex=p<f?m<f?0:2:m<p?1:2},r.prototype.aabbQuery=function(e,t,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,r="x";1===n&&(r="y"),2===n&&(r="z");for(var a=this.axisList,o=(t.lowerBound[r],t.upperBound[r],0);o<a.length;o++){var s=a[o];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&i.push(s)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":45}],13:[function(e,t,i){t.exports=s,e("./Constraint");var n=e("./PointToPointConstraint"),r=e("../equations/ConeEquation"),a=e("../equations/RotationalEquation"),o=(e("../equations/ContactEquation"),e("../math/Vec3"));function s(e,t,i){var s=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,l=i.pivotA?i.pivotA.clone():new o,c=i.pivotB?i.pivotB.clone():new o;this.axisA=i.axisA?i.axisA.clone():new o,this.axisB=i.axisB?i.axisB.clone():new o,n.call(this,e,l,t,c,s),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0;var u=this.coneEquation=new r(e,t,i),h=this.twistEquation=new a(e,t,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,u.maxForce=0,u.minForce=-s,h.maxForce=0,h.minForce=-s,this.equations.push(u,h)}s.prototype=new n,s.constructor=s,new o,new o,s.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,r=this.twistEquation;n.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(r.axisA,r.axisA),e.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),t.vectorToWorldFrame(r.axisB,r.axisB),i.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":32,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t,i){t.exports=r;var n=e("../utils/Utils");function r(e,t,i){i=n.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=r.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}r.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},r.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},r.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},r.idCounter=0},{"../utils/Utils":55}],15:[function(e,t,i){t.exports=a;var n=e("./Constraint"),r=e("../equations/ContactEquation");function a(e,t,i,a){n.call(this,e,t),void 0===i&&(i=e.position.distanceTo(t.position)),void 0===a&&(a=1e6),this.distance=i;var o=this.distanceEquation=new r(e,t);this.equations.push(o),o.minForce=-a,o.maxForce=a}(a.prototype=new n).update=function(){var e=this.bodyA,t=this.bodyB,i=this.distanceEquation,n=.5*this.distance,r=i.ni;t.position.vsub(e.position,r),r.normalize(),r.mult(n,i.ri),r.mult(-n,i.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t,i){t.exports=s,e("./Constraint");var n=e("./PointToPointConstraint"),r=e("../equations/RotationalEquation"),a=e("../equations/RotationalMotorEquation"),o=(e("../equations/ContactEquation"),e("../math/Vec3"));function s(e,t,i){var s=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,l=i.pivotA?i.pivotA.clone():new o,c=i.pivotB?i.pivotB.clone():new o;n.call(this,e,l,t,c,s),(this.axisA=i.axisA?i.axisA.clone():new o(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new o(1,0,0)).normalize();var u=this.rotationalEquation1=new r(e,t,i),h=this.rotationalEquation2=new r(e,t,i),_=this.motorEquation=new a(e,t,s);_.enabled=!1,this.equations.push(u,h,_)}s.prototype=new n,(s.constructor=s).prototype.enableMotor=function(){this.motorEquation.enabled=!0},s.prototype.disableMotor=function(){this.motorEquation.enabled=!1},s.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},s.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var l=new o,c=new o;s.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,r=this.rotationalEquation1,a=this.rotationalEquation2,o=l,s=c,u=this.axisA,h=this.axisB;n.prototype.update.call(this),e.quaternion.vmult(u,o),t.quaternion.vmult(h,s),o.tangents(r.axisA,a.axisA),r.axisB.copy(s),a.axisB.copy(s),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":32,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t,i){t.exports=o,e("./Constraint");var n=e("./PointToPointConstraint"),r=e("../equations/RotationalEquation"),a=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function o(e,t,i){var o=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,s=new a,l=new a,c=new a;e.position.vadd(t.position,c),c.scale(.5,c),t.pointToLocalFrame(c,l),e.pointToLocalFrame(c,s),n.call(this,e,s,t,l,o),this.xA=e.vectorToLocalFrame(a.UNIT_X),this.xB=t.vectorToLocalFrame(a.UNIT_X),this.yA=e.vectorToLocalFrame(a.UNIT_Y),this.yB=t.vectorToLocalFrame(a.UNIT_Y),this.zA=e.vectorToLocalFrame(a.UNIT_Z),this.zB=t.vectorToLocalFrame(a.UNIT_Z);var u=this.rotationalEquation1=new r(e,t,i),h=this.rotationalEquation2=new r(e,t,i),_=this.rotationalEquation3=new r(e,t,i);this.equations.push(u,h,_)}o.prototype=new n,o.constructor=o,new a,new a,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,a=this.rotationalEquation3;n.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),t.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,r.axisA),t.vectorToWorldFrame(this.zB,r.axisB),e.vectorToWorldFrame(this.zA,a.axisA),t.vectorToWorldFrame(this.xB,a.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":32,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t,i){t.exports=o;var n=e("./Constraint"),r=e("../equations/ContactEquation"),a=e("../math/Vec3");function o(e,t,i,o,s){n.call(this,e,i),s=void 0!==s?s:1e6,this.pivotA=t?t.clone():new a,this.pivotB=o?o.clone():new a;var l=this.equationX=new r(e,i),c=this.equationY=new r(e,i),u=this.equationZ=new r(e,i);this.equations.push(l,c,u),l.minForce=c.minForce=u.minForce=-s,l.maxForce=c.maxForce=u.maxForce=s,l.ni.set(1,0,0),c.ni.set(0,1,0),u.ni.set(0,0,1)}(o.prototype=new n).update=function(){var e=this.bodyA,t=this.bodyB,i=this.equationX,n=this.equationY,r=this.equationZ;e.quaternion.vmult(this.pivotA,i.ri),t.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),r.ri.copy(i.ri),r.rj.copy(i.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":32,"./Constraint":14}],19:[function(e,t,i){t.exports=o;var n=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation")),a=e("../math/CMath");function o(e,t,i){var a=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;r.call(this,e,t,-a,a),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.angle=void 0!==i.angle?i.angle:0}(o.prototype=new r).constructor=o;var s=new n,l=new n;o.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,o=s,c=l,u=this.jacobianElementA,h=this.jacobianElementB;return n.cross(r,o),r.cross(n,c),u.rotational.copy(c),h.rotational.copy(o),-(a.cos(this.angle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/CMath":27,"../math/Mat3":29,"../math/Vec3":32,"./Equation":21}],20:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){i=void 0!==i?i:1e6,n.call(this,e,t,0,i),this.si=null,this.sj=null,this.restitution=0,this.ri=new r,this.rj=new r,this.ni=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var o=new r,s=new r,l=new r;a.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.bi,r=this.bj,a=this.ri,c=this.rj,u=o,h=s,_=n.velocity,d=n.angularVelocity,f=(n.force,n.torque,r.velocity),p=r.angularVelocity,m=(r.force,r.torque,l),v=this.jacobianElementA,g=this.jacobianElementB,y=this.ni;a.cross(y,u),c.cross(y,h),y.negate(v.spatial),u.negate(v.rotational),g.spatial.copy(y),g.rotational.copy(h),m.copy(r.position),m.vadd(c,m),m.vsub(n.position,m),m.vsub(a,m);var x=y.dot(m),S=this.restitution+1;return-x*t-(S*f.dot(y)-S*_.dot(y)+p.dot(h)-d.dot(u))*i-e*this.computeGiMf()};var c=new r,u=new r,h=new r,_=new r,d=new r;a.prototype.getImpactVelocityAlongNormal=function(){var e=c,t=u,i=h,n=_,r=d;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,e),this.bj.getVelocityAtWorldPoint(n,t),e.vsub(t,r),this.ni.dot(r)}},{"../math/Mat3":29,"../math/Vec3":32,"./Equation":21}],21:[function(e,t,i){t.exports=a;var n=e("../math/JacobianElement"),r=e("../math/Vec3");function a(e,t,i,r){this.id=a.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===r?1e6:r,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}(a.prototype.constructor=a).id=0,a.prototype.setSpookParams=function(e,t,i){var n=t,r=e,a=i;this.a=4/(a*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(a*a*r*(1+4*n))},a.prototype.computeB=function(e,t,i){var n=this.computeGW();return-this.computeGq()*e-n*t-this.computeGiMf()*i},a.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.position,a=n.position;return e.spatial.dot(r)+t.spatial.dot(a)},new r,a.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.velocity,a=n.velocity,o=i.angularVelocity,s=n.angularVelocity;return e.multiplyVectors(r,o)+t.multiplyVectors(a,s)},a.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.vlambda,a=n.vlambda,o=i.wlambda,s=n.wlambda;return e.multiplyVectors(r,o)+t.multiplyVectors(a,s)};var o=new r,s=new r,l=new r,c=new r;a.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.force,a=i.torque,u=n.force,h=n.torque,_=i.invMassSolve,d=n.invMassSolve;return r.scale(_,o),u.scale(d,s),i.invInertiaWorldSolve.vmult(a,l),n.invInertiaWorldSolve.vmult(h,c),e.multiplyVectors(o,l)+t.multiplyVectors(s,c)};var u=new r;a.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,i=this.bi,n=this.bj,r=i.invMassSolve,a=n.invMassSolve,o=i.invInertiaWorldSolve,s=n.invInertiaWorldSolve,l=r+a;return o.vmult(e.rotational,u),l+=u.dot(e.rotational),s.vmult(t.rotational,u),l+u.dot(t.rotational)};var h=new r;new r,new r,new r,new r,new r,a.prototype.addToWlambda=function(e){var t=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,r=this.bj,a=h;n.vlambda.addScaledVector(n.invMassSolve*e,t.spatial,n.vlambda),r.vlambda.addScaledVector(r.invMassSolve*e,i.spatial,r.vlambda),n.invInertiaWorldSolve.vmult(t.rotational,a),n.wlambda.addScaledVector(e,a,n.wlambda),r.invInertiaWorldSolve.vmult(i.rotational,a),r.wlambda.addScaledVector(e,a,r.wlambda)},a.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":28,"../math/Vec3":32}],22:[function(e,t,i){t.exports=a;var n=e("./Equation"),r=e("../math/Vec3");function a(e,t,i){n.call(this,e,t,-i,i),this.ri=new r,this.rj=new r,this.t=new r}e("../math/Mat3"),(a.prototype=new n).constructor=a;var o=new r,s=new r;a.prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,r=o,a=s,l=this.t;i.cross(l,r),n.cross(l,a);var c=this.jacobianElementA,u=this.jacobianElementB;return l.negate(c.spatial),r.negate(c.rotational),u.spatial.copy(l),u.rotational.copy(a),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":29,"../math/Vec3":32,"./Equation":21}],23:[function(e,t,i){t.exports=o;var n=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation")),a=e("../math/CMath");function o(e,t,i){var a=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;r.call(this,e,t,-a,a),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}(o.prototype=new r).constructor=o;var s=new n,l=new n;o.prototype.computeB=function(e){var t=this.a,i=this.b,n=this.axisA,r=this.axisB,o=s,c=l,u=this.jacobianElementA,h=this.jacobianElementB;return n.cross(r,o),r.cross(n,c),u.rotational.copy(c),h.rotational.copy(o),-(a.cos(this.maxAngle)-n.dot(r))*t-this.computeGW()*i-e*this.computeGiMf()}},{"../math/CMath":27,"../math/Mat3":29,"../math/Vec3":32,"./Equation":21}],24:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=(e("../math/Mat3"),e("./Equation"));function a(e,t,i){i=void 0!==i?i:1e6,r.call(this,e,t,-i,i),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}((a.prototype=new r).constructor=a).prototype.computeB=function(e){this.a;var t=this.b,i=(this.bi,this.bj,this.axisA),n=this.axisB,r=this.jacobianElementA,a=this.jacobianElementB;return r.rotational.copy(i),n.negate(a.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":29,"../math/Vec3":32,"./Equation":21}],25:[function(e,t,i){var n=e("../utils/Utils");(t.exports=function e(t,i,r){r=n.defaults(r,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[t,i],this.friction=r.friction,this.restitution=r.restitution,this.contactEquationStiffness=r.contactEquationStiffness,this.contactEquationRelaxation=r.contactEquationRelaxation,this.frictionEquationStiffness=r.frictionEquationStiffness,this.frictionEquationRelaxation=r.frictionEquationRelaxation}).idCounter=0},{"../utils/Utils":55}],26:[function(e,t,i){(t.exports=function e(t){var i="";"string"==typeof(t=t||{})?(i=t,t={}):"object"==typeof t&&(i=""),this.name=i,this.id=e.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}).idCounter=0},{}],27:[function(e,t,i){var n=180/Math.PI;function r(e){return e*n}var a={};function o(e){if(a.digit!=e){for(var t=1/Math.pow(10,e),i=0;i<=90;i+=t)a[i.toFixed(e)]=Math.sin(i/n);a.digit=e}}function s(e,t){return e<=90?a[e.toFixed(t)]:e<=180?a[(e=180-e).toFixed(t)]:e<=270?-a[(e-=180).toFixed(t)]:-a[(e=360-e).toFixed(t)]}function l(e){var t=r(e)%360;return t<0&&(t+=360),s(t,_._digit)}function c(e){var t=(r(e)+90)%360;return t<0&&(t+=360),s(t,_._digit)}function u(e){return Math.sin(e).toFixed(_.digit)}function h(e){return Math.cos(e).toFixed(_.digit)}var _={sin:Math.sin,cos:Math.cos,atan2:Math.atan2};_._sin=l,_._cos=c,_._sinArr=a,_._sin360=s,_._sinNative=u,_._cosNative=h,_._radian2angle=r,_._calculateSinByDigit=o,_._digit=1,Object.defineProperty(_,"digit",{get:function(){return this._digit},set:function(e){this._digit=e,1==this._mode&&o(e)}}),_._mode=0,Object.defineProperty(_,"mode",{get:function(){return this._mode},set:function(e){this._mode!=e&&(0==(this._mode=e)?(_.sin=Math.sin,_.cos=Math.cos):1==e?(_.digit=_._digit,_.sin=l,_.cos=c):2==e&&(_.sin=u,_.cos=h))}}),t.exports=_},{}],28:[function(e,t,i){t.exports=r;var n=e("./Vec3");function r(){this.spatial=new n,this.rotational=new n}r.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},r.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":32}],29:[function(e,t,i){t.exports=r;var n=e("./Vec3");function r(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}r.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},r.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},r.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},r.prototype.getTrace=function(e){e=e||new n;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},r.prototype.vmult=function(e,t){t=t||new n;var i=this.elements,r=e.x,a=e.y,o=e.z;return t.x=i[0]*r+i[1]*a+i[2]*o,t.y=i[3]*r+i[4]*a+i[5]*o,t.z=i[6]*r+i[7]*a+i[8]*o,t},r.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},r.prototype.mmult=function(e,t){for(var i=t||new r,n=0;n<3;n++)for(var a=0;a<3;a++){for(var o=0,s=0;s<3;s++)o+=e.elements[n+3*s]*this.elements[s+3*a];i.elements[n+3*a]=o}return i},r.prototype.scale=function(e,t){t=t||new r;for(var i=this.elements,n=t.elements,a=0;3!==a;a++)n[3*a+0]=e.x*i[3*a+0],n[3*a+1]=e.y*i[3*a+1],n[3*a+2]=e.z*i[3*a+2];return t},r.prototype.solve=function(e,t){t=t||new n;for(var i,r=[],a=0;a<12;a++)r.push(0);for(a=0;a<3;a++)for(i=0;i<3;i++)r[a+4*i]=this.elements[a+3*i];r[3]=e.x,r[7]=e.y,r[11]=e.z;var o,s,l=3,c=l;do{if(0===r[(a=c-l)+4*a])for(i=a+1;i<c;i++)if(0!==r[a+4*i]){for(o=4;r[(s=4-o)+4*a]+=r[s+4*i],--o;);break}if(0!==r[a+4*a])for(i=a+1;i<c;i++){var u=r[a+4*i]/r[a+4*a];for(o=4;r[(s=4-o)+4*i]=s<=a?0:r[s+4*i]-r[s+4*a]*u,--o;);}}while(--l);if(t.z=r[11]/r[10],t.y=(r[7]-r[6]*t.z)/r[5],t.x=(r[3]-r[2]*t.z-r[1]*t.y)/r[0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},r.prototype.e=function(e,t,i){if(void 0===i)return this.elements[t+3*e];this.elements[t+3*e]=i},r.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},r.prototype.toString=function(){for(var e="",t=0;t<9;t++)e+=this.elements[t]+",";return e},r.prototype.reverse=function(e){e=e||new r;for(var t,i=[],n=0;n<18;n++)i.push(0);for(n=0;n<3;n++)for(t=0;t<3;t++)i[n+6*t]=this.elements[n+3*t];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var a,o,s=3,l=s;do{if(0===i[(n=l-s)+6*n])for(t=n+1;t<l;t++)if(0!==i[n+6*t]){for(a=6;i[(o=6-a)+6*n]+=i[o+6*t],--a;);break}if(0!==i[n+6*n])for(t=n+1;t<l;t++){var c=i[n+6*t]/i[n+6*n];for(a=6;i[(o=6-a)+6*t]=o<=n?0:i[o+6*t]-i[o+6*n]*c,--a;);}}while(--s);n=2;do{t=n-1;do{for(c=i[n+6*t]/i[n+6*n],a=6;i[(o=6-a)+6*t]=i[o+6*t]-i[o+6*n]*c,--a;);}while(t--)}while(--n);n=2;do{for(c=1/i[n+6*n],a=6;i[(o=6-a)+6*n]=i[o+6*n]*c,--a;);}while(n--);n=2;do{t=2;do{if(o=i[3+t+6*n],isNaN(o)||o===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(n,t,o)}while(t--)}while(n--);return e},r.prototype.setRotationFromQuaternion=function(e){var t=e.x,i=e.y,n=e.z,r=e.w,a=t+t,o=i+i,s=n+n,l=t*a,c=t*o,u=t*s,h=i*o,_=i*s,d=n*s,f=r*a,p=r*o,m=r*s,v=this.elements;return v[0]=1-(h+d),v[1]=c-m,v[2]=u+p,v[3]=c+m,v[4]=1-(l+d),v[5]=_-f,v[6]=u-p,v[7]=_+f,v[8]=1-(l+h),this},r.prototype.transpose=function(e){for(var t=(e=e||new r).elements,i=this.elements,n=0;3!==n;n++)for(var a=0;3!==a;a++)t[3*n+a]=i[3*a+n];return e}},{"./Vec3":32}],30:[function(e,t,i){t.exports=a;var n=e("./Vec3"),r=e("./CMath");function a(e,t,i,n){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1}a.prototype.set=function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},a.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},a.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},a.prototype.setFromAxisAngle=function(e,t){var i=r.sin(.5*t);return this.x=e.x*i,this.y=e.y*i,this.z=e.z*i,this.w=r.cos(.5*t),this},a.prototype.toAxisAngle=function(e){e=e||new n,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var o=new n,s=new n;a.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var i=o,n=s;e.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var r=e.cross(t);this.x=r.x,this.y=r.y,this.z=r.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}return this},new n,new n,new n,a.prototype.mult=function(e,t){t=t||new a;var i=this.x,n=this.y,r=this.z,o=this.w,s=e.x,l=e.y,c=e.z,u=e.w;return t.x=i*u+o*s+n*c-r*l,t.y=n*u+o*l+r*s-i*c,t.z=r*u+o*c+i*l-n*s,t.w=o*u-i*s-n*l-r*c,t},a.prototype.inverse=function(e){var t=this.x,i=this.y,n=this.z,r=this.w;e=e||new a,this.conjugate(e);var o=1/(t*t+i*i+n*n+r*r);return e.x*=o,e.y*=o,e.z*=o,e.w*=o,e},a.prototype.conjugate=function(e){return(e=e||new a).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},a.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},a.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0==e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},a.prototype.vmult=function(e,t){t=t||new n;var i=e.x,r=e.y,a=e.z,o=this.x,s=this.y,l=this.z,c=this.w,u=c*i+s*a-l*r,h=c*r+l*i-o*a,_=c*a+o*r-s*i,d=-o*i-s*r-l*a;return t.x=u*c+d*-o+h*-l-_*-s,t.y=h*c+d*-s+_*-o-u*-l,t.z=_*c+d*-l+u*-s-h*-o,t},a.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},a.prototype.toEuler=function(e,t){var i,n,a;t=t||"YZX";var o=this.x,s=this.y,l=this.z,c=this.w;switch(t){case"YZX":var u=o*s+l*c;if(.499<u&&(i=2*r.atan2(o,c),n=Math.PI/2,a=0),u<-.499&&(i=-2*r.atan2(o,c),n=-Math.PI/2,a=0),isNaN(i)){var h=o*o,_=s*s,d=l*l;i=r.atan2(2*s*c-2*o*l,1-2*_-2*d),n=Math.asin(2*u),a=r.atan2(2*o*c-2*s*l,1-2*h-2*d)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=i,e.z=n,e.x=a},a.prototype.setFromEuler=function(e,t,i,n){n=n||"XYZ";var a=r.cos(e/2),o=r.cos(t/2),s=r.cos(i/2),l=r.sin(e/2),c=r.sin(t/2),u=r.sin(i/2);return"XYZ"===n?(this.x=l*o*s+a*c*u,this.y=a*c*s-l*o*u,this.z=a*o*u+l*c*s,this.w=a*o*s-l*c*u):"YXZ"===n?(this.x=l*o*s+a*c*u,this.y=a*c*s-l*o*u,this.z=a*o*u-l*c*s,this.w=a*o*s+l*c*u):"ZXY"===n?(this.x=l*o*s-a*c*u,this.y=a*c*s+l*o*u,this.z=a*o*u+l*c*s,this.w=a*o*s-l*c*u):"ZYX"===n?(this.x=l*o*s-a*c*u,this.y=a*c*s+l*o*u,this.z=a*o*u-l*c*s,this.w=a*o*s+l*c*u):"YZX"===n?(this.x=l*o*s+a*c*u,this.y=a*c*s+l*o*u,this.z=a*o*u-l*c*s,this.w=a*o*s-l*c*u):"XZY"===n&&(this.x=l*o*s-a*c*u,this.y=a*c*s-l*o*u,this.z=a*o*u+l*c*s,this.w=a*o*s+l*c*u),this},a.prototype.clone=function(){return new a(this.x,this.y,this.z,this.w)},a.prototype.slerp=function(e,t,i){i=i||new a;var n,o,s,l,c,u=this.x,h=this.y,_=this.z,d=this.w,f=e.x,p=e.y,m=e.z,v=e.w;return(o=u*f+h*p+_*m+d*v)<0&&(o=-o,f=-f,p=-p,m=-m,v=-v),c=1e-6<1-o?(n=Math.acos(o),s=r.sin(n),l=r.sin((1-t)*n)/s,r.sin(t*n)/s):(l=1-t,t),i.x=l*u+c*f,i.y=l*h+c*p,i.z=l*_+c*m,i.w=l*d+c*v,i},a.prototype.integrate=function(e,t,i,n){n=n||new a;var r=e.x*i.x,o=e.y*i.y,s=e.z*i.z,l=this.x,c=this.y,u=this.z,h=this.w,_=.5*t;return n.x+=_*(r*h+o*u-s*c),n.y+=_*(o*h+s*l-r*u),n.z+=_*(s*h+r*c-o*l),n.w+=_*(-r*l-o*c-s*u),n}},{"./CMath":27,"./Vec3":32}],31:[function(e,t,i){var n=e("./Vec3"),r=e("./Quaternion");function a(e){e=e||{},this.position=new n,e.position&&this.position.copy(e.position),this.quaternion=new r,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=a;var o=new r;a.pointToLocalFrame=function(e,t,i,r){return r=r||new n,i.vsub(e,r),t.conjugate(o),o.vmult(r,r),r},a.prototype.pointToLocal=function(e,t){return a.pointToLocalFrame(this.position,this.quaternion,e,t)},a.pointToWorldFrame=function(e,t,i,r){return r=r||new n,t.vmult(i,r),r.vadd(e,r),r},a.prototype.pointToWorld=function(e,t){return a.pointToWorldFrame(this.position,this.quaternion,e,t)},a.prototype.vectorToWorldFrame=function(e,t){return t=t||new n,this.quaternion.vmult(e,t),t},a.vectorToWorldFrame=function(e,t,i){return e.vmult(t,i),i},a.vectorToLocalFrame=function(e,t,i,r){return r=r||new n,t.w*=-1,t.vmult(i,r),t.w*=-1,r}},{"./Quaternion":30,"./Vec3":32}],32:[function(e,t,i){t.exports=r;var n=e("./Mat3");function r(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}r.ZERO=new r(0,0,0),r.UNIT_X=new r(1,0,0),r.UNIT_Y=new r(0,1,0),r.UNIT_Z=new r(0,0,1),r.prototype.cross=function(e,t){var i=e.x,n=e.y,a=e.z,o=this.x,s=this.y,l=this.z;return(t=t||new r).x=s*a-l*n,t.y=l*i-o*a,t.z=o*n-s*i,t},r.prototype.set=function(e,t,i){return this.x=e,this.y=t,this.z=i,this},r.prototype.setZero=function(){this.x=this.y=this.z=0},r.prototype.vadd=function(e,t){if(!t)return new r(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},r.prototype.vsub=function(e,t){if(!t)return new r(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},r.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},r.prototype.normalize=function(){var e=this.x,t=this.y,i=this.z,n=Math.sqrt(e*e+t*t+i*i);if(0<n){var r=1/n;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return n},r.prototype.unit=function(e){e=e||new r;var t=this.x,i=this.y,n=this.z,a=Math.sqrt(t*t+i*i+n*n);return 0<a?(a=1/a,e.x=t*a,e.y=i*a,e.z=n*a):(e.x=1,e.y=0,e.z=0),e},r.prototype.length=r.prototype.norm=function(){var e=this.x,t=this.y,i=this.z;return Math.sqrt(e*e+t*t+i*i)},r.prototype.lengthSquared=r.prototype.norm2=function(){return this.dot(this)},r.prototype.distanceTo=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,o=e.z;return Math.sqrt((r-t)*(r-t)+(a-i)*(a-i)+(o-n)*(o-n))},r.prototype.distanceSquared=function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,o=e.z;return(r-t)*(r-t)+(a-i)*(a-i)+(o-n)*(o-n)},r.prototype.mult=function(e,t){t=t||new r;var i=this.x,n=this.y,a=this.z;return t.x=e*i,t.y=e*n,t.z=e*a,t},r.prototype.vmul=function(e,t){return(t=t||new r).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},r.prototype.scale=r.prototype.mult,r.prototype.addScaledVector=function(e,t,i){return(i=i||new r).x=this.x+e*t.x,i.y=this.y+e*t.y,i.z=this.z+e*t.z,i},r.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},r.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},r.prototype.negate=function(e){return(e=e||new r).x=-this.x,e.y=-this.y,e.z=-this.z,e};var a=new r,o=new r;r.prototype.tangents=function(e,t){var i=this.norm();if(0<i){var n=a,r=1/i;n.set(this.x*r,this.y*r,this.z*r);var s=o;Math.abs(n.x)<.9?s.set(1,0,0):s.set(0,1,0),n.cross(s,e),n.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},r.prototype.toString=function(){return this.x+","+this.y+","+this.z},r.prototype.toArray=function(){return[this.x,this.y,this.z]},r.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},r.prototype.lerp=function(e,t,i){var n=this.x,r=this.y,a=this.z;i.x=n+(e.x-n)*t,i.y=r+(e.y-r)*t,i.z=a+(e.z-a)*t},r.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},r.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var s=new r;r.prototype.isAntiparallelTo=function(e,t){return this.negate(s),s.almostEquals(e,t)},r.prototype.clone=function(){return new r(this.x,this.y,this.z)}},{"./Mat3":29}],33:[function(e,t,i){t.exports=u;var n=e("../utils/EventTarget"),r=(e("../shapes/Shape"),e("../math/Vec3")),a=e("../math/Mat3"),o=e("../math/Quaternion"),s=(e("../material/Material"),e("../collision/AABB")),l=e("../shapes/Box"),c=e("../world/World");function u(e){e=e||{},n.apply(this),this.id=u.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new r,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new r,this.previousPosition=new r,this.interpolatedPosition=new r,this.initPosition=new r,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new r,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new r,this.force=new r;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=0<t?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?u.STATIC:u.DYNAMIC,typeof e.type==typeof u.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new r,this.quaternion=new o,this.initQuaternion=new o,this.previousQuaternion=new o,this.interpolatedQuaternion=new o,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new r,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new r,this.invInertia=new r,this.invInertiaWorld=new a,this.invMassSolve=0,this.invInertiaSolve=new r,this.invInertiaWorldSolve=new a,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new r(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new r(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new s,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new r,e.shape&&this.addShape(e.shape),this.hasTrigger=!0,this.updateMassProperties()}((u.prototype=new n).constructor=u).COLLIDE_EVENT_NAME="collide",u.DYNAMIC=1,u.STATIC=2,u.KINEMATIC=4,u.AWAKE=0,u.SLEEPY=1,u.SLEEPING=2,u.idCounter=0,u.wakeupEvent={type:"wakeup"},u.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===u.SLEEPING&&this.dispatchEvent(u.wakeupEvent)},u.prototype.sleep=function(){this.sleepState=u.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},u.sleepyEvent={type:"sleepy"},u.sleepEvent={type:"sleep"},u.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);t===u.AWAKE&&i<n?(this.sleepState=u.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(u.sleepyEvent)):t===u.SLEEPY&&n<i?this.wakeUp():t===u.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(u.sleepEvent))}},u.prototype.updateSolveMassProperties=function(){this.sleepState===u.SLEEPING||this.type===u.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},u.prototype.pointToLocalFrame=function(e,t){return t=t||new r,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},u.prototype.vectorToLocalFrame=function(e,t){return t=t||new r,this.quaternion.conjugate().vmult(e,t),t},u.prototype.pointToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},u.prototype.vectorToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t};var h=new r,_=new o;u.prototype.addShape=function(e,t,i){var n=new r,a=new o;return t&&n.copy(t),i&&a.copy(i),this.shapes.push(e),this.shapeOffsets.push(n),this.shapeOrientations.push(a),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger(),(c.idToShapeMap[e.id]=e).body=this},u.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger())},u.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,i=e.length,n=0,r=0;r!==i;r++){var a=e[r];a.updateBoundingSphereRadius();var o=t[r].norm(),s=a.boundingSphereRadius;n<o+s&&(n=o+s)}this.boundingRadius=n};var d=new s;u.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,i=this.shapeOrientations,n=e.length,r=h,a=_,o=this.quaternion,s=this.aabb,l=d,c=0;c!==n;c++){var u=e[c];o.vmult(t[c],r),r.vadd(this.position,r),i[c].mult(o,a),u.calculateWorldAABB(r,a,l.lowerBound,l.upperBound),0===c?s.copy(l):s.extend(l)}this.aabbNeedsUpdate=!1};var f=new a,p=new a;new a,u.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var i=f,n=p;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(t,i),i.mmult(n,this.invInertiaWorld)}},new r;var m=new r;u.prototype.applyForce=function(e,t){if(this.type===u.DYNAMIC){var i=m;t.cross(e,i),this.force.vadd(e,this.force),this.torque.vadd(i,this.torque)}};var v=new r,g=new r;u.prototype.applyLocalForce=function(e,t){if(this.type===u.DYNAMIC){var i=v,n=g;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyForce(i,n)}},new r;var y=new r,x=new r;u.prototype.applyImpulse=function(e,t){if(this.type===u.DYNAMIC){var i=t,n=y;n.copy(e),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var r=x;i.cross(e,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var S=new r,T=new r;u.prototype.applyLocalImpulse=function(e,t){if(this.type===u.DYNAMIC){var i=S,n=T;this.vectorToWorldFrame(e,i),this.vectorToWorldFrame(t,n),this.applyImpulse(i,n)}};var E=new r;u.prototype.updateMassProperties=function(){var e=E;this.invMass=0<this.mass?1/this.mass:0;var t=this.inertia,i=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),l.calculateInertia(e,this.mass,t),this.invInertia.set(0<t.x&&!i?1/t.x:0,0<t.y&&!i?1/t.y:0,0<t.z&&!i?1/t.z:0),this.updateInertiaWorld(!0)},u.prototype.getVelocityAtWorldPoint=function(e,t){var i=new r;return e.vsub(this.position,i),this.angularVelocity.cross(i,t),this.velocity.vadd(t,t),t},new r,new r,new o,new o,u.prototype.integrate=function(e,t,i){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===u.DYNAMIC||this.type===u.KINEMATIC)&&this.sleepState!==u.SLEEPING){var n=this.velocity,r=this.angularVelocity,a=this.position,o=this.force,s=this.torque,l=this.quaternion,c=this.invMass,h=this.invInertiaWorld,_=this.linearFactor,d=c*e;n.x+=o.x*d*_.x,n.y+=o.y*d*_.y,n.z+=o.z*d*_.z;var f=h.elements,p=this.angularFactor,m=s.x*p.x,v=s.y*p.y,g=s.z*p.z;r.x+=e*(f[0]*m+f[1]*v+f[2]*g),r.y+=e*(f[3]*m+f[4]*v+f[5]*g),r.z+=e*(f[6]*m+f[7]*v+f[8]*g),a.x+=n.x*e,a.y+=n.y*e,a.z+=n.z*e,l.integrate(this.angularVelocity,e,this.angularFactor,l),t&&(i?l.normalizeFast():l.normalize()),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},u.prototype.isSleeping=function(){return this.sleepState===u.SLEEPING},u.prototype.isSleepy=function(){return this.sleepState===u.SLEEPY},u.prototype.isAwake=function(){return this.sleepState===u.AWAKE},u.prototype.updateHasTrigger=function(){for(var e=this.shapes.length;e--&&(this.hasTrigger=!this.shapes[e].collisionResponse,!this.hasTrigger););}},{"../collision/AABB":3,"../material/Material":26,"../math/Mat3":29,"../math/Quaternion":30,"../math/Vec3":32,"../shapes/Box":39,"../shapes/Shape":45,"../utils/EventTarget":51,"../world/World":58}],34:[function(e,t,i){e("./Body");var n=e("../math/Vec3"),r=e("../math/Quaternion"),a=(e("../collision/RaycastResult"),e("../collision/Ray")),o=e("../objects/WheelInfo");function s(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=s,new n,new n,new n;var l=new n,c=new n,u=new n;new a,s.prototype.addWheel=function(e){var t=new o(e=e||{}),i=this.wheelInfos.length;return this.wheelInfos.push(t),i},s.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new n,s.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},s.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},s.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},s.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},s.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,r=this.chassisBody,a=0;a<i;a++)this.updateWheelTransform(a);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var o=new n;for(this.getVehicleAxisWorld(this.indexForwardAxis,o),o.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),a=0;a<i;a++)this.castRay(t[a]);this.updateSuspension(e);var s=new n,l=new n;for(a=0;a<i;a++){var c=(d=t[a]).suspensionForce;c>d.maxSuspensionForce&&(c=d.maxSuspensionForce),d.raycastResult.hitNormalWorld.scale(c*e,s),d.raycastResult.hitPointWorld.vsub(r.position,l),r.applyImpulse(s,l)}this.updateFriction(e);var u=new n,h=new n,_=new n;for(a=0;a<i;a++){var d=t[a];r.getVelocityAtWorldPoint(d.chassisConnectionPointWorld,_);var f=1;switch(this.indexUpAxis){case 1:f=-1}if(d.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,h);var p=h.dot(d.raycastResult.hitNormalWorld);d.raycastResult.hitNormalWorld.scale(p,u),h.vsub(u,h);var m=h.dot(_);d.deltaRotation=f*m*e/d.radius}!d.sliding&&d.isInContact||0===d.engineForce||!d.useCustomSlidingRotationalSpeed||(d.deltaRotation=(0<d.engineForce?1:-1)*d.customSlidingRotationalSpeed*e),Math.abs(d.brake)>Math.abs(d.engineForce)&&(d.deltaRotation=0),d.rotation+=d.deltaRotation,d.deltaRotation*=.99}},s.prototype.updateSuspension=function(e){for(var t=this.chassisBody.mass,i=this.wheelInfos,n=i.length,r=0;r<n;r++){var a=i[r];if(a.isInContact){var o,s=a.suspensionRestLength-a.suspensionLength;o=a.suspensionStiffness*s*a.clippedInvContactDotSuspension;var l=a.suspensionRelativeVelocity;o-=(l<0?a.dampingCompression:a.dampingRelaxation)*l,a.suspensionForce=o*t,a.suspensionForce<0&&(a.suspensionForce=0)}else a.suspensionForce=0}},s.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var h=new n,_=new n;s.prototype.castRay=function(e){var t=h,i=_;this.updateWheelTransformWorld(e);var r=this.chassisBody,a=-1,o=e.suspensionRestLength+e.radius;e.directionWorld.scale(o,t);var s=e.chassisConnectionPointWorld;s.vadd(t,i);var l=e.raycastResult;l.reset();var c=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(s,i,l),r.collisionResponse=c;var u=l.body;if(e.raycastResult.groundObject=0,u){a=l.distance,e.raycastResult.hitNormalWorld=l.hitNormalWorld,e.isInContact=!0;var d=l.distance;e.suspensionLength=d-e.radius;var f=e.suspensionRestLength-e.maxSuspensionTravel,p=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<f&&(e.suspensionLength=f),e.suspensionLength>p&&(e.suspensionLength=p,e.raycastResult.reset());var m=e.raycastResult.hitNormalWorld.dot(e.directionWorld),v=new n;r.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,v);var g=e.raycastResult.hitNormalWorld.dot(v);if(-.1<=m)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var y=-1/m;e.suspensionRelativeVelocity=g*y,e.clippedInvContactDotSuspension=y}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return a},s.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},s.prototype.updateWheelTransform=function(e){var t=l,i=c,n=u,a=this.wheelInfos[e];this.updateWheelTransformWorld(a),a.directionLocal.scale(-1,t),i.copy(a.axleLocal),t.cross(i,n),n.normalize(),i.normalize();var o=a.steering,s=new r;s.setFromAxisAngle(t,o);var h=new r;h.setFromAxisAngle(i,a.rotation);var _=a.worldTransform.quaternion;this.chassisBody.quaternion.mult(s,_),_.mult(h,_),_.normalize();var d=a.worldTransform.position;d.copy(a.directionWorld),d.scale(a.suspensionLength,d),d.vadd(a.chassisConnectionPointWorld,d)};var d=[new n(1,0,0),new n(0,1,0),new n(0,0,1)];s.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var f=new n,p=[],m=[];s.prototype.updateFriction=function(e){for(var t=f,i=this.wheelInfos,r=i.length,a=this.chassisBody,o=m,s=p,l=0;l<r;l++)_=(C=i[l]).raycastResult.body,C.sideImpulse=0,C.forwardImpulse=0,o[l]||(o[l]=new n),s[l]||(s[l]=new n);for(l=0;l<r;l++)if(_=(C=i[l]).raycastResult.body){var c=s[l];this.getWheelTransformWorld(l).vectorToWorldFrame(d[this.indexRightAxis],c);var u=C.raycastResult.hitNormalWorld,h=c.dot(u);u.scale(h,t),c.vsub(t,c),c.normalize(),u.cross(c,o[l]),o[l].normalize(),C.sideImpulse=I(a,C.raycastResult.hitPointWorld,_,C.raycastResult.hitPointWorld,c),C.sideImpulse*=1}for(this.sliding=!1,l=0;l<r;l++){var _=(C=i[l]).raycastResult.body,v=0;if(C.slipInfo=1,_){var g=C.brake?C.brake:0;v=x(a,_,C.raycastResult.hitPointWorld,o[l],g);var y=g/(v+=C.engineForce*e);C.slipInfo*=y}if(C.forwardImpulse=0,C.skidInfo=1,_){C.skidInfo=1;var S=C.suspensionForce*e*C.frictionSlip,T=S*S;C.forwardImpulse=v;var E=.5*C.forwardImpulse,b=1*C.sideImpulse,A=E*E+b*b;C.sliding=!1,T<A&&(this.sliding=!0,C.sliding=!0,y=S/Math.sqrt(A),C.skidInfo*=y)}}if(this.sliding)for(l=0;l<r;l++)0!==(C=i[l]).sideImpulse&&C.skidInfo<1&&(C.forwardImpulse*=C.skidInfo,C.sideImpulse*=C.skidInfo);for(l=0;l<r;l++){var C=i[l],w=new n;if(C.raycastResult.hitPointWorld.vsub(a.position,w),0!==C.forwardImpulse){var R=new n;o[l].scale(C.forwardImpulse,R),a.applyImpulse(R,w)}if(0!==C.sideImpulse){_=C.raycastResult.body;var O=new n;C.raycastResult.hitPointWorld.vsub(_.position,O);var M=new n;s[l].scale(C.sideImpulse,M),a.vectorToLocalFrame(w,w),w["xyz"[this.indexUpAxis]]*=C.rollInfluence,a.vectorToWorldFrame(w,w),a.applyImpulse(M,w),M.scale(-1,M),_.applyImpulse(M,O)}}};var v=new n,g=new n,y=new n;function x(e,t,i,n,r){var a=0,o=i,s=v,l=g,c=y;return e.getVelocityAtWorldPoint(o,s),t.getVelocityAtWorldPoint(o,l),s.vsub(l,c),r<(a=-n.dot(c)*(1/(A(e,i,n)+A(t,i,n))))&&(a=r),a<-r&&(a=-r),a}var S=new n,T=new n,E=new n,b=new n;function A(e,t,i){var n=S,r=T,a=E,o=b;return t.vsub(e.position,n),n.cross(i,r),e.invInertiaWorld.vmult(r,o),o.cross(n,a),e.invMass+i.dot(a)}var C=new n,w=new n,R=new n;function I(e,t,i,n,r){if(1.1<r.norm2())return 0;var a=C,o=w,s=R;return e.getVelocityAtWorldPoint(t,a),i.getVelocityAtWorldPoint(n,o),a.vsub(o,s),-.2*r.dot(s)*(1/(e.invMass+i.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":30,"../math/Vec3":32,"../objects/WheelInfo":38,"./Body":33}],35:[function(e,t,i){var n=e("./Body"),r=e("../shapes/Sphere"),a=e("../shapes/Box"),o=e("../math/Vec3"),s=e("../constraints/HingeConstraint"),l=e("../math/CMath");function c(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new o(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new a(new o(5,2,.5));this.chassisBody=new n(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}(t.exports=c).prototype.addWheel=function(e){var t=(e=e||{}).body;t=t||new n(1,new r(1.2)),this.wheelBodies.push(t),this.wheelForces.push(0),new o;var i=void 0!==e.position?e.position.clone():new o,a=new o;this.chassisBody.pointToWorldFrame(i,a),t.position.set(a.x,a.y,a.z);var l=void 0!==e.axis?e.axis.clone():new o(0,1,0);this.wheelAxes.push(l);var c=new s(this.chassisBody,t,{pivotA:i,axisA:l,pivotB:o.ZERO,axisB:l,collideConnected:!1});return this.constraints.push(c),this.wheelBodies.length-1},c.prototype.setSteeringValue=function(e,t){var i=this.wheelAxes[t],n=l.cos(e),r=l.sin(e),a=i.x,o=i.y;this.constraints[t].axisA.set(n*a-r*o,r*a+n*o,0)},c.prototype.setMotorSpeed=function(e,t){var i=this.constraints[t];i.enableMotor(),i.motorTargetVelocity=e},c.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var u=new o;c.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},c.prototype.applyWheelForce=function(e,t){var i=this.wheelAxes[t],n=this.wheelBodies[t],r=n.torque;i.scale(e,u),n.vectorToWorldFrame(u,u),r.vadd(u,r)},c.prototype.addToWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.addBody(i[n]);for(n=0;n<t.length;n++)e.addConstraint(t[n]);e.addEventListener("preStep",this._update.bind(this))},c.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},c.prototype.removeFromWorld=function(e){for(var t=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)e.remove(i[n]);for(n=0;n<t.length;n++)e.removeConstraint(t[n])};var h=new o;c.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],i=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,h),i.dot(h)}},{"../constraints/HingeConstraint":16,"../math/CMath":27,"../math/Vec3":32,"../shapes/Box":39,"../shapes/Sphere":46,"./Body":33}],36:[function(e,t,i){t.exports=r,e("../shapes/Shape");var n=e("../math/Vec3");function r(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),r.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},r.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var a=new n;r.prototype.getNeighbors=function(e,t){for(var i=this.particles.length,n=e.id,r=this.smoothingRadius*this.smoothingRadius,o=a,s=0;s!==i;s++){var l=this.particles[s];l.position.vsub(e.position,o),n!==l.id&&o.norm2()<r&&t.push(l)}};var o=new n,s=new n,l=new n,c=new n,u=new n,h=new n;r.prototype.update=function(){for(var e=this.particles.length,t=o,i=this.speedOfSound,n=this.eps,r=0;r!==e;r++){var a=this.particles[r];(b=this.neighbors[r]).length=0,this.getNeighbors(a,b),b.push(this.particles[r]);for(var _=b.length,d=0,f=0;f!==_;f++){a.position.vsub(b[f].position,t);var p=t.norm(),m=this.w(p);d+=b[f].mass*m}this.densities[r]=d,this.pressures[r]=i*i*(this.densities[r]-this.density)}var v=s,g=l,y=c,x=u,S=h;for(r=0;r!==e;r++){var T,E,b,A=this.particles[r];for(v.set(0,0,0),g.set(0,0,0),_=(b=this.neighbors[r]).length,f=0;f!==_;f++){var C=b[f];A.position.vsub(C.position,x);var w=x.norm();T=-C.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+n)+this.pressures[f]/(this.densities[f]*this.densities[f]+n)),this.gradw(x,y),y.mult(T,y),v.vadd(y,v),C.velocity.vsub(A.velocity,S),S.mult(1/(1e-4+this.densities[r]*this.densities[f])*this.viscosity*C.mass,S),E=this.nablaw(w),S.mult(E,S),g.vadd(S,g)}g.mult(A.mass,g),v.mult(A.mass,v),A.force.vadd(g,A.force),A.force.vadd(v,A.force)}},r.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},r.prototype.gradw=function(e,t){var i=e.norm(),n=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),t)},r.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":30,"../math/Vec3":32,"../objects/Body":33,"../shapes/Particle":43,"../shapes/Shape":45}],37:[function(e,t,i){var n=e("../math/Vec3");function r(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}(t.exports=r).prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},r.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},r.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},r.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var a=new n,o=new n,s=new n,l=new n,c=new n,u=new n,h=new n,_=new n,d=new n,f=new n,p=new n;r.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,i=this.restLength,n=this.bodyA,r=this.bodyB,m=a,v=o,g=s,y=l,x=p,S=c,T=u,E=h,b=_,A=d,C=f;this.getWorldAnchorA(S),this.getWorldAnchorB(T),S.vsub(n.position,E),T.vsub(r.position,b),T.vsub(S,m);var w=m.norm();v.copy(m),v.normalize(),r.velocity.vsub(n.velocity,g),r.angularVelocity.cross(b,x),g.vadd(x,g),n.angularVelocity.cross(E,x),g.vsub(x,g),v.mult(-e*(w-i)-t*g.dot(v),y),n.force.vsub(y,n.force),r.force.vadd(y,r.force),E.cross(y,A),b.cross(y,C),n.torque.vsub(A,n.torque),r.torque.vadd(C,r.torque)}},{"../math/Vec3":32}],38:[function(e,t,i){var n=e("../math/Vec3"),r=e("../math/Transform"),a=e("../collision/RaycastResult"),o=e("../utils/Utils");function s(e){e=o.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new a,this.worldTransform=new r,this.isInContact=!1}t.exports=s;var l=new n,c=new n;l=new n,s.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var i=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,c),e.getVelocityAtWorldPoint(c,l);var n=t.hitNormalWorld.dot(l);if(-.1<=i)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/i;this.suspensionRelativeVelocity=n*r,this.clippedInvContactDotSuspension=r}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":31,"../math/Vec3":32,"../utils/Utils":55}],39:[function(e,t,i){t.exports=o;var n=e("./Shape"),r=e("../math/Vec3"),a=e("./ConvexPolyhedron");function o(e){n.call(this,{type:n.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}((o.prototype=new n).constructor=o).prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,i=this.halfExtents.z,n=r,o=[new n(-e,-t,-i),new n(e,-t,-i),new n(e,t,-i),new n(-e,t,-i),new n(-e,-t,i),new n(e,-t,i),new n(e,t,i),new n(-e,t,i)],s=(new n(0,0,1),new n(0,1,0),new n(1,0,0),new a(o,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));(this.convexPolyhedronRepresentation=s).material=this.material},o.prototype.calculateLocalInertia=function(e,t){return t=t||new r,o.calculateInertia(this.halfExtents,e,t),t},o.calculateInertia=function(e,t,i){var n=e;n.isZero()?(i.x=2/12*t,i.y=2/12*t,i.z=2/12*t):(i.x=1/12*t*(2*n.y*2*n.y+2*n.z*2*n.z),i.y=1/12*t*(2*n.x*2*n.x+2*n.z*2*n.z),i.z=1/12*t*(2*n.y*2*n.y+2*n.x*2*n.x))},o.prototype.getSideNormals=function(e,t){var i=e,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==t)for(var r=0;r!==i.length;r++)t.vmult(i[r],i[r]);return i},o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var s=new r;new r,o.prototype.forEachWorldCorner=function(e,t,i){for(var n=this.halfExtents,r=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],a=0;a<r.length;a++)s.set(r[a][0],r[a][1],r[a][2]),t.vmult(s,s),e.vadd(s,s),i(s.x,s.y,s.z)};var l=[new r,new r,new r,new r,new r,new r,new r,new r];o.prototype.calculateWorldAABB=function(e,t,i,n){var r=this.halfExtents;l[0].set(r.x,r.y,r.z),l[1].set(-r.x,r.y,r.z),l[2].set(-r.x,-r.y,r.z),l[3].set(-r.x,-r.y,-r.z),l[4].set(r.x,-r.y,-r.z),l[5].set(r.x,r.y,-r.z),l[6].set(-r.x,r.y,-r.z),l[7].set(r.x,-r.y,r.z);var a=l[0];t.vmult(a,a),e.vadd(a,a),n.copy(a),i.copy(a);for(var o=1;o<8;o++){a=l[o],t.vmult(a,a),e.vadd(a,a);var s=a.x,c=a.y,u=a.z;s>n.x&&(n.x=s),c>n.y&&(n.y=c),u>n.z&&(n.z=u),s<i.x&&(i.x=s),c<i.y&&(i.y=c),u<i.z&&(i.z=u)}}},{"../math/Vec3":32,"./ConvexPolyhedron":40,"./Shape":45}],40:[function(e,t,i){t.exports=o;var n=e("./Shape"),r=e("../math/Vec3"),a=(e("../math/Quaternion"),e("../math/Transform"));function o(e,t,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}(o.prototype=new n).constructor=o;var s=new r;o.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,i=(t.length,this.uniqueEdges);i.length=0;for(var n=s,r=0;r!==e.length;r++)for(var a=e[r],o=a.length,l=0;l!==o;l++){var c=(l+1)%o;t[a[l]].vsub(t[a[c]],n),n.normalize();for(var u=!1,h=0;h!==i.length;h++)if(i[h].almostEquals(n)||i[h].almostEquals(n)){u=!0;break}u||i.push(n.clone())}},o.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var i=this.faceNormals[e]||new r;this.getFaceNormal(e,i),i.negate(i),this.faceNormals[e]=i;var n=this.vertices[this.faces[e][0]];if(i.dot(n)<0)for(console.error(".faceNormals["+e+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),t=0;t<this.faces[e].length;t++)console.warn(".vertices["+this.faces[e][t]+"] = Vec3("+this.vertices[this.faces[e][t]].toString()+")")}};var l=new r,c=new r;o.computeNormal=function(e,t,i,n){t.vsub(e,c),i.vsub(t,l),l.cross(c,n),n.isZero()||n.normalize()},o.prototype.getFaceNormal=function(e,t){var i=this.faces[e],n=this.vertices[i[0]],r=this.vertices[i[1]],a=this.vertices[i[2]];return o.computeNormal(n,r,a,t)};var u=new r;o.prototype.clipAgainstHull=function(e,t,i,n,a,o,s,l,c){for(var h=u,_=-1,d=-Number.MAX_VALUE,f=0;f<i.faces.length;f++){h.copy(i.faceNormals[f]),a.vmult(h,h);var p=h.dot(o);d<p&&(d=p,_=f)}for(var m=[],v=i.faces[_],g=v.length,y=0;y<g;y++){var x=i.vertices[v[y]],S=new r;S.copy(x),a.vmult(S,S),n.vadd(S,S),m.push(S)}0<=_&&this.clipFaceAgainstHull(o,e,t,m,s,l,c)};var h=new r,_=new r,d=new r,f=new r,p=new r,m=new r;o.prototype.findSeparatingAxis=function(e,t,i,n,r,a,o,s){var l=h,c=_,u=d,v=f,g=p,y=m,x=Number.MAX_VALUE,S=this;if(S.uniqueAxes)for(E=0;E!==S.uniqueAxes.length;E++){if(i.vmult(S.uniqueAxes[E],l),!1===(C=S.testSepAxis(l,e,t,i,n,r)))return!1;C<x&&(x=C,a.copy(l))}else for(var T=o?o.length:S.faces.length,E=0;E<T;E++){var b=o?o[E]:E;if(l.copy(S.faceNormals[b]),i.vmult(l,l),!1===(C=S.testSepAxis(l,e,t,i,n,r)))return!1;C<x&&(x=C,a.copy(l))}if(e.uniqueAxes)for(E=0;E!==e.uniqueAxes.length;E++){if(r.vmult(e.uniqueAxes[E],c),!1===(C=S.testSepAxis(c,e,t,i,n,r)))return!1;C<x&&(x=C,a.copy(c))}else{var A=s?s.length:e.faces.length;for(E=0;E<A;E++){var C;if(b=s?s[E]:E,c.copy(e.faceNormals[b]),r.vmult(c,c),!1===(C=S.testSepAxis(c,e,t,i,n,r)))return!1;C<x&&(x=C,a.copy(c))}}for(var w=0;w!==S.uniqueEdges.length;w++){i.vmult(S.uniqueEdges[w],v);for(var R=0;R!==e.uniqueEdges.length;R++)if(r.vmult(e.uniqueEdges[R],g),v.cross(g,y),!y.almostZero()){y.normalize();var I=S.testSepAxis(y,e,t,i,n,r);if(!1===I)return!1;I<x&&(x=I,a.copy(y))}}return n.vsub(t,u),0<u.dot(a)&&a.negate(a),!0};var v=[],g=[];o.prototype.testSepAxis=function(e,t,i,n,r,a){o.project(this,e,i,n,v),o.project(t,e,r,a,g);var s=v[0],l=v[1],c=g[0],u=g[1];if(s<u||c<l)return!1;var h=s-u,_=c-l;return h<_?h:_};var y=new r,x=new r;o.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(y,x);var i=x.x-y.x,n=x.y-y.y,r=x.z-y.z;t.x=1/12*e*(2*n*2*n+2*r*2*r),t.y=1/12*e*(2*i*2*i+2*r*2*r),t.z=1/12*e*(2*n*2*n+2*i*2*i)},o.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],i=this.faceNormals[e],n=this.vertices[t[0]];return-i.dot(n)};var S=new r,T=new r,E=new r,b=new r,A=new r,C=new r,w=new r,R=new r;o.prototype.clipFaceAgainstHull=function(e,t,i,n,r,a,o){for(var s=S,l=T,c=E,u=b,h=A,_=C,d=w,f=R,p=this,m=n,v=[],g=-1,y=Number.MAX_VALUE,x=0;x<p.faces.length;x++){s.copy(p.faceNormals[x]),i.vmult(s,s);var I=s.dot(e);I<y&&(y=I,g=x)}if(!(g<0)){var O=p.faces[g];O.connectedFaces=[];for(var M=0;M<p.faces.length;M++)for(var P=0;P<p.faces[M].length;P++)-1!==O.indexOf(p.faces[M][P])&&M!==g&&-1===O.connectedFaces.indexOf(M)&&O.connectedFaces.push(M);m.length;for(var k=O.length,D=0;D<k;D++){var B=p.vertices[O[D]],L=p.vertices[O[(D+1)%k]];B.vsub(L,l),c.copy(l),i.vmult(c,c),t.vadd(c,c),u.copy(this.faceNormals[g]),i.vmult(u,u),t.vadd(u,u),c.cross(u,h),h.negate(h),_.copy(B),i.vmult(_,_),t.vadd(_,_),_.dot(h);var N=O.connectedFaces[D];d.copy(this.faceNormals[N]);var F=this.getPlaneConstantOfFace(N);f.copy(d),i.vmult(f,f);var z=F-f.dot(t);for(this.clipFaceAgainstPlane(m,v,f,z);m.length;)m.shift();for(;v.length;)m.push(v.shift())}for(d.copy(this.faceNormals[g]),F=this.getPlaneConstantOfFace(g),f.copy(d),i.vmult(f,f),z=F-f.dot(t),M=0;M<m.length;M++){var U=f.dot(m[M])+z;if(U<=r&&(U=r),U<=a){var G=m[M];if(U<=0){var H={point:G,normal:f,depth:U};o.push(H)}}}}},o.prototype.clipFaceAgainstPlane=function(e,t,i,n){var a,o,s=e.length;if(s<2)return t;var l=e[e.length-1],c=e[0];a=i.dot(l)+n;for(var u=0;u<s;u++){if(c=e[u],o=i.dot(c)+n,a<0)if(o<0)(h=new r).copy(c),t.push(h);else{var h=new r;l.lerp(c,a/(a-o),h),t.push(h)}else o<0&&(h=new r,l.lerp(c,a/(a-o),h),t.push(h),t.push(c));l=c,a=o}return t},o.prototype.computeWorldVertices=function(e,t){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new r);for(var n=this.vertices,a=this.worldVertices,o=0;o!==i;o++)t.vmult(n[o],a[o]),e.vadd(a[o],a[o]);this.worldVerticesNeedsUpdate=!1},new r,o.prototype.computeLocalAABB=function(e,t){var i=this.vertices.length,n=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<i;r++){var a=n[r];a.x<e.x?e.x=a.x:a.x>t.x&&(t.x=a.x),a.y<e.y?e.y=a.y:a.y>t.y&&(t.y=a.y),a.z<e.z?e.z=a.z:a.z>t.z&&(t.z=a.z)}},o.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new r);for(var i=this.faceNormals,n=this.worldFaceNormals,a=0;a!==t;a++)e.vmult(i[a],n[a]);this.worldFaceNormalsNeedsUpdate=!1},o.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=0,n=t.length;i!==n;i++){var r=t[i].norm2();e<r&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)};var I=new r;o.prototype.calculateWorldAABB=function(e,t,i,n){for(var r,a,o,s,l,c,u=this.vertices.length,h=this.vertices,_=0;_<u;_++)I.copy(h[_]),t.vmult(I,I),e.vadd(I,I),(I.x<r||void 0===r)&&(r=I.x),(I.x>s||void 0===s)&&(s=I.x),(I.y<a||void 0===a)&&(a=I.y),(I.y>l||void 0===l)&&(l=I.y),(I.z<o||void 0===o)&&(o=I.z),(I.z>c||void 0===c)&&(c=I.z);i.set(r,a,o),n.set(s,l,c)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.prototype.getAveragePointLocal=function(e){e=e||new r;for(var t=this.vertices.length,i=this.vertices,n=0;n<t;n++)e.vadd(i[n],e);return e.mult(1/t,e),e},o.prototype.transformAllPoints=function(e,t){var i=this.vertices.length,n=this.vertices;if(t){for(var r=0;r<i;r++){var a=n[r];t.vmult(a,a)}for(r=0;r<this.faceNormals.length;r++)a=this.faceNormals[r],t.vmult(a,a)}if(e)for(r=0;r<i;r++)(a=n[r]).vadd(e,a)};var O=new r,M=new r,P=new r;o.prototype.pointIsInside=function(e){var t=this.vertices.length,i=this.vertices,n=this.faces,r=this.faceNormals,a=this.faces.length,o=O;this.getAveragePointLocal(o);for(var s=0;s<a;s++){this.faces[s].length,t=r[s];var l=i[n[s][0]],c=M;e.vsub(l,c);var u=t.dot(c),h=P;o.vsub(l,h);var _=t.dot(h);if(u<0&&0<_||0<u&&_<0)return!1}return-1},new r;var k=new r,D=new r;o.project=function(e,t,i,n,r){var o=e.vertices.length,s=k,l=0,c=0,u=D,h=e.vertices;u.setZero(),a.vectorToLocalFrame(i,n,t,s),a.pointToLocalFrame(i,n,u,u);var _=u.dot(s);c=l=h[0].dot(s);for(var d=1;d<o;d++){var f=h[d].dot(s);l<f&&(l=f),f<c&&(c=f)}if((l-=_)<(c-=_)){var p=c;c=l,l=p}r[0]=l,r[1]=c}},{"../math/Quaternion":30,"../math/Transform":31,"../math/Vec3":32,"./Shape":45}],41:[function(e,t,i){t.exports=o,e("./Shape");var n=e("../math/Vec3"),r=(e("../math/Quaternion"),e("./ConvexPolyhedron")),a=e("../math/CMath");function o(e,t,i,o,s){if(s){for(var l=o,c=a.cos,u=a.sin,h=i/2,_=[],d=[],f=[0],p=[1],m=[],v=2*Math.PI/l,g=0;g<l;g++)_.push(new n(e*c(v*g),h,e*u(v*g))),_.push(new n(e*c(v*g),-h,e*u(v*g))),g<l-1?(d.push([2*g+2,2*g+3,2*g+1,2*g]),f.push(2*g+2),p.push(2*g+3)):d.push([0,1,2*g+1,2*g]),(l%2==1||g<l/2)&&m.push(new n(c(v*(g+.5)),0,u(v*(g+.5))));d.push(p);var y=[];for(g=0;g<f.length;g++)y.push(f[f.length-g-1]);return d.push(y),m.push(new n(0,1,0)),void r.call(this,_,d,m)}l=o;var x=[],S=(m=[],[]),T=[],E=[];for(c=a.cos,u=a.sin,x.push(new n(t*c(0),t*u(0),.5*-i)),T.push(0),x.push(new n(e*c(0),e*u(0),.5*i)),E.push(1),g=0;g<l;g++){v=2*Math.PI/l*(g+1);var b=2*Math.PI/l*(g+.5);g<l-1?(x.push(new n(t*c(v),t*u(v),.5*-i)),T.push(2*g+2),x.push(new n(e*c(v),e*u(v),.5*i)),E.push(2*g+3),S.push([2*g+2,2*g+3,2*g+1,2*g])):S.push([0,1,2*g+1,2*g]),(l%2==1||g<l/2)&&m.push(new n(c(b),u(b),0))}for(S.push(E),m.push(new n(0,0,1)),y=[],g=0;g<T.length;g++)y.push(T[T.length-g-1]);S.push(y),r.call(this,x,S,m)}o.prototype=new r},{"../math/CMath":27,"../math/Quaternion":30,"../math/Vec3":32,"./ConvexPolyhedron":40,"./Shape":45}],42:[function(e,t,i){var n=e("./Shape"),r=e("./ConvexPolyhedron"),a=e("../math/Vec3"),o=e("../utils/Utils");function s(e,t){t=o.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this,{type:n.types.HEIGHTFIELD}),this.pillarConvex=new r,this.pillarOffset=new a,this.updateBoundingSphereRadius(),this._cachedPillars={}}((t.exports=s).prototype=new n).update=function(){this._cachedPillars={}},s.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];r<t&&(t=r)}this.minValue=t},s.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],i=0;i!==e.length;i++)for(var n=0;n!==e[i].length;n++){var r=e[i][n];t<r&&(t=r)}this.maxValue=t},s.prototype.setHeightValueAtIndex=function(e,t,i){this.data[e][t]=i,this.clearCachedConvexTrianglePillar(e,t,!1),0<e&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),0<t&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),0<t&&0<e&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},s.prototype.getRectMinMax=function(e,t,i,n,r){r=r||[];for(var a=this.data,o=this.minValue,s=e;s<=i;s++)for(var l=t;l<=n;l++){var c=a[s][l];o<c&&(o=c)}r[0]=this.minValue,r[1]=o},s.prototype.getIndexOfPosition=function(e,t,i,n){var r=this.elementSize,a=this.data,o=Math.floor(e/r),s=Math.floor(t/r);return i[0]=o,i[1]=s,n&&(o<0&&(o=0),s<0&&(s=0),o>=a.length-1&&(o=a.length-1),s>=a[0].length-1&&(s=a[0].length-1)),!(o<0||s<0||o>=a.length-1||s>=a[0].length-1)};var l=[],c=new a,u=new a,h=new a,_=new a;s.prototype.getTriangleAt=function(e,t,i,n,r,a){var o=l;this.getIndexOfPosition(e,t,o,i);var s=o[0],c=o[1],u=this.data;i&&(s=Math.min(u.length-2,Math.max(0,s)),c=Math.min(u[0].length-2,Math.max(0,c)));var h=this.elementSize,_=Math.pow(e/h-s,2)+Math.pow(t/h-c,2),d=Math.pow(e/h-(s+1),2)+Math.pow(t/h-(c+1),2)<_;return this.getTriangle(s,c,d,n,r,a),d};var d=new a,f=new a,p=new a,m=new a,v=new a;s.prototype.getNormalAt=function(e,t,i,n){var r=d,a=f,o=p,s=m,l=v;this.getTriangleAt(e,t,i,r,a,o),a.vsub(r,s),o.vsub(r,l),s.cross(l,n),n.normalize()},s.prototype.getAabbAtIndex=function(e,t,i){var n=this.data,r=this.elementSize;i.lowerBound.set(e*r,t*r,n[e][t]),i.upperBound.set((e+1)*r,(t+1)*r,n[e+1][t+1])},s.prototype.getHeightAt=function(e,t,i){var n=this.data,r=u,a=h,o=_,s=l;this.getIndexOfPosition(e,t,s,i);var d=s[0],f=s[1];i&&(d=Math.min(n.length-2,Math.max(0,d)),f=Math.min(n[0].length-2,Math.max(0,f)));var p,m,v,g,y,x,S,T,E,b=this.getTriangleAt(e,t,i,r,a,o);return p=e,m=t,v=r.x,g=r.y,y=a.x,x=a.y,S=o.x,T=o.y,(E=c).x=((x-T)*(p-S)+(S-y)*(m-T))/((x-T)*(v-S)+(S-y)*(g-T)),E.y=((T-g)*(p-S)+(v-S)*(m-T))/((x-T)*(v-S)+(S-y)*(g-T)),E.z=1-E.x-E.y,b?n[d+1][f+1]*c.x+n[d][f+1]*c.y+n[d+1][f]*c.z:n[d][f]*c.x+n[d+1][f]*c.y+n[d][f+1]*c.z},s.prototype.getCacheConvexTrianglePillarKey=function(e,t,i){return e+"_"+t+"_"+(i?1:0)},s.prototype.getCachedConvexTrianglePillar=function(e,t,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},s.prototype.setCachedConvexTrianglePillar=function(e,t,i,n,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]={convex:n,offset:r}},s.prototype.clearCachedConvexTrianglePillar=function(e,t,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,i)]},s.prototype.getTriangle=function(e,t,i,n,r,a){var o=this.data,s=this.elementSize;i?(n.set((e+1)*s,(t+1)*s,o[e+1][t+1]),r.set(e*s,(t+1)*s,o[e][t+1]),a.set((e+1)*s,t*s,o[e+1][t])):(n.set(e*s,t*s,o[e][t]),r.set((e+1)*s,t*s,o[e+1][t]),a.set(e*s,(t+1)*s,o[e][t+1]))},s.prototype.getConvexTrianglePillar=function(e,t,i){var n=this.pillarConvex,o=this.pillarOffset;if(this.cacheEnabled){if(s=this.getCachedConvexTrianglePillar(e,t,i))return this.pillarConvex=s.convex,void(this.pillarOffset=s.offset);n=new r,o=new a,this.pillarConvex=n,this.pillarOffset=o}var s=this.data,l=this.elementSize,c=n.faces;n.vertices.length=6;for(var u=0;u<6;u++)n.vertices[u]||(n.vertices[u]=new a);for(c.length=5,u=0;u<5;u++)c[u]||(c[u]=[]);var h=n.vertices,_=(Math.min(s[e][t],s[e+1][t],s[e][t+1],s[e+1][t+1])-this.minValue)/2+this.minValue;i?(o.set((e+.75)*l,(t+.75)*l,_),h[0].set(.25*l,.25*l,s[e+1][t+1]-_),h[1].set(-.75*l,.25*l,s[e][t+1]-_),h[2].set(.25*l,-.75*l,s[e+1][t]-_),h[3].set(.25*l,.25*l,-_-1),h[4].set(-.75*l,.25*l,-_-1),h[5].set(.25*l,-.75*l,-_-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=2,c[2][1]=5,c[2][2]=3,c[2][3]=0,c[3][0]=3,c[3][1]=4,c[3][2]=1,c[3][3]=0,c[4][0]=1,c[4][1]=4,c[4][2]=5,c[4][3]=2):(o.set((e+.25)*l,(t+.25)*l,_),h[0].set(-.25*l,-.25*l,s[e][t]-_),h[1].set(.75*l,-.25*l,s[e+1][t]-_),h[2].set(-.25*l,.75*l,s[e][t+1]-_),h[3].set(-.25*l,-.25*l,-_-1),h[4].set(.75*l,-.25*l,-_-1),h[5].set(-.25*l,.75*l,-_-1),c[0][0]=0,c[0][1]=1,c[0][2]=2,c[1][0]=5,c[1][1]=4,c[1][2]=3,c[2][0]=0,c[2][1]=2,c[2][2]=5,c[2][3]=3,c[3][0]=1,c[3][1]=0,c[3][2]=3,c[3][3]=4,c[4][0]=4,c[4][1]=5,c[4][2]=2,c[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,i,n,o)},s.prototype.calculateLocalInertia=function(e,t){return(t=t||new a).set(0,0,0),t},s.prototype.volume=function(){return Number.MAX_VALUE},s.prototype.calculateWorldAABB=function(e,t,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},s.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new a(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},s.prototype.setHeightsFromImage=function(e,t){var i=document.createElement("canvas");i.width=e.width,i.height=e.height;var n=i.getContext("2d");n.drawImage(e,0,0);var r=n.getImageData(0,0,e.width,e.height),a=this.data;a.length=0,this.elementSize=Math.abs(t.x)/r.width;for(var o=0;o<r.height;o++){for(var s=[],l=0;l<r.width;l++){var c=(r.data[4*(o*r.height+l)]+r.data[4*(o*r.height+l)+1]+r.data[4*(o*r.height+l)+2])/4/255*t.z;t.x<0?s.push(c):s.unshift(c)}t.y<0?a.unshift(s):a.push(s)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":32,"../utils/Utils":55,"./ConvexPolyhedron":40,"./Shape":45}],43:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PARTICLE})}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){return(t=t||new r).set(0,0,0),t},a.prototype.volume=function(){return 0},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},a.prototype.calculateWorldAABB=function(e,t,i,n){i.copy(e),n.copy(e)}},{"../math/Vec3":32,"./Shape":45}],44:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(){n.call(this,{type:n.types.PLANE}),this.worldNormal=new r,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}((a.prototype=new n).constructor=a).prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},a.prototype.calculateLocalInertia=function(e,t){return t||new r},a.prototype.volume=function(){return Number.MAX_VALUE};var o=new r;a.prototype.calculateWorldAABB=function(e,t,i,n){o.set(0,0,1),t.vmult(o,o);var r=Number.MAX_VALUE;i.set(-r,-r,-r),n.set(r,r,r),1===o.x&&(n.x=e.x),1===o.y&&(n.y=e.y),1===o.z&&(n.z=e.z),-1===o.x&&(i.x=e.x),-1===o.y&&(i.y=e.y),-1===o.z&&(i.z=e.z)},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":32,"./Shape":45}],45:[function(e,t,i){t.exports=r;var n=e("../utils/EventTarget"),r=e("./Shape");function r(e){e=e||{},n.apply(this),this.id=r.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),r.prototype=new n,(r.prototype.constructor=r).prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},r.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},r.prototype.calculateLocalInertia=function(e,t){throw"calculateLocalInertia() not implemented for shape type "+this.type},r.idCounter=0,r.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":30,"../math/Vec3":32,"../utils/EventTarget":51,"./Shape":45}],46:[function(e,t,i){t.exports=a;var n=e("./Shape"),r=e("../math/Vec3");function a(e){if(n.call(this,{type:n.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}((a.prototype=new n).constructor=a).prototype.calculateLocalInertia=function(e,t){t=t||new r;var i=2*e*this.radius*this.radius/5;return t.x=i,t.y=i,t.z=i,t},a.prototype.volume=function(){return 4*Math.PI*this.radius/3},a.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},a.prototype.calculateWorldAABB=function(e,t,i,n){for(var r=this.radius,a=["x","y","z"],o=0;o<a.length;o++){var s=a[o];i[s]=e[s]-r,n[s]=e[s]+r}}},{"../math/Vec3":32,"./Shape":45}],47:[function(e,t,i){t.exports=c;var n=e("./Shape"),r=e("../math/Vec3"),a=(e("../math/Quaternion"),e("../math/Transform")),o=e("../collision/AABB"),s=e("../utils/Octree"),l=e("../math/CMath");function c(e,t){n.call(this,{type:n.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new o,this.edges=null,this.scale=new r(1,1,1),this.tree=new s,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}(c.prototype=new n).constructor=c;var u=new r;c.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var i=new o,n=new r,a=new r,s=new r,l=[n,a,s],c=0;c<this.indices.length/3;c++){var u=3*c;this._getUnscaledVertex(this.indices[u],n),this._getUnscaledVertex(this.indices[1+u],a),this._getUnscaledVertex(this.indices[2+u],s),i.setFromPoints(l),e.insert(i,c)}e.removeEmptyNodes()};var h=new o;c.prototype.getTrianglesInAABB=function(e,t){h.copy(e);var i=this.scale,n=i.x,r=i.y,a=i.z,o=h.lowerBound,s=h.upperBound;return o.x/=n,o.y/=r,o.z/=a,s.x/=n,s.y/=r,s.z/=a,this.tree.aabbQuery(h,t)},c.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,i=e.x===e.y===e.z;t&&i||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},c.prototype.updateNormals=function(){for(var e=u,t=this.normals,i=0;i<this.indices.length/3;i++){var n=3*i,r=this.indices[n],a=this.indices[1+n],o=this.indices[2+n];this.getVertex(r,m),this.getVertex(a,v),this.getVertex(o,g),c.computeNormal(v,m,g,e),t[n]=e.x,t[1+n]=e.y,t[2+n]=e.z}},c.prototype.updateEdges=function(){function e(e,i){t[r<a?r+"_"+a:a+"_"+r]=!0}for(var t={},i=0;i<this.indices.length/3;i++){var n=3*i,r=this.indices[n],a=this.indices[1+n];this.indices[2+n],e(),e(),e()}var o=Object.keys(t);for(this.edges=new Int16Array(2*o.length),i=0;i<o.length;i++){var s=o[i].split("_");this.edges[2*i]=parseInt(s[0],10),this.edges[2*i+1]=parseInt(s[1],10)}},c.prototype.getEdgeVertex=function(e,t,i){var n=this.edges[2*e+(t?1:0)];this.getVertex(n,i)};var _=new r,d=new r;c.prototype.getEdgeVector=function(e,t){var i=_,n=d;this.getEdgeVertex(e,0,i),this.getEdgeVertex(e,1,n),n.vsub(i,t)};var f=new r,p=new r;c.computeNormal=function(e,t,i,n){t.vsub(e,p),i.vsub(t,f),f.cross(p,n),n.isZero()||n.normalize()};var m=new r,v=new r,g=new r;c.prototype.getVertex=function(e,t){var i=this.scale;return this._getUnscaledVertex(e,t),t.x*=i.x,t.y*=i.y,t.z*=i.z,t},c.prototype._getUnscaledVertex=function(e,t){var i=3*e,n=this.vertices;return t.set(n[i],n[1+i],n[2+i])},c.prototype.getWorldVertex=function(e,t,i,n){return this.getVertex(e,n),a.pointToWorldFrame(t,i,n,n),n},c.prototype.getTriangleVertices=function(e,t,i,n){var r=3*e;this.getVertex(this.indices[r],t),this.getVertex(this.indices[1+r],i),this.getVertex(this.indices[2+r],n)},c.prototype.getNormal=function(e,t){var i=3*e;return t.set(this.normals[i],this.normals[1+i],this.normals[2+i])};var y=new o;c.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(y);var i=y.upperBound.x-y.lowerBound.x,n=y.upperBound.y-y.lowerBound.y,r=y.upperBound.z-y.lowerBound.z;return t.set(1/12*e*(2*n*2*n+2*r*2*r),1/12*e*(2*i*2*i+2*r*2*r),1/12*e*(2*n*2*n+2*i*2*i))};var x=new r;c.prototype.computeLocalAABB=function(e){var t=e.lowerBound,i=e.upperBound,n=this.vertices.length,r=(this.vertices,x);this.getVertex(0,r),t.copy(r),i.copy(r);for(var a=0;a!==n;a++)this.getVertex(a,r),r.x<t.x?t.x=r.x:r.x>i.x&&(i.x=r.x),r.y<t.y?t.y=r.y:r.y>i.y&&(i.y=r.y),r.z<t.z?t.z=r.z:r.z>i.z&&(i.z=r.z)},c.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},c.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,i=new r,n=0,a=t.length/3;n!==a;n++){this.getVertex(n,i);var o=i.norm2();e<o&&(e=o)}this.boundingSphereRadius=Math.sqrt(e)},new r;var S=new a,T=new o;c.prototype.calculateWorldAABB=function(e,t,i,n){var r=S,a=T;r.position=e,r.quaternion=t,this.aabb.toWorldFrame(r,a),i.copy(a.lowerBound),n.copy(a.upperBound)},c.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},c.createTorus=function(e,t,i,n,r){e=e||1,t=t||.5,i=i||8,n=n||6,r=r||2*Math.PI;for(var a=[],o=[],s=0;s<=i;s++)for(var u=0;u<=n;u++){var h=u/n*r,_=s/i*Math.PI*2,d=(e+t*l.cos(_))*l.cos(h),f=(e+t*l.cos(_))*l.sin(h),p=t*l.sin(_);a.push(d,f,p)}for(s=1;s<=i;s++)for(u=1;u<=n;u++){var m=(n+1)*s+u-1,v=(n+1)*(s-1)+u-1,g=(n+1)*(s-1)+u,y=(n+1)*s+u;o.push(m,v,y),o.push(v,g,y)}return new c(a,o)}},{"../collision/AABB":3,"../math/CMath":27,"../math/Quaternion":30,"../math/Transform":31,"../math/Vec3":32,"../utils/Octree":52,"./Shape":45}],48:[function(e,t,i){t.exports=r,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver");function r(){n.call(this),this.iterations=10,this.tolerance=1e-7}r.prototype=new n;var a=[],o=[],s=[];r.prototype.solve=function(e,t){var i,n,r,l,c,u=0,h=this.iterations,_=this.tolerance*this.tolerance,d=this.equations,f=d.length,p=t.bodies,m=p.length,v=e;if(0!==f)for(var g=0;g!==m;g++)p[g].updateSolveMassProperties();var y=o,x=s,S=a;for(y.length=f,x.length=f,S.length=f,g=0;g!==f;g++){var T=d[g];S[g]=0,x[g]=T.computeB(v),y[g]=1/T.computeC()}if(0!==f){for(g=0;g!==m;g++){var E=(C=p[g]).vlambda,b=C.wlambda;E.set(0,0,0),b.set(0,0,0)}for(u=0;u!==h;u++){for(var A=l=0;A!==f;A++)T=d[A],i=x[A],n=y[A],(c=S[A])+(r=n*(i-T.computeGWlambda()-T.eps*c))<T.minForce?r=T.minForce-c:c+r>T.maxForce&&(r=T.maxForce-c),S[A]+=r,l+=0<r?r:-r,T.addToWlambda(r);if(l*l<_)break}for(g=0;g!==m;g++){var C,w=(C=p[g]).velocity,R=C.angularVelocity;C.vlambda.vmul(C.linearFactor,C.vlambda),w.vadd(C.vlambda,w),C.wlambda.vmul(C.angularFactor,C.wlambda),R.vadd(C.wlambda,R)}for(var I=d.length,O=1/v;I--;)d[I].multiplier=S[I]*O}return u}},{"../math/Quaternion":30,"../math/Vec3":32,"./Solver":49}],49:[function(e,t,i){function n(){this.equations=[]}(t.exports=n).prototype.solve=function(e,t){return 0},n.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},n.prototype.removeEquation=function(e){var t=this.equations,i=t.indexOf(e);-1!==i&&t.splice(i,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],50:[function(e,t,i){t.exports=a,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver"),r=e("../objects/Body");function a(e){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}a.prototype=new n;var o=[],s=[],l={bodies:[]},c=r.STATIC;function u(e){for(var t=e.length,i=0;i!==t;i++){var n=e[i];if(!(n.visited||n.body.type&c))return n}return!1}var h=[];function _(e,t,i,n){for(h.push(e),e.visited=!0,t(e,i,n);h.length;)for(var r,a=h.pop();r=u(a.children);)r.visited=!0,t(r,i,n),h.push(r)}function d(e,t,i){t.push(e.body);for(var n=e.eqs.length,r=0;r!==n;r++){var a=e.eqs[r];-1===i.indexOf(a)&&i.push(a)}}function f(e,t){return t.id-e.id}a.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},a.prototype.solve=function(e,t){for(var i=o,n=this.nodePool,r=t.bodies,a=this.equations,c=a.length,h=r.length,p=this.subsolver;n.length<h;)n.push(this.createNode());i.length=h;for(var m=0;m<h;m++)i[m]=n[m];for(m=0;m!==h;m++){var v=i[m];v.body=r[m],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var g=0;g!==c;g++){var y=a[g],x=(m=r.indexOf(y.bi),r.indexOf(y.bj)),S=i[m],T=i[x];S.children.push(T),S.eqs.push(y),T.children.push(S),T.eqs.push(y)}var E,b=0,A=s;p.tolerance=this.tolerance,p.iterations=this.iterations;for(var C=l;E=u(i);){A.length=0,C.bodies.length=0,_(E,d,C.bodies,A);var w=A.length;for(A=A.sort(f),m=0;m!==w;m++)p.addEquation(A[m]);p.solve(e,C),p.removeAllEquations(),b++}return b}},{"../math/Quaternion":30,"../math/Vec3":32,"../objects/Body":33,"./Solver":49}],51:[function(e,t,i){function n(){}(t.exports=n).prototype={constructor:n,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[e])return this;var n=i[e].indexOf(t);return-1!==n&&i[e].splice(n,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var i=0,n=t.length;i<n;i++)t[i].call(this,e)}return this}}},{}],52:[function(e,t,i){var n=e("../collision/AABB"),r=e("../math/Vec3");function a(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new n,this.data=[],this.children=[]}(t.exports=function(e,t){(t=t||{}).root=null,t.aabb=e,a.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}).prototype=new a,a.prototype.reset=function(e,t){this.children.length=this.data.length=0},a.prototype.insert=function(e,t,i){var n=this.data;if(i=i||0,!this.aabb.contains(e))return!1;var r=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var a=!1;r.length||(this.subdivide(),a=!0);for(var o=0;8!==o;o++)if(r[o].insert(e,t,i+1))return!0;a&&(r.length=0)}return n.push(t),!0};var o=new r;a.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,i=e.upperBound,s=this.children;s.push(new a({aabb:new n({lowerBound:new r(0,0,0)})}),new a({aabb:new n({lowerBound:new r(1,0,0)})}),new a({aabb:new n({lowerBound:new r(1,1,0)})}),new a({aabb:new n({lowerBound:new r(1,1,1)})}),new a({aabb:new n({lowerBound:new r(0,1,1)})}),new a({aabb:new n({lowerBound:new r(0,0,1)})}),new a({aabb:new n({lowerBound:new r(1,0,1)})}),new a({aabb:new n({lowerBound:new r(0,1,0)})})),i.vsub(t,o),o.scale(.5,o);for(var l=this.root||this,c=0;8!==c;c++){var u=s[c];u.root=l;var h=u.aabb.lowerBound;h.x*=o.x,h.y*=o.y,h.z*=o.z,h.vadd(t,h),h.vadd(o,u.aabb.upperBound)}},a.prototype.aabbQuery=function(e,t){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(e)&&Array.prototype.push.apply(t,n.data),Array.prototype.push.apply(i,n.children)}return t};var s=new n;a.prototype.rayQuery=function(e,t,i){return e.getAABB(s),s.toLocalFrame(t,s),this.aabbQuery(s,i),i},a.prototype.removeEmptyNodes=function(){for(var e=this.children.length-1;0<=e;e--)this.children[e].removeEmptyNodes(),this.children[e].children.length||this.children[e].data.length||this.children.splice(e,1)}},{"../collision/AABB":3,"../math/Vec3":32}],53:[function(e,t,i){function n(){this.objects=[],this.type=Object}(t.exports=n).prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},n.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],54:[function(e,t,i){function n(){this.data={keys:[]}}(t.exports=n).prototype.get=function(e,t){if(t<e){var i=t;t=e,e=i}return this.data[e+"-"+t]},n.prototype.set=function(e,t,i){if(t<e){var n=t;t=e,e=n}var r=e+"-"+t;return this.get(e,t)||this.data.keys.push(r),this.data[r]=i,this.data[r]},n.prototype.del=function(e,t){if(t<e){var i=t;t=e,e=i}var n=e+"-"+t,r=this.data.keys.indexOf(n);return 0<=r&&(this.data.keys.splice(r,1),delete this.data[n],!0)},n.prototype.reset=function(){this.data={keys:[]}},n.prototype.getLength=function(){return this.data.keys.length},n.prototype.getKeyByIndex=function(e){return this.data.keys[e]},n.prototype.getDataByKey=function(e){return this.data[e]}},{}],55:[function(e,t,i){(t.exports=function(){}).defaults=function(e,t){for(var i in e=e||{},t)i in e||(e[i]=t[i]);return e}},{}],56:[function(e,t,i){t.exports=a;var n=e("../math/Vec3"),r=e("./Pool");function a(){r.call(this),this.type=n}(a.prototype=new r).constructObject=function(){return new n}},{"../math/Vec3":32,"./Pool":53}],57:[function(e,t,i){t.exports=d;var n=e("../collision/AABB"),r=e("../objects/Body"),a=e("../shapes/Shape"),o=e("../collision/Ray"),s=e("../math/Vec3"),l=e("../math/Transform"),c=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),u=(e("../solver/Solver"),e("../utils/Vec3Pool")),h=e("../equations/ContactEquation"),_=e("../equations/FrictionEquation");function d(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new u,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}d.prototype.createContactEquation=function(e,t,i,n,r,a){var o;this.contactPointPool.length?((o=this.contactPointPool.pop()).bi=e,o.bj=t):o=new h(e,t),o.enabled=e.collisionResponse&&t.collisionResponse&&i.collisionResponse&&n.collisionResponse;var s=this.currentContactMaterial;o.restitution=s.restitution,o.setSpookParams(s.contactEquationStiffness,s.contactEquationRelaxation,this.world.dt);var l=i.material||e.material,c=n.material||t.material;return l&&c&&0<=l.restitution&&0<=c.restitution&&(o.restitution=l.restitution*c.restitution),o.si=r||i,o.sj=a||n,o},d.prototype.createFrictionEquationsFromContact=function(e,t){var i=e.bi,n=e.bj,r=e.si,a=e.sj,o=this.world,s=this.currentContactMaterial,l=s.friction,c=r.material||i.material,u=a.material||n.material;if(c&&u&&0<=c.friction&&0<=u.friction&&(l=c.friction*u.friction),0<l){var h=l*o.gravity.length(),d=i.invMass+n.invMass;0<d&&(d=1/d);var f=this.frictionEquationPool,p=f.length?f.pop():new _(i,n,h*d),m=f.length?f.pop():new _(i,n,h*d);return p.bi=m.bi=i,p.bj=m.bj=n,p.minForce=m.minForce=-h*d,p.maxForce=m.maxForce=h*d,p.ri.copy(e.ri),p.rj.copy(e.rj),m.ri.copy(e.ri),m.rj.copy(e.rj),e.ni.tangents(p.t,m.t),p.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,o.dt),m.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,o.dt),p.enabled=m.enabled=e.enabled,t.push(p,m),!0}return!1};var f=new s,p=new s,m=new s;d.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];f.setZero(),p.setZero(),m.setZero();for(var r=t.bi,a=(t.bj,0);a!==e;a++)(t=this.result[this.result.length-1-a]).bodyA!==r?(f.vadd(t.ni,f),p.vadd(t.ri,p),m.vadd(t.rj,m)):(f.vsub(t.ni,f),p.vadd(t.rj,p),m.vadd(t.ri,m));var o=1/e;p.scale(o,i.ri),m.scale(o,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),f.normalize(),f.tangents(i.t,n.t)}};var v=new s,g=new s,y=new c,x=new c;d.prototype.getContacts=function(e,t,i,n,a,o,s){this.contactPointPool=a,this.frictionEquationPool=s,this.result=n,this.frictionResult=o;for(var l=y,c=x,u=v,h=g,_=0,d=e.length;_!==d;_++){var f=e[_],p=t[_],m=null;f.material&&p.material&&(m=i.getContactMaterial(f.material,p.material)||null);for(var S=0==f.collisionResponse||0==p.collisionResponse||f.type&r.KINEMATIC&&p.type&r.STATIC||f.type&r.STATIC&&p.type&r.KINEMATIC||f.type&r.KINEMATIC&&p.type&r.KINEMATIC,T=0;T<f.shapes.length;T++){f.quaternion.mult(f.shapeOrientations[T],l),f.quaternion.vmult(f.shapeOffsets[T],u),u.vadd(f.position,u);for(var E=f.shapes[T],b=0;b<p.shapes.length;b++){p.quaternion.mult(p.shapeOrientations[b],c),p.quaternion.vmult(p.shapeOffsets[b],h),h.vadd(p.position,h);var A=p.shapes[b];if(E.collisionFilterMask&A.collisionFilterGroup&&A.collisionFilterMask&E.collisionFilterGroup&&!(u.distanceTo(h)>E.boundingSphereRadius+A.boundingSphereRadius)){S|=0==E.collisionResponse||0==A.collisionResponse;var C=null;E.material&&A.material&&(C=i.getContactMaterial(E.material,A.material)||null),this.currentContactMaterial=C||m||i.defaultContactMaterial;var w=this[E.type|A.type];if(w&&(E.type<A.type?w.call(this,E,A,u,h,l,c,f,p,E,A,S):w.call(this,A,E,h,u,c,l,p,f,E,A,S))&&S){i.shapeOverlapKeeper.set(E.id,A.id),i.bodyOverlapKeeper.set(f.id,p.id);var R={si:E,sj:A};i.triggerDic.set(E.id,A.id,R),i.oldTriggerDic.set(E.id,A.id,R)}}}}}},d.prototype[a.types.BOX|a.types.BOX]=d.prototype.boxBox=function(e,t,i,n,r,a,o,s,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,i,n,r,a,o,s,e,t,u)},d.prototype[a.types.BOX|a.types.CONVEXPOLYHEDRON]=d.prototype.boxConvex=function(e,t,i,n,r,a,o,s,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,i,n,r,a,o,s,e,t,u)},d.prototype[a.types.BOX|a.types.PARTICLE]=d.prototype.boxParticle=function(e,t,i,n,r,a,o,s,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,i,n,r,a,o,s,e,t,u)},d.prototype[a.types.SPHERE]=d.prototype.sphereSphere=function(e,t,i,n,r,a,o,s,l,c,u){if(u)return i.distanceSquared(n)<Math.pow(e.radius+t.radius,2);var h=this.createContactEquation(o,s,e,t,l,c);n.vsub(i,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(e.radius,h.ri),h.rj.mult(-t.radius,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(o.position,h.ri),h.rj.vadd(n,h.rj),h.rj.vsub(s.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var S=new s,T=new s,E=new s;d.prototype[a.types.PLANE|a.types.TRIMESH]=d.prototype.planeTrimesh=function(e,t,i,n,r,a,o,c,u,h,_){var d=new s,f=S;f.set(0,0,1),r.vmult(f,f);for(var p=0;p<t.vertices.length/3;p++){t.getVertex(p,d);var m=new s;m.copy(d),l.pointToWorldFrame(n,a,m,d);var v=T;if(d.vsub(i,v),f.dot(v)<=0){if(_)return!0;var g=this.createContactEquation(o,c,e,t,u,h);g.ni.copy(f);var y=E;f.scale(v.dot(f),y),d.vsub(y,y),g.ri.copy(y),g.ri.vsub(o.position,g.ri),g.rj.copy(d),g.rj.vsub(c.position,g.rj),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}}};var b=new s,A=new s,C=(new s,new s),w=new s,R=new s,I=new s,O=new s,M=new s,P=new s,k=new s,D=new s,B=new s,L=new s,N=new n,F=[];d.prototype[a.types.SPHERE|a.types.TRIMESH]=d.prototype.sphereTrimesh=function(e,t,i,n,r,a,s,c,u,h,_){var d=R,f=I,p=O,m=M,v=P,g=k,y=N,x=w,S=A,T=F;l.pointToLocalFrame(n,a,i,v);var E=e.radius;y.lowerBound.set(v.x-E,v.y-E,v.z-E),y.upperBound.set(v.x+E,v.y+E,v.z+E),t.getTrianglesInAABB(y,T);for(var z=C,U=e.radius*e.radius,G=0;G<T.length;G++)for(var H=0;H<3;H++)if(t.getVertex(t.indices[3*T[G]+H],z),z.vsub(v,S),S.norm2()<=U){if(x.copy(z),l.pointToWorldFrame(n,a,x,z),z.vsub(i,S),_)return!0;(j=this.createContactEquation(s,c,e,t,u,h)).ni.copy(S),j.ni.normalize(),j.ri.copy(j.ni),j.ri.scale(e.radius,j.ri),j.ri.vadd(i,j.ri),j.ri.vsub(s.position,j.ri),j.rj.copy(z),j.rj.vsub(c.position,j.rj),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}for(G=0;G<T.length;G++)for(H=0;H<3;H++){t.getVertex(t.indices[3*T[G]+H],d),t.getVertex(t.indices[3*T[G]+(H+1)%3],f),f.vsub(d,p),v.vsub(f,g);var V=g.dot(p);v.vsub(d,g);var W=g.dot(p);if(0<W&&V<0&&(v.vsub(d,g),m.copy(p),m.normalize(),W=g.dot(m),m.scale(W,g),g.vadd(d,g),(Q=g.distanceTo(v))<e.radius)){if(_)return!0;var j=this.createContactEquation(s,c,e,t,u,h);g.vsub(v,j.ni),j.ni.normalize(),j.ni.scale(e.radius,j.ri),l.pointToWorldFrame(n,a,g,g),g.vsub(c.position,j.rj),l.vectorToWorldFrame(a,j.ni,j.ni),l.vectorToWorldFrame(a,j.ri,j.ri),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}}for(var q=D,X=B,Y=L,K=b,Z=(G=0,T.length);G!==Z;G++){t.getTriangleVertices(T[G],q,X,Y),t.getNormal(T[G],K),v.vsub(q,g);var Q=g.dot(K);if(K.scale(Q,g),v.vsub(g,g),Q=g.distanceTo(v),o.pointInTriangle(g,q,X,Y)&&Q<e.radius){if(_)return!0;j=this.createContactEquation(s,c,e,t,u,h),g.vsub(v,j.ni),j.ni.normalize(),j.ni.scale(e.radius,j.ri),l.pointToWorldFrame(n,a,g,g),g.vsub(c.position,j.rj),l.vectorToWorldFrame(a,j.ni,j.ni),l.vectorToWorldFrame(a,j.ri,j.ri),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}}T.length=0};var z=new s,U=new s,G=new s,H=new s,V=new s;d.prototype[a.types.SPHERE|a.types.PLANE]=d.prototype.spherePlane=function(e,t,i,n,r,a,o,s,l,c,u){if(G.set(0,0,1),a.vmult(G,G),G.negate(G),G.normalize(),G.mult(e.radius,H),i.vsub(n,z),G.mult(G.dot(z),U),z.vsub(U,V),-z.dot(G)<=e.radius){if(u)return!0;var h=this.createContactEquation(o,s,e,t,l,c);h.ni.copy(G),h.ri.copy(H),h.rj.copy(V);var _=h.ri,d=h.rj;_.vadd(i,_),_.vsub(o.position,_),d.vadd(n,d),d.vsub(s.position,d),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}return!1};var W=new s,j=new s,q=new s;function X(e,t,i){for(var n=null,r=e.length,a=0;a!==r;a++){var o=e[a],s=W;e[(a+1)%r].vsub(o,s);var l=j;s.cross(t,l);var c=q;i.vsub(o,c);var u=l.dot(c);if(!(null===n||0<u&&!0===n||u<=0&&!1===n))return!1;null===n&&(n=0<u)}return!0}var Y=new s,K=new s,Z=new s,Q=new s,J=[new s,new s,new s,new s,new s,new s],$=new s,ee=new s,te=new s,ie=new s;d.prototype[a.types.SPHERE|a.types.BOX]=d.prototype.sphereBox=function(e,t,i,n,r,a,o,s,l,c,u){var h=this.v3pool,_=J;i.vsub(n,Y),t.getSideNormals(_,a);for(var d=e.radius,f=!1,p=ee,m=te,v=ie,g=null,y=0,x=0,S=0,T=null,E=0,b=_.length;E!==b&&!1===f;E++){var A=K;A.copy(_[E]);var C=A.norm();A.normalize();var w=Y.dot(A);if(w<C+d&&0<w){var R=Z,I=Q;R.copy(_[(E+1)%3]),I.copy(_[(E+2)%3]);var O=R.norm(),M=I.norm();R.normalize(),I.normalize();var P=Y.dot(R),k=Y.dot(I);if(P<O&&-O<P&&k<M&&-M<k){var D=Math.abs(w-C-d);if((null===T||D<T)&&(T=D,x=P,S=k,g=C,p.copy(A),m.copy(R),v.copy(I),y++,u))return!0}}}if(y){f=!0;var B=this.createContactEquation(o,s,e,t,l,c);p.mult(-d,B.ri),B.ni.copy(p),B.ni.negate(B.ni),p.mult(g,p),m.mult(x,m),p.vadd(m,p),v.mult(S,v),p.vadd(v,B.rj),B.ri.vadd(i,B.ri),B.ri.vsub(o.position,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(s.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}for(var L=h.get(),N=$,F=0;2!==F&&!f;F++)for(var z=0;2!==z&&!f;z++)for(var U=0;2!==U&&!f;U++)if(L.set(0,0,0),F?L.vadd(_[0],L):L.vsub(_[0],L),z?L.vadd(_[1],L):L.vsub(_[1],L),U?L.vadd(_[2],L):L.vsub(_[2],L),n.vadd(L,N),N.vsub(i,N),N.norm2()<d*d){if(u)return!0;f=!0,(B=this.createContactEquation(o,s,e,t,l,c)).ri.copy(N),B.ri.normalize(),B.ni.copy(B.ri),B.ri.mult(d,B.ri),B.rj.copy(L),B.ri.vadd(i,B.ri),B.ri.vsub(o.position,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(s.position,B.rj),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult)}h.release(L),L=null;var G=h.get(),H=h.get(),V=(B=h.get(),h.get()),W=(D=h.get(),_.length);for(F=0;F!==W&&!f;F++)for(z=0;z!==W&&!f;z++)if(F%3!=z%3){_[z].cross(_[F],G),G.normalize(),_[F].vadd(_[z],H),B.copy(i),B.vsub(H,B),B.vsub(n,B);var j=B.dot(G);for(G.mult(j,V),U=0;U===F%3||U===z%3;)U++;D.copy(i),D.vsub(V,D),D.vsub(H,D),D.vsub(n,D);var q=Math.abs(j),X=D.norm();if(q<_[U].norm()&&X<d){if(u)return!0;f=!0;var ne=this.createContactEquation(o,s,e,t,l,c);H.vadd(V,ne.rj),ne.rj.copy(ne.rj),D.negate(ne.ni),ne.ni.normalize(),ne.ri.copy(ne.rj),ne.ri.vadd(n,ne.ri),ne.ri.vsub(i,ne.ri),ne.ri.normalize(),ne.ri.mult(d,ne.ri),ne.ri.vadd(i,ne.ri),ne.ri.vsub(o.position,ne.ri),ne.rj.vadd(n,ne.rj),ne.rj.vsub(s.position,ne.rj),this.result.push(ne),this.createFrictionEquationsFromContact(ne,this.frictionResult)}}h.release(G,H,B,V,D)};var ne=new s,re=new s,ae=new s,oe=new s,se=new s,le=new s,ce=new s,ue=new s,he=new s,_e=new s;d.prototype[a.types.SPHERE|a.types.CONVEXPOLYHEDRON]=d.prototype.sphereConvex=function(e,t,i,n,r,a,o,s,l,c,u){var h=this.v3pool;i.vsub(n,ne);for(var _=t.faceNormals,d=t.faces,f=t.vertices,p=e.radius,m=0;m!==f.length;m++){var v=f[m],g=se;a.vmult(v,g),n.vadd(g,g);var y=oe;if(g.vsub(i,y),y.norm2()<p*p)return!!u||(x=!0,(D=this.createContactEquation(o,s,e,t,l,c)).ri.copy(y),D.ri.normalize(),D.ni.copy(D.ri),D.ri.mult(p,D.ri),g.vsub(n,D.rj),D.ri.vadd(i,D.ri),D.ri.vsub(o.position,D.ri),D.rj.vadd(n,D.rj),D.rj.vsub(s.position,D.rj),this.result.push(D),void this.createFrictionEquationsFromContact(D,this.frictionResult))}for(var x=!1,S=(m=0,d.length);m!==S&&!1===x;m++){var T=_[m],E=d[m],b=le;a.vmult(T,b);var A=ce;a.vmult(f[E[0]],A),A.vadd(n,A);var C=ue;b.mult(-p,C),i.vadd(C,C);var w=he;C.vsub(A,w);var R=w.dot(b),I=_e;if(i.vsub(A,I),R<0&&0<I.dot(b)){for(var O=[],M=0,P=E.length;M!==P;M++){var k=h.get();a.vmult(f[E[M]],k),n.vadd(k,k),O.push(k)}if(X(O,b,i)){if(u)return!0;x=!0;var D=this.createContactEquation(o,s,e,t,l,c);b.mult(-p,D.ri),b.negate(D.ni);var B=h.get();b.mult(-R,B);var L=h.get();b.mult(-p,L),i.vsub(n,D.rj),D.rj.vadd(L,D.rj),D.rj.vadd(B,D.rj),D.rj.vadd(n,D.rj),D.rj.vsub(s.position,D.rj),D.ri.vadd(i,D.ri),D.ri.vsub(o.position,D.ri),h.release(B),h.release(L),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult),M=0;for(var N=O.length;M!==N;M++)h.release(O[M]);return}for(M=0;M!==E.length;M++){var F=h.get(),z=h.get();a.vmult(f[E[(M+1)%E.length]],F),a.vmult(f[E[(M+2)%E.length]],z),n.vadd(F,F),n.vadd(z,z);var U=re;z.vsub(F,U);var G=ae;U.unit(G);var H=h.get(),V=h.get();i.vsub(F,V);var W=V.dot(G);G.mult(W,H),H.vadd(F,H);var j=h.get();if(H.vsub(i,j),0<W&&W*W<U.norm2()&&j.norm2()<p*p){if(u)return!0;for(D=this.createContactEquation(o,s,e,t,l,c),H.vsub(n,D.rj),H.vsub(i,D.ni),D.ni.normalize(),D.ni.mult(p,D.ri),D.rj.vadd(n,D.rj),D.rj.vsub(s.position,D.rj),D.ri.vadd(i,D.ri),D.ri.vsub(o.position,D.ri),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult),M=0,N=O.length;M!==N;M++)h.release(O[M]);return h.release(F),h.release(z),h.release(H),h.release(j),void h.release(V)}h.release(F),h.release(z),h.release(H),h.release(j),h.release(V)}for(M=0,N=O.length;M!==N;M++)h.release(O[M])}}},new s,new s,d.prototype[a.types.PLANE|a.types.BOX]=d.prototype.planeBox=function(e,t,i,n,r,a,o,s,l,c,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,i,n,r,a,o,s,e,t,u)};var de=new s,fe=new s,pe=new s,me=new s;d.prototype[a.types.PLANE|a.types.CONVEXPOLYHEDRON]=d.prototype.planeConvex=function(e,t,i,n,r,a,o,s,l,c,u){var h=de,_=fe;_.set(0,0,1),r.vmult(_,_);for(var d=0,f=pe,p=0;p!==t.vertices.length;p++)if(h.copy(t.vertices[p]),a.vmult(h,h),n.vadd(h,h),h.vsub(i,f),_.dot(f)<=0){if(u)return!0;var m=this.createContactEquation(o,s,e,t,l,c),v=me;_.mult(_.dot(f),v),h.vsub(v,v),v.vsub(i,m.ri),m.ni.copy(_),h.vsub(n,m.rj),m.ri.vadd(i,m.ri),m.ri.vsub(o.position,m.ri),m.rj.vadd(n,m.rj),m.rj.vsub(s.position,m.rj),this.result.push(m),d++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&d&&this.createFrictionFromAverage(d)};var ve=new s,ge=new s;d.prototype[a.types.CONVEXPOLYHEDRON]=d.prototype.convexConvex=function(e,t,i,n,r,a,o,s,l,c,u,h,_){var d=ve;if(!(i.distanceTo(n)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,i,r,n,a,d,h,_)){var f=[],p=ge;e.clipAgainstHull(i,r,t,n,a,d,-100,100,f);for(var m=0,v=0;v!==f.length;v++){if(u)return!0;var g=this.createContactEquation(o,s,e,t,l,c),y=g.ri,x=g.rj;d.negate(g.ni),f[v].normal.negate(p),p.mult(f[v].depth,p),f[v].point.vadd(p,y),x.copy(f[v].point),y.vsub(i,y),x.vsub(n,x),y.vadd(i,y),y.vsub(o.position,y),x.vadd(n,x),x.vsub(s.position,x),this.result.push(g),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(g,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}};var ye=new s,xe=new s,Se=new s;d.prototype[a.types.PLANE|a.types.PARTICLE]=d.prototype.planeParticle=function(e,t,i,n,r,a,o,s,l,c,u){var h=ye;h.set(0,0,1),o.quaternion.vmult(h,h);var _=xe;if(n.vsub(o.position,_),h.dot(_)<=0){if(u)return!0;var d=this.createContactEquation(s,o,t,e,l,c);d.ni.copy(h),d.ni.negate(d.ni),d.ri.set(0,0,0);var f=Se;h.mult(h.dot(n),f),n.vsub(f,f),d.rj.copy(f),this.result.push(d),this.createFrictionEquationsFromContact(d,this.frictionResult)}};var Te=new s;d.prototype[a.types.PARTICLE|a.types.SPHERE]=d.prototype.sphereParticle=function(e,t,i,n,r,a,o,s,l,c,u){var h=Te;if(h.set(0,0,1),n.vsub(i,h),h.norm2()<=e.radius*e.radius){if(u)return!0;var _=this.createContactEquation(s,o,t,e,l,c);h.normalize(),_.rj.copy(h),_.rj.mult(e.radius,_.rj),_.ni.copy(h),_.ni.negate(_.ni),_.ri.set(0,0,0),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}};var Ee=new c,be=new s,Ae=(new s,new s),Ce=new s,we=new s;d.prototype[a.types.PARTICLE|a.types.CONVEXPOLYHEDRON]=d.prototype.convexParticle=function(e,t,i,n,r,a,o,s,l,c,u){var h=-1,_=Ae,d=we,f=null,p=be;if(p.copy(n),p.vsub(i,p),r.conjugate(Ee),Ee.vmult(p,p),e.pointIsInside(p)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(i,r),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(r);for(var m=0,v=e.faces.length;m!==v;m++){var g=[e.worldVertices[e.faces[m][0]]],y=e.worldFaceNormals[m];n.vsub(g[0],Ce);var x=-y.dot(Ce);if(null===f||Math.abs(x)<Math.abs(f)){if(u)return!0;f=x,h=m,_.copy(y)}}if(-1!==h){var S=this.createContactEquation(s,o,t,e,l,c);_.mult(f,d),d.vadd(n,d),d.vsub(i,d),S.rj.copy(d),_.negate(S.ni),S.ri.set(0,0,0);var T=S.ri,E=S.rj;T.vadd(n,T),T.vsub(s.position,T),E.vadd(i,E),E.vsub(o.position,E),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},d.prototype[a.types.BOX|a.types.HEIGHTFIELD]=d.prototype.boxHeightfield=function(e,t,i,n,r,a,o,s,l,c,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,i,n,r,a,o,s,e,t,u)};var Re=new s,Ie=new s,Oe=[0];d.prototype[a.types.CONVEXPOLYHEDRON|a.types.HEIGHTFIELD]=d.prototype.convexHeightfield=function(e,t,i,n,r,a,o,s,c,u,h){var _=t.data,d=t.elementSize,f=e.boundingSphereRadius,p=Ie,m=Oe,v=Re;l.pointToLocalFrame(n,a,i,v);var g=Math.floor((v.x-f)/d)-1,y=Math.ceil((v.x+f)/d)+1,x=Math.floor((v.y-f)/d)-1,S=Math.ceil((v.y+f)/d)+1;if(!(y<0||S<0||g>_.length||x>_[0].length)){g<0&&(g=0),y<0&&(y=0),x<0&&(x=0),S<0&&(S=0),g>=_.length&&(g=_.length-1),y>=_.length&&(y=_.length-1),S>=_[0].length&&(S=_[0].length-1),x>=_[0].length&&(x=_[0].length-1);var T=[];t.getRectMinMax(g,x,y,S,T);var E=T[0],b=T[1];if(!(v.z-f>b||v.z+f<E))for(var A=g;A<y;A++)for(var C=x;C<S;C++){var w=!1;if(t.getConvexTrianglePillar(A,C,!1),l.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.convexConvex(e,t.pillarConvex,i,p,r,a,o,s,c,u,h,m,null)),h&&w)return!0;if(t.getConvexTrianglePillar(A,C,!0),l.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.convexConvex(e,t.pillarConvex,i,p,r,a,o,s,c,u,h,m,null)),h&&w)return!0}}};var Me=new s,Pe=new s;d.prototype[a.types.SPHERE|a.types.HEIGHTFIELD]=d.prototype.sphereHeightfield=function(e,t,i,n,r,a,o,s,c,u,h){var _=t.data,d=e.radius,f=t.elementSize,p=Pe,m=Me;l.pointToLocalFrame(n,a,i,m);var v=Math.floor((m.x-d)/f)-1,g=Math.ceil((m.x+d)/f)+1,y=Math.floor((m.y-d)/f)-1,x=Math.ceil((m.y+d)/f)+1;if(!(g<0||x<0||v>_.length||y>_[0].length)){v<0&&(v=0),g<0&&(g=0),y<0&&(y=0),x<0&&(x=0),v>=_.length&&(v=_.length-1),g>=_.length&&(g=_.length-1),x>=_[0].length&&(x=_[0].length-1),y>=_[0].length&&(y=_[0].length-1);var S=[];t.getRectMinMax(v,y,g,x,S);var T=S[0],E=S[1];if(!(m.z-d>E||m.z+d<T))for(var b=this.result,A=v;A<g;A++)for(var C=y;C<x;C++){var w=b.length,R=!1;if(t.getConvexTrianglePillar(A,C,!1),l.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(R=this.sphereConvex(e,t.pillarConvex,i,p,r,a,o,s,e,t,h)),h&&R)return!0;if(t.getConvexTrianglePillar(A,C,!0),l.pointToWorldFrame(n,a,t.pillarOffset,p),i.distanceTo(p)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(R=this.sphereConvex(e,t.pillarConvex,i,p,r,a,o,s,e,t,h)),h&&R)return!0;if(2<b.length-w)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":30,"../math/Transform":31,"../math/Vec3":32,"../objects/Body":33,"../shapes/ConvexPolyhedron":40,"../shapes/Shape":45,"../solver/Solver":49,"../utils/Vec3Pool":56}],58:[function(e,t,i){t.exports=y,e("../shapes/Shape");var n=e("../math/Vec3"),r=e("../math/Quaternion"),a=e("../solver/GSSolver"),o=(e("../equations/ContactEquation"),e("../equations/FrictionEquation"),e("./Narrowphase")),s=e("../utils/EventTarget"),l=e("../collision/ArrayCollisionMatrix"),c=e("../collision/ObjectCollisionMatrix"),u=e("../collision/OverlapKeeper"),h=e("../material/Material"),_=e("../material/ContactMaterial"),d=e("../objects/Body"),f=e("../utils/TupleDictionary"),p=e("../collision/RaycastResult"),m=e("../collision/AABB"),v=e("../collision/Ray"),g=e("../collision/NaiveBroadphase");function y(e){e=e||{},s.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new n,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new g,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new a,this.constraints=[],this.narrowphase=new o(this),this.collisionMatrix=new l,this.collisionMatrixPrevious=new l,this.bodyOverlapKeeper=new u,this.shapeOverlapKeeper=new u,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new f,this.defaultMaterial=new h("default"),this.defaultContactMaterial=new _(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this),this.substeps=0,this.cm=new c,this.tm=new c,this.triggerDic=new f,this.oldTriggerDic=new f,this.contactsDic=new f,this.oldContactsDic=new f}y.idToBodyMap={},y.idToShapeMap={},y.prototype=new s,new m;var x=new v;if(y.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},y.prototype.numObjects=function(){return this.bodies.length},y.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},y.prototype.add=y.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof d&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.cm.setNumObjects(this.bodies.length),y.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},y.prototype.addConstraint=function(e){this.constraints.push(e)},y.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},y.prototype.rayTest=function(e,t,i){i instanceof p?this.raycastClosest(e,t,{skipBackfaces:!0},i):this.raycastAll(e,t,{skipBackfaces:!0},i)},y.prototype.raycastAll=function(e,t,i,n){return i.mode=v.ALL,i.from=e,i.to=t,i.callback=n,x.intersectWorld(this,i)},y.prototype.raycastAny=function(e,t,i,n){return i.mode=v.ANY,i.from=e,i.to=t,i.result=n,x.intersectWorld(this,i)},y.prototype.raycastClosest=function(e,t,i,n){return i.mode=v.CLOSEST,i.from=e,i.to=t,i.result=n,x.intersectWorld(this,i)},y.prototype.removeBody=y.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,i=this.bodies,n=i.indexOf(e);if(-1!==n){i.splice(n,1);for(var r=0;r!==i.length;r++)i[r].index=r;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete y.idToBodyMap[e.id],this.cm.setNumObjects(t),this.dispatchEvent(this.removeBodyEvent)}},y.prototype.getBodyById=function(e){return y.idToBodyMap[e]},y.prototype.getShapeById=function(e){return y.idToShapeMap[e]},y.prototype.addMaterial=function(e){this.materials.push(e)},y.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var S=Date.now();performance.timing&&performance.timing.navigationStart&&(S=performance.timing.navigationStart),performance.now=function(){return Date.now()-S}}new n,y.prototype.step=function(e,t,i){if(i=i||10,0===(t=t||0))this.internalStep(e),this.time+=e,this.substeps=1;else{for(this.accumulator+=t,this.substeps=0;this.accumulator>=e&&this.substeps<i;)this.internalStep(e),this.accumulator-=e,this.substeps++;for(var n=this.accumulator%e/e,r=0;r!==this.bodies.length;r++){var a=this.bodies[r];a.previousPosition.lerp(a.position,n,a.interpolatedPosition),a.previousQuaternion.slerp(a.quaternion,n,a.interpolatedQuaternion),a.previousQuaternion.normalize()}this.time+=t}};var T,E,b,A,C,w,R={type:"postStep"},I={type:"preStep"},O={type:"collide",body:null,contact:null},M=[],P=[],k=[],D=[];new n,new n,new n,new n,new n,new n,new n,new n,new n,new r,new r,new r,new n,y.prototype.internalStep=function(e){this.dt=e;var t,i=this.contacts,n=k,r=D,a=this.numObjects(),o=this.bodies,s=this.solver,l=this.gravity,c=this.doProfiling,u=this.profile,h=d.DYNAMIC,_=this.constraints,f=P,p=(l.norm(),l.x),m=l.y,v=l.z,g=0;for(c&&(t=performance.now()),g=0;g!==a;g++)if((L=o[g]).useGravity&&L.type===h){var y=L.force,x=L.mass;y.x+=x*p,y.y+=x*m,y.z+=x*v}g=0;for(var S=this.subsystems.length;g!==S;g++)this.subsystems[g].update();c&&(t=performance.now()),n.length=0,r.length=0,this.broadphase.collisionPairs(this,n,r),c&&(u.broadphase=performance.now()-t);var T=_.length;for(g=0;g!==T;g++)if(!(H=_[g]).collideConnected)for(var E=n.length-1;0<=E;--E)(H.bodyA===n[E]&&H.bodyB===r[E]||H.bodyB===n[E]&&H.bodyA===r[E])&&(n.splice(E,1),r.splice(E,1));this.collisionMatrixTick(),c&&(t=performance.now());var b=M,A=i.length;for(g=0;g!==A;g++)b.push(i[g]);i.length=0;var C=this.frictionEquations.length;for(g=0;g!==C;g++)f.push(this.frictionEquations[g]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(n,r,this,i,b,this.frictionEquations,f),c&&(u.narrowphase=performance.now()-t),c&&(t=performance.now()),g=0;g<this.frictionEquations.length;g++)s.addEquation(this.frictionEquations[g]);for(var w=i.length,B=0;B!==w;B++){var L=(H=i[B]).bi,N=H.bj,F=H.si,z=H.sj;if(F.material&&z.material?0<=F.material.restitution&&0<=z.material.restitution&&(H.restitution=F.material.restitution*z.material.restitution):L.material&&N.material&&0<=L.material.restitution&&0<=N.material.restitution&&(H.restitution=L.material.restitution*N.material.restitution),s.addEquation(H),L.allowSleep&&L.type===d.DYNAMIC&&L.sleepState===d.SLEEPING&&N.sleepState===d.AWAKE&&N.type!==d.STATIC){var U=N.velocity.norm2()+N.angularVelocity.norm2();2*Math.pow(N.sleepSpeedLimit,2)<=U&&(L._wakeUpAfterNarrowphase=!0)}if(N.allowSleep&&N.type===d.DYNAMIC&&N.sleepState===d.SLEEPING&&L.sleepState===d.AWAKE&&L.type!==d.STATIC){var G=L.velocity.norm2()+L.angularVelocity.norm2();2*Math.pow(L.sleepSpeedLimit,2)<=G&&(N._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(L,N,!0),this.collisionMatrixPrevious.get(L,N)||(O.body=N,O.contact=H,L.dispatchEvent(O),O.body=L,N.dispatchEvent(O)),this.bodyOverlapKeeper.set(L.id,N.id),this.shapeOverlapKeeper.set(F.id,z.id)}for(this.emitContactEvents(),c&&(u.makeContactConstraints=performance.now()-t,t=performance.now()),g=0;g!==a;g++)(L=o[g])._wakeUpAfterNarrowphase&&(L.wakeUp(),L._wakeUpAfterNarrowphase=!1);for(T=_.length,g=0;g!==T;g++){var H;(H=_[g]).update(),E=0;for(var V=H.equations.length;E!==V;E++){var W=H.equations[E];s.addEquation(W)}}s.solve(e,this),c&&(u.solve=performance.now()-t),s.removeAllEquations();var j=Math.pow;for(g=0;g!==a;g++)if((L=o[g]).type&h){var q=j(1-L.linearDamping,e),X=L.velocity;X.mult(q,X);var Y=L.angularVelocity;if(Y){var K=j(1-L.angularDamping,e);Y.mult(K,Y)}}for(this.dispatchEvent(I),g=0;g!==a;g++)(L=o[g]).preStep&&L.preStep.call(L);c&&(t=performance.now());var Z=this.stepnumber%(this.quatNormalizeSkip+1)==0,Q=this.quatNormalizeFast;for(g=0;g!==a;g++)o[g].integrate(e,Z,Q);for(this.clearForces(),this.broadphase.dirty=!0,c&&(u.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(R),g=0;g!==a;g++){var J=(L=o[g]).postStep;J&&J.call(L)}if(this.allowSleep)for(g=0;g!==a;g++)o[g].sleepTick(this.time)},y.prototype.emitContactEvents=(T=[],E=[],b={type:"beginContact",bodyA:null,bodyB:null},A={type:"endContact",bodyA:null,bodyB:null},C={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},w={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},function(){var e=this.hasAnyEventListener("beginContact"),t=this.hasAnyEventListener("endContact");if((e||t)&&this.bodyOverlapKeeper.getDiff(T,E),e){for(var i=0,n=T.length;i<n;i+=2)b.bodyA=this.getBodyById(T[i]),b.bodyB=this.getBodyById(T[i+1]),this.dispatchEvent(b);b.bodyA=b.bodyB=null}if(t){for(i=0,n=E.length;i<n;i+=2)A.bodyA=this.getBodyById(E[i]),A.bodyB=this.getBodyById(E[i+1]),this.dispatchEvent(A);A.bodyA=A.bodyB=null}T.length=E.length=0;var r=this.hasAnyEventListener("beginShapeContact"),a=this.hasAnyEventListener("endShapeContact");if((r||a)&&this.shapeOverlapKeeper.getDiff(T,E),r){for(i=0,n=T.length;i<n;i+=2){var o=this.getShapeById(T[i]),s=this.getShapeById(T[i+1]);C.shapeA=o,C.shapeB=s,C.bodyA=o.body,C.bodyB=s.body,this.dispatchEvent(C)}C.bodyA=C.bodyB=C.shapeA=C.shapeB=null}if(a){for(i=0,n=E.length;i<n;i+=2)o=this.getShapeById(E[i]),s=this.getShapeById(E[i+1]),w.shapeA=o,w.shapeB=s,w.bodyA=o.body,w.bodyB=s.body,this.dispatchEvent(w);w.bodyA=w.bodyB=w.shapeA=w.shapeB=null}}),y.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,i=0;i!==t;i++){var n=e[i];n.force,n.torque,n.force.set(0,0,0),n.torque.set(0,0,0)}};var B={type:"cc-trigger",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null},L={type:"cc-collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},N=[];y.prototype.emitTriggeredEvents=function(){if(0!=this.substeps){for(var e,t,i=this.triggerDic.getLength();i--;)if(e=this.triggerDic.getKeyByIndex(i),null!=(t=this.triggerDic.getDataByKey(e))){var n=t.si,r=t.sj;this.tm.get(n,r)?B.event="onTriggerStay":(this.tm.set(n,r,!0),B.event="onTriggerEnter"),B.selfShape=n,B.otherShape=r,B.selfBody=n.body,B.otherBody=r.body,n.dispatchEvent(B),B.selfShape=r,B.otherShape=n,B.selfBody=r.body,B.otherBody=n.body,r.dispatchEvent(B)}for(i=this.oldTriggerDic.getLength();0<i;)i--,e=this.oldTriggerDic.getKeyByIndex(i),null==this.triggerDic.getDataByKey(e)&&null!=(t=this.oldTriggerDic.getDataByKey(e))&&(n=t.si,r=t.sj,this.tm.set(n,r,!1),this.oldTriggerDic.del(n.id,r.id)&&i--,B.event="onTriggerExit",B.selfShape=n,B.otherShape=r,B.selfBody=n.body,B.otherBody=r.body,n.dispatchEvent(B),B.selfShape=r,B.otherShape=n,B.selfBody=r.body,B.otherBody=n.body,r.dispatchEvent(B));this.triggerDic.reset()}},y.prototype.emitCollisionEvents=function(){if(0!=this.substeps){for(var e,t,i=this.contacts,n=this.contacts.length;n--;){var r=(u=i[n]).si,a=u.sj,o=this.contactsDic.get(r.id,a.id);null==o&&(o=this.contactsDic.set(r.id,a.id,[])),o.push(u)}for(n=this.contactsDic.getLength();n--;)if(e=this.contactsDic.getKeyByIndex(n),null!=(t=this.contactsDic.getDataByKey(e))){r=t[0].si,a=t[0].sj;var s=r.body,l=a.body;this.cm.get(s,l)?L.event="onCollisionStay":(this.cm.set(s,l,!0),L.event="onCollisionEnter"),L.bi=s,L.contact=t[0],L.contacts=t,L.body=l,L.selfShape=r,L.otherShape=a,s.dispatchEvent(L),L.body=s,L.selfShape=a,L.otherShape=r,l.dispatchEvent(L)}var c=N;for(n=c.length;n--;){var u;r=(u=c[n]).si,a=u.sj,null==this.oldContactsDic.get(r.id,a.id)&&this.oldContactsDic.set(r.id,a.id,u)}for(n=this.oldContactsDic.getLength();n--;)e=this.oldContactsDic.getKeyByIndex(n),null==this.contactsDic.getDataByKey(e)&&(r=(t=this.oldContactsDic.getDataByKey(e)).si,a=t.sj,s=r.body,l=a.body,this.cm.get(s,l)&&(s.isSleeping()&&l.isSleeping()||(this.cm.set(s,l,!1),L.bi=s,L.contact=t,L.event="onCollisionExit",L.body=l,L.selfShape=r,L.otherShape=a,L.contacts.length=0,L.contacts.push(t),s.dispatchEvent(L),L.body=s,L.selfShape=a,L.otherShape=r,l.dispatchEvent(L))));this.contactsDic.reset(),this.oldContactsDic.reset(),M=N,N=this.contacts.slice(),this.contacts.length=0}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":30,"../math/Vec3":32,"../objects/Body":33,"../shapes/Shape":45,"../solver/GSSolver":48,"../utils/EventTarget":51,"../utils/TupleDictionary":54,"./Narrowphase":57}]},{},[2])(2)}));O4.CANNON;!function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(A4||(A4=e("ERigidBodyType",{}))),function(e){e[e.X_AXIS=0]="X_AXIS",e[e.Y_AXIS=1]="Y_AXIS",e[e.Z_AXIS=2]="Z_AXIS"}(C4||(C4=e("EAxisDirection",{}))),et(C4),function(e){e[e.VERTEX=1]="VERTEX",e[e.LINE=2]="LINE",e[e.TRIANGLE=3]="TRIANGLE",e[e.TETRAHEDRON=4]="TETRAHEDRON"}(w4||(w4={})),et(w4),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.MESH=5]="MESH",e[e.PLANE=6]="PLANE",e[e.SIMPLEX=7]="SIMPLEX",e[e.TERRAIN=8]="TERRAIN"}(R4||(R4={})),et(R4),function(e){e[e.POINT_TO_POINT=0]="POINT_TO_POINT",e[e.HINGE=1]="HINGE",e[e.CONE_TWIST=2]="CONE_TWIST"}(I4||(I4={})),et(I4);var M4={INITED:!1},P4=function(){return 0},k4={impl:null,collider:null,attachedRigidBody:null,initialize:P4,onLoad:P4,onEnable:P4,onDisable:P4,onDestroy:P4,setGroup:P4,getGroup:P4,addGroup:P4,removeGroup:P4,setMask:P4,getMask:P4,addMask:P4,removeMask:P4,setMaterial:P4,setAsTrigger:P4,setCenter:P4,getAABB:P4,getBoundingSphere:P4,setSize:P4,setRadius:P4,setCylinderHeight:P4,setDirection:P4,setHeight:P4,setShapeType:P4,setVertices:P4,setMesh:P4,setTerrain:P4,setNormal:P4,setConstant:P4};function D4(e){return function(){if(M4.INITED)return;M4.INITED=!0;var e=E._global.CC_PHYSICS_BUILTIN,t=E._global.CC_PHYSICS_CANNON,i=E._global.CC_PHYSICS_AMMO;M4[R4.BOX]=function(e){return new E4.BoxShape(e)},M4[R4.SPHERE]=function(e){return new E4.SphereShape(e)},M4[R4.CAPSULE]=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return e||i?new E4.CapsuleShape(t,n,r):(G(9610),k4)},M4[R4.CYLINDER]=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return t||i?new E4.CylinderShape(e,n,r):(G(9612),k4)},M4[R4.CONE]=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return t||i?new E4.ConeShape(e,n,r):(G(9612),k4)},M4[R4.MESH]=function(){return t||i?new E4.TrimeshShape:(G(9611),k4)},M4[R4.TERRAIN]=function(){return t||i?new E4.TerrainShape:(P("[Physics]: builtin physics system doesn't support cylinder collider"),k4)},M4[R4.SIMPLEX]=function(){return t||i?new E4.SimplexShape:(P("[Physics]: builtin physics system doesn't support simple collider"),k4)},M4[R4.PLANE]=function(){return t||i?new E4.PlaneShape:(P("[Physics]: builtin physics system doesn't support plane collider"),k4)}}(),M4[e]()}var B4,L4,N4,F4,z4,U4,G4,H4,V4={INITED:!1},W4={impl:null,initialize:P4,onLoad:P4,onEnable:P4,onDisable:P4,onDestroy:P4,setEnableCollision:P4,setConnectedBody:P4,setPivotA:P4,setPivotB:P4};function j4(e){return function(){if(V4.INITED)return;V4.INITED=!0;E._global.CC_PHYSICS_BUILTIN;var e=E._global.CC_PHYSICS_CANNON,t=E._global.CC_PHYSICS_AMMO;V4[I4.POINT_TO_POINT]=function(){return e||t?new E4.PointToPointConstraint:(P("[Physics]: builtin physics system doesn't support point to point constraint"),W4)},V4[I4.HINGE]=function(){return e||t?new E4.HingeConstraint:(P("[Physics]: builtin physics system doesn't support hinge constraint"),W4)},V4[I4.CONE_TWIST]=function(){return e||t?new E4.ConeTwistConstraint:(P("[Physics]: builtin physics system doesn't support cone twist constraint"),W4)}}(),V4[e]()}var q4,X4=e("PhysicMaterial",ii("cc.PhysicMaterial")((H4=G4=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_friction",N4,c(e)),x(e,"_rollingFriction",F4,c(e)),x(e,"_spinningFriction",z4,c(e)),x(e,"_restitution",U4,c(e)),t.allMaterials.push(c(e)),""==e._uuid&&(e._uuid="pm_"+t._idCounter++),e}return o(t,e),r(t,[{key:"friction",get:function(){return this._friction},set:function(e){pn(this._friction,e)||(this._friction=e,this.emit("physics_material_update"))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){pn(this._rollingFriction,e)||(this._rollingFriction=e,this.emit("physics_material_update"))}},{key:"spinningFriction",get:function(){return this._spinningFriction},set:function(e){pn(this._spinningFriction,e)||(this._spinningFriction=e,this.emit("physics_material_update"))}},{key:"restitution",get:function(){return this._restitution},set:function(e){pn(this._restitution,e)||(this._restitution=e,this.emit("physics_material_update"))}}]),r(t,[{key:"clone",value:function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e._rollingFriction=this._rollingFriction,e._spinningFriction=this._spinningFriction,e}},{key:"destroy",value:function(){if(_(s(t.prototype),"destroy",this).call(this)){var e=t.allMaterials.indexOf(this);return e>=0&&t.allMaterials.splice(e,1),!0}return!1}}]),t}(cn),G4.allMaterials=[],G4._idCounter=0,S((L4=H4).prototype,"friction",[vi],Object.getOwnPropertyDescriptor(L4.prototype,"friction"),L4.prototype),S(L4.prototype,"rollingFriction",[vi],Object.getOwnPropertyDescriptor(L4.prototype,"rollingFriction"),L4.prototype),S(L4.prototype,"spinningFriction",[vi],Object.getOwnPropertyDescriptor(L4.prototype,"spinningFriction"),L4.prototype),S(L4.prototype,"restitution",[vi],Object.getOwnPropertyDescriptor(L4.prototype,"restitution"),L4.prototype),N4=S(L4.prototype,"_friction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),F4=S(L4.prototype,"_rollingFriction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),z4=S(L4.prototype,"_spinningFriction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),U4=S(L4.prototype,"_restitution",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),B4=L4))||B4),Y4=e("PhysicsRayResult",function(){function e(){i(this,e),this._hitPoint=new oa,this._hitNormal=new oa,this._distance=0,this._collider=null}return r(e,[{key:"_assign",value:function(e,t,i,n){oa.copy(this._hitPoint,e),oa.copy(this._hitNormal,n),this._distance=t,this._collider=i}},{key:"clone",value:function(){var t=new e;return oa.copy(t._hitPoint,this._hitPoint),oa.copy(t._hitNormal,this._hitNormal),t._distance=this._distance,t._collider=this._collider,t}},{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collider}},{key:"hitNormal",get:function(){return this._hitNormal}}]),e}());!function(e){e[e.DEFAULT=1]="DEFAULT"}(q4||(q4={})),et(q4),E.internal.PhysicsGroup=q4;var K4=function e(){var t=this;i(this,e),this.updateArray=[];for(var n=function(e){var i=1<<e;t["_".concat(i)]=0,Object.defineProperty(t,i,{get:function(){return this["_".concat(i)]},set:function(e){this["_".concat(i)]!=e&&(this["_".concat(i)]=e,this.updateArray.indexOf(i)<0&&this.updateArray.push(i))}})},r=0;r<32;r++)n(r);this._1=q4.DEFAULT},Z4=e("PhysicsSystem",function(e){function t(){var e;i(this,t),(e=u(this,s(t).call(this))).physicsWorld=void 0,e.raycastClosestResult=new Y4,e.raycastResults=[],e.collisionMatrix=new K4,e.useCollisionMatrix=void 0,e.useNodeChains=void 0,e._enable=!0,e._allowSleep=!0,e._maxSubSteps=1,e._subStepCount=0,e._fixedTimeStep=1/60,e._autoSimulation=!0,e._accumulator=0,e._sleepThreshold=.1,e._gravity=new oa(0,-10,0),e._material=new X4,e.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},e.raycastResultPool=new Ui((function(){return new Y4}),1);var n=CO.config?CO.config.physics:null;if(n){if(oa.copy(e._gravity,n.gravity),e._allowSleep=n.allowSleep,e._fixedTimeStep=n.fixedTimeStep,e._maxSubSteps=n.maxSubSteps,e._sleepThreshold=n.sleepThreshold,e.autoSimulation=n.autoSimulation,e.useNodeChains=n.useNodeChains,e.useCollisionMatrix=n.useCollsionMatrix,n.defaultMaterial&&(e._material.friction=n.defaultMaterial.friction,e._material.rollingFriction=n.defaultMaterial.rollingFriction,e._material.spinningFriction=n.defaultMaterial.spinningFriction,e._material.restitution=n.defaultMaterial.restitution),n.collisionMatrix)for(var r in n.collisionMatrix){var a=1<<parseInt(r);e.collisionMatrix["_".concat(a)]=n.collisionMatrix[r]}}else e.useCollisionMatrix=!1,e.useNodeChains=!1;return e._material.on("physics_material_update",e._updateMaterial,c(e)),e.physicsWorld=new E4.PhysicsWorld,e.physicsWorld.setGravity(e._gravity),e.physicsWorld.setAllowSleep(e._allowSleep),e.physicsWorld.setDefaultMaterial(e._material),e}return o(t,e),r(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.physicsWorld.setAllowSleep(e)}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(e){this._maxSubSteps=e}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(e){this._fixedTimeStep=e}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e),this.physicsWorld.setGravity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(e){this._autoSimulation=e}},{key:"defaultMaterial",get:function(){return this._material}}],[{key:"PHYSICS_NONE",get:function(){return!b4}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===b4}},{key:"PHYSICS_CANNON",get:function(){return"cannon.js"===b4}},{key:"PHYSICS_AMMO",get:function(){return"ammo.js"===b4}},{key:"PhysicsGroup",get:function(){return q4}},{key:"instance",get:function(){return t._instance}}]),r(t,[{key:"postUpdate",value:function(e){if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=e,AB.emit(iB.EVENT_BEFORE_PHYSICS);this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.updateCollisionMatrix(),this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this._accumulator-=this._fixedTimeStep,this._subStepCount++,this.physicsWorld.emitEvents(),this.physicsWorld.syncSceneToPhysics()}AB.emit(iB.EVENT_AFTER_PHYSICS)}}else this.physicsWorld.syncSceneToPhysics()}},{key:"resetAccumulator",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this._accumulator=e}},{key:"step",value:function(e,t,i){this.physicsWorld.step(e,t,i)}},{key:"syncSceneToPhysics",value:function(){this.physicsWorld.syncSceneToPhysics()}},{key:"emitEvents",value:function(){this.physicsWorld.emitEvents()}},{key:"updateCollisionMatrix",value:function(){if(this.useCollisionMatrix)for(var e=this.collisionMatrix.updateArray;e.length>0;){var t=e.pop(),i=this.collisionMatrix[t];this.physicsWorld.updateCollisionMatrix(t,i)}}},{key:"resetCollisionMatrix",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4294967295,t=0;t<32;t++){var i=1<<t;this.collisionMatrix["".concat(i)]=e}}},{key:"isCollisionGroup",value:function(e,t){var i=this.collisionMatrix,n=i[e];return e&i[t]&&t&n}},{key:"setCollisionGroup",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=this.collisionMatrix;i?(n[e]|=t,n[t]|=e):(n[e]&=~t,n[t]&=~e)}},{key:"raycast",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e7,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return this.updateCollisionMatrix(),this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=t,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=n,this.physicsWorld.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults)}},{key:"raycastClosest",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4294967295,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e7,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return this.updateCollisionMatrix(),this.raycastOptions.mask=t,this.raycastOptions.maxDistance=i,this.raycastOptions.queryTrigger=n,this.physicsWorld.raycastClosest(e,this.raycastOptions,this.raycastClosestResult)}},{key:"_updateMaterial",value:function(){this.physicsWorld.setDefaultMaterial(this._material)}}]),t}(PD));Z4.ID="PHYSICS",Z4._instance=void 0,AB.once(iB.EVENT_INIT,(function(){!function(){if(!Z4.PHYSICS_NONE){var e=new E.PhysicsSystem;E.PhysicsSystem._instance=e,AB.registerSystem(Z4.ID,e,0)}}()}));var Q4=new O4.Vec3,J4=new O4.Vec3,$4=function(){function e(){i(this,e),this._isEnabled=!1}return r(e,[{key:"setAllowSleep",value:function(e){this.impl.allowSleep=e,this._wakeUpIfSleep()}},{key:"setMass",value:function(e){this.impl.mass=e,0==this.impl.mass?this.impl.type=O4.Body.STATIC:this.impl.type=this._rigidBody.isKinematic?O4.Body.KINEMATIC:O4.Body.DYNAMIC,this.impl.updateMassProperties(),this._wakeUpIfSleep()}},{key:"setIsKinematic",value:function(e){0==this.impl.mass?this.impl.type=O4.Body.STATIC:this.impl.type=e?O4.Body.KINEMATIC:O4.Body.DYNAMIC}},{key:"fixRotation",value:function(e){this.impl.fixedRotation=e,this.impl.updateMassProperties(),this._wakeUpIfSleep()}},{key:"setLinearDamping",value:function(e){this.impl.linearDamping=e}},{key:"setAngularDamping",value:function(e){this.impl.angularDamping=e}},{key:"useGravity",value:function(e){this.impl.useGravity=e,this._wakeUpIfSleep()}},{key:"setLinearFactor",value:function(e){oa.copy(this.impl.linearFactor,e),this._wakeUpIfSleep()}},{key:"setAngularFactor",value:function(e){oa.copy(this.impl.angularFactor,e),this._wakeUpIfSleep()}},{key:"initialize",value:function(e){this._rigidBody=e,this._sharedBody=Z4.instance.physicsWorld.getSharedBody(this._rigidBody.node),this._sharedBody.reference=!0,this._sharedBody.wrappedBody=this}},{key:"onLoad",value:function(){}},{key:"onEnable",value:function(){this._isEnabled=!0,this.setGroup(this._rigidBody.group),Z4.instance.useCollisionMatrix&&this.setMask(Z4.instance.collisionMatrix[this._rigidBody.group]),this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.useGravity(this._rigidBody.useGravity),this.setIsKinematic(this._rigidBody.isKinematic),this.fixRotation(this._rigidBody.fixedRotation),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this._sharedBody.enabled=!0}},{key:"onDisable",value:function(){this._isEnabled=!1,this._sharedBody.enabled=!1}},{key:"onDestroy",value:function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null}},{key:"clearVelocity",value:function(){this.impl.velocity.setZero(),this.impl.angularVelocity.setZero()}},{key:"clearForces",value:function(){this.impl.force.setZero(),this.impl.torque.setZero()}},{key:"clearState",value:function(){this.clearVelocity(),this.clearForces()}},{key:"wakeUp",value:function(){return this.impl.wakeUp()}},{key:"sleep",value:function(){return this.impl.sleep()}},{key:"setSleepThreshold",value:function(e){this.impl.sleepSpeedLimit=e,this._wakeUpIfSleep()}},{key:"getSleepThreshold",value:function(){return this.impl.sleepSpeedLimit}},{key:"getLinearVelocity",value:function(e){return oa.copy(e,this.impl.velocity),e}},{key:"setLinearVelocity",value:function(e){this._wakeUpIfSleep(),oa.copy(this.impl.velocity,e)}},{key:"getAngularVelocity",value:function(e){return oa.copy(e,this.impl.angularVelocity),e}},{key:"setAngularVelocity",value:function(e){this._wakeUpIfSleep(),oa.copy(this.impl.angularVelocity,e)}},{key:"applyForce",value:function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=oa.ZERO),this.impl.applyForce(oa.copy(Q4,e),oa.copy(J4,t))}},{key:"applyImpulse",value:function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=oa.ZERO),this.impl.applyImpulse(oa.copy(Q4,e),oa.copy(J4,t))}},{key:"applyLocalForce",value:function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=oa.ZERO),this.impl.applyLocalForce(oa.copy(Q4,e),oa.copy(J4,t))}},{key:"applyLocalImpulse",value:function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=oa.ZERO),this.impl.applyLocalImpulse(oa.copy(Q4,e),oa.copy(J4,t))}},{key:"applyTorque",value:function(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),oa.add(this.impl.torque,this.impl.torque,e)}},{key:"applyLocalTorque",value:function(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),oa.copy(Q4,e),this.impl.vectorToWorldFrame(Q4,Q4),oa.add(this.impl.torque,this.impl.torque,Q4)}},{key:"getGroup",value:function(){return this.impl.collisionFilterGroup}},{key:"setGroup",value:function(e){this.impl.collisionFilterGroup=e,this._wakeUpIfSleep()}},{key:"addGroup",value:function(e){this.impl.collisionFilterGroup|=e,this._wakeUpIfSleep()}},{key:"removeGroup",value:function(e){this.impl.collisionFilterGroup&=~e,this._wakeUpIfSleep()}},{key:"getMask",value:function(){return this.impl.collisionFilterMask}},{key:"setMask",value:function(e){this.impl.collisionFilterMask=e,this._wakeUpIfSleep()}},{key:"addMask",value:function(e){this.impl.collisionFilterMask|=e,this._wakeUpIfSleep()}},{key:"removeMask",value:function(e){this.impl.collisionFilterMask&=~e,this._wakeUpIfSleep()}},{key:"_wakeUpIfSleep",value:function(){this.impl.isAwake()||this.impl.wakeUp()}},{key:"isAwake",get:function(){return this.impl.isAwake()}},{key:"isSleepy",get:function(){return this.impl.isSleepy()}},{key:"isSleeping",get:function(){return this.impl.isSleeping()}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),e}();function e3(e,t){e.__cc_wrapper__=t}function t3(e){return e.__cc_wrapper__}function i3(e,t){e.checkCollisionResponse=!t.queryTrigger,e.collisionFilterGroup=-1,e.collisionFilterMask=t.mask}function n3(e,t){e._assign(t.hitPointWorld,t.distance,t3(t.shape).collider,t.hitNormalWorld)}function r3(e){e.aabbNeedsUpdate=!0,e.updateMassProperties(),e.updateBoundingRadius()}var a3,o3,s3,l3,c3,u3,h3,_3,d3,f3,p3,m3,v3,g3,y3,x3,S3,T3,E3,b3,A3,C3,w3,R3,I3,O3,M3,P3,k3,D3,B3,L3,N3,F3,z3,U3,G3,H3,V3,W3,j3,q3,X3,Y3,K3,Z3,Q3,J3={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},$3=new O4.Quaternion,e5=new O4.Vec3,t5=new O4.Vec3,i5=function(){function e(){i(this,e),this._offset=new O4.Vec3,this._orient=new O4.Quaternion,this._index=-1,this.onTriggerListener=this._onTrigger.bind(this),this._isBinding=!1}return r(e,[{key:"setMaterial",value:function(t){null==t?this._shape.material=null:(null==e.idToMaterial[t._uuid]&&(e.idToMaterial[t._uuid]=new O4.Material(t._uuid)),this._shape.material=e.idToMaterial[t._uuid],this._shape.material.friction=t.friction,this._shape.material.restitution=t.restitution)}},{key:"setAsTrigger",value:function(e){this._shape.collisionResponse=!e,this._index>=0&&this._body.updateHasTrigger()}},{key:"setCenter",value:function(e){this._setCenter(e),this._index>=0&&r3(this._body)}},{key:"setAttachedBody",value:function(e){if(e){if(this._sharedBody){if(this._sharedBody.wrappedBody==e.body)return;this._sharedBody.reference=!1}this._sharedBody=Z4.instance.physicsWorld.getSharedBody(e.node),this._sharedBody.reference=!0}else this._sharedBody&&(this._sharedBody.reference=!1),this._sharedBody=Z4.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0}},{key:"getAABB",value:function(e){pa.copy($3,this._collider.node.worldRotation),this._shape.calculateWorldAABB(O4.Vec3.ZERO,$3,e5,t5),oa.subtract(e.halfExtents,t5,e5),oa.multiplyScalar(e.halfExtents,e.halfExtents,.5),oa.add(e.center,this._collider.node.worldPosition,this._collider.center)}},{key:"getBoundingSphere",value:function(e){e.radius=this._shape.boundingSphereRadius,oa.add(e.center,this._collider.node.worldPosition,this._collider.center)}},{key:"initialize",value:function(e){this._collider=e,this._isBinding=!0,this.onComponentSet(),e3(this._shape,this),this._shape.addEventListener("cc-trigger",this.onTriggerListener),this._sharedBody=Z4.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0}},{key:"onComponentSet",value:function(){}},{key:"onLoad",value:function(){this.setMaterial(this._collider.sharedMaterial),this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)}},{key:"onEnable",value:function(){this._sharedBody.addShape(this),this._sharedBody.enabled=!0}},{key:"onDisable",value:function(){this._sharedBody.removeShape(this),this._sharedBody.enabled=!1}},{key:"onDestroy",value:function(){this._sharedBody.reference=!1,this._shape.removeEventListener("cc-trigger",this.onTriggerListener),delete O4.World.idToShapeMap[this._shape.id],this._sharedBody=null,e3(this._shape,null),this._offset=null,this._orient=null,this._shape=null,this._collider=null,this.onTriggerListener=null}},{key:"getGroup",value:function(){return this._body.collisionFilterGroup}},{key:"setGroup",value:function(e){this._body.collisionFilterGroup=e,this._body.isAwake()||this._body.wakeUp()}},{key:"addGroup",value:function(e){this._body.collisionFilterGroup|=e,this._body.isAwake()||this._body.wakeUp()}},{key:"removeGroup",value:function(e){this._body.collisionFilterGroup&=~e,this._body.isAwake()||this._body.wakeUp()}},{key:"getMask",value:function(){return this._body.collisionFilterMask}},{key:"setMask",value:function(e){this._body.collisionFilterMask=e,this._body.isAwake()||this._body.wakeUp()}},{key:"addMask",value:function(e){this._body.collisionFilterMask|=e,this._body.isAwake()||this._body.wakeUp()}},{key:"removeMask",value:function(e){this._body.collisionFilterMask&=~e,this._body.isAwake()||this._body.wakeUp()}},{key:"setScale",value:function(e){this._setCenter(this._collider.center)}},{key:"setIndex",value:function(e){this._index=e}},{key:"setOffsetAndOrient",value:function(e,t){oa.copy(e,this._offset),pa.copy(t,this._orient),this._offset=e,this._orient=t}},{key:"_setCenter",value:function(e){var t=this._offset;oa.subtract(t,this._sharedBody.node.worldPosition,this._collider.node.worldPosition),oa.add(t,t,e),oa.multiply(t,t,this._collider.node.worldScale)}},{key:"_onTrigger",value:function(e){J3.type=e.event;var t=t3(e.selfShape),i=t3(e.otherShape);t&&t.collider.needTriggerEvent&&(J3.selfCollider=t.collider,J3.otherCollider=i?i.collider:null,J3.impl=e,this._collider.emit(J3.type,J3))}},{key:"impl",get:function(){return this._shape}},{key:"collider",get:function(){return this._collider}},{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_body",get:function(){return this._sharedBody.body}}]),e}();i5.idToMaterial={};var n5,r5,a5,o5,s5,l5,c5,u5,h5,_5,d5,f5,p5,m5,v5,g5,y5,x5,S5,T5,E5,b5=e("RigidBodyComponent",(a3=ii("cc.RigidBody"),o3=mi("i18n:cc.RigidBody"),s3=_i("Physics/RigidBody"),l3=ri(-1),c3=Li(Z4.PhysicsGroup),u3=wi(-2),h3=Si(""),_3=wi(0),d3=Si(""),f3=wi(.5),p3=gi((function(){return 0!=this._mass})),m3=Si(""),v3=wi(1),g3=gi((function(){return 0!=this._mass})),y3=Si(""),x3=wi(2),S3=gi((function(){return 0!=this._mass})),T3=Si(""),E3=wi(3),b3=gi((function(){return 0!=this._mass})),A3=Si(""),C3=wi(4),w3=gi((function(){return 0!=this._mass})),R3=Si(""),I3=wi(5),O3=gi((function(){return 0!=this._mass})),M3=Si(""),P3=wi(6),k3=gi((function(){return 0!=this._mass})),D3=Si(""),B3=wi(7),L3=gi((function(){return 0!=this._mass})),N3=Si(""),a3(F3=o3(F3=s3(F3=hi(F3=ai(F3=l3((Q3=Z3=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._body=null,x(n,"_group",U3,c(n)),x(n,"_mass",G3,c(n)),x(n,"_allowSleep",H3,c(n)),x(n,"_linearDamping",V3,c(n)),x(n,"_angularDamping",W3,c(n)),x(n,"_fixedRotation",j3,c(n)),x(n,"_isKinematic",q3,c(n)),x(n,"_useGravity",X3,c(n)),x(n,"_linearFactor",Y3,c(n)),x(n,"_angularFactor",K3,c(n)),n}return o(t,e),r(t,[{key:"onLoad",value:function(){this._body=new E4.RigidBody,this._body.initialize(this)}},{key:"onEnable",value:function(){this._body&&this._body.onEnable()}},{key:"onDisable",value:function(){this._body&&this._body.onDisable()}},{key:"onDestroy",value:function(){this._body&&this._body.onDestroy()}},{key:"applyForce",value:function(e,t){this._assertOnLoadCalled&&this._body.applyForce(e,t)}},{key:"applyLocalForce",value:function(e,t){this._assertOnLoadCalled&&this._body.applyLocalForce(e,t)}},{key:"applyImpulse",value:function(e,t){this._assertOnLoadCalled&&this._body.applyImpulse(e,t)}},{key:"applyLocalImpulse",value:function(e,t){this._assertOnLoadCalled&&this._body.applyLocalImpulse(e,t)}},{key:"applyTorque",value:function(e){this._assertOnLoadCalled&&this._body.applyTorque(e)}},{key:"applyLocalTorque",value:function(e){this._assertOnLoadCalled&&this._body.applyLocalTorque(e)}},{key:"wakeUp",value:function(){this._assertOnLoadCalled&&this._body.wakeUp()}},{key:"sleep",value:function(){this._assertOnLoadCalled&&this._body.sleep()}},{key:"clearState",value:function(){this._assertOnLoadCalled&&this._body.clearState()}},{key:"clearForces",value:function(){this._assertOnLoadCalled&&this._body.clearForces()}},{key:"clearVelocity",value:function(){this._assertOnLoadCalled&&this._body.clearVelocity()}},{key:"getLinearVelocity",value:function(e){this._assertOnLoadCalled&&this._body.getLinearVelocity(e)}},{key:"setLinearVelocity",value:function(e){this._assertOnLoadCalled&&this._body.setLinearVelocity(e)}},{key:"getAngularVelocity",value:function(e){this._assertOnLoadCalled&&this._body.getAngularVelocity(e)}},{key:"setAngularVelocity",value:function(e){this._assertOnLoadCalled&&this._body.setAngularVelocity(e)}},{key:"getGroup",value:function(){return this._assertOnLoadCalled?this._body.getGroup():0}},{key:"setGroup",value:function(e){this._assertOnLoadCalled&&(this.group=e)}},{key:"addGroup",value:function(e){this._assertOnLoadCalled&&!this._assertUseCollisionMatrix&&this._body.addGroup(e)}},{key:"removeGroup",value:function(e){this._assertOnLoadCalled&&!this._assertUseCollisionMatrix&&this._body.removeGroup(e)}},{key:"getMask",value:function(){return this._assertOnLoadCalled?this._body.getMask():0}},{key:"setMask",value:function(e){this._assertOnLoadCalled&&!this._assertUseCollisionMatrix&&this._body.setMask(e)}},{key:"addMask",value:function(e){this._assertOnLoadCalled&&!this._assertUseCollisionMatrix&&this._body.addMask(e)}},{key:"removeMask",value:function(e){this._assertOnLoadCalled&&!this._assertUseCollisionMatrix&&this._body.removeMask(e)}},{key:"group",get:function(){return this._group},set:function(e){this._group=e,this._body&&this._body.setGroup(e)}},{key:"mass",get:function(){return this._mass},set:function(e){e=e<0?0:e,this._mass=e,this._body&&this._body.setMass(e)}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._body&&this._body.setIsKinematic(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body&&this._body.useGravity(e)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e,this._body&&this._body.fixRotation(e)}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){oa.copy(this._linearFactor,e),this._body&&this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){oa.copy(this._angularFactor,e),this._body&&this._body.setAngularFactor(this._angularFactor)}},{key:"sleepThreshold",get:function(){return this._assertOnLoadCalled?this._body.getSleepThreshold():0},set:function(e){this._assertOnLoadCalled&&this._body.setSleepThreshold(e)}},{key:"isAwake",get:function(){return!!this._assertOnLoadCalled&&this._body.isAwake}},{key:"isSleepy",get:function(){return!!this._assertOnLoadCalled&&this._body.isSleepy}},{key:"isSleeping",get:function(){return!!this._assertOnLoadCalled&&this._body.isSleeping}},{key:"body",get:function(){return this._body}},{key:"_assertOnLoadCalled",get:function(){var e=0==this._isOnLoadCalled;return e&&k("[Physics]: Please make sure that the node has been added to the scene"),!e}},{key:"_assertUseCollisionMatrix",get:function(){return Z4.instance.useCollisionMatrix&&k("[Physics]: useCollisionMatrix is turn on, using collision matrix instead please."),Z4.instance.useCollisionMatrix}}]),t}(Yr),Z3.ERigidBodyType=A4,S((z3=Q3).prototype,"group",[c3,u3,h3],Object.getOwnPropertyDescriptor(z3.prototype,"group"),z3.prototype),S(z3.prototype,"mass",[_3,d3],Object.getOwnPropertyDescriptor(z3.prototype,"mass"),z3.prototype),S(z3.prototype,"allowSleep",[f3,p3,m3],Object.getOwnPropertyDescriptor(z3.prototype,"allowSleep"),z3.prototype),S(z3.prototype,"linearDamping",[v3,g3,y3],Object.getOwnPropertyDescriptor(z3.prototype,"linearDamping"),z3.prototype),S(z3.prototype,"angularDamping",[x3,S3,T3],Object.getOwnPropertyDescriptor(z3.prototype,"angularDamping"),z3.prototype),S(z3.prototype,"isKinematic",[E3,b3,A3],Object.getOwnPropertyDescriptor(z3.prototype,"isKinematic"),z3.prototype),S(z3.prototype,"useGravity",[C3,w3,R3],Object.getOwnPropertyDescriptor(z3.prototype,"useGravity"),z3.prototype),S(z3.prototype,"fixedRotation",[I3,O3,M3],Object.getOwnPropertyDescriptor(z3.prototype,"fixedRotation"),z3.prototype),S(z3.prototype,"linearFactor",[P3,k3,D3],Object.getOwnPropertyDescriptor(z3.prototype,"linearFactor"),z3.prototype),S(z3.prototype,"angularFactor",[B3,L3,N3],Object.getOwnPropertyDescriptor(z3.prototype,"angularFactor"),z3.prototype),U3=S(z3.prototype,"_group",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z4.PhysicsGroup.DEFAULT}}),G3=S(z3.prototype,"_mass",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),H3=S(z3.prototype,"_allowSleep",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),V3=S(z3.prototype,"_linearDamping",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),W3=S(z3.prototype,"_angularDamping",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),j3=S(z3.prototype,"_fixedRotation",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q3=S(z3.prototype,"_isKinematic",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),X3=S(z3.prototype,"_useGravity",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Y3=S(z3.prototype,"_linearFactor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(1,1,1)}}),K3=S(z3.prototype,"_angularFactor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(1,1,1)}}),F3=z3))||F3)||F3)||F3)||F3)||F3)||F3));b5||(b5=e("RigidBodyComponent",{}));var A5,C5,w5,R5,I5,O5,M5,P5,k5=e("ColliderComponent",(n5=ii("cc.Collider"),r5=Li(b5),a5=xi("Attached"),o5=wi(-2),s5=Li(X4),l5=xi("Material"),c5=wi(-1),u5=Si(""),h5=wi(0),_5=Si(""),d5=Li(oa),f5=wi(1),p5=Si(" Node "),m5=Li(X4),n5((E5=T5=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this))).TYPE=void 0,n._shape=null,n._aabb=null,n._boundingSphere=null,n._isSharedMaterial=!0,n._needTriggerEvent=!1,n._needCollisionEvent=!1,x(n,"_material",y5,c(n)),x(n,"_isTrigger",x5,c(n)),x(n,"_center",S5,c(n)),n.TYPE=e,n}return o(t,e),r(t,[{key:"attachedRigidBody",get:function(){return function e(t){var i=t.getComponent(b5);return i&&i.isValid?i:null==t.parent||t.parent==t.scene?null:e(t.parent)}(this.node)}},{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=this._material.clone(),this._material.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){this._shape&&(null!=e&&null!=this._material?this._material._uuid!=e._uuid&&(this._material.off("physics_material_update",this._updateMaterial,this),e.on("physics_material_update",this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):null!=e&&null==this._material?(e.on("physics_material_update",this._updateMaterial,this),this._material=e):null==e&&null!=this._material&&(this._material.off("physics_material_update",this._updateMaterial,this),this._material=e),this._updateMaterial())}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e,this._shape&&this._shape.setAsTrigger(this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(e){oa.copy(this._center,e),this._shape&&this._shape.setCenter(this._center)}},{key:"shape",get:function(){return this._shape}},{key:"worldBounds",get:function(){return null==this._aabb&&(this._aabb=new $c),this._shape&&this._shape.getAABB(this._aabb),this._aabb}},{key:"boundingSphere",get:function(){return null==this._boundingSphere&&(this._boundingSphere=new Uo),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}},{key:"needTriggerEvent",get:function(){return this._needTriggerEvent}},{key:"needCollisionEvent",get:function(){return this._needCollisionEvent}},{key:"_assertOnLoadCalled",get:function(){var e=0==this._isOnLoadCalled;return e&&k("[Physics]: Please make sure that the node has been added to the scene"),!e}},{key:"_assertUseCollisionMatrix",get:function(){return Z4.instance.useCollisionMatrix&&k("[Physics]: useCollisionMatrix is turn on, using collision matrix instead please."),Z4.instance.useCollisionMatrix}}]),r(t,[{key:"on",value:function(e,i,n,r){var a=_(s(t.prototype),"on",this).call(this,e,i,n,r);return this._updateNeedEvent(e),a}},{key:"off",value:function(e,i,n){_(s(t.prototype),"off",this).call(this,e,i,n),this._updateNeedEvent()}},{key:"once",value:function(e,i,n){var r=_(s(t.prototype),"once",this).call(this,e,i,n);return this._updateNeedEvent(e),r}},{key:"removeAll",value:function(e){_(s(t.prototype),"removeAll",this).call(this,e),this._updateNeedEvent()}},{key:"getGroup",value:function(){return this._assertOnLoadCalled?this._shape.getGroup():0}},{key:"setGroup",value:function(e){if(this._assertOnLoadCalled)if(Z4.instance.useCollisionMatrix){var t=this._shape.attachedRigidBody;t?t.group=e:(this._shape.setGroup(e),this._updateMask())}else this._shape.setGroup(e)}},{key:"addGroup",value:function(e){if(this._assertOnLoadCalled)if(this._assertUseCollisionMatrix){var t=this._shape.attachedRigidBody;t?t.group|=e:(this._shape.addGroup(e),this._updateMask())}else this._shape.addGroup(e)}},{key:"removeGroup",value:function(e){if(this._assertOnLoadCalled)if(this._assertUseCollisionMatrix){var t=this._shape.attachedRigidBody;t?t.group&=~e:(this._shape.removeGroup(e),this._updateMask())}else this._shape.removeGroup(e)}},{key:"getMask",value:function(){return this._assertOnLoadCalled?this._shape.getMask():0}},{key:"setMask",value:function(e){this._assertOnLoadCalled&&!this._assertUseCollisionMatrix&&this._shape.setMask(e)}},{key:"addMask",value:function(e){this._assertOnLoadCalled&&!this._assertUseCollisionMatrix&&this._shape.addMask(e)}},{key:"removeMask",value:function(e){this._assertOnLoadCalled&&!this._assertUseCollisionMatrix&&this._shape.removeMask(e)}},{key:"onLoad",value:function(){this._shape=D4(this.TYPE),this._shape.initialize(this),this.sharedMaterial=null==this._material?Z4.instance.defaultMaterial:this._material,this._shape.onLoad()}},{key:"onEnable",value:function(){this._shape&&this._shape.onEnable()}},{key:"onDisable",value:function(){this._shape&&this._shape.onDisable()}},{key:"onDestroy",value:function(){this._shape&&(this._material&&this._material.off("physics_material_update",this._updateMaterial,this),this._shape.onDestroy())}},{key:"_updateMaterial",value:function(){this._shape&&this._shape.setMaterial(this._material)}},{key:"_updateNeedEvent",value:function(e){this.isValid&&(void 0!==e?"onCollisionEnter"==e||"onCollisionStay"==e||"onCollisionExit"==e?this._needCollisionEvent=!0:"onTriggerEnter"!=e&&"onTriggerStay"!=e&&"onTriggerExit"!=e||(this._needTriggerEvent=!0):this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")?this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1):this._needTriggerEvent=!1)}},{key:"_updateMask",value:function(){this._shape.setMask(Z4.instance.collisionMatrix[this._shape.getGroup()])}}]),t}($i(Yr)),T5.EColliderType=R4,T5.EAxisDirection=C4,S((g5=E5).prototype,"attachedRigidBody",[r5,yi,a5,o5],Object.getOwnPropertyDescriptor(g5.prototype,"attachedRigidBody"),g5.prototype),S(g5.prototype,"sharedMaterial",[s5,l5,c5,u5],Object.getOwnPropertyDescriptor(g5.prototype,"sharedMaterial"),g5.prototype),S(g5.prototype,"isTrigger",[h5,_5],Object.getOwnPropertyDescriptor(g5.prototype,"isTrigger"),g5.prototype),S(g5.prototype,"center",[d5,f5,p5],Object.getOwnPropertyDescriptor(g5.prototype,"center"),g5.prototype),y5=S(g5.prototype,"_material",[m5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x5=S(g5.prototype,"_isTrigger",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S5=S(g5.prototype,"_center",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),v5=g5))||v5));k5||(k5=e("ColliderComponent",{}));var D5,B5,L5,N5,F5,z5,U5,G5,H5,V5,W5,j5,q5,X5,Y5,K5,Z5,Q5,J5,$5,e8,t8,i8,n8,r8,a8,o8,s8,l8,c8,u8,h8,_8,d8,f8,p8,m8,v8,g8,y8,x8,S8,T8,E8,b8,A8,C8,w8,R8,I8,O8,M8,P8,k8,D8,B8,L8,N8,F8,z8,U8,G8,H8,V8,W8,j8,q8,X8,Y8,K8,Z8,Q8,J8,$8,e6,t6,i6,n6,r6,a6,o6,s6,l6,c6,u6,h6,_6,d6,f6,p6,m6,v6,g6,y6,x6,S6,T6,E6=e("BoxColliderComponent",(A5=ii("cc.BoxCollider"),C5=mi("i18n:cc.BoxCollider"),w5=_i("Physics/BoxCollider"),R5=Li(oa),I5=Si(""),A5(O5=C5(O5=w5(O5=hi((S((M5=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,R4.BOX)),"_size",P5,c(e)),e}return o(t,e),r(t,[{key:"size",get:function(){return this._size},set:function(e){oa.copy(this._size,e),this._shape&&this.shape.setSize(this._size)}},{key:"shape",get:function(){return this._shape}}]),t}(k5)).prototype,"size",[R5,I5],Object.getOwnPropertyDescriptor(M5.prototype,"size"),M5.prototype),P5=S(M5.prototype,"_size",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(1,1,1)}}),O5=M5))||O5)||O5)||O5)||O5)),b6=e("SphereColliderComponent",(D5=ii("cc.SphereCollider"),B5=mi("i18n:cc.SphereCollider"),L5=_i("Physics/SphereCollider"),N5=Si(""),D5(F5=B5(F5=L5(F5=hi((S((z5=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,R4.SPHERE)),"_radius",U5,c(e)),e}return o(t,e),r(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this.shape.setRadius(this._radius)}},{key:"shape",get:function(){return this._shape}}]),t}(k5)).prototype,"radius",[N5],Object.getOwnPropertyDescriptor(z5.prototype,"radius"),z5.prototype),U5=S(z5.prototype,"_radius",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),F5=z5))||F5)||F5)||F5)||F5)),A6=e("CapsuleColliderComponent",(G5=ii("cc.CapsuleCollider"),H5=mi("i18n:cc.CapsuleCollider"),V5=_i("Physics/CapsuleCollider"),W5=Si(""),j5=Si(""),q5=Li(C4),X5=Si(""),G5(Y5=H5(Y5=V5(Y5=hi((S((K5=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,R4.CAPSULE)),"_radius",Z5,c(e)),x(e,"_cylinderHeight",Q5,c(e)),x(e,"_direction",J5,c(e)),e}return o(t,e),r(t,[{key:"radius",get:function(){return this._radius},set:function(e){e<0&&(e=0),this._radius=e,this.shape.setRadius(e)}},{key:"cylinderHeight",get:function(){return this._cylinderHeight},set:function(e){e<0&&(e=0),this._cylinderHeight=e,this.shape.setCylinderHeight(e)}},{key:"direction",get:function(){return this._direction},set:function(e){(e=Math.floor(e))<C4.X_AXIS||e>C4.Z_AXIS||(this._direction=e,this.shape.setDirection(e))}},{key:"height",get:function(){return 2*this._radius+this._cylinderHeight},set:function(e){var t=e-2*this._radius;t<0&&(t=0),this.cylinderHeight=t}},{key:"worldHeight",get:function(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}},{key:"shape",get:function(){return this._shape}}]),r(t,[{key:"_getRadiusScale",value:function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction==C4.Y_AXIS?Math.abs(kn(e.x,e.z)):this._direction==C4.X_AXIS?Math.abs(kn(e.y,e.z)):Math.abs(kn(e.x,e.y))}},{key:"_getHeightScale",value:function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction==C4.Y_AXIS?Math.abs(e.y):this._direction==C4.X_AXIS?Math.abs(e.x):Math.abs(e.z)}}]),t}(k5)).prototype,"radius",[W5],Object.getOwnPropertyDescriptor(K5.prototype,"radius"),K5.prototype),S(K5.prototype,"cylinderHeight",[j5],Object.getOwnPropertyDescriptor(K5.prototype,"cylinderHeight"),K5.prototype),S(K5.prototype,"direction",[q5,X5],Object.getOwnPropertyDescriptor(K5.prototype,"direction"),K5.prototype),Z5=S(K5.prototype,"_radius",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Q5=S(K5.prototype,"_cylinderHeight",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),J5=S(K5.prototype,"_direction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C4.Y_AXIS}}),Y5=K5))||Y5)||Y5)||Y5)||Y5)),C6=e("CylinderColliderComponent",($5=ii("cc.CylinderCollider"),e8=mi("i18n:cc.CylinderCollider"),t8=_i("Physics/CylinderCollider"),i8=Si(""),n8=Si(""),r8=Li(C4),$5(a8=e8(a8=t8(a8=hi((S((o8=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,R4.CYLINDER)),"_radius",s8,c(e)),x(e,"_height",l8,c(e)),x(e,"_direction",c8,c(e)),e}return o(t,e),r(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!=e&&(e<0&&(e=0),this._radius=e,this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!=e&&(e<0&&(e=0),this._height=e,this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!=e&&(e<C4.X_AXIS||e>C4.Z_AXIS||(this._direction=e,this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(k5)).prototype,"radius",[i8],Object.getOwnPropertyDescriptor(o8.prototype,"radius"),o8.prototype),S(o8.prototype,"height",[n8],Object.getOwnPropertyDescriptor(o8.prototype,"height"),o8.prototype),S(o8.prototype,"direction",[r8],Object.getOwnPropertyDescriptor(o8.prototype,"direction"),o8.prototype),s8=S(o8.prototype,"_radius",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),l8=S(o8.prototype,"_height",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),c8=S(o8.prototype,"_direction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C4.Y_AXIS}}),a8=o8))||a8)||a8)||a8)||a8)),w6=(e("ConeCollider",(u8=ii("cc.ConeCollider"),h8=mi("i18n:cc.ConeCollider"),_8=_i("Physics/ConeCollider(beta)"),d8=Si(""),f8=Si(""),p8=Li(C4),u8(m8=h8(m8=_8(m8=hi((S((v8=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,R4.CONE)),"_radius",g8,c(e)),x(e,"_height",y8,c(e)),x(e,"_direction",x8,c(e)),e}return o(t,e),r(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!=e&&(e<0&&(e=0),this._radius=e,this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!=e&&(e<0&&(e=0),this._height=e,this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!=e&&(e<C4.X_AXIS||e>C4.Z_AXIS||(this._direction=e,this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(k5)).prototype,"radius",[d8],Object.getOwnPropertyDescriptor(v8.prototype,"radius"),v8.prototype),S(v8.prototype,"height",[f8],Object.getOwnPropertyDescriptor(v8.prototype,"height"),v8.prototype),S(v8.prototype,"direction",[p8],Object.getOwnPropertyDescriptor(v8.prototype,"direction"),v8.prototype),g8=S(v8.prototype,"_radius",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),y8=S(v8.prototype,"_height",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),x8=S(v8.prototype,"_direction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return C4.Y_AXIS}}),m8=v8))||m8)||m8)||m8)||m8)),e("MeshColliderComponent",(S8=ii("cc.MeshCollider"),T8=mi("i18n:cc.MeshCollider"),E8=_i("Physics/MeshCollider"),b8=Li($_),S8(A8=T8(A8=E8(A8=hi((S((C8=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,R4.MESH)),"_mesh",w8,c(e)),x(e,"_convex",R8,c(e)),e}return o(t,e),r(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this.shape.setMesh(this._mesh)}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex=e}},{key:"shape",get:function(){return this._shape}}]),t}(k5)).prototype,"mesh",[b8],Object.getOwnPropertyDescriptor(C8.prototype,"mesh"),C8.prototype),S(C8.prototype,"convex",[vi],Object.getOwnPropertyDescriptor(C8.prototype,"convex"),C8.prototype),w8=S(C8.prototype,"_mesh",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R8=S(C8.prototype,"_convex",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),A8=C8))||A8)||A8)||A8)||A8))),R6=e("ConstantForce",(I8=ii("cc.ConstantForce"),O8=mi("i18n:cc.ConstantForce"),M8=ni(b5),P8=_i("Physics/ConstantForce"),k8=wi(0),D8=Si(""),B8=wi(1),L8=Si(""),N8=wi(2),F8=Si(""),z8=wi(3),U8=Si(""),I8(G8=O8(G8=M8(G8=P8(G8=ai(G8=hi((V8=S((H8=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._rigidBody=null,x(n,"_force",V8,c(n)),x(n,"_localForce",W8,c(n)),x(n,"_torque",j8,c(n)),x(n,"_localTorque",q8,c(n)),n._mask=0,n}return o(t,e),r(t,[{key:"onLoad",value:function(){this._rigidBody=this.node.getComponent(b5),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)}},{key:"lateUpdate",value:function(e){null!=this._rigidBody&&0!=this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))}},{key:"_maskUpdate",value:function(e,t){e.strictEquals(oa.ZERO)?this._mask&=~t:this._mask|=t}},{key:"force",get:function(){return this._force},set:function(e){oa.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){oa.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){oa.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){oa.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),t}(Yr)).prototype,"_force",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),W8=S(H8.prototype,"_localForce",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),j8=S(H8.prototype,"_torque",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),q8=S(H8.prototype,"_localTorque",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),S(H8.prototype,"force",[k8,D8],Object.getOwnPropertyDescriptor(H8.prototype,"force"),H8.prototype),S(H8.prototype,"localForce",[B8,L8],Object.getOwnPropertyDescriptor(H8.prototype,"localForce"),H8.prototype),S(H8.prototype,"torque",[N8,F8],Object.getOwnPropertyDescriptor(H8.prototype,"torque"),H8.prototype),S(H8.prototype,"localTorque",[z8,U8],Object.getOwnPropertyDescriptor(H8.prototype,"localTorque"),H8.prototype),G8=H8))||G8)||G8)||G8)||G8)||G8)||G8)),I6=(e("TERRAIN_MAX_LEVELS",4),e("TERRAIN_MAX_BLEND_LAYERS",4),e("TERRAIN_MAX_LAYER_COUNT",256)),O6=e("TERRAIN_BLOCK_TILE_COMPLEXITY",32),M6=e("TERRAIN_BLOCK_VERTEX_COMPLEXITY",33),P6=e("TERRAIN_BLOCK_VERTEX_SIZE",8),k6=e("TERRAIN_HEIGHT_BASE",32768),D6=e("TERRAIN_HEIGHT_FACTORY",1/512),B6=e("TERRAIN_HEIGHT_FMIN",-k6*D6),L6=e("TERRAIN_HEIGHT_FMAX",(65535-k6)*D6),N6=(e("TERRAIN_NORTH_INDEX",0),e("TERRAIN_SOUTH_INDEX",1),e("TERRAIN_WEST_INDEX",2),e("TERRAIN_EAST_INDEX",3),e("TERRAIN_DATA_VERSION",16842753)),F6=e("TERRAIN_DATA_VERSION2",16842754),z6=e("TERRAIN_DATA_VERSION3",16842755),U6=e("TERRAIN_DATA_VERSION_DEFAULT",16843025),G6=function(){function e(){i(this,e),this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}return r(e,[{key:"reserve",value:function(e){if(!(this.buffer.byteLength>e)){for(var t=this.buffer.byteLength;t<e;)t+=t;for(var i=new Uint8Array(t),n=0;n<this.length;++n)i[n]=this.buffer[n];this.buffer=i,this._buffView=new DataView(this.buffer.buffer)}}},{key:"assign",value:function(e){this.buffer=e,this.length=e.length,this._seekPos=e.byteOffset,this._buffView=new DataView(e.buffer)}},{key:"writeInt8",value:function(e){this.reserve(this.length+1),this._buffView.setInt8(this.length,e),this.length+=1}},{key:"writeInt16",value:function(e){this.reserve(this.length+2),this._buffView.setInt16(this.length,e,!0),this.length+=2}},{key:"writeInt32",value:function(e){this.reserve(this.length+4),this._buffView.setInt32(this.length,e,!0),this.length+=4}},{key:"writeIntArray",value:function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setInt32(this.length+4*t,e[t],!0);this.length+=4*e.length}},{key:"writeFloat",value:function(e){this.reserve(this.length+4),this._buffView.setFloat32(this.length,e,!0),this.length+=4}},{key:"writeFloatArray",value:function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setFloat32(this.length+4*t,e[t],!0);this.length+=4*e.length}},{key:"writeString",value:function(e){this.reserve(this.length+e.length+4),this._buffView.setInt32(this.length,e.length,!0);for(var t=0;t<e.length;++t)this._buffView.setInt8(this.length+4+t,e.charCodeAt(t));this.length+=e.length+4}},{key:"readInt8",value:function(){var e=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,e}},{key:"readInt16",value:function(){var e=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,e}},{key:"readInt",value:function(){var e=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,e}},{key:"readIntArray",value:function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getInt32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e}},{key:"readFloat",value:function(){var e=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,e}},{key:"readFloatArray",value:function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getFloat32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e}},{key:"readString",value:function(){for(var e=this.readInt(),t="",i=0;i<e;++i)t+=String.fromCharCode(this.readInt8());return t}}]),e}(),H6=e("TerrainLayerInfo",(function e(){i(this,e),this.slot=0,this.tileSize=1,this.detailMap=""})),V6=e("TerrainAsset",ii("cc.TerrainAsset")(X8=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._data=null,e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._layerBuffer=[-1,-1,-1,-1],e._layerInfos=[],e.loaded=!1,e}return o(t,e),r(t,[{key:"getLayer",value:function(e,t,i){var n=4*(t*this.blockCount[0]+e)+i;return e<this.blockCount[0]&&t<this.blockCount[1]&&n<this._layerBuffer.length?this._layerBuffer[n]:-1}},{key:"getHeight",value:function(e,t){var i=this._blockCount[0]*O6+1;return(this._heights[t*i+e]-k6)*D6}},{key:"getVertexCountI",value:function(){return this._blockCount.length<1?0:this._blockCount[0]*O6+1}},{key:"getVertexCountJ",value:function(){return this._blockCount.length<2?0:this._blockCount[1]*O6+1}},{key:"_setNativeData",value:function(e){this._data=e}},{key:"_loadNativeData",value:function(e){var t=new G6;t.assign(e);var i=t.readInt();if(i===U6)return!0;if(i!==N6&&i!==F6&&i!==z6)return!1;this.tileSize=t.readFloat(),t.readIntArray(this._blockCount),this.weightMapSize=t.readInt16(),this.lightMapSize=t.readInt16();var n=t.readInt();this.heights=new Uint16Array(n);for(var r=0;r<this.heights.length;++r)this.heights[r]=t.readInt16();var a=t.readInt();this.weights=new Uint8Array(a);for(var o=0;o<this.weights.length;++o)this.weights[o]=t.readInt8();if(i>=F6){var s=t.readInt();this.layerBuffer=new Array(s);for(var l=0;l<this.layerBuffer.length;++l)this.layerBuffer[l]=t.readInt16()}if(i>=z6){var c=t.readInt();this.layerInfos=new Array(c);for(var u=0;u<this.layerInfos.length;++u)this.layerInfos[u]=new H6,this.layerInfos[u].slot=t.readInt(),this.layerInfos[u].tileSize=t.readFloat(),this.layerInfos[u].detailMap=t.readString()}return!0}},{key:"_exportNativeData",value:function(){var e=new G6;e.writeInt32(z6),e.writeFloat(this.tileSize),e.writeIntArray(this._blockCount),e.writeInt16(this.weightMapSize),e.writeInt16(this.lightMapSize),e.writeInt32(this.heights.length);for(var t=0;t<this.heights.length;++t)e.writeInt16(this.heights[t]);e.writeInt32(this.weights.length);for(var i=0;i<this.weights.length;++i)e.writeInt8(this.weights[i]);e.writeInt32(this.layerBuffer.length);for(var n=0;n<this.layerBuffer.length;++n)e.writeInt16(this.layerBuffer[n]);e.writeInt32(this.layerInfos.length);for(var r=0;r<this.layerInfos.length;++r)e.writeInt32(this.layerInfos[r].slot),e.writeFloat(this.layerInfos[r].tileSize),e.writeString(this.layerInfos[r].detailMap);return e.buffer}},{key:"_exportDefaultNativeData",value:function(){var e=new G6;return e.writeInt32(U6),e.buffer}},{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?(this._data.set(new Uint8Array(e)),E.loader._cache[this.nativeUrl]&&(E.loader._cache[this.nativeUrl].content=this._data.buffer)):this._data=new Uint8Array(e),this._loadNativeData(this._data),this.loaded=!0,this.emit("load")}},{key:"tileSize",set:function(e){this._tileSize=e},get:function(){return this._tileSize}},{key:"blockCount",set:function(e){this._blockCount=e},get:function(){return this._blockCount}},{key:"lightMapSize",set:function(e){this._lightMapSize=e},get:function(){return this._lightMapSize}},{key:"weightMapSize",set:function(e){this._weightMapSize=e},get:function(){return this._weightMapSize}},{key:"heights",set:function(e){this._heights=e},get:function(){return this._heights}},{key:"weights",set:function(e){this._weights=e},get:function(){return this._weights}},{key:"layerBuffer",set:function(e){this._layerBuffer=e},get:function(){return this._layerBuffer}},{key:"layerInfos",set:function(e){this._layerInfos=e},get:function(){return this._layerInfos}}]),t}(cn))||X8),W6=(e("TerrainCollider",(Y8=ii("cc.TerrainCollider"),K8=mi("i18n:cc.TerrainCollider"),Z8=_i("Physics/TerrainCollider(beta)"),Q8=Li(V6),Y8(J8=K8(J8=Z8(J8=hi((S(($8=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,R4.TERRAIN)),"_terrain",e6,c(e)),e}return o(t,e),r(t,[{key:"terrain",get:function(){return this._terrain},set:function(e){this._terrain=e,this.shape.setTerrain(this._terrain)}},{key:"shape",get:function(){return this._shape}}]),t}(k5)).prototype,"terrain",[Q8],Object.getOwnPropertyDescriptor($8.prototype,"terrain"),$8.prototype),e6=S($8.prototype,"_terrain",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J8=$8))||J8)||J8)||J8)||J8)),e("SimplexCollider",(t6=ii("cc.SimplexCollider"),i6=mi("i18n:cc.SimplexCollider"),n6=_i("Physics/SimplexCollider"),r6=Li(w4),a6=gi((function(){return this._shapeType>1})),o6=gi((function(){return this._shapeType>2})),s6=gi((function(){return this._shapeType>3})),t6(l6=i6(l6=n6(l6=hi((d6=_6=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,R4.SIMPLEX)),"_shapeType",u6,c(e)),x(e,"_vertices",h6,c(e)),e}return o(t,e),r(t,[{key:"shapeType",get:function(){return this._shapeType},set:function(e){this._shapeType=e,this.shape.setShapeType(e)}},{key:"vertex0",get:function(){return this._vertices[0]},set:function(e){oa.copy(this._vertices[0],e),this.updateVertices()}},{key:"vertex1",get:function(){return this._vertices[1]},set:function(e){oa.copy(this._vertices[1],e),this.updateVertices()}},{key:"vertex2",get:function(){return this._vertices[2]},set:function(e){oa.copy(this._vertices[2],e),this.updateVertices()}},{key:"vertex3",get:function(){return this._vertices[3]},set:function(e){oa.copy(this._vertices[3],e),this.updateVertices()}},{key:"shape",get:function(){return this._shape}},{key:"vertices",get:function(){return this._vertices}}]),r(t,[{key:"updateVertices",value:function(){this.shape.setVertices(this._vertices)}}]),t}(k5),_6.ESimplexType=w4,S((c6=d6).prototype,"shapeType",[r6],Object.getOwnPropertyDescriptor(c6.prototype,"shapeType"),c6.prototype),S(c6.prototype,"vertex0",[vi],Object.getOwnPropertyDescriptor(c6.prototype,"vertex0"),c6.prototype),S(c6.prototype,"vertex1",[a6],Object.getOwnPropertyDescriptor(c6.prototype,"vertex1"),c6.prototype),S(c6.prototype,"vertex2",[o6],Object.getOwnPropertyDescriptor(c6.prototype,"vertex2"),c6.prototype),S(c6.prototype,"vertex3",[s6],Object.getOwnPropertyDescriptor(c6.prototype,"vertex3"),c6.prototype),u6=S(c6.prototype,"_shapeType",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return w4.TETRAHEDRON}}),h6=S(c6.prototype,"_vertices",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new oa(0,0,0),new oa(0,0,1),new oa(1,0,0),new oa(0,1,0)]}}),l6=c6))||l6)||l6)||l6)||l6)));W6||(W6=e("SimplexCollider",{}));e("PlaneCollider",(f6=ii("cc.PlaneCollider"),p6=mi("i18n:cc.PlaneCollider"),m6=_i("Physics/PlaneCollider(beta)"),v6=Li(oa),g6=Si(""),f6(y6=p6(y6=m6(y6=hi((S((x6=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,R4.PLANE)),"_normal",S6,c(e)),x(e,"_constant",T6,c(e)),e}return o(t,e),r(t,[{key:"normal",get:function(){return this._normal},set:function(e){oa.copy(this._normal,e),this.shape.setNormal(this._normal)}},{key:"constant",get:function(){return this._constant},set:function(e){this._constant=e,this.shape.setConstant(this._constant)}},{key:"shape",get:function(){return this._shape}}]),t}(k5)).prototype,"normal",[v6,g6],Object.getOwnPropertyDescriptor(x6.prototype,"normal"),x6.prototype),S(x6.prototype,"constant",[vi],Object.getOwnPropertyDescriptor(x6.prototype,"constant"),x6.prototype),S6=S(x6.prototype,"_normal",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa(0,1,0)}}),T6=S(x6.prototype,"_constant",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y6=x6))||y6)||y6)||y6)||y6));var j6,q6,X6,Y6,K6,Z6,Q6,J6,$6,e7,t7,i7,n7,r7,a7,o7,s7,l7,c7,u7,h7=e("Constraint",(j6=ii("cc.Constraint"),q6=ni(b5),X6=Li(b5),Y6=wi(-2),K6=Li(b5),Z6=wi(-1),Q6=wi(0),J6=Li(b5),j6($6=q6((r7=n7=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this))).TYPE=void 0,x(n,"_enableCollision",t7,c(n)),x(n,"_connectedBody",i7,c(n)),n._constraint=null,n.TYPE=e,n}return o(t,e),r(t,[{key:"attachedBody",get:function(){return this.getComponent(b5)}},{key:"connectedBody",get:function(){return this._connectedBody},set:function(e){this._connectedBody=e,this._constraint&&this._constraint.setConnectedBody(e)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(e){this._enableCollision=e,this._constraint&&this._constraint.setEnableCollision(e)}}]),r(t,[{key:"onLoad",value:function(){this._constraint=j4(this.TYPE),this._constraint.initialize(this),this._constraint.onLoad()}},{key:"onEnable",value:function(){this._constraint&&this._constraint.onEnable()}},{key:"onDisable",value:function(){this._constraint&&this._constraint.onDisable()}},{key:"onDestroy",value:function(){this._constraint&&this._constraint.onDestroy()}}]),t}($i(Yr)),n7.EConstraintType=I4,S((e7=r7).prototype,"attachedBody",[X6,yi,Y6],Object.getOwnPropertyDescriptor(e7.prototype,"attachedBody"),e7.prototype),S(e7.prototype,"connectedBody",[K6,Z6],Object.getOwnPropertyDescriptor(e7.prototype,"connectedBody"),e7.prototype),S(e7.prototype,"enableCollision",[Q6],Object.getOwnPropertyDescriptor(e7.prototype,"enableCollision"),e7.prototype),t7=S(e7.prototype,"_enableCollision",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),i7=S(e7.prototype,"_connectedBody",[J6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$6=e7))||$6)||$6));h7||(h7=e("Constraint",{}));var _7,d7,f7,p7,m7,v7,g7,y7,x7;e("HingeConstraint",ii("cc.HingeConstraint")(a7=mi("i18n:cc.HingeConstraint")(a7=_i("Physics/HingeConstraint(beta)")((s7=S((o7=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,I4.HINGE)),"axisA",s7,c(e)),x(e,"axisB",l7,c(e)),x(e,"pivotA",c7,c(e)),x(e,"pivotB",u7,c(e)),e}return o(t,e),t}(h7)).prototype,"axisA",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),l7=S(o7.prototype,"axisB",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),c7=S(o7.prototype,"pivotA",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),u7=S(o7.prototype,"pivotB",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),a7=o7))||a7)||a7)||a7),e("PointToPointConstraint",(_7=ii("cc.PointToPointConstraint"),d7=mi("i18n:cc.PointToPointConstraint"),f7=_i("Physics/PointToPointConstraint(beta)"),p7=Li(oa),m7=Li(oa),_7(v7=d7(v7=f7((S((g7=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this,I4.POINT_TO_POINT)),"_pivotA",y7,c(e)),x(e,"_pivotB",x7,c(e)),e}return o(t,e),r(t,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){oa.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){oa.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"constraint",get:function(){return this._constraint}}]),t}(h7)).prototype,"pivotA",[p7],Object.getOwnPropertyDescriptor(g7.prototype,"pivotA"),g7.prototype),S(g7.prototype,"pivotB",[m7],Object.getOwnPropertyDescriptor(g7.prototype,"pivotB"),g7.prototype),y7=S(g7.prototype,"_pivotA",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),x7=S(g7.prototype,"_pivotB",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oa}}),v7=g7))||v7)||v7)||v7));ka(Z4,"PhysicsSystem",[{name:"ins",newName:"instance"}]),ka(Z4.prototype,"PhysicsSystem.prototype",[{name:"deltaTime",newName:"fixedTimeStep"},{name:"maxSubStep",newName:"maxSubSteps"}]),Da(Z4.prototype,"PhysicsSystem.prototype",[{name:"useFixedTime"}]),ka(k5.prototype,"Collider.prototype",[{name:"attachedRigidbody",newName:"attachedRigidBody"}]),ka(E6.prototype,"BoxCollider.prototype",[{name:"boxShape",newName:"shape"}]),ka(b6.prototype,"SphereCollider.prototype",[{name:"sphereShape",newName:"shape"}]),ka(A6.prototype,"CapsuleCollider.prototype",[{name:"capsuleShape",newName:"shape"}]),ka(b5.prototype,"RigidBody.prototype",[{name:"rigidBody",newName:"body"}]),E.RigidBodyComponent=b5,ze.setClassAlias(b5,"cc.RigidBodyComponent"),E.ColliderComponent=k5,ze.setClassAlias(k5,"cc.ColliderComponent"),E.BoxColliderComponent=E6,ze.setClassAlias(E6,"cc.BoxColliderComponent"),E.SphereColliderComponent=b6,ze.setClassAlias(b6,"cc.SphereColliderComponent"),ze.setClassAlias(A6,"cc.CapsuleColliderComponent"),ze.setClassAlias(w6,"cc.MeshColliderComponent"),ze.setClassAlias(C6,"cc.CylinderColliderComponent"),E.PhysicsSystem=Z4,E.PhysicMaterial=X4,E.PhysicsRayResult=Y4,E.ConstantForce=R6;var S7=function(){function e(t){i(this,e),this.impl=null,this.event=void 0,this.event=t}return r(e,[{key:"isBodyA",get:function(){var e=this.event.selfCollider.shape.impl,t=this.impl.bj;return e.body.id==t.id}}]),r(e,[{key:"getLocalPointOnA",value:function(e){this.impl&&oa.copy(e,this.impl.rj)}},{key:"getLocalPointOnB",value:function(e){this.impl&&oa.copy(e,this.impl.ri)}},{key:"getWorldPointOnA",value:function(e){this.impl&&oa.add(e,this.impl.rj,this.impl.bj.position)}},{key:"getWorldPointOnB",value:function(e){this.impl&&oa.add(e,this.impl.ri,this.impl.bi.position)}},{key:"getLocalNormalOnB",value:function(e){this.impl&&oa.copy(e,this.impl.ni)}},{key:"getWorldNormalOnB",value:function(e){this.impl&&oa.transformQuat(e,this.impl.ni,this.impl.bi.quaternion)}}]),e}(),T7=new oa,E7=new pa,b7=[],A7={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},C7=function(){function e(t,n){i(this,e),this.node=void 0,this.wrappedWorld=void 0,this.body=void 0,this.shapes=[],this.wrappedBody=null,this.index=-1,this.ref=0,this.onCollidedListener=this.onCollided.bind(this),this.wrappedWorld=n,this.node=t,this.body=new O4.Body,this.body.collisionFilterGroup=Z4.PhysicsGroup.DEFAULT,this.body.sleepSpeedLimit=Z4.instance.sleepThreshold,this.body.material=this.wrappedWorld.impl.defaultMaterial,this.body.addEventListener("cc-collide",this.onCollidedListener)}return r(e,[{key:"enabled",set:function(e){e?this.index<0&&(this.index=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitial()):this.index>=0&&(0==this.shapes.length&&null==this.wrappedBody||0==this.shapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled)&&(this.body.sleep(),this.index=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"reference",set:function(e){e?this.ref++:this.ref--,0==this.ref&&this.destroy()}}],[{key:"getSharedBody",value:function(t,i){var n=t.uuid;if(e.sharedBodesMap.has(n))return e.sharedBodesMap.get(n);var r=new e(t,i);return e.sharedBodesMap.set(t.uuid,r),r}}]),r(e,[{key:"addShape",value:function(e){if(this.shapes.indexOf(e)<0){var t=this.body.shapes.length;this.body.addShape(e.impl),this.shapes.push(e),e.setIndex(t);var i=this.body.shapeOffsets[t],n=this.body.shapeOrientations[t];e.setOffsetAndOrient(i,n),this.body.isSleeping()&&this.body.wakeUp()}}},{key:"removeShape",value:function(e){var t=this.shapes.indexOf(e);t>=0&&(this.shapes.splice(t,1),this.body.removeShape(e.impl),e.setIndex(-1),this.body.isSleeping()&&this.body.wakeUp())}},{key:"syncSceneToPhysics",value:function(){if(this.node.hasChangedFlags&&(this.body.isSleeping()&&this.body.wakeUp(),oa.copy(this.body.position,this.node.worldPosition),pa.copy(this.body.quaternion,this.node.worldRotation),this.body.aabbNeedsUpdate=!0,this.node.hasChangedFlags&nv.SCALE)){for(var e=0;e<this.shapes.length;e++)this.shapes[e].setScale(this.node.worldScale);r3(this.body)}}},{key:"syncPhysicsToScene",value:function(){this.body.type!=A4.STATIC&&(this.body.isSleeping()||(oa.copy(T7,this.body.position),pa.copy(E7,this.body.quaternion),this.node.worldPosition=T7,this.node.worldRotation=E7))}},{key:"syncInitial",value:function(){oa.copy(this.body.position,this.node.worldPosition),pa.copy(this.body.quaternion,this.node.worldRotation),this.body.aabbNeedsUpdate=!0;for(var e=0;e<this.shapes.length;e++)this.shapes[e].setScale(this.node.worldScale);r3(this.body),this.body.isSleeping()&&this.body.wakeUp()}},{key:"destroy",value:function(){this.body.removeEventListener("cc-collide",this.onCollidedListener),e.sharedBodesMap.delete(this.node.uuid),delete O4.World.idToBodyMap[this.body.id],this.node=null,this.wrappedWorld=null,this.body=null,this.shapes=null,this.onCollidedListener=null}},{key:"onCollided",value:function(e){A7.type=e.event;var t=t3(e.selfShape),i=t3(e.otherShape);if(t&&t.collider.needCollisionEvent){b7.push.apply(b7,A7.contacts),A7.contacts.length=0,A7.impl=e,A7.selfCollider=t.collider,A7.otherCollider=i?i.collider:null;var n=0;for(n=0;n<e.contacts.length;n++){var r=e.contacts[n];if(b7.length>0){var a=b7.pop();a.impl=r,A7.contacts.push(a)}else{var o=new S7(A7);o.impl=r,A7.contacts.push(o)}}for(n=0;n<this.shapes.length;n++){this.shapes[n].collider.emit(A7.type,A7)}}}}]),e}();C7.sharedBodesMap=new Map;var w7=function(){function e(){i(this,e),this.bodies=[],this.constraints=[],this._world=void 0,this._raycastResult=new O4.RaycastResult,this._world=new O4.World,this._world.broadphase=new O4.NaiveBroadphase,this._world.solver.iterations=10,this._world.solver.tolerance=1e-4,this._world.defaultContactMaterial.contactEquationStiffness=1e6,this._world.defaultContactMaterial.frictionEquationStiffness=1e6,this._world.defaultContactMaterial.contactEquationRelaxation=3,this._world.defaultContactMaterial.frictionEquationRelaxation=3}return r(e,[{key:"setDefaultMaterial",value:function(e){this._world.defaultMaterial.friction=e.friction,this._world.defaultMaterial.restitution=e.restitution,null!=i5.idToMaterial[e._uuid]&&(i5.idToMaterial[e._uuid]=this._world.defaultMaterial)}},{key:"setAllowSleep",value:function(e){this._world.allowSleep=e}},{key:"setGravity",value:function(e){oa.copy(this._world.gravity,e)}},{key:"impl",get:function(){return this._world}}]),r(e,[{key:"emitEvents",value:function(){this._world.emitTriggeredEvents(),this._world.emitCollisionEvents()}},{key:"syncSceneToPhysics",value:function(){for(var e=0;e<this.bodies.length;e++)this.bodies[e].syncSceneToPhysics()}},{key:"step",value:function(e,t,i){if(0!=this.bodies.length){this._world.step(e,t,i);for(var n=0;n<this.bodies.length;n++)this.bodies[n].syncPhysicsToScene()}}},{key:"raycastClosest",value:function(e,t,i){O7(e,t.maxDistance),i3(M7,t);var n=this._world.raycastClosest(R7,I7,M7,this._raycastResult);return n&&n3(i,this._raycastResult),n}},{key:"raycast",value:function(e,t,i,n){return O7(e,t.maxDistance),i3(M7,t),this._world.raycastAll(R7,I7,M7,(function(e){var t=i.add();n3(t,e),n.push(t)}))}},{key:"getSharedBody",value:function(e){return C7.getSharedBody(e,this)}},{key:"addSharedBody",value:function(e){this.bodies.indexOf(e)<0&&(this.bodies.push(e),this._world.addBody(e.body))}},{key:"removeSharedBody",value:function(e){var t=this.bodies.indexOf(e);t>=0&&(this.bodies.splice(t,1),this._world.remove(e.body))}},{key:"addConstraint",value:function(e){this.constraints.indexOf(e)<0&&(this.constraints.push(e),this._world.addConstraint(e.impl))}},{key:"removeConstraint",value:function(e){var t=this.constraints.indexOf(e);t>=0&&(this.constraints.splice(t,1),this._world.removeConstraint(e.impl))}},{key:"updateCollisionMatrix",value:function(e,t){for(var i=0;i<this.bodies.length;i++){var n=this.bodies[i].body;n.collisionFilterGroup==e&&(n.collisionFilterMask=t)}}}]),e}(),R7=new O4.Vec3,I7=new O4.Vec3;function O7(e,t){oa.copy(R7,e.o),e.computeHit(I7,t)}var M7={checkCollisionResponse:!1,collisionFilterGroup:-1,collisionFilterMask:-1,skipBackFaces:!0},P7=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this))).HALF_EXTENT=void 0,e.HALF_EXTENT=new O4.Vec3(.5,.5,.5),e._shape=new O4.Box(e.HALF_EXTENT.clone()),e}return o(t,e),r(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),r(t,[{key:"setSize",value:function(e){oa.multiplyScalar(this.HALF_EXTENT,e,.5);var t=this.collider.node.worldScale;this.impl.halfExtents.x=this.HALF_EXTENT.x*Math.abs(t.x),this.impl.halfExtents.y=this.HALF_EXTENT.y*Math.abs(t.y),this.impl.halfExtents.z=this.HALF_EXTENT.z*Math.abs(t.z),this.impl.updateConvexPolyhedronRepresentation(),-1!=this._index&&r3(this._body)}},{key:"onLoad",value:function(){_(s(t.prototype),"onLoad",this).call(this),this.setSize(this.collider.size)}},{key:"setScale",value:function(e){_(s(t.prototype),"setScale",this).call(this,e),this.setSize(this.collider.size)}}]),t}(i5),k7=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5;return i(this,t),(e=u(this,s(t).call(this)))._shape=new O4.Sphere(n),e}return o(t,e),r(t,[{key:"setRadius",value:function(e){var t=function(e){return Math.max(e.x,Math.max(e.y,e.z))}(this.collider.node.worldScale);this.impl.radius=e*Math.abs(t),this.impl.updateBoundingSphereRadius(),-1!=this._index&&r3(this._body)}},{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),r(t,[{key:"onLoad",value:function(){_(s(t.prototype),"onLoad",this).call(this),this.setRadius(this.collider.radius)}},{key:"setScale",value:function(e){_(s(t.prototype),"setScale",this).call(this,e),this.setRadius(this.collider.radius)}}]),t}(i5),D7=new O4.Vec3,B7=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"setMesh",value:function(e){if(this._isBinding){var t=e;if(null!=this._shape)if(t&&t.renderingSubMeshes.length>0){var i=t.renderingSubMeshes[0].geometricInfo.positions,n=t.renderingSubMeshes[0].geometricInfo.indices;this.updateProperties(i,n)}else this.updateProperties(new Float32Array,new Uint16Array);else if(t&&t.renderingSubMeshes.length>0){var r=t.renderingSubMeshes[0].geometricInfo.positions,a=t.renderingSubMeshes[0].geometricInfo.indices;this._shape=new O4.Trimesh(r,a)}else this._shape=new O4.Trimesh(new Float32Array,new Uint16Array)}}},{key:"onComponentSet",value:function(){this.setMesh(this.collider.mesh)}},{key:"onLoad",value:function(){_(s(t.prototype),"onLoad",this).call(this),this.setMesh(this.collider.mesh)}},{key:"setScale",value:function(e){_(s(t.prototype),"setScale",this).call(this,e),oa.copy(D7,e),this.impl.setScale(D7)}},{key:"updateProperties",value:function(e,t){this.impl.vertices=new Float32Array(e),this.impl.indices=new Int16Array(t),this.impl.normals=new Float32Array(t.length),this.impl.aabb=new O4.AABB,this.impl.edges=[],this.impl.tree=new O4.Octree(new O4.AABB),this.impl.updateEdges(),this.impl.updateNormals(),this.impl.updateAABB(),this.impl.updateBoundingSphereRadius(),this.impl.updateTree(),this.impl.setScale(this.impl.scale),this._index>=0&&r3(this._body)}},{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(i5),L7=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:C4.Y_AXIS;return i(this,t),(e=u(this,s(t).call(this)))._shape=new O4.Cylinder(n,n,r,O4.CC_CONFIG.numSegmentsCylinder,a==C4.Y_AXIS),e}return o(t,e),r(t,[{key:"setRadius",value:function(e){this.updateProperties(this.collider.radius,this.collider.height,O4.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!=this._index&&r3(this._body)}},{key:"setHeight",value:function(e){this.updateProperties(this.collider.radius,this.collider.height,O4.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!=this._index&&r3(this._body)}},{key:"setDirection",value:function(e){this.updateProperties(this.collider.radius,this.collider.height,O4.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!=this._index&&r3(this._body)}},{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),r(t,[{key:"onLoad",value:function(){_(s(t.prototype),"onLoad",this).call(this),this.setRadius(this.collider.radius)}},{key:"setScale",value:function(e){_(s(t.prototype),"setScale",this).call(this,e),this.setRadius(this.collider.radius)}},{key:"updateProperties",value:function(e,t,i,n,r){var a=t,o=e,s=Math.cos,l=Math.sin,c=Math.abs,u=Math.max;1==n?(a=c(r.y)*t,o=u(c(r.x),c(r.z))*e):2==n?(a=c(r.z)*t,o=u(c(r.x),c(r.y))*e):(a=c(r.x)*t,o=u(c(r.y),c(r.z))*e);var h=i,_=a/2,d=[],f=[],p=[],m=2*Math.PI/h;if(1==n){for(var v=[1],g=[0],y=0;y<h;y++){var x=o*s(m*y),S=o*l(m*y);d.push(new O4.Vec3(x,_,S)),d.push(new O4.Vec3(x,-_,S)),y<h-1?(f.push([2*y+2,2*y+3,2*y+1,2*y]),g.push(2*y+2),v.push(2*y+3)):f.push([0,1,2*y+1,2*y]),(h%2==1||y<h/2)&&p.push(new O4.Vec3(s(m*(y+.5)),0,l(m*(y+.5))))}f.push(v);var T=[];for(y=0;y<g.length;y++)T.push(g[g.length-y-1]);f.push(T),p.push(new O4.Vec3(0,1,0))}else if(2==n){var E=[0],b=[1];for(y=0;y<h;y++){var A=o*s(m*y),C=o*l(m*y);d.push(new O4.Vec3(A,C,_)),d.push(new O4.Vec3(A,C,-_)),y<h-1?(f.push([2*y,2*y+1,2*y+3,2*y+2]),E.push(2*y+2),b.push(2*y+3)):f.push([2*y,2*y+1,0,1]),(h%2==1||y<h/2)&&p.push(new O4.Vec3(s(m*(y+.5)),l(m*(y+.5)),0))}f.push(E);for(T=[],y=0;y<b.length;y++)T.push(b[b.length-y-1]);f.push(T),p.push(new O4.Vec3(0,0,1))}else{var w=[0],R=[1];for(y=0;y<h;y++){var I=o*s(m*y),O=o*l(m*y);d.push(new O4.Vec3(_,I,O)),d.push(new O4.Vec3(-_,I,O)),y<h-1?(f.push([2*y,2*y+1,2*y+3,2*y+2]),w.push(2*y+2),R.push(2*y+3)):f.push([2*y,2*y+1,0,1]),(h%2==1||y<h/2)&&p.push(new O4.Vec3(0,s(m*(y+.5)),l(m*(y+.5))))}f.push(w);for(T=[],y=0;y<R.length;y++)T.push(R[R.length-y-1]);f.push(T),p.push(new O4.Vec3(1,0,0))}this.impl.vertices=d,this.impl.faces=f,this.impl.uniqueAxes=p,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()}}]),t}(i5),N7=new oa,F7=new oa,z7=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:C4.Y_AXIS;return i(this,t),(e=u(this,s(t).call(this)))._shape=new O4.Cylinder(0,n,r,O4.CC_CONFIG.numSegmentsCone,a==C4.Y_AXIS),e}return o(t,e),r(t,[{key:"setRadius",value:function(e){this.updateProperties(this.collider.radius,this.collider.height,O4.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!=this._index&&r3(this._body)}},{key:"setHeight",value:function(e){this.updateProperties(this.collider.radius,this.collider.height,O4.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!=this._index&&r3(this._body)}},{key:"setDirection",value:function(e){this.updateProperties(this.collider.radius,this.collider.height,O4.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!=this._index&&r3(this._body)}},{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),r(t,[{key:"onLoad",value:function(){_(s(t.prototype),"onLoad",this).call(this),this.setRadius(this.collider.radius)}},{key:"setScale",value:function(e){_(s(t.prototype),"setScale",this).call(this,e),this.setRadius(this.collider.radius)}},{key:"updateProperties",value:function(e,t,i,n,r){var a=t,o=e,s=Math.cos,l=Math.sin,c=Math.abs,u=Math.max;1==n?(a=c(r.y)*t,o=u(c(r.x),c(r.z))*e):2==n?(a=c(r.z)*t,o=u(c(r.x),c(r.y))*e):(a=c(r.x)*t,o=u(c(r.y),c(r.z))*e);var h=i,_=a/2,d=[],f=[],p=[],m=2*Math.PI/h;if(1==n){var v=[];f.push(v),d.push(new O4.Vec3(0,_,0));for(var g=0;g<h;g++){var y=o*s(m*g),x=o*l(m*g);d.push(new O4.Vec3(y,-_,x))}for(g=0;g<h;g++){0!=g&&v.push(g),w=g<h-1?[0,g+2,g+1]:[0,1,g+1],f.push(w),oa.subtract(N7,d[0],d[w[1]]),oa.subtract(F7,d[w[2]],d[w[1]]),oa.cross(N7,F7,N7),N7.normalize(),p.push(new O4.Vec3(N7.x,N7.y,N7.z))}p.push(new O4.Vec3(0,-1,0))}else if(2==n){var S=[];f.push(S),d.push(new O4.Vec3(0,0,_));for(g=0;g<h;g++){var T=o*s(m*g),E=o*l(m*g);d.push(new O4.Vec3(T,E,-_))}for(g=0;g<h;g++){0!=g&&S.push(h-g),w=g<h-1?[0,g+1,g+2]:[0,g+1,1],f.push(w),oa.subtract(N7,d[0],d[w[1]]),oa.subtract(F7,d[w[2]],d[w[1]]),oa.cross(N7,N7,F7),N7.normalize(),p.push(new O4.Vec3(N7.x,N7.y,N7.z))}p.push(new O4.Vec3(0,0,-1))}else{var b=[];f.push(b),d.push(new O4.Vec3(_,0,0));for(g=0;g<h;g++){var A=o*s(m*g),C=o*l(m*g);d.push(new O4.Vec3(-_,A,C))}for(g=0;g<h;g++){var w;0!=g&&b.push(h-g),w=g<h-1?[0,g+1,g+2]:[0,g+1,1],f.push(w),oa.subtract(N7,d[0],d[w[1]]),oa.subtract(F7,d[w[2]],d[w[1]]),oa.cross(N7,N7,F7),N7.normalize(),p.push(new O4.Vec3(N7.x,N7.y,N7.z))}p.push(new O4.Vec3(-1,0,0))}this.impl.vertices=d,this.impl.faces=f,this.impl.uniqueAxes=p,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()}}]),t}(i5),U7=new O4.AABB,G7=new O4.AABB,H7=new O4.Transform;O4.Heightfield.prototype.calculateWorldAABB=function(e,t,i,n){var r=H7,a=G7;oa.copy(r.position,e),pa.copy(r.quaternion,t);var o=this.elementSize,s=this.data;U7.lowerBound.set(0,0,this.minValue),U7.upperBound.set((s.length-1)*o,(s[0].length-1)*o,this.maxValue),U7.toWorldFrame(r,a),i.copy(a.lowerBound),n.copy(a.upperBound)};var V7,W7=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this))).DATA=void 0,e.OPTIONS=void 0,e._terrainID=void 0,e.DATA=[[]],e.OPTIONS={elementSize:0},e._terrainID="",e}return o(t,e),r(t,[{key:"setTerrain",value:function(e){if(e){if(this._terrainID!=e._uuid){var t=e,i=t.getVertexCountI(),n=t.getVertexCountJ();this._terrainID=t._uuid,this.DATA.length=i-1;for(var r=0;r<i;r++){null==this.DATA[r]&&(this.DATA[r]=[]),this.DATA[r].length=n-1;for(var a=0;a<n;a++)this.DATA[r][a]=t.getHeight(r,n-1-a)}this.OPTIONS.elementSize=t.tileSize,this.updateProperties(this.DATA,this.OPTIONS.elementSize)}}else""!=this._terrainID&&(this._terrainID="",this.DATA.length=1,this.DATA[0]=this.DATA[0]||[],this.DATA[0].length=0,this.OPTIONS.elementSize=0,this.updateProperties(this.DATA,this.OPTIONS.elementSize))}},{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),r(t,[{key:"onComponentSet",value:function(){var e=this.collider.terrain;if(e){for(var t=e.getVertexCountI(),i=e.getVertexCountJ(),n=0;n<t;n++){null==this.DATA[n]&&(this.DATA[n]=[]);for(var r=0;r<i;r++)this.DATA[n][r]=e.getHeight(n,i-1-r)}this.OPTIONS.elementSize=e.tileSize,this._terrainID=e._uuid}this._shape=new O4.Heightfield(this.DATA,this.OPTIONS)}},{key:"onLoad",value:function(){_(s(t.prototype),"onLoad",this).call(this),this.setTerrain(this.collider.terrain)}},{key:"updateProperties",value:function(e,t){var i=this.impl;i.data=e,i.elementSize=t,i.updateMinValue(),i.updateMaxValue(),i.updateBoundingSphereRadius(),i.update(),this._index>=0&&r3(this._body)}},{key:"_setCenter",value:function(e){var t=this.collider.terrain;if(t){pa.fromEuler(this._orient,-90,0,0);var i=this._offset;oa.set(i,0,0,(t.getVertexCountJ()-1)*t.tileSize),oa.add(i,i,e),oa.multiply(i,i,this._collider.node.worldScale)}}}]),t}(i5),j7=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).VERTICES=[],n}return o(t,e),r(t,[{key:"setShapeType",value:function(e){this._isBinding}},{key:"setVertices",value:function(e){var t=this.VERTICES.length;if(4==t){for(var i=this._collider.node.worldScale,n=0;n<t;n++)oa.multiply(this.VERTICES[n],i,e[n]);var r=this.impl;r.computeNormals(),r.computeEdges(),r.updateBoundingSphereRadius()}-1!=this._index&&r3(this._body)}},{key:"onComponentSet",value:function(){var e=this.collider.shapeType;if(e==W6.ESimplexType.TETRAHEDRON){for(var t=0;t<4;t++)this.VERTICES[t]=new O4.Vec3(0,0,0);this._shape=q7(this.VERTICES)}else W6.ESimplexType.VERTEX,this._shape=new O4.Particle}},{key:"onLoad",value:function(){_(s(t.prototype),"onLoad",this).call(this),this.collider.updateVertices()}},{key:"setScale",value:function(e){_(s(t.prototype),"setScale",this).call(this,e),this.collider.updateVertices()}},{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(i5),q7=(V7=[[0,3,2],[0,1,3],[0,2,1],[1,2,3]],function(e){return new O4.ConvexPolyhedron(e,V7)}),X7=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this)))._shape=new O4.Plane,e}return o(t,e),r(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),r(t,[{key:"setNormal",value:function(e){pa.rotationTo(this._orient,oa.UNIT_Z,e),-1!=this._index&&r3(this._body)}},{key:"setConstant",value:function(e){oa.scaleAndAdd(this._offset,this._collider.center,this.collider.normal,e)}},{key:"onLoad",value:function(){_(s(t.prototype),"onLoad",this).call(this),this.setConstant(this.collider.constant),this.setNormal(this.collider.normal)}},{key:"_setCenter",value:function(e){_(s(t.prototype),"_setCenter",this).call(this,e),this.setConstant(this.collider.constant)}}]),t}(i5);O4.World.staticBody=new O4.Body,O4.World.idToConstraintMap={};var Y7,K7,Z7=function(){function e(){i(this,e),this._rigidBody=null}return r(e,[{key:"setConnectedBody",value:function(e){this._impl.bodyB=e?e.body.impl:O4.World.staticBody}},{key:"setEnableCollision",value:function(e){this._impl.collideConnected=e}},{key:"initialize",value:function(e){this._com=e,this._rigidBody=e.attachedBody,this.onComponentSet(),this.setEnableCollision(e.enableCollision),O4.World.idToConstraintMap[this._impl.id]=this._impl}},{key:"onComponentSet",value:function(){}},{key:"onLoad",value:function(){}},{key:"onEnable",value:function(){this._rigidBody&&this._rigidBody.body.sharedBody.wrappedWorld.addConstraint(this)}},{key:"onDisable",value:function(){this._rigidBody&&this._rigidBody.body.sharedBody.wrappedWorld.removeConstraint(this)}},{key:"onDestroy",value:function(){delete O4.World.idToConstraintMap[this._impl.id],this._com=null,this._rigidBody=null,this._impl=null}},{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),e}(),Q7=new oa,J7=new oa,$7=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"setPivotA",value:function(e){oa.multiply(Q7,e,this._com.node.worldScale),oa.copy(this.impl.pivotA,Q7)}},{key:"setPivotB",value:function(e){oa.copy(Q7,e);var t=this.constraint.connectedBody;t?oa.multiply(Q7,Q7,t.node.worldScale):(oa.add(Q7,Q7,this._com.node.worldPosition),oa.multiply(J7,this.constraint.pivotA,this._com.node.worldScale),oa.add(Q7,Q7,J7)),oa.copy(this.impl.pivotB,Q7)}},{key:"onComponentSet",value:function(){if(this._rigidBody){var e=this._rigidBody.body.impl,t=this.constraint.connectedBody,i=O4.World.staticBody;t&&(i=t.body.impl),this._impl=new O4.PointToPointConstraint(e,null,i),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)}}},{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(Z7),e9=new oa,t9=new oa,i9=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"setPivotA",value:function(e){oa.multiply(e9,e,this._com.node.worldScale),oa.copy(this.impl.pivotA,e9)}},{key:"setPivotB",value:function(e){oa.copy(e9,e);var t=this.constraint.connectedBody;t?oa.multiply(e9,e9,t.node.worldScale):(oa.add(e9,e9,this._com.node.worldPosition),oa.multiply(t9,this.constraint.pivotA,this._com.node.worldScale),oa.add(e9,e9,t9)),oa.copy(this.impl.pivotB,e9)}},{key:"setAxisA",value:function(e){oa.copy(this.impl.axisA,e),oa.copy(this.impl.equations[3].axisA,e),oa.copy(this.impl.equations[4].axisA,e)}},{key:"setAxisB",value:function(e){oa.copy(this.impl.axisB,e),oa.copy(this.impl.equations[3].axisB,e),oa.copy(this.impl.equations[4].axisB,e)}},{key:"onComponentSet",value:function(){if(this._rigidBody){var e=this._rigidBody.body.impl,t=this.constraint.connectedBody,i=O4.World.staticBody;t&&(i=t.body.impl),this._impl=new O4.HingeConstraint(e,i),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.setAxisA(this.constraint.axisA),this.setAxisB(this.constraint.axisB)}}},{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(Z7);ka(S7.prototype,"IContactEquation.prototype",[{name:"contactA",newName:"getLocalPointOnA",customGetter:function(){var e=new oa;return S7.prototype.getLocalPointOnA.call(this,e),e}},{name:"contactB",newName:"getLocalPointOnB",customGetter:function(){var e=new oa;return S7.prototype.getLocalPointOnB.call(this,e),e}},{name:"normal",newName:"getLocalNormalOnB",customGetter:function(){var e=new oa;return S7.prototype.getLocalNormalOnB.call(this,e),e}}]),K7={PhysicsWorld:w7,RigidBody:$4,BoxShape:P7,SphereShape:k7,TrimeshShape:B7,CylinderShape:L7,ConeShape:z7,TerrainShape:W7,SimplexShape:j7,PlaneShape:X7,PointToPointConstraint:$7,HingeConstraint:i9},b4=Y7="cannon.js",E._global.CC_PHYSICS_BUILTIN="builtin"==Y7,E._global.CC_PHYSICS_CANNON="cannon.js"==Y7,E._global.CC_PHYSICS_AMMO="ammo.js"==Y7,E4=K7,window&&(window.CANNON=O4),O4.CC_CONFIG={numSegmentsCone:12,numSegmentsCylinder:12,ignoreSelfBody:!0},O4.ArrayCollisionMatrix.prototype.reset=function(){for(var e in this.matrix)delete this.matrix[e]};e("HeightField",function(){function e(t,n){i(this,e),this.data=new Uint16Array,this.w=0,this.h=0,this.w=t,this.h=n,this.data=new Uint16Array(t*n);for(var r=0;r<t*n;++r)this.data[r]=0}return r(e,[{key:"set",value:function(e,t,i){this.data[t*this.w+e]=i}},{key:"get",value:function(e,t){return this.data[t*this.w+e]}},{key:"getClamp",value:function(e,t){return e=vn(e,0,this.w-1),t=vn(t,0,this.h-1),this.get(e,t)}},{key:"getAt",value:function(e,t){var i=e,n=t,r=Math.floor(i),a=Math.floor(n),o=r+1,s=a+1,l=i-r,c=n-a;r=vn(r,0,this.w-1),a=vn(a,0,this.h-1),o=vn(o,0,this.w-1),s=vn(s,0,this.h-1);var u=this.get(r,a),h=this.get(o,a),_=this.get(r,s),d=this.get(o,s),f=.5*(h+_);return l+c<=1?d=f+(f-u):u=f+(f-d),(u*(1-l)+h*l)*(1-c)+(_*(1-l)+d*l)*c}}]),e}());var n9,r9,a9,o9,s9,l9,c9,u9,h9,_9,d9,f9,p9,m9,v9,g9,y9,x9,S9,T9,E9,b9,A9,C9,w9,R9,I9,O9,M9,P9,k9,D9,B9,L9,N9,F9,z9,U9,G9=e("TerrainInfo",ii("cc.TerrainInfo")((a9=S((r9=function(){function e(){i(this,e),x(this,"tileSize",a9,this),x(this,"blockCount",o9,this),x(this,"weightMapSize",s9,this),x(this,"lightMapSize",l9,this)}return r(e,[{key:"size",get:function(){var e=new wa(0,0);return e.width=this.blockCount[0]*O6*this.tileSize,e.height=this.blockCount[1]*O6*this.tileSize,e}},{key:"tileCount",get:function(){var e=[0,0];return e[0]=this.blockCount[0]*O6,e[1]=this.blockCount[1]*O6,e}},{key:"vertexCount",get:function(){var e=this.tileCount;return e[0]+=1,e[1]+=1,e}}]),e}()).prototype,"tileSize",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),o9=S(r9.prototype,"blockCount",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),s9=S(r9.prototype,"weightMapSize",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),l9=S(r9.prototype,"lightMapSize",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),n9=r9))||n9),H9=e("TerrainLayer",ii("cc.TerrainLayer")((h9=S((u9=function e(){i(this,e),x(this,"detailMap",h9,this),x(this,"tileSize",_9,this)}).prototype,"detailMap",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_9=S(u9.prototype,"tileSize",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c9=u9))||c9),V9=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._model=null,n._meshData=null,n._brushMaterial=null,n._currentMaterial=null,n._currentMaterialLayers=0,n}return o(t,e),r(t,[{key:"destroy",value:function(){return null!=this._model&&(E.director.root.destroyModel(this._model),this._model=null),_(s(t.prototype),"destroy",this).call(this)}},{key:"_invalidMaterial",value:function(){null!=this._currentMaterial&&(this._clearMaterials(),this._currentMaterial=null,null!=this._model&&(this._model.enabled=!1))}},{key:"_updateMaterial",value:function(e,t){if(null!=this._meshData&&null!=this._model){var i=e.getMaxLayer();if(null==this._currentMaterial||i!==this._currentMaterialLayers){if(this._currentMaterial=new sm,this._currentMaterial.initialize({effectAsset:e.getTerrain().getEffectAsset(),defines:e._getMaterialDefines(i)}),null!==this._brushMaterial)this._currentMaterial.passes.push(this._brushMaterial.passes[0]);t&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=i,this._model.enabled=!0}}}},{key:"_onMaterialModified",value:function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())}},{key:"_onRebuildPSO",value:function(e,t){this._model&&this._model.setSubModelMaterial(e,t)}},{key:"_clearMaterials",value:function(){null!=this._model&&this._onMaterialModified(0,null)}},{key:"_getBuiltinMaterial",value:function(){return tf.get("missing-material")}}]),t}(AC),W9=e("TerrainBlockInfo",ii("cc.TerrainBlockInfo")((p9=S((f9=function e(){i(this,e),x(this,"layers",p9,this)}).prototype,"layers",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[-1,-1,-1,-1]}}),d9=f9))||d9),j9=e("TerrainBlockLightmapInfo",ii("cc.TerrainBlockLightmapInfo")((g9=S((v9=function e(){i(this,e),x(this,"texture",g9,this),x(this,"UOff",y9,this),x(this,"VOff",x9,this),x(this,"UScale",S9,this),x(this,"VScale",T9,this)}).prototype,"texture",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y9=S(v9.prototype,"UOff",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x9=S(v9.prototype,"VOff",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S9=S(v9.prototype,"UScale",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T9=S(v9.prototype,"VScale",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m9=v9))||m9),q9=e("TerrainBlock",function(){function e(t,n,r){i(this,e),this._terrain=void 0,this._info=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._lightmapInfo=null,this._terrain=t,this._info=t.getBlockInfo(n,r),this._index[0]=n,this._index[1]=r,this._lightmapInfo=t._getLightmapInfo(n,r),this._node=new Zk(""),this._node.setParent(this._terrain.node),this._node._objFlags|=E.Object.Flags.DontSave,this._renderable=this._node.addComponent(V9)}return r(e,[{key:"build",value:function(){for(var e=AB.root.device,t=new Float32Array(P6*M6*M6),i=0,n=0;n<M6;++n)for(var r=0;r<M6;++r){var a=this._index[0]*O6+r,o=this._index[1]*O6+n,s=this._terrain.getPosition(a,o),l=this._terrain.getNormal(a,o),c=new ia(r/O6,n/O6);t[i++]=s.x,t[i++]=s.y,t[i++]=s.z,t[i++]=l.x,t[i++]=l.y,t[i++]=l.z,t[i++]=c.x,t[i++]=c.y}var u=e.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,P6*Float32Array.BYTES_PER_ELEMENT*M6*M6,P6*Float32Array.BYTES_PER_ELEMENT));u.update(t);var h=[new al(Vo.ATTR_POSITION,jo.RGB32F),new al(Vo.ATTR_NORMAL,jo.RGB32F),new al(Vo.ATTR_TEX_COORD,jo.RG32F)];this._renderable._meshData=new K_([u],h,Zo.TRIANGLE_LIST,this._terrain._getSharedIndexBuffer());var _=this._renderable._model=E.director.root.createModel(zb);_.node=_.transform=this._node,this._renderable._getRenderScene().addModel(_),this._updateWeightMap(),this._updateMaterial(!0)}},{key:"rebuild",value:function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)}},{key:"destroy",value:function(){null!=this._renderable&&this._renderable.destroy(),null!=this._node&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()}},{key:"update",value:function(){this._updateMaterial(!1);var e=this._renderable._currentMaterial;if(null!=e){var t=this.getMaxLayer(),i=new ua(1,1,1,1);if(0===t)if(-1!==this.layers[0]){var n=this._terrain.getLayer(this.layers[0]);null!=n&&(i.x=1/n.tileSize),e.setProperty("detailMap0",null!=n?n.detailMap:null)}else e.setProperty("detailMap0",E.builtinResMgr.get("default-texture"));else if(1===t){var r=this._terrain.getLayer(this.layers[0]),a=this._terrain.getLayer(this.layers[1]);null!=r&&(i.x=1/r.tileSize),null!=a&&(i.y=1/a.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=r?r.detailMap:null),e.setProperty("detailMap1",null!=a?a.detailMap:null)}else if(2===t){var o=this._terrain.getLayer(this.layers[0]),s=this._terrain.getLayer(this.layers[1]),l=this._terrain.getLayer(this.layers[2]);null!=o&&(i.x=1/o.tileSize),null!=s&&(i.y=1/s.tileSize),null!=l&&(i.z=1/l.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=o?o.detailMap:null),e.setProperty("detailMap1",null!=s?s.detailMap:null),e.setProperty("detailMap2",null!=l?l.detailMap:null)}else if(3===t){var c=this._terrain.getLayer(this.layers[0]),u=this._terrain.getLayer(this.layers[1]),h=this._terrain.getLayer(this.layers[2]),_=this._terrain.getLayer(this.layers[3]);null!=c&&(i.x=1/c.tileSize),null!=u&&(i.y=1/u.tileSize),null!=h&&(i.z=1/h.tileSize),null!=_&&(i.z=1/_.tileSize),e.setProperty("weightMap",this._weightMap),e.setProperty("detailMap0",null!=c?c.detailMap:null),e.setProperty("detailMap1",null!=u?u.detailMap:null),e.setProperty("detailMap2",null!=h?h.detailMap:null),e.setProperty("detailMap3",null!=_?_.detailMap:null)}e.setProperty("UVScale",i),null!=this.lightmap&&(e.setProperty("lightMap",this.lightmap),e.setProperty("lightMapUVParam",this.lightmapUVParam))}}},{key:"setBrushMaterial",value:function(e){this._renderable._brushMaterial!==e&&(this._renderable._brushMaterial=e,this._renderable._invalidMaterial())}},{key:"getTerrain",value:function(){return this._terrain}},{key:"getIndex",value:function(){return this._index}},{key:"getRect",value:function(){var e=new Ia;return e.x=this._index[0]*O6,e.y=this._index[1]*O6,e.width=O6,e.height=O6,e}},{key:"setLayer",value:function(e,t){this.layers[e]!==t&&(this.layers[e]=t,this._renderable._invalidMaterial(),this._updateMaterial(!1))}},{key:"getLayer",value:function(e){return this.layers[e]}},{key:"getMaxLayer",value:function(){return this.layers[3]>=0?3:this.layers[2]>=0?2:this.layers[1]>=0?1:0}},{key:"_getMaterialDefines",value:function(e){if(null!=this.lightmap){if(0===e)return{LAYERS:1,LIGHT_MAP:1};if(1===e)return{LAYERS:2,LIGHT_MAP:1};if(2===e)return{LAYERS:3,LIGHT_MAP:1};if(3===e)return{LAYERS:4,LIGHT_MAP:1}}else{if(0===e)return{LAYERS:1};if(1===e)return{LAYERS:2};if(2===e)return{LAYERS:3};if(3===e)return{LAYERS:4}}return{LAYERS:0}}},{key:"_invalidMaterial",value:function(){this._renderable._invalidMaterial()}},{key:"_updateMaterial",value:function(e){this._renderable._updateMaterial(this,e)}},{key:"_updateHeight",value:function(){if(null!=this._renderable._meshData){for(var e=new Float32Array(P6*M6*M6),t=0,i=0;i<M6;++i)for(var n=0;n<M6;++n){var r=this._index[0]*O6+n,a=this._index[1]*O6+i,o=this._terrain.getPosition(r,a),s=this._terrain.getNormal(r,a),l=new ia(n/M6,i/M6);e[t++]=o.x,e[t++]=o.y,e[t++]=o.z,e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,e[t++]=l.x,e[t++]=l.y}this._renderable._meshData.vertexBuffers[0].update(e)}}},{key:"_updateWeightMap",value:function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new Oh,this._weightMap.create(this._terrain.weightMapSize,this._terrain.weightMapSize,Wu.RGBA8888),this._weightMap.setFilters(qu.LINEAR,qu.LINEAR),this._weightMap.setWrapMode(ju.CLAMP_TO_EDGE,ju.CLAMP_TO_EDGE));for(var e=new Uint8Array(this._terrain.weightMapSize*this._terrain.weightMapSize*4),t=0,i=0;i<this._terrain.weightMapSize;++i)for(var n=0;n<this._terrain.weightMapSize;++n){var r=this._index[0]*this._terrain.weightMapSize+n,a=this._index[1]*this._terrain.weightMapSize+i,o=this._terrain.getWeight(r,a);e[4*t+0]=Math.floor(255*o.x),e[4*t+1]=Math.floor(255*o.y),e[4*t+2]=Math.floor(255*o.z),e[4*t+3]=Math.floor(255*o.w),t+=1}this._weightMap.uploadData(e)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)}},{key:"_updateLightmap",value:function(e){this._lightmapInfo=e,this._invalidMaterial()}},{key:"layers",get:function(){return this._info.layers}},{key:"lightmap",get:function(){return this._lightmapInfo?this._lightmapInfo.texture:null}},{key:"lightmapUVParam",get:function(){return null!=this._lightmapInfo?new ua(this._lightmapInfo.UOff,this._lightmapInfo.VOff,this._lightmapInfo.UScale,this._lightmapInfo.VScale):new ua(0,0,0,0)}}]),e}()),X9=(e("Terrain",(E9=ii("cc.Terrain"),b9=mi("i18n:cc.Terrain"),A9=Li(V6),C9=Li(qp),w9=gi(!1),R9=Li(H9),I9=Li(V6),O9=gi(!0),M9=Li(qp),P9=gi(!0),k9=Li(G9),E9(D9=b9(D9=hi(D9=ai((L9=S((B9=function(e){function t(){var e;i(this,t),x(e=u(this,s(t).call(this)),"__asset",L9,c(e)),x(e,"_effectAsset",N9,c(e)),x(e,"_layers",F9,c(e)),x(e,"_blockInfos",z9,c(e)),x(e,"_lightmapInfos",U9,c(e)),e._tileSize=1,e._blockCount=[1,1],e._weightMapSize=128,e._lightMapSize=128,e._heights=new Uint16Array,e._weights=new Uint8Array,e._normals=[],e._blocks=[],e._sharedIndexBuffer=null;for(var n=0;n<I6;++n)e._layers.push(null);return e}return o(t,e),r(t,[{key:"build",value:function(e){return this._tileSize=e.tileSize,this._blockCount[0]=e.blockCount[0],this._blockCount[1]=e.blockCount[1],this._weightMapSize=e.weightMapSize,this._lightMapSize=e.lightMapSize,this._buildImp()}},{key:"rebuild",value:function(e){for(var t=[],i=0;i<e.blockCount[0]*e.blockCount[1];++i)t.push(new W9);for(var n=Math.min(this._blockCount[0],e.blockCount[0]),r=Math.min(this._blockCount[1],e.blockCount[1]),a=0;a<r;++a)for(var o=0;o<n;++o){var s=a*e.blockCount[0]+o,l=a*this.blockCount[0]+o;t[s]=this._blockInfos[l]}this._blockInfos=t;for(var c,u=y(this._blocks);!(c=u()).done;){c.value.destroy()}this._blocks=[],this._rebuildHeights(e),this._rebuildWeights(e),this._tileSize=e.tileSize,this._blockCount[0]=e.blockCount[0],this._blockCount[1]=e.blockCount[1],this._weightMapSize=e.weightMapSize,this._lightMapSize=e.lightMapSize,this._buildNormals();for(var h=0;h<this._blockCount[1];++h)for(var _=0;_<this._blockCount[0];++_)this._blocks.push(new q9(this,_,h));for(var d,f=y(this._blocks);!(d=f()).done;){d.value.build()}}},{key:"importHeightField",value:function(e,t){for(var i=0,n=0;n<this.vertexCount[1];++n)for(var r=0;r<this.vertexCount[0];++r){var a=r/this.tileCount[0],o=n/this.tileCount[1],s=e.getAt(a*e.w,o*e.h)*t;this._heights[i++]=s}this._buildNormals();for(var l,c=y(this._blocks);!(l=c()).done;){l.value._updateHeight()}}},{key:"exportHeightField",value:function(e,t){for(var i=0,n=0;n<e.h;++n)for(var r=0;r<e.w;++r){var a=r/(e.w-1),o=n/(e.h-1),s=a*this.size.width,l=o*this.size.height,c=this.getHeightAt(s,l);null!=c&&(e.data[i++]=c*t)}}},{key:"exportAsset",value:function(){var e=new V6;e.tileSize=this.tileSize,e.blockCount=this.blockCount,e.lightMapSize=this.lightMapSize,e.weightMapSize=this.weightMapSize,e.heights=this.heights,e.weights=this.weights,e.layerBuffer=new Array(4*this._blocks.length);for(var t=0;t<this._blocks.length;++t)e.layerBuffer[4*t+0]=this._blocks[t].layers[0],e.layerBuffer[4*t+1]=this._blocks[t].layers[1],e.layerBuffer[4*t+2]=this._blocks[t].layers[2],e.layerBuffer[4*t+3]=this._blocks[t].layers[3];for(var i=0;i<this._layers.length;++i){var n=this._layers[i];if(n&&n.detailMap&&ji(n.detailMap)){var r=new H6;r.slot=i,r.tileSize=n.tileSize,r.detailMap=n.detailMap._uuid,e.layerInfos.push(r)}}return e}},{key:"getEffectAsset",value:function(){return null===this._effectAsset?E.EffectAsset.get("builtin-terrain"):this._effectAsset}},{key:"onLoad",value:function(){for(var e=E.director.root.device,t=new Uint16Array(O6*O6*6),i=0,n=0;n<O6;++n)for(var r=0;r<O6;++r){var a=n*M6+r,o=n*M6+r+1,s=(n+1)*M6+r,l=(n+1)*M6+r+1;t[i++]=a,t[i++]=s,t[i++]=o,t[i++]=o,t[i++]=s,t[i++]=l}this._sharedIndexBuffer=e.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.HOST|Xo.DEVICE,Uint16Array.BYTES_PER_ELEMENT*O6*O6*6,Uint16Array.BYTES_PER_ELEMENT)),this._sharedIndexBuffer.update(t)}},{key:"onEnable",value:function(){0===this._blocks.length&&this._buildImp()}},{key:"onDisable",value:function(){for(var e,t=y(this._blocks);!(e=t()).done;){e.value.destroy()}this._blocks=[]}},{key:"onDestroy",value:function(){for(var e=0;e<this._layers.length;++e)this._layers[e]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()}},{key:"onRestore",value:function(){this.onDisable(),this.onLoad(),this._buildImp(!0)}},{key:"update",value:function(e){for(var t,i=y(this._blocks);!(t=i()).done;){t.value.update()}}},{key:"addLayer",value:function(e){for(var t=0;t<this._layers.length;++t)if(null==this._layers[t])return this._layers[t]=e,t;return-1}},{key:"setLayer",value:function(e,t){this._layers[e]=t}},{key:"removeLayer",value:function(e){this._layers[e]=null}},{key:"getLayer",value:function(e){return-1===e?null:this._layers[e]}},{key:"getPosition",value:function(e,t){var i=e*this._tileSize,n=t*this._tileSize,r=this.getHeight(e,t);return new oa(i,r,n)}},{key:"getHeightField",value:function(){return this._heights}},{key:"setHeight",value:function(e,t,i){i=vn(i,B6,L6),this._heights[t*this.vertexCount[0]+e]=k6+i/D6}},{key:"getHeight",value:function(e,t){return(this._heights[t*this.vertexCount[0]+e]-k6)*D6}},{key:"getHeightClamp",value:function(e,t){return e=vn(e,0,this.vertexCount[0]-1),t=vn(t,0,this.vertexCount[1]-1),this.getHeight(e,t)}},{key:"getHeightAt",value:function(e,t){var i=e/this.tileSize,n=t/this.tileSize,r=Math.floor(i),a=Math.floor(n),o=r+1,s=a+1,l=i-r,c=n-a;if(r<0||r>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;r=vn(r,0,this.vertexCount[0]-1),a=vn(a,0,this.vertexCount[1]-1),o=vn(o,0,this.vertexCount[0]-1),s=vn(s,0,this.vertexCount[1]-1);var u=this.getHeight(r,a),h=this.getHeight(o,a),_=this.getHeight(r,s),d=this.getHeight(o,s),f=.5*(h+_);return l+c<=1?d=f+(f-u):u=f+(f-d),(u*(1-l)+h*l)*(1-c)+(_*(1-l)+d*l)*c}},{key:"_setNormal",value:function(e,t,i){var n=t*this.vertexCount[0]+e;this._normals[3*n+0]=i.x,this._normals[3*n+1]=i.y,this._normals[3*n+2]=i.z}},{key:"getNormal",value:function(e,t){var i=t*this.vertexCount[0]+e,n=new oa;return n.x=this._normals[3*i+0],n.y=this._normals[3*i+1],n.z=this._normals[3*i+2],n}},{key:"getNormalAt",value:function(e,t){var i=e/this.tileSize,n=t/this.tileSize,r=Math.floor(i),a=Math.floor(n),o=r+1,s=a+1,l=i-r,c=n-a;if(r<0||r>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;r=vn(r,0,this.vertexCount[0]-1),a=vn(a,0,this.vertexCount[1]-1),o=vn(o,0,this.vertexCount[0]-1),s=vn(s,0,this.vertexCount[1]-1);var u=this.getNormal(r,a),h=this.getNormal(o,a),_=this.getNormal(r,s),d=this.getNormal(o,s),f=new oa;oa.add(f,h,_).multiplyScalar(.5),l+c<=1?(d.set(f),d.subtract(u),d.add(f)):(u.set(f),u.subtract(d),u.add(f));var p=new oa,m=new oa,v=new oa;return oa.lerp(p,u,h,l),oa.lerp(m,_,d,l),oa.lerp(v,p,m,c),v}},{key:"setWeight",value:function(e,t,i){var n=t*this._weightMapSize*this._blockCount[0]+e;this._weights[4*n+0]=255*i.x,this._weights[4*n+1]=255*i.y,this._weights[4*n+2]=255*i.z,this._weights[4*n+3]=255*i.w}},{key:"getWeight",value:function(e,t){var i=t*this._weightMapSize*this._blockCount[0]+e,n=new ua;return n.x=this._weights[4*i+0]/255,n.y=this._weights[4*i+1]/255,n.z=this._weights[4*i+2]/255,n.w=this._weights[4*i+3]/255,n}},{key:"getWeightAt",value:function(e,t){var i=e/this.tileSize,n=t/this.tileSize,r=Math.floor(i),a=Math.floor(n),o=r+1,s=a+1,l=i-r,c=n-a;if(r<0||r>this.vertexCount[0]-1||a<0||a>this.vertexCount[1]-1)return null;r=vn(r,0,this.vertexCount[0]-1),a=vn(a,0,this.vertexCount[1]-1),o=vn(o,0,this.vertexCount[0]-1),s=vn(s,0,this.vertexCount[1]-1);var u=this.getWeight(r,a),h=this.getWeight(o,a),_=this.getWeight(r,s),d=this.getWeight(o,s),f=new ua;ua.add(f,h,_).multiplyScalar(.5),l+c<=1?(d=new ua,ua.subtract(d,f,u).add(f)):(u=new ua,ua.subtract(u,f,d).add(f));var p=new ua,m=new ua,v=new ua;return ua.lerp(p,u,h,l),ua.lerp(m,_,d,l),ua.lerp(v,p,m,c),v}},{key:"getBlockInfo",value:function(e,t){return this._blockInfos[t*this._blockCount[0]+e]}},{key:"getBlock",value:function(e,t){return this._blocks[t*this._blockCount[0]+e]}},{key:"getBlocks",value:function(){return this._blocks}},{key:"rayCheck",value:function(e,t,i){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=2e3,a=e;n&&oa.subtract(a,e,this.node.getWorldPosition());var o=new oa;o.set(t),o.multiplyScalar(i);var s=null;if(t.equals(new oa(0,1,0))){var l=this.getHeightAt(a.x,a.z);null!=l&&a.y<=l&&(s=new oa(a.x,l,a.z))}else if(t.equals(new oa(0,-1,0))){var c=this.getHeightAt(a.x,a.z);null!=c&&a.y>=c&&(s=new oa(a.x,c,a.z))}else{for(var u=0;u++<r;){var h=this.getHeightAt(a.x,a.z);if(null!=h&&a.y<=h)break;a.add(t)}for(;u++<r;){var _=this.getHeightAt(a.x,a.z);if(null!=_&&a.y<=_){s=new oa(a.x,_,a.z);break}a.add(o)}}return s}},{key:"_getSharedIndexBuffer",value:function(){return this._sharedIndexBuffer}},{key:"_resetLightmap",value:function(e){if(this._lightmapInfos.length=0,e)for(var t=0;t<this._blockCount[0]*this._blockCount[1];++t)this._lightmapInfos.push(new j9)}},{key:"_updateLightmap",value:function(e,t,i,n,r,a){this._lightmapInfos[e].texture=t,this._lightmapInfos[e].UOff=i,this._lightmapInfos[e].VOff=n,this._lightmapInfos[e].UScale=r,this._lightmapInfos[e].VScale=a,this._blocks[e]._updateLightmap(this._lightmapInfos[e])}},{key:"_getLightmapInfo",value:function(e,t){var i=t*this._blockCount[0]+e;return i<this._lightmapInfos.length?this._lightmapInfos[i]:null}},{key:"_calcNormal",value:function(e,t){var i,n,r=1,a=this.getPosition(e,t);e<this.vertexCount[0]-1?i=this.getPosition(e+1,t):(r*=-1,i=this.getPosition(e-1,t)),t<this.vertexCount[1]-1?n=this.getPosition(e,t+1):(r*=-1,n=this.getPosition(e,t-1)),i.subtract(a),n.subtract(a);var o=new oa;return o.set(n),o.cross(i),o.multiplyScalar(r),o.normalize(),o}},{key:"_buildNormals",value:function(){for(var e=0,t=0;t<this.vertexCount[1];++t)for(var i=0;i<this.vertexCount[0];++i){var n=this._calcNormal(i,t);this._normals[3*e+0]=n.x,this._normals[3*e+1]=n.y,this._normals[3*e+2]=n.z,e+=1}}},{key:"_buildImp",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.valid)return!0;if(!t&&null!=this.__asset){this._tileSize=this.__asset.tileSize,this._blockCount=this.__asset.blockCount,this._weightMapSize=this.__asset.weightMapSize,this._lightMapSize=this.__asset.lightMapSize,this._heights=this.__asset.heights,this._weights=this.__asset.weights;for(var i=!0,n=0;n<this._layers.length;++n)null!=this._layers[n]&&(i=!1);if(i&&null!=this._asset)for(var r,a=function(){var t=r.value,i=new H9;i.tileSize=t.tileSize,E.loader.loadRes(t.detailMap,Oh,(function(e,t){i.detailMap=t})),e._layers[t.slot]=i},o=y(this._asset.layerInfos);!(r=o()).done;)a()}if(0===this._blockCount[0]||0===this._blockCount[1])return!1;var s=this.vertexCount[0]*this.vertexCount[1];if(null===this._heights||this._heights.length!==s){this._heights=new Uint16Array(s),this._normals=new Array(3*s);for(var l=0;l<s;++l)this._heights[l]=k6,this._normals[3*l+0]=0,this._normals[3*l+1]=1,this._normals[3*l+2]=0}else this._normals=new Array(3*s),this._buildNormals();var c=this._weightMapSize*this._blockCount[0],u=this._weightMapSize*this._blockCount[1];if(this._weights.length!==c*u*4){this._weights=new Uint8Array(c*u*4);for(var h=0;h<c*u;++h)this._weights[4*h+0]=255,this._weights[4*h+1]=0,this._weights[4*h+2]=0,this._weights[4*h+3]=0}if(this._blockInfos.length!==this._blockCount[0]*this._blockCount[1]){this._blockInfos=[];for(var _=0;_<this._blockCount[1];++_)for(var d=0;d<this._blockCount[0];++d){var f=new W9;null!=this._asset&&(f.layers[0]=this._asset.getLayer(d,_,0),f.layers[1]=this._asset.getLayer(d,_,1),f.layers[1]===f.layers[0]&&(f.layers[1]=-1),f.layers[2]=this._asset.getLayer(d,_,2),f.layers[2]===f.layers[0]&&(f.layers[2]=-1),f.layers[3]=this._asset.getLayer(d,_,3),f.layers[3]===f.layers[0]&&(f.layers[3]=-1)),this._blockInfos.push(f)}}for(var p=0;p<this._blockCount[1];++p)for(var m=0;m<this._blockCount[0];++m)this._blocks.push(new q9(this,m,p));for(var v,g=y(this._blocks);!(v=g()).done;){var x=v.value;x.build()}}},{key:"_rebuildHeights",value:function(e){if(this.vertexCount[0]===e.vertexCount[0]&&this.vertexCount[1]===e.vertexCount[1])return!1;for(var t=new Uint16Array(e.vertexCount[0]*e.vertexCount[1]),i=0;i<t.length;++i)t[i]=k6;for(var n=Math.min(this.vertexCount[0],e.vertexCount[0]),r=Math.min(this.vertexCount[1],e.vertexCount[1]),a=0;a<r;++a)for(var o=0;o<n;++o){var s=a*e.vertexCount[0]+o,l=a*this.vertexCount[0]+o;t[s]=this._heights[l]}return this._heights=t,!0}},{key:"_rebuildWeights",value:function(e){var t=this,i=this._weightMapSize,n=this._weightMapSize*this._blockCount[0],r=this._weightMapSize*this._blockCount[1],a=e.weightMapSize*e.blockCount[0],o=e.weightMapSize*e.blockCount[1];if(a===n&&o===r)return!1;for(var s=new Uint8Array(a*o*4),l=0;l<a*o;++l)s[4*l+0]=255,s[4*l+1]=0,s[4*l+2]=0,s[4*l+3]=0;for(var c=Math.min(e.blockCount[0],this._blockCount[0]),u=Math.min(e.blockCount[1],this._blockCount[1]),h=function(e,t,i){var r=t*n+e,a=new ua;return a.x=i[4*r+0]/255,a.y=i[4*r+1]/255,a.z=i[4*r+2]/255,a.w=i[4*r+3]/255,a},_=function(e,i,n,r,a){var o=Math.floor(e),s=Math.floor(i),l=o+1,c=s+1,u=e-o,_=i-s,d=h(o+n,s+r,t._weights),f=h(l+n,s+r,t._weights),p=h(o+n,c+r,t._weights),m=h(l+n,c+r,t._weights),v=new ua;ua.add(v,f,p).multiplyScalar(.5),u+_<=1?(m.set(v),m.subtract(d),m.add(v)):(d.set(v),d.subtract(m),d.add(v));var g=new ua,y=new ua,x=new ua;return ua.lerp(g,d,f,u),ua.lerp(y,p,m,u),ua.lerp(x,g,y,_),x},d=0;d<u;++d)for(var f=0;f<c;++f)for(var p=f*i,m=d*i,v=0;v<e.weightMapSize;++v)for(var g=0;g<e.weightMapSize;++g){var y=void 0;if(e.weightMapSize===i)y=h(g+p,v+m,this._weights);else y=_(g/(e.weightMapSize-1)*(i-1),v/(e.weightMapSize-1)*(i-1),p,m,this._weights);var x=f*e.weightMapSize+g,S=(d*e.weightMapSize+v)*a+x;s[4*S+0]=255*y.x,s[4*S+1]=255*y.y,s[4*S+2]=255*y.z,s[4*S+3]=255*y.w}return this._weights=s,!0}},{key:"_asset",set:function(e){if(this.__asset!==e&&(this.__asset=e,null!=this.__asset&&this.valid)){for(var t,i=y(this._blocks);!(t=i()).done;){t.value.destroy()}this._blocks=[],this._blockInfos=[],this._buildImp()}},get:function(){return this.__asset}},{key:"effectAsset",set:function(e){if(this._effectAsset!==e){this._effectAsset=e;for(var t,i=y(this._blocks);!(t=i()).done;){t.value._invalidMaterial()}}},get:function(){return this._effectAsset}},{key:"size",get:function(){var e=new wa(0,0);return e.width=this.blockCount[0]*O6*this.tileSize,e.height=this.blockCount[1]*O6*this.tileSize,e}},{key:"tileSize",get:function(){return this._tileSize}},{key:"tileCount",get:function(){return[this.blockCount[0]*O6,this.blockCount[1]*O6]}},{key:"vertexCount",get:function(){var e=this.tileCount;return e[0]+=1,e[1]+=1,e}},{key:"blockCount",get:function(){return this._blockCount}},{key:"lightMapSize",get:function(){return this._lightMapSize}},{key:"weightMapSize",get:function(){return this._weightMapSize}},{key:"heights",get:function(){return this._heights}},{key:"weights",get:function(){return this._weights}},{key:"valid",get:function(){return this._blocks.length>0}},{key:"info",get:function(){var e=new G9;return e.tileSize=this.tileSize,e.blockCount[0]=this.blockCount[0],e.blockCount[1]=this.blockCount[1],e.weightMapSize=this.weightMapSize,e.lightMapSize=this.lightMapSize,e}}]),t}(Yr)).prototype,"__asset",[A9,si,Mi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N9=S(B9.prototype,"_effectAsset",[C9,si,Mi,w9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F9=S(B9.prototype,"_layers",[R9,si,Mi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z9=S(B9.prototype,"_blockInfos",[si,Mi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),U9=S(B9.prototype,"_lightmapInfos",[si,Mi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),S(B9.prototype,"_asset",[I9,O9],Object.getOwnPropertyDescriptor(B9.prototype,"_asset"),B9.prototype),S(B9.prototype,"effectAsset",[M9,P9],Object.getOwnPropertyDescriptor(B9.prototype,"effectAsset"),B9.prototype),S(B9.prototype,"info",[k9],Object.getOwnPropertyDescriptor(B9.prototype,"info"),B9.prototype),D9=B9))||D9)||D9)||D9)||D9)),0),Y9=function e(){i(this,e),this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},K9=function(){function e(){i(this,e),this._hashTargets=_e(!0),this._arrayTargets=[],this._elementPool=[]}return r(e,[{key:"_searchElementByTarget",value:function(e,t){for(var i=0;i<e.length;i++)if(t===e[i].target)return e[i];return null}},{key:"_getElement",value:function(e,t){var i=this._elementPool.pop();return i||(i=new Y9),i.target=e,i.paused=!!t,i}},{key:"_putElement",value:function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)}},{key:"addAction",value:function(e,t,i){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+X9++);var n=this._hashTargets[t.uuid];n?n.actions||(n.actions=[]):(n=this._getElement(t,i),this._hashTargets[t.uuid]=n,this._arrayTargets.push(n)),n.actions.push(e),e.startWithTarget(t)}else V(1e3)}},{key:"removeAllActions",value:function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var i=e[t];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=_e(!0)}},{key:"removeAllActionsFromTarget",value:function(e){if(null!=e){var t=this._hashTargets[e.uuid];t&&(t.actions.length=0,this._deleteHashElement(t))}}},{key:"removeAction",value:function(e){if(null!=e){var t=e.getOriginalTarget(),i=this._hashTargets[t.uuid];if(i)for(var n=0;n<i.actions.length;n++)if(i.actions[n]===e){i.actions.splice(n,1),i.actionIndex>=n&&i.actionIndex--;break}}}},{key:"_removeActionByTag",value:function(e,t,i){for(var n=0,r=t.actions.length;n<r;++n){var a=t.actions[n];if(a&&a.getTag()===e){if(i&&a.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,t);break}}}},{key:"removeActionByTag",value:function(e,t){e===E.Action.TAG_INVALID&&z(1002);var i=this._hashTargets;if(t){var n=i[t.uuid];n&&this._removeActionByTag(e,n,t)}else for(var r in i){var a=i[r];this._removeActionByTag(e,a)}}},{key:"getActionByTag",value:function(e,t){e===E.Action.TAG_INVALID&&z(1004);var i=this._hashTargets[t.uuid];if(i){if(null!=i.actions)for(var n=0;n<i.actions.length;++n){var r=i.actions[n];if(r&&r.getTag()===e)return r}z(1005,e)}return null}},{key:"getNumberOfRunningActionsInTarget",value:function(e){var t=this._hashTargets[e.uuid];return t&&t.actions?t.actions.length:0}},{key:"pauseTarget",value:function(e){var t=this._hashTargets[e.uuid];t&&(t.paused=!0)}},{key:"resumeTarget",value:function(e){var t=this._hashTargets[e.uuid];t&&(t.paused=!1)}},{key:"pauseAllRunningActions",value:function(){for(var e=[],t=this._arrayTargets,i=0;i<t.length;i++){var n=t[i];n&&!n.paused&&(n.paused=!0,e.push(n.target))}return e}},{key:"resumeTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])}},{key:"pauseTargets",value:function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])}},{key:"purgeSharedManager",value:function(){E.director.getScheduler().unscheduleUpdate(this)}},{key:"_removeActionAtIndex",value:function(e,t){t.actions[e];t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)}},{key:"_deleteHashElement",value:function(e){var t=!1;if(e&&!e.lock&&this._hashTargets[e.target.uuid]){delete this._hashTargets[e.target.uuid];for(var i=this._arrayTargets,n=0,r=i.length;n<r;n++)if(i[n]===e){i.splice(n,1);break}this._putElement(e),t=!0}return t}},{key:"update",value:function(e){for(var t,i=this._arrayTargets,n=0;n<i.length;n++){if(this._currentTarget=i[n],!(t=this._currentTarget).paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var r=t.currentAction;t.currentAction=null,this.removeAction(r)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&n--}}}]),e}(),Z9=e("TweenSystem",function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a)))).actionMgr=new K9,n}return o(t,e),r(t,[{key:"postUpdate",value:function(e){this.actionMgr.update(e)}},{key:"ActionManager",get:function(){return this.actionMgr}}]),t}(PD));Z9.ID="TWEEN",Z9.instance=void 0,AB.on(iB.EVENT_INIT,(function(){var e=new Z9;Z9.instance=e,AB.registerSystem(Z9.ID,e,100)}));var Q9=function(){function e(){i(this,e),this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}return r(e,[{key:"clone",value:function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t}},{key:"isDone",value:function(){return!0}},{key:"startWithTarget",value:function(e){this.originalTarget=e,this.target=e}},{key:"stop",value:function(){this.target=null}},{key:"step",value:function(e){z(1006)}},{key:"update",value:function(e){z(1007)}},{key:"getTarget",value:function(){return this.target}},{key:"setTarget",value:function(e){this.target=e}},{key:"getOriginalTarget",value:function(){return this.originalTarget}},{key:"setOriginalTarget",value:function(e){this.originalTarget=e}},{key:"getTag",value:function(){return this.tag}},{key:"setTag",value:function(e){this.tag=e}},{key:"reverse",value:function(){return z(1008),null}},{key:"retain",value:function(){}},{key:"release",value:function(){}}]),e}();Q9.TAG_INVALID=-1;var J9=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._duration=0,n._timesForRepeat=1,n}return o(t,e),r(t,[{key:"getDuration",value:function(){return this._duration*(this._timesForRepeat||1)}},{key:"setDuration",value:function(e){this._duration=e}},{key:"clone",value:function(){return new t}}]),t}(Q9),$9=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"isDone",value:function(){return!0}},{key:"step",value:function(e){this.update(1)}},{key:"update",value:function(e){}},{key:"reverse",value:function(){return this.clone()}},{key:"clone",value:function(){return new t}}]),t}(J9),eee=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"update",value:function(e){for(var t=this.target.getComponentsInChildren(AC),i=0;i<t.length;++i){t[i].enabled=!0}}},{key:"reverse",value:function(){return new tee}},{key:"clone",value:function(){return new t}}]),t}($9);var tee=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"update",value:function(e){for(var t=this.target.getComponentsInChildren(AC),i=0;i<t.length;++i){t[i].enabled=!1}}},{key:"reverse",value:function(){return new eee}},{key:"clone",value:function(){return new t}}]),t}($9);var iee=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this)))._isNeedCleanUp=!0,void 0!==e&&n.init(e),n}return o(t,e),r(t,[{key:"update",value:function(e){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()}},{key:"init",value:function(e){return this._isNeedCleanUp=e,!0}},{key:"reverse",value:function(){return new t(this._isNeedCleanUp)}},{key:"clone",value:function(){return new t(this._isNeedCleanUp)}}]),t}($9);var nee=function(e){function t(e,n,r){var a;return i(this,t),(a=u(this,s(t).call(this)))._selectorTarget=null,a._function=null,a._data=null,a.initWithFunction(e,n,r),a}return o(t,e),r(t,[{key:"initWithFunction",value:function(e,t,i){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==i&&(this._data=i),!0}},{key:"execute",value:function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)}},{key:"update",value:function(e){this.execute()}},{key:"getTargetCallback",value:function(){return this._selectorTarget}},{key:"setTargetCallback",value:function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)}},{key:"clone",value:function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e}}]),t}($9);var ree=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this))).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===e||isNaN(e)||n.initWithDuration(e),n}return o(t,e),r(t,[{key:"getElapsed",value:function(){return this._elapsed}},{key:"initWithDuration",value:function(e){return this._duration=0===e?Sh.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0}},{key:"isDone",value:function(){return this._elapsed>=this._duration}},{key:"_cloneDecoration",value:function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod}},{key:"_reverseEaseList",value:function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}}},{key:"clone",value:function(){var e=new t(this._duration);return this._cloneDecoration(e),e}},{key:"easing",value:function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this}},{key:"_computeEaseTime",value:function(e){return e}},{key:"step",value:function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=1>t?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))}},{key:"startWithTarget",value:function(e){Q9.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0}},{key:"reverse",value:function(){return z(1010),this}},{key:"setAmplitudeRate",value:function(e){z(1011)}},{key:"getAmplitudeRate",value:function(){return z(1012),0}},{key:"speed",value:function(e){return e<=0?(z(1013),this):(this._speedMethod=!0,this._speed*=e,this)}},{key:"getSpeed",value:function(){return this._speed}},{key:"setSpeed",value:function(e){return this._speed=e,this}},{key:"repeat",value:function(e){return e=Math.round(e),isNaN(e)||e<1?(z(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)}},{key:"repeatForever",value:function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this}}]),t}(J9),aee=function(e){function t(e){var n;i(this,t),(n=u(this,s(t).call(this)))._actions=[],n._split=0,n._last=0,n._reversed=!1;var r=e instanceof Array?e:arguments;if(1===r.length)return V(1019),u(n);var a=r.length-1;if(a>=0&&null==r[a]&&z(1015),a>=0){for(var o,l=r[0],c=1;c<a;c++)r[c]&&(o=l,l=t._actionOneTwo(o,r[c]));n.initWithTwoActions(l,r[a])}return n}return o(t,e),r(t,[{key:"initWithTwoActions",value:function(e,t){if(!e||!t)return V(1025),!1;var i=e._duration,n=t._duration,r=(i*=e._repeatMethod?e._timesForRepeat:1)+(n*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e}},{key:"startWithTarget",value:function(e){ree.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1}},{key:"stop",value:function(){-1!==this._last&&this._actions[this._last].stop(),Q9.prototype.stop.call(this)}},{key:"update",value:function(e){var t,i,n=0,r=this._split,a=this._actions,o=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===n&&1===o&&this._reversed&&(a[1].update(0),a[1].stop())):(n=1,t=1===r?1:(e-r)/(1-r),-1===o&&(a[0].startWithTarget(this.target),a[0].update(1),a[0].stop()),0===o&&(a[0].update(1),a[0].stop())),i=a[n],o===n&&i.isDone()||(o!==n&&i.startWithTarget(this.target),t*=i._timesForRepeat,i.update(t>1?t%1:t),this._last=n)}},{key:"reverse",value:function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e}}]),t}(ree);function oee(e){var t=e instanceof Array?e:arguments;if(1===t.length)return V(1019),null;var i=t.length-1;i>=0&&null==t[i]&&z(1015);var n=null;if(i>=0){n=t[0];for(var r=1;r<=i;r++)t[r]&&(n=aee._actionOneTwo(n,t[r]))}return n}aee._actionOneTwo=function(e,t){var i=new aee;return i.initWithTwoActions(e,t),i};var see=function(e){function t(e,n){var r;return i(this,t),(r=u(this,s(t).call(this)))._times=0,r._total=0,r._nextDt=0,r._actionInstant=!1,r._innerAction=null,void 0!==n&&r.initWithAction(e,n),r}return o(t,e),r(t,[{key:"initWithAction",value:function(e,t){var i=e._duration*t;return!!this.initWithDuration(i)&&(this._times=t,this._innerAction=e,e instanceof $9&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e}},{key:"startWithTarget",value:function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,ree.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}},{key:"stop",value:function(){this._innerAction.stop(),Q9.prototype.stop.call(this)}},{key:"update",value:function(e){e=this._computeEaseTime(e);var t=this._innerAction,i=this._duration,n=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<n;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/i,this._nextDt=r>1?1:r;e>=1&&this._total<n&&(t.update(1),this._total++),this._actionInstant||(this._total===n?t.stop():t.update(e-(r-t._duration/i)))}else t.update(e*n%1)}},{key:"isDone",value:function(){return this._total===this._times}},{key:"reverse",value:function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e}},{key:"setInnerAction",value:function(e){this._innerAction!==e&&(this._innerAction=e)}},{key:"getInnerAction",value:function(){return this._innerAction}}]),t}(ree);var lee=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this)))._innerAction=null,e&&n.initWithAction(e),n}return o(t,e),r(t,[{key:"initWithAction",value:function(e){return e?(this._innerAction=e,!0):(V(1026),!1)}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e}},{key:"startWithTarget",value:function(e){ree.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)}},{key:"step",value:function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))}},{key:"isDone",value:function(){return!1}},{key:"reverse",value:function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}},{key:"setInnerAction",value:function(e){this._innerAction!==e&&(this._innerAction=e)}},{key:"getInnerAction",value:function(){return this._innerAction}}]),t}(ree);var cee=function(e){function t(e){var n;i(this,t),(n=u(this,s(t).call(this)))._one=null,n._two=null;var r=e instanceof Array?e:arguments;if(1===r.length)return V(1020),u(n);var a=r.length-1;if(a>=0&&null==r[a]&&z(1015),a>=0){for(var o,l=r[0],c=1;c<a;c++)r[c]&&(o=l,l=t._actionOneTwo(o,r[c]));n.initWithTwoActions(l,r[a])}return n}return o(t,e),r(t,[{key:"initWithTwoActions",value:function(e,t){if(!e||!t)return V(1027),!1;var i=!1,n=e._duration,r=t._duration;return this.initWithDuration(Math.max(n,r))&&(this._one=e,this._two=t,n>r?this._two=aee._actionOneTwo(t,_ee(n-r)):n<r&&(this._one=aee._actionOneTwo(e,_ee(r-n))),i=!0),i}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e}},{key:"startWithTarget",value:function(e){ree.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)}},{key:"stop",value:function(){this._one.stop(),this._two.stop(),Q9.prototype.stop.call(this)}},{key:"update",value:function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)}},{key:"reverse",value:function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e}}]),t}(ree);function uee(e){var t=e instanceof Array?e:arguments;if(1===t.length)return V(1020),null;t.length>0&&null==t[t.length-1]&&z(1015);for(var i=t[0],n=1;n<t.length;n++)null!=t[n]&&(i=cee._actionOneTwo(i,t[n]));return i}cee._actionOneTwo=function(e,t){var i=new cee;return i.initWithTwoActions(e,t),i};var hee=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"update",value:function(e){}},{key:"reverse",value:function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e}}]),t}(ree);function _ee(e){return new hee(e)}var dee=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this)))._other=null,e&&n.initWithAction(e),n}return o(t,e),r(t,[{key:"initWithAction",value:function(e){return e?e===this._other?(V(1029),!1):!!ree.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(V(1028),!1)}},{key:"clone",value:function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e}},{key:"startWithTarget",value:function(e){ree.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)}},{key:"update",value:function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)}},{key:"reverse",value:function(){return this._other.clone()}},{key:"stop",value:function(){this._other.stop(),Q9.prototype.stop.call(this)}}]),t}(ree);var fee,pee,mee,vee,gee,yee,xee,See,Tee,Eee,bee,Aee,Cee,wee,Ree,Iee,Oee,Mee,Pee,kee,Dee,Bee,Lee=function(e){function n(e,t,r){var a;if(i(this,n),(a=u(this,s(n).call(this)))._opts=void 0,a._props=void 0,a._originProps=void 0,null==r)r=Object.create(null);else if(function(e){var t=" [Tween:] ",i=" option is not support in v"+E.ENGINE_VERSION;e.delay&&P(t+"delay"+i),e.repeat&&P(t+"repeat"+i),e.repeatDelay&&P(t+"repeatDelay"+i),e.interpolation&&P(t+"interpolation"+i),e.onStop&&P(t+"onStop"+i)}(r),r.easing&&"string"==typeof r.easing&&(r.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var i=(e=e.replace(t,t.toLowerCase())).split("-");if(2==i.length){var n=i[0];if("linear"==n)e="linear";else{var r=i[1];switch(n){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=n+r}}}}return e}(r.easing)),r.progress||(r.progress=a.progress),r.easing&&"string"==typeof r.easing){var o=r.easing;r.easing=Xz[o],r.easing||G(1031,o)}for(var l in a._opts=r,a._props=Object.create(null),t){var c=t[l],h=void 0,_=void 0;void 0!==c.value&&(c.easing||c.progress)&&("string"==typeof c.easing?!(h=h[c.easing])&&G(1031,c.easing):h=c.easing,_=c.progress,c=c.value);var d=Object.create(null);d.value=c,d.easing=h,d.progress=_,a._props[l]=d}return a._originProps=t,a.initWithDuration(e),a}return o(n,e),r(n,[{key:"clone",value:function(){var e=new n(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e}},{key:"startWithTarget",value:function(e){ree.prototype.startWithTarget.call(this,e);var i=!!this._opts.relative,n=this._props;for(var r in n){var a=e[r];if(void 0!==a){var o=n[r],s=o.value;if("number"==typeof a)o.start=a,o.current=a,o.end=i?a+s:s;else if("object"===t(a))for(var l in null==o.start&&(o.start={},o.current={},o.end={}),s)o.start[l]=a[l],o.current[l]=a[l],o.end[l]=i?a[l]+s[l]:s[l]}}this._opts.onStart&&this._opts.onStart(this.target)}},{key:"update",value:function(e){var i=this.target;if(i){var n=this._props,r=this._opts,a=e;r.easing&&(a=r.easing(e));var o=r.progress;for(var s in n){var l=n[s],c=l.easing?l.easing(e):a,u=l.progress?l.progress:o,h=l.start,_=l.end;if("number"==typeof h)l.current=u(h,_,l.current,c);else if("object"===t(h))for(var d in h)l.current[d]=u(h[d],_[d],l.current[d],c);i[s]=l.current}r.onUpdate&&r.onUpdate(this.target,e),1==e&&r.onComplete&&r.onComplete(this.target)}}},{key:"progress",value:function(e,t,i,n){return e+(t-e)*n}}]),n}(ree),Nee=function(e){function t(e){var n;return i(this,t),(n=u(this,s(t).call(this)))._props=void 0,n._props={},void 0!==e&&n.init(e),n}return o(t,e),r(t,[{key:"init",value:function(e){for(var t in e)this._props[t]=e[t];return!0}},{key:"update",value:function(){var e=this._props,t=this.target;for(var i in e)t[i]=e[i]}},{key:"clone",value:function(){var e=new t;return e.init(this._props),e}}]),t}($9),Fee=e("Tween",function(){function e(t){i(this,e),this._actions=[],this._finalAction=null,this._target=null,this._tag=Q9.TAG_INVALID,this._target=void 0===t?null:t,this._target&&this._target instanceof ig&&this._target.on(lm.NODE_DESTROYED,this._destroy,this)}return r(e,[{key:"tag",value:function(e){return this._tag=e,this}},{key:"then",value:function(e){return e instanceof Q9?this._actions.push(e.clone()):this._actions.push(e._union()),this}},{key:"target",value:function(e){return this._target&&this._target instanceof ig&&this._target.off(lm.NODE_DESTROYED,this._destroy,this),this._target=e,this._target&&this._target instanceof ig&&this._target.on(lm.NODE_DESTROYED,this._destroy,this),this}},{key:"start",value:function(){return this._target?(this._finalAction&&Z9.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),Z9.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(P("Please set target to tween first"),this)}},{key:"stop",value:function(){return this._finalAction&&Z9.instance.ActionManager.removeAction(this._finalAction),this}},{key:"clone",value:function(e){var t=this._union();return zee(e).then(t.clone())}},{key:"union",value:function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this}},{key:"to",value:function(e,t,i){(i=i||Object.create(null)).relative=!1;var n=new Lee(e,t,i);return this._actions.push(n),this}},{key:"by",value:function(e,t,i){(i=i||Object.create(null)).relative=!0;var n=new Lee(e,t,i);return this._actions.push(n),this}},{key:"set",value:function(e){var t=new Nee(e);return this._actions.push(t),this}},{key:"delay",value:function(e){var t=_ee(e);return this._actions.push(t),this}},{key:"call",value:function(e){var t,i,n=new nee(e,t,i);return this._actions.push(n),this}},{key:"sequence",value:function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this}},{key:"parallel",value:function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this}},{key:"repeat",value:function(t,i){if(t==1/0)return this.repeatForever(i);var n,r=this._actions;return n=i instanceof e?i._union():r.pop(),r.push(function(e,t){return new see(e,t)}(n,t)),this}},{key:"repeatForever",value:function(t){var i,n=this._actions;return i=t instanceof e?t._union():n.pop(),n.push(function(e){return new lee(e)}(i)),this}},{key:"reverseTime",value:function(t){var i,n=this._actions;return i=t instanceof e?t._union():n.pop(),n.push(function(e){return new dee(e)}(i)),this}},{key:"hide",value:function(){var e=new tee;return this._actions.push(e),this}},{key:"show",value:function(){var e=new eee;return this._actions.push(e),this}},{key:"removeSelf",value:function(){var e=new iee(!1);return this._actions.push(e),this}},{key:"_union",value:function(){var e=this._actions;return 1===e.length?e[0]:oee(e)}},{key:"_destroy",value:function(){this.stop()}}],[{key:"stopAll",value:function(){Z9.instance.ActionManager.removeAllActions()}},{key:"stopAllByTag",value:function(e,t){Z9.instance.ActionManager.removeActionByTag(e,t)}},{key:"stopAllByTarget",value:function(e){Z9.instance.ActionManager.removeAllActionsFromTarget(e)}},{key:"_wrappedSequence",value:function(){var t=e._tmp_args;t.length=0;for(var i=arguments.length,n=0;n<i;n++){var r=t[n]=n<0||arguments.length<=n?void 0:arguments[n];r instanceof e&&(t[n]=r._union())}return oee.apply(oee,t)}},{key:"_wrappedParallel",value:function(){var t=e._tmp_args;t.length=0;for(var i=arguments.length,n=0;n<i;n++){var r=t[n]=n<0||arguments.length<=n?void 0:arguments[n];r instanceof e&&(t[n]=r._union())}return uee.apply(uee,t)}}]),e}());function zee(e){return new Fee(e)}function Uee(e){return P("tweenUtil' is deprecated, please use 'tween' instead "),new Fee(e)}Fee._tmp_args=[],E.Tween=Fee,E.tween=zee,E.tweenUtil=Uee;var Gee,Hee=new oa,Vee=et({SOLID_COLOR:Ts.ALL,DEPTH_ONLY:Ts.DEPTH_STENCIL,DONT_CLEAR:Ts.NONE}),Wee=et({OVERLAY:0,INTERSPERSE:1}),jee=e("CanvasComponent",(fee=ii("cc.Canvas"),pee=mi("i18n:cc.Canvas"),mee=ri(100),vee=ni(jv),gee=_i("UI/Canvas"),yee=Li(Vee),xee=Si(""),See=Si(""),Tee=Li(Wee),Eee=Si("Canvas intersperse  Canvas overlay  Canvas \n Canvas  ClearFlag  SOLID_COLOR"),bee=Si(" RenderMode  intersperse  RenderMode  overlay  Canvas  Canvas  priority "),Aee=Li(om),Cee=Si(""),wee=Li(Vee),Ree=Li(Wee),fee(Iee=pee(Iee=mee(Iee=vee(Iee=gee(Iee=hi(Iee=ai((S((Oee=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_priority",Mee,c(e)),x(e,"_targetTexture",Pee,c(e)),x(e,"_clearFlag",kee,c(e)),x(e,"_color",Dee,c(e)),x(e,"_renderMode",Bee,c(e)),e._thisOnResized=void 0,e._camera=null,e._pos=new oa,e._thisOnResized=e.alignWithScreen.bind(c(e)),e}return o(t,e),r(t,[{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this._camera&&(this._camera.clearFlag=this._clearFlag)}},{key:"color",get:function(){return this._color},set:function(e){Ma.copy(this._color,e),this._camera&&(this._camera.clearColor=e)}},{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._camera&&(this._camera.priority=this._getViewPriority())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=this._getViewPriority()),AB.root&&AB.root.ui&&AB.root.ui.sortScreens()}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var t=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(t),this._updateTargetTexture()}}},{key:"visibility",get:function(){return this._camera?this._camera.view.visibility:-1}},{key:"camera",get:function(){return this._camera}}]),r(t,[{key:"__preload",value:function(){var e=new ig("UICamera_"+this.node.name);if(e.setPosition(0,0,1e3),this._camera=AB.root.createCamera(),this._camera.initialize({name:"ui_"+this.node.name,node:e,projection:KN.ProjectionType.ORTHO,priority:this._getViewPriority(),flows:["UIFlow"]}),this._camera.fov=45,this._camera.clearFlag=this.clearFlag,this._camera.farClip=2e3,this._camera.viewport=new Ia(0,0,1,1),this.color=this._color,this._targetTexture){var t=this._targetTexture.window;this._camera.changeTargetWindow(t)}PO.on("design-resolution-changed",this._thisOnResized),this.alignWithScreen(),AB.root.ui.addScreen(this)}},{key:"onEnable",value:function(){this._camera&&AB.root.ui.renderScene.addCamera(this._camera)}},{key:"onDisable",value:function(){this._camera&&AB.root.ui.renderScene.removeCamera(this._camera)}},{key:"onDestroy",value:function(){AB.root.ui.removeScreen(this),this._camera&&AB.root.destroyCamera(this._camera),this._targetTexture&&this._targetTexture.off("resize"),PO.off("design-resolution-changed",this._thisOnResized)}},{key:"alignWithScreen",value:function(){var e,t;this.node.getPosition(this._pos);var i=mO;e=i,t=PO.getDesignResolutionSize();var n=0,r=0;PO.getResolutionPolicy()===E.view._rpNoBorder&&(n=.5*(t.width-i.width),r=.5*(t.height-i.height)),oa.set(Hee,.5*i.width+n,.5*i.height+r,0),this._pos.equals(Hee)||this.node.setPosition(Hee);var a=this.node._uiProps.uiTransformComp;a.width!==e.width&&(a.width=e.width),a.height!==e.height&&(a.height=e.height),this.node.getWorldPosition(Hee);var o=this._camera;if(o){if(this._targetTexture)o.setFixedSize(i.width,i.height),o.orthoHeight=i.height/2;else{var s=CO.canvas;o.resize(s.width,s.height),o.orthoHeight=CO.canvas.height/PO.getScaleY()/2}o.node.setPosition(Hee.x,Hee.y,1e3),o.update()}}},{key:"_checkTargetTextureEvent",value:function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)}},{key:"_updateTargetTexture",value:function(){if(this._camera){var e=this._camera;if(this._targetTexture){var t=this._targetTexture.window;e.changeTargetWindow(t),e.orthoHeight=mO.height/2,e.isWindowSize=!1}else e.changeTargetWindow(),e.orthoHeight=CO.canvas.height/PO.getScaleY()/2,e.isWindowSize=!0}}},{key:"_getViewPriority",value:function(){return this._renderMode===Wee.OVERLAY?this._priority|1<<30:this._priority}}]),t}(Yr)).prototype,"clearFlag",[yee,xee],Object.getOwnPropertyDescriptor(Oee.prototype,"clearFlag"),Oee.prototype),S(Oee.prototype,"color",[See],Object.getOwnPropertyDescriptor(Oee.prototype,"color"),Oee.prototype),S(Oee.prototype,"renderMode",[Tee,Eee],Object.getOwnPropertyDescriptor(Oee.prototype,"renderMode"),Oee.prototype),S(Oee.prototype,"priority",[bee],Object.getOwnPropertyDescriptor(Oee.prototype,"priority"),Oee.prototype),S(Oee.prototype,"targetTexture",[Aee,Cee],Object.getOwnPropertyDescriptor(Oee.prototype,"targetTexture"),Oee.prototype),Mee=S(Oee.prototype,"_priority",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pee=S(Oee.prototype,"_targetTexture",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kee=S(Oee.prototype,"_clearFlag",[wee],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vee.DEPTH_ONLY}}),Dee=S(Oee.prototype,"_color",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma(0,0,0,0)}}),Bee=S(Oee.prototype,"_renderMode",[Ree],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wee.OVERLAY}}),Iee=Oee))||Iee)||Iee)||Iee)||Iee)||Iee)||Iee)||Iee));E.Canvas=jee;var qee=e("UIComponent",ii("cc.UIComponent")(Gee=ni(jv)(Gee=ri(110)(Gee=ai(Gee=hi(Gee=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._lastParent=null,n}return o(t,e),r(t,[{key:"__preload",value:function(){this.node._uiProps.uiComp=this}},{key:"onEnable",value:function(){}},{key:"onDisable",value:function(){}},{key:"onDestroy",value:function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}},{key:"updateAssembler",value:function(e){}},{key:"postUpdateAssembler",value:function(e){}}]),t}(Yr))||Gee)||Gee)||Gee)||Gee)||Gee);Da(qee.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),E.UITransformComponent=jv,ze.setClassAlias(jv,"cc.UITransformComponent"),ze.setClassAlias(YM,"cc.RenderComponent"),E.CanvasComponent=jee,ze.setClassAlias(jee,"cc.CanvasComponent");var Xee,Yee,Kee,Zee,Qee,Jee,$ee,ete,tte,ite,nte,rte,ate,ote,ste,lte,cte,ute,hte,_te,dte,fte,pte,mte,vte,gte,yte,xte,Ste,Tte,Ete,bte,Ate,Cte,wte,Rte,Ite,Ote,Mte,Pte,kte,Dte,Bte,Lte,Nte,Fte,zte,Ute,Gte,Hte,Vte=new oa,Wte=new Ta;function jte(e,t,i,n){var r=i.data,a=t.currBufferBatch,o=a.byteOffset>>2,s=i.vertexCount,l=a.indicesOffset,c=a.vertexOffset;a.request(s,i.indicesCount)||(a=t.currBufferBatch,s=0,l=0,c=0);var u=a.vData,h=a.iData;e.getWorldMatrix(Wte);for(var _=0;_<s;_++){var d=r[_];oa.set(Vte,d.x,d.y,0),oa.transformMat4(Vte,Vte,Wte),u[o++]=Vte.x,u[o++]=Vte.y,u[o++]=Vte.z,u[o++]=d.u,u[o++]=d.v,Ma.toArray(u,n,o),o+=4}for(var f=0,p=s/4;f<p;f++){var m=c+4*f;h[l++]=m,h[l++]=m+1,h[l++]=m+2,h[l++]=m+1,h[l++]=m+3,h[l++]=m+2}}var qte,Xte,Yte,Kte=new Ma;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(qte||(qte={})),nt(qte),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(Xte||(Xte={})),function(e){e.CLICK="click"}(Yte||(Yte={}));var Zte,Qte,Jte,$te,eie,tie,iie,nie,rie,aie,oie,sie,lie,cie,uie,hie,_ie,die,fie,pie,mie,vie,gie,yie,xie,Sie,Tie,Eie,bie,Aie,Cie,wie,Rie,Iie,Oie,Mie,Pie,kie,Die,Bie,Lie,Nie,Fie,zie,Uie,Gie,Hie,Vie,Wie,jie,qie,Xie,Yie,Kie,Zie,Qie,Jie,$ie,ene,tne,ine,nne,rne,ane,one=e("ButtonComponent",(Xee=ii("cc.Button"),Yee=mi("i18n:cc.Button"),Kee=ri(110),Zee=_i("UI/Button"),Qee=ni(jv),Jee=Li(ig),$ee=wi(0),ete=Si(" Button Button  Color  Sprite "),tte=wi(1),ite=Si(""),nte=Li(qte),rte=wi(2),ate=Si(""),ote=Si(""),ste=Si(""),lte=Si(""),cte=Si(""),ute=Ei(0),hte=bi(10),_te=Si(""),dte=Si(" Button  scale * zoomScale"),fte=Li(Pd),pte=Si(""),mte=Li(Pd),vte=Si(""),gte=Li(Pd),yte=Si(""),xte=Li(Pd),Ste=Si(""),Tte=Li([CB]),Ete=wi(20),bte=Si("1"),Xee(Ate=Yee(Ate=Kee(Ate=Zee(Ate=Qee((Hte=Gte=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"clickEvents",wte,c(n)),x(n,"_interactable",Rte,c(n)),x(n,"_transition",Ite,c(n)),x(n,"_normalColor",Ote,c(n)),x(n,"_hoverColor",Mte,c(n)),x(n,"_pressedColor",Pte,c(n)),x(n,"_disabledColor",kte,c(n)),x(n,"_normalSprite",Dte,c(n)),x(n,"_hoverSprite",Bte,c(n)),x(n,"_pressedSprite",Lte,c(n)),x(n,"_disabledSprite",Nte,c(n)),x(n,"_duration",Fte,c(n)),x(n,"_zoomScale",zte,c(n)),x(n,"_target",Ute,c(n)),n._pressed=!1,n._hovered=!1,n._fromColor=new Ma,n._toColor=new Ma,n._time=0,n._transitionFinished=!0,n._fromScale=new oa,n._toScale=new oa,n._originalScale=null,n._sprite=null,n._targetScale=new oa,n}return o(t,e),r(t,[{key:"__preload",value:function(){this.target||(this.target=this.node);var e=this.node.getComponent(Dk);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()}},{key:"onEnable",value:function(){this.node.on(lm.TOUCH_START,this._onTouchBegan,this),this.node.on(lm.TOUCH_MOVE,this._onTouchMove,this),this.node.on(lm.TOUCH_END,this._onTouchEnded,this),this.node.on(lm.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(lm.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(lm.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"onDisable",value:function(){this._resetState(),this.node.off(lm.TOUCH_START,this._onTouchBegan,this),this.node.off(lm.TOUCH_MOVE,this._onTouchMove,this),this.node.off(lm.TOUCH_END,this._onTouchEnded,this),this.node.off(lm.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(lm.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(lm.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"update",value:function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===qte.COLOR||this._transition===qte.SCALE)){this._time+=e;var i=1;this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1);var n=t.getComponent(YM);n&&(this._transition===qte.COLOR?(Ma.lerp(Kte,this._fromColor,this._toColor,i),n.color=Kte):this.transition===qte.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=yn(this._fromScale.x,this._toScale.x,i),this._targetScale.y=yn(this._fromScale.y,this._toScale.y,i),t.setScale(this._targetScale)),1===i&&(this._transitionFinished=!0))}}},{key:"_resizeNodeToTargetNode",value:function(){if(this.target)this.target._uiProps.uiTransformComp}},{key:"_resetState",value:function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=e.getComponent(YM);if(t){var i=this._transition;i===qte.COLOR&&this._interactable?t.color=this._normalColor:i===qte.SCALE&&this._originalScale&&e.setScale(this._originalScale),this._transitionFinished=!0}}}},{key:"_registerNodeEvent",value:function(){this.node.on(lm.TOUCH_START,this._onTouchBegan,this),this.node.on(lm.TOUCH_MOVE,this._onTouchMove,this),this.node.on(lm.TOUCH_END,this._onTouchEnded,this),this.node.on(lm.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(lm.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(lm.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_registerTargetEvent",value:function(e){e.on(lm.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)}},{key:"_unregisterNodeEvent",value:function(){this.node.off(lm.TOUCH_START,this._onTouchBegan,this),this.node.off(lm.TOUCH_MOVE,this._onTouchMove,this),this.node.off(lm.TOUCH_END,this._onTouchEnded,this),this.node.off(lm.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(lm.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(lm.MOUSE_LEAVE,this._onMouseMoveOut,this)}},{key:"_unregisterTargetEvent",value:function(e){e.off(lm.TRANSFORM_CHANGED)}},{key:"_getTargetSprite",value:function(e){var t=null;return e&&(t=e.getComponent(Dk)),t}},{key:"_applyTarget",value:function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new oa),oa.copy(this._originalScale,this.target.getScale()))}},{key:"_onTargetSpriteFrameChanged",value:function(e){this._transition===qte.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)}},{key:"_setCurrentStateSpriteFrame",value:function(e){if(e)switch(this._getButtonState()){case Xte.NORMAL:this._normalSprite=e;break;case Xte.HOVER:this._hoverSprite=e;break;case Xte.PRESSED:this._pressedSprite=e;break;case Xte.DISABLED:this._disabledSprite=e}}},{key:"_onTargetColorChanged",value:function(e){this._transition===qte.COLOR&&this._setCurrentStateColor(e)}},{key:"_setCurrentStateColor",value:function(e){switch(this._getButtonState()){case Xte.NORMAL:this._normalColor=e;break;case Xte.HOVER:this._hoverColor=e;break;case Xte.PRESSED:this._pressedColor=e;break;case Xte.DISABLED:this._disabledColor=e}}},{key:"_onTargetTransformChanged",value:function(e){e|nv.SCALE&&this._originalScale&&this._transition===qte.SCALE&&this._transitionFinished&&oa.copy(this._originalScale,this.target.getScale())}},{key:"_onTouchBegan",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchMove",value:function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed){if(!e)return!1;var t=e.touch;if(!t)return!1;var i,n=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());if(this._transition===qte.SCALE&&this.target&&this._originalScale)n?(oa.copy(this._fromScale,this._originalScale),oa.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale));else i=n?Xte.PRESSED:Xte.NORMAL,this._applyTransition(i);e&&(e.propagationStopped=!0)}}},{key:"_onTouchEnded",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(CB.emitEvents(this.clickEvents,e),this.node.emit(Yte.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))}},{key:"_onTouchCancel",value:function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}},{key:"_onMouseMoveIn",value:function(e){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==qte.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}},{key:"_onMouseMoveOut",value:function(e){this._hovered&&(this._hovered=!1,this._updateState())}},{key:"_updateState",value:function(){var e=this._getButtonState();this._applyTransition(e)}},{key:"_getButtonState",value:function(){var e=Xte.NORMAL;return this._interactable?this._pressed?e=Xte.PRESSED:this._hovered&&(e=Xte.HOVER):e=Xte.DISABLED,e.toString()}},{key:"_updateColorTransition",value:function(e){var t,i=this[e+"Color"],n=null===(t=this.target)||void 0===t?void 0:t.getComponent(YM);n&&(e===Xte.DISABLED?n.color=i:(this._fromColor=n.color.clone(),this._toColor=i,this._time=0,this._transitionFinished=!1))}},{key:"_updateSpriteTransition",value:function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)}},{key:"_updateScaleTransition",value:function(e){this._interactable&&(e===Xte.PRESSED?this._zoomUp():this._zoomBack())}},{key:"_zoomUp",value:function(){this._originalScale&&(oa.copy(this._fromScale,this._originalScale),oa.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}},{key:"_zoomBack",value:function(){this.target&&this._originalScale&&(oa.copy(this._fromScale,this.target.getScale()),oa.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}},{key:"_applyTransition",value:function(e){var t=this._transition;t===qte.COLOR?this._updateColorTransition(e):t===qte.SPRITE?this._updateSpriteTransition(e):t===qte.SCALE&&this._updateScaleTransition(e)}},{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===qte.COLOR?this._updateColorTransition(Xte.NORMAL):this._transition===qte.SPRITE&&this._updateSpriteTransition(Xte.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(Dk);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(Yr),Gte.Transition=qte,Gte.EventType=Yte,S((Cte=Hte).prototype,"target",[Jee,$ee,ete],Object.getOwnPropertyDescriptor(Cte.prototype,"target"),Cte.prototype),S(Cte.prototype,"interactable",[tte,ite],Object.getOwnPropertyDescriptor(Cte.prototype,"interactable"),Cte.prototype),S(Cte.prototype,"transition",[nte,rte,ate],Object.getOwnPropertyDescriptor(Cte.prototype,"transition"),Cte.prototype),S(Cte.prototype,"normalColor",[ote],Object.getOwnPropertyDescriptor(Cte.prototype,"normalColor"),Cte.prototype),S(Cte.prototype,"pressedColor",[ste],Object.getOwnPropertyDescriptor(Cte.prototype,"pressedColor"),Cte.prototype),S(Cte.prototype,"hoverColor",[lte],Object.getOwnPropertyDescriptor(Cte.prototype,"hoverColor"),Cte.prototype),S(Cte.prototype,"disabledColor",[cte],Object.getOwnPropertyDescriptor(Cte.prototype,"disabledColor"),Cte.prototype),S(Cte.prototype,"duration",[ute,hte,_te],Object.getOwnPropertyDescriptor(Cte.prototype,"duration"),Cte.prototype),S(Cte.prototype,"zoomScale",[dte],Object.getOwnPropertyDescriptor(Cte.prototype,"zoomScale"),Cte.prototype),S(Cte.prototype,"normalSprite",[fte,pte],Object.getOwnPropertyDescriptor(Cte.prototype,"normalSprite"),Cte.prototype),S(Cte.prototype,"pressedSprite",[mte,vte],Object.getOwnPropertyDescriptor(Cte.prototype,"pressedSprite"),Cte.prototype),S(Cte.prototype,"hoverSprite",[gte,yte],Object.getOwnPropertyDescriptor(Cte.prototype,"hoverSprite"),Cte.prototype),S(Cte.prototype,"disabledSprite",[xte,Ste],Object.getOwnPropertyDescriptor(Cte.prototype,"disabledSprite"),Cte.prototype),wte=S(Cte.prototype,"clickEvents",[Tte,si,Ete,bte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rte=S(Cte.prototype,"_interactable",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ite=S(Cte.prototype,"_transition",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qte.NONE}}),Ote=S(Cte.prototype,"_normalColor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma(214,214,214,255)}}),Mte=S(Cte.prototype,"_hoverColor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma(211,211,211,255)}}),Pte=S(Cte.prototype,"_pressedColor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.WHITE.clone()}}),kte=S(Cte.prototype,"_disabledColor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma(124,124,124,255)}}),Dte=S(Cte.prototype,"_normalSprite",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bte=S(Cte.prototype,"_hoverSprite",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lte=S(Cte.prototype,"_pressedSprite",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nte=S(Cte.prototype,"_disabledSprite",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fte=S(Cte.prototype,"_duration",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),zte=S(Cte.prototype,"_zoomScale",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Ute=S(Cte.prototype,"_target",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ate=Cte))||Ate)||Ate)||Ate)||Ate)||Ate)),sne=e("CanvasPool",function(){function e(){i(this,e),this.pool=[]}return r(e,[{key:"get",value:function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),i=t.getContext("2d");e={canvas:t,context:i}}return e}},{key:"put",value:function(e){this.pool.length>=32||this.pool.push(e)}}]),e}());!function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(ine||(ine=e("HorizontalTextAlignment",{}))),nt(ine),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(nne||(nne=e("VerticalTextAlignment",{}))),nt(nne),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(rne||(rne=e("Overflow",{}))),nt(rne),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(ane||(ane=e("CacheMode",{}))),nt(ane);var lne,cne,une,hne=e("LabelComponent",(Zte=ii("cc.Label"),Qte=mi("i18n:cc.Label"),Jte=ri(110),$te=_i("UI/Render/Label"),eie=wi(4),tie=Si("Label "),iie=Li(ine),nie=wi(5),rie=Si(""),aie=Li(nne),oie=wi(6),sie=Si(""),lie=wi(7),cie=Si(" point "),uie=wi(8),hie=Si(""),_ie=wi(8),die=Si(" point "),fie=Li(rne),pie=wi(9),mie=Si("\n 1. CLAMP:  \n 2. SHRINK: \n 3. RESIZE_HEIGHT:  height ."),vie=wi(10),gie=Si(""),yie=Li(aI),xie=wi(11),Sie=Si("Label "),Tie=wi(12),Eie=Si(""),bie=Li(ane),Aie=wi(13),Cie=Si("\n 1. NONE:  \n 2. BITMAP:  \n 3. CHAR: "),wie=wi(15),Rie=Si(""),Iie=wi(16),Oie=Si(""),Mie=wi(17),Pie=Si(""),kie=Li(sm),Die=xi("Materials"),Bie=gi(!1),Zte(Lie=Qte(Lie=Jte(Lie=$te((tne=ene=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_useOriginalSize",Fie,c(e)),x(e,"_string",zie,c(e)),x(e,"_horizontalAlign",Uie,c(e)),x(e,"_verticalAlign",Gie,c(e)),x(e,"_actualFontSize",Hie,c(e)),x(e,"_fontSize",Vie,c(e)),x(e,"_fontFamily",Wie,c(e)),x(e,"_lineHeight",jie,c(e)),x(e,"_overflow",qie,c(e)),x(e,"_enableWrapText",Xie,c(e)),x(e,"_font",Yie,c(e)),x(e,"_isSystemFontUsed",Kie,c(e)),e._spacingX=0,x(e,"_isItalic",Zie,c(e)),x(e,"_isBold",Qie,c(e)),x(e,"_isUnderline",Jie,c(e)),x(e,"_cacheMode",$ie,c(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}return o(t,e),r(t,[{key:"string",get:function(){return this._string},set:function(e){e+="",this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,"string"==typeof e&&G(4e3),this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null,this._flushAssembler(),this.updateRenderData()))}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode===ane.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"spriteFrame",get:function(){return this._texture}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"sharedMaterials",get:function(){return _(s(t.prototype),"sharedMaterials",this)},set:function(e){f(s(t.prototype),"sharedMaterials",e,this,!0)}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof mI?this._font.fontSize:-1}}]),r(t,[{key:"onEnable",value:function(){_(s(t.prototype),"onEnable",this).call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}},{key:"onDisable",value:function(){_(s(t.prototype),"onDisable",this).call(this)}},{key:"onDestroy",value:function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){var e=this._ttfSpriteFrame.texture;if(e){var i=e;i.image&&i.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,_(s(t.prototype),"onDestroy",this).call(this)}},{key:"updateRenderData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.markForUpdateRenderData(),e&&(this._flushAssembler(),this._applyFontTexture())}},{key:"_render",value:function(e){e.commitComp(this,this._texture.getGFXTexture(),this._assembler,this._texture.getGFXSampler())}},{key:"_updateColor",value:function(){this._font instanceof mI?_(s(t.prototype),"_updateColor",this).call(this):this.updateRenderData(!1)}},{key:"_canRender",value:function(){if(!_(s(t.prototype),"_canRender",this).call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof mI){var i=e.spriteFrame;if(!i||!i.textureLoaded())return!1}return!0}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}},{key:"_applyFontTexture",value:function(){var e=this,t=this._font;if(t instanceof mI){var i=t.spriteFrame,n=function(){e._texture=i,e._assembler&&e._assembler.updateRenderData(e)};i&&(i.loaded||i.textureLoaded?n():i.once("load",n,this))}else{if(this.cacheMode===ane.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new Pd,this._assemblerData=this._assembler.getAssemblerData();var r=new $u(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=r}this.cacheMode!==ane.CHAR&&(this._texture=this._ttfSpriteFrame),this._assembler&&this._assembler.updateRenderData(this)}}}]),t}(YM),ene.HorizontalAlign=ine,ene.VerticalAlign=nne,ene.Overflow=rne,ene.CacheMode=ane,ene._canvasPool=new sne,S((Nie=tne).prototype,"string",[eie,tie,Oi],Object.getOwnPropertyDescriptor(Nie.prototype,"string"),Nie.prototype),S(Nie.prototype,"horizontalAlign",[iie,nie,rie],Object.getOwnPropertyDescriptor(Nie.prototype,"horizontalAlign"),Nie.prototype),S(Nie.prototype,"verticalAlign",[aie,oie,sie],Object.getOwnPropertyDescriptor(Nie.prototype,"verticalAlign"),Nie.prototype),S(Nie.prototype,"fontSize",[lie,cie],Object.getOwnPropertyDescriptor(Nie.prototype,"fontSize"),Nie.prototype),S(Nie.prototype,"fontFamily",[uie,hie],Object.getOwnPropertyDescriptor(Nie.prototype,"fontFamily"),Nie.prototype),S(Nie.prototype,"lineHeight",[_ie,die],Object.getOwnPropertyDescriptor(Nie.prototype,"lineHeight"),Nie.prototype),S(Nie.prototype,"overflow",[fie,pie,mie],Object.getOwnPropertyDescriptor(Nie.prototype,"overflow"),Nie.prototype),S(Nie.prototype,"enableWrapText",[vie,gie],Object.getOwnPropertyDescriptor(Nie.prototype,"enableWrapText"),Nie.prototype),S(Nie.prototype,"font",[yie,xie,Sie],Object.getOwnPropertyDescriptor(Nie.prototype,"font"),Nie.prototype),S(Nie.prototype,"useSystemFont",[Tie,Eie],Object.getOwnPropertyDescriptor(Nie.prototype,"useSystemFont"),Nie.prototype),S(Nie.prototype,"cacheMode",[bie,Aie,Cie],Object.getOwnPropertyDescriptor(Nie.prototype,"cacheMode"),Nie.prototype),S(Nie.prototype,"isBold",[wie,Rie],Object.getOwnPropertyDescriptor(Nie.prototype,"isBold"),Nie.prototype),S(Nie.prototype,"isItalic",[Iie,Oie],Object.getOwnPropertyDescriptor(Nie.prototype,"isItalic"),Nie.prototype),S(Nie.prototype,"isUnderline",[Mie,Pie],Object.getOwnPropertyDescriptor(Nie.prototype,"isUnderline"),Nie.prototype),S(Nie.prototype,"sharedMaterials",[kie,Ni,Die,Bie],Object.getOwnPropertyDescriptor(Nie.prototype,"sharedMaterials"),Nie.prototype),Fie=S(Nie.prototype,"_useOriginalSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zie=S(Nie.prototype,"_string",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),Uie=S(Nie.prototype,"_horizontalAlign",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ine.CENTER}}),Gie=S(Nie.prototype,"_verticalAlign",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nne.CENTER}}),Hie=S(Nie.prototype,"_actualFontSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vie=S(Nie.prototype,"_fontSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Wie=S(Nie.prototype,"_fontFamily",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),jie=S(Nie.prototype,"_lineHeight",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),qie=S(Nie.prototype,"_overflow",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rne.NONE}}),Xie=S(Nie.prototype,"_enableWrapText",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Yie=S(Nie.prototype,"_font",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kie=S(Nie.prototype,"_isSystemFontUsed",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Zie=S(Nie.prototype,"_isItalic",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qie=S(Nie.prototype,"_isBold",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jie=S(Nie.prototype,"_isUnderline",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$ie=S(Nie.prototype,"_cacheMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ane.NONE}}),Lie=Nie))||Lie)||Lie)||Lie)||Lie)),_ne=function(){function e(){i(this,e)}return r(e,null,[{key:"add",value:function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)}},{key:"remove",value:function(e){var t=this._tabIndexList,i=t.indexOf(e);-1!==i&&t.splice(i,1)}},{key:"resort",value:function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))}},{key:"next",value:function(e){var t=this._tabIndexList,i=t.indexOf(e);if(e.setFocus(!1),-1!==i){var n=t[i+1];n&&n._delegate.tabIndex>=0&&n.setFocus(!0)}}}]),e}();_ne._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(lne||(lne={})),et(lne),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(cne||(cne={})),et(cne),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(une||(une={})),et(une);var dne,fne,pne,mne,vne,gne,yne,xne,Sne,Tne,Ene,bne,Ane,Cne,wne,Rne,Ine,One,Mne,Pne,kne,Dne,Bne,Lne,Nne,Fne,zne,Une,Gne,Hne,Vne,Wne,jne,qne,Xne,Yne,Kne,Zne,Qne,Jne,$ne,ere,tre,ire,nre,rre,are,ore,sre,lre,cre,ure,hre,_re,dre,fre,pre,mre,vre,gre,yre,xre,Sre=function(){function e(){i(this,e),this._editing=!1,this._delegate=null}return r(e,[{key:"init",value:function(e){}},{key:"onEnable",value:function(){}},{key:"update",value:function(){}},{key:"onDisable",value:function(){this._editing&&this.endEditing()}},{key:"clear",value:function(){this._delegate=null}},{key:"setTabIndex",value:function(e){}},{key:"setSize",value:function(e,t){}},{key:"setFocus",value:function(e){e?this.beginEditing():this.endEditing()}},{key:"isFocused",value:function(){return this._editing}},{key:"beginEditing",value:function(){}},{key:"endEditing",value:function(){}}]),e}(),Tre=new Ta,Ere=new Ta,bre=new oa,Are=null,Cre=0,wre=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._delegate=null,n._inputMode=-1,n._inputFlag=-1,n._returnType=-1,n.__eventListeners={},n.__fullscreen=!1,n.__autoResize=!1,n.__orientationChanged=void 0,n._edTxt=null,n._isTextArea=!1,n._textLabelFont=null,n._textLabelFontSize=null,n._textLabelFontColor=null,n._textLabelAlign=null,n._placeholderLabelFont=null,n._placeholderLabelFontSize=null,n._placeholderLabelFontColor=null,n._placeholderLabelAlign=null,n._placeholderLineHeight=null,n._placeholderStyleSheet=null,n._domId="EditBoxId_".concat(++Cre),n}return o(t,e),r(t,[{key:"init",value:function(e){e&&(this._delegate=e,e.inputMode===cne.ANY?this._createTextArea():this._createInput(),_ne.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer(),this.__fullscreen=PO.isAutoFullScreenEnabled(),this.__autoResize=PO._resizeWithBrowserSize)}},{key:"clear",value:function(){this._removeEventListeners(),this._removeDomFromGameContainer(),_ne.remove(this),Are===this&&(Are=null),this._delegate=null}},{key:"update",value:function(){this._updateMatrix()}},{key:"setTabIndex",value:function(e){this._edTxt.tabIndex=e,_ne.resort()}},{key:"setSize",value:function(e,t){var i=this._edTxt;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"beginEditing",value:function(){Are&&Are!==this&&Are.setFocus(!1),this._editing=!0,Are=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()}},{key:"endEditing",value:function(){this._edTxt.blur()}},{key:"_createInput",value:function(){this._isTextArea=!1,this._edTxt=document.createElement("input")}},{key:"_createTextArea",value:function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")}},{key:"_addDomToGameContainer",value:function(){CO.container&&this._edTxt&&(CO.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))}},{key:"_removeDomFromGameContainer",value:function(){Xe(CO.container,this._edTxt)&&this._edTxt&&CO.container.removeChild(this._edTxt),Xe(document.head,this._placeholderStyleSheet)&&document.head.removeChild(this._placeholderStyleSheet),this._edTxt=null,delete this._placeholderStyleSheet}},{key:"_showDom",value:function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),Gn.isMobile&&this._showDomOnMobile()}},{key:"_hideDom",value:function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),Gn.isMobile&&this._hideDomOnMobile()}},{key:"_showDomOnMobile",value:function(){Gn.os===Gn.OS_ANDROID&&(this.__fullscreen&&(PO.enableAutoFullScreen(!1),nM.exitFullScreen()),this.__autoResize&&PO.resizeWithBrowserSize(!1),this._adjustWindowScroll())}},{key:"_hideDomOnMobile",value:function(){var e=this;Gn.os===Gn.OS_ANDROID&&(this.__autoResize&&PO.resizeWithBrowserSize(!0),setTimeout((function(){Are||e.__fullscreen&&PO.enableAutoFullScreen(!0)}),400)),this._scrollBackWindow()}},{key:"_adjustWindowScroll",value:function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)}},{key:"_scrollBackWindow",value:function(){setTimeout((function(){Gn.browserType!==Gn.BROWSER_TYPE_WECHAT||Gn.os!==Gn.OS_IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)}},{key:"_updateMatrix",value:function(){if(this._edTxt){var e=this._delegate.node,t=PO.getScaleX(),i=PO.getScaleY(),n=PO.getViewportRect(),r=PO.getDevicePixelRatio();e.getWorldMatrix(Tre);var a=e._uiProps.uiTransformComp;if(a&&oa.set(bre,-a.anchorX*a.width,-a.anchorY*a.height,bre.z),Ta.transform(Tre,Tre,bre),!e._uiProps.uiTransformComp)return!1;var o=AB.root.ui.getScreen(e._uiProps.uiTransformComp.visibility);if(o){o.node.getWorldRT(Ere);var s=Ere.m12,l=Ere.m13,c=mO.center;Ere.m12=c.x-(Ere.m00*s+Ere.m04*l),Ere.m13=c.y-(Ere.m01*s+Ere.m05*l),Ta.multiply(Ere,Ere,Tre),t/=r,i/=r;var u=CO.container,h=Ere.m00*t,_=Tre.m01,d=Tre.m04,f=Ere.m05*i,p=parseInt(u&&u.style.paddingLeft||"0");p+=n.x/r;var m=parseInt(u&&u.style.paddingBottom||"0");m+=n.y/r;var v="matrix("+h+","+-_+","+-d+","+f+","+(Ere.m12*t+p)+","+-(Ere.m13*i+m)+")";this._edTxt.style.transform=v,this._edTxt.style["-webkit-transform"]=v,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},{key:"_updateInputType",value:function(){var e=this._delegate,t=e.inputMode,i=e.inputFlag,n=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==i||this._returnType!==n){if(this._inputMode=t,this._inputFlag=i,this._returnType=n,this._isTextArea){var a="none";return i===une.INITIAL_CAPS_ALL_CHARACTERS?a="uppercase":i===une.INITIAL_CAPS_WORD&&(a="capitalize"),void(r.style.textTransform=a)}if(r=r,i!==une.PASSWORD){var o=r.type;t===cne.EMAIL_ADDR?o="email":t===cne.NUMERIC||t===cne.DECIMAL?o="number":t===cne.PHONE_NUMBER?(o="number",r.pattern="[0-9]*"):t===cne.URL?o="url":(o="text",n===lne.SEARCH&&(o="search")),r.type=o;var s="none";i===une.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":i===une.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}else r.type="password"}}},{key:"_updateMaxLength",value:function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e}},{key:"_initStyleSheet",value:function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="uppercase",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}}},{key:"_updateStyleSheet",value:function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))}},{key:"_updateTextLabel",value:function(e){if(e){var t=e.font;t=!t||t instanceof mI?e.fontFamily:t._fontFamily;var i=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==i||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=i,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var n=this._edTxt;switch(n.style.fontSize="".concat(i,"px"),n.style.color=e.color.toCSS("rgba"),n.style.fontFamily=t,e.horizontalAlign){case hne.HorizontalAlign.LEFT:n.style.textAlign="left";break;case hne.HorizontalAlign.CENTER:n.style.textAlign="center";break;case hne.HorizontalAlign.RIGHT:n.style.textAlign="right"}}}}},{key:"_updatePlaceholderLabel",value:function(e){if(e){var t=e.font;t=!t||t instanceof mI?e.fontFamily:e.font._fontFamily;var i=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==i||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=i,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var n=this._placeholderStyleSheet,r=e.color.toCSS("rgba"),a=e.fontSize,o="";switch(e.horizontalAlign){case hne.HorizontalAlign.LEFT:o="left";break;case hne.HorizontalAlign.CENTER:o="center";break;case hne.HorizontalAlign.RIGHT:o="right"}n.innerHTML="#".concat(this._domId,"::-webkit-input-placeholder{text-transform: initial;-family: ").concat(t,";font-size: ").concat(i,"px;color: ").concat(r,";line-height: ").concat(a,"px;text-align: ").concat(o,";}")+"#".concat(this._domId,"::-moz-placeholder{text-transform: initial;-family: ").concat(t,";font-size: ").concat(i,"px;color: ").concat(r,";line-height: ").concat(a,"px;text-align: ").concat(o,";}")+"#".concat(this._domId,"::-ms-input-placeholder{text-transform: initial;-family: ").concat(t,";font-size: ").concat(i,"px;color: ").concat(r,";line-height: ").concat(a,"px;text-align: ").concat(o,";}"),E.sys.browserType===E.sys.BROWSER_TYPE_EDGE&&(n.innerHTML+="#".concat(this._domId,"::-ms-clear{display: none;}"))}}}},{key:"_registerEventListeners",value:function(){if(this._edTxt){var e=this,t=this._edTxt,i=!1,n=this.__eventListeners;n.compositionStart=function(){i=!0},n.compositionEnd=function(){i=!1,e._delegate._editBoxTextChanged(t.value)},n.onInput=function(){if(!i){var n=e._delegate,r=n.maxLength;r>=0&&(t.value=t.value.slice(0,r)),n._editBoxTextChanged(t.value)}},n.onClick=function(){e._editing&&Gn.isMobile&&e._adjustWindowScroll()},n.onKeydown=function(i){i.keyCode===Sh.KEY.enter?(i.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):i.keyCode===Sh.KEY.tab&&(i.propagationStopped=!0,i.preventDefault(),_ne.next(e))},n.onBlur=function(){Gn.isMobile&&i&&n.compositionEnd(),e._editing=!1,Are=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",n.compositionStart),t.addEventListener("compositionend",n.compositionEnd),t.addEventListener("input",n.onInput),t.addEventListener("keydown",n.onKeydown),t.addEventListener("blur",n.onBlur),t.addEventListener("touchstart",n.onClick)}}},{key:"_removeEventListeners",value:function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}}}]),t}(Sre);function Rre(e){return e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()}))}function Ire(e){return e.charAt(0).toUpperCase()+e.slice(1)}!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(xre||(xre={}));var Ore,Mre,Pre,kre,Dre,Bre,Lre,Nre,Fre,zre,Ure,Gre,Hre,Vre,Wre,jre,qre,Xre,Yre,Kre,Zre,Qre,Jre,$re,eae,tae,iae,nae,rae,aae,oae,sae,lae,cae,uae,hae,_ae,dae,fae,pae,mae,vae,gae=e("EditBoxComponent",(dne=ii("cc.EditBox"),fne=mi("i18n:cc.EditBox"),pne=ri(100),mne=_i("UI/EditBox"),vne=ni(jv),gne=wi(1),yne=Si(""),xne=wi(2),Sne=Si(""),Tne=Li(hne),Ene=wi(3),bne=Si(" Label "),Ane=Li(hne),Cne=wi(4),wne=Si(" Label "),Rne=Li(Pd),Ine=wi(5),One=Si(""),Mne=Li(une),Pne=wi(6),kne=Si(""),Dne=Li(cne),Bne=wi(7),Lne=Si(": ANY "),Nne=Li(lne),Fne=wi(8),zne=Si(""),Une=wi(9),Gne=Si(""),Hne=wi(10),Vne=Si(" DOM  tabIndex Web "),Wne=Li([CB]),jne=wi(11),qne=Si(""),Xne=Li([CB]),Yne=wi(12),Kne=Si(""),Zne=Li([CB]),Qne=wi(13),Jne=Si(" "),$ne=Li([CB]),ere=wi(14),tre=Si(", "),dne(ire=fne(ire=pne(ire=mne(ire=vne(ire=hi((yre=gre=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"editingDidBegan",rre,c(n)),x(n,"textChanged",are,c(n)),x(n,"editingDidEnded",ore,c(n)),x(n,"editingReturn",sre,c(n)),n._impl=null,n._background=null,x(n,"_textLabel",lre,c(n)),x(n,"_placeholderLabel",cre,c(n)),x(n,"_returnType",ure,c(n)),x(n,"_useOriginalSize",hre,c(n)),x(n,"_string",_re,c(n)),x(n,"_tabIndex",dre,c(n)),x(n,"_backgroundImage",fre,c(n)),x(n,"_inputFlag",pre,c(n)),x(n,"_inputMode",mre,c(n)),x(n,"_maxLength",vre,c(n)),n._isLabelVisible=!1,n}return o(t,e),r(t,[{key:"__preload",value:function(){this._init()}},{key:"onEnable",value:function(){this._registerEvent(),this._impl&&this._impl.onEnable()}},{key:"update",value:function(){this._impl&&this._impl.update()}},{key:"onDisable",value:function(){this._unregisterEvent(),this._impl&&this._impl.onDisable()}},{key:"onDestroy",value:function(){this._impl&&this._impl.clear()}},{key:"setFocus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"focus",value:function(){this._impl&&this._impl.setFocus(!0)}},{key:"blur",value:function(){this._impl&&this._impl.setFocus(!1)}},{key:"isFocused",value:function(){return!!this._impl&&this._impl.isFocused()}},{key:"_editBoxEditingDidBegan",value:function(){CB.emitEvents(this.editingDidBegan,this),this.node.emit(xre.EDITING_DID_BEGAN,this)}},{key:"_editBoxEditingDidEnded",value:function(){CB.emitEvents(this.editingDidEnded,this),this.node.emit(xre.EDITING_DID_ENDED,this)}},{key:"_editBoxTextChanged",value:function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,CB.emitEvents(this.textChanged,e,this),this.node.emit(xre.TEXT_CHANGED,this)}},{key:"_editBoxEditingReturn",value:function(){CB.emitEvents(this.editingReturn,this),this.node.emit(xre.EDITING_RETURN,this)}},{key:"_showLabels",value:function(){this._isLabelVisible=!0,this._updateLabels()}},{key:"_hideLabels",value:function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}},{key:"_onTouchBegan",value:function(e){e.propagationStopped=!0}},{key:"_onTouchCancel",value:function(e){e.propagationStopped=!0}},{key:"_onTouchEnded",value:function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0}},{key:"_init",value:function(){this._createBackgroundSprite(),this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(lm.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}},{key:"_createBackgroundSprite",value:function(){this._background||(this._background=this.node.getComponent(Dk),this._background||(this._background=this.node.addComponent(Dk))),this._background.type=Dk.Type.SLICED,this._background.spriteFrame=this._backgroundImage}},{key:"_updateTextLabel",value:function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||(t=new ig("TEXT_LABEL")),(e=t.getComponent(hne))||(e=t.addComponent(hne)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=hne.Overflow.CLAMP,this._inputMode===cne.ANY?(e.verticalAlign=nne.TOP,e.enableWrapText=!0):(e.verticalAlign=nne.CENTER,e.enableWrapText=!1),e.string=this._updateLabelStringStyle(this._string)}},{key:"_updatePlaceholderLabel",value:function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||(t=new ig("PLACEHOLDER_LABEL")),(e=t.getComponent(hne))||(e=t.addComponent(hne)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=hne.Overflow.CLAMP,this._inputMode===cne.ANY?(e.verticalAlign=nne.TOP,e.enableWrapText=!0):(e.verticalAlign=nne.CENTER,e.enableWrapText=!1),e.string=this.placeholder}},{key:"_syncSize",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var i=this._background.node._uiProps.uiTransformComp;i.anchorPoint=e.anchorPoint,i.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)}},{key:"_updateLabels",value:function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}}},{key:"_updateString",value:function(e){var t=this._textLabel;if(t){var i=e;i&&(i=this._updateLabelStringStyle(i)),t.string=i,this._updateLabels()}}},{key:"_updateLabelStringStyle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=this._inputFlag;if(t||i!==une.PASSWORD)i===une.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===une.INITIAL_CAPS_WORD?e=Rre(e):i===une.INITIAL_CAPS_SENTENCE&&(e=Ire(e));else{for(var n="",r=e.length,a=0;a<r;++a)n+="";e=n}return e}},{key:"_registerEvent",value:function(){this.node.on(lm.TOUCH_START,this._onTouchBegan,this),this.node.on(lm.TOUCH_END,this._onTouchEnded,this)}},{key:"_unregisterEvent",value:function(){this.node.off(lm.TOUCH_START,this._onTouchBegan,this),this.node.off(lm.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelPosition",value:function(e){var t=this.node._uiProps.uiTransformComp,i=-t.anchorX*t.width,n=-t.anchorY*t.height,r=this._placeholderLabel,a=this._textLabel;a&&(a.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),a.node.position=new oa(i+2,n+e.height,a.node.position.z),a.verticalAlign=this._inputMode===cne.ANY?nne.TOP:nne.CENTER,a.enableWrapText=this._inputMode===cne.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.position=new oa(i+2,n+e.height,r.node.position.z),r.verticalAlign=this._inputMode===cne.ANY?nne.TOP:nne.CENTER,r.enableWrapText=this._inputMode===cne.ANY)}},{key:"_resizeChildNodes",value:function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.position=new oa(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._placeholderLabel&&this._placeholderLabel.node;i&&(i.position=new oa(-e.width/2,e.height/2,i.position.z),i._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._background&&this._background.node;n&&n._uiProps.uiTransformComp.setContentSize(e.contentSize)}},{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._createBackgroundSprite())}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(Yr),gre._EditBoxImpl=Sre,gre.KeyboardReturnType=lne,gre.InputFlag=une,gre.InputMode=cne,gre.EventType=xre,S((nre=yre).prototype,"string",[gne,yne],Object.getOwnPropertyDescriptor(nre.prototype,"string"),nre.prototype),S(nre.prototype,"placeholder",[xne,Sne],Object.getOwnPropertyDescriptor(nre.prototype,"placeholder"),nre.prototype),S(nre.prototype,"textLabel",[Tne,Ene,bne],Object.getOwnPropertyDescriptor(nre.prototype,"textLabel"),nre.prototype),S(nre.prototype,"placeholderLabel",[Ane,Cne,wne],Object.getOwnPropertyDescriptor(nre.prototype,"placeholderLabel"),nre.prototype),S(nre.prototype,"backgroundImage",[Rne,Ine,One],Object.getOwnPropertyDescriptor(nre.prototype,"backgroundImage"),nre.prototype),S(nre.prototype,"inputFlag",[Mne,Pne,kne],Object.getOwnPropertyDescriptor(nre.prototype,"inputFlag"),nre.prototype),S(nre.prototype,"inputMode",[Dne,Bne,Lne],Object.getOwnPropertyDescriptor(nre.prototype,"inputMode"),nre.prototype),S(nre.prototype,"returnType",[Nne,Fne,zne],Object.getOwnPropertyDescriptor(nre.prototype,"returnType"),nre.prototype),S(nre.prototype,"maxLength",[Une,Gne],Object.getOwnPropertyDescriptor(nre.prototype,"maxLength"),nre.prototype),S(nre.prototype,"tabIndex",[Hne,Vne],Object.getOwnPropertyDescriptor(nre.prototype,"tabIndex"),nre.prototype),rre=S(nre.prototype,"editingDidBegan",[Wne,jne,qne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),are=S(nre.prototype,"textChanged",[Xne,si,Yne,Kne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ore=S(nre.prototype,"editingDidEnded",[Zne,si,Qne,Jne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sre=S(nre.prototype,"editingReturn",[$ne,si,ere,tre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lre=S(nre.prototype,"_textLabel",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cre=S(nre.prototype,"_placeholderLabel",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ure=S(nre.prototype,"_returnType",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lne.DEFAULT}}),hre=S(nre.prototype,"_useOriginalSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_re=S(nre.prototype,"_string",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dre=S(nre.prototype,"_tabIndex",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fre=S(nre.prototype,"_backgroundImage",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pre=S(nre.prototype,"_inputFlag",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return une.DEFAULT}}),mre=S(nre.prototype,"_inputMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cne.ANY}}),vre=S(nre.prototype,"_maxLength",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),ire=nre))||ire)||ire)||ire)||ire)||ire)||ire));Gn.isBrowser&&(gae._EditBoxImpl=wre);var yae,xae,Sae,Tae,Eae,bae=lm;!function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(yae||(yae={})),nt(yae),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(xae||(xae={})),nt(xae),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Sae||(Sae={})),nt(Sae),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(Tae||(Tae={})),nt(Tae),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(Eae||(Eae={})),nt(Eae);var Aae,Cae,wae,Rae,Iae,Oae,Mae,Pae,kae,Dae,Bae,Lae,Nae,Fae,zae,Uae,Gae,Hae,Vae,Wae,jae,qae,Xae,Yae,Kae,Zae=new oa,Qae=new oa,Jae=e("LayoutComponent",(Ore=ii("cc.Layout"),Mre=mi("i18n:cc.Layout"),Pre=ri(110),kre=_i("UI/Layout"),Dre=ni(jv),Bre=Li(yae),Lre=Si("\n 1. NONE \n 2. HORIZONTAL \n 3. VERTICAL\n 4. GRID, "),Nre=Li(xae),Fre=Si("\n 1. NONE \n 2. CONTAINER,  \n 3. CHILDREN, "),zre=Si(" GRID "),Ure=Li(Sae),Gre=Si(" GRID "),Hre=Si(""),Vre=Si(""),Wre=Si(""),jre=Si(""),qre=Si(""),Xre=Si(""),Yre=Li(Tae),Kre=Si(""),Zre=Li(Eae),Qre=Si(""),Jre=Si(""),$re=Si(""),Ore(eae=Mre(eae=Pre(eae=kre(eae=Dre(eae=hi((vae=mae=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_resizeMode",iae,c(n)),x(n,"_N$layoutType",nae,c(n)),x(n,"_N$padding",rae,c(n)),x(n,"_cellSize",aae,c(n)),x(n,"_startAxis",oae,c(n)),x(n,"_paddingLeft",sae,c(n)),x(n,"_paddingRight",lae,c(n)),x(n,"_paddingTop",cae,c(n)),x(n,"_paddingBottom",uae,c(n)),x(n,"_spacingX",hae,c(n)),x(n,"_spacingY",_ae,c(n)),x(n,"_verticalDirection",dae,c(n)),x(n,"_horizontalDirection",fae,c(n)),x(n,"_affectedByScale",pae,c(n)),n._layoutSize=new wa(300,200),n._layoutDirty=!0,n._isAlign=!1,n}return o(t,e),r(t,[{key:"updateLayout",value:function(){this._layoutDirty&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}},{key:"onEnable",value:function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(wa.ZERO)&&e.setContentSize(this._layoutSize),0!==this._N$padding&&this._migratePaddingData(),this._doLayoutDirty()}},{key:"onDisable",value:function(){this._removeEventListeners()}},{key:"_migratePaddingData",value:function(){this._paddingLeft=this._N$padding,this._paddingRight=this._N$padding,this._paddingTop=this._N$padding,this._paddingBottom=this._N$padding,this._N$padding=0}},{key:"_addEventListeners",value:function(){AB.on(iB.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(bae.SIZE_CHANGED,this._resized,this),this.node.on(bae.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(bae.CHILD_ADDED,this._childAdded,this),this.node.on(bae.CHILD_REMOVED,this._childRemoved,this),this._addChildrenEventListeners()}},{key:"_removeEventListeners",value:function(){AB.off(iB.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(bae.SIZE_CHANGED,this._resized,this),this.node.off(bae.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(bae.CHILD_ADDED,this._childAdded,this),this.node.off(bae.CHILD_REMOVED,this._childRemoved,this),this._removeChildrenEventListeners()}},{key:"_addChildrenEventListeners",value:function(){for(var e=this.node.children,t=0;t<e.length;++t){var i=e[t];i.on(bae.TRANSFORM_CHANGED,this._doScaleDirty,this),i.on(bae.SIZE_CHANGED,this._doLayoutDirty,this),i.on(bae.TRANSFORM_CHANGED,this._transformDirty,this),i.on(bae.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_removeChildrenEventListeners",value:function(){for(var e=this.node.children,t=0;t<e.length;++t){var i=e[t];i.off(bae.TRANSFORM_CHANGED,this._doScaleDirty,this),i.off(bae.SIZE_CHANGED,this._doLayoutDirty,this),i.off(bae.TRANSFORM_CHANGED,this._transformDirty,this),i.off(bae.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off("active-in-hierarchy-changed",this._doLayoutDirty,this)}}},{key:"_childAdded",value:function(e){e.on(bae.TRANSFORM_CHANGED,this._doScaleDirty,this),e.on(bae.SIZE_CHANGED,this._doLayoutDirty,this),e.on(bae.TRANSFORM_CHANGED,this._transformDirty,this),e.on(bae.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_childRemoved",value:function(e){e.off(bae.TRANSFORM_CHANGED,this._doScaleDirty,this),e.off(bae.SIZE_CHANGED,this._doLayoutDirty,this),e.off(bae.TRANSFORM_CHANGED,this._transformDirty,this),e.off(bae.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off("active-in-hierarchy-changed",this._doLayoutDirty,this),this._doLayoutDirty()}},{key:"_resized",value:function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}},{key:"_doLayoutHorizontally",value:function(e,t,i,n){var r=this.node._uiProps.uiTransformComp,a=r.anchorPoint,o=this.node.children,s=1,l=this._paddingLeft,c=-a.x*e;this._horizontalDirection===Eae.RIGHT_TO_LEFT&&(s=-1,c=(1-a.x)*e,l=this._paddingRight);for(var u=c+s*l-s*this._spacingX,h=0,_=0,d=0,f=0,p=0,m=0,v=0,g=0;g<o.length;++g)o[g].activeInHierarchy&&v++;var y=this._cellSize.width;this._N$layoutType!==yae.GRID&&this._resizeMode===xae.CHILDREN&&(y=(e-(this._paddingLeft+this._paddingRight)-(v-1)*this._spacingX)/v);for(var x=0;x<o.length;++x){var S=o[x],T=S._uiProps.uiTransformComp;if(S.activeInHierarchy&&T){S.getScale(Qae);var E=this._getUsedScaleValue(Qae.x),b=this._getUsedScaleValue(Qae.y);this._resizeMode===xae.CHILDREN&&(T.width=y/E,this._N$layoutType===yae.GRID&&(T.height=this._cellSize.height/b));var A=T.anchorX,C=T.width*E,w=T.height*b;d>_&&(_=d),w>=_&&(d=_,_=w,m=T.anchorY),this._horizontalDirection===Eae.RIGHT_TO_LEFT&&(A=1-T.anchorX),u=u+s*A*C+s*this._spacingX;var R=s*(1-A)*C;if(t){var I=u+R+s*(s>0?this._paddingRight:this._paddingLeft),O=!1;this._horizontalDirection===Eae.LEFT_TO_RIGHT&&I>(1-a.x)*e&&(O=!0);var M=!1;this._horizontalDirection===Eae.RIGHT_TO_LEFT&&I<-a.x*e&&(M=!0),(O||M)&&(w>=_?(0===d&&(d=_),h+=d,d=_):(h+=_,d=w,_=0),u=c+s*(l+A*C),f++)}var P=i(S,T,h,f);e>=C+this._paddingLeft+this._paddingRight&&n&&(S.getPosition(Zae),S.setPosition(u,P,Zae.z));var k=1,D=void 0,B=0===_?w:_;this._verticalDirection===Tae.TOP_TO_BOTTOM?(p=p||r.height,(D=P+(k=-1)*(B*m+this._paddingBottom))<p&&(p=D)):(p=p||-r.height,(D=P+k*(B*m+this._paddingTop))>p&&(p=D)),u+=R}}return p}},{key:"_doLayoutVertically",value:function(e,t,i,n){var r=this.node._uiProps.uiTransformComp,a=r.anchorPoint,o=this.node.children,s=1,l=this._paddingBottom,c=-a.y*e;this._verticalDirection===Tae.TOP_TO_BOTTOM&&(s=-1,c=(1-a.y)*e,l=this._paddingTop);for(var u=c+s*l-s*this._spacingY,h=0,_=0,d=0,f=0,p=0,m=0,v=0,g=0;g<o.length;++g)o[g].activeInHierarchy&&v++;var y=this._cellSize.height;this._N$layoutType!==yae.GRID&&this._resizeMode===xae.CHILDREN&&(y=(e-(this._paddingTop+this._paddingBottom)-(v-1)*this._spacingY)/v);for(var x=0;x<o.length;++x){var S=o[x];if(S){var T=S.getScale(),E=this._getUsedScaleValue(T.x),b=this._getUsedScaleValue(T.y),A=S._uiProps.uiTransformComp;if(S.activeInHierarchy&&A){this._resizeMode===xae.CHILDREN&&(A.height=y/b,this._N$layoutType===yae.GRID&&(A.width=this._cellSize.width/E));var C=A.anchorY,w=A.width*E,R=A.height*b;d>_&&(_=d),w>=_&&(d=_,_=w,m=A.anchorX),this._verticalDirection===Tae.TOP_TO_BOTTOM&&(C=1-A.anchorY),u=u+s*C*R+s*this._spacingY;var I=s*(1-C)*R;if(t){var O=u+I+s*(s>0?this._paddingTop:this._paddingBottom),M=!1;this._verticalDirection===Tae.BOTTOM_TO_TOP&&O>(1-a.y)*e&&(M=!0);var P=!1;this._verticalDirection===Tae.TOP_TO_BOTTOM&&O<-a.y*e&&(P=!0),(M||P)&&(w>=_?(0===d&&(d=_),h+=d,d=_):(h+=_,d=w,_=0),u=c+s*(l+C*R),f++)}var k=i(S,A,h,f);e>=R+(this._paddingTop+this._paddingBottom)&&n&&(S.getPosition(Zae),S.setPosition(k,u,Zae.z));var D=1,B=void 0,L=0===_?w:_;this._horizontalDirection===Eae.RIGHT_TO_LEFT?(D=-1,p=p||r.width,(B=k+D*(L*m+this._paddingLeft))<p&&(p=B)):(p=p||-r.width,(B=k+D*(L*m+this._paddingRight))>p&&(p=B)),u+=I}}}return p}},{key:"_doLayoutBasic",value:function(){for(var e=this.node.children,t=null,i=0;i<e.length;++i){var n=e[i],r=n._uiProps.uiTransformComp;r&&(n.activeInHierarchy&&(t?Ia.union(t,t,r.getBoundingBoxToWorld()):t=r.getBoundingBoxToWorld()))}if(t){var a=this.node.parent.getComponent(jv);if(!a)return;oa.set(Zae,t.x,t.y,0);var o=new oa;a.convertToNodeSpaceAR(Zae,o),oa.set(o,o.x-this._paddingLeft,o.y-this._paddingBottom,o.z),oa.set(Zae,t.x+t.width,t.y+t.height,0);var s=new oa;a.convertToNodeSpaceAR(Zae,s),oa.set(s,s.x+this._paddingRight,s.y+this._paddingTop,s.z);var l=E.size(parseFloat((s.x-o.x).toFixed(2)),parseFloat((s.y-o.y).toFixed(2)));this.node.getPosition(Zae);var c=this.node._uiProps.uiTransformComp;if(0!==l.width){var u=(Zae.x-o.x)/l.width;c.anchorX=parseFloat(u.toFixed(2))}if(0!==l.height){var h=(Zae.y-o.y)/l.height;c.anchorY=parseFloat(h.toFixed(2))}c.setContentSize(l)}}},{key:"_doLayoutGridAxisHorizontal",value:function(e,t){var i=this,n=t.width,r=1,a=-e.y*t.height,o=this._paddingBottom;this._verticalDirection===Tae.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*t.height,o=this._paddingTop);var s=this,l=function(e,t,n,l){return a+r*(n+t.anchorY*t.height*s._getUsedScaleValue(e.getScale().y)+o+l*i._spacingY)},c=0;if(this._resizeMode===xae.CONTAINER){var u=this._doLayoutHorizontally(n,!0,l,!1);(c=a-u)<0&&(c*=-1),a=-e.y*c,this._verticalDirection===Tae.TOP_TO_BOTTOM&&(r=-1,a=(1-e.y)*c)}this._doLayoutHorizontally(n,!0,l,!0),this._resizeMode===xae.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(n,c)}},{key:"_doLayoutGridAxisVertical",value:function(e,t){var i=this,n=t.height,r=1,a=-e.x*t.width,o=this._paddingLeft;this._horizontalDirection===Eae.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*t.width,o=this._paddingRight);var s=this,l=function(e,t,n,l){return a+r*(n+t.anchorX*t.width*s._getUsedScaleValue(e.getScale().x)+o+l*i._spacingX)},c=0;if(this._resizeMode===xae.CONTAINER){var u=this._doLayoutVertically(n,!0,l,!1);(c=a-u)<0&&(c*=-1),a=-e.x*c,this._horizontalDirection===Eae.RIGHT_TO_LEFT&&(r=-1,a=(1-e.x)*c)}this._doLayoutVertically(n,!0,l,!0),this._resizeMode===xae.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,n)}},{key:"_doLayoutGrid",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,i=e.contentSize;this.startAxis===Sae.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,i):this.startAxis===Sae.VERTICAL&&this._doLayoutGridAxisVertical(t,i)}},{key:"_getHorizontalBaseWidth",value:function(e){var t=0,i=0;if(this._resizeMode===xae.CONTAINER){for(var n=0;n<e.length;++n){var r=e[n];r.getScale(Qae);var a=r._uiProps.uiTransformComp;r.activeInHierarchy&&a&&(i++,t+=a.width*this._getUsedScaleValue(Qae.x))}t+=(i-1)*this._spacingX+this._paddingLeft+this._paddingRight}else t=this.node._uiProps.uiTransformComp.width;return t}},{key:"_getVerticalBaseHeight",value:function(e){var t=0,i=0;if(this._resizeMode===xae.CONTAINER){for(var n=0;n<e.length;++n){var r=e[n];r.getScale(Qae);var a=r._uiProps.uiTransformComp;r.activeInHierarchy&&a&&(i++,t+=a.height*this._getUsedScaleValue(Qae.y))}t+=(i-1)*this._spacingY+this._paddingBottom+this._paddingTop}else t=this.node._uiProps.uiTransformComp.height;return t}},{key:"_doLayout",value:function(){var e=this;if(this._N$layoutType===yae.HORIZONTAL){var t=this._getHorizontalBaseWidth(this.node.children);this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?oa.ZERO:t.position).y}),!0),this._isAlign=!1,this.node._uiProps.uiTransformComp.width=t}else if(this._N$layoutType===yae.VERTICAL){var i=this._getVerticalBaseHeight(this.node.children);this._doLayoutVertically(i,!1,(function(t){return(e._isAlign?oa.ZERO:t.position).x}),!0),this._isAlign=!1,this.node._uiProps.uiTransformComp.height=i}else this._N$layoutType===yae.NONE?this._resizeMode===xae.CONTAINER&&this._doLayoutBasic():this._N$layoutType===yae.GRID&&this._doLayoutGrid()}},{key:"_getUsedScaleValue",value:function(e){return this._affectedByScale?Math.abs(e):1}},{key:"_transformDirty",value:function(e){e&nv.POSITION&&this._doLayoutDirty()}},{key:"_doLayoutDirty",value:function(){this._layoutDirty=!0}},{key:"_doScaleDirty",value:function(e){e&nv.SCALE&&(this._layoutDirty=this._layoutDirty||this._affectedByScale)}},{key:"type",get:function(){return this._N$layoutType},set:function(e){this._N$layoutType=e,this._isAlign=!0,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._N$layoutType===yae.NONE&&e===xae.CHILDREN||(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this._N$padding=e,this._migratePaddingData(),this._doLayoutDirty()}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(Yr),mae.Type=yae,mae.VerticalDirection=Tae,mae.HorizontalDirection=Eae,mae.ResizeMode=xae,mae.AxisDirection=Sae,S((tae=vae).prototype,"type",[Bre,Lre],Object.getOwnPropertyDescriptor(tae.prototype,"type"),tae.prototype),S(tae.prototype,"resizeMode",[Nre,Fre],Object.getOwnPropertyDescriptor(tae.prototype,"resizeMode"),tae.prototype),S(tae.prototype,"cellSize",[zre],Object.getOwnPropertyDescriptor(tae.prototype,"cellSize"),tae.prototype),S(tae.prototype,"startAxis",[Ure,Gre],Object.getOwnPropertyDescriptor(tae.prototype,"startAxis"),tae.prototype),S(tae.prototype,"paddingLeft",[Hre],Object.getOwnPropertyDescriptor(tae.prototype,"paddingLeft"),tae.prototype),S(tae.prototype,"paddingRight",[Vre],Object.getOwnPropertyDescriptor(tae.prototype,"paddingRight"),tae.prototype),S(tae.prototype,"paddingTop",[Wre],Object.getOwnPropertyDescriptor(tae.prototype,"paddingTop"),tae.prototype),S(tae.prototype,"paddingBottom",[jre],Object.getOwnPropertyDescriptor(tae.prototype,"paddingBottom"),tae.prototype),S(tae.prototype,"spacingX",[qre],Object.getOwnPropertyDescriptor(tae.prototype,"spacingX"),tae.prototype),S(tae.prototype,"spacingY",[Xre],Object.getOwnPropertyDescriptor(tae.prototype,"spacingY"),tae.prototype),S(tae.prototype,"verticalDirection",[Yre,Kre],Object.getOwnPropertyDescriptor(tae.prototype,"verticalDirection"),tae.prototype),S(tae.prototype,"horizontalDirection",[Zre,Qre],Object.getOwnPropertyDescriptor(tae.prototype,"horizontalDirection"),tae.prototype),S(tae.prototype,"padding",[Jre],Object.getOwnPropertyDescriptor(tae.prototype,"padding"),tae.prototype),S(tae.prototype,"affectedByScale",[$re],Object.getOwnPropertyDescriptor(tae.prototype,"affectedByScale"),tae.prototype),iae=S(tae.prototype,"_resizeMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xae.NONE}}),nae=S(tae.prototype,"_N$layoutType",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yae.NONE}}),rae=S(tae.prototype,"_N$padding",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aae=S(tae.prototype,"_cellSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wa(40,40)}}),oae=S(tae.prototype,"_startAxis",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sae.HORIZONTAL}}),sae=S(tae.prototype,"_paddingLeft",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),lae=S(tae.prototype,"_paddingRight",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cae=S(tae.prototype,"_paddingTop",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uae=S(tae.prototype,"_paddingBottom",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hae=S(tae.prototype,"_spacingX",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_ae=S(tae.prototype,"_spacingY",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dae=S(tae.prototype,"_verticalDirection",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tae.TOP_TO_BOTTOM}}),fae=S(tae.prototype,"_horizontalDirection",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eae.LEFT_TO_RIGHT}}),pae=S(tae.prototype,"_affectedByScale",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eae=tae))||eae)||eae)||eae)||eae)||eae)||eae));!function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(Aae||(Aae={})),nt(Aae),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(Cae||(Cae={})),nt(Cae),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(wae||(wae={})),nt(wae);var $ae,eoe,toe,ioe,noe,roe,aoe,ooe,soe,loe,coe,uoe,hoe,_oe,doe,foe,poe,moe,voe,goe={parent:null,owner:null,subModelIdx:0},yoe=UD.concat([new al("a_dist",jo.R32F)]),xoe=VD(yoe),Soe=e("GraphicsComponent",(Rae=ii("cc.Graphics"),Iae=mi("i18n:cc.Graphics"),Oae=ri(110),Mae=_i("UI/Render/Graphics"),Pae=Li(Cae),kae=Si(""),Dae=Li(Aae),Bae=Si(""),Lae=Si(""),Nae=Si(""),Fae=Si(""),zae=gi(!1),Rae(Uae=Iae(Uae=Oae(Uae=Mae((Kae=Yae=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this))).impl=null,e.model=null,x(e,"_lineWidth",Hae,c(e)),x(e,"_strokeColor",Vae,c(e)),x(e,"_lineJoin",Wae,c(e)),x(e,"_lineCap",jae,c(e)),x(e,"_fillColor",qae,c(e)),x(e,"_miterLimit",Xae,c(e)),e._isDrawing=!1,e._renderingMeshCache=[],e._instanceMaterialType=iM.ADD_COLOR,e._uiMaterialDirty=!0,e}return o(t,e),r(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}}]),r(t,[{key:"onRestore",value:function(){this.impl||this._flushAssembler()}},{key:"__preload",value:function(){_(s(t.prototype),"__preload",this).call(this),this.impl=this._assembler&&this._assembler.createImpl(this)}},{key:"onLoad",value:function(){this._sceneGetter=AB.root.ui.getRenderSceneGetter(),this._rebuildModel(),this.helpInstanceMaterial()}},{key:"onDisable",value:function(){this._detachFromScene()}},{key:"onDestroy",value:function(){if(_(s(t.prototype),"onDestroy",this).call(this),this._sceneGetter=null,this.model&&(this.model.destroy(),AB.root.destroyModel(this.model),this.model=null),this._renderingMeshCache.length>0){for(var e=this._renderingMeshCache.length,i=0;i<e;i++){var n,r=this._renderingMeshCache[i];r.vertexBuffers[0].destroy(),null===(n=r.indexBuffer)||void 0===n||n.destroy(),r.destroy()}this._renderingMeshCache.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)}},{key:"moveTo",value:function(e,t){this.impl&&this.impl.moveTo(e,t)}},{key:"lineTo",value:function(e,t){this.impl&&this.impl.lineTo(e,t)}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){this.impl&&this.impl.bezierCurveTo(e,t,i,n,r,a)}},{key:"quadraticCurveTo",value:function(e,t,i,n){this.impl&&this.impl.quadraticCurveTo(e,t,i,n)}},{key:"arc",value:function(e,t,i,n,r,a){this.impl&&this.impl.arc(e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){this.impl&&this.impl.ellipse(e,t,i,n)}},{key:"circle",value:function(e,t,i){this.impl&&this.impl.circle(e,t,i)}},{key:"rect",value:function(e,t,i,n){this.impl&&this.impl.rect(e,t,i,n)}},{key:"roundRect",value:function(e,t,i,n,r){this.impl&&this.impl.roundRect(e,t,i,n,r)}},{key:"fillRect",value:function(e,t,i,n){this.rect(e,t,i,n),this.fill()}},{key:"clear",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.impl&&(this.impl.clear(e),this._isDrawing=!1,this.model&&(this.model.destroy(),this._rebuildModel()),this._detachFromScene(),this.markForUpdateRenderData())}},{key:"close",value:function(){this.impl&&this.impl.close()}},{key:"stroke",value:function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._assembler.stroke(this),this._attachToScene()}},{key:"fill",value:function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._assembler.fill(this),this._attachToScene()}},{key:"helpInstanceMaterial",value:function(){var e=null;goe.owner=this,this.sharedMaterial?(goe.parent=this.sharedMaterial[0],e=new um(goe)):(goe.parent=tf.get("ui-graphics-material"),(e=new um(goe)).recompileShaders({USE_LOCAL:!0})),this._uiMaterial=goe.parent,this._uiMaterialIns=e,this.impl||(this._flushAssembler(),this.impl=this._assembler&&this._assembler.createImpl(this))}},{key:"activeSubModel",value:function(e){if(this.model){if(this.model.subModels.length<=e){var t,i=this._renderingMeshCache.length;if(i>0&&i>e)t=this._renderingMeshCache[e];else{var n=E.director.root.device,r=n.createBuffer(new qs(qo.VERTEX|qo.TRANSFER_DST,Xo.DEVICE,65535*xoe,xoe)),a=n.createBuffer(new qs(qo.INDEX|qo.TRANSFER_DST,Xo.DEVICE,131070,2));(t=new K_([r],yoe,Zo.TRIANGLE_LIST,a)).subMeshIdx=0,this._renderingMeshCache.push(t)}this.model.initSubModel(e,t,this.getUIMaterialInstance())}}else console.warn("There is no model in ".concat(this.node.name))}},{key:"_render",value:function(e){e.commitModel(this,this.model,this._uiMaterialIns)}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}},{key:"_canRender",value:function(){return!!_(s(t.prototype),"_canRender",this).call(this)&&(!!this.model&&this._isDrawing)}},{key:"_attachToScene",value:function(){var e=AB.root.ui.renderScene;this.model&&this.model.scene!==e&&(null!==this.model.scene&&this._detachFromScene(),e.addModel(this.model))}},{key:"_detachFromScene",value:function(){this.model&&this.model.scene&&(this.model.scene.removeModel(this.model),this.model.scene=null)}},{key:"_rebuildModel",value:function(){this.model?this.model.inited||this.model.initialize():(this.model=AB.root.createModel(zb),this.model.node=this.model.transform=this.node)}}]),t}(YM),Yae.LineJoin=Cae,Yae.LineCap=Aae,S((Gae=Kae).prototype,"lineWidth",[vi],Object.getOwnPropertyDescriptor(Gae.prototype,"lineWidth"),Gae.prototype),S(Gae.prototype,"lineJoin",[Pae,kae],Object.getOwnPropertyDescriptor(Gae.prototype,"lineJoin"),Gae.prototype),S(Gae.prototype,"lineCap",[Dae,Bae],Object.getOwnPropertyDescriptor(Gae.prototype,"lineCap"),Gae.prototype),S(Gae.prototype,"strokeColor",[Lae],Object.getOwnPropertyDescriptor(Gae.prototype,"strokeColor"),Gae.prototype),S(Gae.prototype,"fillColor",[Nae],Object.getOwnPropertyDescriptor(Gae.prototype,"fillColor"),Gae.prototype),S(Gae.prototype,"miterLimit",[Fae],Object.getOwnPropertyDescriptor(Gae.prototype,"miterLimit"),Gae.prototype),S(Gae.prototype,"color",[Ni,zae],Object.getOwnPropertyDescriptor(Gae.prototype,"color"),Gae.prototype),Hae=S(Gae.prototype,"_lineWidth",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Vae=S(Gae.prototype,"_strokeColor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.BLACK.clone()}}),Wae=S(Gae.prototype,"_lineJoin",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cae.MITER}}),jae=S(Gae.prototype,"_lineCap",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Aae.BUTT}}),qae=S(Gae.prototype,"_fillColor",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ma.WHITE.clone()}}),Xae=S(Gae.prototype,"_miterLimit",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Uae=Gae))||Uae)||Uae)||Uae)||Uae)),Toe=new Ta,Eoe=new ia,boe=new Ta,Aoe=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL"}(voe||(voe={})),nt(voe);var Coe,woe,Roe,Ioe,Ooe,Moe,Poe,koe,Doe,Boe,Loe,Noe,Foe,zoe,Uoe,Goe,Hoe,Voe,Woe,joe,qoe,Xoe,Yoe,Koe=e("MaskComponent",($ae=ii("cc.Mask"),eoe=mi("i18n:cc.Mask"),toe=ri(110),ioe=_i("UI/Render/Mask"),noe=Li(voe),roe=wi(4),aoe=Si(""),ooe=Si(""),soe=gi(!1),loe=gi(!1),coe=gi(!1),$ae(uoe=eoe(uoe=toe(uoe=ioe((moe=poe=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_type",_oe,c(e)),x(e,"_inverted",doe,c(e)),x(e,"_segments",foe,c(e)),e._graphics=null,e._clearGraphics=null,e._instanceMaterialType=iM.ADD_COLOR,e._uiMaterialDirty=!0,e}return o(t,e),r(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null))}},{key:"inverted",get:function(){return this._inverted},set:function(e){E.game.renderType!==AO.RENDER_TYPE_CANVAS?this._inverted=e:G(4202)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=vn(e,3,1e4),this._updateGraphics())}},{key:"graphics",get:function(){return this._graphics}},{key:"clearGraphics",get:function(){return this._clearGraphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}}]),r(t,[{key:"onLoad",value:function(){this._createGraphics(),this._clearGraphics&&this._clearGraphics.onLoad(),this._graphics&&this._graphics.onLoad()}},{key:"onRestore",value:function(){this._createGraphics(),this._updateGraphics()}},{key:"onEnable",value:function(){_(s(t.prototype),"onEnable",this).call(this),this._enableGraphics(),PO.on("design-resolution-changed",this._updateClearGraphics,this)}},{key:"onDisable",value:function(){_(s(t.prototype),"onDisable",this).call(this),this._disableGraphics(),PO.off("design-resolution-changed",this._updateClearGraphics)}},{key:"onDestroy",value:function(){_(s(t.prototype),"onDestroy",this).call(this),this._removeGraphics()}},{key:"isHit",value:function(e){var t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=i.width,r=i.height,a=Eoe;this.node.getWorldMatrix(Toe),Ta.invert(boe,Toe),ia.transformMat4(a,e,boe);var o=t.anchorPoint;a.x+=o.x*n,a.y+=o.y*r;var s=!1;if(this.type===voe.RECT||this.type===voe.GRAPHICS_STENCIL)s=a.x>=0&&a.y>=0&&a.x<=n&&a.y<=r;else if(this.type===voe.ELLIPSE){var l=n/2,c=r/2,u=a.x-.5*n,h=a.y-.5*r;s=u*u/(l*l)+h*h/(c*c)<1}return this._inverted&&(s=!s),s}},{key:"_render",value:function(e){e.commitComp(this,null,this._assembler)}},{key:"_postRender",value:function(e){this._postAssembler&&e.commitComp(this,null,this._postAssembler)}},{key:"_nodeStateChange",value:function(e){_(s(t.prototype),"_nodeStateChange",this).call(this,e),this._updateGraphics()}},{key:"_resolutionChanged",value:function(){this._updateClearGraphics()}},{key:"_canRender",value:function(){return!!_(s(t.prototype),"_canRender",this).call(this)&&(null!==this._clearGraphics&&null!==this._graphics)}},{key:"_flushAssembler",value:function(){var e=t.Assembler.getAssembler(this),i=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==i&&(this._postAssembler=i),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.sharedMaterial,this.markForUpdateRenderData())}},{key:"_createGraphics",value:function(){if(!this._clearGraphics){var e=new ig("clear-graphics"),t=this._clearGraphics=e.addComponent(Soe);t.delegateSrc=this.node,t.lineWidth=0;var i=Ma.WHITE.clone();i.a=0,t.fillColor=i}if(!this._graphics){var n=this._graphics=new Soe;n.node=this.node,n.node.getWorldMatrix(),n.lineWidth=0;var r=Ma.WHITE.clone();r.a=0,n.fillColor=r}}},{key:"_updateClearGraphics",value:function(){if(this._clearGraphics){var e=mO;this._clearGraphics.node.setWorldPosition(e.width/2,e.height/2,0),this._clearGraphics.clear(),this._clearGraphics.rect(-e.width/2,-e.height/2,e.width,e.height),this._clearGraphics.fill()}}},{key:"_updateGraphics",value:function(){if(this._graphics){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var i=e.contentSize,n=i.width,r=i.height,a=e.anchorPoint,o=-n*a.x,s=-r*a.y;if(this._type===voe.RECT)t.rect(o,s,n,r);else if(this._type===voe.ELLIPSE){for(var l=function(e,t,i){Aoe.length=0;for(var n=2*Math.PI/i,r=0;r<i;++r)Aoe.push(new oa(t.x*Math.cos(n*r)+e.x,t.y*Math.sin(n*r)+e.y,0));return Aoe}(new oa(o+n/2,s+r/2,0),new oa(n/2,r/2,0),this._segments),c=0;c<l.length;++c){var u=l[c];0===c?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}}},{key:"_enableGraphics",value:function(){this._clearGraphics&&(this._clearGraphics.onEnable(),this._updateClearGraphics()),this._graphics&&(this._graphics.onEnable(),this._updateGraphics())}},{key:"_disableGraphics",value:function(){this._graphics&&this._graphics.onDisable(),this._clearGraphics&&this._clearGraphics.onDisable()}},{key:"_removeGraphics",value:function(){this._graphics&&this._graphics.destroy(),this._clearGraphics&&this._clearGraphics.destroy()}}]),t}(YM),poe.Type=voe,S((hoe=moe).prototype,"type",[noe,roe,aoe],Object.getOwnPropertyDescriptor(hoe.prototype,"type"),hoe.prototype),S(hoe.prototype,"inverted",[ooe],Object.getOwnPropertyDescriptor(hoe.prototype,"inverted"),hoe.prototype),S(hoe.prototype,"segments",[vi],Object.getOwnPropertyDescriptor(hoe.prototype,"segments"),hoe.prototype),S(hoe.prototype,"dstBlendFactor",[Ni,soe],Object.getOwnPropertyDescriptor(hoe.prototype,"dstBlendFactor"),hoe.prototype),S(hoe.prototype,"srcBlendFactor",[Ni,loe],Object.getOwnPropertyDescriptor(hoe.prototype,"srcBlendFactor"),hoe.prototype),S(hoe.prototype,"color",[Ni,coe],Object.getOwnPropertyDescriptor(hoe.prototype,"color"),hoe.prototype),_oe=S(hoe.prototype,"_type",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return voe.RECT}}),doe=S(hoe.prototype,"_inverted",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),foe=S(hoe.prototype,"_segments",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),uoe=hoe))||uoe)||uoe)||uoe)||uoe));E.Mask=Koe,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(Yoe||(Yoe={})),et(Yoe);var Zoe,Qoe,Joe,$oe,ese,tse,ise,nse,rse,ase,ose,sse,lse,cse,use,hse,_se,dse,fse,pse,mse,vse,gse,yse,xse,Sse,Tse,Ese,bse,Ase,Cse,wse,Rse,Ise,Ose,Mse,Pse,kse,Dse,Bse,Lse,Nse,Fse,zse,Use,Gse,Hse=e("ProgressBarComponent",(Coe=ii("cc.ProgressBar"),woe=mi("i18n:cc.ProgressBar"),Roe=ri(110),Ioe=_i("UI/ProgressBar"),Ooe=ni(jv),Moe=Li(Dk),Poe=Si(" Sprite "),koe=Li(Yoe),Doe=Si(""),Boe=Si(" progress  1 "),Loe=Ti([0,1,.1]),Noe=Si(" 0  1"),Foe=Si(""),Coe(zoe=woe(zoe=Roe(zoe=Ioe(zoe=Ooe((Xoe=qoe=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_barSprite",Goe,c(n)),x(n,"_mode",Hoe,c(n)),x(n,"_totalLength",Voe,c(n)),x(n,"_progress",Woe,c(n)),x(n,"_reverse",joe,c(n)),n}return o(t,e),r(t,[{key:"_initBarSprite",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===Dk.FillType.RADIAL&&(this._mode=Yoe.FILLED),this._mode===Yoe.HORIZONTAL?this.totalLength=r.width:this._mode===Yoe.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var a=-i.width*n.x;e.setPosition(a,0,0)}}}},{key:"_updateBarStatus",value:function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,i=t.anchorPoint,n=t.contentSize,r=e.getPosition(),a=new ia(0,.5),o=gn(this._progress),s=this._totalLength*o,l=n,c=0,u=0;switch(this._mode){case Yoe.HORIZONTAL:this._reverse&&(a=new ia(1,.5)),l=new wa(s,n.height),c=this._totalLength,u=n.height;break;case Yoe.VERTICAL:a=this._reverse?new ia(.5,1):new ia(.5,0),l=new wa(n.width,s),c=n.width,u=this._totalLength}if(this._mode===Yoe.FILLED)this._barSprite.type!==Dk.Type.FILLED?P("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==Dk.Type.FILLED){var h=a.x-i.x,_=a.y-i.y,d=new oa(c*h,u*_,0);e.setPosition(r.x+d.x,r.y+d.y,r.z),t.setAnchorPoint(a),t.setContentSize(l)}else P("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var i=t._uiProps.uiTransformComp.contentSize;this._mode===Yoe.HORIZONTAL?this.totalLength=i.width:this._mode===Yoe.VERTICAL?this.totalLength=i.height:this._mode===Yoe.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===Yoe.FILLED&&(e=gn(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(Yr),qoe.Mode=Yoe,S((Uoe=Xoe).prototype,"barSprite",[Moe,Poe],Object.getOwnPropertyDescriptor(Uoe.prototype,"barSprite"),Uoe.prototype),S(Uoe.prototype,"mode",[koe,Doe],Object.getOwnPropertyDescriptor(Uoe.prototype,"mode"),Uoe.prototype),S(Uoe.prototype,"totalLength",[Boe],Object.getOwnPropertyDescriptor(Uoe.prototype,"totalLength"),Uoe.prototype),S(Uoe.prototype,"progress",[Loe,Ci,Noe],Object.getOwnPropertyDescriptor(Uoe.prototype,"progress"),Uoe.prototype),S(Uoe.prototype,"reverse",[Foe],Object.getOwnPropertyDescriptor(Uoe.prototype,"reverse"),Uoe.prototype),Goe=S(Uoe.prototype,"_barSprite",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hoe=S(Uoe.prototype,"_mode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yoe.HORIZONTAL}}),Voe=S(Uoe.prototype,"_totalLength",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Woe=S(Uoe.prototype,"_progress",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),joe=S(Uoe.prototype,"_reverse",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zoe=Uoe))||zoe)||zoe)||zoe)||zoe)||zoe)),Vse=e("LabelOutlineComponent",(Zoe=ii("cc.LabelOutline"),Qoe=mi("i18n:cc.LabelOutline"),Joe=ri(110),$oe=_i("UI/LabelOutline"),ese=ni(hne),tse=Si(""),ise=Si(""),Zoe(nse=Qoe(nse=Joe(nse=$oe(nse=ese(nse=hi((ase=S((rse=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_color",ase,c(n)),x(n,"_width",ose,c(n)),n}return o(t,e),r(t,[{key:"onEnable",value:function(){this._updateRenderData()}},{key:"onDisable",value:function(){this._updateRenderData()}},{key:"_updateRenderData",value:function(){var e=this.node.getComponent(hne);e&&e.updateRenderData(!0)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(Yr)).prototype,"_color",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ma(0,0,0,255)}}),ose=S(rse.prototype,"_width",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),S(rse.prototype,"color",[tse],Object.getOwnPropertyDescriptor(rse.prototype,"color"),rse.prototype),S(rse.prototype,"width",[ise],Object.getOwnPropertyDescriptor(rse.prototype,"width"),rse.prototype),nse=rse))||nse)||nse)||nse)||nse)||nse)||nse)),Wse=new Lu,jse=new Ne((function(e){if(!E.isValid(e.node))return!1;var t=e.node.getComponent(Vse);return t&&(t.width=0),!0}),20);jse.get=function(e,t){var i=this._get();i||(i={node:new Zk("RICHTEXT_CHILD"),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:""});var n=i.node;n||(n=new Zk("RICHTEXT_CHILD"));var r=n.getComponent(hne);return r||(r=n.addComponent(hne)),r.string=e,r.horizontalAlign=ine.LEFT,r.verticalAlign=nne.TOP,n.setPosition(0,0,0),n._uiProps.uiTransformComp.setAnchorPoint(.5,.5),{node:n,comp:r,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:""}};var qse,Xse,Yse,Kse,Zse,Qse,Jse,$se,ele,tle,ile,nle,rle,ale,ole,sle,lle,cle,ule,hle,_le,dle,fle,ple,mle,vle=e("RichTextComponent",(sse=ii("cc.RichText"),lse=mi("i18n:cc.RichText"),cse=ri(110),use=_i("UI/Render/RichText"),hse=Si(""),_se=Li(ine),dse=Si(""),fse=Si(""),pse=Si(""),mse=Li(aI),vse=Si(""),gse=Si(""),yse=Li(ane),xse=Si(", "),Sse=Si(""),Tse=Si(""),Ese=Li(Jw),bse=Si(" img  src  imageAtlas  spriteFrame img tag "),Ase=Si("RichText "),sse(Cse=lse(Cse=cse(Cse=use(Cse=hi((Gse=Use=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_lineHeight",Rse,c(e)),x(e,"_string",Ise,c(e)),x(e,"_horizontalAlign",Ose,c(e)),x(e,"_fontSize",Mse,c(e)),x(e,"_maxWidth",Pse,c(e)),x(e,"_fontFamily",kse,c(e)),x(e,"_font",Dse,c(e)),x(e,"_isSystemFontUsed",Bse,c(e)),x(e,"_userDefinedFont",Lse,c(e)),x(e,"_cacheMode",Nse,c(e)),x(e,"_imageAtlas",Fse,c(e)),x(e,"_handleTouchEvent",zse,c(e)),e._textArray=[],e._labelSegments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}return o(t,e),r(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),r(t,[{key:"onEnable",value:function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}},{key:"onDisable",value:function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}},{key:"start",value:function(){this._onTTFLoaded(),this.node.on(ig.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this)}},{key:"onRestore",value:function(){}},{key:"onDestroy",value:function(){for(var e,t=y(this._labelSegments);!(e=t()).done;){var i=e.value;i.node.removeFromParent(),jse.put(i)}this.node.off(ig.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this)}},{key:"_addEventListeners",value:function(){this.node.on(ig.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_removeEventListeners",value:function(){this.node.off(ig.EventType.TOUCH_END,this._onTouchEnded,this)}},{key:"_updateLabelSegmentTextAttributes",value:function(){var e=this;this._labelSegments.forEach((function(t){e._applyTextAttribute(t)}))}},{key:"_createFontLabel",value:function(e){return jse.get(e,this)}},{key:"_onTTFLoaded",value:function(){if(this._font instanceof fI)if(this._font._nativeAsset)this._layoutDirty=!0,this._updateRichText();else{var e=this;aO.load(this._font.nativeUrl,(function(t,i){e._layoutDirty=!0,e._updateRichText()}))}else this._layoutDirty=!0,this._updateRichText()}},{key:"_measureText",value:function(e,t){var i=this,n=function(t){var n;return 0===i._labelSegmentsCache.length?(n=i._createFontLabel(t),i._labelSegmentsCache.push(n)):(n=i._labelSegmentsCache[0]).node.getComponent(hne).string=t,n.styleIndex=e,i._applyTextAttribute(n),n.node._uiProps.uiTransformComp.contentSize.width};return t?n(t):n}},{key:"_onTouchEnded",value:function(e){for(var t,i=this,n=this.node.getComponents(Yr),r=function(){var r=t.value,a=r.clickHandler,o=r.clickParam;a&&i._containsTouchLocation(r,e.touch.getUILocation())&&(n.forEach((function(t){var i=t[a];t.enabledInHierarchy&&i&&i.call(t,e,o)})),e.propagationStopped=!0)},a=y(this._labelSegments);!(t=a()).done;)r()}},{key:"_containsTouchLocation",value:function(e,t){var i=e.node.getComponent(jv);return!!i&&i.getBoundingBoxToWorld().contains(t)}},{key:"_resetState",value:function(){for(var e=this,t=this.node.children,i=function(i){var n=t[i];if(("RICHTEXT_CHILD"===n.name||"RICHTEXT_Image_CHILD"===n.name)&&(n.parent===e.node?n.parent=null:t.splice(i,1),"RICHTEXT_CHILD"===n.name)){var r=e._labelSegments.findIndex((function(e){return e.node===n}));-1!==r&&jse.put(e._labelSegments[r])}},n=t.length-1;n>=0;n--)i(n);this._labelSegments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}},{key:"_activateChildren",value:function(e){for(var t=this.node.children.length-1;t>=0;t--){var i=this.node.children[t];"RICHTEXT_CHILD"!==i.name&&"RICHTEXT_Image_CHILD"!==i.name||(i.active=e)}}},{key:"_addLabelSegment",value:function(e,t){var i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(e);else{var n=(i=this._labelSegmentsCache.pop()).node.getComponent(hne);n&&(n.string=e)}return i.styleIndex=t,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),this._applyTextAttribute(i),this.node.addChild(i.node),this._labelSegments.push(i),i}},{key:"_updateRichTextWithMaxWidth",value:function(e,t,i){var n=t;if(this._lineOffsetX>0&&n+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var a=this._getFirstWordLen(e,r,e.length),o=e.substr(r,a),s=this._measureText(i,o);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var l=e.substr(0,r);this._addLabelSegment(l,i),e=e.substr(r,e.length),n=this._measureText(i,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=a}if(n>this._maxWidth)for(var c=Au(e,n,this._maxWidth,this._measureText(i)),u=0;u<c.length;++u){var h=c[u],_=this._addLabelSegment(h,i).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,c.length>1&&u<c.length-1&&this._updateLineInfo()}else this._lineOffsetX+=n,this._addLabelSegment(e,i)}},{key:"_isLastComponentCR",value:function(e){return e.length-1===e.lastIndexOf("\n")}},{key:"_updateLineInfo",value:function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}},{key:"_needsUpdateTextLayout",value:function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var i=this._textArray[t],n=e[t];if(i.text!==n.text)return!0;var r=i.style,a=n.style;if(r){if(a){if(!!a.outline!=!!r.outline)return!0;if(r.size!==a.size||r.italic!==a.italic||r.isImage!==a.isImage)return!0;if(r.src!==a.src||r.imageAlign!==a.imageAlign||r.imageHeight!==a.imageHeight||r.imageWidth!==a.imageWidth||r.imageOffset!==a.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(a&&(a.size||a.italic||a.isImage||a.outline))return!0}return!1}},{key:"_addRichTextImageElement",value:function(e){if(e.style){var t=e.style,i=t.src,n=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(n){var r=new Zk("RICHTEXT_Image_CHILD"),a=r.addComponent(Dk);switch(t.imageAlign){case"top":r._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r._uiProps.uiTransformComp.setAnchorPoint(0,0)}a.type=Dk.Type.SLICED,a.sizeMode=Dk.SizeMode.CUSTOM,a.spriteFrame=n,this.node.addChild(r);var o={node:r,comp:a,lineCount:0,styleIndex:0,imageOffset:t.imageOffset||"",clickParam:"",clickHandler:""};this._labelSegments.push(o);var s=n.rect.clone(),l=1,c=s.width,u=s.height,h=t.imageWidth||0,_=t.imageHeight||0;_>0?(c*=l=_/u,u*=l):(c*=l=this._lineHeight/u,u*=l),h>0&&(c=h),this._maxWidth>0?(this._lineOffsetX+c>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=c):(this._lineOffsetX+=c,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r._uiProps.uiTransformComp.setContentSize(c,u),o.lineCount=this._lineCount,o.clickHandler="",o.clickParam="";var d=t.event;d&&(o.clickHandler=d.click,o.clickParam=d.param)}else G(4400)}}},{key:"_updateRichText",value:function(){if(this.enabledInHierarchy){var e=Wse.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,i=!1,n=0;n<this._textArray.length;++n){var r=this._textArray[n],a=r.text;if(void 0!==a){if(""===a){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var o=a.split("\n"),s=0;s<o.length;++s){var l=o[s];if(""!==l)if(i=!1,this._maxWidth>0){var c=this._measureText(n,l);this._updateRichTextWithMaxWidth(l,c,n),o.length>1&&s<o.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(l,n),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),o.length>1&&s<o.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(a)&&s===o.length-1)continue;this._updateLineInfo(),i=!0}}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+pu)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}}},{key:"_getFirstWordLen",value:function(e,t,i){var n=e.charAt(t);if(Su(n)||Tu(n))return 1;for(var r=1,a=t+1;a<i&&(!Tu(n=e.charAt(a))&&!Su(n));++a)r++;return r}},{key:"_updateRichTextPosition",value:function(){for(var e=0,t=1,i=this._lineCount,n=this.node._uiProps.uiTransformComp,r=n.anchorX,a=n.anchorY,o=0;o<this._labelSegments.length;++o){var s=this._labelSegments[o],l=s.lineCount;l>t&&(e=0,t=l);var c=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case ine.LEFT:break;case ine.CENTER:c-=this._linesWidth[l-1]/2;break;case ine.RIGHT:c-=this._linesWidth[l-1]}var u=s.node.position;if(s.node.setPosition(e+c,this._lineHeight*(i-l)-this._labelHeight*a,u.z),l===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(Dk)){var h=s.node.position.clone(),_=this._lineHeight,d=this._lineHeight*(1+pu);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(d-_)/2;break;case.5:h.y+=d/2;break;default:h.y+=(d-_)/2}if(s.imageOffset){var f=s.imageOffset.split(",");if(1===f.length&&f[0]){var p=parseFloat(f[0]);Number.isInteger(p)&&(h.y+=p)}else if(2===f.length){var m=parseFloat(f[0]),v=parseFloat(f[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(Vse);if(g){var y=s.node.position.clone();y.y=y.y-g.width,s.node.position=y}}}},{key:"_convertLiteralColorValue",value:function(e){var t=e.toUpperCase();return Ma[t]?Ma[t]:(new Ma).fromHEX(e)}},{key:"_applyTextAttribute",value:function(e){var t=e.node.getComponent(hne);if(t){var i,n=e.styleIndex;if(this._textArray[n]&&(i=this._textArray[n].style),i){if(t.color=this._convertLiteralColorValue(i.color||"white"),t.isBold=!!i.bold,t.isItalic=!!i.italic,t.isUnderline=!!i.underline,i.outline){var r=e.node.getComponent(Vse);r||(r=e.node.addComponent(Vse)),r.color=this._convertLiteralColorValue(i.outline.color),r.width=i.outline.width}i.size&&(t.fontSize=i.size),e.clickHandler="",e.clickParam="";var a=i.event;a&&(e.clickHandler=a.click||"",e.clickParam=a.param||"")}else t.fontSize=this._fontSize;t.cacheMode=this._cacheMode,this._font instanceof aI&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0)}}}]),t}(qee),Use.HorizontalAlign=ine,Use.VerticalAlign=nne,S((wse=Gse).prototype,"string",[Oi,hse],Object.getOwnPropertyDescriptor(wse.prototype,"string"),wse.prototype),S(wse.prototype,"horizontalAlign",[_se,dse],Object.getOwnPropertyDescriptor(wse.prototype,"horizontalAlign"),wse.prototype),S(wse.prototype,"fontSize",[fse],Object.getOwnPropertyDescriptor(wse.prototype,"fontSize"),wse.prototype),S(wse.prototype,"fontFamily",[pse],Object.getOwnPropertyDescriptor(wse.prototype,"fontFamily"),wse.prototype),S(wse.prototype,"font",[mse,vse],Object.getOwnPropertyDescriptor(wse.prototype,"font"),wse.prototype),S(wse.prototype,"useSystemFont",[gse],Object.getOwnPropertyDescriptor(wse.prototype,"useSystemFont"),wse.prototype),S(wse.prototype,"cacheMode",[yse,xse],Object.getOwnPropertyDescriptor(wse.prototype,"cacheMode"),wse.prototype),S(wse.prototype,"maxWidth",[Sse],Object.getOwnPropertyDescriptor(wse.prototype,"maxWidth"),wse.prototype),S(wse.prototype,"lineHeight",[Tse],Object.getOwnPropertyDescriptor(wse.prototype,"lineHeight"),wse.prototype),S(wse.prototype,"imageAtlas",[Ese,bse],Object.getOwnPropertyDescriptor(wse.prototype,"imageAtlas"),wse.prototype),S(wse.prototype,"handleTouchEvent",[Ase],Object.getOwnPropertyDescriptor(wse.prototype,"handleTouchEvent"),wse.prototype),Rse=S(wse.prototype,"_lineHeight",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Ise=S(wse.prototype,"_string",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),Ose=S(wse.prototype,"_horizontalAlign",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ine.LEFT}}),Mse=S(wse.prototype,"_fontSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Pse=S(wse.prototype,"_maxWidth",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kse=S(wse.prototype,"_fontFamily",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),Dse=S(wse.prototype,"_font",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bse=S(wse.prototype,"_isSystemFontUsed",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Lse=S(wse.prototype,"_userDefinedFont",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nse=S(wse.prototype,"_cacheMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ane.NONE}}),Fse=S(wse.prototype,"_imageAtlas",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zse=S(wse.prototype,"_handleTouchEvent",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Cse=wse))||Cse)||Cse)||Cse)||Cse)||Cse)),gle=new oa,yle=new oa,xle=new oa,Sle=new ia,Tle=new Ma;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(mle||(mle={})),nt(mle);var Ele,ble,Ale,Cle,wle,Rle,Ile,Ole,Mle,Ple,kle,Dle,Ble,Lle,Nle,Fle,zle,Ule,Gle,Hle,Vle,Wle,jle,qle,Xle,Yle,Kle,Zle,Qle,Jle,$le,ece,tce,ice,nce,rce,ace,oce,sce,lce,cce,uce,hce,_ce,dce,fce,pce,mce,vce,gce=e("ScrollBarComponent",(qse=ii("cc.ScrollBar"),Xse=mi("i18n:cc.ScrollBar"),Yse=ri(110),Kse=_i("UI/ScrollBar"),Zse=ni(jv),Qse=Li(Dk),Jse=wi(0),$se=Si(" Sprite"),ele=Li(mle),tle=wi(1),ile=Si("ScrollBar "),nle=wi(2),rle=Si(" ScrollBar"),ale=wi(3),ole=Si("\n enableAutoHide  true "),qse(sle=Xse(sle=Yse(sle=Kse(sle=Zse((ple=fle=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_scrollView",cle,c(n)),x(n,"_handle",ule,c(n)),x(n,"_direction",hle,c(n)),x(n,"_enableAutoHide",_le,c(n)),x(n,"_autoHideTime",dle,c(n)),n._touching=!1,n._opacity=255,n._autoHideRemainingTime=0,n}return o(t,e),r(t,[{key:"hide",value:function(){this._autoHideRemainingTime=0,this._setOpacity(0)}},{key:"show",value:function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}},{key:"onScroll",value:function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var i=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(i,n)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var a=0,o=0,s=0,l=0,c=0;this._direction===mle.HORIZONTAL?(a=i.width,o=n.width,c=r.width,s=e.x,l=-this._convertToScrollViewSpace(t).x):this._direction===mle.VERTICAL&&(a=i.height,o=n.height,c=r.height,s=e.y,l=-this._convertToScrollViewSpace(t).y);var u=this._calculateLength(a,o,c,s),h=this._calculatePosition(a,o,c,l,s,u);this._updateLength(u),this._updateHandlerPosition(h)}}}}},{key:"setScrollView",value:function(e){this._scrollView=e}},{key:"onTouchBegan",value:function(){this._enableAutoHide&&(this._touching=!0)}},{key:"onTouchEnded",value:function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,i))return}}this._autoHideRemainingTime=this._autoHideTime}}},{key:"onEnable",value:function(){var e=this.node.getComponent(Dk);e&&(this._opacity=e.color.a)}},{key:"start",value:function(){this._enableAutoHide&&this._setOpacity(0)}},{key:"update",value:function(e){this._processAutoHide(e)}},{key:"_convertToScrollViewSpace",value:function(e){var t=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(!t||!i)return gle;yle.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(yle,xle);var n=t.convertToNodeSpaceAR(xle);return n.x+=t.anchorX*t.width,n.y+=t.anchorY*t.height,n}},{key:"_setOpacity",value:function(e){if(this._handle){var t=this.node.getComponent(Dk);t&&(Tle.set(t.color),Tle.a=e,t.color=Tle),(t=this._handle.getComponent(Dk))&&(Tle.set(t.color),Tle.a=e,t.color=Tle)}}},{key:"_updateHandlerPosition",value:function(e){if(this._handle){var t=this._fixupHandlerPosition();this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}}},{key:"_fixupHandlerPosition",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize,i=e.anchorPoint,n=this.handle.node._uiProps.uiTransformComp.contentSize,r=this.handle.node.parent;oa.set(yle,-t.width*i.x,-t.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(yle,xle),o=new oa;return r._uiProps.uiTransformComp.convertToNodeSpaceAR(a,o),this.direction===mle.HORIZONTAL?o=new oa(o.x,o.y+(t.height-n.height)/2,0):this.direction===mle.VERTICAL&&(o=new oa(o.x+(t.width-n.width)/2,o.y,0)),this.handle.node.setPosition(o),o}},{key:"_conditionalDisableScrollBar",value:function(e,t){return e.width<=t.width&&this._direction===mle.HORIZONTAL||e.height<=t.height&&this._direction===mle.VERTICAL}},{key:"_calculateLength",value:function(e,t,i,n){var r=e;return n&&(r+=20*(n>0?n:-n)),i*(t/r)}},{key:"_calculatePosition",value:function(e,t,i,n,r,a){var o=e-t;r&&(o+=Math.abs(r));var s=0;o&&(s=gn(s=n/o));var l=(i-a)*s;return this._direction===mle.VERTICAL?new oa(0,l,0):new oa(l,0,0)}},{key:"_updateLength",value:function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,i=t.contentSize,n=t.anchorPoint;n.x===Sle.x&&n.y===Sle.y||t.setAnchorPoint(Sle),this._direction===mle.HORIZONTAL?t.setContentSize(e,i.height):t.setContentSize(i.width,e)}}},{key:"_processAutoHide",value:function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(gle))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(new oa))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(Yr),fle.Direction=mle,S((lle=ple).prototype,"handle",[Qse,Jse,$se],Object.getOwnPropertyDescriptor(lle.prototype,"handle"),lle.prototype),S(lle.prototype,"direction",[ele,tle,ile],Object.getOwnPropertyDescriptor(lle.prototype,"direction"),lle.prototype),S(lle.prototype,"enableAutoHide",[nle,rle],Object.getOwnPropertyDescriptor(lle.prototype,"enableAutoHide"),lle.prototype),S(lle.prototype,"autoHideTime",[ale,ole],Object.getOwnPropertyDescriptor(lle.prototype,"autoHideTime"),lle.prototype),cle=S(lle.prototype,"_scrollView",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ule=S(lle.prototype,"_handle",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hle=S(lle.prototype,"_direction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mle.HORIZONTAL}}),_le=S(lle.prototype,"_enableAutoHide",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dle=S(lle.prototype,"_autoHideTime",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sle=lle))||sle)||sle)||sle)||sle)||sle)),yce=e("ViewGroup",ii("cc.ViewGroup")(Ele=ri(110)(Ele=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),t}(Yr))||Ele)||Ele);E.ViewGroup=yce;var xce,Sce=new oa,Tce=new oa,Ece=new oa,bce=new ia,Ace=new ia,Cce=function(){return(new Date).getMilliseconds()},wce={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(xce||(xce={}));var Rce,Ice,Oce,Mce,Pce,kce,Dce,Bce,Lce,Nce,Fce,zce,Uce,Gce,Hce,Vce,Wce,jce,qce,Xce,Yce,Kce,Zce=e("ScrollViewComponent",(ble=ii("cc.ScrollView"),Ale=mi("i18n:cc.ScrollView"),Cle=ri(110),wle=_i("UI/ScrollView"),Rle=ni(jv),Ile=Ti([0,10]),Ole=wi(0),Mle=Si("0 "),Ple=Ti([0,1,.1]),kle=wi(1),Dle=Si("0 1 "),Ble=wi(2),Lle=Si(""),Nle=wi(3),Fle=Si(""),zle=Li(ig),Ule=wi(4),Gle=Si(""),Hle=wi(5),Vle=Si(""),Wle=Li(gce),jle=wi(6),qle=Si(" ScrollBar"),Xle=wi(7),Yle=Si(""),Kle=Li(gce),Zle=wi(8),Qle=Si(" ScrollBar"),Jle=wi(9),$le=Si(""),ece=Li([CB]),tce=wi(10),ice=Si(""),ble(nce=Ale(nce=Cle(nce=wle(nce=Rle((vce=mce=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"bounceDuration",ace,c(n)),x(n,"brake",oce,c(n)),x(n,"elastic",sce,c(n)),x(n,"inertia",lce,c(n)),x(n,"horizontal",cce,c(n)),x(n,"vertical",uce,c(n)),x(n,"cancelInnerEvents",hce,c(n)),x(n,"scrollEvents",_ce,c(n)),n._autoScrolling=!1,n._scrolling=!1,x(n,"_content",dce,c(n)),x(n,"_horizontalScrollBar",fce,c(n)),x(n,"_verticalScrollBar",pce,c(n)),n._topBoundary=0,n._bottomBoundary=0,n._leftBoundary=0,n._rightBoundary=0,n._touchMoveDisplacements=[],n._touchMoveTimeDeltas=[],n._touchMovePreviousTimestamp=0,n._touchMoved=!1,n._autoScrollAttenuate=!1,n._autoScrollStartPosition=new oa,n._autoScrollTargetDelta=new oa,n._autoScrollTotalTime=0,n._autoScrollAccumulatedTime=0,n._autoScrollCurrentlyOutOfBoundary=!1,n._autoScrollBraking=!1,n._autoScrollBrakingStartPosition=new oa,n._outOfBoundaryAmount=new oa,n._outOfBoundaryAmountDirty=!0,n._stopMouseWheel=!1,n._mouseWheelEventElapsedTime=0,n._isScrollEndedWithThresholdEventFired=!1,n._scrollEventEmitMask=0,n._isBouncing=!1,n._contentPos=new oa,n._deltaPos=new oa,n}return o(t,e),r(t,[{key:"scrollToBottom",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ia(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i,!0)}},{key:"scrollToTop",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ia(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ia(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ia(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ia(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToTopRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ia(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomLeft",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ia(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToBottomRight",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._calculateMovePercentDelta({anchor:new ia(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,!1!==t):this._moveContent(i)}},{key:"scrollToOffset",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=this.getMaxScrollOffset(),r=new ia(0,0);0===n.x?r.x=0:r.x=e.x/n.x,0===n.y?r.y=1:r.y=(n.y-e.y)/n.y,this.scrollTo(r,t,i)}},{key:"getScrollOffset",value:function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new oa(t,e,0)}},{key:"getMaxScrollOffset",value:function(){if(!this._content||!this.view)return Sce;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,i=e.height-this.view.height;return new oa(t=t>=0?t:0,i=i>=0?i:0,0)}},{key:"scrollToPercentHorizontal",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new ia(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==i):this._moveContent(n)}},{key:"scrollTo",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new ia(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"scrollToPercentVertical",value:function(e,t,i){var n=this._calculateMovePercentDelta({anchor:new ia(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,i):this._moveContent(n)}},{key:"stopAutoScroll",value:function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}},{key:"setContentPosition",value:function(e){if(this._content){var t=this.getContentPosition();Math.abs(e.x-t.x)<1e-4&&Math.abs(e.y-t.y)<1e-4||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}}},{key:"getContentPosition",value:function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Sce}},{key:"isScrolling",value:function(){return this._scrolling}},{key:"isAutoScrolling",value:function(){return this._autoScrolling}},{key:"getScrollEndedEventTiming",value:function(){return 1e-4}},{key:"start",value:function(){this._calculateBoundary(),this._content&&AB.once(iB.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}},{key:"onEnable",value:function(){this._registerEvent(),this._content&&(this._content.on(ig.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(ig.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(ig.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(ig.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}},{key:"update",value:function(e){this._autoScrolling&&this._processAutoScrolling(e)}},{key:"onDisable",value:function(){this._unregisterEvent(),this._content&&(this._content.off(ig.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(ig.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(ig.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(ig.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}},{key:"_registerEvent",value:function(){this.node.on(ig.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(ig.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(ig.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(ig.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(ig.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_unregisterEvent",value:function(){this.node.off(ig.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(ig.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(ig.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(ig.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(ig.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}},{key:"_onMouseWheel",value:function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var i=new oa,n=e.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchBegan",value:function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))}},{key:"_onTouchMoved",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var i=e.touch;if(this._handleMoveLogic(i),this.cancelInnerEvents){var n=i.getUILocation(bce);if(n.subtract(i.getUIStartLocation(Ace)),n.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new dm(e.getTouches(),e.bubbles);r.type=ig.EventType.TOUCH_CANCEL,r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}}},{key:"_onTouchEnded",value:function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(xce.TOUCH_UP);var i=e.touch;this._handleReleaseLogic(i),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}}},{key:"_onTouchCancelled",value:function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var i=e.touch;this._handleReleaseLogic(i)}this._stopPropagationIfTargetIsMe(e)}}},{key:"_calculateBoundary",value:function(){if(this._content&&this.view){var e=this._content.getComponent(Jae);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,i=t.width*t.anchorX,n=t.height*t.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}}},{key:"_hasNestedViewGroup",value:function(e,t){if(e&&e.eventPhase===Fi.CAPTURING_PHASE){if(t)for(var i,n=y(t);!(i=n()).done;){var r=i.value;if(this.node===r)return!(!e.target||!e.target.getComponent(yce));if(r.getComponent(yce))return!0}return!1}}},{key:"_startInertiaScroll",value:function(e){var t=new oa(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)}},{key:"_calculateAttenuatedFactor",value:function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))}},{key:"_startAttenuatingAutoScroll",value:function(e,t){var i=new oa(e);if(i.normalize(),this._content&&this.view){var n=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,a=n.width-r.width,o=n.height-r.height,s=this._calculateAttenuatedFactor(a),l=this._calculateAttenuatedFactor(o);i.x=i.x*a*(1-this.brake)*s,i.y=i.y*o*l*(1-this.brake),i.z=0}var c=e.length(),u=i.length()/c;if(i.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=new oa(e);h.multiplyScalar(u),i.set(h),i.add(e)}var _=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(i,_,!0)}},{key:"_calculateAutoScrollTimeByInitialSpeed",value:function(e){return Math.sqrt(Math.sqrt(e/5))}},{key:"_startAutoScroll",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,oa.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new oa;var r=this._getHowMuchOutOfBoundary();r.equals(Sce,1e-4)||(this._autoScrollCurrentlyOutOfBoundary=!0)}},{key:"_calculateTouchMoveVelocity",value:function(){var e=0;if((e=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),e))<=0||e>=.5)return new oa;var t=new oa;return t=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),t),new oa(t.x*(1-this.brake)/e,t.y*(1-this.brake)/e,0)}},{key:"_flattenVectorByDirection",value:function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t}},{key:"_moveContent",value:function(e,t){var i=this._flattenVectorByDirection(e);Tce.set(this.getContentPosition()),Tce.add(i),Tce.set(1e-4*Math.floor(1e4*Tce.x),1e-4*Math.floor(1e4*Tce.y),Tce.z),this.setContentPosition(Tce);var n=this._getHowMuchOutOfBoundary();this._updateScrollBar(n),this.elastic&&t&&this._startBounceBackIfNeeded()}},{key:"_getContentLeftBoundary",value:function(){if(!this._content)return-1;var e=this.getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width}},{key:"_getContentRightBoundary",value:function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width}},{key:"_getContentTopBoundary",value:function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height}},{key:"_getContentBottomBoundary",value:function(){if(!this._content)return-1;var e=this.getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height}},{key:"_getHowMuchOutOfBoundary",value:function(e){if((e=e||new oa).equals(Sce,1e-4)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new oa;return this._getContentLeftBoundary()+e.x>this._leftBoundary?t.x=this._leftBoundary-(this._getContentLeftBoundary()+e.x):this._getContentRightBoundary()+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(this._getContentRightBoundary()+e.x)),this._getContentTopBoundary()+e.y<this._topBoundary?t.y=this._topBoundary-(this._getContentTopBoundary()+e.y):this._getContentBottomBoundary()+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(this._getContentBottomBoundary()+e.y)),e.equals(Sce,1e-4)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),t=this._clampDelta(t)}},{key:"_updateScrollBar",value:function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)}},{key:"_onScrollBarTouchBegan",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}},{key:"_onScrollBarTouchEnded",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}},{key:"_dispatchEvent",value:function(e){if(e===xce.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===xce.SCROLL_TO_TOP||e===xce.SCROLL_TO_BOTTOM||e===xce.SCROLL_TO_LEFT||e===xce.SCROLL_TO_RIGHT){var t=1<<wce[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}CB.emitEvents(this.scrollEvents,this,wce[e]),this.node.emit(e,this)}},{key:"_adjustContentOutOfBoundary",value:function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();Tce.set(this.getContentPosition()),Tce.add(e),this._content.setPosition(Tce),this._updateScrollBar(Sce)}}},{key:"_hideScrollBar",value:function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}},{key:"_updateScrollBarState",value:function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}}},{key:"_stopPropagationIfTargetIsMe",value:function(e){e.eventPhase===Fi.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)}},{key:"_processDeltaMove",value:function(e){this._scrollChildren(e),this._gatherTouchMove(e)}},{key:"_handleMoveLogic",value:function(e){this._deltaPos.set(this._getLocalAxisAlignDelta(e)),this._processDeltaMove(this._deltaPos)}},{key:"_handleReleaseLogic",value:function(e){this._deltaPos.set(this._getLocalAxisAlignDelta(e)),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(xce.SCROLL_ENDED))}},{key:"_getLocalAxisAlignDelta",value:function(e){var t=this.node._uiProps.uiTransformComp,i=new oa;return t&&(e.getUILocation(bce),e.getUIPreviousLocation(Ace),Tce.set(bce.x,bce.y,0),Ece.set(Ace.x,Ace.y,0),t.convertToNodeSpaceAR(Tce,Tce),t.convertToNodeSpaceAR(Ece,Ece),oa.subtract(i,Tce,Ece)),i}},{key:"_scrollChildren",value:function(e){var t,i,n=e=this._clampDelta(e);if(this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t)),this._content){var r=this._content._uiProps.uiTransformComp,a=r.anchorX,o=r.anchorY,s=r.width,l=r.height,c=this._content.position||Sce;if(n.y>0)c.y-o*l+n.y>=this._bottomBoundary&&(i=xce.SCROLL_TO_BOTTOM);else if(n.y<0){c.y-o*l+l+n.y<=this._topBoundary&&(i=xce.SCROLL_TO_TOP)}if(n.x<0)c.x-a*s+s+n.x<=this._rightBoundary&&(i=xce.SCROLL_TO_RIGHT);else if(n.x>0){c.x-a*s+n.x>=this._leftBoundary&&(i=xce.SCROLL_TO_LEFT)}}this._moveContent(n,!1),0===n.x&&0===n.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(xce.SCROLL_BEGAN)),this._dispatchEvent(xce.SCROLLING)),i&&i.length>0&&this._dispatchEvent(i)}},{key:"_handlePressLogic",value:function(){this._autoScrolling&&this._dispatchEvent(xce.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=Cce(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}},{key:"_clampDelta",value:function(e){if(this._content&&this.view){var t=this.view.contentSize,i=this._content._uiProps.uiTransformComp;i.width<t.width&&(e.x=0),i.height<t.height&&(e.y=0)}return e}},{key:"_gatherTouchMove",value:function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var i=Cce();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}},{key:"_startBounceBackIfNeeded",value:function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if((e=this._clampDelta(e)).equals(Sce,1e-4))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(xce.BOUNCE_TOP),e.y<0&&this._dispatchEvent(xce.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(xce.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(xce.BOUNCE_LEFT),this._isBouncing=!0),!0}},{key:"_processInertiaScroll",value:function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(Tce,1e-4)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()}},{key:"_isOutOfBoundary",value:function(){return!this._getHowMuchOutOfBoundary().equals(Sce,1e-4)}},{key:"_isNecessaryAutoScrollBrake",value:function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}},{key:"_processAutoScrolling",value:function(e){var t=this._isNecessaryAutoScrollBrake(),i=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/i);var n,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(n=r,r=(n-=1)*n*n*n*n+1);var a=new oa(this._autoScrollTargetDelta);a.multiplyScalar(r);var o=new oa(this._autoScrollStartPosition);o.add(a);var s=Math.abs(r-1)<=1e-4;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(xce.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var l=new oa(o);l.subtract(this._autoScrollBrakingStartPosition),t&&l.multiplyScalar(i),o.set(this._autoScrollBrakingStartPosition),o.add(l)}else{var c=new oa(o);c.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(c);u.equals(Sce,1e-4)||(o.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=new oa(o);h.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(h),s),this._dispatchEvent(xce.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(xce.SCROLL_ENDED))}},{key:"_checkMouseWheel",value:function(e){if(!this._getHowMuchOutOfBoundary().equals(Sce,1e-4))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(xce.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(xce.SCROLL_ENDED),this._stopMouseWheel=!1)}},{key:"_calculateMovePercentDelta",value:function(e){var t=e.anchor,i=e.applyToHorizontal,n=e.applyToVertical;this._calculateBoundary(),t.clampf(new ia(0,0),new ia(1,1));var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var a=this._getContentLeftBoundary()-this._leftBoundary;a=-a;var o=new oa;if(this._content&&this.view){var s=0,l=this._content._uiProps.uiTransformComp.contentSize,c=this.view.contentSize;i&&(s=l.width-c.width,o.x=a-s*t.x),n&&(s=l.height-c.height,o.y=r-s*t.y)}return o}},{key:"_moveContentToTopLeft",value:function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var i=new oa,n=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var a=this._content._uiProps.uiTransformComp.contentSize;a.height<e.height&&(n=a.height-e.height,i.y=t-n),a.width<e.width&&(n=a.width-e.width,i.x=r)}this._updateScrollBarState(),this._moveContent(i),this._adjustContentOutOfBoundary()}},{key:"_scaleChanged",value:function(e){e===nv.SCALE&&this._calculateBoundary()}},{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):z(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Sce)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Sce)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(yce),mce.EventType=xce,ace=S((rce=vce).prototype,"bounceDuration",[si,Ile,Ole,Mle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oce=S(rce.prototype,"brake",[si,Ple,kle,Dle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),sce=S(rce.prototype,"elastic",[si,Ble,Lle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lce=S(rce.prototype,"inertia",[si,Nle,Fle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),S(rce.prototype,"content",[zle,Ule,Gle],Object.getOwnPropertyDescriptor(rce.prototype,"content"),rce.prototype),cce=S(rce.prototype,"horizontal",[si,Hle,Vle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),S(rce.prototype,"horizontalScrollBar",[Wle,jle,qle],Object.getOwnPropertyDescriptor(rce.prototype,"horizontalScrollBar"),rce.prototype),uce=S(rce.prototype,"vertical",[si,Xle,Yle],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),S(rce.prototype,"verticalScrollBar",[Kle,Zle,Qle],Object.getOwnPropertyDescriptor(rce.prototype,"verticalScrollBar"),rce.prototype),hce=S(rce.prototype,"cancelInnerEvents",[si,Jle,$le],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_ce=S(rce.prototype,"scrollEvents",[ece,si,tce,ice],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dce=S(rce.prototype,"_content",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fce=S(rce.prototype,"_horizontalScrollBar",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pce=S(rce.prototype,"_verticalScrollBar",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nce=rce))||nce)||nce)||nce)||nce)||nce)),Qce=new oa;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Kce||(Kce={})),nt(Kce);var Jce,$ce,eue,tue,iue,nue,rue,aue,oue,sue,lue,cue,uue,hue,_ue,due,fue,pue,mue,vue,gue=e("SliderComponent",(Rce=ii("cc.Slider"),Ice=mi("i18n:cc.Slider"),Oce=ri(110),Mce=_i("UI/Slider"),Pce=ni(jv),kce=Li(Dk),Dce=Si(""),Bce=Li(Kce),Lce=Si(""),Nce=Ti([0,1,.01]),Fce=Si(" 0 - 1 "),zce=Li([CB]),Uce=Si(""),Rce(Gce=Ice(Gce=Oce(Gce=Mce(Gce=Pce((Yce=Xce=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"slideEvents",Vce,c(n)),x(n,"_handle",Wce,c(n)),x(n,"_direction",jce,c(n)),x(n,"_progress",qce,c(n)),n._offset=new oa,n._dragging=!1,n._touchHandle=!1,n._handleLocalPos=new oa,n._touchPos=new oa,n}return o(t,e),r(t,[{key:"__preload",value:function(){this._updateHandlePosition()}},{key:"onEnable",value:function(){this._updateHandlePosition(),this.node.on(lm.TOUCH_START,this._onTouchBegan,this),this.node.on(lm.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(lm.TOUCH_END,this._onTouchEnded,this),this.node.on(lm.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(lm.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(lm.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(lm.TOUCH_END,this._onTouchEnded,this))}},{key:"onDisable",value:function(){this.node.off(lm.TOUCH_START,this._onTouchBegan,this),this.node.off(lm.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(lm.TOUCH_END,this._onTouchEnded,this),this.node.off(lm.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(lm.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(lm.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(lm.TOUCH_END,this._onTouchEnded,this))}},{key:"_onHandleDragStart",value:function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();oa.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}}},{key:"_onTouchBegan",value:function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchMoved",value:function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)}},{key:"_onTouchEnded",value:function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new oa,e&&(e.propagationStopped=!0)}},{key:"_onTouchCancelled",value:function(e){this._dragging=!1,e&&(e.propagationStopped=!0)}},{key:"_handleSliderLogic",value:function(e){this._updateProgress(e),this._emitSlideEvent()}},{key:"_emitSlideEvent",value:function(){CB.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}},{key:"_updateProgress",value:function(e){if(this._handle&&e){var t=e.getUILocation();oa.set(this._touchPos,t.x,t.y,0);var i=this.node._uiProps.uiTransformComp,n=i.convertToNodeSpaceAR(this._touchPos,Qce);this.direction===Kce.Horizontal?this.progress=gn(.5+(n.x-this._offset.x)/i.width):this.progress=gn(.5+(n.y-this._offset.y)/i.height)}}},{key:"_updateHandlePosition",value:function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===Kce.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}}},{key:"_changeLayout",value:function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var i=this._handle.node.position;this._direction===Kce.Horizontal?this._handle.node.setPosition(i.x,0,i.z):this._handle.node.setPosition(0,i.y,i.z),this._updateHandlePosition()}}},{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(Yr),Xce.Direction=Kce,S((Hce=Yce).prototype,"handle",[kce,Dce],Object.getOwnPropertyDescriptor(Hce.prototype,"handle"),Hce.prototype),S(Hce.prototype,"direction",[Bce,Lce],Object.getOwnPropertyDescriptor(Hce.prototype,"direction"),Hce.prototype),S(Hce.prototype,"progress",[Ci,Nce,Fce],Object.getOwnPropertyDescriptor(Hce.prototype,"progress"),Hce.prototype),Vce=S(Hce.prototype,"slideEvents",[zce,si,Uce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wce=S(Hce.prototype,"_handle",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jce=S(Hce.prototype,"_direction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kce.Horizontal}}),qce=S(Hce.prototype,"_progress",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Gce=Hce))||Gce)||Gce)||Gce)||Gce)||Gce));function yue(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return Object.assign.apply(Object,[{}].concat(t))}!function(e){e.TOGGLE="toggle"}(vue||(vue={}));var xue,Sue,Tue,Eue,bue,Aue,Cue,wue,Rue,Iue,Oue,Mue,Pue,kue,Due,Bue,Lue,Nue,Fue,zue,Uue,Gue,Hue,Vue,Wue,jue,que,Xue,Yue,Kue,Zue,Que,Jue,$ue,ehe,the,ihe,nhe,rhe,ahe,ohe,she,lhe,che,uhe,hhe,_he,dhe,fhe,phe,mhe,vhe=e("ToggleComponent",(Jce=ii("cc.Toggle"),$ce=mi("i18n:cc.Toggle"),eue=ri(110),tue=_i("UI/Toggle"),iue=ni(jv),nue=wi(2),rue=Si(" true check mark  enabled  disabled "),aue=Li(Dk),oue=wi(3),sue=Si("Toggle "),lue=Li([CB]),cue=Si(""),Jce(uue=$ce(uue=eue(uue=tue(uue=iue((mue=pue=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"checkEvents",_ue,c(n)),x(n,"_isChecked",due,c(n)),x(n,"_checkMark",fue,c(n)),n}return o(t,e),r(t,[{key:"_internalToggle",value:function(){this.isChecked=!this.isChecked}},{key:"_set",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._isChecked!=e){this._isChecked=e;var i=this._toggleContainer;i&&i.enabled&&this.enabled&&(e||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}}},{key:"playEffect",value:function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}},{key:"setIsCheckedWithoutNotify",value:function(e){this._set(e,!1)}},{key:"onEnable",value:function(){_(s(t.prototype),"onEnable",this).call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)}},{key:"onDisable",value:function(){_(s(t.prototype),"onDisable",this).call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)}},{key:"OnDestroy",value:function(){var e=this._toggleContainer;e&&e.ensureValidState()}},{key:"_emitToggleEvents",value:function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&CB.emitEvents(this.checkEvents,this)}},{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return E.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(one),pue.EventType=yue(vue,Yte),S((hue=mue).prototype,"isChecked",[nue,rue],Object.getOwnPropertyDescriptor(hue.prototype,"isChecked"),hue.prototype),S(hue.prototype,"checkMark",[aue,oue,sue],Object.getOwnPropertyDescriptor(hue.prototype,"checkMark"),hue.prototype),_ue=S(hue.prototype,"checkEvents",[lue,si,cue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),due=S(hue.prototype,"_isChecked",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fue=S(hue.prototype,"_checkMark",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),uue=hue))||uue)||uue)||uue)||uue)||uue)),ghe=e("ToggleContainerComponent",(xue=ii("cc.ToggleContainer"),Sue=mi("i18n:cc.ToggleContainer"),Tue=ri(110),Eue=_i("UI/ToggleContainer"),bue=Si(" true  toggle "),Aue=Li([CB]),Cue=Si(""),xue(wue=Sue(wue=Tue(wue=Eue(wue=hi((Iue=S((Rue=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_allowSwitchOff",Iue,c(n)),x(n,"checkEvents",Oue,c(n)),n}return o(t,e),r(t,[{key:"start",value:function(){this.ensureValidState()}},{key:"activeToggles",value:function(){return this.toggleItems.filter((function(e){return e.isChecked}))}},{key:"anyTogglesChecked",value:function(){return!!this.toggleItems.find((function(e){return e.isChecked}))}},{key:"notifyToggleCheck",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.enabledInHierarchy){for(var i=0;i<this.toggleItems.length;i++){var n=this.toggleItems[i];n!==e&&(t?n.isChecked=!1:n.setIsCheckedWithoutNotify(!1))}this.checkEvents&&E.Component.EventHandler.emitEvents(this.checkEvents,e)}}},{key:"ensureValidState",value:function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var i=this.activeToggles();if(i.length>1)for(var n=i[0],r=0;r<i.length;++r){var a=i[r];a!==n&&(a.isChecked=!1)}}},{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");if(t&&t.enabled)return t})).filter(Boolean)}}]),t}(Yr)).prototype,"_allowSwitchOff",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S(Rue.prototype,"allowSwitchOff",[bue],Object.getOwnPropertyDescriptor(Rue.prototype,"allowSwitchOff"),Rue.prototype),Oue=S(Rue.prototype,"checkEvents",[Aue,si,Cue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wue=Rue))||wue)||wue)||wue)||wue)||wue)),yhe=e("UIModelComponent",ii("cc.UIMeshRenderer")(Mue=mi("i18n:cc.UIMeshRenderer")(Mue=ri(110)(Mue=_i("UI/UIMeshRenderer")(Mue=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._models=null,n._modelComponent=null,n}return o(t,e),r(t,[{key:"onLoad",value:function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?(this._modelComponent._sceneGetter=AB.root.ui.getRenderSceneGetter(),this._models=this._modelComponent._collectModels()):console.warn("node '".concat(this.node&&this.node.name,"' doesn't have any renderable component"))}},{key:"onEnable",value:function(){_(s(t.prototype),"onEnable",this).call(this),this._modelComponent&&this._modelComponent._attachToScene()}},{key:"onDisable",value:function(){_(s(t.prototype),"onDisable",this).call(this),this._modelComponent&&this._modelComponent._detachFromScene()}},{key:"onDestroy",value:function(){_(s(t.prototype),"onDestroy",this).call(this),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,E.isValid(this._modelComponent,!0)&&this._modelComponent._attachToScene(),this._models=null)}},{key:"updateAssembler",value:function(e){if(this._models){for(var t,i=y(this._models);!(t=i()).done;){var n=t.value;e.commitModel.call(e,this,n,this._modelComponent.material)}return!0}return!1}},{key:"update",value:function(){this._fitUIRenderQueue()}},{key:"_fitUIRenderQueue",value:function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var i=this._modelComponent.getMaterialInstance(t);if(null!=i)for(var n=i.passes,r=n.length,a=0;a<r;a++){var o=n[a];o._priority=Dh.MAX-11,o.blendState.targets[0].blend||i.overridePipelineStates({blendState:{targets:[{blend:!0}]}},a)}}}},{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(qee))||Mue)||Mue)||Mue)||Mue),xhe=new oa;function She(e){return e instanceof Yk?mO:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:wa.ZERO}function The(e,t,i,n){for(var r=e.parent?e.parent.getScale():xhe,a=r.x,o=r.y,s=0,l=0,c=e.parent;;){if(!c)return i.x=i.y=0,void(n.x=n.y=1);var u=c.getPosition();if(s+=u.x,l+=u.y,(c=c.parent)===t)break;var h=(r=c?c.getScale():xhe).x,_=r.y;s*=h,l*=_,a*=h,o*=_}n.x=0!==a?1/a:1,n.y=0!==o?1/o:1,i.x=-s,i.y=-l}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(phe||(phe={})),nt(phe),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(mhe||(mhe={}));var Ehe,bhe,Ahe,Che,whe,Rhe,Ihe,Ohe,Mhe,Phe,khe,Dhe,Bhe,Lhe,Nhe,Fhe,zhe,Uhe,Ghe,Hhe=mhe.TOP|mhe.BOT,Vhe=mhe.LEFT|mhe.RIGHT,Whe=e("WidgetComponent",(Pue=ii("cc.Widget"),kue=mi("i18n:cc.Widget"),Due=ri(110),Bue=_i("UI/Widget"),Lue=ni(jv),Nue=Li(ig),Fue=Si(""),zue=Si(""),Uue=Si(""),Gue=Si(""),Hue=Si(""),Vue=Si(""),Wue=Si(""),jue=Li(phe),que=Si(" widget  widget "),Pue(Xue=kue(Xue=Due(Xue=Bue(Xue=Lue(Xue=hi((fhe=dhe=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._lastPos=new oa,n._lastSize=new wa,n._dirty=!0,x(n,"_alignFlags",Kue,c(n)),x(n,"_target",Zue,c(n)),x(n,"_left",Que,c(n)),x(n,"_right",Jue,c(n)),x(n,"_top",$ue,c(n)),x(n,"_bottom",ehe,c(n)),x(n,"_horizontalCenter",the,c(n)),x(n,"_verticalCenter",ihe,c(n)),x(n,"_isAbsLeft",nhe,c(n)),x(n,"_isAbsRight",rhe,c(n)),x(n,"_isAbsTop",ahe,c(n)),x(n,"_isAbsBottom",ohe,c(n)),x(n,"_isAbsHorizontalCenter",she,c(n)),x(n,"_isAbsVerticalCenter",lhe,c(n)),x(n,"_originalWidth",che,c(n)),x(n,"_originalHeight",uhe,c(n)),x(n,"_alignMode",hhe,c(n)),x(n,"_lockFlags",_he,c(n)),n}return o(t,e),r(t,[{key:"updateAlignment",value:function(){E._widgetManager.updateAlignment(this.node)}},{key:"_validateTargetInDEV",value:function(){}},{key:"setDirty",value:function(){this._recursiveDirty()}},{key:"onEnable",value:function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),E._widgetManager.add(this),this._registerEvent(),this._registerTargetEvents()}},{key:"onDisable",value:function(){E._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}},{key:"onDestroy",value:function(){this._removeParentEvent()}},{key:"_adjustWidgetToAllowMovingInEditor",value:function(e){if(e&nv.POSITION&&!E._widgetManager.isAligning){var t=this.node.getPosition(),i=this._lastPos,n=new oa(t);n.subtract(i);var r=this.node.parent,a=new oa(1,1,1);if(this.target&&(r=this.target,The(this.node,r,new oa,a)),r){var o=She(r),s=new oa;0!==o.width&&0!==o.height&&oa.set(s,n.x/o.width,n.y/o.height,s.z),this.isAlignTop&&(this._top-=(this._isAbsTop?n.y:s.y)*a.y),this.isAlignBottom&&(this._bottom+=(this._isAbsBottom?n.y:s.y)*a.y),this.isAlignLeft&&(this._left+=(this._isAbsLeft?n.x:s.x)*a.x),this.isAlignRight&&(this._right-=(this._isAbsRight?n.x:s.x)*a.x),this.isAlignHorizontalCenter&&(this._horizontalCenter+=(this._isAbsHorizontalCenter?n.x:s.x)*a.x),this.isAlignVerticalCenter&&(this._verticalCenter+=(this._isAbsVerticalCenter?n.y:s.y)*a.y),this._recursiveDirty()}}}},{key:"_adjustWidgetToAllowResizingInEditor",value:function(){if(!E._widgetManager.isAligning){this.setDirty();var e=this.node._uiProps.uiTransformComp,t=e.contentSize,i=this._lastSize,n=new oa(t.width-i.width,t.height-i.height,0),r=this.node.parent,a=new oa(1,1,1);if(this.target&&(r=this.target,The(this.node,r,new oa,a)),r){var o=She(r),s=new oa;0!==o.width&&0!==o.height&&oa.set(s,n.x/o.width,n.y/o.height,s.z);var l=e.anchorPoint;this.isAlignTop&&(this._top-=(this._isAbsTop?n.y:s.y)*(1-l.y)*a.y),this.isAlignBottom&&(this._bottom-=(this._isAbsBottom?n.y:s.y)*l.y*a.y),this.isAlignLeft&&(this._left-=(this._isAbsLeft?n.x:s.x)*l.x*a.x),this.isAlignRight&&(this._right-=(this._isAbsRight?n.x:s.x)*(1-l.x)*a.x),this._recursiveDirty()}}}},{key:"_adjustWidgetToAnchorChanged",value:function(){this.setDirty()}},{key:"_adjustTargetToParentChanged",value:function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents()}},{key:"_registerEvent",value:function(){this.node.on(lm.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.on(lm.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.on(lm.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(lm.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_unregisterEvent",value:function(){this.node.off(lm.TRANSFORM_CHANGED,this._adjustWidgetToAllowMovingInEditor,this),this.node.off(lm.SIZE_CHANGED,this._adjustWidgetToAllowResizingInEditor,this),this.node.off(lm.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}},{key:"_removeParentEvent",value:function(){this.node.off(lm.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}},{key:"_autoChangedValue",value:function(e,t){var i=(this._alignFlags&e)>0,n=this.node.parent&&this.node.parent._uiProps.uiTransformComp;if(i&&n){var r=n.contentSize;this.isAlignLeft&&e===mhe.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===mhe.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===mhe.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===mhe.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===mhe.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===mhe.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}}},{key:"_registerTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.getComponent(jv)?(e.on(lm.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.on(lm.SIZE_CHANGED,this._targetChangedOperation,this)):G(6501,this.node.name))}},{key:"_unregisterTargetEvents",value:function(){var e=this._target||this.node.parent;e&&(e.off(lm.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(lm.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_unregisterOldParentEvents",value:function(e){var t=this._target||e;t&&(t.off(lm.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.off(lm.SIZE_CHANGED,this._targetChangedOperation,this))}},{key:"_targetChangedOperation",value:function(){this._recursiveDirty()}},{key:"_setAlign",value:function(e,t){if(t!==(this._alignFlags&e)>0){var i=(e&Vhe)>0,n=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=n.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=n.height))):(i?this.isStretchWidth&&(n.width=this._originalWidth):this.isStretchHeight&&(n.height=this._originalHeight),this._alignFlags&=~e)}}},{key:"_recursiveDirty",value:function(){this._dirty||(this._dirty=!0)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&mhe.TOP)>0},set:function(e){this._setAlign(mhe.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&mhe.BOT)>0},set:function(e){this._setAlign(mhe.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&mhe.LEFT)>0},set:function(e){this._setAlign(mhe.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&mhe.RIGHT)>0},set:function(e){this._setAlign(mhe.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&mhe.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=mhe.MID):this._alignFlags&=~mhe.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&mhe.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=mhe.CENTER):this._alignFlags&=~mhe.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&Vhe)===Vhe}},{key:"isStretchHeight",get:function(){return(this._alignFlags&Hhe)===Hhe}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(mhe.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(mhe.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(mhe.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(mhe.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(mhe.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(mhe.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(Yr),dhe.AlignMode=phe,S((Yue=fhe).prototype,"target",[Nue,Fue],Object.getOwnPropertyDescriptor(Yue.prototype,"target"),Yue.prototype),S(Yue.prototype,"isAlignTop",[zue],Object.getOwnPropertyDescriptor(Yue.prototype,"isAlignTop"),Yue.prototype),S(Yue.prototype,"isAlignBottom",[Uue],Object.getOwnPropertyDescriptor(Yue.prototype,"isAlignBottom"),Yue.prototype),S(Yue.prototype,"isAlignLeft",[Gue],Object.getOwnPropertyDescriptor(Yue.prototype,"isAlignLeft"),Yue.prototype),S(Yue.prototype,"isAlignRight",[Hue],Object.getOwnPropertyDescriptor(Yue.prototype,"isAlignRight"),Yue.prototype),S(Yue.prototype,"isAlignVerticalCenter",[Vue],Object.getOwnPropertyDescriptor(Yue.prototype,"isAlignVerticalCenter"),Yue.prototype),S(Yue.prototype,"isAlignHorizontalCenter",[Wue],Object.getOwnPropertyDescriptor(Yue.prototype,"isAlignHorizontalCenter"),Yue.prototype),S(Yue.prototype,"editorTop",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"editorTop"),Yue.prototype),S(Yue.prototype,"editorBottom",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"editorBottom"),Yue.prototype),S(Yue.prototype,"editorLeft",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"editorLeft"),Yue.prototype),S(Yue.prototype,"editorRight",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"editorRight"),Yue.prototype),S(Yue.prototype,"editorHorizontalCenter",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"editorHorizontalCenter"),Yue.prototype),S(Yue.prototype,"editorVerticalCenter",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"editorVerticalCenter"),Yue.prototype),S(Yue.prototype,"isAbsoluteTop",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"isAbsoluteTop"),Yue.prototype),S(Yue.prototype,"isAbsoluteBottom",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"isAbsoluteBottom"),Yue.prototype),S(Yue.prototype,"isAbsoluteLeft",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"isAbsoluteLeft"),Yue.prototype),S(Yue.prototype,"isAbsoluteRight",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"isAbsoluteRight"),Yue.prototype),S(Yue.prototype,"isAbsoluteHorizontalCenter",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"isAbsoluteHorizontalCenter"),Yue.prototype),S(Yue.prototype,"isAbsoluteVerticalCenter",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"isAbsoluteVerticalCenter"),Yue.prototype),S(Yue.prototype,"alignMode",[jue,que],Object.getOwnPropertyDescriptor(Yue.prototype,"alignMode"),Yue.prototype),S(Yue.prototype,"alignFlags",[vi],Object.getOwnPropertyDescriptor(Yue.prototype,"alignFlags"),Yue.prototype),Kue=S(Yue.prototype,"_alignFlags",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zue=S(Yue.prototype,"_target",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Que=S(Yue.prototype,"_left",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jue=S(Yue.prototype,"_right",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$ue=S(Yue.prototype,"_top",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ehe=S(Yue.prototype,"_bottom",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),the=S(Yue.prototype,"_horizontalCenter",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ihe=S(Yue.prototype,"_verticalCenter",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nhe=S(Yue.prototype,"_isAbsLeft",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rhe=S(Yue.prototype,"_isAbsRight",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ahe=S(Yue.prototype,"_isAbsTop",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ohe=S(Yue.prototype,"_isAbsBottom",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),she=S(Yue.prototype,"_isAbsHorizontalCenter",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lhe=S(Yue.prototype,"_isAbsVerticalCenter",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),che=S(Yue.prototype,"_originalWidth",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uhe=S(Yue.prototype,"_originalHeight",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hhe=S(Yue.prototype,"_alignMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return phe.ON_WINDOW_RESIZE}}),_he=S(Yue.prototype,"_lockFlags",[si,ci],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xue=Yue))||Xue)||Xue)||Xue)||Xue)||Xue)||Xue));E.internal.computeInverseTransForTarget=The,E.internal.getReadonlyNodeSize=She;var jhe,qhe=new Ma;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(jhe||(jhe={})),nt(jhe);var Xhe,Yhe,Khe,Zhe,Qhe,Jhe,$he,e_e,t_e,i_e,n_e,r_e,a_e,o_e,s_e,l_e,c_e,u_e,h_e,__e,d_e,f_e,p_e,m_e,v_e,g_e,y_e,x_e,S_e,T_e,E_e,b_e,A_e,C_e,w_e,R_e,I_e,O_e,M_e,P_e,k_e,D_e,B_e,L_e,N_e,F_e=e("PageViewIndicatorComponent",(Ehe=ii("cc.PageViewIndicator"),bhe=mi("i18n:cc.PageViewIndicator"),Ahe=ri(110),Che=_i("UI/PageViewIndicator"),whe=Li(Pd),Rhe=Si(""),Ihe=Li(jhe),Ohe=Si(""),Mhe=Li(wa),Phe=Si(""),khe=Si(""),Ehe(Dhe=bhe(Dhe=Ahe(Dhe=Che((Ghe=Uhe=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"spacing",Lhe,c(n)),x(n,"_spriteFrame",Nhe,c(n)),x(n,"_direction",Fhe,c(n)),x(n,"_cellSize",zhe,c(n)),n._layout=null,n._pageView=null,n._indicators=[],n}return o(t,e),r(t,[{key:"onLoad",value:function(){this._updateLayout()}},{key:"setPageView",value:function(e){this._pageView=e,this._refresh()}},{key:"_updateLayout",value:function(){this._layout=this.getComponent(Jae),this._layout||(this._layout=this.addComponent(Jae));var e=this._layout;this.direction===jhe.HORIZONTAL?(e.type=Jae.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===jhe.VERTICAL&&(e.type=Jae.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=Jae.ResizeMode.CONTAINER}},{key:"_createIndicator",value:function(){var e=new ig,t=e.addComponent(Dk);return t.spriteFrame=this.spriteFrame,t.sizeMode=Dk.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e}},{key:"_changedState",value:function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var i=0;i<e.length;++i){var n=e[i];if(n._uiProps.uiComp){var r=n._uiProps.uiComp;qhe.set(r.color),qhe.a=127.5,r.color=qhe}}if(e[t]._uiProps.uiComp){var a=e[t]._uiProps.uiComp;qhe.set(a.color),qhe.a=255,a.color=qhe}}}}},{key:"_refresh",value:function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var i=0;if(t.length>e.length)for(i=0;i<t.length;++i)e[i]||(e[i]=this._createIndicator());else for(i=e.length-t.length;i>0;--i){var n=e[i-1];this.node.removeChild(n),e.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(Yr),Uhe.Direction=jhe,S((Bhe=Ghe).prototype,"spriteFrame",[whe,Rhe],Object.getOwnPropertyDescriptor(Bhe.prototype,"spriteFrame"),Bhe.prototype),S(Bhe.prototype,"direction",[Ihe,Ohe],Object.getOwnPropertyDescriptor(Bhe.prototype,"direction"),Bhe.prototype),S(Bhe.prototype,"cellSize",[Mhe,Phe],Object.getOwnPropertyDescriptor(Bhe.prototype,"cellSize"),Bhe.prototype),Lhe=S(Bhe.prototype,"spacing",[si,khe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nhe=S(Bhe.prototype,"_spriteFrame",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fhe=S(Bhe.prototype,"_direction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jhe.HORIZONTAL}}),zhe=S(Bhe.prototype,"_cellSize",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wa(20,20)}}),Dhe=Bhe))||Dhe)||Dhe)||Dhe)||Dhe)),z_e=new ia;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(B_e||(B_e={})),nt(B_e),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(L_e||(L_e={})),nt(L_e),function(e){e.PAGE_TURNING="page-turning"}(N_e||(N_e={}));var U_e,G_e,H_e,V_e,W_e,j_e,q_e,X_e,Y_e,K_e,Z_e,Q_e,J_e,$_e,ede,tde,ide,nde,rde,ade,ode,sde,lde,cde,ude,hde,_de,dde,fde,pde,mde,vde,gde,yde,xde,Sde,Tde=e("PageViewComponent",(Xhe=ii("cc.PageView"),Yhe=mi("i18n:cc.PageView"),Khe=ri(110),Zhe=_i("UI/PageView"),Qhe=Li(B_e),Jhe=Si(""),$he=Li(L_e),e_e=Si(""),t_e=Ti([0,1,.01]),i_e=Si(""),n_e=Ti([0,1,.01]),r_e=Si(" PageView PageTurning "),a_e=Li(F_e),o_e=Si(""),s_e=Si("\n\n"),l_e=Li(gce),c_e=gi(!1),u_e=Li(gce),h_e=gi(!1),__e=gi(!1),d_e=gi(!1),f_e=gi(!1),p_e=Li([CB]),m_e=gi(!1),v_e=Li([CB]),g_e=Si(""),Xhe(y_e=Yhe(y_e=Khe(y_e=Zhe((D_e=k_e=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"autoPageTurningThreshold",S_e,c(n)),x(n,"horizontal",T_e,c(n)),x(n,"vertical",E_e,c(n)),x(n,"cancelInnerEvents",b_e,c(n)),x(n,"scrollEvents",A_e,c(n)),x(n,"pageTurningSpeed",C_e,c(n)),x(n,"pageEvents",w_e,c(n)),x(n,"_sizeMode",R_e,c(n)),x(n,"_direction",I_e,c(n)),x(n,"_scrollThreshold",O_e,c(n)),x(n,"_pageTurningEventTiming",M_e,c(n)),x(n,"_indicator",P_e,c(n)),n._curPageIdx=0,n._lastPageIdx=0,n._pages=[],n._initContentPos=new oa,n._scrollCenterOffsetX=[],n._scrollCenterOffsetY=[],n._touchBeganPosition=new oa,n._touchEndPosition=new oa,n}return o(t,e),r(t,[{key:"__preload",value:function(){this.node.on(lm.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"onEnable",value:function(){_(s(t.prototype),"onEnable",this).call(this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onDisable",value:function(){_(s(t.prototype),"onDisable",this).call(this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}},{key:"onLoad",value:function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}},{key:"onDestroy",value:function(){this.node.off(lm.SIZE_CHANGED,this._updateAllPagesSize,this)}},{key:"getCurrentPageIndex",value:function(){return this._curPageIdx}},{key:"setCurrentPageIndex",value:function(e){this.scrollToPage(e,1)}},{key:"getPages",value:function(){return this._pages}},{key:"addPage",value:function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):z(4301))}},{key:"insertPage",value:function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void z(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}}},{key:"removePage",value:function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):G(4300,e.name)}}},{key:"removePageAtIndex",value:function(e){var t=this._pages;if(!(e<0||e>=t.length)){var i=t[e];i&&this.content&&(this.content.removeChild(i),t.splice(e,1),this._updatePageView())}}},{key:"removeAllPages",value:function(){if(this.content){for(var e=this._pages,t=0,i=e.length;t<i;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}}},{key:"scrollToPage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3;e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())}},{key:"getScrollEndedEventTiming",value:function(){return this.pageTurningEventTiming}},{key:"_updatePageView",value:function(){if(this.content){var e=this.content.getComponent(Jae);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var i=this._initContentPos,n=0;n<t;++n){var r=this._pages[n].position;this.direction===L_e.Horizontal?this._scrollCenterOffsetX[n]=Math.abs(i.x+r.x):this._scrollCenterOffsetY[n]=Math.abs(i.y+r.y)}this.indicator&&this.indicator._refresh()}}},{key:"_updateAllPagesSize",value:function(){var e=this.view;if(this.content&&e&&this._sizeMode===B_e.Unified)for(var t=this._pages,i=e.contentSize,n=0,r=t.length;n<r;n++)t[n]._uiProps.uiTransformComp.setContentSize(i)}},{key:"_handleReleaseLogic",value:function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))}},{key:"_onTouchBegan",value:function(e,i){e.touch.getUILocation(z_e),oa.set(this._touchBeganPosition,z_e.x,z_e.y,0),_(s(t.prototype),"_onTouchBegan",this).call(this,e,i)}},{key:"_onTouchMoved",value:function(e,i){_(s(t.prototype),"_onTouchMoved",this).call(this,e,i)}},{key:"_onTouchEnded",value:function(e,i){e.touch.getUILocation(z_e),oa.set(this._touchEndPosition,z_e.x,z_e.y,0),_(s(t.prototype),"_onTouchEnded",this).call(this,e,i)}},{key:"_onTouchCancelled",value:function(e,i){e.touch.getUILocation(z_e),oa.set(this._touchEndPosition,z_e.x,z_e.y,0),_(s(t.prototype),"_onTouchCancelled",this).call(this,e,i)}},{key:"_onMouseWheel",value:function(){}},{key:"_syncScrollDirection",value:function(){this.horizontal=this.direction===L_e.Horizontal,this.vertical=this.direction===L_e.Vertical}},{key:"_syncSizeMode",value:function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(Jae);if(t){if(this._sizeMode===B_e.Free&&this._pages.length>0){var i=this._pages[0]._uiProps.uiTransformComp,n=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===L_e.Horizontal?(t.paddingLeft=(e.width-i.width)/2,t.paddingRight=(e.width-n.width)/2):this.direction===L_e.Vertical&&(t.paddingTop=(e.height-i.height)/2,t.paddingBottom=(e.height-n.height)/2)}t.updateLayout()}}}},{key:"_initPages",value:function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var i=e[t];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}}},{key:"_dispatchPageTurningEvent",value:function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,CB.emitEvents(this.pageEvents,this,N_e.PAGE_TURNING),this.node.emit(N_e.PAGE_TURNING,this))}},{key:"_isQuicklyScrollable",value:function(e){if(this.direction===L_e.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===L_e.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1}},{key:"_moveOffsetValue",value:function(e){var t=new oa;if(this._sizeMode===B_e.Free)this.direction===L_e.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===L_e.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var i=this.view;if(!i)return t;this.direction===L_e.Horizontal?t.x=e*i.width:this.direction===L_e.Vertical&&(t.y=e*i.height)}return t}},{key:"_getDragDirection",value:function(e){return this._direction===L_e.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1}},{key:"_isScrollable",value:function(e,t,i){if(this._sizeMode===B_e.Free){var n=0,r=0;if(this.direction===L_e.Horizontal)return n=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[i],Math.abs(e.x)>=Math.abs(n-r)*this.scrollThreshold;if(this.direction===L_e.Vertical)return n=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[i],Math.abs(e.y)>=Math.abs(n-r)*this.scrollThreshold}else{var a=this.view;if(!a)return;if(this.direction===L_e.Horizontal)return Math.abs(e.x)>=a.width*this.scrollThreshold;if(this.direction===L_e.Vertical)return Math.abs(e.y)>=a.height*this.scrollThreshold}}},{key:"_autoScrollToPage",value:function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();((e=this._clampDelta(e)).x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new oa;oa.subtract(t,this._touchBeganPosition,this._touchEndPosition);var i=this._curPageIdx,n=i+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(i-n);if(n<this._pages.length){if(this._isScrollable(t,i,n))return void this.scrollToPage(n,r);var a=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(a))return void this.scrollToPage(n,r)}this.scrollToPage(i,r)}}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return _(s(t.prototype),"verticalScrollBar",this)},set:function(e){f(s(t.prototype),"verticalScrollBar",e,this,!0)}},{key:"horizontalScrollBar",get:function(){return _(s(t.prototype),"horizontalScrollBar",this)},set:function(e){f(s(t.prototype),"horizontalScrollBar",e,this,!0)}}]),t}(Zce),k_e.SizeMode=B_e,k_e.Direction=L_e,k_e.EventType=yue(N_e,xce),S((x_e=D_e).prototype,"sizeMode",[Qhe,Jhe],Object.getOwnPropertyDescriptor(x_e.prototype,"sizeMode"),x_e.prototype),S(x_e.prototype,"direction",[$he,e_e],Object.getOwnPropertyDescriptor(x_e.prototype,"direction"),x_e.prototype),S(x_e.prototype,"scrollThreshold",[Ci,t_e,i_e],Object.getOwnPropertyDescriptor(x_e.prototype,"scrollThreshold"),x_e.prototype),S(x_e.prototype,"pageTurningEventTiming",[Ci,n_e,r_e],Object.getOwnPropertyDescriptor(x_e.prototype,"pageTurningEventTiming"),x_e.prototype),S(x_e.prototype,"indicator",[a_e,o_e],Object.getOwnPropertyDescriptor(x_e.prototype,"indicator"),x_e.prototype),S_e=S(x_e.prototype,"autoPageTurningThreshold",[si,s_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),S(x_e.prototype,"verticalScrollBar",[l_e,Ni,c_e],Object.getOwnPropertyDescriptor(x_e.prototype,"verticalScrollBar"),x_e.prototype),S(x_e.prototype,"horizontalScrollBar",[u_e,Ni,h_e],Object.getOwnPropertyDescriptor(x_e.prototype,"horizontalScrollBar"),x_e.prototype),T_e=S(x_e.prototype,"horizontal",[Ni,si,__e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),E_e=S(x_e.prototype,"vertical",[Ni,si,d_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),b_e=S(x_e.prototype,"cancelInnerEvents",[Ni,si,f_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),A_e=S(x_e.prototype,"scrollEvents",[p_e,si,Ni,m_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),C_e=S(x_e.prototype,"pageTurningSpeed",[si,vi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),w_e=S(x_e.prototype,"pageEvents",[v_e,si,g_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),R_e=S(x_e.prototype,"_sizeMode",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return B_e.Unified}}),I_e=S(x_e.prototype,"_direction",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return L_e.Horizontal}}),O_e=S(x_e.prototype,"_scrollThreshold",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),M_e=S(x_e.prototype,"_pageTurningEventTiming",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),P_e=S(x_e.prototype,"_indicator",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y_e=x_e))||y_e)||y_e)||y_e)||y_e)),Ede=e("UIStaticBatchComponent",(U_e=ii("cc.UIStaticBatch"),G_e=mi("i18n:cc.UIStaticBatch"),H_e=_i("UI/Render/UIStaticBatch"),V_e=ri(110),W_e=gi(!1),j_e=gi(!1),q_e=gi(!1),X_e=Li(sm),Y_e=xi("Materials"),K_e=gi(!1),U_e(Z_e=G_e(Z_e=H_e(Z_e=V_e((S((Q_e=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))))._init=!1,n._meshBuffer=null,n._dirty=!0,n._lastMeshBuffer=null,n._uiDrawBatchList=[],n}return o(t,e),r(t,[{key:"onLoad",value:function(){var e=this._getUI();if(e){var t=GD,i=new qD(e);i.initialize(t,this._arrivalMaxBuffer),this._meshBuffer=i}}},{key:"onDestroy",value:function(){_(s(t.prototype),"onDestroy",this).call(this),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)}},{key:"updateAssembler",value:function(e){this._dirty&&(e.finishMergeBatches(),this._lastMeshBuffer=e.currBufferBatch,e.currBufferBatch=this._meshBuffer,e.currStaticRoot=this),this._init&&(e.finishMergeBatches(),e.commitStaticBatch(this))}},{key:"postUpdateAssembler",value:function(e){this._dirty&&(e.finishMergeBatches(),e.currBufferBatch=this._lastMeshBuffer,e.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadData())}},{key:"markAsDirty",value:function(){this._getUI()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())}},{key:"_requireDrawBatch",value:function(){var e=new QD;return e.isStatic=!0,this._uiDrawBatchList.push(e),e}},{key:"_clearData",value:function(){if(this._meshBuffer){this._meshBuffer.reset();for(var e=this._getUI(),t=0;t<this._uiDrawBatchList.length;t++){this._uiDrawBatchList[t].destroy(e)}}this._uiDrawBatchList.length=0,this._init=!1}},{key:"_getUI",value:function(){return AB.root&&AB.root.ui?AB.root.ui:(G(9301),null)}},{key:"_arrivalMaxBuffer",value:function(){G(9300)}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateColor(),this.markForUpdateRenderData())}},{key:"sharedMaterials",get:function(){return _(s(t.prototype),"sharedMaterials",this)},set:function(e){f(s(t.prototype),"sharedMaterials",e,this,!0)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(YM)).prototype,"dstBlendFactor",[Ni,W_e],Object.getOwnPropertyDescriptor(Q_e.prototype,"dstBlendFactor"),Q_e.prototype),S(Q_e.prototype,"srcBlendFactor",[Ni,j_e],Object.getOwnPropertyDescriptor(Q_e.prototype,"srcBlendFactor"),Q_e.prototype),S(Q_e.prototype,"color",[Ni,q_e],Object.getOwnPropertyDescriptor(Q_e.prototype,"color"),Q_e.prototype),S(Q_e.prototype,"sharedMaterials",[Ni,X_e,Y_e,K_e],Object.getOwnPropertyDescriptor(Q_e.prototype,"sharedMaterials"),Q_e.prototype),Z_e=Q_e))||Z_e)||Z_e)||Z_e)||Z_e)),bde=e("UIOpacityComponent",ii("cc.UIOpacity")(J_e=mi("i18n:cc.UIOpacity")(J_e=ri(110)(J_e=_i("UI/UIOpacity")(J_e=hi((S(($_e=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_opacity",ede,c(n)),n}return o(t,e),r(t,[{key:"onEnable",value:function(){this.node._uiProps.opacity=this._opacity/255}},{key:"onDisable",value:function(){this.node._uiProps.opacity=1}},{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(this._opacity=e,this.node._uiProps.opacity=e/255)}}]),t}(Yr)).prototype,"opacity",[vi],Object.getOwnPropertyDescriptor($_e.prototype,"opacity"),$_e.prototype),ede=S($_e.prototype,"_opacity",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),J_e=$_e))||J_e)||J_e)||J_e)||J_e)||J_e),Ade=e("SafeAreaComponent",ii("cc.SafeArea")(tde=mi("i18n:cc.SafeArea")(tde=ri(110)(tde=hi(tde=_i("UI/SafeArea")(tde=ni(Whe)(tde=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"onEnable",value:function(){this.updateArea(),PO.on("canvas-resize",this.updateArea,this)}},{key:"onDisable",value:function(){PO.off("canvas-resize",this.updateArea,this)}},{key:"updateArea",value:function(){var e=this.node.getComponent(Whe),t=this.node.getComponent(jv);if(e&&t){var i=E.winSize,n=E.sys;e.updateAlignment();var r=this.node.position,a=t.anchorPoint;e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var o=i.width,s=i.height,l=n.getSafeAreaRect();console.log(l),e.top=s-l.y-l.height,e.bottom=l.y,e.left=l.x,e.right=o-l.x-l.width,e.updateAlignment();var c=this.node.position,u=a.x-(c.x-r.x)/t.width,h=a.y-(c.y-r.y)/t.height;t.setAnchorPoint(u,h),e.enabled=!0}}}]),t}(Yr))||tde)||tde)||tde)||tde)||tde)||tde),Cde=e("UICoordinateTrackerComponent",(ide=ii("cc.UICoordinateTracker"),nde=mi("i18n:cc.UICoordinateTracker"),rde=_i("UI/UICoordinateTracker"),ade=ri(110),ode=Li(ig),sde=Si(""),lde=Li(KN),cde=Si(""),ude=Si(""),hde=Si(""),_de=Li([CB]),dde=Si(""),ide(fde=nde(fde=rde(fde=ade((S((pde=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"syncEvents",mde,c(n)),x(n,"_target",vde,c(n)),x(n,"_camera",gde,c(n)),x(n,"_useScale",yde,c(n)),x(n,"_distance",xde,c(n)),n._transformPos=new oa,n._viewPos=new oa,n._canMove=!0,n._lastWpos=new oa,n._lastCameraPos=new oa,n}return o(t,e),r(t,[{key:"onEnable",value:function(){this._checkCanMove()}},{key:"update",value:function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t._camera&&(!this._lastWpos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWpos.set(e),this._lastCameraPos.set(t.node.worldPosition),t._camera.update(),DC.WorldNode3DToLocalNodeUI(t,e,this._target,this._transformPos),this._useScale&&oa.transformMat4(this._viewPos,this.node.worldPosition,t._camera.matView),this.syncEvents.length>0)){var i=this._distance/Math.abs(this._viewPos.z);CB.emitEvents(this.syncEvents,this._transformPos,i)}}},{key:"_checkCanMove",value:function(){this._canMove=!(!this._camera||!this._target)}},{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(Yr)).prototype,"target",[ode,sde],Object.getOwnPropertyDescriptor(pde.prototype,"target"),pde.prototype),S(pde.prototype,"camera",[lde,cde],Object.getOwnPropertyDescriptor(pde.prototype,"camera"),pde.prototype),S(pde.prototype,"useScale",[ude],Object.getOwnPropertyDescriptor(pde.prototype,"useScale"),pde.prototype),S(pde.prototype,"distance",[hde],Object.getOwnPropertyDescriptor(pde.prototype,"distance"),pde.prototype),mde=S(pde.prototype,"syncEvents",[_de,si,dde],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vde=S(pde.prototype,"_target",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gde=S(pde.prototype,"_camera",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yde=S(pde.prototype,"_useScale",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xde=S(pde.prototype,"_distance",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),fde=pde))||fde)||fde)||fde)||fde)),wde=[lm.TOUCH_START,lm.TOUCH_END,lm.TOUCH_MOVE,lm.MOUSE_DOWN,lm.MOUSE_MOVE,lm.MOUSE_UP,lm.MOUSE_ENTER,lm.MOUSE_LEAVE,lm.MOUSE_WHEEL];function Rde(e){e.propagationStopped=!0}var Ide=e("BlockInputEventsComponent",ii("cc.BlockInputEvents")(Sde=mi("i18n:cc.BlockInputEvents")(Sde=_i("Components/BlockInputEvents")(Sde=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"onEnable",value:function(){for(var e=0;e<wde.length;e++)this.node.on(wde[e],Rde,this)}},{key:"onDisable",value:function(){for(var e=0;e<wde.length;e++)this.node.off(wde[e],Rde,this)}}]),t}(Yr))||Sde)||Sde)||Sde),Ode=new oa,Mde=new ia,Pde=new oa,kde=new oa(1,1,1);function Dde(e,t){var i,n=t.target,r=Pde,a=kde;if(n?The(e,i=n,r,a):i=e.parent,i.getComponent(jv)){var o=She(i),s=i instanceof Yk,l=s?Mde:i.getComponent(jv).anchorPoint,c=s;e.getPosition(Ode);var u=e._uiProps.uiTransformComp,h=Ode.x,_=Ode.y,d=u.anchorPoint,f=e.getScale();if(t.alignFlags&mhe.HORIZONTAL){var p=0,m=0,v=o.width;c?(p=mO.left.x,m=mO.right.x):m=(p=-l.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,n&&(p+=r.x,p*=a.x,m+=r.x,m*=a.x);var g=0,y=d.x,x=f.x;if(x<0&&(y=1-y,x=-x),t.isStretchWidth)g=m-p,0!==x&&(u.width=g/x),h=p+y*g;else if(g=u.width*x,t.isAlignHorizontalCenter){var S=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,T=(.5-l.x)*o.width;n&&(S*=a.x,T+=r.x,T*=a.x),h=T+(y-.5)*g+S}else h=t.isAlignLeft?p+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&mhe.VERTICAL){var E=0,b=0,A=o.height;c?(b=mO.bottom.y,E=mO.top.y):E=(b=-l.y*A)+A,b+=t.isAbsoluteBottom?t.bottom:t.bottom*A,E-=t.isAbsoluteTop?t.top:t.top*A,n&&(b+=r.y,b*=a.y,E+=r.y,E*=a.y);var C=0,w=d.y,R=f.y;if(R<0&&(w=1-w,R=-R),t.isStretchHeight)C=E-b,0!==R&&(u.height=C/R),_=b+w*C;else if(C=u.height*R,t.isAlignVerticalCenter){var I=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*A,O=(.5-l.y)*o.height;n&&(I*=a.y,O+=r.y,O*=a.y),_=O+(w-.5)*C+I}else _=t.isAlignBottom?b+w*C:E+(w-1)*C;t._lastSize.height=C}e.setPosition(h,_,Ode.z),oa.set(t._lastPos,h,_,Ode.z)}}function Bde(){var e=AB.getScene();if(e){if(Fde.isAligning=!0,Fde._nodesOrderDirty)Lde.length=0,function e(t){var i=t.getComponent(Whe);if(i)if(Dde(t,i),i.alignMode!==phe.ALWAYS)i.enabled=!1;else{if(!E.isValid(t,!0))return;Lde.push(i)}for(var n,r=y(t.children);!(n=r()).done;){var a=n.value;a.active&&e(a)}}(e),Fde._nodesOrderDirty=!1;else{var t=null,i=Fde._activeWidgetsIterator;for(i.i=0;i.i<Lde.length;++i.i)(t=Lde[i.i])._dirty&&(Dde(t.node,t),t._dirty=!1)}Fde.isAligning=!1}}var Lde=[];var Nde=[],Fde=e("widgetManager",E._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Fe.MutableForwardIterator(Lde),animationState:null,init:function(){if(AB.on(iB.EVENT_AFTER_UPDATE,Bde),Gn.isMobile){var e=this.onResized.bind(this);window.addEventListener("resize",e),window.addEventListener("orientationchange",e)}else RO.instance.on("design-resolution-changed",this.onResized,this)},add:function(e){this._nodesOrderDirty=!0;var t=AB.root.ui.getScreen(e.node._uiProps.uiTransformComp.visibility);t&&-1===Nde.indexOf(t)&&(Nde.push(t),t.node.on("design-resolution-changed",this.onResized,this))},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=AB.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){if(ig.isNode(e)){var t=e.getComponent(Whe);t&&t.alignMode===phe.ON_WINDOW_RESIZE&&(t.enabled=!0)}for(var i,n=y(e.children);!(i=n()).done;){var r=i.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function i(e,t){return Math.abs(e-t)>1e-10?t:e}var n=e.node,r=n.parent;if(r){var a=new oa,o=new oa(1,1,1);if(e.target&&The(n,r=e.target,a,o),!t)return;var s=r._uiProps.uiTransformComp,l=n._uiProps.uiTransformComp;if(!s)return void G(6501,e.node.name);var c=s.anchorPoint,u=She(r),h=l.anchorPoint,_=n.getPosition(),d=mhe,f=n.getScale(),p=0;if(t&d.LEFT){var m=-c.x*u.width;m+=a.x,m*=o.x,p=_.x-h.x*l.width*f.x-m,e.isAbsoluteLeft||(p/=u.width),p/=o.x,e.left=i(e.left,p)}if(t&d.RIGHT){var v=(1-c.x)*u.width;v+=a.x,p=(v*=o.x)-(_.x+(1-h.x)*l.width*f.x),e.isAbsoluteRight||(p/=u.width),p/=o.x,e.right=i(e.right,p)}if(t&d.TOP){var g=(1-c.y)*u.height;g+=a.y,p=(g*=o.y)-(_.y+(1-h.y)*l.height*f.y),e.isAbsoluteTop||(p/=u.height),p/=o.y,e.top=i(e.top,p)}if(t&d.BOT){var y=-c.y*u.height;y+=a.y,y*=o.y,p=_.y-h.y*l.height*f.y-y,e.isAbsoluteBottom||(p/=u.height),p/=o.y,e.bottom=i(e.bottom,p)}}},updateAlignment:function e(t){var i=t.parent;i&&ig.isNode(i)&&e(i);var n=t.getComponent(Whe);n&&i&&Dde(t,n)},AlignMode:phe,AlignFlags:mhe});AB.on(iB.EVENT_INIT,(function(){Fde.init()}));var zde=function e(t,n,r){i(this,e),this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=n,this.y=r};function Ude(e,t,i,n,r){var a=0,o=null;if(r===function(e,t,i,n){for(var r=0,a=t,o=i-n;a<i;a+=n)r+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return r}(e,t,i,n)>0)for(a=t;a<i;a+=n)o=afe(a,e[a],e[a+1],o);else for(a=i-n;a>=t;a-=n)o=afe(a,e[a],e[a+1],o);return o&&tfe(o,o.next)&&(ofe(o),o=o.next),o}function Gde(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)return e;t||(t=e);var i=e,n=!1;do{if(n=!1,i.steiner||!tfe(i,i.next)&&0!==efe(i.prev,i,i.next))i=i.next;else{if(ofe(i),(i=t=i.prev)===i.next)return null;n=!0}}while(n||i!==t);return t}function Hde(e,t,i,n,r,a){var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(e){!o&&a&&Kde(e,n,r,a);for(var s=e,l=null,c=null;e.prev!==e.next;)if(l=e.prev,c=e.next,a?Wde(e,n,r,a):Vde(e))t.push(l.i/i),t.push(e.i/i),t.push(c.i/i),ofe(e),e=c.next,s=c.next;else if((e=c)===s){o?1===o?Hde(e=jde(e,t,i),t,i,n,r,a,2):2===o&&qde(e,t,i,n,r,a):Hde(Gde(e),t,i,n,r,a,1);break}}}function Vde(e){var t=e.prev,i=e,n=e.next;if(efe(t,i,n)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(Jde(t.x,t.y,i.x,i.y,n.x,n.y,r.x,r.y)&&efe(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Wde(e,t,i,n){var r=e.prev,a=e,o=e.next;if(efe(r,a,o)>=0)return!1;for(var s=r.x<a.x?r.x<o.x?r.x:o.x:a.x<o.x?a.x:o.x,l=r.y<a.y?r.y<o.y?r.y:o.y:a.y<o.y?a.y:o.y,c=r.x>a.x?r.x>o.x?r.x:o.x:a.x>o.x?a.x:o.x,u=r.y>a.y?r.y>o.y?r.y:o.y:a.y>o.y?a.y:o.y,h=Zde(s,l,t,i,n),_=Zde(c,u,t,i,n),d=e.nextZ;d&&d.z<=_;){if(d!==e.prev&&d!==e.next&&Jde(r.x,r.y,a.x,a.y,o.x,o.y,d.x,d.y)&&efe(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=e.prevZ;d&&d.z>=h;){if(d!==e.prev&&d!==e.next&&Jde(r.x,r.y,a.x,a.y,o.x,o.y,d.x,d.y)&&efe(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}function jde(e,t,i){var n=e;do{var r=n.prev,a=n.next.next;!tfe(r,a)&&ife(r,n,n.next,a)&&nfe(r,a)&&nfe(a,r)&&(t.push(r.i/i),t.push(n.i/i),t.push(a.i/i),ofe(n),ofe(n.next),n=e=a),n=n.next}while(n!==e);return n}function qde(e,t,i,n,r,a){var o=e;do{for(var s=o.next.next;s!==o.prev;){if(o.i!==s.i&&$de(o,s)){var l=rfe(o,s);return o=Gde(o,o.next),l=Gde(l,l.next),Hde(o,t,i,n,r,a),void Hde(l,t,i,n,r,a)}s=s.next}o=o.next}while(o!==e)}function Xde(e,t){return e.x-t.x}function Yde(e,t){if(t=function(e,t){var i=t,n=e.x,r=e.y,a=-1/0,o=null;do{if(r<=i.y&&r>=i.next.y){var s=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=n&&s>a){if(a=s,s===n){if(r===i.y)return i;if(r===i.next.y)return i.next}o=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!o)return null;if(n===a)return o.prev;var l,c=o,u=o.x,h=o.y,_=1/0;i=o.next;for(;i!==c;)n>=i.x&&i.x>=u&&Jde(r<h?n:a,r,u,h,r<h?a:n,r,i.x,i.y)&&((l=Math.abs(r-i.y)/(n-i.x))<_||l===_&&i.x>o.x)&&nfe(i,e)&&(o=i,_=l),i=i.next;return o}(e,t)){var i=rfe(t,e);Gde(i,i.next)}}function Kde(e,t,i,n){var r=e;do{null===r.z&&(r.z=Zde(r.x,r.y,t,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,i=null,n=null,r=null,a=null,o=0,s=0,l=0,c=1;do{for(i=e,e=null,a=null,o=0;i;){for(o++,n=i,s=0,t=0;t<c&&(s++,n=n.nextZ);t++);for(l=c;s>0||l>0&&n;)0===s?(r=n,n=n.nextZ,l--):0!==l&&n?i.z<=n.z?(r=i,i=i.nextZ,s--):(r=n,n=n.nextZ,l--):(r=i,i=i.nextZ,s--),a?a.nextZ=r:e=r,r.prevZ=a,a=r;i=n}a.nextZ=null,c*=2}while(o>1)}(r)}function Zde(e,t,i,n,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Qde(e){var t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}function Jde(e,t,i,n,r,a,o,s){return(r-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(n-s)-(i-o)*(t-s)>=0&&(i-o)*(a-s)-(r-o)*(n-s)>=0}function $de(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&ife(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&nfe(e,t)&&nfe(t,e)&&function(e,t){var i=e,n=!1,r=(e.x+t.x)/2,a=(e.y+t.y)/2;do{i.y>a!=i.next.y>a&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==e);return n}(e,t)}function efe(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function tfe(e,t){return e.x===t.x&&e.y===t.y}function ife(e,t,i,n){return!!(tfe(e,t)&&tfe(i,n)||tfe(e,n)&&tfe(i,t))||efe(e,t,i)>0!=efe(e,t,n)>0&&efe(i,n,e)>0!=efe(i,n,t)>0}function nfe(e,t){return efe(e.prev,e,e.next)<0?efe(e,t,e.next)>=0&&efe(e,e.prev,t)>=0:efe(e,t,e.prev)<0||efe(e,e.next,t)<0}function rfe(e,t){var i=new zde(e.i,e.x,e.y),n=new zde(t.i,t.x,t.y),r=e.next,a=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,n.next=i,i.prev=n,a.next=n,n.prev=a,n}function afe(e,t,i,n){var r=new zde(e,t,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function ofe(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function sfe(e,t,i){i=i||3;var n=t?t.length:0,r=n?t[0]*i:e.length,a=Ude(e,0,r,i,!0),o=[];if(!a)return o;var s=0,l=0,c=0,u=0,h=0,_=0,d=0;if(n&&(a=function(e,t,i,n){var r,a=[],o=0,s=null;for(o=0,r=t.length;o<r;o++)(s=Ude(e,t[o]*n,o<r-1?t[o+1]*n:e.length,n,!1))&&(s===s.next&&(s.steiner=!0),a.push(Qde(s)));if(a.sort(Xde),!i)return i;for(o=0;o<a.length;o++)Yde(a[o],i),i=Gde(i,i.next);return i}(e,t,a,i)),e.length>80*i){s=c=e[0],l=u=e[1];for(var f=i;f<r;f+=i)(h=e[f])<s&&(s=h),(_=e[f+1])<l&&(l=_),h>c&&(c=h),_>u&&(u=_);d=Math.max(c-s,u-l)}return Hde(a,o,i,s,l,d),o}var lfe=Math.PI,cfe=Math.min,ufe=Math.max,hfe=Math.cos,_fe=Math.sin,dfe=Math.abs,ffe=Math.sign,pfe=.5522847493;function mfe(e,t,i,n,r){e.moveTo(t-n,i),e.bezierCurveTo(t-n,i+r*pfe,t-n*pfe,i+r,t,i+r),e.bezierCurveTo(t+n*pfe,i+r,t+n,i+r*pfe,t+n,i),e.bezierCurveTo(t+n,i-r*pfe,t+n*pfe,i-r,t,i-r),e.bezierCurveTo(t-n*pfe,i-r,t-n,i-r*pfe,t-n,i),e.close()}for(var vfe=function(e){function t(e,n){var r;return i(this,t),(r=u(this,s(t).call(this,e,n))).dx=0,r.dy=0,r.dmx=0,r.dmy=0,r.flags=0,r.len=0,r.reset(),r}return o(t,e),r(t,[{key:"reset",value:function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}]),t}(ia),gfe=function(){function e(){i(this,e),this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return r(e,[{key:"reset",value:function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}]),e}(),yfe=function(){function e(){i(this,e),this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Ma.WHITE.clone(),this.lineCap=Aae.BUTT,this.strokeColor=Ma.BLACK.clone(),this.lineJoin=Cae.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataPool=new Ui((function(){return new VA}),16),this._renderDataList=[],this._curPath=null}return r(e,[{key:"moveTo",value:function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,wae.PT_CORNER),this._commandX=e,this._commandY=t}},{key:"lineTo",value:function(e,t){this.addPoint(e,t,wae.PT_CORNER),this._commandX=e,this._commandY=t}},{key:"bezierCurveTo",value:function(e,t,i,n,r,a){var o=this._curPath,s=o.points[o.points.length-1];s&&(s.x!==e||s.y!==t||i!==r||n!==a?(!function e(t,i,n,r,a,o,s,l,c,u,h){var _,d,f,p,m,v,g,y,x,S,T,E,b,A,C,w;u>10||(m=.5*(o+l),v=.5*(s+c),g=.5*((_=.5*(i+r))+(f=.5*(r+o))),y=.5*((d=.5*(n+a))+(p=.5*(a+s))),((C=dfe((r-l)*(A=c-n)-(a-c)*(b=l-i)))+(w=dfe((o-l)*A-(s-c)*b)))*(C+w)<t.tessTol*(b*b+A*A)?t.addPoint(l,c,0===h?h|wae.PT_BEVEL:h):(e(t,i,n,_,d,g,y,T=.5*(g+(x=.5*(f+m))),E=.5*(y+(S=.5*(p+v))),u+1,0),e(t,T,E,x,S,m,v,l,c,u+1,h)))}(this,s.x,s.y,e,t,i,n,r,a,0,wae.PT_CORNER),this._commandX=r,this._commandY=a):this.lineTo(r,a))}},{key:"quadraticCurveTo",value:function(e,t,i,n){var r=this._commandX,a=this._commandY;this.bezierCurveTo(r+2/3*(e-r),a+2/3*(t-a),i+2/3*(e-i),n+2/3*(t-n),i,n)}},{key:"arc",value:function(e,t,i,n,r,a){!function(e,t,i,n,r,a,o){var s,l,c=0,u=0,h=0,_=0,d=0,f=0,p=0,m=0,v=0,g=0,y=0,x=0,S=0,T=0;if(u=a-r,o=o||!1)if(dfe(u)>=2*lfe)u=2*lfe;else for(;u<0;)u+=2*lfe;else if(dfe(u)>=2*lfe)u=2*-lfe;else for(;u>0;)u-=2*lfe;for(l=0|ufe(1,cfe(dfe(u)/(.5*lfe)+.5,5)),h=dfe(4/3*(1-hfe(s=u/l/2))/_fe(s)),o||(h=-h),T=0;T<=l;T++)f=t+(_=hfe(c=r+u*(T/l)))*n,p=i+(d=_fe(c))*n,m=-d*n*h,v=_*n*h,0===T?e.moveTo(f,p):e.bezierCurveTo(g+x,y+S,f-m,p-v,f,p),g=f,y=p,x=m,S=v}(this,e,t,i,n,r,a)}},{key:"ellipse",value:function(e,t,i,n){mfe(this,e,t,i,n),this._curPath.complex=!1}},{key:"circle",value:function(e,t,i){mfe(this,e,t,i,i),this._curPath.complex=!1}},{key:"rect",value:function(e,t,i,n){this.moveTo(e,t),this.lineTo(e+i,t),this.lineTo(e+i,t+n),this.lineTo(e,t+n),this.close(),this._curPath.complex=!1}},{key:"roundRect",value:function(e,t,i,n,r){!function(e,t,i,n,r,a){if(a<.1)e.rect(t,i,n,r);else{var o=cfe(a,.5*dfe(n))*ffe(n),s=cfe(a,.5*dfe(r))*ffe(r);e.moveTo(t,i+s),e.lineTo(t,i+r-s),e.bezierCurveTo(t,i+r-s*(1-pfe),t+o*(1-pfe),i+r,t+o,i+r),e.lineTo(t+n-o,i+r),e.bezierCurveTo(t+n-o*(1-pfe),i+r,t+n,i+r-s*(1-pfe),t+n,i+r-s),e.lineTo(t+n,i+s),e.bezierCurveTo(t+n,i+s*(1-pfe),t+n-o*(1-pfe),i,t+n-o,i),e.lineTo(t+o,i),e.bezierCurveTo(t+o*(1-pfe),i,t,i+s*(1-pfe),t,i+s),e.close()}}(this,e,t,i,n,r),this._curPath.complex=!1}},{key:"clear",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDataList,i=0,n=t.length;i<n;i++){var r=t[i];r&&r.reset()}this._renderDataList.length=0,e&&this._renderDataPool.reset()}},{key:"close",value:function(){this._curPath.closed=!0}},{key:"requestRenderData",value:function(){var e=this._renderDataPool.add();return this._renderDataList.push(e),e}},{key:"getRenderData",value:function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}},{key:"addPoint",value:function(e,t,i){var n=this._curPath;if(n){var r=this._points,a=n.points,o=r[this.pointsOffset++];o?(o.x=e,o.y=t):(o=new vfe(e,t),r.push(o)),o.flags=i,a.push(o)}}},{key:"_addPath",value:function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new gfe,this.paths.push(t)),this.pathLength++,this._curPath=t,t}}]),e}(),xfe=Math.PI,Sfe=Math.min,Tfe=Math.max,Efe=Math.ceil,bfe=Math.acos,Afe=Math.cos,Cfe=Math.sin,wfe=Math.atan2,Rfe=HD(UD.concat([new al("a_dist",jo.R32F)])),Ife=null,Ofe=null,Mfe=new Ma,Pfe=[],kfe=0;kfe<4;kfe++)Pfe.push(new oa);function Dfe(e,t,i){return e<t?t:e>i?i:e}var Bfe={useModel:!0,createImpl:function(e){return new yfe},updateRenderData:function(e){for(var t=e.impl?e.impl.getRenderData():[],i=0,n=t.length;i<n;i++)t[i].material=e.getUIMaterialInstance()},fillBuffers:function(e,t){},renderIA:function(e,t){},getRenderData:function(e,t){if(!Ofe)return null;var i=Ofe.getRenderData(),n=i[Ofe.dataOffset];if(!n)return null;var r=n,a=r?r.vertexCount+t:0;return(a>65535||3*a>131070)&&(++Ofe.dataOffset,Ofe.dataOffset<i.length?n=i[Ofe.dataOffset]:(n=Ofe.requestRenderData(),i[Ofe.dataOffset]=n),r=n),r&&r.vertexCount<a&&r.request(t,3*t),n},stroke:function(e){Ma.copy(Mfe,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){Ma.copy(Mfe,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){var t=e.impl,i=t&&t.getRenderData();if(i&&e.model){var n=e.model.subModels.length,r=i.length;if(r-n>0)for(var a=n;a<r;a++)e.activeSubModel(a);for(var o=e.model.subModels,s=0;s<i.length;s++){var l=i[s],c=o[s].inputAssembler,u=Float32Array.BYTES_PER_ELEMENT*Rfe,h=l.vertexStart*u,_=new Float32Array(l.vData.buffer,0,h>>2);c.vertexCount=l.vertexStart,c.vertexBuffers[0].update(_);var d=new Uint16Array(l.iData.buffer,0,l.indicesStart);c.indexCount=l.indicesStart,c.indexBuffer.update(d)}e.markForUpdateRenderData()}},_expandStroke:function(e){var t=.5*e.lineWidth,i=e.lineCap,n=e.lineJoin,r=e.miterLimit;if(Ofe=e.impl){var a=function(e,t,i){var n=2*bfe(e/(e+i));return Tfe(2,Efe(t/n))}(t,xfe,Ofe.tessTol);this._calculateJoins(Ofe,t,n,r);for(var o=Ofe.paths,s=0,l=Ofe.pathOffset,c=Ofe.pathLength;l<c;l++){var u=o[l],h=u.points.length;n===Cae.ROUND?s+=2*(h+u.bevel*(a+2)+1):s+=2*(h+5*u.bevel+1),u.closed||(i===Aae.ROUND?s+=2*(2*a+2):s+=12)}var _=Ife=this.getRenderData(e,s);if(_){for(var d=_.vData,f=_.iData,p=Ofe.pathOffset,m=Ofe.pathLength;p<m;p++){var v=o[p],g=v.points,y=g.length,x=_.vertexStart,S=void 0,T=void 0,E=0,b=0,A=v.closed;if(A?(S=g[y-1],T=g[0],E=0,b=y):(S=g[0],T=g[1],E=1,b=y-1),!A){var C=new vfe(T.x,T.y);C.subtract(S),C.normalize();var w=C.x,R=C.y;i===Aae.BUTT?this._buttCapStart(S,w,R,t,0):i===Aae.SQUARE?this._buttCapStart(S,w,R,t,t):i===Aae.ROUND&&this._roundCapStart(S,w,R,t,a)}for(var I=E;I<b;++I)n===Cae.ROUND?this._roundJoin(S,T,t,t,a):0!=(T.flags&(wae.PT_BEVEL|wae.PT_INNERBEVEL))?this._bevelJoin(S,T,t,t):(this._vSet(T.x+T.dmx*t,T.y+T.dmy*t,1),this._vSet(T.x-T.dmx*t,T.y-T.dmy*t,-1)),S=T,T=g[I+1];if(A){var O=8*x;this._vSet(d[O],d[O+1],1),this._vSet(d[O+8],d[O+8+1],-1)}else{var M=new vfe(T.x,T.y);M.subtract(S),M.normalize();var P=M.x,k=M.y;i===Aae.BUTT?this._buttCapEnd(T,P,k,t,0):i===Aae.SQUARE?this._buttCapEnd(T,P,k,t,t):i===Aae.ROUND&&this._roundCapEnd(T,P,k,t,a)}for(var D=_.indicesStart,B=x+2,L=_.vertexStart;B<L;B++)f[D++]=B-2,f[D++]=B-1,f[D++]=B;if(_.indicesStart=D,D!==_.indicesCount){var N=new Array(_.indicesCount-D);_.iData.set(N,D)}}Ife=null,Ofe=null}}},_expandFill:function(e){if(Ofe=e.impl){for(var t=Ofe.paths,i=0,n=Ofe.pathOffset,r=Ofe.pathLength;n<r;n++){i+=t[n].points.length}var a=Ife=this.getRenderData(e,i);if(a){for(var o=a,s=o.vData,l=o.iData,c=Ofe.pathOffset,u=Ofe.pathLength;c<u;c++){var h=t[c],_=h.points,d=_.length;if(0!==d){for(var f=a.vertexStart,p=0;p<d;++p)this._vSet(_[p].x,_[p].y);var m=a.indicesStart;if(h.complex){for(var v=[],g=f,y=a.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=sfe(v,null,3);if(!S||0===S.length)continue;for(var T=0,E=S.length;T<E;T++)l[m++]=S[T]+f}else for(var b=f,A=f+2,C=o.vertexStart;A<C;A++)l[m++]=b,l[m++]=A-1,l[m++]=A;if(o.indicesStart=m,m!==o.indicesCount){var w=new Array(o.indicesCount-m);o.iData.set(w,m)}}}Ife=null,Ofe=null}}},_calculateJoins:function(e,t,i,n){var r=0;t>0&&(r=1/t);for(var a=e.paths,o=e.pathOffset,s=e.pathLength;o<s;o++){var l=a[o],c=l.points,u=c.length,h=c[u-1],_=c[0];l.bevel=0;for(var d=0;d<u;d++){var f,p,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(f=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/f;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=wae.PT_LEFT),f*(p=Tfe(11,Sfe(h.len,_.len)*r))*p<1&&(_.flags|=wae.PT_INNERBEVEL),_.flags&wae.PT_CORNER&&(f*n*n<1||i===Cae.BEVEL||i===Cae.ROUND)&&(_.flags|=wae.PT_BEVEL),0!=(_.flags&(wae.PT_BEVEL|wae.PT_INNERBEVEL))&&l.bevel++,h=_,_=c[d+1]}}},_flattenPaths:function(e){for(var t=e.paths,i=e.pathOffset,n=e.pathLength;i<n;i++){var r=t[i],a=r.points,o=a[a.length-1],s=a[0];a.length>2&&o.equals(s)&&(r.closed=!0,a.pop(),o=a[a.length-1]);for(var l=0,c=a.length;l<c;l++){var u=new vfe(s.x,s.y);u.subtract(o),o.len=u.length(),(u.x||u.y)&&u.normalize(),o.dx=u.x,o.dy=u.y,o=s,s=a[l+1]}}},_chooseBevel:function(e,t,i,n){var r=i.x,a=i.y,o=0,s=0,l=0,c=0;return 0!==e?(o=r+t.dy*n,s=a-t.dx*n,l=r+i.dy*n,c=a-i.dx*n):(o=l=r+i.dmx*n,s=c=a+i.dmy*n),[o,s,l,c]},_buttCapStart:function(e,t,i,n,r){var a=e.x-t*r,o=e.y-i*r,s=i,l=-t;this._vSet(a+s*n,o+l*n,1),this._vSet(a-s*n,o-l*n,-1)},_buttCapEnd:function(e,t,i,n,r){var a=e.x+t*r,o=e.y+i*r,s=i,l=-t;this._vSet(a+s*n,o+l*n,1),this._vSet(a-s*n,o-l*n,-1)},_roundCapStart:function(e,t,i,n,r){for(var a=e.x,o=e.y,s=i,l=-t,c=0;c<r;c++){var u=c/(r-1)*xfe,h=Afe(u)*n,_=Cfe(u)*n;this._vSet(a-s*h-t*_,o-l*h-i*_,1),this._vSet(a,o,0)}this._vSet(a+s*n,o+l*n,1),this._vSet(a-s*n,o-l*n,-1)},_roundCapEnd:function(e,t,i,n,r){var a=e.x,o=e.y,s=i,l=-t;this._vSet(a+s*n,o+l*n,1),this._vSet(a-s*n,o-l*n,-1);for(var c=0;c<r;c++){var u=c/(r-1)*xfe,h=Afe(u)*n,_=Cfe(u)*n;this._vSet(a,o,0),this._vSet(a-s*h+t*_,o-l*h+i*_,1)}},_roundJoin:function(e,t,i,n,r){var a=e.dy,o=-e.dx,s=t.dy,l=-t.dx,c=t.x,u=t.y;if(0!=(t.flags&wae.PT_LEFT)){var h=this._chooseBevel(t.flags&wae.PT_INNERBEVEL,e,t,i),_=h[0],d=h[1],f=h[2],p=h[3],m=wfe(-o,-a),v=wfe(-l,-s);v>m&&(v-=2*xfe),this._vSet(_,d,1),this._vSet(c-a*n,t.y-o*n,-1);for(var g=Dfe(Efe((m-v)/xfe)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=c+Afe(x)*n,T=u+Cfe(x)*n;this._vSet(c,u,0),this._vSet(S,T,-1)}this._vSet(f,p,1),this._vSet(c-s*n,u-l*n,-1)}else{var E=this._chooseBevel(t.flags&wae.PT_INNERBEVEL,e,t,-n),b=E[0],A=E[1],C=E[2],w=E[3],R=wfe(o,a),I=wfe(l,s);I<R&&(I+=2*xfe),this._vSet(c+a*n,u+o*n,1),this._vSet(b,A,-1);for(var O=Dfe(Efe((I-R)/xfe)*r,2,r),M=0;M<O;M++){var P=R+M/(O-1)*(I-R),k=c+Afe(P)*i,D=u+Cfe(P)*i;this._vSet(k,D,1),this._vSet(c,u,0)}this._vSet(c+s*n,u+l*n,1),this._vSet(C,w,-1)}},_bevelJoin:function(e,t,i,n){var r=0,a=0,o=0,s=0,l=0,c=0,u=0,h=0,_=e.dy,d=-e.dx,f=t.dy,p=-t.dx;if(t.flags&wae.PT_LEFT){var m=this._chooseBevel(t.flags&wae.PT_INNERBEVEL,e,t,i);l=m[0],c=m[1],u=m[2],h=m[3],this._vSet(l,c,1),this._vSet(t.x-_*n,t.y-d*n,-1),this._vSet(u,h,1),this._vSet(t.x-f*n,t.y-p*n,-1)}else{var v=this._chooseBevel(t.flags&wae.PT_INNERBEVEL,e,t,-n);r=v[0],a=v[1],o=v[2],s=v[3],this._vSet(t.x+_*i,t.y+d*i,1),this._vSet(r,a,-1),this._vSet(t.x+f*i,t.y+p*i,1),this._vSet(o,s,-1)}},_vSet:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(Ife){var n=Ife,r=8*n.vertexStart,a=n.vData;a[r++]=e,a[r++]=t,a[r++]=0,Ma.toArray(a,Mfe,r),r+=4,a[r++]=i,n.vertexStart++}}},Lfe=e("graphicsAssembler",{getAssembler:function(e){return Bfe}});Soe.Assembler=Lfe;var Nfe=function e(){i(this,e),this.u=0,this.v=0,this.width=0,this.height=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.validDefinition=!1,this.xAdvance=0},Ffe=function(){function e(){i(this,e),this._letterDefinitions={}}return r(e,[{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new Nfe;Ee(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=e[n];Ee(this._letterDefinitions[n],r)}}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.width*=e,r.height*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e){return this._letterDefinitions[e.charCodeAt(0)]}},{key:"letterDefinitions",get:function(){return this._letterDefinitions}}]),e}();E.FontAtlas=Ffe;var zfe=function e(){i(this,e),this.char="",this.valid=!0,this.positionX=0,this.positionY=0,this.lineIndex=0},Ufe=new Ia,Gfe=null,Hfe=null,Vfe=[],Wfe=[],jfe=[],qfe=[],Xfe=new wa,Yfe=null,Kfe=null,Zfe=0,Qfe=0,Jfe=0,$fe=0,epe=0,tpe=1,ipe=null,npe="",rpe=0,ape=0,ope=new wa,spe=0,lpe=0,cpe=0,upe=0,hpe=0,_pe=!1,dpe=0,fpe=0,ppe=0,mpe={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){jte(e.node,t,e.renderData,e.color)},appendQuad:function(e,t,i,n,r,a,o){var s=e.renderData;if(s){var l=s.dataLength;s.dataLength+=4,s.vertexCount=s.dataLength,s.indicesCount=s.dataLength/2*3;var c=s.data,u=t.width,h=t.height,_=i.width,d=i.height,f=0,p=0,m=0,v=0;n?(f=i.x/u,v=(i.x+d)/u,p=(i.y+_)/h,m=i.y/h,c[l].u=f,c[l].v=m,c[l+1].u=f,c[l+1].v=p,c[l+2].u=v,c[l+2].v=m,c[l+3].u=v,c[l+3].v=p):(f=i.x/u,v=(i.x+_)/u,p=(i.y+d)/h,m=i.y/h,c[l].u=f,c[l].v=p,c[l+1].u=v,c[l+1].v=p,c[l+2].u=f,c[l+2].v=m,c[l+3].u=v,c[l+3].v=m),c[l].x=r,c[l].y=a-d*o,c[l+1].x=r+_*o,c[l+1].y=a-d*o,c[l+2].x=r,c[l+2].y=a,c[l+3].x=r+_*o,c[l+3].y=a}}};Te(mpe,{updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&Gfe!==e&&(Hfe=(Gfe=e).node._uiProps.uiTransformComp,this._updateProperties(),this._updateContent(),Gfe.actualFontSize=rpe,Hfe.setContentSize(ope),Gfe.renderData.vertDirty=Gfe.renderData.uvDirty=!1,Gfe=null,this._resetProperties())},_updateFontScale:function(){tpe=rpe/ape},_updateProperties:function(){if(Gfe){var e=Gfe.font;if(e){if(ipe=e.spriteFrame,Kfe=e.fntConfig,!(Yfe=Gfe.fontAtlas)){Yfe=new Ffe;for(var t=Kfe.fontDefDictionary,i=0,n=Object.keys(t);i<n.length;i++){var r=n[i],a=new Nfe,o=t[r].rect;a.offsetX=t[r].xOffset,a.offsetY=t[r].yOffset,a.width=o.width,a.height=o.height,a.u=o.x,a.v=o.y,a.textureID=0,a.validDefinition=!0,a.xAdvance=t[r].xAdvance,Yfe.addLetterDefinitions(r,a)}Gfe.fontAtlas=Yfe}npe=Gfe.string.toString(),rpe=Gfe.fontSize,ape=Kfe.fontSize;var s=Hfe.contentSize;ope.width=s.width,ope.height=s.height,spe=Gfe.horizontalAlign,lpe=Gfe.verticalAlign,cpe=Gfe.spacingX,hpe=Gfe.overflow,upe=Gfe.lineHeight,_pe=hpe!==rne.NONE&&(hpe===rne.RESIZE_HEIGHT||Gfe.enableWrapText),this._setupBMFontOverflowMetrics()}}},_resetProperties:function(){Yfe=null,Kfe=null,ipe=null},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=npe,t=e.length,i=Kfe.kerningDict,n=Vfe,r=-1,a=0;a<t;++a){var o=e.charCodeAt(a),s=i[r<<16|65535&o]||0;n[a]=a<t-1?s:0,r=o}},_multilineTextWrap:function(e){var t=npe.length,i=0,n=0,r=0,a=0,o=0,s=0,l=0,c=null,u=new ia;this._updateFontScale();for(var h=Yfe.letterDefinitions,_=0;_<t;){var d=npe.charAt(_);if("\n"!==d){for(var f=e(npe,_,t),p=s,m=l,v=o,g=n,y=!1,x=0;x<f;++x){var S=_+x;if("\r"!==(d=npe.charAt(S)))if(c=Yfe&&Yfe.getLetterDefinitionForChar(d)){var T=g+c.offsetX*tpe;if(_pe&&ppe>0&&n>0&&T+c.width*tpe>ppe&&!Tu(d)){jfe.push(o),o=0,i++,n=0,r-=upe*tpe+0,y=!0;break}u.x=T,u.y=r-c.offsetY*tpe,this._recordLetterInfo(h,u,d,S,i),S+1<Vfe.length&&S<t-1&&(g+=Vfe[S+1]),g+=c.xAdvance*tpe+cpe,v=u.x+c.width*tpe,p<u.y&&(p=u.y),m>u.y-c.height*tpe&&(m=u.y-c.height*tpe)}else this._recordPlaceholderInfo(S,d),console.log("Can't find letter definition in texture atlas "+Kfe.atlasName+" for letter:"+d);else this._recordPlaceholderInfo(S,d)}y||(n=g,s<p&&(s=p),l>m&&(l=m),a<(o=v)&&(a=o),_+=f)}else jfe.push(o),o=0,i++,n=0,r-=upe*tpe+0,this._recordPlaceholderInfo(_,d),_++}return jfe.push(o),Qfe=(Zfe=i+1)*upe*tpe,Zfe>1&&(Qfe+=0*(Zfe-1)),ope.width=dpe,ope.height=fpe,dpe<=0&&(ope.width=parseFloat(a.toFixed(2))),fpe<=0&&(ope.height=parseFloat(Qfe.toFixed(2))),$fe=ope.height,epe=0,s>0&&($fe=ope.height+s),l<-Qfe&&(epe=Qfe+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Su(n)||"\n"===n||Tu(n))return 1;var r=1,a=Yfe&&Yfe.getLetterDefinitionForChar(n);if(!a)return r;for(var o=a.xAdvance*tpe+cpe,s=t+1;s<i&&(n=e.charAt(s),a=Yfe&&Yfe.getLetterDefinitionForChar(n));++s){if(o+a.offsetX*tpe+a.width*tpe>ppe&&!Tu(n)&&ppe>0)return r;if(o+=a.xAdvance*tpe+cpe,"\n"===n||Tu(n)||Su(n))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=Wfe.length){var i=new zfe;Wfe.push(i)}Wfe[e].char=t,Wfe[e].valid=!1},_recordLetterInfo:function(e,t,i,n,r){if(n>=Wfe.length){var a=new zfe;Wfe.push(a)}var o=i.charCodeAt(0);Wfe[n].lineIndex=r,Wfe[n].char=i,Wfe[n].valid=e[o].validDefinition,Wfe[n].positionX=t.x,Wfe[n].positionY=t.y},_alignText:function(){Qfe=0,jfe.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),hpe===rne.SHRINK&&rpe>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||hpe===rne.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),rpe=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=rpe,i=upe,n=Yfe,r=0,a=n?n.cloneLetterDefinition():{},o=!0;e();){var s=t-++r;if(o=!1,s<=0)break;var l=s/t;n&&(n.assignLetterDefinitions(a),n.scaleFontLetterDefinition(l)),upe=i*l,this._multilineTextWrapByWord(),this._computeAlignmentOffset()}upe=i,n&&n.assignLetterDefinitions(a),o||t-r>=0&&this._scaleFontSizeDown(t-r)},_isVerticalClamp:function(){return Qfe>ope.height},_isHorizontalClamp:function(){if(Yfe){for(var e=!1,t=0,i=npe.length;t<i;++t){var n=Wfe[t];if(n.valid){var r=Yfe.getLetterDefinitionForChar(n.char);if(!r)continue;var a=n.positionX+r.width/2*tpe,o=n.lineIndex;if(dpe>0)if(_pe){if(jfe[o]>ope.width&&(a>ope.width||a<0)){e=!0;break}}else if(a>ope.width){e=!0;break}}}return e}},_isHorizontalClamped:function(e,t){var i=jfe[t],n=e>ope.width||e<0;return _pe?i>ope.width&&n:n},_updateQuads:function(){if(!Gfe)return!1;var e=Yfe?Yfe.letterDefinitions:{},t=ipe,i=Gfe.renderData;i.dataLength=i.vertexCount=i.indicesCount=0;for(var n=Hfe.anchorPoint,r=ope,a=n.x*r.width,o=n.y*r.height,s=!0,l=0,c=npe.length;l<c;++l){var u=Wfe[l];if(u.valid){var h=e[u.char.charCodeAt(0)];if(h){Ufe.height=h.height,Ufe.width=h.width,Ufe.x=h.u,Ufe.y=h.v;var _=u.positionY+Jfe;if(fpe>0){if(_>$fe){var d=_-$fe;Ufe.y+=d,Ufe.height-=d,_-=d}_-h.height*tpe<epe&&(Ufe.height=_<epe?0:_-epe)}var f=u.lineIndex,p=u.positionX+h.width/2*tpe+qfe[f];if(dpe>0&&this._isHorizontalClamped(p,f))if(hpe===rne.CLAMP)Ufe.width=0;else if(hpe===rne.SHRINK){if(ope.width>h.width){s=!1;break}Ufe.width=0}if(ipe&&Ufe.height>0&&Ufe.width>0){var m=ipe.isRotated(),v=ipe.getOriginalSize(),g=ipe.getRect(),y=ipe.getOffset(),x=y.x+(v.width-g.width)/2,S=y.y-(v.height-g.height)/2;if(m){var T=Ufe.x;Ufe.x=g.x+g.height-Ufe.y-Ufe.height-S,Ufe.y=T+g.y-x,Ufe.y<0&&(Ufe.height=Ufe.height+S)}else Ufe.x+=g.x-x,Ufe.y+=g.y+S;var E=u.positionX+qfe[u.lineIndex];this.appendQuad(Gfe,t,Ufe,m,E-a,_-o,tpe)}}else console.warn("Can't find letter in this bitmap-font")}}return s},appendQuad:function(e,t,i,n,r,a,o){},_computeAlignmentOffset:function(){switch(qfe.length=0,spe){case ine.LEFT:for(var e=0;e<Zfe;++e)qfe.push(0);break;case ine.CENTER:for(var t=0,i=jfe.length;t<i;t++)qfe.push((ope.width-jfe[t])/2);break;case ine.RIGHT:for(var n=0,r=jfe.length;n<r;n++)qfe.push(ope.width-jfe[n])}switch(lpe){case nne.TOP:Jfe=ope.height;break;case nne.CENTER:Jfe=(ope.height+Qfe)/2;break;case nne.BOTTOM:Jfe=Qfe}},_setupBMFontOverflowMetrics:function(){var e=ope.width,t=ope.height;hpe===rne.RESIZE_HEIGHT&&(t=0),hpe===rne.NONE&&(e=0,t=0),dpe=e,fpe=t,Xfe.width=e,Xfe.height=t,ppe=e}});var vpe=hne.Overflow,gpe=Ma.WHITE.clone(),ype=hne.HorizontalAlign,xpe=hne.VerticalAlign,Spe=function e(){i(this,e),this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},Tpe=function e(){i(this,e),this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},Epe=function(){function e(t,n){i(this,e),this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.hash=void 0,this.char=t,this.labelInfo=n,this.hash=t.charCodeAt(0)+n.hash}return r(e,[{key:"updateRenderData",value:function(){this._updateProperties(),this._updateTexture()}},{key:"destroy",value:function(){this.image=null}},{key:"_updateProperties",value:function(){if(this.data=hne._canvasPool.get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=Eu(this.context,this.char);this.width=parseFloat(e.toFixed(2)),this.height=this.labelInfo.fontSize}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new $u),this.image.reset(this.canvas)}},{key:"_updateTexture",value:function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,i=this.canvas.width,n=this.canvas.height;e.textAlign="center",e.textBaseline="middle",e.clearRect(0,0,i,n),e.fillStyle="rgba(255, 255, 255, 0.005)",e.fillRect(0,0,i,n),e.font=t.fontDesc;var r=i/2,a=n/2,o=t.color;if(e.lineJoin="round",e.fillStyle="rgba(".concat(o.r,", ").concat(o.g,", ").concat(o.b,", ",1,")"),t.isOutlined){var s=t.out||gpe;e.strokeStyle="rgba(".concat(s.r,", ").concat(s.g,", ").concat(s.b,", ").concat(s.a/255,")"),e.lineWidth=2*t.margin,e.strokeText(this.char,r,a)}e.fillText(this.char,r,a)}}}]),e}(),bpe=function(e){function t(){return i(this,t),u(this,s(t).apply(this,arguments))}return o(t,e),r(t,[{key:"initWithSize",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Wu.RGBA8888;this.reset({width:e,height:t,format:i}),this.loaded=!0,this.emit("load")}},{key:"drawTextureAt",value:function(e,t,i){var n=this.getGFXTexture();if(e&&n){var r=this._getGFXDevice();if(r){var a=new Ms;a.texOffset.x=t,a.texOffset.y=i,a.texExtent.width=e.width,a.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],n,[a])}else console.warn("Unable to get device")}}}]),t}(Oh),Ape=function(){function e(t,n){i(this,e),this.texture=void 0,this._x=2,this._y=2,this._nextY=2,this._width=0,this._height=0,this._letterDefinitions=new Map,this._dirty=!1,this.texture=new bpe,this.texture.initWithSize(t,n),this._width=t,this._height=n,AB.on(iB.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}return r(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),r(e,[{key:"insertLetterTexture",value:function(e){var t=e.image,i=AB.root.device;if(!t||!this.texture||!i)return null;var n=t.width,r=t.height;if(this._x+n+2>this._width&&(this._x=2,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+2),this._nextY>this._height)return null;this.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var a=new Tpe;return a.u=this._x,a.v=this._y,a.texture=this.texture,a.valid=!0,a.w=e.width,a.h=e.height,a.xAdvance=e.width,this._x+=n+2,this._letterDefinitions.set(e.hash,a),a}},{key:"update",value:function(){this._dirty&&(this._dirty=!1)}},{key:"reset",value:function(){this._x=2,this._y=2,this._nextY=2,this._letterDefinitions.clear()}},{key:"destroy",value:function(){this.reset(),this.texture&&this.texture.destroy()}},{key:"beforeSceneLoad",value:function(){this.destroy();var e=new bpe;e.initWithSize(this._width,this._height),this.texture=e}},{key:"getLetter",value:function(e){return this._letterDefinitions.get(e)}},{key:"addLetterDefinitions",value:function(e,t){this._letterDefinitions[e]=t}},{key:"cloneLetterDefinition",value:function(){for(var e={},t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=new Tpe;Ee(r,this._letterDefinitions[n]),e[n]=r}return e}},{key:"assignLetterDefinitions",value:function(e){var t=this;e.forEach((function(e,i){Ee(t._letterDefinitions[i],e)}))}},{key:"scaleFontLetterDefinition",value:function(e){for(var t=0,i=Object.keys(this._letterDefinitions);t<i.length;t++){var n=i[t],r=this._letterDefinitions[n];r.w*=e,r.h*=e,r.offsetX*=e,r.offsetY*=e,r.xAdvance*=e}}},{key:"getLetterDefinitionForChar",value:function(e,t){var i=e.charCodeAt(0)+t.hash,n=this._letterDefinitions.get(i);if(!n){var r=new Epe(e,t);r.updateRenderData(),n=this.insertLetterTexture(r),r.destroy()}return n}}]),e}(),Cpe=new Ia,wpe=null,Rpe=null,Ipe=[],Ope=[],Mpe=[],Ppe=[],kpe=new wa,Dpe=null,Bpe=0,Lpe=0,Npe=0,Fpe=0,zpe=0,Upe=1,Gpe="",Hpe=0,Vpe=0,Wpe=new wa,jpe=0,qpe=0,Xpe=0,Ype=0,Kpe=0,Zpe=!1,Qpe=0,Jpe=0,$pe=0,eme="",tme=!1,ime={fontSize:0,lineHeight:0,hash:"",fontFamily:"",fontDesc:"Arial",hAlign:0,vAlign:0,color:gpe,isOutlined:!1,out:gpe,margin:0},nme={getAssemblerData:function(){return Dpe||(Dpe=new Ape(1024,1024)),Dpe.texture},updateRenderData:function(e){e.renderData&&e.renderData.vertDirty&&wpe!==e&&(wpe=e,Rpe=e.node._uiProps.uiTransformComp,this._updateFontFamily(e),ime.fontFamily=eme,this._updateProperties(),ime.fontDesc=this._getFontDesc(),this._updateContent(),wpe.actualFontSize=Hpe,Rpe.setContentSize(Wpe),wpe.renderData.vertDirty=wpe.renderData.uvDirty=!1,wpe=null,this._resetProperties())},_updateFontScale:function(){Upe=Hpe/Vpe},_updateProperties:function(){if(wpe){Gpe=wpe.string.toString(),Hpe=wpe.fontSize,Vpe=Hpe;var e=Rpe.contentSize;Wpe.width=e.width,Wpe.height=e.height,jpe=wpe.horizontalAlign,qpe=wpe.verticalAlign,Xpe=wpe.spacingX,Kpe=wpe.overflow,Ype=wpe.lineHeight,tme=wpe.isBold,Zpe=Kpe!==vpe.NONE&&(Kpe===vpe.RESIZE_HEIGHT||wpe.enableWrapText);var t=wpe.getComponent(Vse);t&&t.enabled?(ime.isOutlined=!0,ime.margin=t.width,ime.out=t.color,ime.out.a=t.color.a*wpe.color.a/255):(ime.isOutlined=!1,ime.margin=0),ime.lineHeight=Ype,ime.fontSize=Hpe,ime.fontFamily=eme,ime.color=wpe.color,ime.hash=this._computeHash(ime),this._setupBMFontOverflowMetrics()}},_updateFontFamily:function(e){e.useSystemFont?eme=e.fontFamily:e.font?e.font._nativeAsset?eme=e.font._nativeAsset:(eme=aO.getRes(e.font.nativeUrl)||"")||aO.load(e.font.nativeUrl,(function(t,i){eme=i||"Arial",e.font&&(e.font._nativeAsset=i),e.updateRenderData(!0)})):eme="Arial"},_computeHash:function(e){var t=e.color.toHEX("#rrggbb"),i="";return e.isOutlined&&(i=e.out.toHEX("#rrggbb")),""+e.fontSize+e.fontFamily+t+i},_getFontDesc:function(){var e=Hpe.toString()+"px ";return e+=eme,tme&&(e="bold "+e),e},_resetProperties:function(){},_updateContent:function(){this._updateFontScale(),this._alignText()},_computeHorizontalKerningForText:function(){},_multilineTextWrap:function(e){var t=Gpe.length,i=0,n=0,r=0,a=0,o=0,s=0,l=0,c=null,u=new ia(0,0);this._updateFontScale();for(var h=0;h<t;){var _=Gpe.charAt(h);if("\n"!==_){for(var d=e(Gpe,h,t),f=s,p=l,m=o,v=n,g=!1,y=0;y<d;++y){var x=h+y;if("\r"!==(_=Gpe.charAt(x)))if(c=Dpe&&Dpe.getLetterDefinitionForChar(_,ime)){var S=v+c.offsetX*Upe;if(Zpe&&$pe>0&&n>0&&S+c.w*Upe>$pe&&!Tu(_)){Mpe.push(o),o=0,i++,n=0,r-=Ype*Upe+0,g=!0;break}u.x=S,u.y=r-c.offsetY*Upe,this._recordLetterInfo(u,_,x,i),x+1<Ipe.length&&x<t-1&&(v+=Ipe[x+1]),v+=c.xAdvance*Upe+Xpe,m=u.x+c.w*Upe,f<u.y&&(f=u.y),p>u.y-c.h*Upe&&(p=u.y-c.h*Upe)}else this._recordPlaceholderInfo(x,_);else this._recordPlaceholderInfo(x,_)}g||(n=v,s<f&&(s=f),l>p&&(l=p),a<(o=m)&&(a=o),h+=d)}else Mpe.push(o),o=0,i++,n=0,r-=Ype*Upe+0,this._recordPlaceholderInfo(h,_),h++}return Mpe.push(o),Lpe=(Bpe=i+1)*Ype*Upe,Bpe>1&&(Lpe+=0*(Bpe-1)),Wpe.width=Qpe,Wpe.height=Jpe,Qpe<=0&&(Wpe.width=parseFloat(a.toFixed(2))),Jpe<=0&&(Wpe.height=parseFloat(Lpe.toFixed(2))),Fpe=Wpe.height,zpe=0,s>0&&(Fpe=Wpe.height+s),l<-Lpe&&(zpe=Lpe+l),!0},_getFirstCharLen:function(){return 1},_getFirstWordLen:function(e,t,i){var n=e.charAt(t);if(Su(n)||"\n"===n||Tu(n))return 1;if(Dpe){var r=1,a=Dpe.getLetterDefinitionForChar(n,ime);if(!a)return r;for(var o=a.xAdvance*Upe+Xpe,s=t+1;s<i&&(n=e.charAt(s),a=Dpe.getLetterDefinitionForChar(n,ime));++s){if(o+a.offsetX*Upe+a.w*Upe>$pe&&!Tu(n)&&$pe>0)return r;if(o+=a.xAdvance*Upe+Xpe,"\n"===n||Tu(n)||Su(n))break;r++}return r}},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=Ope.length){var i=new Spe;Ope.push(i)}Ope[e].char=t,Ope[e].hash=t.charCodeAt(0)+ime.hash,Ope[e].valid=!1},_recordLetterInfo:function(e,t,i,n){if(i>=Ope.length){var r=new Spe;Ope.push(r)}var a=t.charCodeAt(0)+ime.hash;Ope[i].line=n,Ope[i].char=t,Ope[i].hash=a;var o=Dpe&&Dpe.getLetter(a);Ope[i].valid=!!o&&!!o.valid,Ope[i].x=e.x,Ope[i].y=e.y},_alignText:function(){Lpe=0,Mpe.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),this._updateQuads()},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),Hpe=e,t&&this._updateContent()},_isVerticalClamp:function(){return Lpe>Wpe.height},_isHorizontalClamp:function(){for(var e=!1,t=0,i=Gpe.length;t<i;++t){var n=Ope[t];if(n.valid){var r=Dpe.getLetter(n.hash);if(!r)continue;var a=n.x+r.w*Upe,o=n.line;if(Qpe>0)if(Zpe){if(Mpe[o]>Wpe.width&&(a>Wpe.width||a<0)){e=!0;break}}else if(a>Wpe.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var i=Mpe[t],n=e>Wpe.width||e<0;return Zpe?i>Wpe.width&&n:n},_updateQuads:function(){if(wpe&&Dpe){var e=Dpe.texture,t=(wpe.node,wpe.renderData);t.dataLength=t.vertexCount=t.indicesCount=0;for(var i=Wpe,n=Rpe.anchorPoint,r=n.x*i.width,a=n.y*i.height,o=!0,s=0,l=Gpe.length;s<l;++s){var c=Ope[s];if(c.valid){var u=Dpe.getLetter(c.hash);if(u){Cpe.height=u.h,Cpe.width=u.w,Cpe.x=u.u,Cpe.y=u.v;var h=c.y+Npe;if(Jpe>0){if(h>Fpe){var _=h-Fpe;Cpe.y+=_,Cpe.height-=_,h-=_}h-u.h*Upe<zpe&&(Cpe.height=h<zpe?0:h-zpe)}var d=c.line,f=c.x+u.w/2*Upe+Ppe[d];if(Qpe>0&&this._isHorizontalClamped(f,d))if(Kpe===vpe.CLAMP)Cpe.width=0;else if(Kpe===vpe.SHRINK){if(Wpe.width>u.w){o=!1;break}Cpe.width=0}if(Cpe.height>0&&Cpe.width>0){var p=c.x+Ppe[c.line];this.appendQuad(wpe,e,Cpe,!1,p-r,h-a,Upe)}}}}return o}},appendQuad:function(e,t,i,n,r,a,o){},_computeAlignmentOffset:function(){switch(Ppe.length=0,jpe){case ype.LEFT:for(var e=0;e<Bpe;++e)Ppe.push(0);break;case ype.CENTER:for(var t=0,i=Mpe.length;t<i;t++)Ppe.push((Wpe.width-Mpe[t])/2);break;case ype.RIGHT:for(var n=0,r=Mpe.length;n<r;n++)Ppe.push(Wpe.width-Mpe[n])}switch(qpe){case xpe.TOP:Npe=Wpe.height;break;case xpe.CENTER:Npe=(Wpe.height+Lpe)/2-(Ype-Hpe)/2;break;case xpe.BOTTOM:Npe=(Wpe.height+Lpe)/2-(Ype-Hpe)}},_setupBMFontOverflowMetrics:function(){var e=Wpe.width,t=Wpe.height;Kpe===vpe.RESIZE_HEIGHT&&(t=0),Kpe===vpe.NONE&&(e=0,t=0),Qpe=e,Jpe=t,kpe.width=e,kpe.height=t,$pe=e}},rme=new Ma(255,255,255,255),ame={createData:function(e){return e.requestRenderData()},fillBuffers:function(e,t){if(e.renderData){var i=e.node;rme.a=e.color.a,jte(i,t,e.renderData,rme)}},appendQuad:mpe.appendQuad};Te(ame,nme);var ome=hne.Overflow,sme=Ma.WHITE.clone(),lme=Ce(Vse,Yr),cme=null,ume=null,hme=null,_me="",dme="",fme=0,pme=0,mme=[],vme=new wa,gme=0,yme=0,xme=0,Sme=new Ma,Tme="",Eme=ome.NONE,bme=!1,Ame=!1,Cme=new Ma,wme=0,Rme=0,Ime=!1,Ome=!1,Mme=!1,Pme={getAssemblerData:function(){var e=hne._canvasPool.get();return e.canvas.width=e.canvas.height=1,e},resetAssemblerData:function(e){e&&hne._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData&&e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._calculateSplitStrings(),this._updateLabelDimensions(),this._calculateTextBaseline(),this._updateTexture(),e.actualFontSize=fme,t.setContentSize(vme),this.updateVertexData(e),e.markForUpdateRenderData(!1),cme=null,ume=null,hme=null}},updateVertexData:function(e){},_updateFontFamily:function(e){e.useSystemFont?Tme=e.fontFamily:e.font?e.font._nativeAsset?Tme=e.font._nativeAsset:aO.load(e.font.nativeUrl,(function(t,i){Tme=i||"Arial",e.font._nativeAsset=i,e.updateRenderData(!0)})):Tme="Arial"},_updateProperties:function(e,t){var i=e.assemblerData;if(i){cme=i.context,ume=i.canvas,hme=e.spriteFrame,dme=e.string.toString(),fme=e.fontSize,pme=fme,Eme=e.overflow,vme.width=t.width,vme.height=t.height,gme=e.lineHeight,yme=e.horizontalAlign,xme=e.verticalAlign,Sme=e.color,Ime=e.isBold,Ome=e.isItalic,Mme=e.isUnderline,bme=Eme!==ome.NONE&&(Eme===ome.RESIZE_HEIGHT||e.enableWrapText);var n=lme&&e.getComponent(Vse);n&&n.enabled?(Ame=!0,Rme=wme=n.width,Cme.set(n.color),Cme.a=Cme.a*e.color.a/255):(Ame=!1,Rme=0)}},_calculateFillTextStartPosition:function(){var e=this._getLineHeight(),t=mme.length,i=0,n=0;return i=yme===ine.RIGHT?vme.width-Rme:yme===ine.CENTER?vme.width/2:0+Rme,n=xme===nne.TOP?fme*(pu/2):xme===nne.CENTER?vme.height/2-e*(t-1)/2:vme.height-e*(t-1),new ia(i,n)},_updateTexture:function(){if(cme&&ume){cme.clearRect(0,0,ume.width,ume.height),cme.font=_me;var e,t,i=this._calculateFillTextStartPosition(),n=this._getLineHeight();cme.lineJoin="round",cme.fillStyle="rgba(".concat(Sme.r,", ").concat(Sme.g,", ").concat(Sme.b,", ").concat(Sme.a/255,")");for(var r=0;r<mme.length;++r){if(Ame){var a=Cme||sme;cme.strokeStyle="rgba(".concat(a.r,", ").concat(a.g,", ").concat(a.b,", ").concat(a.a/255,")"),cme.lineWidth=2*wme,cme.strokeText(mme[r],i.x,i.y+r*n)}cme.fillText(mme[r],i.x,i.y+r*n),Mme&&(e=this._calculateUnderlineStartPosition(),cme.save(),cme.beginPath(),cme.lineWidth=fme/8,cme.strokeStyle="rgba(".concat(Sme.r,", ").concat(Sme.g,", ").concat(Sme.b,", ").concat(Sme.a/255,")"),cme.moveTo(e.x,e.y+r*n-1),cme.lineTo(e.x+ume.width,e.y+r*n-1),cme.stroke(),cme.restore())}if(hme)t=hme instanceof Pd?hme.texture:hme,0!==ume.width&&0!==ume.height&&(t.reset({width:ume.width,height:ume.height,mipmapLevel:1}),t.uploadData(ume))}},_calculateUnderlineStartPosition:function(){var e=this._getLineHeight(),t=mme.length,i=0+Rme,n=0;return n=xme===nne.TOP?fme:xme===nne.CENTER?vme.height/2-e*(t-1)/2+fme/2:vme.height-e*(t-1),new ia(i,n)},_updateLabelDimensions:function(){if(cme){var e=dme.split("\n");if(Eme===ome.RESIZE_HEIGHT)vme.height=(mme.length+pu)*this._getLineHeight();else if(Eme===ome.NONE){mme=e;for(var t,i=0,n=0,r=y(e);!(t=r()).done;){var a=t.value,o=Eu(cme,a);i=i>o?i:o}n=(mme.length+pu)*this._getLineHeight(),vme.width=parseFloat(i.toFixed(2))+2*Rme,vme.height=parseFloat(n.toFixed(2)),Ome&&(vme.width+=pme*Math.tan(.20943951))}ume&&(ume.width=vme.width,ume.height=vme.height)}},_calculateTextBaseline:function(){var e,t;e=yme===ine.RIGHT?"right":yme===ine.CENTER?"center":"left",t=xme===nne.TOP?"top":xme===nne.CENTER?"middle":"bottom",cme&&(cme.textAlign=e,cme.textBaseline=t)},_calculateSplitStrings:function(){if(cme){var e=dme.split("\n");if(bme){mme=[];for(var t,i=vme.width-2*Rme,n=y(e);!(t=n()).done;){var r=t.value,a=Au(r,Eu(cme,r),i,this._measureText(cme));mme=mme.concat(a)}}else mme=e}},_getFontDesc:function(){var e=fme.toString()+"px ";return e+=Tme,Ime&&(e="bold "+e),Ome&&(e="italic "+e),e},_getLineHeight:function(){var e=gme;return 0|(e=0===e?fme:e*fme/pme)},_calculateParagraphLength:function(e,t){for(var i,n=[],r=y(e);!(i=r()).done;){var a=Eu(t,i.value);n.push(a)}return n},_measureText:function(e){return function(t){return Eu(e,t)}},_calculateLabelFont:function(){if(cme&&(_me=this._getFontDesc(),cme.font=_me,Eme===ome.SHRINK)){var e=dme.split("\n"),t=this._calculateParagraphLength(e,cme);mme=e;var i=0,n=0,r=0;if(bme){var a=vme.width-2*Rme,o=vme.height-2*Rme;if(a<0||o<0)return _me=this._getFontDesc(),void(cme.font=_me);n=o+1,r=a+1;for(var s=fme+1,l=[],c=!0,u=0|s;n>o||r>a;){if(c?s=u/2|0:u=s=u-1,s<=0){z(4003);break}for(fme=s,_me=this._getFontDesc(),cme.font=_me,mme=[],n=0,i=0;i<e.length;++i){var h=0,_=Eu(cme,e[i]);for(l=Au(e[i],_,a,this._measureText(cme));h<l.length;){r=Eu(cme,l[h]),n+=this._getLineHeight(),++h}mme=mme.concat(l)}c&&(n>o?u=0|s:(c=!1,n=o+1))}}else{for(n=e.length*this._getLineHeight(),i=0;i<e.length;++i)r<t[i]&&(r=t[i]);var d=(vme.width-2*Rme)/r,f=vme.height/n;fme=pme*Math.min(1,d,f)|0,_me=this._getFontDesc(),cme.font=_me}}}},kme=Ma.WHITE.clone(),Dme={createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.vertexCount=4,t.indicesCount=6;var i=t.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;for(var n=5,r=0;r<4;r++)Ma.toArray(i,kme,n),n+=9;return t},fillBuffers:function(e,t){var i=e.renderData,n=i.data,r=e.node,a=t.currBufferBatch,o=a.byteOffset>>2,s=a.indicesOffset,l=a.vertexOffset;a.request()||(a=t.currBufferBatch,s=0,l=0);var c=a.vData,u=a.iData,h=i.vData,_=n[0],d=n[3];r.updateWorldTransform();var f=r._pos,p=r._rot,m=r._scale,v=_.x*m.x,g=d.x*m.x,y=_.y*m.y,x=d.y*m.y,S=p.x,T=p.y,E=p.z,b=p.w,A=S*T,C=E*b,w=S*S-T*T,R=b*b-E*E,I=R+w,O=2*(A-C),M=R-w,P=2*(A+C),k=f.x,D=f.y;h[0]=I*v+O*y+k,h[1]=M*y+P*v+D,h[9]=I*g+O*y+k,h[10]=M*y+P*g+D,h[18]=I*v+O*x+k,h[19]=M*x+P*v+D,h[27]=I*g+O*x+k,h[28]=M*x+P*g+D,c.set(h,o),u[s++]=l,u[s++]=l+1,u[s++]=l+2,u[s++]=l+2,u[s++]=l+1,u[s++]=l+3},updateVertexData:function(e){var t=e.renderData;if(t){var i=e.node._uiProps.uiTransformComp,n=i.width,r=i.height,a=i.anchorX*n,o=i.anchorY*r,s=t.data;s[0].x=-a,s[0].y=-o,s[3].x=n-a,s[3].y=r-o}}};Te(Dme,Pme);var Bme=e("labelAssembler",{getAssembler:function(e){var t=Dme;return e.font instanceof mI?t=mpe:e.cacheMode===hne.CacheMode.CHAR&&(t=ame),t}});hne.Assembler=Bme;var Lme=XD.sharedManager,Nme={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t},updateRenderData:function(e){var t=e.renderData;t&&t.vertDirty&&this.updateVertexData&&this.updateVertexData(e)},updateVertexData:function(e){var t=e.renderData;if(t){var i,n,r,a,o=e.node._uiProps.uiTransformComp,s=t.data,l=o.width,c=o.height,u=o.anchorX*l,h=o.anchorY*c;i=-u,n=-h,r=l-u,a=c-h,s[0].x=i,s[0].y=n,s[3].x=r,s[3].y=a,t.vertDirty=!1}},fillBuffers:function(e,t){Lme.pushMask(e),Lme.clear(),e.clearGraphics.updateAssembler(t),Lme.enterLevel(),e.graphics.updateAssembler(t),Lme.enableMask()}},Fme={fillBuffers:function(e,t){Lme.exitMask()}},zme={getAssembler:function(){return Nme}},Ume={getAssembler:function(){return Fme}};Koe.Assembler=zme,Koe.PostAssembler=Ume;var Gme=Dk.FillType,Hme=new Ta,Vme={useModel:!1,updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t){var n=i.uvDirty,r=i.vertDirty;if(!n&&!r)return;var a=e.fillStart,o=e.fillRange;o<0&&(a+=o,o=-o),o=(o=(o=a+o)>1?1:o)<0?0:o;var s=(a=(a=a>1?1:a)<0?0:a)+(o=(o-=a)<0?0:o);s=s>1?1:s,n&&this.updateUVs(e,a,s),r&&(this.updateVertexData&&this.updateVertexData(e,a,s),this.updateWorldVertexData(e))}},updateUVs:function(e,t,i){var n=e.spriteFrame,r=e.renderData,a=r.data,o=n.width,s=n.height,l=n.getRect(),c=0,u=0,h=0,_=0,d=0,f=0,p=0,m=0,v=0,g=0;switch(n.isRotated()?(c=l.x/o,u=(l.y+l.width)/s,h=d=c,p=v=(l.x+l.height)/o,f=g=u,_=m=l.y/s):(c=l.x/o,u=(l.y+l.height)/s,h=p=c,d=v=(l.x+l.width)/o,_=f=u,m=g=l.y/s),e.fillType){case Gme.HORIZONTAL:a[0].u=h+(d-h)*t,a[0].v=_+(f-_)*t,a[1].u=h+(d-h)*i,a[1].v=_+(f-_)*i,a[2].u=p+(v-p)*t,a[2].v=m+(g-m)*t,a[3].u=p+(v-p)*i,a[3].v=m+(g-m)*i;break;case Gme.VERTICAL:a[0].u=h+(p-h)*t,a[0].v=_+(m-_)*t,a[1].u=d+(v-d)*t,a[1].v=f+(g-f)*t,a[2].u=h+(p-h)*i,a[2].v=_+(m-_)*i,a[3].u=d+(v-d)*i,a[3].v=f+(g-f)*i;break;default:V(2626)}r.uvDirty=!1},updateVertexData:function(e,t,i){var n=e.renderData,r=n.data,a=e.node._uiProps.uiTransformComp,o=a.width,s=a.height,l=a.anchorX*o,c=a.anchorY*s,u=-l,h=-c,_=o-l,d=s-c,f=0;switch(e.fillType){case Gme.HORIZONTAL:f=u+(_-u)*i,u=u+(_-u)*t,_=f;break;case Gme.VERTICAL:f=h+(d-h)*i,h=h+(d-h)*t,d=f;break;default:V(2626)}r[4].x=u,r[4].y=h,r[5].x=_,r[5].y=h,r[6].x=u,r[6].y=d,r[7].x=_,r[7].y=d,n.vertDirty=!1},createData:function(e){var t=e.requestRenderData();t.dataLength=8,t.vertexCount=4,t.indicesCount=6;for(var i,n=y(t.data);!(i=n()).done;){i.value.z=0}return t},updateWorldVertexData:function(e){var t=e.node,i=e.renderData.data;t.getWorldMatrix(Hme);for(var n=0;n<4;n++){var r=i[n+4],a=i[n];oa.transformMat4(a,r,Hme)}},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);e.node;!function(e,t,i,n){var r=i.data,a=t.currBufferBatch,o=a.byteOffset>>2,s=i.vertexCount,l=a.indicesOffset,c=a.vertexOffset;a.request(s,i.indicesCount)||(a=t.currBufferBatch,s=0,l=0,c=0);for(var u=a.vData,h=0;h<s;h++){var _=r[h];u[o++]=_.x,u[o++]=_.y,u[o++]=_.z,u[o++]=_.u,u[o++]=_.v,Ma.toArray(u,n,o),o+=4}var d=a.iData;d[l++]=c,d[l++]=c+1,d[l++]=c+2,d[l++]=c+1,d[l++]=c+3,d[l++]=c+2}(0,t,e.renderData,e.color)}},Wme=2*Math.PI,jme=[new ia,new ia,new ia,new ia],qme=new Array(4),Xme=new Array(8),Yme=[new ia,new ia,new ia,new ia],Kme=[new ia,new ia,new ia,new ia],Zme=new ia,Qme=[new ia,new ia,new ia,new ia];function Jme(e,t,i,n,r,a,o){var s=Math.sin(a);s=Math.abs(s)>1e-6?s:0;var l=Math.cos(a),c=0,u=0;if(0!==(l=Math.abs(l)>1e-6?l:0)){if(c=s/l,(e-r.x)*l>0){var h=r.y+c*(e-r.x);o[0].x=e,o[0].y=h}if((t-r.x)*l>0){var _=r.y+c*(t-r.x);o[2].x=t,o[2].y=_}}if(0!==s){if(u=l/s,(n-r.y)*s>0){var d=r.x+u*(n-r.y);o[3].x=d,o[3].y=n}if((i-r.y)*s>0){var f=r.x+u*(i-r.y);o[1].x=f,o[1].y=i}}}function $me(e,t){var i=t.x-e.x,n=t.y-e.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(n/i);return i<0&&(r+=Math.PI),r}function eve(e,t,i,n,r){var a=qme,o=a[0],s=a[1],l=a[2],c=a[3];e[t].x=i.x,e[t].y=i.y,e[t+1].x=n.x,e[t+1].y=n.y,e[t+2].x=r.x,e[t+2].y=r.y;tve((i.x-o)/(l-o),(i.y-s)/(c-s),e,t),tve((n.x-o)/(l-o),(n.y-s)/(c-s),e,t+1),tve((r.x-o)/(l-o),(r.y-s)/(c-s),e,t+2)}function tve(e,t,i,n){var r=Xme,a=r[0]+(r[2]-r[0])*e,o=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,l=r[5]+(r[7]-r[5])*e,c=i[n];c.u=a+(o-a)*t,c.v=s+(l-s)*t}for(var ive={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;if(i&&t&&(i.vertDirty||i.uvDirty)){var n=i.data,r=e.fillStart,a=e.fillRange;for(a<0&&(r+=a,a=-a);r>=1;)r-=1;for(;r<0;)r+=1;var o=(r*=Wme)+(a*=Wme);!function(e){var t=e.node._uiProps.uiTransformComp,i=t.width,n=t.height,r=t.anchorX*i,a=t.anchorY*n,o=-r,s=-a,l=i-r,c=n-a,u=qme;u[0]=o,u[1]=s,u[2]=l,u[3]=c;var h=e.fillCenter,_=Zme.x=Math.min(Math.max(0,h.x),1)*(l-o)+o,d=Zme.y=Math.min(Math.max(0,h.y),1)*(c-s)+s;jme[0].x=jme[3].x=o,jme[1].x=jme[2].x=l,jme[0].y=jme[1].y=s,jme[2].y=jme[3].y=c;for(var f,p=y(Qme);!(f=p()).done;){var m=f.value;ia.set(m,0,0)}_!==u[0]&&ia.set(Qme[0],3,0),_!==u[2]&&ia.set(Qme[2],1,2),d!==u[1]&&ia.set(Qme[1],0,1),d!==u[3]&&ia.set(Qme[3],2,3)}(e),function(e){var t=e.width,i=e.height,n=e.getRect(),r=0,a=0,o=0,s=0,l=Xme;e.isRotated()?(r=n.x/t,a=(n.x+n.height)/t,o=n.y/i,s=(n.y+n.width)/i,l[0]=l[2]=r,l[4]=l[6]=a,l[3]=l[7]=s,l[1]=l[5]=o):(r=n.x/t,a=(n.x+n.width)/t,o=n.y/i,s=(n.y+n.height)/i,l[0]=l[4]=r,l[2]=l[6]=a,l[1]=l[3]=s,l[5]=l[7]=o)}(t),Jme(qme[0],qme[2],qme[1],qme[3],Zme,r,Yme),Jme(qme[0],qme[2],qme[1],qme[3],Zme,r+a,Kme);for(var s=0,l=0;l<4;++l){var c=Qme[l];if(c)if(a>=Wme)i.dataLength=s+3,eve(n,s,Zme,jme[c.x],jme[c.y]),s+=3;else{var u=$me(Zme,jme[c.x]),h=$me(Zme,jme[c.y]);h<u&&(h+=Wme),u-=Wme,h-=Wme;for(var _=0;_<3;++_)u>=o||(u>=r?(i.dataLength=s+3,eve(n,s,Zme,jme[c.x],h>=o?Kme[l]:jme[c.y]),s+=3):h<=r||(h<=o?(i.dataLength=s+3,eve(n,s,Zme,Yme[l],jme[c.y]),s+=3):(i.dataLength=s+3,eve(n,s,Zme,Yme[l],Kme[l]),s+=3))),u+=Wme,h+=Wme}}i.indicesCount=i.vertexCount=s,i.vertDirty=i.uvDirty=!1}},fillBuffers:function(e,t){!function(e,t,i,n){var r=i.data,a=t.currBufferBatch,o=a.byteOffset>>2,s=i.vertexCount,l=a.indicesOffset,c=a.vertexOffset;a.request(s,i.indicesCount)||(a=t.currBufferBatch,s=0,l=0,c=0);var u=a.vData;e.getWorldMatrix(Wte);for(var h=0;h<s;h++){var _=r[h];oa.set(Vte,_.x,_.y,0),oa.transformMat4(Vte,Vte,Wte),u[o++]=Vte.x,u[o++]=Vte.y,u[o++]=Vte.z,u[o++]=_.u,u[o++]=_.v,Ma.toArray(u,n,o),o+=4}for(var d=a.iData,f=0;f<i.dataLength;f++)d[l+f]=c+f}(e.node,t,e.renderData,e.color)}},nve=[],rve=0;rve<4;rve++)nve.push(new oa);for(var ave={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.vertexCount=4,t.indicesCount=6,t.vData=new Float32Array(36),t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&this.updateVertexData(e),i.uvDirty&&this.updateUvs(e))},fillBuffers:function(e,t){if(null!==e){var i=e.renderData.data,n=e.node,r=t.currBufferBatch,a=r.byteOffset>>2,o=r.indicesOffset,s=r.vertexOffset;r.request()||(r=t.currBufferBatch,a=0,o=0,s=0);var l=r.vData,c=r.iData,u=e.renderData.vData,h=i[0],_=i[3],d=n.worldMatrix,f=d.m00,p=d.m01,m=d.m04,v=d.m05,g=d.m12,y=d.m13,x=h.x,S=_.x,T=h.y,E=_.y,b=f*x,A=f*S,C=p*x,w=p*S,R=m*T,I=m*E,O=v*T,M=v*E;u[0]=b+R+g,u[1]=C+O+y,u[9]=A+R+g,u[10]=w+O+y,u[18]=b+I+g,u[19]=C+M+y,u[27]=A+I+g,u[28]=w+M+y,l.set(u,a),c[o++]=s,c[o++]=s+1,c[o++]=s+2,c[o++]=s+2,c[o++]=s+1,c[o++]=s+3}},updateVertexData:function(e){var t=e.renderData;if(t){var i=e.node._uiProps.uiTransformComp,n=t.data,r=i.width,a=i.height,o=i.anchorX*r,s=i.anchorY*a,l=0,c=0,u=0,h=0;if(e.trim)l=-o,c=-s,u=r-o,h=a-s;else{var _=e.spriteFrame,d=_.getOriginalSize(),f=_.getRect(),p=d.width,m=d.height,v=f.width,g=f.height,y=_.getOffset(),x=r/p,S=a/m,T=y.x+(p-v)/2,E=y.x-(p-v)/2;l=T*x-o,c=(y.y+(m-g)/2)*S-s,u=r+E*x-o,h=a+(y.y-(m-g)/2)*S-s}n[0].x=l,n[0].y=c,n[0].z=0,n[3].x=u,n[3].y=h,n[3].z=0,t.vertDirty=!1}},updateUvs:function(e){var t=e.renderData,i=t.vData,n=e.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],t.uvDirty=!1},updateColor:function(e){for(var t=e.renderData.vData,i=5,n=e.color,r=n.r/255,a=n.g/255,o=n.b/255,s=n.a/255,l=0;l<4;l++)t[i]=r,t[i+1]=a,t[i+2]=o,t[i+3]=s,i+=9}},ove=new oa,sve=new Ta,lve={useModel:!1,createData:function(e){var t=e.requestRenderData();return t.dataLength=20,t.vertexCount=16,t.indicesCount=54,t},updateRenderData:function(e){var t=e.spriteFrame,i=e.renderData;i&&t&&(i.vertDirty&&(this.updateVertexData(e),this.updateWorldVertexData(e)))},updateVertexData:function(e){var t=e.renderData,i=t.data,n=e.node._uiProps.uiTransformComp,r=n.width,a=n.height,o=n.anchorX*r,s=n.anchorY*a,l=e.spriteFrame,c=l.insetLeft,u=l.insetRight,h=l.insetTop,_=l.insetBottom,d=r-c-u,f=a-h-_,p=r/(c+u),m=a/(h+_);p=isNaN(p)||p>1?1:p,m=isNaN(m)||m>1?1:m,d=d<0?0:d,f=f<0?0:f,i[0].x=-o,i[0].y=-s,i[1].x=c*p-o,i[1].y=_*m-s,i[2].x=i[1].x+d,i[2].y=i[1].y+f,i[3].x=r-o,i[3].y=a-s,t.vertDirty=!1},fillBuffers:function(e,t){e.node.hasChangedFlags&&this.updateWorldVertexData(e);var i=t.currBufferBatch,n=e.renderData,r=n.data,a=i.byteOffset>>2,o=n.vertexCount,s=i.indicesOffset,l=i.vertexOffset,c=e.spriteFrame.uvSliced;i.request(o,n.indicesCount)||(i=t.currBufferBatch,a=0,s=0,l=0);for(var u=i.vData,h=i.iData,_=4;_<20;++_){var d=r[_],f=c[_-4];u[a++]=d.x,u[a++]=d.y,u[a++]=d.z,u[a++]=f.u,u[a++]=f.v,Ma.toArray(u,e.color,a),a+=4}for(var p=0;p<3;++p)for(var m=0;m<3;++m){var v=l+4*p+m;h[s++]=v,h[s++]=v+1,h[s++]=v+4,h[s++]=v+1,h[s++]=v+5,h[s++]=v+4}},updateWorldVertexData:function(e){var t=e.node,i=e.renderData.data;t.getWorldMatrix(sve);for(var n=0;n<4;++n)for(var r=i[n],a=0;a<4;++a){var o=i[a],s=i[4+4*n+a];oa.set(ove,o.x,r.y,0),oa.transformMat4(s,ove,sve)}}},cve=[],uve=0;uve<4;uve++)cve.push(new oa);var hve,_ve={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,i=e.spriteFrame;if(i&&t&&(t.uvDirty||t.vertDirty)){var n=e.node._uiProps.uiTransformComp,r=Math.abs(n.width),a=Math.abs(n.height),o=i.getRect(),s=i.insetLeft,l=i.insetRight,c=o.width-s-l,u=i.insetTop,h=i.insetBottom,_=o.height-u-h;this.sizableWidth=r-s-l,this.sizableHeight=a-u-h,this.sizableWidth=this.sizableWidth>0?this.sizableWidth:0,this.sizableHeight=this.sizableHeight>0?this.sizableHeight:0,this.hRepeat=0===c?this.sizableWidth:this.sizableWidth/c,this.vRepeat=0===_?this.sizableHeight:this.sizableHeight/_,this.row=Math.ceil(this.hRepeat+2),this.col=Math.ceil(this.vRepeat+2),t.dataLength=Math.max(8,this.row+1,this.col+1),this.updateVerts(e),t.vertexCount=this.row*this.col*4,t.indicesCount=this.row*this.col*6,t.uvDirty=!1,t.vertDirty=!1}},fillBuffers:function(e,t){var i,n=e.node,r=e.renderData,a=t.currBufferBatch,o=a.indicesOffset,s=a.byteOffset>>2,l=a.vertexOffset,c=r.vertexCount,u=r.indicesCount,h=a.vData,_=a.iData;a.request(c,u)||(a=t.currBufferBatch,s=0,o=0,l=0);var d=e.spriteFrame,f=d.isRotated(),p=d.uv,m=null===(i=e.spriteFrame)||void 0===i?void 0:i.uvSliced,v=d.getRect(),g=d.insetLeft,y=d.insetRight,x=v.width-g-y,S=d.insetTop,T=d.insetBottom,E=v.height-S-T,b=n.worldMatrix;this.fillVertices(h,s,b,this.row,this.col,r.data);for(var A=0,C=0,w=0,R=this.row;w<R;++w){C=this.sizableHeight>E?this.sizableHeight>=w*E?1:this.vRepeat%1:this.vRepeat;for(var I=0,O=this.col;I<O;++I){A=this.sizableWidth>x?this.sizableWidth>=I*x?1:this.hRepeat%1:this.hRepeat;var M=s+3,P=M+1;f?(h[M]=p[0],h[P]=p[1],h[M+9]=p[0],h[P+9]=p[1]+(p[7]-p[1])*A,h[M+18]=p[0]+(p[6]-p[0])*C,h[P+18]=p[1],h[M+27]=h[M+18],h[P+27]=h[P+9]):(0===I?h[M]=p[0]:I>0&&I<this.col-1?h[M]=m[1].u:I===this.col-1&&(h[M]=m[2].u),0===w?h[P]=m[0].v:w>0&&w<this.row-1?h[P]=m[4].v:w===this.row-1&&(h[P]=m[8].v),0===I||I>0&&I<this.col-1?h[M+9]=m[1].u+(m[2].u-m[1].u)*A:I===this.col-1&&(h[M+9]=m[3].u),0===w?h[P+9]=m[0].v:w>0&&w<this.row-1?h[P+9]=m[4].v:w===this.row-1&&(h[P+9]=m[8].v),0===I?h[M+18]=p[0]:I>0&&I<this.col-1?h[M+18]=m[1].u:I===this.col-1&&(h[M+18]=m[2].u),0===w||w>0&&w<this.row-1?h[P+18]=m[4].v+(m[8].v-m[4].v)*C:w===this.row-1&&(h[P+18]=m[12].v),h[M+27]=h[M+9],h[P+27]=h[P+18]),Ma.toArray(h,e.color,P+1),Ma.toArray(h,e.color,P+9+1),Ma.toArray(h,e.color,P+18+1),Ma.toArray(h,e.color,P+27+1),s+=36}}for(var k=0;k<u;k+=6)_[o++]=l,_[o++]=l+1,_[o++]=l+2,_[o++]=l+1,_[o++]=l+3,_[o++]=l+2,l+=4},fillVertices:function(e,t,i,n,r,a){for(var o=0,s=0,l=0,c=0,u=0,h=n;u<h;++u){l=a[u].y,c=a[u+1].y;for(var _=0,d=r;_<d;++_){o=a[_].x,s=a[_+1].x,oa.set(cve[0],o,l,0),oa.set(cve[1],s,l,0),oa.set(cve[2],o,c,0),oa.set(cve[3],s,c,0);for(var f=0;f<4;f++){var p=cve[f];oa.transformMat4(p,p,i);var m=9*f;e[t+m]=p.x,e[t+m+1]=p.y,e[t+m+2]=p.z}t+=36}}},updateVerts:function(e){var t,i=e.node._uiProps.uiTransformComp,n=null===(t=e.renderData)||void 0===t?void 0:t.data,r=e.spriteFrame,a=r.getRect(),o=Math.abs(i.width),s=Math.abs(i.height),l=i.anchorX*o,c=i.anchorY*s,u=r.insetLeft,h=r.insetRight,_=a.width-u-h,d=r.insetTop,f=r.insetBottom,p=a.height-d-f,m=i.width/(u+h)>1?1:i.width/(u+h),v=i.height/(d+f)>1?1:i.height/(d+f),g=0,y=0;g=_>0?Math.floor(1e3*this.sizableWidth)/1e3%_==0?_:this.sizableWidth%_:this.sizableWidth,y=p>0?Math.floor(1e3*this.sizableHeight)/1e3%p==0?p:this.sizableHeight%p:this.sizableHeight;for(var x=0;x<=this.col;x++)0===x?n[x].x=-l:x>0&&x<this.col?1===x?n[x].x=u*m+Math.min(_,this.sizableWidth)-l:_>0?x===this.col-1?n[x].x=u+g+_*(x-2)-l:n[x].x=u+Math.min(_,this.sizableWidth)+_*(x-2)-l:n[x].x=u+this.sizableWidth-l:x===this.col&&(n[x].x=Math.min(u+this.sizableWidth+h,o)-l);for(var S=0;S<=this.row;S++)0===S?n[S].y=-c:S>0&&S<this.row?1===S?n[S].y=f*v+Math.min(p,this.sizableHeight)-c:p>0?S===this.row-1?n[S].y=f+y+(S-2)*p-c:n[S].y=f+Math.min(p,this.sizableHeight)+(S-2)*p-c:n[S].y=f+this.sizableHeight-c:S===this.row&&(n[S].y=Math.min(f+this.sizableHeight+d,s)-c)}},dve=Dk.Type,fve=Dk.FillType,pve=e("spriteAssembler",{getAssembler:function(e){var t=ave,i=e;switch(i.type){case dve.SLICED:t=lve;break;case dve.TILED:t=_ve;break;case dve.FILLED:t=i.fillType===fve.RADIAL?ive:Vme}return t}});Dk.Assembler=pve;var mve,vve,gve,yve=e("UIReorderComponent",ii("cc.UIReorderComponent")(hve=function e(){i(this,e),G(1408,"UIReorderComponent")})||hve);E.UIReorderComponent=yve,E.ButtonComponent=one,ze.setClassAlias(one,"cc.ButtonComponent"),E.EditBoxComponent=gae,ze.setClassAlias(gae,"cc.EditBoxComponent"),E.LayoutComponent=Jae,ze.setClassAlias(Jae,"cc.LayoutComponent"),E.MaskComponent=Koe,ze.setClassAlias(Koe,"cc.MaskComponent"),E.LabelComponent=hne,ze.setClassAlias(hne,"cc.LabelComponent"),E.LabelOutlineComponent=Vse,ze.setClassAlias(Vse,"cc.LabelOutlineComponent"),E.ProgressBarComponent=Hse,ze.setClassAlias(Hse,"cc.ProgressBarComponent"),E.RichTextComponent=vle,ze.setClassAlias(vle,"cc.RichTextComponent"),E.ScrollViewComponent=Zce,ze.setClassAlias(Zce,"cc.ScrollViewComponent"),E.ScrollBarComponent=gce,ze.setClassAlias(gce,"cc.ScrollBarComponent"),E.SliderComponent=gue,ze.setClassAlias(gue,"cc.SliderComponent"),E.SpriteComponent=Dk,ze.setClassAlias(Dk,"cc.SpriteComponent"),E.ToggleComponent=vhe,ze.setClassAlias(vhe,"cc.ToggleComponent"),E.ToggleContainerComponent=ghe,ze.setClassAlias(ghe,"cc.ToggleContainerComponent"),E.UIModelComponent=yhe,ze.setClassAlias(yhe,"cc.UIModelComponent"),E.WidgetComponent=Whe,ze.setClassAlias(Whe,"cc.WidgetComponent"),E.GraphicsComponent=Soe,ze.setClassAlias(Soe,"cc.GraphicsComponent"),E.PageViewComponent=Tde,ze.setClassAlias(Tde,"cc.PageViewComponent"),E.PageViewIndicatorComponent=F_e,ze.setClassAlias(F_e,"cc.PageViewIndicatorComponent"),ze.setClassAlias(Ede,"cc.UIStaticBatchComponent"),ze.setClassAlias(bde,"cc.UIOpacityComponent"),E.SafeAreaComponent=Ade,ze.setClassAlias(Ade,"cc.SafeAreaComponent"),ze.setClassAlias(Cde,"cc.UICoordinateTrackerComponent"),E.BlockInputEventsComponent=Ide,ze.setClassAlias(Ide,"cc.BlockInputEventsComponent"),E.UI={MeshBuffer:qD,UIVertexFormat:WD,spriteAssembler:pve,graphicsAssembler:Lfe,labelAssembler:Bme};var xve,Sve,Tve=e("VideoClip",ii("cc.VideoClip")((gve=S((vve=function(e){function t(){var e;return i(this,t),x(e=u(this,s(t).call(this)),"_duration",gve,c(e)),e._video=null,e.loaded=!1,e}return o(t,e),r(t,[{key:"_nativeAsset",set:function(e){this._video=e,e?(this._duration=e.duration,this.loaded=!0):(this._duration=0,this.loaded=!1)},get:function(){return this._video}}]),t}(cn)).prototype,"_duration",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mve=vve))||mve),Eve=et({REMOTE:0,LOCAL:1});!function(e){e[e.NONE=0]="NONE",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.COMPLETED=4]="COMPLETED",e[e.META_LOADED=5]="META_LOADED",e[e.READY_TO_PLAY=6]="READY_TO_PLAY",e[e.ERROR=7]="ERROR",e[e.CLICKED=8]="CLICKED"}(xve||(xve={})),function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(Sve||(Sve={}));var bve,Ave,Cve,wve,Rve,Ive,Ove,Mve,Pve,kve,Dve,Bve,Lve,Nve,Fve,zve,Uve,Gve,Hve,Vve,Wve,jve,qve,Xve,Yve,Kve,Zve,Qve,Jve,$ve,ege,tge,ige,nge,rge,age,oge,sge,lge,cge,uge=E.game,hge=E.Game,_ge=E.view,dge=E.screen,fge=E.visibleRect,pge=E.GFXClearFlag,mge=-Math.pow(2,15),vge=Aa(),gge=function(){function e(t){var n=this;i(this,e),this._eventList=new Map,this._state=xve.NONE,this._video=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._loaded=!1,this._loadedMeta=!1,this._ignorePause=!1,this._waitingFullscreen=!1,this._fullScreenOnAwake=!1,this._playing=!1,this._cachedCurrentTime=-1,this._keepAspectRatio=!1,this._videoComponent=null,this._uiTrans=null,this._stayOnBottom=!1,this._dirty=!1,this._forceUpdate=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._clearColorA=-1,this._clearFlag=void 0,this._loadedMetadataCb=void 0,this._canplayCb=void 0,this._playCb=void 0,this._pauseCb=void 0,this._playingCb=void 0,this._endedCb=void 0,this._errorCb=void 0,this._clickCb=void 0,this._videoComponent=t,this._uiTrans=t.node.getComponent(jv),this._onHide=function(){n.video&&n._state===xve.PLAYING&&(n.video.pause(),n._interrupted=!0)},this._onShow=function(){n._interrupted&&n.video&&(n.video.play(),n._interrupted=!1)},uge.on(hge.EVENT_HIDE,this._onHide),uge.on(hge.EVENT_SHOW,this._onShow),this._loadedMetadataCb=function(e){n._forceUpdate=!0,n._loadedMeta=!0,n.enable(),n._keepAspectRatio&&n.syncTrans(e.target.videoWidth,e.target.videoHeight),n._waitingFullscreen&&(n._waitingFullscreen=!1,n._toggleFullscreen(!0)),n._dispatchEvent(xve.META_LOADED)},this._canplayCb=function(e){if(!n._loaded)switch(e.target.readyState){case Sve.HAVE_METADATA:case Sve.HAVE_ENOUGH_DATA:n._loaded=!0,n._dispatchEvent(xve.READY_TO_PLAY)}},this._playCb=function(e){n._dispatchEvent(xve.PLAYING)},this._pauseCb=function(e){n._playing=!1,n._ignorePause?n._ignorePause=!1:n._dispatchEvent(xve.PAUSED)},this._playingCb=function(e){n._playing=!0,n._dispatchEvent(xve.PLAYING)},this._endedCb=function(e){n._dispatchEvent(xve.COMPLETED)},this._clickCb=function(e){n._dispatchEvent(xve.CLICKED)},this._errorCb=function(e){n._dispatchEvent(xve.ERROR);var t=e.target.error;t&&k("Error "+t.code+"; details: "+t.message)}}return r(e,[{key:"_toggleFullscreen",value:function(e){var t=this,i=this._video;if(i&&i.readyState===Sve.HAVE_ENOUGH_DATA)return Gn.os===Gn.OS_IOS&&Gn.isBrowser?(e?i.webkitEnterFullscreen&&i.webkitEnterFullscreen():i.webkitExitFullscreen&&i.webkitExitFullscreen(),void(this._fullScreenOnAwake=i.webkitDisplayingFullscreen)):dge.supportsFullScreen?void(e?(Gn.browserType===Gn.BROWSER_TYPE_IE&&(i.style.transform=""),i.setAttribute("x5-video-player-fullscreen","true"),dge.requestFullScreen(i,(function(e){var n=Gn.browserType===Gn.BROWSER_TYPE_IE?e.msFullscreenElement:e.fullscreenElement;t._fullScreenOnAwake=n===i}),(function(){t._fullScreenOnAwake=!1}))):(i.removeAttribute("x5-video-player-fullscreen"),dge.exitFullScreen())):(this._fullScreenOnAwake=e,this._forceUpdate=!0,void this.syncMatrix())}},{key:"_dispatchEvent",value:function(e){var t=this._eventList.get(e);t&&(this._state=e,t.call(this))}},{key:"syncTrans",value:function(e,t){this._uiTrans&&(this._uiTrans.width=e,this._uiTrans.height=t)}},{key:"play",value:function(){var e=this;if(this.video){var t=this.video.play();window.Promise&&t instanceof Promise&&t.catch((function(e){})).then((function(){-1!==e._cachedCurrentTime&&e.video.currentTime!==e._cachedCurrentTime&&(e.video.currentTime=e._cachedCurrentTime,e._cachedCurrentTime=-1)}))}}},{key:"pause",value:function(){this.video&&(this.video.pause(),this._cachedCurrentTime=this.video.currentTime)}},{key:"stop",value:function(){var e=this;this.video&&(this._ignorePause=!0,this.video.currentTime=0,this.video.pause(),setTimeout((function(){e._ignorePause=!1,e._dispatchEvent(xve.STOPPED)}),0))}},{key:"syncClip",value:function(e){this.removeDom(),e&&this.appendDom(e._nativeAsset)}},{key:"syncURL",value:function(e){this.removeDom(),e&&this.appendDom(document.createElement("video"),e)}},{key:"syncFullScreenOnAwake",value:function(e){!this._loadedMeta&&e?this._waitingFullscreen=!0:this._toggleFullscreen(e)}},{key:"syncStayOnBottom",value:function(e){this._video&&(this._video.style["z-index"]=e?mge:0,this._stayOnBottom=e),this._dirty=!0}},{key:"syncKeepAspectRatio",value:function(e){this._keepAspectRatio=e,e&&this._loadedMeta&&this.syncTrans(this._video.videoWidth,this._video.videoHeight)}},{key:"removeDom",value:function(){var e=this._video;Xe(uge.container,e)&&(uge.container.removeChild(e),this._removeEvent()),this._cachedCurrentTime=0,this._playing=!1,this._loaded=!1,this._video=null}},{key:"appendDom",value:function(e,t){if(this._video=e,e.className="cocosVideo",e.style.visibility="hidden",e.style.position="absolute",e.style.bottom="0px",e.style.left="0px",e.style["transform-origin"]="0px 100% 0px",e.style["-webkit-transform-origin"]="0px 100% 0px",e.setAttribute("preload","auto"),e.setAttribute("webkit-playsinline",""),e.setAttribute("x5-playsinline",""),e.setAttribute("playsinline",""),this._bindEvent(),uge.container.appendChild(e),t){var i=document.createElement("source");i.src=t,e.appendChild(i)}else this.enable(),this._keepAspectRatio&&this.syncTrans(e.videoWidth,e.videoHeight)}},{key:"_removeEvent",value:function(){var e=this._video;e.removeEventListener("loadedmetadata",this._loadedMetadataCb),e.removeEventListener("canplay",this._canplayCb),e.removeEventListener("canplaythrough",this._canplayCb),e.removeEventListener("play",this._playCb),e.removeEventListener("pause",this._pauseCb),e.removeEventListener("playing",this._playingCb),e.removeEventListener("click",this._clickCb),e.removeEventListener("ended",this._endedCb),e.removeEventListener("error",this._errorCb)}},{key:"_bindEvent",value:function(){var e=this._video;e.addEventListener("loadedmetadata",this._loadedMetadataCb),e.addEventListener("canplay",this._canplayCb),e.addEventListener("canplaythrough",this._canplayCb),e.addEventListener("play",this._playCb),e.addEventListener("pause",this._pauseCb),e.addEventListener("playing",this._playingCb),e.addEventListener("click",this._clickCb),e.addEventListener("ended",this._endedCb),e.addEventListener("error",this._errorCb)}},{key:"enable",value:function(){this._video&&(this._video.style.visibility="visible")}},{key:"disable",value:function(){this._video&&(this._video.style.visibility="hidden",this._video.pause())}},{key:"destroy",value:function(){this.removeDom(),this._eventList.clear(),uge.off(hge.EVENT_HIDE,this._onHide),uge.off(hge.EVENT_SHOW,this._onShow)}},{key:"syncSize",value:function(e,t){var i=this._video;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"getUICanvas",value:function(){return this._uiTrans&&this._uiTrans._canvas?this._uiTrans._canvas:null}},{key:"syncMatrix",value:function(){if(this._video&&"hidden"!==this._video.style.visibility&&this._videoComponent){var e=this.getUICanvas();if(e){var t=e.camera;if(t&&!dge.fullScreen()){this._dirty&&(this._dirty=!1,this._stayOnBottom?(this._clearColorA=e.color.a,this._clearFlag=e.clearFlag,e.color.a=0,e.clearFlag=pge.ALL):this._clearFlag&&(e.color.a=this._clearColorA,e.clearFlag=this._clearFlag,this._clearColorA=-1,this._clearFlag=null)),this._videoComponent.node.getWorldMatrix(vge),t.update(!0),t.worldMatrixToScreen(vge,vge,uge.canvas.width,uge.canvas.height);var i=0,n=0;if(this._fullScreenOnAwake?(i=fge.width,n=fge.height):(i=this._uiTrans.contentSize.width,n=this._uiTrans.contentSize.height),this._forceUpdate||this._m00!==vge.m00||this._m01!==vge.m01||this._m04!==vge.m04||this._m05!==vge.m05||this._m12!==vge.m12||this._m13!==vge.m13||this._w!==i||this._h!==n){this._m00=vge.m00,this._m01=vge.m01,this._m04=vge.m04,this._m05=vge.m05,this._m12=vge.m12,this._m13=vge.m13,this._w=i,this._h=n;var r,a,o=_ge._devicePixelRatio,s=1/o,l=1/o,c=uge.container,u=vge.m00*s,h=vge.m01,_=vge.m04,d=vge.m05*l;r=this._w*s,a=this._h*l,this._keepAspectRatio||this.syncSize(this._w,this._h);var f=this._uiTrans.anchorPoint,p=f.x,m=f.y,v=r*vge.m00*p,g=a*vge.m05*m,y=c&&c.style.paddingLeft?parseInt(c.style.paddingLeft):0,x=c&&c.style.paddingBottom?parseInt(c.style.paddingBottom):0,S="matrix("+u+","+-h+","+-_+","+d+","+(vge.m12*s-v+y)+","+-(vge.m13*l-g+x)+")";this._video.style.transform=S,this._video.style["-webkit-transform"]=S,Gn.browserType!==Gn.BROWSER_TYPE_IE&&(this._forceUpdate=!1)}}}}}},{key:"fullScreenOnAwake",get:function(){return this._fullScreenOnAwake}},{key:"loaded",get:function(){return this._loaded}},{key:"eventList",get:function(){return this._eventList}},{key:"video",get:function(){return this._video}},{key:"state",get:function(){return this._state}}]),e}();E.internal.VideoPlayerImpl=gge;var yge;e("VideoPlayer",(bve=ii("cc.VideoPlayer"),Ave=mi("i18n:cc.VideoPlayer"),Cve=_i("Components/VideoPlayer"),wve=ni(jv),Rve=Li(Tve),Ive=Li(Eve),Ove=Si("i18n:videoplayer.resourceType"),Mve=Si("i18n:videoplayer.remoteURL"),Pve=Li(Tve),kve=Si("i18n:videoplayer.clip"),Dve=Si("i18n:videoplayer.playOnAwake"),Bve=Ti([0,10,1]),Lve=Si("i18n:videoplayer.playbackRate"),Nve=Ti([0,1,.1]),Fve=Si("i18n:videoplayer.volume"),zve=Si("i18n:videoplayer.mute"),Uve=Si("i18n:videoplayer.loop"),Gve=Si("i18n:videoplayer.keepAspectRatio"),Hve=Si("i18n:videoplayer.fullScreenOnAwake"),Vve=Si("i18n:videoplayer.stayOnBottom"),Wve=Li([CB]),jve=wi(20),qve=Si("i18n:videoplayer.videoPlayerEvent"),bve(Xve=Ave(Xve=Cve(Xve=wve(Xve=hi((cge=lge=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_resourceType",Kve,c(n)),x(n,"_remoteURL",Zve,c(n)),x(n,"_clip",Qve,c(n)),x(n,"_playOnAwake",Jve,c(n)),x(n,"_volume",$ve,c(n)),x(n,"_mute",ege,c(n)),x(n,"_playbackRate",tge,c(n)),x(n,"_loop",ige,c(n)),x(n,"_controls",nge,c(n)),x(n,"_fullScreenOnAwake",rge,c(n)),x(n,"_stayOnBottom",age,c(n)),x(n,"_keepAspectRatio",oge,c(n)),n._impl=void 0,n._cachedCurrentTime=0,x(n,"videoPlayerEvent",sge,c(n)),n}return o(t,e),r(t,[{key:"syncSource",value:function(){this._impl&&(this._resourceType===Eve.REMOTE?this._impl.syncURL(this._remoteURL):this._impl.syncClip(this._clip))}},{key:"onLoad",value:function(){this._impl=new gge(this),this.syncSource(),this.nativeVideo&&(this.nativeVideo.loop=this._loop,this.nativeVideo.volume=this._volume,this.nativeVideo.muted=this._mute,this.nativeVideo.playbackRate=this._playbackRate,this.nativeVideo.currentTime=this._cachedCurrentTime,this.nativeVideo.controls=this._controls),this._impl.syncStayOnBottom(this._stayOnBottom),this._impl.syncKeepAspectRatio(this._keepAspectRatio),this._impl.syncFullScreenOnAwake(this._fullScreenOnAwake),this._impl.eventList.set(xve.META_LOADED,this.onMetaLoaded.bind(this)),this._impl.eventList.set(xve.READY_TO_PLAY,this.onReadyToPlay.bind(this)),this._impl.eventList.set(xve.PLAYING,this.onPlaying.bind(this)),this._impl.eventList.set(xve.PAUSED,this.onPasued.bind(this)),this._impl.eventList.set(xve.STOPPED,this.onStopped.bind(this)),this._impl.eventList.set(xve.COMPLETED,this.onCompleted.bind(this)),this._impl.eventList.set(xve.ERROR,this.onError.bind(this)),this._playOnAwake&&this._impl.loaded&&this.play()}},{key:"onEnable",value:function(){this._impl&&this._impl.enable()}},{key:"onDisable",value:function(){this._impl&&this._impl.disable()}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.syncMatrix()}},{key:"onMetaLoaded",value:function(){CB.emitEvents(this.videoPlayerEvent,this,xve.META_LOADED),this.node.emit("meta-loaded",this)}},{key:"onReadyToPlay",value:function(){this._playOnAwake&&!this.isPlaying&&this.play(),CB.emitEvents(this.videoPlayerEvent,this,xve.READY_TO_PLAY),this.node.emit("ready-to-play",this)}},{key:"onPlaying",value:function(){CB.emitEvents(this.videoPlayerEvent,this,xve.PLAYING),this.node.emit("playing",this)}},{key:"onPasued",value:function(){CB.emitEvents(this.videoPlayerEvent,this,xve.PAUSED),this.node.emit("paused",this)}},{key:"onStopped",value:function(){CB.emitEvents(this.videoPlayerEvent,this,xve.STOPPED),this.node.emit("stopped",this)}},{key:"onCompleted",value:function(){CB.emitEvents(this.videoPlayerEvent,this,xve.COMPLETED),this.node.emit("completed",this)}},{key:"onError",value:function(){CB.emitEvents(this.videoPlayerEvent,this,xve.ERROR),this.node.emit("error",this)}},{key:"play",value:function(){this._impl&&this._impl.play()}},{key:"pause",value:function(){this._impl&&this._impl.pause()}},{key:"stop",value:function(){this._impl&&this._impl.stop()}},{key:"resourceType",get:function(){return this._resourceType},set:function(e){this._resourceType!==e&&(this._resourceType=e,this.syncSource())}},{key:"remoteURL",get:function(){return this._remoteURL},set:function(e){this._remoteURL!==e&&(this._remoteURL=e,this.syncSource())}},{key:"clip",get:function(){return this._clip},set:function(e){this._clip!==e&&(this._clip=e,this.syncSource())}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"playbackRate",get:function(){return this._playbackRate},set:function(e){this._playbackRate=e,this.nativeVideo&&(this.nativeVideo.playbackRate=e)}},{key:"volume",get:function(){return this._volume},set:function(e){this._volume=e,this.nativeVideo&&(this.nativeVideo.volume=e)}},{key:"mute",get:function(){return this._mute},set:function(e){this._mute=e,this.nativeVideo&&(this.nativeVideo.mute=e)}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this.nativeVideo&&(this.nativeVideo.loop=e)}},{key:"keepAspectRatio",get:function(){return this._keepAspectRatio},set:function(e){this._keepAspectRatio!==e&&(this._keepAspectRatio=e,this._impl&&this._impl.syncKeepAspectRatio(e))}},{key:"fullScreenOnAwake",get:function(){return this._fullScreenOnAwake=this._impl&&this._impl.fullScreenOnAwake,this._fullScreenOnAwake},set:function(e){this._fullScreenOnAwake!==e&&(this._fullScreenOnAwake=e,this._impl&&this._impl.syncFullScreenOnAwake(e))}},{key:"stayOnBottom",get:function(){return this._stayOnBottom},set:function(e){this._stayOnBottom!==e&&(this._stayOnBottom=e,this._impl&&this._impl.syncStayOnBottom(e))}},{key:"nativeVideo",get:function(){return this._impl&&this._impl.video||null}},{key:"controls",get:function(){return this._controls},set:function(e){this._controls=e,this.nativeVideo&&(this.nativeVideo.controls=e)}},{key:"currentTime",get:function(){return this.nativeVideo?this.nativeVideo.currentTime:this._cachedCurrentTime},set:function(e){isNaN(e)?P("illegal video time!"):(e=vn(e,0,this.duration),this._cachedCurrentTime=e,this.nativeVideo&&(this.nativeVideo.currentTime=e))}},{key:"duration",get:function(){return this.nativeVideo?this.nativeVideo.duration:0}},{key:"state",get:function(){return this._impl?this._impl.state:xve.NONE}},{key:"isPlaying",get:function(){return this.state===xve.PLAYING}}]),t}(Yr),lge.EventType=xve,lge.ResourceType=Eve,Kve=S((Yve=cge).prototype,"_resourceType",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Eve.LOCAL}}),Zve=S(Yve.prototype,"_remoteURL",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Qve=S(Yve.prototype,"_clip",[Rve,si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jve=S(Yve.prototype,"_playOnAwake",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$ve=S(Yve.prototype,"_volume",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ege=S(Yve.prototype,"_mute",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tge=S(Yve.prototype,"_playbackRate",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ige=S(Yve.prototype,"_loop",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nge=S(Yve.prototype,"_controls",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rge=S(Yve.prototype,"_fullScreenOnAwake",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),age=S(Yve.prototype,"_stayOnBottom",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oge=S(Yve.prototype,"_keepAspectRatio",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),S(Yve.prototype,"resourceType",[Ive,Ove],Object.getOwnPropertyDescriptor(Yve.prototype,"resourceType"),Yve.prototype),S(Yve.prototype,"remoteURL",[Mve],Object.getOwnPropertyDescriptor(Yve.prototype,"remoteURL"),Yve.prototype),S(Yve.prototype,"clip",[Pve,kve],Object.getOwnPropertyDescriptor(Yve.prototype,"clip"),Yve.prototype),S(Yve.prototype,"playOnAwake",[Dve],Object.getOwnPropertyDescriptor(Yve.prototype,"playOnAwake"),Yve.prototype),S(Yve.prototype,"playbackRate",[Ci,Bve,Lve],Object.getOwnPropertyDescriptor(Yve.prototype,"playbackRate"),Yve.prototype),S(Yve.prototype,"volume",[Ci,Nve,Fve],Object.getOwnPropertyDescriptor(Yve.prototype,"volume"),Yve.prototype),S(Yve.prototype,"mute",[zve],Object.getOwnPropertyDescriptor(Yve.prototype,"mute"),Yve.prototype),S(Yve.prototype,"loop",[Uve],Object.getOwnPropertyDescriptor(Yve.prototype,"loop"),Yve.prototype),S(Yve.prototype,"keepAspectRatio",[Gve],Object.getOwnPropertyDescriptor(Yve.prototype,"keepAspectRatio"),Yve.prototype),S(Yve.prototype,"fullScreenOnAwake",[Hve],Object.getOwnPropertyDescriptor(Yve.prototype,"fullScreenOnAwake"),Yve.prototype),S(Yve.prototype,"stayOnBottom",[Vve],Object.getOwnPropertyDescriptor(Yve.prototype,"stayOnBottom"),Yve.prototype),sge=S(Yve.prototype,"videoPlayerEvent",[si,Wve,jve,qve],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xve=Yve))||Xve)||Xve)||Xve)||Xve)||Xve));!function(e){e[e.NONE=0]="NONE",e[e.LOADING=1]="LOADING",e[e.LOADED=2]="LOADED",e[e.ERROR=3]="ERROR"}(yge||(yge={}));var xge,Sge,Tge,Ege,bge,Age,Cge,wge,Rge,Ige,Oge,Mge,Pge,kge,Dge=E.game,Bge=E.view,Lge=E.mat4,Nge=E.misc,Fge=Lge(),zge=function(){function e(t){var n=this;i(this,e),this._eventList=new Map,this._state=yge.NONE,this._webview=void 0,this._loaded=!1,this._webViewComponent=null,this._uiTrans=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._forceUpdate=!1,this._loadedCb=void 0,this._errorCb=void 0,this._webViewComponent=t,this._uiTrans=t.node.getComponent(jv),this._loadedCb=function(e){n._forceUpdate=!0,n._dispatchEvent(yge.LOADED)},this._errorCb=function(e){n._dispatchEvent(yge.ERROR);var t=e.target.error;t&&k("Error "+t.code+"; details: "+t.message)},this._appendDom()}return r(e,[{key:"loadURL",value:function(e){this._webview&&(this._webview.src=e,this._dispatchEvent(yge.LOADING))}},{key:"evaluateJS",value:function(e){if(this._webview){var t=this._webview.contentWindow;if(t)try{t.eval(e)}catch(e){this._dispatchEvent(yge.ERROR),k(e)}}}},{key:"setOnJSCallback",value:function(e){}},{key:"setJavascriptInterfaceScheme",value:function(e){}},{key:"_dispatchEvent",value:function(e){var t=this._eventList.get(e);t&&(this._state=e,t.call(this))}},{key:"_appendDom",value:function(){this._webview=document.createElement("iframe"),this._webview.style.border="none",this._webview.style.position="absolute",this._webview.style.bottom="0px",this._webview.style.left="0px",this._webview.style["transform-origin"]="0px 100% 0px",this._webview.style["-webkit-transform-origin"]="0px 100% 0px",this._bindEvent(),Dge.container.appendChild(this._webview)}},{key:"_removeDom",value:function(){var e=this._webview;Nge.contains(Dge.container,e)&&(Dge.container.removeChild(e),this._removeEvent()),this._loaded=!1,this._webview=null}},{key:"_bindEvent",value:function(){var e=this._webview;e.addEventListener("load",this._loadedCb),e.addEventListener("error",this._errorCb)}},{key:"_removeEvent",value:function(){var e=this._webview;e.removeEventListener("load",this._loadedCb),e.removeEventListener("error",this._errorCb)}},{key:"enable",value:function(){this._webview&&(this._webview.style.visibility="visible")}},{key:"disable",value:function(){this._webview&&(this._webview.style.visibility="hidden")}},{key:"destroy",value:function(){this._removeDom(),this._eventList.clear()}},{key:"syncStyleSize",value:function(e,t){var i=this._webview;i&&(i.style.width=e+"px",i.style.height=t+"px")}},{key:"getUICamera",value:function(){return this._uiTrans&&this._uiTrans._canvas?this._uiTrans._canvas.camera:null}},{key:"syncMatrix",value:function(){if(this._webview&&"hidden"!==this._webview.style.visibility&&this._webViewComponent){var e=this.getUICamera();if(e){this._webViewComponent.node.getWorldMatrix(Fge),e.update(!0),e.worldMatrixToScreen(Fge,Fge,Dge.canvas.width,Dge.canvas.height);var t=this._uiTrans.contentSize.width,i=this._uiTrans.contentSize.height;if(this._forceUpdate||this._m00!==Fge.m00||this._m01!==Fge.m01||this._m04!==Fge.m04||this._m05!==Fge.m05||this._m12!==Fge.m12||this._m13!==Fge.m13||this._w!==t||this._h!==i){this._m00=Fge.m00,this._m01=Fge.m01,this._m04=Fge.m04,this._m05=Fge.m05,this._m12=Fge.m12,this._m13=Fge.m13,this._w=t,this._h=i;var n=Bge._devicePixelRatio,r=1/n,a=1/n,o=Dge.container,s=Fge.m00*r,l=Fge.m01,c=Fge.m04,u=Fge.m05*a;this._webview.style.width="".concat(t,"px"),this._webview.style.height="".concat(i,"px");var h=this._w*r,_=this._h*a,d=h*Fge.m00*this._uiTrans.anchorX,f=_*Fge.m05*this._uiTrans.anchorY,p=o&&o.style.paddingLeft?parseInt(o.style.paddingLeft):0,m=o&&o.style.paddingBottom?parseInt(o.style.paddingBottom):0,v="matrix("+s+","+-l+","+-c+","+u+","+(Fge.m12*r-d+p)+","+-(Fge.m13*a-f+m)+")";this._webview.style.transform=v,this._webview.style["-webkit-transform"]=v,this._forceUpdate=!1}}}}},{key:"loaded",get:function(){return this._loaded}},{key:"eventList",get:function(){return this._eventList}},{key:"webview",get:function(){return this._webview}},{key:"state",get:function(){return this._state}}]),e}();E.internal.WebViewImpl=zge;e("WebView",(xge=ii("cc.WebView"),Sge=mi("i18n:cc.WebView"),Tge=_i("Components/WebView"),Ege=ni(jv),bge=Si("i18n:videoplayer.url"),Age=Li([CB]),Cge=wi(20),wge=Si("i18n:videoplayer.webviewEvents"),xge(Rge=Sge(Rge=Tge(Rge=Ege(Rge=hi((kge=Pge=function(e){function t(){var e,n;i(this,t);for(var r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return x(n=u(this,(e=s(t)).call.apply(e,[this].concat(a))),"_url",Oge,c(n)),n._impl=null,x(n,"webviewEvents",Mge,c(n)),n}return o(t,e),r(t,[{key:"setJavascriptInterfaceScheme",value:function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)}},{key:"setOnJSCallback",value:function(e){this._impl&&this._impl.setOnJSCallback(e)}},{key:"evaluateJS",value:function(e){this._impl&&this._impl.evaluateJS(e)}},{key:"onLoad",value:function(){this._impl=new zge(this),this._impl.loadURL(this._url),this._impl.eventList.set(yge.LOADING,this.onLoading.bind(this)),this._impl.eventList.set(yge.LOADED,this.onLoaded.bind(this)),this._impl.eventList.set(yge.ERROR,this.onError.bind(this))}},{key:"onLoading",value:function(){CB.emitEvents(this.webviewEvents,this,yge.LOADING),this.node.emit("loading",this)}},{key:"onLoaded",value:function(){CB.emitEvents(this.webviewEvents,this,yge.LOADED),this.node.emit("loaded",this)}},{key:"onError",value:function(){CB.emitEvents(this.webviewEvents,this,yge.ERROR),this.node.emit("error",this)}},{key:"onEnable",value:function(){this._impl&&this._impl.enable()}},{key:"onDisable",value:function(){this._impl&&this._impl.disable()}},{key:"onDestroy",value:function(){this._impl&&(this._impl.destroy(),this._impl=null)}},{key:"update",value:function(e){this._impl&&this._impl.syncMatrix()}},{key:"url",get:function(){return this._url},set:function(e){this._url=e,this._impl&&this._impl.loadURL(e)}},{key:"nativeWebView",get:function(){return this._impl&&this._impl.webview||null}},{key:"state",get:function(){return this._impl?this._impl.state:yge.NONE}}]),t}(Yr),Pge.EventType=yge,Oge=S((Ige=kge).prototype,"_url",[si],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"https://cocos.com"}}),S(Ige.prototype,"url",[bge],Object.getOwnPropertyDescriptor(Ige.prototype,"url"),Ige.prototype),Mge=S(Ige.prototype,"webviewEvents",[Age,Cge,wge],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rge=Ige))||Rge)||Rge)||Rge)||Rge)||Rge))}}}));
//# sourceMappingURL=cc.js.map
